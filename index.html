<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é–‹çæ‰€ï½œå®˜æ–¹ç¶²ç«™</title>
  <meta name="color-scheme" content="light dark">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          brand: { DEFAULT: '#14b8a6', fg: '#0f766e', amber: '#f59e0b' }
        },
        boxShadow: {
          soft: '0 10px 25px -10px rgb(0 0 0 / 0.25)',
          elevate: '0 12px 30px -12px rgba(0,0,0,.35)'
        },
        borderRadius: { 'xl2': '1rem' },
        keyframes: {
          fadeIn: { '0%': {opacity:0, transform:'translateY(6px)'},
                    '100%': {opacity:1, transform:'translateY(0)'} },
          pulseSoft: { '0%,100%': {opacity:.75}, '50%': {opacity:1} }
        },
        animation: {
          fadeIn: 'fadeIn .35s ease-out both',
          pulseSoft: 'pulseSoft 2.4s ease-in-out infinite'
        }
      }
    }
  }
</script>

  <!-- React 18 UMD + Babel for in-browser JSX -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
 
/* æŸ”å’Œæ ¼é»èƒŒæ™¯ + æ¼¸å±¤åŸºåº• */
body {
  background-image:
    radial-gradient(at 20% 0%, rgba(20,184,166,.08), transparent 35%),
    radial-gradient(at 80% 10%, rgba(245,158,11,.08), transparent 35%),
    radial-gradient(at 50% 100%, rgba(15,118,110,.08), transparent 35%);
}

   
    .tap-target{padding:10px 12px; min-width:44px; min-height:44px}

    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  
/* === èƒŒæ™¯åœ–ç‰‡ï¼ˆæ•´ç«™ï¼‰ ================================== */
html, body { min-height: 100%; }
body::before{
  content:"";
  position: fixed; inset: 0; z-index:-1;
  background-image:
    linear-gradient(var(--bg-tint, rgba(255,255,255,0.0)), var(--bg-tint, rgba(255,255,255,0.0))),
    var(--bg-img, none);
  background-size: var(--bg-size, cover);
  background-position: var(--bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--bg-brightness,1)) blur(var(--bg-blur,0px));
  opacity: var(--bg-opacity,1);
  transition: filter .25s ease, opacity .25s ease, background .25s ease;
}

/* === æ¼¢å ¡é¸å–®èƒŒæ™¯ ======================= */

.menu-pane{
  position: relative;
  overflow: hidden;
  background: var(--menu-fallback, rgba(255,255,255,.92));
  border-right: 1px solid rgba(15,23,42,.08);
}
.menu-pane::before{
  content:"";
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(var(--menu-tint, rgba(255,255,255,0.0)), var(--menu-tint, rgba(255,255,255,0.0))),
    var(--menu-bg-img, none);
  background-size: var(--menu-bg-size, cover);
  background-position: var(--menu-bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--menu-brightness,1)) blur(var(--menu-blur,0px));
  opacity: var(--menu-opacity,1);
}
.menu-pane > *{ position: relative; z-index:1; }

/* === Mobile tweaks (ä¸å½±éŸ¿æ¡Œæ©Ÿ) === */
@media (max-width: 640px) {
  .toolbar-grid, .flex-wrap, .px-2 { gap: 8px; }
  .paginator-top { display: none; }     /* ä¸Šæ–¹åˆ†é å™¨åœ¨æ‰‹æ©Ÿéš±è—ï¼Œä¿ç•™ä¸‹æ–¹é‚£çµ„ */
  .min-h-\[44px\] { min-height: 44px !important; }
  .sheet-w { width: min(96vw, 560px) !important; }
}

</style>

<!-- [IMGIO CSS START] -->
<style>
  /* åŸºæœ¬ï¼šç•¶ä½œå®¹å™¨èª¿æ•´æ™‚æœƒç”¨åˆ°ï¼ˆèƒŒæ™¯åœ–ç­‰ï¼‰ */
  [data-img-key]{
    background-repeat: no-repeat;
    background-position: center center;
    background-size: cover;
  }
  /* è‹¥ä½ è¦ç”¨é€æ˜åº¦/åç§»/ç¸®æ”¾ç­‰ï¼Œé€™è£¡æä¾›é€šç”¨ classï¼ˆJS æœƒç›´æ¥æ”¹ styleï¼Œä¸æœƒå‹•ä½  classï¼‰ */

/* === Dark mode å¢å¼·ï¼šä¸»é èƒŒæ™¯èˆ‡æ¼¢å ¡é¸å–®å°æ¯”/å¯è®€æ€§ === */
/* ä»¥ã€Œåª’é«”æŸ¥è©¢ã€åµæ¸¬ç³»çµ±æ·±è‰²ï¼›Tailwind é è¨­ darkMode: 'media' ä¹Ÿç›¸å®¹ */
@media (prefers-color-scheme: dark) {

  /* 1) èª¿æ•´å…¨ç«™ï¼ˆä¸»é ï¼‰æ¼¸å±¤èƒŒæ™¯åœ¨æ·±è‰²ä¸‹çš„è§€æ„Ÿï¼šæ›´æŸ”å’Œã€æ›´æœ‰å±¤æ¬¡ */
  body {
    background-image:
      radial-gradient(at 20% 0%, rgba(20,184,166,.12), transparent 35%),
      radial-gradient(at 80% 10%, rgba(245,158,11,.10), transparent 35%),
      radial-gradient(at 50% 100%, rgba(100,116,139,.18), transparent 38%); /* slate-500-ish */
    /* é€™è£¡ä¸å‹•ä½ åŸæœ¬çš„ --bg-* è®Šæ•¸ï¼›è‹¥æœ‰è‡ªè¨‚èƒŒæ™¯åœ–ä»æœƒç…§å¸¸å¥—ç”¨ */
  }

  /* 2) æå‡æ¼¢å ¡æŠ½å±œï¼ˆmenu-paneï¼‰å¯è®€æ€§ï¼šæ·±åº•ï¼‹äº®å­—ï¼‹æŸ”å’Œé‚Šç•Œ */
  :root {
    /* è‹¥æœªå¦è¡ŒæŒ‡å®š menu èƒŒæ™¯ï¼Œæä¾›æ·±è‰²ä¸‹æ›´é©åˆçš„é è¨­ fallback */
    --menu-fallback: rgba(2, 6, 23, 0.92); /* slate-950 è¿‘ä¼¼å€¼ã€å¸¶ 92% ä¸é€æ˜ */
  }

  .menu-pane {
    background: var(--menu-fallback, rgba(2, 6, 23, 0.92)) !important;
    color: #e5e7eb; /* slate-200ï¼šæŠ½å±œå…§ä¸€èˆ¬æ–‡å­— */
    border-right-color: rgba(148, 163, 184, 0.25); /* slate-400-ish */
  }

  /* æŠ½å±œå…§çš„åˆ†éš”ç·š/é‚Šæ¡†ï¼Œåœ¨æ·±è‰²ä¸‹æ›´æŸ”å’Œ */
  .menu-pane .border,
  .menu-pane .border-b,
  .menu-pane .border-t,
  .menu-pane .border-l,
  .menu-pane .border-r {
    border-color: rgba(148, 163, 184, 0.25) !important;
  }

  /* æŠ½å±œå…§é€£çµ/æŒ‰éˆ•ç¶­æŒç¹¼æ‰¿çš„äº®å­—è‰²ï¼Œé¿å…å€‹åˆ¥å…ƒç´ é¡è‰²éæš— */
  .menu-pane a,
  .menu-pane button,
  .menu-pane [role="button"] {
    color: inherit;
  }

  /* æŠ½å±œé …ç›®çš„ hover/active ç‹€æ…‹åœ¨æ·±è‰²ä¸‹çµ¦æ›´æ·ºçš„é«˜äº®åº•ï¼Œå°æ¯”æ›´æ¸…æ¥š */
  .menu-pane .hover\:bg-slate-100:hover,
  .menu-pane .active\:bg-slate-100:active {
    background-color: rgba(30, 41, 59, 0.6) !important; /* slate-800 60% */
  }

  /* æŠ½å±œé ‚éƒ¨å·¥å…·åˆ—ï¼ˆä½ åŸæœ¬çš„ header å€å¡Šï¼‰åº•è‰²èˆ‡æ–‡å­—ä¹Ÿä¸€ä½µå„ªåŒ– */
  .menu-pane .bg-white,
  .menu-pane .bg-white\/85,
  .menu-pane .bg-slate-50 {
    background-color: rgba(2, 6, 23, 0.92) !important;
    color: #e5e7eb !important;
  }
  .menu-pane .text-slate-500 { color: #cbd5e1 !important; } /* slate-300 è¿‘ä¼¼ */
}

</style>
<!-- [IMGIO CSS END] -->

</head>
<body class="bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    // â€”â€” LocalStorage Keys â€”â€”
    const LS = { data: 'kjs_site_data_v1', admin: 'kjs_admin_pass' };

  // === Default Settingsï¼ˆå¯è¢«ç®¡ç†é¢æ¿è¦†å¯«ï¼‰ ===
const DEFAULT_SETTINGS = {
  drawMaxPerRun: 500,      // å–®æ¬¡æœ€å¤šæŠ½å‡ºäººæ•¸ä¸Šé™ï¼ˆåé¡ï¼‰
  drawPublicShowLimit: 50, // å…¬é–‹çµæœæœ€å¤šé¡¯ç¤ºå¹¾ä½
  drawCooldownSec: 10,     // åŒä¸€æ´»å‹•é‡è·‘å†·å»ç§’æ•¸
  contactUrl: ""           // â˜… å…¨åŸŸã€Œè¯çµ¡ç®¡ç†å“¡ã€ç¶²å€ï¼ˆå¯ç•™ç©ºï¼‰
};
// === History ç‹€æ…‹é¸å–® ===
const HISTORY_STATUS_OPTIONS = [
  { value: "å·²å¯„å‡º",   label: "âœ… å·²å¯„å‡º" },
  { value: "è™•ç†ä¸­",   label: "â³ è™•ç†ä¸­" },
  { value: "æœªå›è¦†",   label: "ğŸ”´ æœªå›è¦†" },
  { value: "å†å¯„é€ä¸­", label: "ğŸ“¦ å†å¯„é€ä¸­" },
  { value: "å¾…å¯„é€",   label: "ğŸŸ¡ å¾…å¯„é€" },
  { value: "æ”¾æ£„é ˜ç", label: "ğŸš« æ”¾æ£„é ˜ç" },
];
// é¡¯ç¤ºç”¨ï¼ˆæ­·å²åˆ—è¡¨ï¼‰
const HISTORY_STATUS_ICON = {
  "å·²å¯„å‡º":"âœ…","è™•ç†ä¸­":"â³","æœªå›è¦†":"ğŸ”´","å†å¯„é€ä¸­":"ğŸ“¦","å¾…å¯„é€":"ğŸŸ¡","æ”¾æ£„é ˜ç":"ğŸš«"
};

// ========== ç‹€æ…‹æ¨™ç±¤æ¨£å¼ï¼ˆæŸ”å’Œã€ä¸åˆºçœ¼ï¼‰ ==========
const HISTORY_STATUS_STYLE = {
  "å·²å¯„å‡º":   { bg: "bg-emerald-100/70 dark:bg-emerald-300/15", text: "text-emerald-700 dark:text-emerald-300", ring:"ring-emerald-500/20" },
  "è™•ç†ä¸­":   { bg: "bg-sky-100/70 dark:bg-sky-300/15",         text: "text-sky-700 dark:text-sky-300",         ring:"ring-sky-500/20" },
  "æœªå›è¦†":   { bg: "bg-rose-100/70 dark:bg-rose-300/15",       text: "text-rose-700 dark:text-rose-300",       ring:"ring-rose-500/20" },
  "å†å¯„é€ä¸­": { bg: "bg-indigo-100/70 dark:bg-indigo-300/15",   text: "text-indigo-700 dark:text-indigo-300",   ring:"ring-indigo-500/20" },
  "å¾…å¯„é€":   { bg: "bg-amber-100/70 dark:bg-amber-300/15",     text: "text-amber-800 dark:text-amber-300",     ring:"ring-amber-500/20" },
  "æ”¾æ£„é ˜ç": { bg: "bg-slate-200/70 dark:bg-slate-300/15",     text: "text-slate-700 dark:text-slate-300",     ring:"ring-slate-400/20" },
};

/* =========================================
 * å…¨åŸŸæ²å‹•é–ï¼šé¿å…å½ˆçª—/æª¢è¦–å™¨ç•°å¸¸é€ æˆæ•´ç«™å¡ä½
 * ========================================= */
(function(){
  const lockKey = "__BODY_SCROLL_LOCK_COUNT__";
  if (!window[lockKey]) window[lockKey] = 0;
  function apply() {
    if (window[lockKey] > 0) {
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";
    } else {
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      document.body.style.touchAction = "";
    }
  }
  window.BodyScrollLock = {
    lock() { window[lockKey] = Math.max(0, (window[lockKey]||0)) + 1; apply(); },
    unlock() { window[lockKey] = Math.max(0, (window[lockKey]||0) - 1); apply(); },
    reset() { window[lockKey] = 0; apply(); }
  };
  // ä¿éšªæ©Ÿåˆ¶ï¼šé é¢éš±è—/é›¢é–‹æ™‚è‡ªå‹•é‚„åŸ
  window.addEventListener("pagehide", ()=>window.BodyScrollLock.reset());
  document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState !== "visible") window.BodyScrollLock.reset(); });
})();

// === åˆ—é ­ï¼šæ—¥æœŸ / çå“åç¨±(æˆªæ–·) / ç‹€æ…‹ï¼ˆé å³ä¸æ›è¡Œï¼‰ ===
function HistoryHeaderRow({ rec }) {
  const date = formatDateYMD(rec?.date || "") || "â€”";
  const title = rec?.title || "ï¼ˆæœªå‘½åï¼‰";
  const status = rec?.status || "";

  return (
    <div className="grid grid-cols-[94px_1fr_auto] sm:grid-cols-[110px_1fr_auto] items-center gap-2 sm:gap-3 w-full">
      {/* æ—¥æœŸï¼šç­‰å¯¬å­—é«”ï¼Œå›ºå®šå¯¬åº¦ */}
      <span className="font-mono text-[13px] text-slate-500">{date}</span>

      {/* åç¨±ï¼šå–®è¡Œæˆªæ–·ï¼Œæ‰‹æ©Ÿé™åˆ¶å­—æ•¸æ›´ç·Š */}
      <div className="flex items-center min-w-0">
        <span className="mr-2" aria-hidden="true">ğŸ</span>
        <span
          className="truncate max-w-[18ch] sm:max-w-[48ch] text-[15px]"
          title={title}
        >
          {title}
        </span>
      </div>

      {/* ç‹€æ…‹ï¼šå›ºå®šåœ¨å³å´ã€ä¸å¯ç¸®å° */}
      <div className="shrink-0">
        <StatusTag value={status} />
      </div>
    </div>
  );
}
// ç¤¾ç¾¤å•†åº—ï¼ˆç¾é‡‘è³¼è²·ï¼‰â€” å›ºå®š 9/16 æ¬„ã€åªä¿ç•™å°å¡è©³æƒ…ï¼ˆä¸å†é–‹å…¨è¢å¹•åœ–å±¤ï¼‰
// ç®¡ç†åŠŸèƒ½ï¼ˆStoreEditorï¼‰èˆ‡ ProductSheet éƒ½ä¿ç•™ï¼Œå‘½åä¸è®Š
function Store({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  // åå¥½ï¼ˆä¹/åå…­å®®æ ¼ã€æ¯é ï¼‰
  const prefKey = "store_prefs_v2";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9"); // grid9 / grid16
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // ç®¡ç†é¢æ¿
  const [showEditor, setShowEditor] = React.useState(false);
  const HasStoreEditor = typeof StoreEditor === "function";

  // å°å¡è©³æƒ…ï¼ˆæ²¿ç”¨æ—¢æœ‰ ProductSheetï¼‰
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // å·¥å…·
  const safeNumber = (v) => {
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) return +v;
    return null;
  };
  const getRemain = (x) => {
    const v = [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find(n=>n!=null);
    return v==null ? null : v;
  };

  // è³‡æ–™
  const itemsRaw = Array.isArray(data?.store?.items) ? data.store.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    return { ...it, _images: images.filter(Boolean) };
  };
  const allItems = React.useMemo(()=> itemsRaw.map(normalizeItem), [itemsRaw]);

  // æœå°‹ / ç¯©é¸ / æ’åº
  const [search, setSearch] = React.useState(query || "");
  const [sortBy, setSortBy] = React.useState("latest"); // latest | priceAsc | priceDesc
  const [onlyInStock, setOnlyInStock] = React.useState(false);

  const filtered = React.useMemo(()=>{
    const kw = String(search||"").trim().toLowerCase();
    return allItems.filter(x=>{
      const hay = [x?.name, x?.desc, x?.intro].map(s=>String(s||"").toLowerCase()).join(" ");
      const hitKW   = !kw || hay.includes(kw);
      const remain  = getRemain(x);
      const hitStock= !onlyInStock || (remain==null || remain>0);
      return hitKW && hitStock;
    });
  }, [allItems, search, onlyInStock]);

  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    if (sortBy==="priceAsc")       arr.sort((a,b)=> ((+a?.price||Infinity) - (+b?.price||Infinity)));
    else if (sortBy==="priceDesc") arr.sort((a,b)=> ((+b?.price||-Infinity) - (+a?.price||-Infinity)));
    else                           arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered, sortBy]);

  // åˆ†é 
  const total   = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [search, sortBy, view, pageSize, onlyInStock]);
  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage  = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage    = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems  = sorted.slice(start, end);

  // å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿå¯æ›è¡Œï¼‰
  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        <input className="flex-1 min-w-[220px] rounded border px-3 py-2" placeholder="æœå°‹å•†å“..." value={search} onChange={e=>setSearch(e.target.value)} />
        <select className="rounded border px-2 py-2" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
          <option value="latest">æœ€æ–°æ›´æ–°</option>
          <option value="priceAsc">åƒ¹æ ¼ï¼ˆä½â†’é«˜ï¼‰</option>
          <option value="priceDesc">åƒ¹æ ¼ï¼ˆé«˜â†’ä½ï¼‰</option>
        </select>
        <label className="flex items-center gap-1">
          <input type="checkbox" checked={onlyInStock} onChange={e=>setOnlyInStock(e.target.checked)} />
          åªçœ‹æœ‰è²¨
        </label>
        <label className="flex items-center gap-1">
          ç‰ˆé¢
          <select className="rounded border px-2 py-2" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 å®®æ ¼</option>
            <option value="grid16">16 å®®æ ¼</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          æ¯é 
          <select className="rounded border px-2 py-2" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>
        <div className="grow basis-full sm:basis-auto" />
        {admin && HasStoreEditor && (
          <button className="rounded-lg border px-3 py-2" onClick={()=>setShowEditor(true)}>ç®¡ç†</button>
        )}
      </div>
    </div>
  );

  // æ‰‹æ©Ÿä¹Ÿå›ºå®š 9/16 æ¬„
  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      <div className={`grid ${gridCols} gap-3`} aria-label="ç¤¾ç¾¤å•†åº—æ¸…å–®">
        {pageItems.map((x, i) => {
          const name   = x?.name || 'ï¼ˆæœªå‘½åï¼‰';
          const price  = (x?.price ?? '') !== '' ? x.price : null;
          const cover  = Array.isArray(x._images) && x._images.length>0 ? x._images[0] : '';
          const buyUrl = x?.buyUrl || x?.url || '';
          const remain = getRemain(x);

          return (
            <details key={x.id || i} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none">
              {/* é» summary â†’ åªé–‹ ProductSheetï¼ˆä¸å†é–‹ç¬¬äºŒå±¤åœ–ç‰‡æª¢è¦–å™¨ï¼‰ */}
              <summary className="list-none cursor-pointer p-3" onClick={(e)=>{ e.preventDefault(); setSheet({ open:true, item:x }); }}>
                <div className="flex flex-col">
                  <div className="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                    {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
                  </div>
                  <div className="mt-2 flex items-center justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-medium text-[15px] whitespace-normal break-words" title={name}>{name}</div>
                    </div>
                    {price!=null && <div className="text-sm text-emerald-700 dark:text-emerald-400 whitespace-nowrap">NT$ {price}</div>}
                  </div>
                </div>
              </summary>

              {/* å±•é–‹å…§å®¹ï¼šä¿ç•™å¯å­˜å–æ€§ï¼ˆä¸»è¦äº’å‹•èµ°ä¸Šé¢çš„ summary é–‹å•Ÿ sheetï¼‰ */}
              <div className="px-3 pb-3">
                <div className="text-sm space-y-2">
                  {remain!=null && <div className="text-slate-600">å‰©é¤˜æ•¸é‡ï¼š{remain}</div>}
                  {x.desc  && <div className="whitespace-pre-wrap leading-relaxed break-words">{x.desc}</div>}
                  {x.intro && <div className="whitespace-pre-wrap leading-relaxed break-words">{x.intro}</div>}
                </div>

                <div className="mt-3">
                  {buyUrl
                    ? <a href={buyUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center justify-center w-full rounded-lg bg-brand text-white px-4 py-2 text-sm shadow-soft" title="å‰å¾€è³¼è²·">å‰å¾€è³¼è²·</a>
                    : <button disabled className="inline-flex items-center justify-center w-full rounded-lg border px-4 py-2 text-sm text-slate-400" title="å°šæœªæä¾›è³¼è²·é€£çµ">å°šæœªæä¾›è³¼è²·é€£çµ</button>}
                </div>
              </div>
            </details>
          );
        })}
      </div>

      <Paginator />

      {/* ç®¡ç†é¢æ¿ï¼šåŸå°ä¸å‹•ä¿ç•™ */}
      {admin && HasStoreEditor && showEditor && (
        <StoreEditor data={data} setData={setData} onClose={()=>setShowEditor(false)} />
      )}

      {/* âœ… åªä¿ç•™å°å¡è©³æƒ…ï¼›ä¸å†å‚³ onOpenViewerï¼Œé¿å…å†é–‹ç¬¬äºŒå±¤åœ–å±¤ */}
      <ProductSheet
        open={sheet.open}
        item={sheet.item}
        context="store"
        onClose={()=>setSheet({ open:false, item:null })}
      />
    </section>
  );
}



function StoreCard({ item }) {
  const images = Array.isArray(item?.images) ? item.images.filter(Boolean) : [];
  const thumb = images[0] || '';
  return (
    <CardCollapse
      summary={
        <div className="p-3 space-y-2">
          <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
            {thumb
              ? <img src={thumb} alt="" className="w-full h-full object-contain" loading="lazy" />
              : <div className="w-full h-full flex items-center justify-center text-slate-400">ç„¡åœ–</div>}
          </div>
          <div className="flex items-center justify-between gap-2">
            <div className="min-w-0">
              <div className="font-medium truncate" title={item?.name||''}>
                {item?.name || 'ï¼ˆæœªå‘½åï¼‰'}
              </div>
              {Array.isArray(item?.tags) && item.tags.length>0 && (
                <div className="text-xs text-slate-500 truncate" title={item.tags.join(' / ')}>
                  {item.tags.join(' / ')}
                </div>
              )}
            </div>
            {(item?.price ?? '') !== '' && (
              <div className="shrink-0 font-semibold">{String(item.price)}</div>
            )}
          </div>
        </div>
      }
    >
      {/* è©³ç´°å…§å®¹ï¼ˆå±•é–‹å¾Œæ‰é¡¯ç¤ºï¼‰ */}
      <div className="space-y-3">
        {/* åœ–ç‰‡è¼ªæ’­ï¼ˆç¸®åœ–åˆ‡æ›ï¼‰ */}
        {images.length > 0 && <ImageStrip images={images} alt={item?.name||'å•†å“åœ–ç‰‡'} />}

        {/* ä»‹ç´¹æ–‡å­— */}
        {item?.desc && (
          <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
            {item.desc}
          </p>
        )}

        {/* æ“ä½œåˆ— */}
        <div>
          {item?.buyUrl ? (
            <a
              href={item.buyUrl}
              target="_blank" rel="noopener noreferrer"
              className="inline-flex items-center justify-center w-full rounded-lg bg-brand text-white px-4 py-2 text-sm shadow-soft"
              title="å‰å¾€è³¼è²·"
            >
              å‰å¾€è³¼è²·
            </a>
          ) : (
            <button
              disabled
              className="inline-flex items-center justify-center w-full rounded-lg border px-4 py-2 text-sm text-slate-400"
              title="å°šæœªæä¾›è³¼è²·é€£çµ"
            >
              å°šæœªæä¾›è³¼è²·é€£çµ
            </button>
          )}
        </div>
      </div>
    </CardCollapse>
  );
}

/* ç°¡æ˜“åœ–ç‰‡ç¸®åœ–å¸¶åˆ‡æ› */
function ImageStrip({ images = [], alt = '' }) {
  const [idx, setIdx] = React.useState(0);
  const main = images[idx] || images[0] || '';
  return (
    <div className="space-y-2">
      {/* å¤§åœ–é è¦½ */}
      <div className="rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800">
        {main
          ? <img src={main} alt={alt} className="w-full h-auto object-cover" loading="lazy" />
          : <div className="w-full aspect-[4/3] flex items-center justify-center text-slate-400">ç„¡åœ–ç‰‡</div>}
      </div>

      {/* ç¸®åœ–ï¼šæ”¹ç”¨ Gridï¼Œæœƒè‡ªå‹•æ›è¡Œæˆå¤šåˆ— */}
      {images.length > 1 && (
        <div className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          {images.map((src, i) => (
            <button
              key={src + i}
              onClick={() => setIdx(i)}
              className={
                "w-full aspect-square rounded-lg overflow-hidden border " +
                (i === idx ? "border-brand ring-2 ring-brand/50" : "border-slate-200 dark:border-slate-700")
              }
              title={`åœ–ç‰‡ ${i + 1}`}
            >
              <img src={src} alt="" className="w-full h-full object-cover" loading="lazy" />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

/*********************************
 * ğŸ›’ å•†åº—ç·¨è¼¯å™¨ï¼ˆAdmin å°ˆç”¨ï¼‰
 * - å¤šåœ–ï¼šä¸€è¡Œä¸€å¼µ URL
 * - åŒ¯å‡º CSVï¼šå« images é™£åˆ—ï¼ˆä»¥ | ä¸²æ¥ï¼‰
 *********************************/
function StoreEditor({ data, setData, onClose }) {
  const items = Array.isArray(data?.store?.items) ? data.store.items : [];
  const [drafts, setDrafts] = React.useState(() => items.map(cloneStoreItem));
  const [filter, setFilter] = React.useState('');

  function cloneStoreItem(it={}) {
    return {
      id: it.id || nid(),
      name: it.name || '',
      price: it.price ?? '',
      stock: it.stock ?? '',
      desc: it.desc || it.intro || '',
      images: Array.isArray(it.images) ? it.images.filter(Boolean) : [],
      imagesText: Array.isArray(it.images) ? it.images.join('\n') : '',  
buyUrl: it.buyUrl || '',
      tags: Array.isArray(it.tags) ? it.tags.filter(Boolean) : [],
    };
  }

  const filtered = filter
    ? drafts.filter(it =>
        matchText(it.name, filter) ||
        matchText(it.desc, filter) ||
        (Array.isArray(it.tags) && it.tags.some(t=>matchText(t, filter)))
      )
    : drafts;

  const up = (id, field, value) => {
    setDrafts(d => d.map(x => x.id===id ? { ...x, [field]: value } : x));
  };

  const remove = (id) => {
    if (!confirmKeyword({ label:'ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿæ‰“ã€Œåˆªé™¤ã€ç¢ºèª', keyword:'åˆªé™¤' })) return;
    setDrafts(d => d.filter(x => x.id!==id));
  };

  const addNew = () => {
    setDrafts(d => [
      { id: nid(), name:'', price:'', stock:'', desc:'', images:[], buyUrl:'', tags:[] },
      ...d
    ]);
  };

  const saveAll = () => {
    setData(s => ({
      ...s,
      store: { ...(s.store||{}), items: drafts }
    }));
    alert('ç¤¾ç¾¤å•†åº—å·²å„²å­˜');
    onClose?.();
  };

  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="w-full max-w-4xl max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl">
          {/* header */}
          <div className="px-4 py-3 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
            <div className="font-semibold">ç·¨è¼¯ç¤¾ç¾¤å•†åº—</div>
            <div className="flex items-center gap-2">
              <input
                value={filter}
                onChange={e=>setFilter(e.target.value)}
                placeholder="æœå°‹è‰ç¨¿..."
                className="rounded-lg border px-2 py-1.5 text-sm"
              />
              <button onClick={addNew} className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm">æ–°å¢å•†å“</button>
              <button onClick={()=>exportStoreCSV(drafts)} className="rounded-lg border px-3 py-1.5 text-sm">åŒ¯å‡º CSV</button>
              <button onClick={saveAll} className="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm">å„²å­˜</button>
              <button onClick={onClose} className="rounded-lg border px-3 py-1.5 text-sm">é—œé–‰</button>
            </div>
          </div>

          {/* body */}
          <div className="p-3 overflow-y-auto max-h-[calc(86vh-56px)] space-y-3">
            {filtered.length === 0 ? (
              <div className="text-slate-500 text-sm">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‰ç¨¿ã€‚</div>
            ) : filtered.map(it => (
              <div key={it.id} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3 space-y-2">
                <div className="grid grid-cols-1 md:grid-cols-6 gap-2">
                  <input
                    className="md:col-span-3 rounded-lg border px-3 py-2"
                    placeholder="å•†å“åç¨±"
                    value={it.name}
                    onChange={e=>up(it.id, 'name', e.target.value)}
                  />
                  <input
                    className="md:col-span-1 rounded-lg border px-3 py-2"
                    placeholder="å”®åƒ¹ï¼ˆå­—ä¸²æˆ–æ•¸å­—ï¼‰"
                    value={it.price}
                    onChange={e=>up(it.id, 'price', e.target.value)}
                  />
                  <input
                    className="md:col-span-1 rounded-lg border px-3 py-2"
                    placeholder="åº«å­˜ï¼ˆå¯çœç•¥ï¼‰"
                    value={it.stock}
                    onChange={e=>up(it.id, 'stock', e.target.value)}
                  />
                  <input
                    className="md:col-span-1 rounded-lg border px-3 py-2"
                    placeholder="è³¼è²·é€£çµï¼ˆbuyUrlï¼‰"
                    value={it.buyUrl}
                    onChange={e=>up(it.id, 'buyUrl', e.target.value)}
                  />
                </div>

                <textarea
                  className="w-full rounded-lg border px-3 py-2"
                  placeholder="å•†å“ä»‹ç´¹ï¼ˆdescï¼‰"
                  rows={3}
                  value={it.desc}
                  onChange={e=>up(it.id, 'desc', e.target.value)}
                />

                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <textarea
  className="rounded-lg border px-3 py-2"
  placeholder="å¤šå¼µåœ–ç‰‡ï¼šæ¯è¡Œä¸€å€‹ URLï¼ˆimagesï¼‰"
  rows={5}
  value={it.imagesText ?? (it.images||[]).join('\n')}
  onChange={e=>{
    const raw = e.target.value;                        // åŸæ¨£ä¿ç•™ï¼ˆå«ç©ºç™½è¡Œï¼‰
    up(it.id, 'imagesText', raw);                      // 1) å„²å­˜åŸå§‹æ–‡å­—
    const imgs = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    up(it.id, 'images', imgs);                         // 2) åŒæ­¥è§£æçµ¦é è¦½/å„²å­˜ç”¨
  }}
/>

                  <input
                    className="rounded-lg border px-3 py-2"
                    placeholder="æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ï¼Œä¾‹å¦‚ï¼šç©å…·,å®¶é›»"
                    value={(it.tags||[]).join(',')}
                    onChange={e=>up(it.id, 'tags', e.target.value.split(',').map(s=>s.trim()).filter(Boolean))}
                  />
                </div>

                {/* é è¦½ç¸®åœ–åˆ— */}
               {Array.isArray(it.images) && it.images.length>0 && (
  <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 pt-1">
    {it.images.map((src, idx)=>(
      <div key={src+idx} className="aspect-square rounded-lg overflow-hidden border">
        <img src={src} alt="" className="w-full h-full object-cover" />
      </div>
    ))}
  </div>
)}


                <div className="flex justify-between items-center pt-1">
                  <span className="text-xs text-slate-500">IDï¼š{it.id}</span>
                  <button onClick={()=>remove(it.id)} className="rounded-lg border px-2 py-1 text-sm">åˆªé™¤</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

/***********************
 * åŒ¯å‡º CSVï¼ˆç¤¾ç¾¤å•†åº—ï¼‰
 ***********************/
function exportStoreCSV(items=[]) {
  const header = ['id','name','price','stock','buyUrl','tags','images','desc'];
  const rows = [header];
  for (const it of (items||[])) {
    rows.push([
      it?.id || '',
      it?.name || '',
      it?.price ?? '',
      it?.stock ?? '',
      it?.buyUrl || '',
      Array.isArray(it?.tags) ? it.tags.join('|') : '',
      Array.isArray(it?.images) ? it.images.join('|') : '',
      (it?.desc || '').replace(/\r?\n/g, ' '),
    ]);
  }
  exportCSV(`store_items_${new Date().toISOString().slice(0,10)}.csv`, rows);
}


// å°å…ƒä»¶ï¼šç‹€æ…‹è† å›Šï¼ˆå« emojiï¼Œçµ±ä¸€è¦æ ¼ï¼‰
function StatusTag({ value }) {
  const v = String(value || "").trim();
  if (!v) return null;
  const icon = HISTORY_STATUS_ICON[v] || "ğŸ·ï¸";
  const style = HISTORY_STATUS_STYLE[v] || { bg: "bg-slate-100/70 dark:bg-slate-300/10", text: "text-slate-600 dark:text-slate-300", ring:"ring-slate-400/20" };
  return (
    <span
      className={[
        "inline-flex items-center justify-center gap-1.5 px-2.5 py-1 rounded-full text-xs min-w-[80px] text-center",
        "border border-transparent ring-1", style.ring, style.bg, style.text
      ].join(" ")}
      title={`ç‹€æ…‹ï¼š${v}`}
    >
      <span aria-hidden="true">{icon}</span>
      <span className="leading-none">{v}</span>
    </span>
  );
}


// â€”â€” å°å·¥å…· â€”â€”ï¼ˆä½ å‰›å‰›ä¸å°å¿ƒåˆªæ‰çš„ï¼‰
const cx = (...xs) => xs.filter(Boolean).join(' ');
const nid = () => Math.random().toString(36).slice(2,10);

function useLocalState(key, initial){
  const [state, setState] = React.useState(()=>{
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    }catch{
      return initial;
    }
  });
  React.useEffect(()=>{
    localStorage.setItem(key, JSON.stringify(state));
  },[key, state]);
  return [state, setState];
}

// æ–‡å­—åå–®æ¸…æ´—ï¼šå»ç©ºç™½ã€å…¨/åŠå½¢ç©ºç™½ã€é€£çºŒç©ºç™½ã€å¤§å°å¯«ä¸æ•æ„Ÿå»é‡
function parseLinesClean(txt="") {
  const normalize = s => s.replace(/\u3000/g, " ").replace(/\s+/g, " ").trim();
  const set = new Set(), out = [];
  for (const raw of String(txt).split(/\r?\n/)) {
    const v = normalize(raw);
    if (!v) continue;
    const key = v.toLowerCase();
    if (!set.has(key)) { set.add(key); out.push(v); }
  }
  return out;
}

// â€”â€” æ–‡å­—æ¯”å°ï¼šå¤§å°å¯«ä¸æ•æ„Ÿã€å…¨å½¢ç©ºç™½è½‰åŠå½¢ã€é€£çºŒç©ºç™½æ­¸ä¸€åŒ– â€”â€” //
function matchText(hay="", needle=""){
  const norm = (s)=> String(s||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase();
  const a = norm(hay), b = norm(needle);
  if (!b) return true; // ç©ºå­—ä¸²è¦–ç‚ºå…¨éƒ¨åŒ¹é…
  return a.includes(b);
}

// â€”â€” History æœå°‹è¦å‰‡ï¼ˆä¾æ¨¡å¼ï¼‰â€”â€” //
// rec: { title, winners[], note, status, youtube, ... }
// mode: 'all' | 'prize' | 'winner' | 'note'
// q: é—œéµå­—
function historyMatchByMode(rec, q, mode){
  const m = mode || 'all';
  const title = rec?.title || "";
  const note  = rec?.note  || rec?.desc || "";
  const winners = Array.isArray(rec?.winners) ? rec.winners : [];

  if (!q) return true; // æ²’è¼¸å…¥é—œéµå­— => ä¸éæ¿¾

  switch (m) {
    case 'prize':
      return matchText(title, q);

    case 'winner':
      return winners.some(w => matchText(w, q));

    case 'note':
      // å‚™è¨»/èªªæ˜ï¼šå„ªå…ˆ note/descï¼Œå…¶æ¬¡ statusã€youtube ä¹Ÿç´å…¥é—œè¯æœå°‹
      return (
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );

    case 'all':
    default:
      // å…¨éƒ¨ï¼štitleã€winnersã€note/status/youtube çš†ç´å…¥
      return (
        matchText(title, q) ||
        winners.some(w => matchText(w, q)) ||
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );
  }
}

// === Adminï¼šç´”å‰ç«¯ SHA-256 é›œæ¹Šï¼ˆé¿å…æ˜æ–‡å­˜å¯†ç¢¼ï¼‰ ===
async function hashTextSHA256(text) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(String(text)));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, "0")).join("");
}


// === è£œé½Šå°å·¥å…·ï¼ˆä¸ä¾è³´å›æ”¶ç«™ï¼‰ ===
function nowISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function exportCSV(filename, rows){
  const csv = rows
    .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* === Grid å·¥å…·ï¼ˆ9/16 å®®æ ¼åˆ‡æ›ï¼‰ === */
function useGridSize(lsKey='kjs_grid_cols', defaultCols=3){
  const [cols, setCols] = useLocalState(lsKey, defaultCols); // 3=9å®®æ ¼, 4=16å®®æ ¼
  const toggle = ()=> setCols(c => (c===3?4:3));
  const colClass = cols===3 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4';
  const label = cols===3 ? '9 å®®æ ¼' : '16 å®®æ ¼';
  return { cols, setCols, toggle, colClass, label };
}

/* å¡ç‰‡å±•é–‹å®¹å™¨ï¼šé»å¡ç‰‡å¾Œå±•é–‹è©³ç´°ï¼ˆå¡ç‰‡å…§éƒ¨æ§åˆ¶ open ç‹€æ…‹ï¼‰ */
function CardCollapse({summary, children, defaultOpen=false}) {
  const [open, setOpen] = React.useState(!!defaultOpen);
  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 shadow-soft overflow-hidden">
      <button
        type="button"
        className="block w-full text-left"
        onClick={()=>setOpen(o=>!o)}
        aria-expanded={open?'true':'false'}
      >
        {summary}
      </button>
      {open && (
        <div className="border-t border-slate-200/70 dark:border-slate-700/70 p-3">
          {children}
        </div>
      )}
    </div>
  );
}

/* =========================================
 * å…¨åŸŸ Viewerï¼ˆåœ–ç‰‡æŸ¥çœ‹å™¨ï¼Œä¾›å„è™•ä½¿ç”¨ï¼‰
 * - é»é®ç½©ç©ºç™½å€åŸŸé—œé–‰
 * - å·¦å³é»/æ»‘åˆ‡æ›ã€é›™æ“Šæ”¾å¤§ã€ä¸‹æ»‘é—œé–‰
 * - ä½¿ç”¨ BodyScrollLock é¿å…æ•´ç«™å¡ä½
 * ========================================= */
function Viewer({ state, setState }) {
  const React = window.React || globalThis.React;
  const containerRef = React.useRef(null);
  const imgRef = React.useRef(null);

  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);

  const hasImages = Array.isArray(state?.images) && state.images.length > 0;
  const index = Math.max(0, Math.min(state?.index || 0, (state?.images?.length || 1) - 1));
  const src = hasImages ? state.images[index] : "";

  // éµç›¤ & é–æ²å‹•ï¼ˆä½¿ç”¨å…¨åŸŸé–ï¼‰
  React.useEffect(() => {
    if (!state?.open) return;
    BodyScrollLock.lock();
    const onKey = (e) => {
      if (e.key === "Escape") setState(v => ({ ...v, open: false }));
      if (e.key === "ArrowLeft") setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      if (e.key === "ArrowRight") setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    return () => { document.removeEventListener("keydown", onKey); BodyScrollLock.unlock(); };
  }, [state?.open, state?.images?.length, setState]);

  // æ›åœ–æ™‚é‡ç½®ç¸®æ”¾ä½ç§»
  React.useEffect(() => { setScale(1); setTx(0); setTy(0); }, [index]);

  const onOverlayClick = (e) => { if (e.target === containerRef.current) setState(v => ({ ...v, open: false })); };
  const onDoubleClick = (e) => { e.preventDefault(); setScale(s => s === 1 ? 2 : 1); if (scale !== 1) { setTx(0); setTy(0); } };

  // æ‰‹å‹¢ï¼šå·¦å³æ»‘æ›åœ–ã€ä¸‹æ»‘é—œé–‰ã€æ‹–æ›³å¹³ç§»ï¼ˆæ”¾å¤§æ™‚ï¼‰
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchMove = (e) => { if (!dragging) return; const dx = e.touches[0].clientX - sx; const dy = e.touches[0].clientY - sy; if (scale > 1) { setTx(dx / 2); setTy(dy / 2); } };
  const onTouchEnd = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dy) > 120 && Math.abs(dy) > Math.abs(dx)) { setState(v => ({ ...v, open: false })); return; }
    if (Math.abs(dx) > 80 && scale === 1 && hasImages) {
      if (dx > 0) setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      else setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    }
    setTx(0); setTy(0);
  };

  if (!state?.open) return null;

  return (
    <div ref={containerRef} className="fixed inset-0 z-[999] bg-black/85 flex flex-col" role="dialog" aria-modal="true" onClick={onOverlayClick}>
      <div className="flex items-center justify-between px-3 py-2 text-white text-sm">
        <div className="truncate pr-2">{state?.title || ""}</div>
        <div className="flex items-center gap-2">
          {hasImages && <span>{index + 1} / {state.images.length}</span>}
          <button className="px-2 py-1 rounded bg-white/10" onClick={() => setState(v => ({ ...v, open: false }))}>é—œé–‰</button>
        </div>
      </div>

      <div className="relative flex-1 flex items-center justify-center select-none"
           onDoubleClick={onDoubleClick} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
        {hasImages && (
          <>
            <button className="absolute left-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length })); }} aria-label="ä¸Šä¸€å¼µ" />
            <button className="absolute right-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index + 1) % v.images.length })); }} aria-label="ä¸‹ä¸€å¼µ" />
          </>
        )}
        {src
          ? <img ref={imgRef} src={src} alt="" style={{ transform: `translate(${tx}px, ${ty}px) scale(${scale})`, transition: 'transform .15s ease-out' }}
                 className="max-w-[min(100vw,1200px)] max-h-[calc(100vh-90px)] object-contain select-none" />
          : <div className="text-white/70">ç„¡åœ–ç‰‡</div>}
      </div>

      <div className="px-3 py-2 border-t border-white/10 text-xs text-white/70 text-center">
        å·¦å³æ»‘å‹•æ›åœ– Â· é›™æ“Šæ”¾å¤§ Â· é»ç©ºç™½é—œé–‰
      </div>
    </div>
  );
}


/* ============================
 * ç­‰å¾…é–‹çï¼ˆæ¸…å–® + è·³å‡ºå¼è³‡è¨Š + æŠ½çå±•ç¤ºï¼‰
 * - ä¸åˆªä»»ä½•æ—¢æœ‰åŠŸèƒ½ï¼ˆç·¨è¼¯/æ–°å¢/åˆªé™¤/ä¸‰ç¨®è½‰æ­·å²/æœå°‹/åˆ†é /9æˆ–16å®®æ ¼â€¦ï¼‰
 * - é»å¡ç‰‡ï¼šæ‰“é–‹ ProductSheetï¼ˆcontext="pending"ï¼‰
 * ============================ */
function Pending({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;
  const nidSafe = (typeof nid === "function") ? nid : () => Math.random().toString(36).slice(2);

  const prefKey = "pending_prefs_v2";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9"); // grid9 / grid16
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // å…¼å®¹ï¼špending.items æˆ– pending é™£åˆ—
  const raw = Array.isArray(data?.pending?.items) ? data.pending.items :
              (Array.isArray(data?.pending) ? data.pending : []);

  const parseLinesClean = (txt) => String(txt||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    const tags   = Array.isArray(it?.tags) ? it.tags   : (typeof it?.tags === "string" ? it.tags.split(",").map(s=>s.trim()).filter(Boolean) : []);
    let candidates = [];
    if (Array.isArray(it?.participants)) candidates = it.participants;
    else if (Array.isArray(it?.members)) candidates = it.members;
    else if (Array.isArray(it?.list)) candidates = it.list;
    else if (Array.isArray(it?.candidates)) candidates = it.candidates;
    else if (typeof it?.listText === "string") candidates = parseLinesClean(it.listText);
    const planned = Number.isFinite(+it?.plannedWinners) ? +it.plannedWinners : 1;
    return { ...it, _images: images, _tags: tags, _candidates: candidates.map(String).filter(Boolean), _planned: planned };
  };

  const allItems = React.useMemo(()=> raw.map(normalizeItem), [raw]);

  // æœå°‹
  const [search, setSearch] = React.useState(query || "");
  const filtered = React.useMemo(()=>{
    const kw = String(search||"").trim().toLowerCase();
    return allItems.filter(x=>{
      const hay = [x?.title, x?.name, x?.desc, x?.intro, x?._tags?.join(" ")].map(s=>String(s||"").toLowerCase()).join(" ");
      return !kw || hay.includes(kw);
    });
  }, [allItems, search]);

  // æ’åºï¼ˆæŒ‰æ›´æ–°æ™‚é–“ï¼‰
  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered]);

  // åˆ†é 
  const total = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [search, view, pageSize]);

  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems = sorted.slice(start, end);

  // Viewerï¼ˆå…±ç”¨å…¨åŸŸ Viewerï¼‰
  const [viewer, setViewer] = React.useState({ open:false, images:[], index:0, title:"" });
  React.useEffect(()=>{
    if (!viewer.open) return;
    const onKey = (e)=>{
      if (e.key==="Escape") setViewer(v=>({ ...v, open:false }));
      if (e.key==="ArrowLeft") setViewer(v=>({ ...v, index:(v.index-1+v.images.length)%v.images.length }));
      if (e.key==="ArrowRight") setViewer(v=>({ ...v, index:(v.index+1)%v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return ()=>{ document.removeEventListener("keydown", onKey); document.body.style.overflow = prev; };
  }, [viewer.open, viewer.images.length]);

  const openViewer = (images, index, title="")=>{
    const list = Array.isArray(images) ? images.filter(Boolean) : (images ? [images] : []);
    if (!list.length) return;
    setViewer({ open:true, images:list, index: Math.max(0, Math.min(index||0, list.length-1)), title });
  };

  // è¡¨å–®ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰
  const [draft, setDraft] = React.useState({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  const [editingId, setEditingId] = React.useState(null);

  function upsertFromDraft() {
    if (!admin) return alert("è«‹å…ˆç™»å…¥ç®¡ç†æ¨¡å¼");
    const title = (draft.title || "").trim();
    if (!title) return alert("è«‹å¡«å¯«ã€çé …åç¨±ã€‘");
    const planned = draft.plannedWinners !== "" ? Number(draft.plannedWinners) : 1;
    if (draft.plannedWinners !== "" && !Number.isFinite(planned)) return alert("æŠ½å‡ºåé¡éœ€ç‚ºæ•¸å­—");
    const rec = {
      id: editingId || nidSafe(),
      title,
      date: draft.date || "",
      image: (draft.image || "").trim(),
      participants: parseLinesClean(draft.participantsText),
      plannedWinners: planned
    };
    if (editingId) {
      const next = raw.map(x => x.id === editingId ? rec : x);
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); setEditingId(null); alert("å·²å„²å­˜ä¿®æ”¹");
    } else {
      const next = [rec, ...raw];
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); alert("å·²æ–°å¢æ´»å‹•");
    }
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function editItem(x) {
    if (!admin) return;
    setEditingId(x?.id || null);
    setDraft({
      date: x?.date || "",
      title: x?.title || "",
      image: x?.image || (Array.isArray(x?._images)&&x._images[0]) || "",
      participantsText: Array.isArray(x?._candidates) ? x._candidates.join("\n") : (Array.isArray(x?.participants) ? x.participants.join("\n") : ""),
      plannedWinners: Number.isFinite(+x?._planned) ? String(x._planned) : (x?.plannedWinners ?? "")
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function cancelEdit(){
    setEditingId(null);
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function removeItemObj(x){
    if (!admin) return;
    if (!confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) return;
    const next = raw.filter(it => (it.id ?? it) !== (x.id ?? x));
    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
    setData(s => ({ ...s, pending: nextP }));
  }

  // è½‰æ­·å²ï¼ˆå…±ç”¨ï¼‰
  function convertToHistoryByWinners(id, winners) {
    if (!admin) return;
    const now = raw.find(x => x.id === id);
    if (!now) return;
    const rest = raw.filter(x => x.id !== id);
    const history = Array.isArray(data?.history) ? data.history : [];
    const rec = {
      id: nidSafe(),
      date: now.date || "",
      title: now.title || "",
      winners: Array.isArray(winners) ? winners : [],
      status: "å·²æŠ½å‡º",
      note: ""
    };
    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: rest } : rest;
    setData(s => ({ ...s, pending: nextP, history: [rec, ...history] }));
    alert("å·²è½‰å…¥æ­·å²");
  }

  // ç®¡ç†ç”¨ï¼šä¸€æ¬¡æ€§æ¨¡æ“¬ï¼ˆä¸èµ°å‹•ç•«ï¼›å±•ç¤ºå‹•ç•«ç”¨ DrawSimulatorï¼‰
  function simulateOnce(list, count){
    const names = Array.isArray(list) ? list.slice() : [];
    const n = Math.max(1, Math.min(count || 1, names.length));
    for (let k = names.length-1; k > 0; k--) {
      const j = Math.floor(Math.random()*(k+1));
      [names[k], names[j]] = [names[j], names[k]];
    }
    return names.slice(0, n);
  }
  function convertBySimulation(x){ // ç”¨æ¨¡æ“¬çµæœï¼ˆä¸€æ¬¡æ€§ï¼‰
    const winners = simulateOnce(x._candidates, x._planned || 1);
    convertToHistoryByWinners(x.id, winners);
  }
  function convertByChecked(x, checkedMap){
    const names = Object.keys(checkedMap||{}).filter(k => checkedMap[k]);
    if (!names.length) return alert("å°šæœªå‹¾é¸äººå“¡");
    convertToHistoryByWinners(x.id, names);
  }
  function convertByInput(x){
    const txt = prompt("è«‹è²¼ä¸Šå¾—çåå–®ï¼ˆæ¯è¡Œä¸€åï¼‰",""); 
    if (txt==null) return;
    const names = parseLinesClean(txt);
    if (!names.length) return alert("æ²’æœ‰æœ‰æ•ˆäººå");
    convertToHistoryByWinners(x.id, names);
  }

  // ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡ï¼ˆå«è‡ªå‹•æ˜ŸæœŸï¼‰
  function copyAdText(x){
    const planned = Number.isFinite(+x?._planned) ? +x._planned : 1;
    const dateStr = String(x?.date || "").trim(); // ä¾‹å¦‚ 2025-09-08
    const weekday = (s) => {
      if (!s) return "";
      const d = new Date(s + "T00:00:00");
      const zh = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      return zh[d.getDay()] || "";
    };
    const endW = weekday(dateStr);
    let announceDate = "";
    let announceW = "";
    if (dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate()+1);
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
      announceDate = `${y}-${m}-${dd}`;
      announceW = weekday(announceDate);
    }
    const perCount = 1; // æ¯äººé è¨­ 1
    const howTo = "ç›´æ¥åœ¨é€™ç¯‡ç•™è¨€ã€Œæˆ‘è¦åƒåŠ ã€å³å¯ï¼";

    const text = [
      "ğŸ‰ã€é™æ™‚æŠ½çä¾†å•¦ï¼ã€‘ğŸ‰",
      "é€™æ¬¡è¦é€å‡ºçš„çå“æ˜¯ ğŸ‘‡",
      "",
      `ğŸ ${x?.title || "ï¼ˆçå“åç¨±ï¼‰"}`,
      `å…±æŠ½ ${planned} åï¼Œæ¯äºº ${perCount} ï¼`,
      "",
      `ğŸ“Œ æŠ½å‡ºåé¡ï¼š${planned} ä½å¹¸é‹å…’`,
      `ğŸ“… æˆªæ­¢æ™‚é–“ï¼š${dateStr ? `${dateStr}ï¼ˆæ˜ŸæœŸ${endW}ï¼‰` : "ï¼ˆè‡ªé¸/å¡«æ—¥æœŸï¼‰"} æ™šä¸Š 23:59 å‰`,
      `ğŸ•° é–‹çå…¬å‘Šï¼š${announceDate ? `${announceDate}ï¼ˆæ˜ŸæœŸ${announceW}ï¼‰` : "ï¼ˆæˆªæ­¢ç¿Œæ—¥ï¼‰"} æ™šé–“å…¬å¸ƒæ–¼ç¾¤çµ„`,
      "",
      "ğŸ“£ åƒåŠ æ–¹å¼ï¼šï¼ˆå¯è‡ªå¡«ï¼‰",
      howTo,
      "",
      "âœ… å®Œå…¨å…è²»åƒåŠ ",
      "âœ… å¾—çåªéœ€è‡ªä»˜é‹è²»ï¼ˆå¯é¸è²¨åˆ°ä»˜æ¬¾ï¼‰",
    ].join("\n");

    navigator.clipboard?.writeText(text)
      .then(()=>alert("å·²è¤‡è£½æŠ½çè²¼æ–‡"))
      .catch(()=>alert("ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–"));
  }

  // å…§å»º Viewerï¼ˆä¿ç•™ï¼‰
  React.useEffect(()=>{}, []);

  // è·³å‡ºå¼è³‡è¨Šé¢æ¿
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // æŠ½çå±•ç¤º
  const [draw, setDraw] = React.useState({ open:false, item:null });

  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  // åˆ†é å™¨
  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
    </div>
  );

  // å·¥å…·åˆ—
  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        <input className="min-h-[44px] flex-1 rounded border px-3 py-2" placeholder="æœå°‹æ´»å‹•..." value={search} onChange={e=>setSearch(e.target.value)} />
        <label className="flex items-center gap-1">
          ç‰ˆé¢
          <select className="min-h-[44px] rounded border px-2 py-1" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 å®®æ ¼</option><option value="grid16">16 å®®æ ¼</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          æ¯é 
          <select className="min-h-[44px] rounded border px-2 py-1" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>
        {admin && (
          <button className="ml-auto rounded-lg border px-3 py-1.5" onClick={()=>window.scrollTo({top:0,behavior:"smooth"})}>æ–°å¢/ç·¨è¼¯</button>
        )}
      </div>
    </div>
  );

  // å¡ç‰‡å…§å‹¾é¸ mapï¼ˆæ¯å¼µå¡è‡ªå·±çš„ stateï¼‰
  const Card = ({ x, i }) => {
    const title = x?.title || x?.name || 'ï¼ˆæœªå‘½åï¼‰';
    const cover = Array.isArray(x?._images) && x._images.length>0 ? x._images[0] : (x?.image || "");
    const images = x._images || (cover ? [cover] : []);
    const count  = Array.isArray(x._candidates) ? x._candidates.length : 0;

    const [checkedMap, setCheckedMap] = React.useState({});
    const toggleCheck = (name) => setCheckedMap(m => ({...m, [name]: !m[name]}));

    return (
      <details key={x.id || i} className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden">
        <summary className="list-none cursor-pointer p-3" onClick={(e)=>{ e.preventDefault(); setSheet({ open:true, item:x }); }}>
          <div className="flex flex-col">
            <div className="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
              {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
              <div className="absolute left-2 top-2 rounded bg-black/60 text-white text-xs px-2 py-1">å€™é¸ {count} äºº</div>
            </div>
            <div className="mt-2 text-[13px] font-medium truncate" title={title}>{title}</div>
            {x.date && <div className="text-xs text-slate-500">æ—¥æœŸï¼š{x.date}</div>}
          </div>
        </summary>

        {/* å±•é–‹å…§å®¹ï¼ˆä¿ç•™ç›¸å®¹ï¼›ä»å¯å±•é–‹ï¼‰ */}
        <div className="px-3 pb-3">
          {Array.isArray(images) && images.length>0 && (
            <div className="mt-2 -mx-1 px-1 flex overflow-x-auto gap-2 snap-x snap-mandatory">
              {images.map((src,idx)=>(
                <button key={idx} className="shrink-0 w-24 aspect-square rounded-lg overflow-hidden border snap-start bg-white/60 dark:bg-slate-900/50" title={`åœ–ç‰‡ ${idx+1}`} onClick={(e)=>{ e.preventDefault(); openViewer(images, idx, title); }}>
                  <img src={src} alt="" className="w-full h-full object-contain" loading="lazy" />
                </button>
              ))}
            </div>
          )}

          {/* ç®¡ç†å“¡æ“ä½œï¼ˆä¿ç•™ï¼‰ */}
          {admin && (
            <div className="mt-3 space-y-2">
              {/* å‹¾é¸åå–® */}
              <div>
                <div className="mb-1 text-sm font-medium">å·²å ±åï¼ˆ{x._candidates.length} äººï¼‰</div>
                {x._candidates.length===0 ? <div className="text-slate-500">å°šç„¡åå–®</div> : (
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
                    {x._candidates.map((n,ii)=>(
                      <label key={ii} className="rounded border px-2 py-1 flex items-center gap-2">
                        <input type="checkbox" checked={!!checkedMap[n]} onChange={()=>toggleCheck(n)} />
                        <span>{n}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>

              {/* ç®¡ç†æŒ‰éˆ• */}
              <div className="flex flex-wrap gap-2 justify-end">
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>editItem(x)}>ç·¨è¼¯</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>copyAdText(x)}>ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertBySimulation(x)}>ä»¥æ¨¡æ“¬çµæœè½‰æ­·å²</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByChecked(x, checkedMap)}>ä»¥å‹¾é¸åå–®è½‰æ­·å²</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByInput(x)}>ç›´æ¥è¼¸å…¥åå–®è½‰æ­·å²</button>
                <button className="rounded-lg bg-rose-500 text-white px-3 py-1.5" onClick={()=>removeItemObj(x)}>åˆªé™¤</button>
              </div>
            </div>
          )}
        </div>
      </details>
    );
  };

  return (
    <section className="space-y-3">
      {/* æ–°å¢/ç·¨è¼¯è¡¨å–®ï¼ˆç®¡ç†å“¡å¯è¦‹ï¼‰ */}
      {admin && (
        <div className="rounded-xl border p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="min-h-[44px] rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d, date:e.target.value}))} placeholder="é–‹ç/æˆªæ­¢æ—¥æœŸ"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d, title:e.target.value}))} placeholder="çé …åç¨±"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.plannedWinners} onChange={e=>setDraft(d=>({...d, plannedWinners:e.target.value}))} placeholder="æŠ½å‡ºåé¡ï¼ˆå¯ç©ºï¼Œé è¨­1ï¼‰"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.image} onChange={e=>setDraft(d=>({...d, image:e.target.value}))} placeholder="å°é¢åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">å·²å ±ååå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
            <textarea className="mt-1 w-full rounded-lg border p-2 h-28" value={draft.participantsText} onChange={e=>setDraft(d=>({...d, participantsText:e.target.value}))}/>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-3 py-1.5">å–æ¶ˆ</button>}
            <button onClick={upsertFromDraft} className="rounded-lg bg-brand text-white px-3 py-1.5">{editingId?"å„²å­˜ä¿®æ”¹":"æ–°å¢æ´»å‹•"}</button>
          </div>
        </div>
      )}

      {/* å·¥å…·åˆ— + åˆ†é å™¨ */}
      <div className="sticky top-0 z-10"><Toolbar /></div>
      <div className="sm:flex"><Paginator /></div>

      {/* æ¸…å–® */}
      <div className={`grid ${gridCols} gap-3`} aria-label="ç­‰å¾…é–‹çæ¸…å–®">
        {pageItems.map((x, i) => <Card key={x.id || i} x={x} i={i} />)}
      </div>

      <Paginator />

      {/* å…§å»º Viewerï¼ˆå…±ç”¨ï¼‰ */}
      <Viewer state={viewer} setState={setViewer} />

      {/* è·³å‡ºå¼è³‡è¨Šé¢æ¿ï¼ˆç­‰å¾…é–‹çï¼‰ */}
      <ProductSheet
        open={sheet.open}
        item={sheet.item}
        context="pending"
        admin={!!admin}
        onClose={()=>setSheet({ open:false, item:null })}
        onOpenViewer={(images, idx, title)=>openViewer(images, idx, title)}
        onStartDraw={(it)=>setDraw({ open:true, item:it })}
        onAdmin={{
          onEdit:  (it)=>editItem(it),
          onDelete:(it)=>removeItemObj(it),
          onCopyAd:(it)=>copyAdText(it),
          onConvertBySim:(it)=>convertBySimulation(it),
          onConvertByChecked:(it)=>{
            // é¢æ¿ä¸­çš„å‹¾é¸èˆ‡å¡ç‰‡å…§å‹¾é¸ä¸æ˜¯åŒä¸€ stateï¼›é€™è£¡æä¾›å¿«é€Ÿå…¨æŠ½ï¼ˆç”¨å…¨éƒ¨å€™é¸ï¼‰
            convertByChecked(it, Object.fromEntries((it?._candidates||[]).map(n=>[n,true])));
          },
          onConvertByInput:(it)=>convertByInput(it),
          checkedMap:{}, toggleCheck:()=>{}
        }}
      />

      {/* æŠ½çå±•ç¤ºï¼ˆå…¨è¢å¹•è¦†è“‹ï¼‰ */}
      <DrawSimulator
        open={draw.open}
        onClose={()=>setDraw({ open:false, item:null })}
        participants={draw.item ? normalizeItem(draw.item)._candidates : []}
        defaultCount={draw.item ? normalizeItem(draw.item)._planned || 1 : 1}
      />
    </section>
  );
}


/* ============================
 * è·³å‡ºå¼è³‡è¨Šé¢æ¿ï¼ˆç¤¾ç¾¤å•†åº— / é»æ•¸å•†åŸ / ç­‰å¾…é–‹çï¼‰
 * - æ‰‹æ©Ÿ/æ¡Œé¢ç½®ä¸­ã€å…§å®¹å¯æ»¾å‹•
 * - é»é®ç½©ç©ºç™½ã€ESCã€è¿”å›éµå¯é—œé–‰
 * - context: "store" | "shop" | "pending"
 * - ä½¿ç”¨ BodyScrollLockï¼Œä¸¦å…§å»ºè¯çµ¡ç®¡ç†å“¡é€£çµ fallback
 * ============================ */
function ProductSheet({
  open = false,
  item = null,
  context = "store",
  onClose = () => {},
  onOpenViewer = () => {},
  contactUrl = "",               // å¯ä¸å‚³ï¼›æœƒè‡ªå‹• fallback
  onCopyTemplate = () => {},
  onStartDraw = () => {},        // for pendingï¼šé–‹å±•ç¤ºå‹•ç•«
  admin = false,                 // for pendingï¼šæ˜¯å¦é¡¯ç¤ºç®¡ç†å€å¡Š
  onAdmin = {}                   // for pendingï¼š{ onEdit, onDelete, onConvertBySim, onConvertByChecked, onConvertByInput, onCopyAd, checkedMap, toggleCheck }
}) {
  const React = window.React || globalThis.React;

  // ---- hooks çš†ç„¡æ¢ä»¶å‘¼å«ï¼ˆé¿å… #310ï¼‰----
  const overlayRef = React.useRef(null);
  const [index, setIndex] = React.useState(0);

  // é–æ²å‹• / ESC / è¿”å›éµï¼ˆä½¿ç”¨å…¨åŸŸé–ï¼‰
  React.useEffect(() => {
    if (!open) return;
    BodyScrollLock.lock();
    const onKey = (e) => { if (e.key === "Escape") onClose(); };
    const onPop = () => onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    try { history.pushState({ sheet: true }, "", location.href); } catch {}
    return () => { document.removeEventListener("keydown", onKey); window.removeEventListener("popstate", onPop); BodyScrollLock.unlock(); };
  }, [open, onClose]);

  // item è®Šå‹•é‡ç½®åœ–ç‰‡ç´¢å¼•
  React.useEffect(() => { setIndex(0); }, [item]);

  // ---- é hook çš„è¡ç”Ÿè³‡æ–™ ----
  const title = (item?.title || item?.name || "ï¼ˆæœªå‘½åï¼‰");
  const images = (() => {
    const arr = Array.isArray(item?.images) ? item.images : (item?.image ? [String(item.image)] : []);
    return (arr || []).filter(Boolean);
  })();
  const tags = (() => {
    if (Array.isArray(item?.tags)) return item.tags;
    if (typeof item?.tags === "string") return item.tags.split(",").map(s => s.trim()).filter(Boolean);
    return [];
  })();
  const buyUrl = item?.buyUrl || item?.url || "";
  const price  = (item?.price ?? "") !== "" ? item?.price : null;
  const needPoints = (() => {
    const p = item?.points ?? item?.point ?? item?.needPoints ?? item?.need_point;
    const n = (typeof p === "string" ? +p : p);
    return Number.isFinite(n) ? n : null;
  })();
  const remain = item?.stock ?? item?.qty ?? item?.quantity ?? item?.remaining ?? null;

  // pendingï¼šå€™é¸åå–®ï¼ˆä¸å¯«å›è³‡æ–™ï¼‰
  const candidates = (() => {
    const list = Array.isArray(item?.participants) ? item.participants
      : Array.isArray(item?.members) ? item.members
      : Array.isArray(item?.list) ? item.list
      : Array.isArray(item?.candidates) ? item.candidates
      : (typeof item?.listText === "string" ? item.listText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean) : []);
    return (list || []).map(String).filter(Boolean);
  })();
  const candidateCount = candidates.length;

  // è§¸æ§å·¦å³æ»‘æ›åœ–
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchEnd = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy) && images.length > 1) {
      setIndex(i => (dx > 0 ? (i - 1 + images.length) : (i + 1)) % images.length);
    }
  };

  // ---- shop ç”¨è¯çµ¡ç®¡ç†å“¡é€£çµï¼ˆå¤šä¾†æº fallbackï¼‰----
  const effectiveContactUrl =
    contactUrl ||
    item?.contactUrl ||            // å–®ä¸€å•†å“å¯è¦†å¯«
    window.__CONTACT_URL__ || "";  // å…¨åŸŸè¨­å®šï¼ˆå¯åœ¨åˆå§‹åŒ–æ™‚è¨­å®šï¼‰

  if (!open) return null;
  const handleOverlayClick = (e) => { if (e.target === overlayRef.current) onClose(); };

  return (
    <div ref={overlayRef} className="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center"
         role="dialog" aria-modal="true" onMouseDown={handleOverlayClick}>
      <div className="w-[min(96vw,44rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        {/* header */}
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div className="min-w-0">
            <div className="font-semibold truncate">{title}</div>
            {context==="store"   && price!=null      && <div className="text-sm text-slate-500">å”®åƒ¹ï¼š{price}</div>}
            {context==="shop"    && needPoints!=null && <div className="text-sm text-slate-500">éœ€æ±‚é»æ•¸ï¼š{needPoints}</div>}
            {context==="pending" && <div className="text-sm text-slate-500">å€™é¸äººæ•¸ï¼š{candidateCount}</div>}
          </div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
        </div>

        {/* ã€æ–°å¢ã€‘pending å°ˆç”¨ï¼šåƒèˆ‡äººå“¡åå–®ï¼ˆå¯æ²å‹•ã€é¡¯ç¤ºç¸½æ•¸ï¼‰ */}
        {context === "pending" && (
          <div className="px-4 pt-3 pb-4">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium">åƒèˆ‡äººå“¡åå–®</div>
              {/* å†æ¬¡é¡¯ç¤ºç¸½æ•¸ï¼Œèˆ‡æ¨™é¡Œåˆ—ä¸€è‡´ */}
              <div className="text-xs text-slate-500">å…± {candidateCount} ä½</div>
            </div>

            <div className="max-h-48 sm:max-h-64 overflow-y-auto rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/40 p-3 text-sm leading-6">
              {candidates && candidates.length ? (
                candidates.map((name, i) => (
                  <div key={i} className="truncate">
                    {i + 1}. {name}
                  </div>
                ))
              ) : (
                <div className="text-slate-500">ç›®å‰æ²’æœ‰åƒèˆ‡äººå“¡</div>
              )}
            </div>
          </div>
        )}

        {/* bodyï¼šä¸»åœ– + ç¸®åœ– + æ–‡å­— */}
        <div className="flex-1 overflow-y-auto">
          <div className="relative bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
            <div className="aspect-square w-full grid place-content-center" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
              {images.length
                ? (
                  <img
                    src={images[index]}
                    alt=""
                    className="w-full h-full object-contain select-none"
                    onClick={() => { if (context === "pending") onOpenViewer?.(images, index, title, buyUrl); }}
                  />
                )
                : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
            </div>
            {images.length>1 && (
              <div className="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1">
                {images.map((_, i) => (
                  <span key={i} className={"h-1.5 w-1.5 rounded-full " + (i===index ? "bg-slate-900 dark:bg-white" : "bg-slate-300 dark:bg-slate-600")}/>
                ))}
              </div>
            )}
          </div>

          {images.length>1 && (
            <div className="px-4 py-3 -mx-1 flex overflow-x-auto gap-2 snap-x snap-mandatory">
              {images.map((src, i) => (
                <button key={src+i} className={"shrink-0 w-20 aspect-square rounded-lg overflow-hidden border snap-start " + (i===index ? "border-brand ring-2 ring-brand/40" : "border-slate-200 dark:border-slate-700")} onClick={()=>setIndex(i)} title={`åœ–ç‰‡ ${i+1}`}>
                  <img src={src} alt="" className="w-full h-full object-contain" loading="lazy" />
                </button>
              ))}
            </div>
          )}

          <div className="px-4 pb-4 space-y-2 text-sm">
            {context==="store" && remain!=null && <div className="text-slate-600">å‰©é¤˜æ•¸é‡ï¼š{remain}</div>}
            {Array.isArray(tags) && tags.length>0 && <div className="text-slate-500">æ¨™ç±¤ï¼š{tags.join(" / ")}</div>}
            {item?.desc  && <div className="whitespace-pre-wrap">{item.desc}</div>}
            {item?.intro && <div className="whitespace-pre-wrap">{item.intro}</div>}
            {item?.extra && <div className="whitespace-pre-wrap">{String(item.extra)}</div>}

            {/* pendingï¼šç®¡ç†å“¡ç”¨åå–®å‹¾é¸ï¼ˆä¿ç•™åŠŸèƒ½ï¼Œä¸å¯«å›ï¼‰ */}
            {context==="pending" && admin && Array.isArray(candidates) && candidates.length>0 && (
              <div className="mt-2">
                <div className="mb-1 text-sm font-medium">å·²å ±åï¼ˆ{candidates.length} äººï¼‰</div>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
                  {candidates.map((n,i)=>(
                    <label key={i} className="rounded border px-2 py-1 flex items-center gap-2">
                      <input type="checkbox" checked={!!onAdmin?.checkedMap?.[n]} onChange={()=>onAdmin?.toggleCheck?.(n)} />
                      <span>{n}</span>
                    </label>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* footer */}
        <div className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {context==="store" ? (
            <>
              {buyUrl
                ? <a href={buyUrl} target="_blank" rel="noopener noreferrer" className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm text-center">å‰å¾€è³¼è²·</a>
                : <button className="flex-1 rounded-lg border px-4 py-2 text-sm text-slate-400" disabled>å°šæœªæä¾›è³¼è²·é€£çµ</button>}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          ) : context==="shop" ? (
            <>
              <button className="flex-1 rounded-lg border px-4 py-2 text-sm" onClick={() => onCopyTemplate(item)}>ğŸ“‹ è¤‡è£½æ¨¡æ¿</button>
              <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={() => {
                const url = effectiveContactUrl;
                if (url) window.open(url, "_blank", "noopener,noreferrer");
                else alert("å°šæœªè¨­å®šã€è¯çµ¡ç®¡ç†å“¡ã€é€£çµï¼šå¯åœ¨å•†å“ data åŠ ä¸Š contactUrlï¼Œæˆ–åœ¨å…¨åŸŸè¨­ç½® window.__CONTACT_URL__ã€‚");
              }}>ğŸ’¬ è¯çµ¡ç®¡ç†å“¡</button>
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          ) : (
            // pending
            <>
              <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={() => onStartDraw(item)}>ğŸ° æ¨¡æ“¬æŠ½çï¼ˆå±•ç¤ºï¼‰</button>
              {admin && (
                <div className="flex-1 flex flex-wrap gap-2 justify-end">
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onEdit?.(item)}>ç·¨è¼¯</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onCopyAd?.(item)}>ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertBySim?.(item)}>ä»¥æ¨¡æ“¬çµæœè½‰æ­·å²</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertByChecked?.(item)}>ä»¥å‹¾é¸åå–®è½‰æ­·å²</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertByInput?.(item)}>ç›´æ¥è¼¸å…¥åå–®è½‰æ­·å²</button>
                  <button className="rounded-lg bg-rose-500 text-white px-3 py-2 text-sm" onClick={()=>onAdmin?.onDelete?.(item)}>åˆªé™¤</button>
                </div>
              )}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}


/* ============================
 * æŠ½çæ¨¡æ“¬å™¨ï¼ˆå±•ç¤ºç”¨ï¼‰
 * - åªé¡¯ç¤ºå‹•ç•«èˆ‡çµæœï¼Œä¸å¯«å›è³‡æ–™ã€ä¸æä¾›è¤‡è£½/å¥—ç”¨
 * props:
 *   open, onClose, participants (string[]), defaultCount (number)
 * ============================ */
function DrawSimulator({ open=false, onClose=()=>{}, participants=[], defaultCount=1 }) {
  const React = window.React || globalThis.React;
  const overlayRef = React.useRef(null);

  const [count, setCount] = React.useState(Math.max(1, defaultCount||1));
  const [duration, setDuration] = React.useState(2200); // 2.2s
  const [running, setRunning] = React.useState(false);
  const [displayName, setDisplayName] = React.useState("");
  const [results, setResults] = React.useState([]);

  React.useEffect(()=>{
    if (!open) return;
    const onKey = (e)=>{ if (e.key==="Escape") onClose(); };
    const onPop = ()=> onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    try { history.pushState({ draw:true }, "", location.href); } catch {}
    return ()=> {
      document.removeEventListener("keydown", onKey);
      window.removeEventListener("popstate", onPop);
      document.body.style.overflow = prev;
    };
  }, [open]);

  const handleOverlayClick = (e)=>{ if (e.target === overlayRef.current && !running) onClose(); };

  const pickWinners = (arr, k) => {
    const list = [...arr];
    for (let i=list.length-1;i>0;i--) {
      const j = Math.floor(Math.random()*(i+1));
      [list[i], list[j]] = [list[j], list[i]];
    }
    return list.slice(0, Math.max(1, Math.min(k, list.length)));
  };

  const start = ()=>{
    if (!Array.isArray(participants) || participants.length===0) { alert("æ²’æœ‰å€™é¸åå–®"); return; }
    setResults([]);
    setRunning(true);
    const startTime = performance.now();
    const total = participants.length;
    let acc = 0, last = startTime;
    const loop = (t)=>{
      const dt = t - last; last = t;
      const p = Math.min(1, (t - startTime) / Math.max(800, duration));
      const ease = 1 - Math.pow(1 - p, 3); // easeOutCubic
      const speed = 30 + (180 - 30) * (1 - ease);
      acc += dt * (speed / 1000) * 20;
      const idx = Math.floor(acc) % total;
      setDisplayName(participants[idx] || "");
      if (p < 1) requestAnimationFrame(loop);
      else { setResults(pickWinners(participants, Math.max(1, +count||1))); setRunning(false); }
    };
    requestAnimationFrame(loop);
  };

  if (!open) return null;

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[1000] bg-black/70 backdrop-blur flex items-center justify-center"
      role="dialog" aria-modal="true"
      onMouseDown={handleOverlayClick}
    >
      <div className="w-[min(96vw,50rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
          <div className="font-semibold">æŠ½çæ¨¡æ“¬ï¼ˆå±•ç¤ºï¼‰</div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose} disabled={running}>é—œé–‰</button>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">æŠ½å‡ºäººæ•¸</span>
              <input type="number" min="1" max={Math.max(1, participants.length)} value={count} onChange={e=>setCount(Math.max(1, Math.min(+e.target.value||1, participants.length||1)))} className="w-20 rounded border px-2 py-1" />
            </label>
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">å‹•ç•«æ™‚é•·(ms)</span>
              <input type="number" min="800" step="100" value={duration} onChange={e=>setDuration(Math.max(800, +e.target.value||2200))} className="w-28 rounded border px-2 py-1" />
            </label>
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 p-6 min-h-[140px] grid place-content-center">
            <div className="text-2xl md:text-3xl font-semibold text-slate-800 dark:text-white tracking-wide animate-pulse select-none">
              {running ? (displayName || "æŠ½é¸ä¸­...") : (results.length ? "æŠ½é¸å®Œæˆ" : "æº–å‚™é–‹å§‹")}
            </div>
            {!running && !results.length && (
              <div className="mt-2 text-xs text-slate-500">åå–®æ•¸ï¼š{participants.length}</div>
            )}
          </div>

          {!!results.length && (
            <div className="space-y-2">
              <div className="text-sm text-slate-600">ä¸­çåå–®ï¼ˆ{results.length}ï¼‰</div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {results.map((name, i)=>(
                  <div key={name+i} className="rounded-lg border border-emerald-300/70 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 px-3 py-2 text-sm animate-[fadeIn_.6s_ease-out]">
                    <span className="opacity-70 mr-1">#{i+1}</span>{name}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="p-3 border-t border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {!running && <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={start}>é–‹å§‹æŠ½ç</button>}
          {running && <button className="flex-1 rounded-lg border px-4 py-2 text-sm" disabled>æŠ½é¸é€²è¡Œä¸­...</button>}
          <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose} disabled={running}>é—œé–‰</button>
        </div>
      </div>
    </div>
  );
}

/* å°å·¥å…·ï¼šhash/PRNGï¼ˆfor ç¨®å­é‡ç¾ï¼‰ */
function xmur3(str) { let h = 1779033703 ^ str.length; for (let i=0;i<str.length;i++) { h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h<<13 | h>>>19; } return function() { h = Math.imul(h ^ (h>>>16), 2246822507); h = Math.imul(h ^ (h>>>13), 3266489909); return (h ^= h>>>16) >>> 0; }; }
function mulberry32(a) { return function() { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }

// å–å¾—å•†å“å‰©é¤˜æ•¸é‡ï¼ˆç›¸å®¹å¤šç¨®æ¬„ä½å‘½åï¼‰
function getRemain(x){
  const cand = [x?.stock, x?.qty, x?.quantity, x?.remaining];
  for (const v of cand){
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    if (typeof v === 'string' && v.trim()!=='' && !Number.isNaN(+v)) return +v;
  }
  return null; // æ²’æœ‰æ•¸é‡å°±ä¸é¡¯ç¤º
}

// é˜²å‘†åˆªé™¤é—œéµå­—ç¢ºèªï¼ˆé è¨­é—œéµå­—ï¼šåˆªé™¤ï¼‰
function confirmKeyword({ label='', keyword='åˆªé™¤' } = {}){
  const input = prompt(`ç‚ºäº†é˜²å‘†ï¼Œè«‹è¼¸å…¥ã€Œ${keyword}ã€ä»¥ç¢ºèªï¼š\n${label}`);
  return input === keyword;
}

// â€”â€” ç©ºè³‡æ–™ï¼ˆå…¨éƒ¨ç•™çµ¦ä½ ç”¨ Admin å¾ŒçºŒæ–°å¢ï¼‰ â€”â€”
// ç›´æ¥åœ¨ EMPTY å…§æ”¾å…¥ settingsï¼ˆæ³¨æ„ others å¾Œé¢çš„é€—è™Ÿï¼‰
const EMPTY = {
  homepage: { title: 'é–‹çæ‰€', subtitle: 'å…è²»æŠ½çãƒ»ä¸å®šæœŸé©šå–œ', announcements: [] },
  history: [],     // ğŸ“š æ­·å²æŠ½çç´€éŒ„
  pending: [],     // â³ ç­‰å¾…é–‹ç
  ongoing: [],     // ğŸ”„ é€²è¡Œä¸­æ´»å‹•

  // ğŸ›ï¸ é»æ•¸å•†åŸï¼ˆåŸæœ¬å°±æœ‰ï¼‰
  shop: { items: [], people: [] },

  // ğŸ›’ï¼ˆæ–°å¢ï¼‰ç¤¾ç¾¤å•†åº—ï¼šçœŸéŒ¢è²©å”®ç”¨ï¼›æ”¯æ´å¤šåœ–ã€ä»‹ç´¹ã€å¤–éƒ¨è³¼è²·é€£çµ
  // images: [string]ï¼ˆåœ–ç‰‡ URL æˆ– ImageIO keyï¼‰ï¼Œæœƒè·Ÿè‘— data ä¸€èµ·åŒ¯å‡º
  // buyUrl: å¤–éƒ¨è³¼è²·ç¶²å€
  // stock: æ•¸é‡ï¼ˆå¯é¸ï¼‰ï¼Œprice: å”®åƒ¹ï¼ˆå­—ä¸²æˆ–æ•¸å­—ï¼‰
  // tags: ä¾‹å¦‚ ["ç©å…·","å®¶é›»"]ï¼Œå¯è¢«æœå°‹
  store: { items: [] },

  // ğŸ“Œ å…¶ä»–è³‡æ–™å¡ç‰‡é›†åˆï¼ˆé€™è¡Œå¾Œé¢ä¸€å®šè¦é€—è™Ÿï¼‰
  others: { cards: [] },

  settings: { ...DEFAULT_SETTINGS },
};



function normName(s=""){ return s.replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase(); }
function parseISODate(d=""){ // å°ˆåƒ YYYY-MM-DDï¼ˆç©ºå­—ä¸²å› NaNï¼‰
  if(!d) return NaN;
  // å¼·åˆ¶ç”¨ UTC é˜²æ­¢æ™‚å€åç§»
  const m = String(d).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return NaN;
  return Date.UTC(+m[1], +m[2]-1, +m[3]);
}
function sortHistoryDesc(arr=[]) {
  const safe = (x)=> {
    const t = parseISODate(x?.date || "");
    return Number.isNaN(t) ? -Infinity : t; // æ²’æ—¥æœŸçš„æ’æœ€ä¸‹
  };
  return [...arr].sort((a,b)=> safe(b) - safe(a));
}


/* === çµ±ä¸€æ—¥æœŸé¡¯ç¤ºï¼šæŠŠ YYYY-MM-DD â†’ YYYY/MM/DDï¼ˆç”¨ UTC å…æ™‚å€åå·®ï¼‰ === */
function formatDateYMD(ymd=""){
  const ts = parseISODate(ymd);        // ä½ æª”æ¡ˆè£¡å·²å­˜åœ¨çš„å‡½å¼:contentReference[oaicite:2]{index=2}
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2, '0');
  const day = String(d.getUTCDate()).padStart(2, '0');
  return `${y}/${m}/${day}`;
}

/* === ä¾æ­·å²ã€Œç‹€æ…‹ã€å›å‚³ä¸€å€‹æŸ”å’Œåº•è‰²ï¼ˆå¯é¸ç”¨ï¼‰ === */
function rowClassByStatus(status=""){
  switch(String(status).trim()){
    case "å·²å¯„å‡º":   return "bg-emerald-50/60 dark:bg-emerald-300/10";
    case "è™•ç†ä¸­":   return "bg-sky-50/60 dark:bg-sky-300/10";
    case "æœªå›è¦†":   return "bg-rose-50/60 dark:bg-rose-300/10";
    case "å†å¯„é€ä¸­": return "bg-indigo-50/60 dark:bg-indigo-300/10";
    case "å¾…å¯„é€":   return "bg-amber-50/60 dark:bg-amber-300/10";
    case "æ”¾æ£„é ˜ç": return "bg-slate-50/60 dark:bg-slate-300/10";
    default:         return "";
  }
}

// === Calendar helpers for History ===
function ymdStringUTC(y, mZeroBased, d) {
  const y4 = String(y).padStart(4, '0');
  const m2 = String(mZeroBased + 1).padStart(2, '0');
  const d2 = String(d).padStart(2, '0');
  return `${y4}-${m2}-${d2}`;
}

function buildMonthDaysUTC(y, mZeroBased) {
  // ä»¥ UTC è¨ˆç®—æœˆæ›†ï¼Œé¿å…æ™‚å€åç§»
  const first = new Date(Date.UTC(y, mZeroBased, 1));
  const startDow = first.getUTCDay(); // 0=Sun..6=Sat
  const daysInMonth = new Date(Date.UTC(y, mZeroBased + 1, 0)).getUTCDate();

  const days = [];
  for (let i = 0; i < startDow; i++) days.push(null); // å‰å°ç©ºæ ¼
  for (let d = 1; d <= daysInMonth; d++) {
    days.push(ymdStringUTC(y, mZeroBased, d));
  }
  return days;
}






// === Utils: æŠ½çç”¨ï¼ˆå®‰å…¨éš¨æ©Ÿ / å¯é¸ç¨®å­ï¼‰ ===
// å°‡å­—ä¸²è®Šæˆ 32-bit æ•´æ•¸ç¨®å­
function hash32(str="") {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
// xorshift32 ç”¢ç”Ÿå™¨ï¼ˆå¯é‡ç¾ï¼‰
function makePRNG(seedStr="") {
  if (!seedStr) return null; // æ²’ç¨®å­å°±ç”¨å®‰å…¨éš¨æ©Ÿ
  let x = hash32(seedStr) || 1;
  return function next() {
    // ç”¢ 0..1 çš„æµ®é»æ•¸
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    // è½‰æˆ 0..1
    return ((x >>> 0) / 4294967296);
  };
}
// Fisherâ€“Yates æ´—ç‰Œï¼›å„ªå…ˆä½¿ç”¨ prngï¼Œå¦å‰‡ç”¨ crypto å®‰å…¨éš¨æ©Ÿ
function shufflePick(arr, k, prng=null) {
  const a = arr.slice();
  const n = a.length;
  // åªæ´—åˆ°å–åˆ° k å€‹ç‚ºæ­¢
  for (let i = 0; i < k; i++) {
    let r;
    if (prng) {
      r = i + Math.floor(prng() * (n - i));
    } else {
      const buf = new Uint32Array(1);
      crypto.getRandomValues(buf);
      r = i + (buf[0] % (n - i));
    }
    [a[i], a[r]] = [a[r], a[i]];
  }
  return a.slice(0, k);
}

function drawCooldownKey(pendingId){ return `kjs_draw_cd_${pendingId}`; }

// === Announcement helpers (NEW) ===
// å®‰å…¨æŠŠ YYYY-MM-DD åŠ å¤©æ•¸ï¼ˆUTCï¼Œä¸åƒæ™‚å€èª¤å·®ï¼‰
function addDaysUTC(ymd="", days=1){
  const ts = parseISODate(ymd);
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  d.setUTCDate(d.getUTCDate() + days);
  const y = d.getUTCFullYear(), m = d.getUTCMonth(), day = d.getUTCDate();
  return ymdStringUTC(y, m, day);
}

// ä¾å¡ç‰‡è³‡æ–™ç”¢ç”Ÿå…¬å‘Šæ¨¡æ¿ï¼ˆå›å‚³å­—ä¸²ï¼‰
function buildAnnouncementText(p = {}, opts = {}) {
  const title   = p?.title || p?.name || "ï¼ˆæœªå‘½åï¼‰";
  const planned = Number(p?.planned || p?.quota || p?.winners || 1);
  const deadline = (p?.deadline || p?.date || "").toString().trim();
  const announce = deadline ? plusDays(deadline, 1) : "";
  const howTo = (typeof opts.howTo === "string" && opts.howTo.trim())
    ? opts.howTo.trim()
    : "ç›´æ¥åœ¨é€™ç¯‡ç•™è¨€ã€Œæˆ‘è¦åƒåŠ ã€å³å¯ï¼";

  return [
    "ğŸ‰ã€é™æ™‚æŠ½çä¾†å•¦ï¼ã€‘ğŸ‰",
    "é€™æ¬¡è¦é€å‡ºçš„å¯¦ç”¨å¥½ç‰©æ˜¯ ğŸ‘‡",
    "",
    `ğŸ ${title}`,
    `ğŸ“Œ æŠ½å‡ºåé¡ï¼š${planned} ä½å¹¸é‹å…’`,
    `ğŸ“… æˆªæ­¢æ™‚é–“ï¼š${deadline} æ™šä¸Š 23:59 å‰`,
    `ğŸ•° é–‹çå…¬å‘Šï¼š${announce} æ™šé–“å…¬å¸ƒæ–¼ç¾¤çµ„`,
    "",
    "ğŸ“£ åƒåŠ æ–¹å¼ï¼š(åˆå§‹å¦‚ä¸‹ï¼Œæ‡‰èƒ½æ›´æ”¹ï¼Œå¦‚æœ‰ç‰¹åˆ¥ä»»å‹™å¯è‡ªå¡«)",
    howTo,
    "",
    "âœ… å®Œå…¨å…è²»åƒåŠ ",
    "âœ… å¾—çåªéœ€è‡ªä»˜é‹è²»ï¼ˆå¯é¸è²¨åˆ°ä»˜æ¬¾ï¼‰",
  ].join("\n");
}

// å°å·¥å…·ï¼šæŠŠ YYYY-MM-DD åŠ  N å¤©
function plusDays(ymd, days){
  const d = new Date(ymd);
  if (Number.isNaN(d.getTime())) return ymd;
  d.setDate(d.getDate() + (days||0));
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2, "0"), dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

// === Collapseï¼ˆå¼·åŒ–ç‰ˆï¼Œå‘ä¸‹ç›¸å®¹ï¼‰===
// ä¿ç•™åŸï¼šheader, children, defaultOpen=false, force=null
// æ–°å¢ï¼šgroupï¼ˆåŒä¸€ç¾¤æ‰‹é¢¨ç´ idï¼‰ï¼Œuidï¼ˆè©²é …å”¯ä¸€ idï¼‰
function Collapse({ header, children, defaultOpen=false, force=null, group=null, uid=null }) {
  const { useState, useRef, useEffect } = React;
  const [open, setOpen] = useState(!!defaultOpen);
  const ref = useRef(null);
  const idRef = useRef(uid || Math.random().toString(36).slice(2,10));
  const grp = group || null;

  // force è¦†å¯«ï¼ˆé…åˆä½ çš„ã€Œå…¨éƒ¨å±•é–‹ï¼æ”¶åˆã€ï¼‰
  useEffect(() => {
    if (force === 'open') setOpen(true);
    else if (force === 'close') setOpen(false);
  }, [force]);

  // é«˜åº¦å‹•ç•«ï¼šä¾ open/children é‡æ–°è¨ˆç®—
  useEffect(() => {
    if (!ref.current) return;
    ref.current.style.height = open ? ref.current.scrollHeight + 'px' : '0px';
  }, [open, children]);

  // æ‰‹é¢¨ç´ï¼šåŒç¾¤æœ‰å…¶å®ƒé …ç›®æ‰“é–‹ â†’ é—œé–‰æˆ‘
  useEffect(() => {
    if (!grp) return;
    const onOpen = (e) => {
      const { group, uid } = e.detail || {};
      if (group === grp && uid !== idRef.current) setOpen(false);
    };
    document.addEventListener('kjs:accordionOpen', onOpen);
    return () => document.removeEventListener('kjs:accordionOpen', onOpen);
  }, [grp]);

  const handleToggle = () => {
    if (force === 'open' || force === 'close') return;
    const next = !open;
    setOpen(next);
    if (next && grp) {
      const ev = new CustomEvent('kjs:accordionOpen', { detail: { group: grp, uid: idRef.current }});
      document.dispatchEvent(ev);
    }
  };

  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white/70 dark:bg-slate-900/40">
      <button
        className="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-slate-50/80 dark:hover:bg-slate-800/60 transition"
        onClick={handleToggle}
        aria-expanded={open ? 'true' : 'false'}
        type="button"
      >
        <div className="font-medium">
          {typeof header === 'function' ? header(open) : header}
        </div>
        <svg className={"w-4 h-4 transition " + (open ? "rotate-180" : "")} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
      <div ref={ref} className="px-4 pb-4 transition-[height] duration-300 ease-in-out" style={{height: open?'auto':'0px'}}>
        <div className="pt-2">{children}</div>
      </div>
    </div>
  );
}


/***************************************************
 * useAccordionControllerï¼šæ‰‹é¢¨ç´æ§åˆ¶ï¼ˆä¸€æ¬¡åªé–‹ä¸€å€‹ï¼‰
 * ä¹Ÿæ”¯æ´ã€Œå…¨éƒ¨å±•é–‹ / å…¨éƒ¨æ”¶åˆã€è¦†å¯«
 ***************************************************/
function useAccordionController() {
  const [activeId, setActiveId] = React.useState(null); // æ­£åœ¨å±•é–‹çš„ id
  const [force, setForce] = React.useState(null);       // 'open' | 'close' | null

  const openAll  = () => setForce('open');
  const closeAll = () => { setForce('close'); setActiveId(null); };
  const clearForce = () => setForce(null);

  // ç¶åˆ°æ¯å€‹ Collapse ç”¨
  const bind = (id) => ({
    isOpen: force === 'open' ? true : force === 'close' ? false : activeId === id,
    force,
    onToggle: () => {
      if (force) setForce(null); // åªè¦æ‰‹å‹•åˆ‡æ›ï¼Œå›æ­¸æ‰‹é¢¨ç´æ¨¡å¼
      setActiveId(prev => (prev === id ? null : id));
    }
  });

  return { activeId, setActiveId, force, setForce, openAll, closeAll, clearForce, bind };
}

    // â€”â€” ä¸» Appï¼ˆPart 1ï¼šéª¨æ¶/å°è¦½/é›™æ¨¡å¼/åŒ¯å…¥åŒ¯å‡ºï¼Œæœªå«ç·¨è¼¯å™¨ï¼‰ â€”â€”
    function App(){
      const [data, setData] = useLocalState(LS.data, EMPTY);

// é€²ç«™æ™‚è‡ªå‹•æŠ“ ./data/app.jsonï¼Œè¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Œä¸¦åŒæ­¥ç®¡ç†å“¡åå–®ï¼ˆadminsï¼‰
React.useEffect(() => {
  (async () => {
    try {
      const res = await fetch('./data/app.json?v=' + Date.now(), { cache: 'no-store' });
      const raw = await res.json();

      // åŒæ™‚ç›¸å®¹å…©ç¨®æ ¼å¼ï¼šæ‰å¹³ { ... } æˆ– åŒ…ä¸€å±¤ { _meta, data, admins }
      const obj = raw && typeof raw === 'object' && 'data' in raw ? raw.data : raw;

      // æ­·å²ç”±æ–°åˆ°èˆŠ
      if (obj && Array.isArray(obj.history)) {
        obj.history = sortHistoryDesc(obj.history);
      }

      // å¯«å…¥è³‡æ–™æœ¬é«”
      if (obj && typeof obj === 'object') {
        setData(obj);
      } else {
        console.error('app.json çµæ§‹ç•°å¸¸ï¼šæœŸæœ›ç‚ºç‰©ä»¶ï¼Œå¯¦å¾—', obj);
      }

// â˜… æ–°å¢ï¼šæŠŠ app.json çš„èƒŒæ™¯è¨­å®šä¹ŸçŒå› stateï¼ˆå« url / pos / menu...ï¼‰
if (raw && typeof raw === 'object' && raw.bg) {
  setBg(raw.bg);
}

// ï¼ˆå¯é¸ï¼‰è‹¥ä½ æœ‰ç”¨ ImageIOï¼Œé †æ‰‹æŠŠ images ä¹ŸåŒ¯å…¥
if (raw && typeof raw === 'object' && raw.images && window.ImageIO?.importImagesJSON) {
  try { window.ImageIO.importImagesJSON(raw.images); } catch {}
}

      // â˜… æ–°å¢ï¼šè‹¥ app.json æä¾› adminsï¼Œè¦†è“‹æœ¬æ©Ÿçš„ç®¡ç†å“¡åå–®ï¼Œé¿å…ä¸åŒæ­¥
      if (raw && typeof raw === 'object' && Array.isArray(raw.admins)) {
        setAdmins(raw.admins);
      }
    } catch (e) {
      console.error('è®€å– data/app.json å¤±æ•—ï¼š', e);
    }
  })();
}, []);


// === PointsPanel å±•é–‹ç‹€æ…‹ï¼ˆé è¨­å±•é–‹ï¼Œæœƒè¨˜ä½ä½¿ç”¨è€…é¸æ“‡ï¼‰ ===
const [pointsOpen, setPointsOpen] = useLocalState('kjs_points_open', false);
      
const [tab, setTab] = useState('home'); // home | history | pending | ongoing | shop | others
      const [menuOpen, setMenuOpen] = useState(false);
      const [adminMode, setAdminMode] = useState(false);
      const [query, setQuery] = useState('');
const [queryMode, setQueryMode] = useLocalState('kjs_query_mode', 'all'); // all | prize | winner | note


// === Adminï¼šç®¡ç†å“¡åå–®ï¼‹ç›®å‰ç™»å…¥è€… ===
const [admins, setAdmins] = useLocalState('kjs_admins', [
  { 
    name: 'admin', 
    passwordHash: '8efdbb89a7394f7a1a3f3a81d1b91a2781a5a66d74f40bfa7f2f5a5a8d79f5f2' 
  }
]);
const [currentAdmin, setCurrentAdmin] = useLocalState('kjs_current_admin', ''); // ç©ºå­—ä¸²ï¼æœªç™»å…¥

// === Adminï¼šç™»å…¥ Modal ç‹€æ…‹ï¼ˆå…©æ®µå¼ï¼‰===
const [showAdminLogin, setShowAdminLogin] = React.useState(false);
const [adminLoginStep, setAdminLoginStep] = React.useState(1); // 1=è¼¸å…¥/é¸æ“‡åç¨±ï¼›2=è¼¸å…¥å¯†ç¢¼
const [loginName, setLoginName] = React.useState('');
const [loginPwd, setLoginPwd] = React.useState('');
const [loginAttempts, setLoginAttempts] = React.useState(0);
const [loginLockUntil, setLoginLockUntil] = React.useState(0); // Date.now() æ¯«ç§’
const [showAdminHint, setShowAdminHint] = React.useState(false);

// === Admin å¯†æŠ€ï¼šé•·æŒ‰ 5~8 ç§’ï¼ˆæ‰‹æ©Ÿï¼‰ï¼æ¡Œé¢é€£é» 7 ä¸‹ ===
const secretHoldMsRef = React.useRef(6000);        // æ¯æ¬¡é–‹å•Ÿç™»å…¥è¦–çª—ï¼Œéš¨æ©Ÿ 5000~8000ms
const secretTimerRef = React.useRef(null);
const secretClicksRef = React.useRef(0);
const secretClicksTimerRef = React.useRef(null);

React.useEffect(() => {
  if (showAdminLogin) {
    secretHoldMsRef.current = 5000 + Math.floor(Math.random() * 3000); // 5000~8000
    secretClicksRef.current = 0;
  } else {
    if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
    if (secretClicksTimerRef.current) clearTimeout(secretClicksTimerRef.current);
    secretClicksTimerRef.current = null;
    setShowAdminHint(false);
  }
}, [showAdminLogin, setShowAdminHint]);

function startSecretHold(e) {
  e.preventDefault();
  if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
  secretTimerRef.current = setTimeout(() => {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
  }, secretHoldMsRef.current);
}
function cancelSecretHold() {
  if (secretTimerRef.current) {
    clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
  }
}

// æ¡Œé¢ï¼šåœ¨åŒä¸€å…ƒç´ ä¸Š 7 æ¬¡é»æ“Šï¼ˆ4 ç§’å…§ï¼‰
function secretClick() {
  secretClicksRef.current += 1;
  if (!secretClicksTimerRef.current) {
    secretClicksTimerRef.current = setTimeout(() => {
      secretClicksRef.current = 0;
      secretClicksTimerRef.current = null;
    }, 4000);
  }
  if (secretClicksRef.current >= 7) {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
    // é‡ç½®
    secretClicksRef.current = 0;
    if (secretClicksTimerRef.current) { clearTimeout(secretClicksTimerRef.current); secretClicksTimerRef.current = null; }
  }
}


// å°è£ï¼šé–‹å•Ÿç™»å…¥è¦–çª— / ç™»å‡º
function enterAdmin() {
  setLoginName('');
  setLoginPwd('');
  setAdminLoginStep(1);
  setShowAdminLogin(true);
}
function exitAdmin() {
  setAdminMode(false);
  setCurrentAdmin('');
  alert('å·²ç™»å‡ºç®¡ç†æ¨¡å¼');
}

// === Drawer A11yï¼šåƒè€ƒç¯€é» ===
const menuPaneRef = React.useRef(null);     // æŠ½å±œ <aside>
const menuButtonRef = React.useRef(null);   // é–‹å•ŸæŠ½å±œçš„æ¼¢å ¡æŒ‰éˆ•
const appContentRef = React.useRef(null);   // ä¸»å…§å®¹å®¹å™¨ï¼ˆè¦ aria-hiddenï¼‰

// === BackToTopï¼šç‹€æ…‹ï¼ˆæ»¾åˆ°ä¸€å®šé«˜åº¦æ‰é¡¯ç¤ºï¼‰ ===
const [showBackTop, setShowBackTop] = React.useState(false);

      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
useEffect(()=>{
  let g = false;
  const onKey = (e)=>{
    // è‹¥æ­£åœ¨è¼¸å…¥æ¬„ä½/æ–‡å­—å€æˆ–çµ„å­—ä¸­å°±å¿½ç•¥
    const tag = (e.target && e.target.tagName || '').toString().toLowerCase();
    if (e.isComposing || tag === 'input' || tag === 'textarea' || tag === 'select' || e.metaKey || e.ctrlKey || e.altKey) return;

    const k = (e.key || '').toLowerCase();     // â† é˜²å‘†
    if (k === '/') { e.preventDefault(); document.getElementById('kjs-search')?.focus(); return; }
    if (k === 'g') { g = true; setTimeout(()=> g = false, 800); return; }
    if (k === 'h' && g) { e.preventDefault(); setTab('home'); return; }
    if (k === 'm' && g) { e.preventDefault(); setMenuOpen(true); return; }
  };
  window.addEventListener('keydown', onKey);
  return ()=> window.removeEventListener('keydown', onKey);
},[]);

// === Drawer A11yï¼šç„¦é»é™·é˜±ã€Esc é—œé–‰ã€é–å®š body æ»¾å‹• ===
React.useEffect(() => {
  if (!menuOpen) return;

  const pane = menuPaneRef.current;
  if (!pane) return;

  // 1) é– body æ»¾å‹•
  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';

  // 2) èšç„¦æŠ½å±œå…§ç¬¬ä¸€å€‹å¯èšç„¦å…ƒç´ 
  const selectors = 'a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const focusables = Array.from(pane.querySelectorAll(selectors));
  const first = focusables[0];
  const last = focusables[focusables.length - 1];
  const prevActive = document.activeElement;

  first?.focus();

  // 3) éµç›¤è¡Œç‚ºï¼šEsc é—œé–‰ã€Tab ç„¦é»ç’°
  const onKeyDown = (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      setMenuOpen(false);
      return;
    }
    if (e.key === 'Tab' && focusables.length > 0) {
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus(); return;
      }
      if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus(); return;
      }
    }
  };

  document.addEventListener('keydown', onKeyDown);

  // 4) æ¸…ç†ï¼šé‚„åŸ bodyã€è§£é™¤ç›£è½ã€æŠŠç„¦é»é‚„çµ¦é–‹å•Ÿéˆ•
  return () => {
    document.body.style.overflow = prevOverflow;
    document.removeEventListener('keydown', onKeyDown);
    // å„ªå…ˆå›åˆ°æ¼¢å ¡æŒ‰éˆ•ï¼›æ²’æ‰¾åˆ°å°±å›åˆ°åŸå…ˆ focus
    if (menuButtonRef.current && typeof menuButtonRef.current.focus === 'function') {
      menuButtonRef.current.focus();
    } else if (prevActive && typeof prevActive.focus === 'function') {
      prevActive.focus();
    }
  };
}, [menuOpen, setMenuOpen]);

// === BackToTopï¼šæ»¾å‹•ç›£è½ï¼ˆ> 480px æ‰é¡¯ç¤ºï¼‰ ===
React.useEffect(() => {
  let ticking = false;
  const threshold = 480; // ä½ å¯ä»¥æ”¹æˆ 400~600 è¦–è¦ºå–œå¥½

  const onScroll = () => {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        setShowBackTop(y > threshold);
        ticking = false;
      });
    }
  };

  // å…ˆè·‘ä¸€æ¬¡ï¼Œé¿å…åˆæ¬¡é€²é é¢åœ¨ä¸­æ®µä½ç½®æ™‚ç‹€æ…‹ä¸æº–
  onScroll();

  window.addEventListener('scroll', onScroll, { passive: true });
  return () => window.removeEventListener('scroll', onScroll);
}, []);

// === èƒŒæ™¯è¨­å®šï¼ˆä¸»ç•«é¢ & æ¼¢å ¡é¸å–®ï¼‰ ===
const [bg, setBg] = useLocalState('kjs_bg', {
  url: "",
  tint: "rgba(255,255,255,0.0)",
  brightness: 1,
  blur: 0,
  opacity: 1,
  size: "cover",
  pos: "center",
  menuUseMain: true,
  menuUrl: "",
  menuTint: "rgba(255,255,255,0.0)",
  menuBrightness: 1,
  menuBlur: 0,
  menuOpacity: 1,
  menuSize: "cover",
  menuPos: "center",
});

// æŠŠè¨­å®šå¥—åˆ° CSS è®Šæ•¸
useEffect(()=>{
  const r = document.documentElement;
  // ä¸»ç•«é¢
  r.style.setProperty('--bg-img', bg.url ? `url("${bg.url}")` : 'none');
  r.style.setProperty('--bg-tint', bg.tint);
  r.style.setProperty('--bg-brightness', String(bg.brightness));
  r.style.setProperty('--bg-blur', bg.blur + 'px');
  r.style.setProperty('--bg-opacity', String(bg.opacity));
  r.style.setProperty('--bg-size', bg.size);
  r.style.setProperty('--bg-pos', bg.pos);

  // æ¼¢å ¡é¸å–®
  const useMain = !!bg.menuUseMain;
  const mUrl = useMain ? bg.url : bg.menuUrl;
  const mTint = useMain ? bg.tint : bg.menuTint;
  const mBri  = useMain ? bg.brightness : bg.menuBrightness;
  const mBlur = useMain ? bg.blur : bg.menuBlur;
  const mOpa  = useMain ? bg.opacity : bg.menuOpacity;
  const mSize = useMain ? bg.size : bg.menuSize;
  const mPos  = useMain ? bg.pos : bg.menuPos;

  r.style.setProperty('--menu-bg-img', mUrl ? `url("${mUrl}")` : 'none');
  r.style.setProperty('--menu-tint', mTint);
  r.style.setProperty('--menu-brightness', String(mBri));
  r.style.setProperty('--menu-blur', mBlur + 'px');
  r.style.setProperty('--menu-opacity', String(mOpa));
  r.style.setProperty('--menu-bg-size', mSize);
  r.style.setProperty('--menu-bg-pos', mPos);
}, [bg]);


 // åŒ¯å…¥/åŒ¯å‡ºï¼ˆJSONï¼Œä¾›ä½ å‚™ä»½æ¬ç§»ï¼‰â€”â€”ã€æ•´æ®µè¦†è“‹ç‰ˆã€‘
// æœ¬ç‰ˆæœƒæŠŠã€Œç«™å…§è³‡æ–™ dataã€èˆ‡ã€Œç®¡ç†å“¡åå–® adminsï¼ˆåªå«é›œæ¹Šï¼Œä¸å«æ˜æ–‡å¯†ç¢¼ï¼‰ã€ä¸€èµ·åŒ¯å‡ºï¼›
// åŒ¯å…¥æ™‚åŒæ™‚æ”¯æ´ã€Œæ–°æ ¼å¼ï¼ˆå« data/adminsï¼‰ã€èˆ‡ã€ŒèˆŠæ ¼å¼ï¼ˆåªæœ‰ dataï¼‰ã€ã€‚

const exportJSON = () => {
  // å–å‡ºç›®å‰æ‰€æœ‰åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´ï¼ˆImageIO æœƒå›å‚³å­—ä¸² JSONï¼‰
  const imagesStr = window.ImageIO ? window.ImageIO.exportImagesJSON() : null;
  const images = imagesStr ? JSON.parse(imagesStr) : null;

  const full = {
    _meta: {
      app: 'kjs',
      version: 2, // å‡ç´šä¸€ä¸‹ç‰ˆæœ¬è™Ÿï¼Œæ–¹ä¾¿ä¹‹å¾Œè¾¨è­˜
      exportedAt: new Date().toISOString()
    },
    data,            // ç«™å…§è³‡æ–™
    admins,          // ç®¡ç†å“¡åå–®ï¼ˆhashï¼‰
    images,          // â† æ–°å¢ï¼šå…¨ç«™åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´ï¼ˆimages.v1 çµæ§‹ï¼‰
    bg               // â† æ–°å¢ï¼šèƒŒæ™¯è¨­å®šï¼ˆä¸»ç•«é¢ / æ¼¢å ¡é¸å–®ï¼‰
  };

  const blob = new Blob([JSON.stringify(full, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_full_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// ï¼ˆå¯é¸ï¼‰åƒ…åŒ¯å‡ºç«™å…§è³‡æ–™ï¼Œä¸å«ç®¡ç†å“¡åå–®â€”â€”å¦‚æœè¦çµ¦ä¸€èˆ¬æˆå“¡å‚™ä»½ï¼Œå¯ä»¥ç¶é€™é¡†
const exportDataOnly = () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_data_only_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// åŒ¯å…¥æ”¯æ´å…©ç¨®æ ¼å¼ï¼š
// 1) æ–°æ ¼å¼ï¼š{ _meta?, data: {...}, admins: [...] } â€”â€” åŒæ™‚è¦†è“‹ç«™å…§è³‡æ–™èˆ‡ç®¡ç†å“¡åå–®
// 2) èˆŠæ ¼å¼ï¼š{ ...ç›´æ¥å°±æ˜¯ data å…§å®¹... } â€”â€” åªè¦†è“‹ç«™å…§è³‡æ–™ï¼Œä¿ç•™æœ¬æ©Ÿ admins
const importJSON = (file) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const obj = JSON.parse(String(e.target.result || '{}'));

      const looksNew = obj && typeof obj === 'object' && ('data' in obj || 'admins' in obj);

      if (looksNew) {
        const nextData   = obj.data  ?? {};
        const nextAdmins = Array.isArray(obj.admins) ? obj.admins : null;

        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        if (nextAdmins) setAdmins(nextAdmins);

        // â˜… æ–°å¢ï¼šè‹¥åŒ…äº† imagesï¼ˆimages.v1 çµæ§‹ï¼‰ï¼Œå‘¼å« ImageIO ç«‹å³å¥—ç”¨
        if (obj.images && window.ImageIO && typeof window.ImageIO.importImagesJSON === 'function') {
          try { window.ImageIO.importImagesJSON(obj.images); } catch {}
        }

        // â˜… æ–°å¢ï¼šè‹¥åŒ…äº† bgï¼ˆèƒŒæ™¯è¨­å®šï¼‰ï¼Œç›´æ¥å¯«å›
        if (obj.bg) {
          try { setBg(obj.bg); } catch {}
        }

        alert(`åŒ¯å…¥å®Œæˆ${nextAdmins ? 'ï¼ˆå«ç®¡ç†å“¡åå–®ï¼‰' : ''}ï¼Œæ­·å²å·²è‡ªå‹•æ’åº`);
      } else {
        // èˆŠæ ¼å¼ï¼šåªæœ‰ data
        const nextData = obj;
        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        alert('åŒ¯å…¥å®Œæˆï¼ˆèˆŠæ ¼å¼ï¼Œå·²è‡ªå‹•æ’åºæ­·å²ï¼‰');
      }
    } catch {
      alert('åŒ¯å…¥å¤±æ•—ï¼šä¸æ˜¯æœ‰æ•ˆ JSON');
    }
  };
  reader.readAsText(file);
};


      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="sticky top-0 z-30 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200/60 dark:border-slate-800">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2">
             <button
  ref={menuButtonRef}
  type="button"
  aria-controls="app-menu-pane"
  aria-expanded={menuOpen ? 'true' : 'false'}
  aria-label="é–‹å•Ÿä¸»é¸å–®"
  className="tap-target -ml-2"
  onClick={() => setMenuOpen(true)}
  title="é–‹å•Ÿé¸å–®"
>
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>

              <h1 className="text-lg font-semibold">é–‹çæ‰€</h1>
              <div className="ml-auto flex items-center gap-2">
                <div className="hidden sm:flex items-center gap-2">
  {/* æ¨¡å¼é¸å–® */}
  <label htmlFor="kjs-search-mode" className="sr-only">æœå°‹æ¨¡å¼</label>
  <select
    id="kjs-search-mode"
    value={queryMode}
    onChange={(e)=>setQueryMode(e.target.value)}
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-2 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70"
    title="é¸æ“‡æœå°‹æ¨¡å¼"
    aria-label="æœå°‹æ¨¡å¼"
  >
    <option value="all">å…¨éƒ¨</option>
    <option value="prize">çå“åç¨±</option>
    <option value="winner">å¾—çè€…</option>
    <option value="note">å‚™è¨»ãƒ»èªªæ˜</option>
  </select>

  {/* æœå°‹è¼¸å…¥æ¡† */}
  <label htmlFor="kjs-search" className="sr-only">æœå°‹é—œéµå­—</label>
  <input
    id="kjs-search"
    value={query}
    onChange={e=>setQuery(e.target.value)}
    placeholder="æœå°‹...ï¼ˆæŒ‰ / èšç„¦ï¼‰"
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70 focus:outline-none focus:ring-2 focus:ring-brand"
  />
</div>

                {!adminMode && (
                  <button onClick={enterAdmin} className="tap-target rounded-xl bg-brand text-white px-3 py-1.5 text-sm shadow-soft">ç®¡ç†</button>
                )}
                {adminMode && (
  <div className="flex items-center gap-2">
    <button onClick={exportJSON} className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm">åŒ¯å‡º</button>
    <label className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm cursor-pointer">åŒ¯å…¥
      <input type="file" accept="application/json" className="hidden" onChange={e=>e.target.files&&importJSON(e.target.files[0])}/>
    </label>

    {/* å°‡åŸæœ¬çš„ã€Œé‡è¨­å¯†ç¢¼ã€æ”¹æˆå°å‘ç³»çµ±è¨­ç½®é ï¼ˆåœ¨é‚£è£¡æ”¹å¸³è™Ÿ/å¯†ç¢¼ï¼‰ */}
    <button
      onClick={() => { setTab('system'); /* å¯é¸ï¼šå¸¶å…¥éŒ¨é» */ const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
      className="tap-target rounded-xl bg-amber-200 text-amber-900 dark:bg-amber-300/20 dark:text-amber-200 px-3 py-1.5 text-sm"
      title="å‰å¾€ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®"
    >
      ç®¡ç†å“¡è¨­å®š
    </button>

    <button onClick={exitAdmin} className="tap-target rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-3 py-1.5 text-sm">é€€å‡º</button>
  </div>
)}

              </div>
            </div>
          </header>

          {/* Main */}
          <div ref={appContentRef} aria-hidden={menuOpen ? 'true' : 'false'}>
  <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">

            {tab==='home' && <Home setTab={setTab} data={data} setData={setData} admin={adminMode} />}

{tab==='links' && <LinksPage data={data} setData={setData} admin={adminMode} />}

            {tab==='history' && <History data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='pending' && <Pending data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='ongoing' && <Ongoing data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='store' && (
  <Store
    data={data}
    admin={adminMode}
    setData={setData}
    query={query}
  />
)}

{tab==='shop' && (
  <>
    {/* æŸ¥è©¢é»æ•¸ï¼šå¯æ”¶åˆå¡ï¼ˆé è¨­å±•é–‹ï¼Œè¨˜æ†¶ç‹€æ…‹ï¼‰ */}
    <section
      className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-0 overflow-hidden"
      aria-label="æŸ¥è©¢é»æ•¸"
    >
      {/* å¡ç‰‡æ¨™é¡Œåˆ— */}
      <div className="flex items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <span className="text-lg">ğŸ’³</span>
          <h2 className="text-base font-semibold">æŸ¥è©¢é»æ•¸</h2>
        </div>
        <button
          type="button"
          aria-controls="points-panel-body"
          aria-expanded={pointsOpen ? 'true' : 'false'}
          onClick={()=>setPointsOpen(v=>!v)}
          className="tap-target rounded-lg border px-3 py-1.5 text-sm"
          title={pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        >
          {pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        </button>
      </div>

      {/* åˆ†éš”ç·š */}
      <div className="h-px bg-slate-200 dark:bg-slate-700" />

      {/* å¡ç‰‡å…§å®¹ï¼ˆå¯æ”¶åˆï¼‰ */}
      {pointsOpen && (
        <div id="points-panel-body" className="p-4">
          <PointsPanel data={data} admin={adminMode} setData={setData} />
        </div>
      )}
    </section>

    {/* èˆ‡æŸ¥è©¢å¡ç‰‡ç•™é»é–“è· */}
    <div className="h-4" />

    {/* é»æ•¸å•†åŸå…§å®¹ */}
    <Shop data={data} admin={adminMode} setData={setData} query={query} />

<ShopImageQuickset data={data} setData={setData} admin={adminMode} />

  </>
)}


{tab==='others' && <Others data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}

{tab==='system' && adminMode && (
  <SystemSettings
    data={data}
    setData={setData}
    bg={bg}
    setBg={setBg}
    admins={admins}
    setAdmins={setAdmins}
    currentAdmin={currentAdmin}
    setCurrentAdmin={setCurrentAdmin}
  />
)}

{/* è¿”å›é ‚éƒ¨ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ï¼šåƒ…åœ¨æ»¾åˆ°ä¸€å®šé«˜åº¦å¾Œé¡¯ç¤º */}
{showBackTop && (
  <button
    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
    className="fixed right-4 bottom-20 md:bottom-6 z-40 rounded-full border shadow-soft bg-white/90 dark:bg-slate-900/80 backdrop-blur px-3 py-2 tap-target"
    aria-label="å›åˆ°æœ€ä¸Šé¢"
    title="å›åˆ°æœ€ä¸Šé¢"
  >
    â†‘
  </button>
)}

{/* === Admin ç™»å…¥ï¼ˆäºŒæ®µå¼ Modalï¼‰=== */}
{showAdminLogin && (
  <div className="fixed inset-0 z-50">
    {/* èƒŒæ™¯ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setShowAdminLogin(false)} />
    <div className="absolute inset-0 flex items-center justify-center p-4">
      <div className="relative w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4" onClick={(e)=>e.stopPropagation()}>

{/* ï¼ˆå¯†æŠ€ï¼‰å·¦ä¸Šè§’ 10Ã—10 px è£é£¾é»ï¼šçœ‹èµ·ä¾†åƒè£é£¾ï¼Œå¯¦éš›æ˜¯é•·æŒ‰/é€£é»å•Ÿå‹•å™¨ */}
<div
  aria-hidden="true"
  tabIndex={-1}
  className="absolute top-1 left-1 w-2.5 h-2.5 rounded-full bg-slate-300/70 dark:bg-slate-600/70 cursor-default select-none"
  // æ‰‹æ©Ÿï¼šé•·æŒ‰ 5~8 ç§’
  onPointerDown={startSecretHold}
  onPointerUp={cancelSecretHold}
  onPointerLeave={cancelSecretHold}
  onPointerCancel={cancelSecretHold}
  // æ¡Œé¢ï¼šé€£é» 7 ä¸‹ï¼ˆæ­¤å…ƒç´ ä¸é¡¯ç¤ºä»»ä½•æŒ‰éˆ•æ¨£å¼ï¼Œæ¸¸æ¨™ä¸è®Šï¼‰
  onClick={secretClick}
  onContextMenu={(e)=>e.preventDefault()} // é˜»æ“‹é•·æŒ‰å«å‡ºé¸å–®
/>


        <div className="text-base font-semibold mb-2">ç®¡ç†è€…ç™»å…¥</div>

        {/* é–å®šæç¤º */}
        {Date.now() < loginLockUntil && (
          <div className="text-sm text-red-600 mb-2">
            å˜—è©¦éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ï¼ˆ{Math.ceil((loginLockUntil - Date.now())/1000)} ç§’ï¼‰
          </div>
        )}

        {/* Step 1ï¼šç®¡ç†è€…åç¨± */}
{adminLoginStep === 1 && (
  <div className="grid gap-2">
    <label className="text-sm text-slate-600 dark:text-slate-300">ç®¡ç†è€…åç¨±</label>
    <input
      className="rounded-lg border px-3 py-2"
      placeholder="ä¾‹å¦‚ï¼šadmin æˆ–è¼¸å…¥æ–°åç¨±"
      value={loginName}
      onChange={e=>setLoginName(e.target.value)}
      disabled={Date.now() < loginLockUntil}
    />

    {/* æ³¨æ„ï¼šä¸å†é¡¯ç¤ºä»»ä½•é¡¯ç¤ºå¸³è™Ÿçš„æŒ‰éˆ•æˆ–æç¤ºï¼›åªåœ¨å¯†æŠ€è§¸ç™¼æ™‚çŸ­æš«é¡¯ç¤ºåå–® */}
    {showAdminHint && admins.length > 0 && (
      <div className="text-xs text-slate-600 dark:text-slate-300 rounded-lg border px-3 py-2">
        {admins.map((a,i)=>(
          <button
            key={i}
            className="mr-2 mb-1 inline-flex items-center px-2 py-0.5 rounded border hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={()=>setLoginName(a.name)}
            disabled={Date.now() < loginLockUntil}
            title="é»ä¸€ä¸‹å¸¶å…¥åç¨±ï¼ˆ5 ç§’å¾Œè‡ªå‹•éš±è—ï¼‰"
          >
            {a.name}
          </button>
        ))}
      </div>
    )}

    <div className="flex justify-end gap-2 mt-2">
      <button className="rounded-lg border px-3 py-1.5" onClick={()=>setShowAdminLogin(false)}>å–æ¶ˆ</button>
      <button
        className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
        onClick={()=>{
          if(!loginName.trim()) { alert('è«‹è¼¸å…¥ç®¡ç†è€…åç¨±'); return; }
          setAdminLoginStep(2);
        }}
      >
        ä¸‹ä¸€æ­¥
      </button>
    </div>
  </div>
)}


        {/* Step 2ï¼šå¯†ç¢¼ */}
        {adminLoginStep === 2 && (
          <div className="grid gap-2">
            <label className="text-sm text-slate-600 dark:text-slate-300">å¯†ç¢¼</label>
            <input
              type="password"
              className="rounded-lg border px-3 py-2"
              placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
              value={loginPwd}
              onChange={e=>setLoginPwd(e.target.value)}
              disabled={Date.now() < loginLockUntil}
            />
            <div className="flex justify-between items-center mt-2">
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setAdminLoginStep(1)}>ä¸Šä¸€æ­¥</button>
              <button
  className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
  disabled={Date.now() < loginLockUntil}
  onClick={async ()=>{
    const name = (loginName||"").trim();
    const pass = (loginPwd||"").trim();            // â† ä¿®æ­£ï¼šç”¨ loginPwdï¼Œä¸æ˜¯ loginPassword

    if(!name || !pass){
      alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
      return;
    }

    // ç›´æ¥ä½¿ç”¨ç‹€æ…‹ä¸­çš„ç®¡ç†å“¡åå–®ï¼ˆä¸è¦å†è®€ LS.adminsï¼‰
    const list = Array.isArray(admins) ? admins : [];
    const found = list.find(u => u && u.name === name);

    if(!found){
      // ğŸš« ç™»å…¥æµç¨‹ä¸å…è¨±å»ºç«‹æ–°ç®¡ç†å“¡ï¼ˆåªèƒ½ç”¨æ—¢æœ‰å¸³è™Ÿç™»å…¥ï¼‰
      alert("æ­¤å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹è¯çµ¡æ—¢æœ‰ç®¡ç†å“¡æ–¼ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€æ–°å¢ã€‚");
      return;
    }

    // å¿…é ˆå·²è¨­å®šå¯†ç¢¼ï¼ˆæœ‰ hashï¼‰ï¼Œä¸å…è¨±åœ¨ç™»å…¥æµç¨‹å»ºç«‹æˆ–è®Šæ›´å¯†ç¢¼
    if(!found.passwordHash || String(found.passwordHash).trim()===""){
      alert("æ­¤å¸³è™Ÿå°šæœªè¨­å®šå¯†ç¢¼ï¼Œè«‹å…ˆç”±æ—¢æœ‰ç®¡ç†å“¡åœ¨ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€ç‚ºè©²å¸³è™Ÿè¨­å®šå¯†ç¢¼ã€‚");
      return;
    }

    // æ¯”å° SHA-256 é›œæ¹Š
    const hash = await hashTextSHA256(pass);
    if(hash !== found.passwordHash){
      alert("å¯†ç¢¼éŒ¯èª¤");
      return;
    }

    // âœ… ç™»å…¥æˆåŠŸ
    setCurrentAdmin(name);
    setAdminMode(true);
    setShowAdminLogin(false);
    setLoginName("");
    setLoginPwd("");         // â† ä¿®æ­£ï¼šæ¸…ç©º loginPwdï¼ˆä¸æ˜¯ setLoginPasswordï¼‰
    alert(`å·²ä»¥ã€Œ${name}ã€ç™»å…¥ç®¡ç†æ¨¡å¼`);
  }}
>
  ç™»å…¥
</button>

            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}

          </main>
</div>

{/* åº•éƒ¨å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿï¼‰ */}
<nav className="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white/95 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700 backdrop-blur">
  <div className="max-w-5xl mx-auto grid grid-cols-5">
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='home'?'text-brand':'')} onClick={()=>setTab('home')} title="é¦–é ">ğŸ </button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='pending'?'text-brand':'')} onClick={()=>setTab('pending')} title="ç­‰å¾…é–‹ç">â³</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='shop'?'text-brand':'')} onClick={()=>setTab('shop')} title="é»æ•¸å•†åŸ">ğŸ›ï¸</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='store'?'text-brand':'')} onClick={()=>setTab('store')} title="ç¤¾ç¾¤å•†åº—">ğŸ›’</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='history'?'text-brand':'')} onClick={()=>setTab('history')} title="æ­·å²ç´€éŒ„">ğŸ“š</button>
  </div>
</nav>

          {/* æŠ½å±œå¼æ¼¢å ¡é¸å–® */}
      {menuOpen && (
  <div className="fixed inset-0 z-50">
    {/* é®ç½©ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setMenuOpen(false)} />
    {/* æŠ½å±œæœ¬é«” */}
    <aside
      id="app-menu-pane"
      ref={menuPaneRef}
      role="dialog"
      aria-modal="true"
      aria-label="ä¸»é¸å–®"
      tabIndex={-1}
      className="menu-pane absolute left-0 top-0 h-full w-80 max-w-[85%] shadow-xl no-scrollbar overflow-y-auto"
    >
      {/* ä½ çš„é¸å–®å…§å®¹ç¶­æŒä¸è®Šï¼šæŠŠåŸæœ¬ aside è£¡çš„å…§å®¹æ•´æ®µè²¼å›ä¾† */}
      <div className="p-4 border-b ... flex items-center justify-between">
  <div className="font-semibold">
    å°è¦½{adminMode && currentAdmin ? <span className="ml-2 text-xs text-slate-500">ï¼ˆ{currentAdmin}ï¼‰</span> : null}
  </div>
        <button className="tap-target" onClick={()=>setMenuOpen(false)} aria-label="é—œé–‰">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <nav className="p-2 grid gap-1">
  {/* â€”â€” ä¸»å°è¦½ â€”â€” */}
  <NavItem
    label="ğŸ  é¦–é "
    active={tab==='home'}
    onClick={()=>{ setTab('home'); setMenuOpen(false); }}
  />
 
<NavItem
  label="ğŸ›’ ç¤¾ç¾¤å•†åº—"
  active={tab==='store'}
  onClick={()=>{ setTab('store'); setMenuOpen(false); }}
  />  

  <NavItem
    label="ğŸ›ï¸ é»æ•¸å•†åŸ"
    active={tab==='shop'}
    onClick={()=>{ setTab('shop'); setMenuOpen(false); }}
  />
  
<NavItem
    label="â³ ç­‰å¾…é–‹ç"
    active={tab==='pending'}
    onClick={()=>{ setTab('pending'); setMenuOpen(false); }}
  />

<NavItem
    label="ğŸ“š æ­·å²ç´€éŒ„"
    active={tab==='history'}
    onClick={()=>{ setTab('history'); setMenuOpen(false); }}
  />
  
<NavItem
    label="ğŸ”„ é€²è¡Œä¸­æ´»å‹•"
    active={tab==='ongoing'}
    onClick={()=>{ setTab('ongoing'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ“Œ å…¶ä»–è³‡æ–™"
    active={tab==='others'}
    onClick={()=>{ setTab('others'); setMenuOpen(false); }}
  />

  {/* åˆ†éš”ç·š */}
  <div className="my-2 h-px bg-slate-200 dark:bg-slate-700" />

  {/* â€”â€” ç®¡ç†å€ï¼ˆä¾ç‹€æ…‹åˆ‡æ›ï¼‰ â€”â€” */}
  {!adminMode ? (
    <button
      className="w-full text-left px-3 py-2 rounded-xl tap-target hover:bg-slate-100 dark:hover:bg-slate-800"
      onClick={()=>{ enterAdmin(); /* æˆåŠŸé€²å…¥å¾Œä¿ç•™æŠ½å±œé–‹å•Ÿï¼Œæˆ–ä½ ä¹Ÿå¯é—œé–‰ */ }}
      title="é€²å…¥ç®¡ç†æ¨¡å¼"
    >
      ğŸ” é€²å…¥ç®¡ç†æ¨¡å¼
    </button>
  ) : (
    <>
      {/* ç³»çµ±è¨­ç½®åˆ†é ï¼ˆä½ ä¹‹å‰è¦æ±‚é›†ä¸­è¨­å®šåœ¨æ­¤ï¼‰ */}
      <NavItem
        label="ğŸ› ï¸ ç³»çµ±è¨­ç½®"
        active={tab==='system'}
        onClick={()=>{ setTab('system'); setMenuOpen(false); }}
      />

      {/* ç®¡ç†å¸¸ç”¨å·¥å…· */}
      <div className="grid grid-cols-2 gap-2 p-2">
  <button
    onClick={exportJSON}
    className="rounded-lg border px-3 py-2 text-sm"
    title="åŒ¯å‡ºæ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    åŒ¯å‡º
  </button>

  <label
    className="rounded-lg border px-3 py-2 text-sm cursor-pointer text-center"
    title="åŒ¯å…¥æ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    ç´”åŒ¯å…¥
    <input
      type="file"
      accept="application/json"
      className="hidden"
      onChange={e=>e.target.files && importJSON(e.target.files[0])}
    />
  </label>

  {/* å°å‘ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®ï¼ˆå–ä»£èˆŠçš„ resetAdminï¼‰ */}
  <button
    onClick={()=>{ setTab('system'); setMenuOpen(false); const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="å‰å¾€ç³»çµ±è¨­ç½®ï¼ˆç®¡ç†è€…æ¸…å–®ï¼‰"
  >
    ç®¡ç†å“¡è¨­å®š
  </button>

  <button
    onClick={()=>{ exitAdmin(); setMenuOpen(false); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="é€€å‡ºç®¡ç†æ¨¡å¼"
  >
    é€€å‡ºç®¡ç†
  </button>
</div>

    </>
  )}
</nav>

      <div className="p-4 text-xs text-slate-500 border-t border-slate-200/60 dark:border-slate-800">
        <div>æç¤ºï¼š</div>
        <ul className="list-disc pl-5 mt-1 space-y-1">
          <li>æŒ‰ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">/</kbd> èšç„¦æœå°‹</li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">h</kbd>ï¼šå›é¦–é </li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">m</kbd>ï¼šé–‹é¸å–®</li>
        </ul>
      </div>
    </aside>
  </div>
)}

        </div>
      );
    }

    // â€”â€” åŸºç¤ UI å…ƒä»¶ â€”â€”
    function NavItem({ label, active, onClick }){
  return (
    <button
      onClick={onClick}
      className={cx(
        'w-full text-left px-3 py-2 rounded-xl tap-target transition',
        active
          ? 'bg-brand/10 text-brand-fg border border-brand/30'
          : 'hover:bg-slate-100 dark:hover:bg-slate-800',
        // æ‰‹æ©Ÿ/éµç›¤çš„è§¸è¦ºå›é¥‹ï¼ˆæ²’æœ‰ hover ä¹Ÿæœ‰æ¸…æ¥šçš„ pressed/focus ç‹€æ…‹ï¼‰
        'active:bg-slate-100 dark:active:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50'
      )}
      // è¼”åŠ©æŠ€è¡“å¯è®€æ€§ï¼ˆé«˜äº®ç•¶å‰é ï¼‰
      aria-current={active ? 'page' : undefined}
    >
      {label}
    </button>
  );
}


function StickyBulkToggles({ onOpenAll, onCloseAll, className="" }) {
  return (
    <div className={cx(
      "sticky top-[60px] z-20 flex items-center gap-2 justify-end",
      className
    )}>
      <button
        type="button"
        onClick={onOpenAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨å±•é–‹"
        aria-label="å…¨éƒ¨å±•é–‹"
      >
        {/* å±•é–‹ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="6 15 12 9 18 15"></polyline>
        </svg>
      </button>
      <button
        type="button"
        onClick={onCloseAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨æ”¶åˆ"
        aria-label="å…¨éƒ¨æ”¶åˆ"
      >
        {/* æ”¶åˆ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="18 9 12 15 6 9"></polyline>
        </svg>
      </button>
    </div>
  );
}

   function Section({ title, subtitle, children }){
  return (
    <section className="animate-fadeIn">
      <div className="mb-3">
        <h2 className="text-[1.25rem] font-semibold tracking-tight">{title}</h2>
        {subtitle && <p className="text-[13px] text-slate-500 mt-1">{subtitle}</p>}
      </div>

      {/* åŸæœ¬çš„ .section-card æ”¹ç‚ºç›´æ¥å¥—å·¥å…·é¡ */}
      <div className="
        bg-white/80 dark:bg-slate-800/70 backdrop-blur
        border border-slate-200/70 dark:border-slate-700/60
        rounded-2xl
        shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
        hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
        transition-shadow
        p-4 sm:p-5
      ">
        {children}
      </div>
    </section>
  );
}



    function EmptyCard({ text, admin }){
      return (
        <div className="border border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 text-center text-slate-500">
          {text}
          {admin && <div className="mt-3 text-xs">ï¼ˆé€²å…¥ç®¡ç†å¾Œå¯æ–°å¢è³‡æ–™ï¼‰</div>}
        </div>
      );
    }

    // === Homeï¼ˆä¸»é ï¼‰ï¼šé—œæ–¼ï¼‹ç¤¾ç¾¤é€£çµï¼‹å¿«æ·å…¥å£ ===
function Home({ setTab, data, setData, admin }) {
  const { useState, useMemo, useEffect } = React;

  // === ä¾†æºè³‡æ–™ ===
  const about = data.homepage?.about ?? "é€™è£¡æ˜¯ã€Œé–‹çæ‰€ã€ï¼Œæä¾›æ­·å²æŠ½çç´€éŒ„ã€ç­‰å¾…é–‹çã€é€²è¡Œä¸­æ´»å‹•èˆ‡é»æ•¸å•†åŸç­‰è³‡è¨Šã€‚";
  const links = data.homepage?.links ?? []; // [{id, name, url}]

  // === å¿«æ·å…¥å£ï¼ˆå…­æ ¼ï¼Œå›ºå®šæ’åºï¼‰ ===
const entries = React.useMemo(() => {
  const storeCount   = Array.isArray(data.store?.items) ? data.store.items.length : 0;
  const linkCount    = Array.isArray(links) ? links.length : 0;
  const shopCount    = Array.isArray(data.shop?.items) ? data.shop.items.length : 0;
  const pendingCount = Array.isArray(data.pending) ? data.pending.length : 0;
  const ongoingCount = Array.isArray(data.ongoing) ? data.ongoing.length : 0;
  const historyCount = Array.isArray(data.history) ? data.history.length : 0;

  return [
    { key:'store',   icon:'ğŸ›’', label:'ç¤¾ç¾¤å•†åº—',       value:storeCount,   onClick:()=>setTab('store') },
    { key:'links',   icon:'ğŸ”—', label:'ç¤¾ç¾¤èˆ‡å®˜æ–¹é€£çµ', value:linkCount,    onClick:()=>setTab('links') }, // ç•™åœ¨é¦–é ï¼Œä¸‹æ–¹å€å¡Š
    { key:'shop',    icon:'ğŸ›ï¸', label:'é»æ•¸å•†åº—',       value:shopCount,    onClick:()=>setTab('shop') },
    { key:'pending', icon:'â³', label:'ç­‰å¾…é–‹ç',       value:pendingCount, onClick:()=>setTab('pending') },
    { key:'ongoing', icon:'ğŸ”„', label:'é€²è¡Œä¸­æ´»å‹•',     value:ongoingCount, onClick:()=>setTab('ongoing') },
    { key:'history', icon:'ğŸ“š', label:'æ­·å²ç´€éŒ„',       value:historyCount, onClick:()=>setTab('history') },
  ];
}, [data, links, setTab]);


  // === ç½®é ‚å…¬å‘Š â†’ æ”¹ç‚ºé€²ç«™å½ˆçª—ï¼ˆåƒ…ç•¶æ¬¡é–‹å•Ÿé¡¯ç¤ºä¸€æ¬¡ï¼‰ ===
  const pinnedCards = useMemo(() => {
    const list = data.others?.cards || [];
    return list.filter(x => x.pin === true);
  }, [data.others]);

  const [showPinModal, setShowPinModal] = useState(false);

  useEffect(() => {
    // ä½¿ç”¨ sessionStorageï¼Œç¢ºä¿åŒä¸€æ¬¡é–‹å•ŸæœŸé–“åªé¡¯ç¤ºä¸€æ¬¡
    const SEEN_KEY = 'kjs_pin_modal_seen_v1';
    const seen = sessionStorage.getItem(SEEN_KEY);
    if (!seen && pinnedCards.length > 0) {
      setShowPinModal(true);
      sessionStorage.setItem(SEEN_KEY, '1');
    }
  }, [pinnedCards]);

  const closePinModal = () => setShowPinModal(false);

  // === ä¸»é ã€Œé—œæ–¼ã€èˆ‡ã€Œé€£çµã€è‰ç¨¿ ===
  const [draft, setDraft] = useState({ about, linkName: "", linkUrl: "" });

  const saveAbout = () => {
    if (!admin) return;
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links } });
    alert("å·²æ›´æ–°ä¸»é ä»‹ç´¹");
  };

  const addLink = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const name = (draft.linkName || "").trim();
    const url  = (draft.linkUrl  || "").trim();
    if (!name || !url) return alert("è«‹è¼¸å…¥é€£çµåç¨±èˆ‡ç¶²å€");
    if (!/^https?:\/\//i.test(url)) return alert("ç¶²å€éœ€ä»¥ http:// æˆ– https:// é–‹é ­");
    const next = [...links, { id: Math.random().toString(36).slice(2, 10), name, url }];
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
    setDraft(d => ({ ...d, linkName: "", linkUrl: "" }));
  };

  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm("åˆªé™¤æ­¤é€£çµï¼Ÿ")) return;
    const next = links.filter(x => x.id !== id);
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
  };

  // === å…¶ä»–è³‡æ–™ï¼ˆåœ¨é¦–é ä¸­ä»¥ç°¡åŒ–åˆ—è¡¨ç¤ºæ„ï¼Œæä¾›å‰å¾€æŒ‰éˆ•ï¼‰ ===
  const otherCards = useMemo(() => {
    const all = data.others?.cards || [];
    // ä¸é¡¯ç¤ºç½®é ‚çš„ï¼ˆç½®é ‚æ”¹ç”±å½ˆçª—é¡¯ç¤ºï¼‰ï¼Œåƒ…åˆ—éç½®é ‚å¡ç‰‡çš„å‰ 5 ç­†ä½œç‚ºé è¦½
    return all.filter(c => !c.pin).slice(0, 5);
  }, [data.others]);

  return (
    <Section title="ä¸»é ï¼šé–‹çæ‰€" subtitle="é¦–é è³‡è¨Šæ¿ƒç¸®ç‰ˆ">
      {/* 1) é—œæ–¼é€™å€‹ç¶²é ï¼ˆç¬¬ä¸€å€ï¼‰ */}
      <Collapse header="ğŸ§¾ é—œæ–¼é€™å€‹ç¶²é ï¼ˆé»æˆ‘å±•é–‹ï¼‰" defaultOpen={false}>
        {!admin && <p className="text-sm whitespace-pre-wrap">{about}</p>}
        {admin && (
          <div className="grid gap-3">
            <textarea
              className="rounded-lg border px-3 py-2 min-h-[100px]"
              value={draft.about}
              onChange={e => setDraft(d => ({ ...d, about: e.target.value }))}
              placeholder="ç°¡çŸ­ä»‹ç´¹æ­¤ç¶²é ã€ç”¨é€”èˆ‡è¦å‰‡é‡é»"
            />
            <div className="flex justify-end">
              <button onClick={saveAbout} className="rounded-lg bg-brand text-white px-4 py-2">
                å„²å­˜ä»‹ç´¹
              </button>
            </div>
          </div>
        )}
      </Collapse>

     {/* 2) å…­æ ¼å¿«æ·å…¥å£ï¼ˆç¬¬äºŒå€ï¼‰ */}
<div
  className="
    my-4 grid gap-2
    grid-cols-2 sm:grid-cols-3
  "
  aria-label="é¦–é å…­æ ¼å¿«æ·å…¥å£"
>
  {entries.map(s => (
    <button
      key={s.key}
      onClick={s.onClick}
      className="
        group rounded-2xl border border-slate-200 dark:border-slate-700
        bg-white/80 dark:bg-slate-800/70 backdrop-blur
        px-3 py-3 text-left shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
        hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
        transition
        focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50
        active:scale-[0.99]
      "
      title={s.label}
      aria-label={s.label}
    >
      <div className="flex items-center justify-between">
        <div className="text-xl leading-none">{s.icon}</div>
        <div className="text-[11px] text-slate-500 opacity-80 group-hover:opacity-100">
          é»æ“Šå‰å¾€
        </div>
      </div>
      <div className="mt-1 text-[13px] text-slate-500">{s.label}</div>
      <div className="mt-0.5 text-2xl font-semibold tabular-nums">{s.value}</div>
    </button>
  ))}
</div>


      

      {/* 4) å…¶ä»–è³‡æ–™ï¼ˆç¬¬å››å€ï¼‰ */}
      <Collapse header="ğŸ“Œ å…¶ä»–è³‡æ–™" defaultOpen={false}>
        {otherCards.length === 0 ? (
          <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å…¶ä»–è³‡æ–™</div>
        ) : (
          <div className="grid gap-2">
            {otherCards.map(c => (
              <div key={c.id} className="rounded-lg border px-3 py-2">
                <div className="text-sm font-medium mb-1">{c.title || "æœªå‘½å"}</div>
                <div className="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">
                  {(c.content || "").split("\n").join(" / ")}
                </div>
              </div>
            ))}
          </div>
        )}
        <div className="mt-3 flex justify-end">
          <button onClick={() => setTab('others')} className="rounded-lg border px-3 py-1.5 text-sm">
            å‰å¾€ã€Œå…¶ä»–è³‡æ–™ã€
          </button>
        </div>
      </Collapse>

      {/* === ç½®é ‚å…¬å‘Šå½ˆçª—ï¼ˆåƒ…ç•¶æ¬¡é–‹å•Ÿé¡¯ç¤ºä¸€æ¬¡ï¼‰ === */}
      {showPinModal && (
        <div className="fixed inset-0 z-50">
          {/* èƒŒæ™¯é®ç½©ï¼šé»æ“Šé—œé–‰ */}
          <div className="absolute inset-0 bg-black/40" onClick={closePinModal} />
          {/* è¦–çª—æœ¬é«” */}
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div
              className="
                relative w-full max-w-md rounded-2xl
                bg-white dark:bg-slate-900
                border border-slate-200 dark:border-slate-700
                shadow-xl p-4
              "
              onClick={(e) => e.stopPropagation()}
              role="dialog"
              aria-modal="true"
              aria-label="ç½®é ‚å…¬å‘Š"
            >
              <div className="flex items-center justify-between mb-2">
                <div className="text-base font-semibold">ğŸ“£ æœ€æ–°å…¬å‘Š</div>
                <button
                  className="tap-target rounded-lg border px-2 py-1 text-sm"
                  onClick={closePinModal}
                  aria-label="é—œé–‰å…¬å‘Š"
                  title="é—œé–‰"
                >
                  âœ•
                </button>
              </div>

              <div className="grid gap-3 max-h-[60vh] overflow-auto pr-1">
                {pinnedCards.map((c) => (
                  <div key={c.id} className="rounded-lg border px-3 py-2">
                    <div className="text-sm font-medium mb-1">{c.title || "æœªå‘½å"}</div>
                    <div className="text-sm whitespace-pre-wrap">{c.content || "ï¼ˆç„¡å…§å®¹ï¼‰"}</div>
                  </div>
                ))}
              </div>

              <div className="mt-3 text-right">
                <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={closePinModal}>
                  æˆ‘çŸ¥é“äº†
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </Section>
  );
}

    function HomeShortcut({ label, onClick }) {
  return (
    <button
      onClick={onClick}
      className="rounded-xl2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-5 text-left shadow-soft hover:shadow-elevate transition-shadow"
    >
      <div className="text-base font-medium">{label}</div>
      <div className="text-xs text-slate-500 mt-1">é»æ“Šé€²å…¥</div>
    </button>
  );
}



// === Historyï¼ˆæ­·å²æŠ½çç´€éŒ„ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/è¤‡è£½åå–®ï¼ˆå«åˆ†é èˆ‡å½ˆå±¤æœˆæ›†ï¼‰ ===
function History({ data, admin, setData, query="", queryMode="all" }) {
  const [bulk, setBulk] = useState(null); // 'open' | 'close' | null
  const [draft, setDraft] = useState({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  const [editingId, setEditingId] = useState(null);
  const [showCal, setShowCal] = useState(false);

  // ğŸ“… æœˆæ›†ï¼šç›®å‰æª¢è¦–çš„å¹´æœˆï¼ˆUTCï¼‰èˆ‡è¢«ç¯©é¸æ—¥æœŸ
  const [cal, setCal] = useState(()=>{
    const now = new Date();
    return { y: now.getUTCFullYear(), m: now.getUTCMonth() }; // ä½¿ç”¨ UTC
  });
  const [filterDate, setFilterDate] = useState(""); // YYYY-MM-DDï¼ˆç©ºå­—ä¸²ï¼ä¸éæ¿¾ï¼‰

  // ç•¶æœˆæ—¥æ›†èˆ‡æ¯æ—¥ç´€éŒ„æ•¸
  const dayList = React.useMemo(()=> buildMonthDaysUTC(cal.y, cal.m), [cal]);
  const dateCounts = React.useMemo(()=>{
    const map = Object.create(null);
    for (const r of (data.history || [])) {
      const d = r?.date || "";
      if (!d) continue;
      map[d] = (map[d] || 0) + 1;
    }
    return map;
  }, [data.history]);

 // ç¯©é¸ï¼‹æœå°‹å¾Œçš„æ¸…å–®ï¼ˆå…ˆä¾æ—¥æœŸç¯©é¸ã€å†ä¾æœå°‹æ¨¡å¼ï¼‰
const items = React.useMemo(()=>{
  let list = data.history || [];

  // 1) æ—¥æœŸç¯©é¸
  if (filterDate) {
    list = list.filter(x => (x.date || "") === filterDate);
  }

  // 2) æœå°‹æ¨¡å¼
  const q = String(query || "").trim();
  if (!q) return list;

  return list.filter(rec => historyMatchByMode(rec, q, queryMode));
}, [data.history, filterDate, query, queryMode]);


  // === åˆ†é ï¼ˆå›ºå®šæ¯é  20 ç­†ï¼›History ç„¡ list/grid æ¨¡å¼ï¼‰ ===
  const [historyPage, setHistoryPage] = useLocalState('kjs_history_page', 1);
  const historyPageSize = 20;
  const historyTotal = items.length;
  const historyMaxPage = Math.max(1, Math.ceil(historyTotal / historyPageSize));

  React.useEffect(() => {
    if (historyPage > historyMaxPage) setHistoryPage(historyMaxPage);
  }, [historyPage, historyMaxPage, setHistoryPage]);

// çµ±ä¸€æ—¥æœŸé¡¯ç¤ºç‚º YYYY-MM-DDï¼ˆä¹Ÿå®¹å¿ 2025/9/2 é€™ç¨®ï¼‰
const fmtDate = React.useCallback((d) => {
  if (!d) return "æœªå¡«æ—¥æœŸ";
  const m = String(d).trim().match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  // m å¯èƒ½æœ‰å…©ç¨®ç¾¤çµ„ï¼Œæ•´ç†æˆ y, mo, da
  let y, mo, da;
  if (m) {
    y  = m[1]  || m[4];
    mo = m[2]  || m[5];
    da = m[3]  || m[6];
    return `${y}-${String(+mo).padStart(2, '0')}-${String(+da).padStart(2, '0')}`;
  }
  // éä»¥ä¸Šæ ¼å¼å°±ä¸å‹‰å¼·ï¼Œé¡¯ç¤ºã€Œæœªå¡«æ—¥æœŸã€
  return "æœªå¡«æ—¥æœŸ";
}, []);
 
 // ç¯©é¸æˆ–æœå°‹è®ŠåŒ–æ™‚å›åˆ°ç¬¬ 1 é 
  React.useEffect(() => {
    setHistoryPage(1);
  }, [filterDate, query, setHistoryPage]);

  const historyStart = (historyPage - 1) * historyPageSize;
  const historyEnd = Math.min(historyStart + historyPageSize, historyTotal);
  const historyPageItems = items.slice(historyStart, historyEnd);

  // é ç¢¼è¦–çª—ï¼ˆæœ€å¤š 5 æ ¼ï¼‰
  const historyWindowSize = 5;
  const historyStartPage = Math.max(
    1,
    Math.min(historyPage - Math.floor(historyWindowSize / 2), historyMaxPage - historyWindowSize + 1)
  );
  const historyEndPage = Math.min(historyMaxPage, historyStartPage + historyWindowSize - 1);

  // â€”â€” å‹•ä½œï¼šå­˜æª” / ç·¨è¼¯ / å–æ¶ˆ / åˆªé™¤ / è¤‡è£½ â€”â€” //
  const saveRecord = () => {
    if (!admin) return alert('è«‹é€²å…¥ç®¡ç†æ¨¡å¼');
    if (!draft.title) return alert('è«‹å¡«å¯«ã€çé …åç¨±ã€‘');

    const dateText = draft.date || "";
    const ts = parseISODate(dateText);
    if (dateText && Number.isNaN(ts)) return alert("æ—¥æœŸæ ¼å¼éœ€ç‚º YYYY-MM-DDï¼ˆä¾‹å¦‚ 2025-08-30ï¼‰");

    const rawLines = String(draft.winnersText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const winners = parseLinesClean(draft.winnersText);
    const removedDup = Math.max(0, rawLines.length - winners.length);

    const winnerCount = Number(draft.winnerCount || winners.length || 0);
    const totalParticipants = Number(draft.totalParticipants || 0);
    if (winnerCount < 0 || totalParticipants < 0) return alert("åé¡èˆ‡ç¸½åƒèˆ‡äººæ•¸éœ€ç‚º 0 æˆ–æ­£æ•´æ•¸");

    const summary = [
      `ç¢ºèªè¦${editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}å—ï¼Ÿ`,
      `çé …åç¨±ï¼š${draft.title}`,
      `æ—¥æœŸï¼š${dateText || "ï¼ˆæœªå¡«ï¼‰"}`,
      `å¾—çè€…äººæ•¸ï¼š${winners.length}${removedDup ? `ï¼ˆå·²è‡ªå‹•å»é‡ ${removedDup} ç­†ï¼‰` : ""}`,
      `æŠ½å‡ºåé¡ï¼š${winnerCount}`,
      `ç¸½åƒèˆ‡äººæ•¸ï¼š${totalParticipants || "ï¼ˆæœªå¡«ï¼‰"}`
    ].join("\n");
    if (!confirm(summary)) return;

    const rec = {
      id: editingId || Math.random().toString(36).slice(2,10),
      title: draft.title,
      date: dateText,
      winners,
      winnerCount,
      totalParticipants,
      youtube: draft.youtube || "",
      status: draft.status || "",
      note: draft.note || ""
    };

    const base = data.history || [];
    const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];
    const sorted = sortHistoryDesc(next); // å­˜æª”å³æ’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
    setData({ ...data, history: sorted });

    setEditingId(null);
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  };

  const editRecord = (x) => {
    if (!admin) return;
    setEditingId(x.id);
    setDraft({
      date: x.date||'',
      title: x.title||'',
      winnersText: (x.winners||[]).join('\n'),
      winnerCount: String(x.winnerCount??''),
      totalParticipants: String(x.totalParticipants??''),
      youtube: x.youtube||'',
      status: x.status||'',
      note: x.note||''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
    setEditingId(null);
  };

  const removeRecord = (id) => {
    if (!admin) return;
    if (!confirm('åˆªé™¤æ­¤ç­†æ­·å²ç´€éŒ„ï¼Ÿ')) return;
    setData({ ...data, history: (data.history || []).filter(x => x.id !== id) });
  };

  const copyWinners = (arr=[]) => navigator.clipboard.writeText((arr||[]).join('\n')).then(()=>alert('å·²è¤‡è£½å¾—çè€…åå–®'));

  // â€”â€” ç•«é¢ â€”â€” //
  return (
    <Section title="ğŸ“š æ­·å²æŠ½çç´€éŒ„" subtitle="å®Œæ•´æ­·å±†æ´»å‹•ç´€éŒ„ã€‚">
      {/* ğŸ“… æœˆæ›†å¿«ç¯©ï¼ˆé ‚éƒ¨ï¼‰â€” å°æŒ‰éˆ• + å½ˆå±¤ */}
      <div className="flex items-center justify-between mb-3">
  <div className="text-sm text-slate-500">ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸</div>
  <div className="flex items-center gap-2">
    {filterDate && (
      <button
        type="button"
        className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
        title="æ¸…é™¤æ—¥æœŸç¯©é¸ï¼Œæ¢å¾©å…¨éƒ¨ç€è¦½"
        onClick={() => { setFilterDate(""); setHistoryPage(1); }}
      >
        æ¸…é™¤ç¯©é¸
      </button>
    )}
    <button
      onClick={()=>setShowCal(true)}
      className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
      title="é–‹å•Ÿæœˆæ›†"
    >
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      æœˆæ›†
    </button>
  </div>
</div>


      {/* ç•¶å‰ç¯©é¸æç¤º */}
      <div className="text-xs text-slate-500 mb-3">
        {filterDate
          ? <>å·²å¥—ç”¨æ—¥æœŸç¯©é¸ï¼š<b>{filterDate}</b>ï¼ˆé»æœˆæ›†æ¸…é™¤ï¼‰</>
          : <>å¯ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸ç´€éŒ„</>}
      </div>

      {/* å½ˆå±¤æœˆæ›†ï¼ˆé®ç½© + ç½®ä¸­å¡ç‰‡ï¼‰ */}
      {showCal && (
  <div className="fixed inset-0 z-50" onClick={()=>setShowCal(false)}>
    {/* é»‘è‰²é®ç½©ï¼ˆæ­¤å±¤ä¸å†éœ€è¦ onClickï¼Œç¶­æŒè¦–è¦ºï¼‰ */}
    <div className="absolute inset-0 bg-black/40" />
    <div className="absolute inset-0 flex items-start justify-center p-4 overflow-auto sm:items-center">

      {/* å¡ç‰‡ä¸»é«”ï¼šé˜»æ­¢å†’æ³¡ï¼Œé¿å…é»æ“Šå¡ç‰‡å…§éƒ¨ä¹Ÿè¢«ç•¶æˆé—œé–‰ */}
      <div
        className="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4"
        onClick={(e)=>e.stopPropagation()}
      >
        <div className="flex items-center justify-between">
          <div className="text-sm font-medium">{cal.y} å¹´ {cal.m + 1} æœˆ</div>
          <div className="flex items-center gap-1">
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m-1<0?{y:y-1,m:11}:{y,m:m-1})); }}
              title="å‰ä¸€å€‹æœˆ"
            >â€¹</button>
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m+1>11?{y:y+1,m:0}:{y,m:m+1})); }}
              title="ä¸‹ä¸€å€‹æœˆ"
            >â€º</button>
            {/* ç›´æ¥åœ¨å½ˆå±¤å…§æä¾›ã€Œæ¸…é™¤ã€ï¼šä¸€éµæ¢å¾©å…¨éƒ¨ç€è¦½ */}
            {filterDate && (
              <button
                className="rounded-lg border px-2 py-1.5 text-sm"
                onClick={()=>{ setFilterDate(""); setHistoryPage(1); }}
                title="æ¸…é™¤æ—¥æœŸç¯©é¸"
              >
                æ¸…é™¤
              </button>
            )}
            {/* é¡å¤–çš„é—œé–‰æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰ */}
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>setShowCal(false)}
              title="é—œé–‰"
            >âœ•</button>
          </div>
        </div>

        {/* æ˜ŸæœŸåˆ— */}
        <div className="grid grid-cols-7 text-xs text-slate-500 mt-3">
          {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((w,i)=>(<div key={i} className="px-1 py-1 text-center">{w}</div>))}
        </div>

        {/* æ—¥æ›†æ ¼ */}
        <div className="grid grid-cols-7 gap-1 mt-1">
          {dayList.map((d, i)=>{
            if (!d) return <div key={i} className="h-9 rounded-lg" />;
            const count = dateCounts[d] || 0;
            const active = !!count;
            const selected = filterDate === d;
            return (
              <button
                key={i}
                onClick={()=>{
                  setFilterDate(prev => prev === d ? "" : d);
                  setHistoryPage(1);
                  setShowCal(false);
                }}
                className={[
                  "h-9 rounded-lg border text-sm flex flex-col items-center justify-center",
                  selected ? "border-brand bg-brand/10" : "border-slate-200 dark:border-slate-700",
                  active ? "hover:bg-slate-50 dark:hover:bg-slate-800" : "opacity-60"
                ].join(" ")}
                title={active ? `æ­¤æ—¥å…±æœ‰ ${count} ç­†ç´€éŒ„` : "æ­¤æ—¥æ²’æœ‰ç´€éŒ„"}
              >
                <div className="leading-none">{parseInt(d.slice(-2),10)}</div>
                {active && (
                  <div className="text-[10px] leading-none mt-0.5 inline-flex items-center px-1 rounded border bg-white/70 dark:bg-slate-800/70">
                    {count}
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  </div>
)}


      {/* ç®¡ç†è¡¨å–® */}
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d,date:e.target.value}))} placeholder="æˆªæ­¢/é–‹çæ—¥æœŸ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="çé …åç¨±"/>
            <input className="rounded-lg border px-3 py-2" value={draft.winnerCount} onChange={e=>setDraft(d=>({...d,winnerCount:e.target.value}))} placeholder="æŠ½å‡ºåé¡ï¼ˆç•™ç©ºï¼ä»¥åå–®æ•¸é‡ï¼‰"/>
            <input className="rounded-lg border px-3 py-2" value={draft.totalParticipants} onChange={e=>setDraft(d=>({...d,totalParticipants:e.target.value}))} placeholder="ç¸½åƒèˆ‡äººæ•¸"/>
            <input className="rounded-lg border px-3 py-2 sm:col-span-2" value={draft.youtube} onChange={e=>setDraft(d=>({...d,youtube:e.target.value}))} placeholder="æŠ½çå½±ç‰‡ï¼ˆYouTube é€£çµï¼Œå¯ç©ºç™½ï¼‰"/>
            <select
              className="rounded-lg border px-3 py-2"
              value={draft.status}
              onChange={e=>setDraft(d=>({...d,status:e.target.value}))}
            >
              <option value="">ï¼ˆä¸å¡«ï¼‰</option>
              {HISTORY_STATUS_OPTIONS.map(opt=>(
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
            </select>
            <input className="rounded-lg border px-3 py-2" value={draft.note} onChange={e=>setDraft(d=>({...d,note:e.target.value}))} placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">å¾—çè€…åå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
            <textarea className="mt-1 w-full rounded-lg border px-3 py-2 min-h-[120px]" value={draft.winnersText} onChange={e=>setDraft(d=>({...d,winnersText:e.target.value}))} placeholder="ä¸€è¡Œä¸€å€‹ LINE æš±ç¨±"></textarea>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveRecord} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      {/* å…¨å±•/å…¨æ”¶ï¼ˆåƒ…å°ç•¶é æœ‰æ•ˆï¼‰ */}
      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

      </div>

      {/* æ¸…å–®ï¼ˆç•¶é è³‡æ–™ï¼‰ */}
      <div className="grid gap-4 mt-4">
        {historyPageItems.map(x => (
          <Collapse
  key={x.id}
  group="history"
  uid={x.id}
  force={bulk}  // ä¿ç•™
  header={(open) => <HistoryHeaderRow rec={x} />}
>
  {/* æ‰‹æ©Ÿï¼šå±•é–‹å¾Œé¡¯ç¤ºå®Œæ•´çå“åç¨± */}
  <div className="sm:hidden mb-2">
    <div className="text-[15px] font-medium whitespace-normal break-words">
      <span className="mr-1" aria-hidden="true">ğŸ</span>
      {x.title || "ï¼ˆæœªå‘½åï¼‰"}
    </div>
  </div>

  <div className="text-sm grid sm:grid-cols-2 gap-x-6 gap-y-1">
    <div>æŠ½å‡ºåé¡ï¼š{x.winnerCount ?? (x.winners?.length||0)}</div>
    <div>ç¸½åƒèˆ‡äººæ•¸ï¼š{x.totalParticipants ?? '-'}</div>

    {x.youtube && (
      <div className="sm:col-span-2 truncate">
        å½±ç‰‡ï¼š
        <a className="text-brand underline" href={x.youtube} target="_blank" rel="noreferrer">
          {x.youtube}
        </a>
      </div>
    )}

    {x.status && (
      <div className="sm:col-span-2">
        <StatusTag value={x.status} />
      </div>
    )}

    {x.note && <div className="sm:col-span-2">å‚™è¨»ï¼š{x.note}</div>}
  </div>

  <div className="mt-3">
    <div className="text-sm text-slate-500 mb-1">å¾—çè€…ï¼š</div>
    <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
      {(x.winners||[]).join('\n')}
    </pre>
  </div>

  <div className="mt-3 flex gap-2 justify-end">
    <button onClick={()=>copyWinners(x.winners)} className="rounded-lg border px-3 py-1.5">è¤‡è£½åå–®</button>
    {admin && (
      <>
        <button onClick={()=>editRecord(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
        <button onClick={()=>removeRecord(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
      </>
    )}
  </div>
</Collapse>

        ))}
      </div>

      {/* åˆ†é æ§åˆ¶ï¼ˆHistoryï¼‰ */}
      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage <= 1}
          onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
        >
          ä¸Šä¸€é 
        </button>

        {Array.from({ length: (historyEndPage - historyStartPage + 1) }, (_, i) => historyStartPage + i).map(p => (
          <button
            key={p}
            type="button"
            className={`rounded-lg border px-3 py-1.5 text-sm ${p === historyPage ? 'bg-brand text-white border-brand' : ''}`}
            onClick={() => setHistoryPage(p)}
          >
            {p}
          </button>
        ))}

        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage >= historyMaxPage}
          onClick={() => setHistoryPage(p => Math.min(historyMaxPage, p + 1))}
        >
          ä¸‹ä¸€é 
        </button>
      </div>
    </Section>
  );
}

function LinksPage({ data, setData, admin }) {
  const links = Array.isArray(data?.homepage?.links) ? data.homepage.links : [];
  const [page, setPage] = useLocalState('kjs_links_page', 1);
  const pageSize = 20;
  const total = links.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);

  const [draft, setDraft] = React.useState({ name: '', url: '' });

  const addLink = () => {
    if (!admin) return;
    if (!draft.name.trim() || !draft.url.trim()) return alert('è«‹å¡«åç¨±èˆ‡ç¶²å€');
    const next = [{ id: nid(), name: draft.name.trim(), url: draft.url.trim() }, ...links];
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: next } }));
    setDraft({ name:'', url:'' });
  };
  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm('åˆªé™¤æ­¤é€£çµï¼Ÿ')) return;
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: (s.homepage?.links||[]).filter(x=>x.id!==id) } }));
  };

  return (
    <Section title="ğŸ”— ç¤¾ç¾¤èˆ‡å®˜æ–¹é€£çµ" subtitle="å¯è‡ªè¨‚å¤šå€‹é€£çµï¼Œæ”¯æ´åˆ†é ã€‚">
      {admin && (
        <div className="mb-3 grid sm:grid-cols-[1fr_2fr_auto] gap-2">
          <input className="rounded-lg border px-3 py-2" placeholder="åç¨±"
                 value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))}/>
          <input className="rounded-lg border px-3 py-2" placeholder="https://..."
                 value={draft.url} onChange={e=>setDraft(d=>({...d,url:e.target.value}))}/>
          <button className="rounded-lg bg-brand text-white px-3 py-2" onClick={addLink}>æ–°å¢</button>
        </div>
      )}

      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
        {links.slice(start, end).map(x => (
          <a key={x.id} href={x.url} target="_blank" rel="noreferrer"
             className="rounded-xl border p-3 hover:border-brand">
            <div className="font-medium truncate">{x.name || x.url}</div>
            <div className="text-xs text-slate-500 truncate">{x.url}</div>
            {admin && (
              <div className="mt-2 text-right">
                <button className="rounded-lg border px-2 py-1 text-xs"
                        onClick={(e)=>{e.preventDefault(); removeLink(x.id);}}>åˆªé™¤</button>
              </div>
            )}
          </a>
        ))}
      </div>

      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
        {Array.from({length:(endPage - startPage + 1)}, (_,i)=>startPage+i).map(p=>(
          <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page?'bg-brand text-white border-brand':''}`}
                  onClick={()=>setPage(p)}>{p}</button>
        ))}
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
      </div>
    </Section>
  );
}




// === Ongoingï¼ˆé€²è¡Œä¸­æ´»å‹•ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/ä¸Šä¸‹ç§»å‹•/å•Ÿç”¨åœç”¨ ===
function Ongoing({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  const [editingId, setEditingId] = useState(null);

  const items = React.useMemo(()=>{
  let list = data.ongoing || [];
  if(!admin) list = list.filter(x => x.enabled !== false);
  const q = String(query).trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>{
    const hay = [
      x.title, x.desc, x.rules, x.link
    ].map(s => String(s||"").toLowerCase()).join(" ");
    return hay.includes(q);
  });
},[data.ongoing, admin, query]);

  const HasImageInput = typeof ImageInput === "function";

  const saveOngoing = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, desc: draft.desc||"", rules: draft.rules||"", link: draft.link||"", image: draft.image||"", enabled: !!draft.enabled };
    const base = data.ongoing || [];
const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];

    setData({ ...data, ongoing: next });
    setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  };

  const editOngoing = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", desc:x.desc||"", rules:x.rules||"", link:x.link||"", image:x.image||"", enabled: !!x.enabled }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true }); };

  const removeOngoing = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, ongoing: (data.ongoing || []).filter(x => x.id !== id) }); };

  const toggleEnabled = (id) => { if(!admin) return; setData({ ...data, ongoing: (data.ongoing || []).map(x => x.id===id ? { ...x, enabled: !x.enabled } : x) });
 };

  const move = (id, dir) => {
  if (!admin) return;
  const arr = [...(data.ongoing || [])];
  const i = arr.findIndex(x => x.id === id);
  const j = dir === "up" ? i - 1 : i + 1;
  if (i < 0 || j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  setData({ ...data, ongoing: arr });
};

  const moveUp = (id) => move(id, 'up');
  const moveDown = (id) => move(id, 'down');

  return (
    <Section title="ğŸ”„ é€²è¡Œä¸­æ´»å‹•" subtitle="å¡ç‰‡å¼å±•ç¤ºï¼ˆå¯ä¸Šä¸‹ç§»å‹•ã€å•Ÿç”¨/åœç”¨ã€ç·¨è¼¯ï¼‰ã€‚">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="æ¨™é¡Œ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.link} onChange={e=>setDraft(d=>({...d,link:e.target.value}))} placeholder="é€£çµï¼ˆå¯ç©ºç™½ï¼‰"/>
            <div className="sm:col-span-2">
              {HasImageInput
                ? <ImageInput label="å±•ç¤ºåœ–ç‰‡" value={draft.image} onChange={(v)=>setDraft(d=>({...d,image:v}))}/>
                : <input className="rounded-lg border px-3 py-2 w-full" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="å±•ç¤ºåœ–ç‰‡ï¼ˆç¶²å€æˆ– base64ï¼‰"/>}
            </div>
          </div>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))} placeholder="ä»‹ç´¹ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.rules} onChange={e=>setDraft(d=>({...d,rules:e.target.value}))} placeholder="è¦å‰‡ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.enabled} onChange={e=>setDraft(d=>({...d,enabled:e.target.checked}))}/>å•Ÿç”¨ï¼ˆå‹¾é¸ï¼å°å¤–é¡¯ç¤ºï¼‰</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveOngoing} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {items.map((x)=> (
          <Collapse key={x.id} 
 group="ongoing"        // â˜… æ–°å¢
  uid={x.id}             // â˜… æ–°å¢
  force={bulk}           // ä½ åŸæœ¬å°±æœ‰ï¼Œç•™è‘—
header={`${x.title || "æœªå‘½åæ´»å‹•"}`} force={bulk}>
            {x.image && <img src={x.image} alt="æ´»å‹•åœ–ç‰‡" className="rounded-lg max-h-56 object-contain w-full bg-slate-50 dark:bg-slate-800 mb-2"/>}
            {x.link && <div className="text-sm mb-2">é€£çµï¼š<a className="underline text-brand" href={x.link} target="_blank" rel="noreferrer">{x.link}</a></div>}
            {x.desc && <div className="text-sm whitespace-pre-wrap mb-2">{x.desc}</div>}
            {x.rules && <div className="text-sm whitespace-pre-wrap mb-2"><span className="text-slate-500">è¦å‰‡ï¼š</span>{x.rules}</div>}
            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>moveUp(x.id)} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>moveDown(x.id)} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>toggleEnabled(x.id)} className="rounded-lg border px-3 py-1.5">
                  {x.enabled ? "åœç”¨" : "å•Ÿç”¨"}
                </button>
                <button onClick={()=>removeOngoing(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

// é»æ•¸å•†åŸ â€” å›ºå®š 9/16 æ¬„ã€åªä¿ç•™å°å¡è©³æƒ…ï¼ˆä¸å†é–‹å…¨è¢å¹•åœ–å±¤ï¼‰
// ç®¡ç†åŠŸèƒ½ï¼ˆShopEditorï¼‰ä¿ç•™ï¼›onSave æ­£ç¢ºå¯«å› data.shop.items
function Shop({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  // åå¥½ï¼ˆä¹/åå…­å®®æ ¼ã€æ¯é ï¼‰
  const prefKey = "pointshop_prefs_v2";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9"); // grid9 / grid16
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // æˆ‘çš„é»æ•¸ï¼ˆè‹¥ data å¸¶æœ‰ myPoints/points.myPointsï¼Œé è¨­å¸¶å…¥ï¼‰
  const initialMyPts =
    (Number.isFinite(+data?.points?.myPoints) ? +data.points.myPoints : null) ??
    (Number.isFinite(+data?.myPoints) ? +data.myPoints : 0);
  const [myPts, setMyPts] = React.useState(initialMyPts || 0);

  // ç®¡ç†é¢æ¿
  const [showEditor, setShowEditor] = React.useState(false);
  const HasShopEditor = typeof ShopEditor === "function";

  // å°å¡è©³æƒ…ï¼ˆæ²¿ç”¨æ—¢æœ‰ ProductSheetï¼‰
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // å·¥å…·
  const safeNumber = (v) => {
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) return +v;
    return null;
  };
  const getRemain = (x) => {
    const v = [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find(n=>n!=null);
    return v==null ? null : v;
  };
  const getNeedPts = (x) => {
    const v = [x?.points, x?.pts, x?.need, x?.needPoints, x?.cost, x?.costPts, x?.pricePts]
      .map(safeNumber).find((n)=> n!=null);
    return v==null ? null : v;
  };

  // è³‡æ–™
  const itemsRaw = Array.isArray(data?.shop?.items) ? data.shop.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    return { ...it, _images: images.filter(Boolean), _needPts: getNeedPts(it) };
  };
  const allItems = React.useMemo(()=> itemsRaw.map(normalizeItem), [itemsRaw]);

  // æœå°‹ / æ’åº / éæ¿¾
  const [search, setSearch] = React.useState(query || "");
  const [sortBy, setSortBy] = React.useState("latest"); // latest | ptsAsc | ptsDesc
  const [onlyInStock, setOnlyInStock] = React.useState(false);
  const [onlyAffordable, setOnlyAffordable] = React.useState(false);

  const filtered = React.useMemo(()=>{
    const kw = String(search||"").trim().toLowerCase();
    return allItems.filter(x=>{
      const hay = [x?.name, x?.title, x?.desc, x?.intro].map(s=>String(s||"").toLowerCase()).join(" ");
      const hitKW = !kw || hay.includes(kw);
      const remain = getRemain(x);
      const hitStock = !onlyInStock || (remain==null || remain>0);
      const need = x._needPts ?? 0;
      const hitAffordable = !onlyAffordable || (need<=myPts);
      return hitKW && hitStock && hitAffordable;
    });
  }, [allItems, search, onlyInStock, onlyAffordable, myPts]);

  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    if (sortBy==="ptsAsc")       arr.sort((a,b)=> ((a._needPts??Infinity) - (b._needPts??Infinity)));
    else if (sortBy==="ptsDesc") arr.sort((a,b)=> ((b._needPts??-Infinity) - (a._needPts??-Infinity)));
    else                         arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered, sortBy]);

  // åˆ†é 
  const total   = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [search, sortBy, view, pageSize, onlyInStock, onlyAffordable, myPts]);
  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage  = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage    = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems  = sorted.slice(start, end);

  // å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿå¯æ›è¡Œï¼‰
  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        <input className="flex-1 min-w-[220px] rounded border px-3 py-2" placeholder="æœå°‹æ´»å‹•..." value={search} onChange={e=>setSearch(e.target.value)} />
        <select className="rounded border px-2 py-2" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
          <option value="latest">æœ€æ–°æ›´æ–°</option>
          <option value="ptsAsc">æ‰€éœ€é»æ•¸ï¼ˆä½â†’é«˜ï¼‰</option>
          <option value="ptsDesc">æ‰€éœ€é»æ•¸ï¼ˆé«˜â†’ä½ï¼‰</option>
        </select>
        <label className="flex items-center gap-1">
          <input type="checkbox" checked={onlyInStock} onChange={e=>setOnlyInStock(e.target.checked)} />
          åªçœ‹æœ‰è²¨
        </label>
        <label className="flex items-center gap-1">
          ç‰ˆé¢
          <select className="rounded border px-2 py-2" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 å®®æ ¼</option>
            <option value="grid16">16 å®®æ ¼</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          æ¯é 
          <select className="rounded border px-2 py-2" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>

        {/* æˆ‘çš„é»æ•¸ & åªçœ‹æˆ‘å¯å…Œæ› */}
        <div className="flex items-center gap-2 ml-auto">
          <label className="flex items-center gap-1">
            æˆ‘çš„é»æ•¸
            <input
              type="number"
              inputMode="numeric"
              className="w-20 rounded border px-2 py-2 text-right"
              value={myPts}
              onChange={e=>setMyPts(Math.max(0, Number(e.target.value)||0))}
            />
          </label>
          <label className="flex items-center gap-1">
            <input type="checkbox" checked={onlyAffordable} onChange={e=>setOnlyAffordable(e.target.checked)} />
            åªçœ‹ã€Œæˆ‘å¯å…Œæ›ã€
          </label>
        </div>

        <div className="grow basis-full sm:basis-auto" />
        {admin && HasShopEditor && (
          <button className="rounded-lg border px-3 py-2" onClick={()=>setShowEditor(true)}>ç®¡ç†</button>
        )}
      </div>
    </div>
  );

  // æ‰‹æ©Ÿä¹Ÿå›ºå®š 9/16 æ¬„
  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      <div className={`grid ${gridCols} gap-3`} aria-label="é»æ•¸å•†åŸæ¸…å–®">
        {pageItems.map((x, i) => {
          const name    = x?.name || x?.title || 'ï¼ˆæœªå‘½åï¼‰';
          const needPts = x._needPts ?? getNeedPts(x);
          const cover   = Array.isArray(x._images) && x._images.length>0 ? x._images[0] : '';
          const remain  = getRemain(x);

        return (
          <details key={x.id || i} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none">
            {/* é» summary â†’ åªé–‹ ProductSheetï¼ˆä¸å†é–‹ç¬¬äºŒå±¤åœ–ç‰‡æª¢è¦–å™¨ï¼‰ */}
            <summary className="list-none cursor-pointer p-3" onClick={(e)=>{ e.preventDefault(); setSheet({ open:true, item:x }); }}>
              <div className="flex flex-col">
                <div className="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                  {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
                </div>
                <div className="mt-2 flex items-center justify-between gap-2">
                  <div className="min-w-0">
                    <div className="font-medium text-[15px] whitespace-normal break-words" title={name}>{name}</div>
                  </div>
                  {needPts!=null && (
                    <div className={`text-sm ${myPts>=needPts ? 'text-emerald-700 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-300'} whitespace-nowrap`}>
                      {needPts} é»
                    </div>
                  )}
                </div>
              </div>
            </summary>

            {/* å±•é–‹å…§å®¹ï¼šä¿ç•™å¯å­˜å–æ€§ï¼ˆä¸»è¦äº’å‹•èµ°ä¸Šé¢çš„ summary é–‹å•Ÿ sheetï¼‰ */}
            <div className="px-3 pb-3">
              <div className="text-sm space-y-2">
                {remain!=null && <div className="text-slate-600">å‰©é¤˜æ•¸é‡ï¼š{remain}</div>}
                {needPts!=null && <div className="text-slate-600">å…Œæ›éœ€æ±‚ï¼š{needPts} é»ï¼ˆä½ ç›®å‰ {myPts} é»ï¼‰</div>}
                {x.desc  && <div className="whitespace-pre-wrap leading-relaxed break-words">{x.desc}</div>}
                {x.intro && <div className="whitespace-pre-wrap leading-relaxed break-words">{x.intro}</div>}
              </div>

              {/* å…Œæ›æŒ‰éˆ•ï¼ˆä½ çš„æµç¨‹è‹¥æœ‰ï¼Œå¯åœ¨é€™è£¡æ¥ä¸Šï¼‰ */}
              <div className="mt-3">
                <button
                  disabled={needPts==null || myPts<needPts}
                  className={`inline-flex items-center justify-center w-full rounded-lg px-4 py-2 text-sm shadow-soft
                  ${needPts!=null && myPts>=needPts ? 'bg-brand text-white' : 'border text-slate-400'}`}
                  title={needPts!=null && myPts>=needPts ? 'å¯å…Œæ›' : 'é»æ•¸ä¸è¶³æˆ–æœªè¨­å®š'}
                >
                  {needPts!=null && myPts>=needPts ? 'æˆ‘è¦å…Œæ›' : 'ç„¡æ³•å…Œæ›'}
                </button>
              </div>
            </div>
          </details>
        );})}
      </div>

      <Paginator />

      {/* ç®¡ç†é¢æ¿ï¼šæ­£ç¢º wiring â€” ç”¨ items + onSave + onClose */}
      {admin && HasShopEditor && showEditor && (
        <ShopEditor
          items={Array.isArray(data?.shop?.items) ? data.shop.items : []}
          onSave={(nextItems) => {
            const safeNext = Array.isArray(nextItems) ? nextItems : [];
            setData(s => ({ ...s, shop: { ...(s.shop || {}), items: safeNext } }));
            setShowEditor(false);
          }}
          onClose={()=>setShowEditor(false)}
        />
      )}

      {/* âœ… åªä¿ç•™å°å¡è©³æƒ…ï¼›ä¸å†å‚³ onOpenViewerï¼Œé¿å…å†é–‹ç¬¬äºŒå±¤åœ–å±¤ */}
      <ProductSheet
        open={sheet.open}
        item={sheet.item}
        context="shop"
        onClose={()=>setSheet({ open:false, item:null })}
      />
    </section>
  );
}


// ============================
// ShopEditorï¼šå°ˆç‚ºé»æ•¸å•†åŸçš„ç®¡ç†ç·¨è¼¯å™¨ï¼ˆä¸å½±éŸ¿ StoreEditorï¼‰
// ============================
function ShopEditor({ items = [], onSave, onClose }) {
  const React = window.React || globalThis.React;
  const [list, setList] = React.useState(()=> (Array.isArray(items) ? items.map(x=>({ ...x })) : []));
  const [editingIndex, setEditingIndex] = React.useState(-1);

  const blankItem = () => ({
    enabled: true,
    name: "",
    points: "",
    desc: "",
    intro: "",
    tags: "",
    image: "",
    images: []
  });

  const move = (i, dir) => {
    setList(arr=>{
      const a = [...arr];
      const j = i + dir;
      if (j<0 || j>=a.length) return a;
      const tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      return a;
    });
  };
  const remove = (i) => setList(arr => arr.filter((_,k)=>k!==i));
  const toggle = (i) => setList(arr => arr.map((x,k)=> k===i ? ({ ...x, enabled: !(x.enabled !== false) }) : x));
  const addNew = () => { setList(arr => [...arr, blankItem()]); setEditingIndex(list.length); };

  const parseImages = (text) => {
    const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    return Array.from(new Set(lines));
  };

  const ItemRow = ({x, i}) => {
    const need = x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? "";
    const cover = Array.isArray(x?.images) && x.images.length ? x.images[0] : (x?.image || "");
    return (
      <div className="grid grid-cols-[auto_1fr_auto] items-center gap-3 px-3 py-2 border-b">
        <div className="w-12 h-12 rounded bg-slate-100 overflow-hidden grid place-content-center">
          {cover ? <img src={cover} alt="" className="w-full h-full object-cover" /> : <span className="text-xs text-slate-400">ç„¡</span>}
        </div>
        <div className="min-w-0">
          <div className="font-medium truncate">{x?.name || "ï¼ˆæœªå‘½åï¼‰"}</div>
          <div className="text-xs text-slate-500 truncate">éœ€è¦é»æ•¸ï¼š{need||"â€”"}ã€€æ¨™ç±¤ï¼š{Array.isArray(x?.tags)? x.tags.join(",") : (x?.tags||"â€”")}</div>
        </div>
        <div className="flex items-center gap-1">
          <button className={`px-2 py-1 rounded text-xs border ${x?.enabled!==false ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : ''}`} onClick={()=>toggle(i)}>
            {x?.enabled!==false ? 'ä¸Šæ¶ä¸­' : 'å·²åœç”¨'}
          </button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>move(i,-1)}>ä¸Šç§»</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>move(i, 1)}>ä¸‹ç§»</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>setEditingIndex(i)}>ç·¨è¼¯</button>
          <button className="px-2 py-1 rounded text-xs border text-rose-600" onClick={()=>remove(i)}>åˆªé™¤</button>
        </div>
      </div>
    );
  };

  const EditorModal = ({x, i}) => {
    const [draft, setDraft] = React.useState(()=>({
      enabled: x?.enabled !== false,
      name: x?.name || "",
      points: (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? ""),
      desc: x?.desc || "",
      intro: x?.intro || "",
      tags: Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags || ""),
      image: x?.image || "",
      imagesText: (Array.isArray(x?.images) ? x.images : (x?.image ? [x.image] : [])).join("\n"),
    }));

    const save = ()=>{
      const next = { ...x };
      next.enabled = !!draft.enabled;
      next.name = draft.name.trim();
      const n = draft.points;
      if (n==="" || n==null) { delete next.points; } else { next.points = n; }
      next.desc = draft.desc;
      next.intro = draft.intro;
      next.tags = draft.tags ? draft.tags.split(",").map(s=>s.trim()).filter(Boolean) : [];
      const imgs = parseImages(draft.imagesText);
      next.images = imgs;
      next.image = imgs[0] || "";
      setList(arr => arr.map((it,k)=> k===i ? next : it));
      setEditingIndex(-1);
    };

    return (
      <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center" role="dialog" aria-modal="true">
        <div className="w-[min(960px,96vw)] max-h-[90vh] overflow-auto rounded-2xl bg-white dark:bg-slate-900 shadow-xl">
          <div className="flex items-center justify-between px-4 py-3 border-b">
            <div className="font-semibold">ç·¨è¼¯é»æ•¸å•†å“</div>
            <div className="flex items-center gap-2">
              <button className="rounded border px-3 py-1.5 text-sm" onClick={()=>setEditingIndex(-1)}>å–æ¶ˆ</button>
              <button className="rounded bg-brand text-white px-3 py-1.5 text-sm" onClick={save}>å„²å­˜</button>
            </div>
          </div>

          <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="grid gap-1 text-sm">
              åç¨±
              <input className="rounded border px-3 py-2" value={draft.name} onChange={e=>setDraft(d=>({ ...d, name:e.target.value }))}/>
            </label>

            <label className="grid gap-1 text-sm">
              éœ€æ±‚é»æ•¸
              <input className="rounded border px-3 py-2" type="number" min="0" value={draft.points} onChange={e=>setDraft(d=>({ ...d, points: e.target.value }))}/>
            </label>

            <label className="md:col-span-2 grid gap-1 text-sm">
              æè¿°ï¼ˆdescï¼‰
              <textarea className="rounded border px-3 py-2 min-h-[72px]" value={draft.desc} onChange={e=>setDraft(d=>({ ...d, desc:e.target.value }))}/>
            </label>

            <label className="md:col-span-2 grid gap-1 text-sm">
              ä»‹ç´¹ï¼ˆintroï¼‰
              <textarea className="rounded border px-3 py-2 min-h-[72px]" value={draft.intro} onChange={e=>setDraft(d=>({ ...d, intro:e.target.value }))}/>
            </label>

            <label className="grid gap-1 text-sm">
              æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
              <input className="rounded border px-3 py-2" value={draft.tags} onChange={e=>setDraft(d=>({ ...d, tags:e.target.value }))}/>
            </label>

            <label className="md:col-span-2 grid gap-1 text-sm">
              æ›´å¤šåœ–ç‰‡ï¼ˆé€è¡Œè²¼ä¸Šï¼‰
              <textarea className="rounded border px-3 py-2 min-h-[160px]" placeholder="https://...jpg\nhttps://...png"
                        value={draft.imagesText}
                        onChange={e=>setDraft(d=>({ ...d, imagesText: e.target.value }))}/>
              <div className="text-xs text-slate-500">ç¬¬ä¸€è¡Œå°‡ä½œç‚ºå°é¢ï¼ˆåŒæ™‚å¯«å…¥ image èˆ‡ images[0] ä»¥ç¶­æŒç›¸å®¹ï¼‰ã€‚</div>
            </label>

            <div className="md:col-span-2">
              <div className="text-sm mb-2">é è¦½</div>
              <div className="flex gap-2 flex-wrap">
                {parseImages(draft.imagesText).map((src, idx)=>(
                  <div key={idx} className="w-20 h-20 rounded border overflow-hidden bg-slate-100 grid place-content-center">
                    {src ? <img src={src} alt="" className="w-full h-full object-cover"/> : <span className="text-xs text-slate-400">ç„¡</span>}
                  </div>
                ))}
                {parseImages(draft.imagesText).length===0 && <div className="text-xs text-slate-500">ç„¡åœ–ç‰‡</div>}
              </div>
            </div>

            <label className="flex items-center gap-2 text-sm">
              <input type="checkbox" checked={draft.enabled} onChange={e=>setDraft(d=>({ ...d, enabled:e.target.checked }))}/>
              ä¸Šæ¶ï¼ˆenabledï¼‰
            </label>
          </div>
        </div>
      </div>
    );
  };

  const exportCSV = ()=>{
    const headers = ["enabled","name","points","desc","intro","tags","image","images"];
    const rows = list.map(x=>{
      const tags = Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags||"");
      const images = Array.isArray(x?.images) ? x.images.join("|") : (x?.image ? String(x.image) : "");
      return [ (x?.enabled!==false), (x?.name||""), (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? ""), (x?.desc||""), (x?.intro||""), tags, (x?.image||""), images ];
    });
    const csv = [headers.join(","), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "shop_items.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  return (
    <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center" role="dialog" aria-modal="true">
      <div className="w-[min(1024px,96vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 shadow-xl flex flex-col">
        {/* header */}
        <div className="flex items-center justify-between px-4 py-3 border-b">
          <div className="font-semibold">é»æ•¸å•†åŸç®¡ç†</div>
          <div className="flex items-center gap-2">
            <button className="rounded border px-3 py-1.5 text-sm" onClick={exportCSV}>åŒ¯å‡º CSV</button>
            <button className="rounded border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
            <button className="rounded bg-brand text-white px-3 py-1.5 text-sm" onClick={()=>onSave(list)}>å„²å­˜</button>
          </div>
        </div>

        {/* list */}
        <div className="flex-1 overflow-auto">
          <div className="p-2">
            <button className="mb-2 rounded bg-emerald-600 text-white px-3 py-1.5 text-sm" onClick={addNew}>æ–°å¢é …ç›®</button>
            <div className="rounded border overflow-hidden">
              {list.length===0 && <div className="p-6 text-center text-slate-500 text-sm">ç›®å‰æ²’æœ‰é …ç›®</div>}
              {list.map((x,i)=> <ItemRow key={i} x={x} i={i} />)}
            </div>
          </div>
        </div>
      </div>

      {/* editor modal */}
      {editingIndex>=0 && <EditorModal x={list[editingIndex]} i={editingIndex} />}
    </div>
  );
}

function Others({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", content:"", pin:false });
  const [editingId, setEditingId] = useState(null);

  const cards = React.useMemo(()=> data.others?.cards || [], [data.others]);

  const orderedCards = React.useMemo(()=>{
    const list = data.others?.cards || [];
    const q = String(query).trim().toLowerCase();
    const filtered = q
      ? list.filter(x =>
          String(x.title||"").toLowerCase().includes(q) ||
          String(x.content||"").toLowerCase().includes(q)
        )
      : list;
    // pin=true ç½®é ‚å„ªå…ˆ
    return [...filtered].sort((a,b)=> (b.pin===true) - (a.pin===true));
  },[data.others, query]);

  const saveCard = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, content: draft.content||"", pin: !!draft.pin };
    const next = editingId ? cards.map(x=>x.id===editingId?rec:x) : [rec, ...cards];
    setData({ ...data, others: { ...data.others, cards: next } });
    setEditingId(null); setDraft({ title:"", content:"", pin:false });
  };

  const editCard = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", content:x.content||"", pin: !!x.pin }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", content:"", pin:false }); };

  const removeCard = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, others: { ...data.others, cards: cards.filter(x=>x.id!==id) } }); };
  const togglePin = (id) => { if(!admin) return; setData({ ...data, others: { ...data.others, cards: cards.map(x=>x.id===id?{...x,pin:!x.pin}:x) } }); };

  const move = (id, dir) => {
    if (!admin) return;
    const arr = [...cards], i = arr.findIndex(x=>x.id===id), j = dir==="up" ? i-1 : i+1;
    if (i<0 || j<0 || j>=arr.length) return;
    [arr[i], arr[j]] = [arr[j], arr[i]];
    setData({ ...data, others: { ...data.others, cards: arr } });
  };

  return (
    <Section title="ğŸ“Œ å…¶ä»–è³‡æ–™" subtitle="å‰µç«‹åˆè¡·ã€å…¬å‘Šã€é–‹çæ–¹å¼ã€è£œå¯„/å†æŠ½è¦å‰‡ã€é»æ•¸è¦å‰‡ã€è´ŠåŠ©èªªæ˜ã€è´ŠåŠ©è€…åå–®ã€æŸ¥è©¢é»æ•¸â€¦">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="å¡ç‰‡æ¨™é¡Œï¼ˆå¦‚ï¼šæœ€æ–°å…¬å‘Šï¼‰"/>
          <textarea className="rounded-lg border px-3 py-2 min-h-[120px]" value={draft.content} onChange={e=>setDraft(d=>({...d,content:e.target.value}))} placeholder="å…§å®¹ï¼ˆå¯è²¼é€£çµï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.pin} onChange={e=>setDraft(d=>({...d,pin:e.target.checked}))}/>ç½®é ‚</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveCard} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {cards.length === 0 && <EmptyCard text="ç›®å‰æ²’æœ‰å¡ç‰‡å…§å®¹" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {orderedCards.map((x)=> (
          <Collapse key={x.id} 
group="others"         // â˜… æ–°å¢
  uid={x.id}             // â˜… æ–°å¢
  force={bulk}           // ä½ åŸæœ¬å°±æœ‰ï¼Œç•™è‘—
header={`${x.title || "æœªå‘½åå¡ç‰‡"}`} force={bulk}>
            <div className="whitespace-pre-wrap text-sm max-h-60 overflow-auto">
  {x.content || "ï¼ˆç„¡å…§å®¹ï¼‰"}
</div>

            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>move(x.id,'up')} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>move(x.id,'down')} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>togglePin(x.id)} className="rounded-lg border px-3 py-1.5">{x.pin ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
                <button onClick={()=>editCard(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
                <button onClick={()=>removeCard(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

function PointsPanel({ data, admin, setData }) {
  const people = React.useMemo(() => data.shop?.people || [], [data.shop]);
  const logs   = React.useMemo(() => data.shop?.logs   || [], [data.shop]); // {id, personId, delta, note, at}
  const [q, setQ] = useState("");
  const [draft, setDraft] = useState({ name: "", points: "" });

  // æŠŠã€Œé¸æ“‡äººå“¡ã€æ”¹æˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼šç”¨ datalist
  const [logDraft, setLogDraft] = useState({ name:"", delta:"", note:"" });

  const norm = (s="") => s.trim().toLowerCase();

  const result = React.useMemo(() => {
    if (!q.trim()) return null;
    const key = norm(q);
    const exact = people.find(p => norm(p.name) === key);
    if (exact) return exact;
    const fuzzy = people.find(p => norm(p.name).includes(key));
    return fuzzy || null;
  }, [q, people]);

const personIdFilter = React.useMemo(() => result?.id || null, [result]);

  const addOrUpdate = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const raw = draft.name || "";
    const name = raw.replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if (!name) return alert("è«‹è¼¸å…¥å§“å/æš±ç¨±");
    const pts = Number(draft.points || 0);
    if (!Number.isFinite(pts)) return alert("é»æ•¸éœ€ç‚ºæ•¸å­—");

    const key = normName(name);
    const exists = people.find(p => normName(p.name) === key);

    const summary = exists
      ? `å·²å­˜åœ¨ã€Œ${exists.name}ã€ï¼Œç›®å‰é»æ•¸ï¼š${exists.points}\nè¦å°‡é»æ•¸æ”¹ç‚ºï¼š${pts} å—ï¼Ÿ`
      : `ç¢ºèªæ–°å¢äººå“¡ï¼š${name}\né»æ•¸ï¼š${pts}`;
    if (!confirm(summary)) return;

    let nextPeople;
    if (exists) {
      nextPeople = people.map(p => normName(p.name) === key ? { ...p, name, points: pts } : p);
    } else {
      nextPeople = [{ id: nid(), name, points: pts }, ...people];
    }
    setData({ ...data, shop: { ...data.shop, people: nextPeople } });
    setDraft({ name: "", points: "" });
  };

  const adjust = (id, delta) => {
    if (!admin) return;
    const next = people.map(p => p.id === id ? { ...p, points: Math.max(0, Number(p.points||0) + delta) } : p);
    const log = { id: nid(), personId:id, delta, note: delta>0?'+èª¿æ•´':'-èª¿æ•´', at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: next, logs: [log, ...logs] } });
  };

  // âœ… åˆªé™¤äººå“¡ï¼šé—œéµå­—ç¢ºèªï¼Œä¸”ä¸å†ä¸Ÿå›æ”¶ç«™
  const removePerson = (id) => {
    if (!admin) return;
    const p = people.find(x=>x.id===id); if(!p) return;
    if(!confirmKeyword({label: `æ¬²åˆªé™¤ï¼š${p.name}`, keyword:'åˆªé™¤'})) return;
    const nextShop = {
      ...data.shop,
      people: people.filter(x=>x.id!==id),
      logs   : logs // äººå“¡åˆªé™¤ä¸å‹•æ­·å²æµæ°´
    };
    setData({ ...data, shop: nextShop });
  };

  // âœ… æ–°å¢ç•°å‹•ï¼šç”¨åå­—æ‰¾äººï¼›ä¸å­˜åœ¨å°±è‡ªå‹•å»ºç«‹
  const addLog = () => {
    if(!admin) return;
    const rawName = (logDraft.name||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if(!rawName) return alert('è«‹è¼¸å…¥äººå“¡å§“å/æš±ç¨±');
    const delta = Number(logDraft.delta||0);
    if(!Number.isFinite(delta) || delta===0) return alert('è«‹è¼¸å…¥é 0 çš„æ•´æ•¸ç•°å‹•');

    // å…ˆæ‰¾ç¾æœ‰äººå“¡
    const key = normName(rawName);
    let person = people.find(x => normName(x.name) === key);

    let nextPeople = [...people];
    if (!person) {
      // è‡ªå‹•å»ºç«‹æ–°çš„äººå“¡ï¼ˆ0 é»ï¼‰
      person = { id: nid(), name: rawName, points: 0 };
      nextPeople = [person, ...people];
    }

    // å¯«å…¥é»æ•¸èˆ‡æµæ°´
    nextPeople = nextPeople.map(x => x.id===person.id ? { ...x, points: Math.max(0, Number(x.points||0) + delta) } : x);
    const log = { id: nid(), personId: person.id, delta, note: logDraft.note||'', at: nowISO() };

    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [log, ...logs] } });

setQ(rawName);

    setLogDraft({ name:"", delta:"", note:"" });
  };

  const revokeLog = (logId) => {
    if(!admin) return;
    const lg = logs.find(l=>l.id===logId); if(!lg) return;
    if(!confirm('è¦æ’¤éŠ·é€™ç­†ç•°å‹•å—ï¼Ÿæœƒå¯«å…¥ä¸€ç­†ç›¸åæ•¸çš„è£œè¨˜ã€‚')) return;
    const pid = lg.personId; const delta = -lg.delta;
    const nextPeople = people.map(x=> x.id===pid ? { ...x, points: Math.max(0, Number(x.points||0)+delta) } : x);
    const newLog = { id: nid(), personId: pid, delta, note: `æ’¤éŠ· ${logId}`, at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [newLog, ...logs] } });
  };

  const sorted  = React.useMemo(()=> [...people].sort((a,b)=> a.name.localeCompare(b.name, "zh-Hant")), [people]);
  // ä¾ç›®å‰æŸ¥è©¢åˆ°çš„äººï¼ˆresultï¼‰ä¾†éæ¿¾å…¶å€‹äººæµæ°´ï¼Œä¸¦åªå– 5 ç­†
const latest5 = React.useMemo(() => {
  const filtered = personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
  return filtered.slice(0,5);
}, [logs, personIdFilter]);

const visibleLogs = React.useMemo(()=>{
  return personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
}, [logs, personIdFilter]);


  return (
    <Section title="ğŸ” æŸ¥è©¢é»æ•¸" subtitle="å…¬é–‹æœ€å¤šé¡¯ç¤ºæœ€è¿‘ 5 ç­†ç•°å‹•ï¼›ç®¡ç†å¯çœ‹å…¨éƒ¨ã€åŠ ä¸€ç­†/æ’¤éŠ·ã€å¯åŒ¯å‡ºã€‚">
      <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
        <input className="rounded-lg border px-3 py-2" value={q} onChange={(e)=>setQ(e.target.value)} placeholder="è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢"/>
        <div className="text-sm">
          {q.trim()
            ? (result
                ? <span>ã€Œ<b>{result.name}</b>ã€ç›®å‰é»æ•¸ï¼š<b>{result.points}</b></span>
                : <span>æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</span>)
            : <span className="text-slate-500">è«‹è¼¸å…¥è¦æŸ¥è©¢çš„å§“å/æš±ç¨±</span>}
        </div>
      </div>

      {/* å…¬é–‹æµæ°´ï¼šåƒ…é¡¯ç¤ºæŸ¥è©¢åˆ°çš„æ­¤äººæœ€è¿‘ 5 ç­† */}
<div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 mt-3">
  <div className="text-sm font-medium mb-2">æœ€è¿‘ 5 ç­†é»æ•¸ç•°å‹•ï¼ˆåƒ…æ­¤äººï¼‰</div>

  {!q.trim() ? (
    <div className="text-sm text-slate-500">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢</div>
  ) : !result ? (
    <div className="text-sm text-slate-500">æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</div>
  ) : latest5.length === 0 ? (
    <div className="text-sm text-slate-500">ã€Œ{result.name}ã€ç›®å‰æ²’æœ‰ç•°å‹•ç´€éŒ„</div>
  ) : (
    <div className="grid gap-2">
      {latest5.map(l=>{
        const p = people.find(x=>x.id===l.personId);
        return (
          <div key={l.id} className="text-sm flex items-center justify-between">
            <div className="truncate">{p?.name || '(å·²åˆª)'}ï½œ{l.delta>0?`+${l.delta}`:l.delta}ï½œ{l.note||'ï¼ˆç„¡å‚™è¨»ï¼‰'}</div>
            <div className="text-xs text-slate-500">{l.at}</div>
          </div>
        );
      })}
    </div>
  )}
</div>


      {admin && (
        <>
          {/* æ–°å¢/æ›´æ–°äººå“¡ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="grid sm:grid-cols-2 gap-3">
              <input className="rounded-lg border px-3 py-2" value={draft.name} onChange={(e)=>setDraft(d=>({ ...d, name: e.target.value }))} placeholder="å§“å/æš±ç¨±"/>
              <input className="rounded-lg border px-3 py-2" value={draft.points} onChange={(e)=>setDraft(d=>({ ...d, points: e.target.value }))} placeholder="é»æ•¸ï¼ˆæ•´æ•¸ï¼‰"/>
            </div>
            <div className="flex justify-end">
              <button onClick={addOrUpdate} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢/æ›´æ–°</button>
            </div>
          </div>

          {/* ç®¡ç†ï¼šå…¨éƒ¨æµæ°´è¡¨ã€åŠ ä¸€ç­† / æ’¤éŠ· / åŒ¯å‡º */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="flex items-center justify-between">
              <div className="text-sm font-medium">å…¨éƒ¨ç•°å‹•</div>
              <div className="flex items-center gap-2">
  {q.trim() && (
    <button
      className="rounded-lg border px-3 py-1.5 text-sm"
      onClick={()=>setQ("")}
      title="æ¸…é™¤äººå“¡éæ¿¾"
    >
      æ¸…é™¤éæ¿¾
    </button>
  )}
  <button
    className="rounded-lg border px-3 py-1.5 text-sm"
    onClick={()=>{
      const rows = [['at','person','delta','note']];
      const list = personIdFilter ? logs.filter(l=>l.personId===personIdFilter) : logs;
      list.forEach(l=>{
        const p = people.find(x=>x.id===l.personId);
        rows.push([l.at, p?.name||'(å·²åˆª)', l.delta, l.note||'']);
      });
      exportCSV('points_logs.csv', rows);
    }}
  >
    åŒ¯å‡º CSV
  </button>
</div>

            </div>

            {/* âœ… æ–°å¢ä¸€ç­†ç•°å‹•ï¼šå¯è¼¸å…¥æˆ–ä¸‹æ‹‰é¸æ“‡ */}
            <div className="grid sm:grid-cols-3 gap-2">
              <div className="sm:col-span-1">
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  list="people-list"
                  placeholder="äººå“¡ï¼ˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼‰"
                  value={logDraft.name}
                  onChange={e=>setLogDraft(d=>({...d, name:e.target.value}))}
                />
                <datalist id="people-list">
                  {people.map(p => <option key={p.id} value={p.name} />)}
                </datalist>
              </div>
              <input className="rounded-lg border px-3 py-2" placeholder="ç•°å‹•ï¼ˆæ•´æ•¸ï¼Œå¯è² ï¼‰" value={logDraft.delta} onChange={e=>setLogDraft(d=>({...d,delta:e.target.value}))}/>
              <input className="rounded-lg border px-3 py-2 sm:col-span-1" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰" value={logDraft.note} onChange={e=>setLogDraft(d=>({...d,note:e.target.value}))}/>
              <div className="sm:col-span-3 flex justify-end">
                <button onClick={addLog} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢ç•°å‹•</button>
              </div>
            </div>

            {/* è¡¨æ ¼ */}
            <div className="rounded-xl border overflow-hidden">
              <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
                <div className="col-span-3">æ™‚é–“</div>
                <div className="col-span-3">äººå“¡</div>
                <div className="col-span-2">ç•°å‹•</div>
                <div className="col-span-3">å‚™è¨»</div>
                <div className="col-span-1 text-right">æ“ä½œ</div>
              </div>
              {logs.length===0 && <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡ç•°å‹•</div>}
              {visibleLogs.map(l=>{

                const p = people.find(x=>x.id===l.personId);
                return (
                  <div key={l.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                    <div className="col-span-3 text-xs">{l.at}</div>
                    <div className="col-span-3">
  {p
    ? <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">{p.name}</button>
    : '(å·²åˆª)'}
</div>

                    <div className="col-span-2">{l.delta>0?`+${l.delta}`:l.delta}</div>
                    <div className="col-span-3 truncate">{l.note||''}</div>
                    <div className="col-span-1 flex justify-end">
                      <button onClick={()=>revokeLog(l.id)} className="rounded-lg border px-2 py-1 text-xs">æ’¤éŠ·</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* äººå“¡åˆ—è¡¨ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mt-3">
            <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
              <div className="col-span-6">å§“å/æš±ç¨±</div>
              <div className="col-span-3">é»æ•¸</div>
              <div className="col-span-3 text-right">æ“ä½œ</div>
            </div>
            {sorted.length === 0 && (
              <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡äººå“¡é»æ•¸è³‡æ–™</div>
            )}
            {sorted.map(p => (
              <div key={p.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                <div className="col-span-6">
  <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">
    {p.name}
  </button>
</div>

                <div className="col-span-3">{p.points}</div>
                <div className="col-span-3 flex justify-end gap-2">
                  <button onClick={()=>adjust(p.id, +1)} className="rounded-lg border px-3 py-1.5">+1</button>
                  <button onClick={()=>adjust(p.id, -1)} className="rounded-lg border px-3 py-1.5">-1</button>
                  <button onClick={()=>removePerson(p.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
                </div>
              </div>
            ))}
          </div>
        </>
      )}
    </Section>
  );
}

function SettingsPanel({ data, setData, bg, setBg }) {
  const DEFAULTS = DEFAULT_SETTINGS;
  const s = (data && data.settings) ? data.settings : DEFAULTS;

  // è¡¨å–®æš«å­˜ï¼ˆæŠ½çåƒæ•¸ + è¯çµ¡ç®¡ç†å“¡é€£çµï¼‰
  const [draft, setDraft] = React.useState({
    drawMaxPerRun:       s.drawMaxPerRun       ?? DEFAULTS.drawMaxPerRun,
    drawPublicShowLimit: s.drawPublicShowLimit ?? DEFAULTS.drawPublicShowLimit,
    drawCooldownSec:     s.drawCooldownSec     ?? DEFAULTS.drawCooldownSec,
    contactUrl:          s.contactUrl          ?? ""
  });

  // è®“å½ˆçª—å¯ç›´æ¥è®€åˆ°å…¨åŸŸè¯çµ¡é€£çµï¼ˆå•†å“æœªè¦†å¯«æ™‚ä½¿ç”¨ï¼‰
  React.useEffect(() => {
    window.__CONTACT_URL__ = draft.contactUrl || s.contactUrl || "";
  }, [draft.contactUrl, s.contactUrl]);

  const onNum  = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));
  const onText = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));

  const saveSettings = () => {
    const a = Math.max(1, parseInt(draft.drawMaxPerRun, 10)       || DEFAULTS.drawMaxPerRun);
    const b = Math.max(1, parseInt(draft.drawPublicShowLimit, 10) || DEFAULTS.drawPublicShowLimit);
    const c = Math.max(0, parseInt(draft.drawCooldownSec, 10)     || DEFAULTS.drawCooldownSec);
    const contact = String(draft.contactUrl || "").trim();

    const nextSettings = {
      drawMaxPerRun: a,
      drawPublicShowLimit: b,
      drawCooldownSec: c,
      contactUrl: contact
    };

    setData(prev => {
      const prevObj = (prev && typeof prev === "object") ? prev : {};
      return { ...prevObj, settings: nextSettings };
    });
    window.__CONTACT_URL__ = contact;
    alert("å·²æ›´æ–°ç³»çµ±è¨­å®š");
  };

  const HasImageInput = (typeof ImageInput === "function");

  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­ç½®" subtitle="æŠ½çåƒæ•¸ + è¯çµ¡ç®¡ç†å“¡é€£çµ + èƒŒæ™¯ç®¡ç†ï¼ˆä¸»ç•«é¢/æ¼¢å ¡é¸å–®ï¼‰">
      {/* æŠ½çæ¨¡æ“¬å™¨åƒæ•¸ */}
      <div className="grid sm:grid-cols-3 gap-3">
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æŠ½çå–®æ¬¡åé¡ä¸Šé™</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawMaxPerRun} onChange={onNum("drawMaxPerRun")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">å…¬é–‹çµæœé¡¯ç¤ºç­†æ•¸ä¸Šé™</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawPublicShowLimit} onChange={onNum("drawPublicShowLimit")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æ¨¡æ“¬é‡è·‘å†·å»ï¼ˆç§’ï¼‰</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="0"
            value={draft.drawCooldownSec} onChange={onNum("drawCooldownSec")} />
        </div>
      </div>

      {/* è¯çµ¡ç®¡ç†å“¡ï¼ˆå…¨åŸŸå¤–éƒ¨é€£çµï¼‰ */}
      <div className="mt-4 grid gap-1">
        <label className="text-sm text-slate-500">è¯çµ¡ç®¡ç†å“¡Â·å¤–éƒ¨é€£çµï¼ˆå¯ç©ºï¼‰</label>
        <input
          className="rounded-lg border px-3 py-2 w-full"
          placeholder="https://..."
          value={draft.contactUrl}
          onChange={onText("contactUrl")}
        />
        <div className="text-xs text-slate-500">å•†å“æœªè‡ªè¨‚æ™‚ï¼Œå½ˆçª—çš„ã€Œè¯çµ¡ç®¡ç†å“¡ã€æŒ‰éˆ•å°‡ä½¿ç”¨æ­¤é€£çµã€‚</div>
      </div>

      {/* èƒŒæ™¯ç®¡ç†ï¼ˆä¸»ç•«é¢ / æ¼¢å ¡é¸å–®ï¼‰ */}
      <div className="mt-6 grid md:grid-cols-2 gap-6">
        {/* ä¸»ç•«é¢èƒŒæ™¯ */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">ğŸ¨ ä¸»ç•«é¢èƒŒæ™¯</div>

          {HasImageInput ? (
            <ImageInput
              label="èƒŒæ™¯åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰"
              value={bg.url || ""}
              onChange={(url) => setBg({ ...bg, url })}
            />
          ) : (
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">èƒŒæ™¯åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
              <input
                className="rounded-lg border px-3 py-2 w-full"
                placeholder="https://..."
                value={bg.url || ""}
                onChange={e=>setBg({ ...bg, url: e.target.value })}
              />
            </div>
          )}

          <div className="grid sm:grid-cols-2 gap-3 mt-3">
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">äº®åº¦ {bg.brightness ?? 1}</label>
              <input type="range" min="0.2" max="2" step="0.05"
                value={bg.brightness ?? 1}
                onChange={e=>setBg({ ...bg, brightness: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">éœ§åŒ–ï¼ˆpxï¼‰ {bg.blur ?? 0}</label>
              <input type="range" min="0" max="16" step="1"
                value={bg.blur ?? 0}
                onChange={e=>setBg({ ...bg, blur: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">é€æ˜åº¦ {bg.opacity ?? 1}</label>
              <input type="range" min="0" max="1" step="0.05"
                value={bg.opacity ?? 1}
                onChange={e=>setBg({ ...bg, opacity: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">ä½ç½®</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.pos || "center"}
                onChange={e=>setBg({ ...bg, pos: e.target.value })}
              >
                <option value="center">center</option>
                <option value="top">top</option>
                <option value="bottom">bottom</option>
                <option value="left">left</option>
                <option value="right">right</option>
                <option value="top left">top left</option>
                <option value="top right">top right</option>
                <option value="bottom left">bottom left</option>
                <option value="bottom right">bottom right</option>
              </select>
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">å°ºå¯¸</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.size || "cover"}
                onChange={e=>setBg({ ...bg, size: e.target.value })}
              >
                <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div className="mt-2">
            <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼‰</label>
            <input
              className="rounded-lg border px-3 py-2 w-full"
              placeholder="ä¾‹å¦‚ï¼šrgba(0,0,0,0.25)"
              value={bg.tint || ""}
              onChange={e=>setBg({ ...bg, tint: e.target.value })}
            />
          </div>
        </div>

        {/* æ¼¢å ¡é¸å–®èƒŒæ™¯ */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">ğŸ“‚ æ¼¢å ¡é¸å–®èƒŒæ™¯</div>

          <label className="inline-flex items-center gap-2 text-sm">
            <input type="checkbox"
              checked={!!bg.menuUseMain}
              onChange={e=>setBg({ ...bg, menuUseMain: e.target.checked })}
            />
            <span>æ²¿ç”¨ä¸»ç•«é¢è¨­å®š</span>
          </label>

          {!bg.menuUseMain && (
            <>
              {HasImageInput ? (
                <ImageInput
                  label="é¸å–®èƒŒæ™¯åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰"
                  value={bg.menuUrl || ""}
                  onChange={(url) => setBg({ ...bg, menuUrl: url })}
                />
              ) : (
                <div className="grid gap-1 mt-2">
                  <label className="text-sm text-slate-500">é¸å–®èƒŒæ™¯åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
                  <input
                    className="rounded-lg border px-3 py-2 w-full"
                    placeholder="https://..."
                    value={bg.menuUrl || ""}
                    onChange={e=>setBg({ ...bg, menuUrl: e.target.value })}
                  />
                </div>
              )}

              <div className="grid sm:grid-cols-2 gap-3 mt-3">
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">äº®åº¦ {bg.menuBrightness ?? 1}</label>
                  <input type="range" min="0.2" max="2" step="0.05"
                    value={bg.menuBrightness ?? 1}
                    onChange={e=>setBg({ ...bg, menuBrightness: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">éœ§åŒ–ï¼ˆpxï¼‰ {bg.menuBlur ?? 0}</label>
                  <input type="range" min="0" max="16" step="1"
                    value={bg.menuBlur ?? 0}
                    onChange={e=>setBg({ ...bg, menuBlur: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">é€æ˜åº¦ {bg.menuOpacity ?? 1}</label>
                  <input type="range" min="0" max="1" step="0.05"
                    value={bg.menuOpacity ?? 1}
                    onChange={e=>setBg({ ...bg, menuOpacity: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">ä½ç½®</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuPos || "center"}
                    onChange={e=>setBg({ ...bg, menuPos: e.target.value })}
                  >
                    <option value="center">center</option>
                    <option value="top">top</option>
                    <option value="bottom">bottom</option>
                    <option value="left">left</option>
                    <option value="right">right</option>
                    <option value="top left">top left</option>
                    <option value="top right">top right</option>
                    <option value="bottom left">bottom left</option>
                    <option value="bottom right">bottom right</option>
                  </select>
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">å°ºå¯¸</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuSize || "cover"}
                    onChange={e=>setBg({ ...bg, menuSize: e.target.value })}
                  >
                    <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                    <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                    <option value="auto">auto</option>
                  </select>
                </div>
              </div>

              <div className="mt-2">
                <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼‰</label>
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  placeholder="ä¾‹å¦‚ï¼šrgba(0,0,0,0.25)"
                  value={bg.menuTint || ""}
                  onChange={e=>setBg({ ...bg, menuTint: e.target.value })}
                />
              </div>
            </>
          )}
        </div>
      </div>

      {/* å¿«é€Ÿé¢¨æ ¼ï¼ˆå¯é¸ï¼‰ */}
      <div className="mt-6 flex flex-wrap gap-2">
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.20)", brightness:1.0, blur:2, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…çˆ½</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.35)", brightness:0.95, blur:6, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æŸ”éœ§</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(0,0,0,0.35)", brightness:1.1, blur:0, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æš—åº•</button>

        <button
          onClick={()=>setBg({
            url:"", tint:"rgba(255,255,255,0.0)", brightness:1, blur:0, opacity:1,
            size:"cover", pos:"center",
            menuUseMain:true, menuUrl:"", menuTint:"rgba(255,255,255,0.0)",
            menuBrightness:1, menuBlur:0, menuOpacity:1, menuSize:"cover", menuPos:"center"
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…é™¤èƒŒæ™¯</button>
      </div>

      {/* å„²å­˜ï¼ˆåªå¯«æŠ½çåƒæ•¸èˆ‡è¯çµ¡é€£çµï¼›èƒŒæ™¯é€é setBg å³æ™‚ç”Ÿæ•ˆ/å¦æœ‰æœ¬åœ°å„²å­˜ï¼‰ */}
      <div className="mt-6 flex justify-end">
        <button onClick={saveSettings} className="rounded-lg bg-brand text-white px-4 py-2">å„²å­˜ç³»çµ±è¨­å®š</button>
      </div>
    </Section>
  );
}

function SystemSettings({ data, setData, bg, setBg, admins, setAdmins, currentAdmin, setCurrentAdmin }) {
  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­ç½®" subtitle="é›†ä¸­ç®¡ç†æ‰€æœ‰è¨­å®šé …ç›®ã€‚">
      {/* ä½ åŸæœ¬ä½¿ç”¨çš„ SettingsPanel å®Œæ•´æ¬åˆ°é€™è£¡å‘ˆç¾ */}
      <SettingsPanel data={data} setData={setData} bg={bg} setBg={setBg} />

{/* === ç®¡ç†è€…æ¸…å–®ï¼ˆæœ¬åœ°ï¼‰=== */}
<Section id="admin-list-panel" title="ğŸ‘¤ ç®¡ç†è€…æ¸…å–®" subtitle="æ–°å¢ï¼åˆªé™¤ï¼æ”¹åï¼æ”¹å¯†ç¢¼ï¼ˆè³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿï¼‰ã€‚">
  <div className="grid gap-3">
    {/* åˆ—è¡¨ */}
    <div className="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 dark:bg-slate-800/50">
          <tr>
            <th className="text-left px-3 py-2">åç¨±</th>
            <th className="text-left px-3 py-2">å¯†ç¢¼ç‹€æ…‹</th>
            <th className="text-right px-3 py-2">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {admins.map((a, idx)=>(
            <tr key={idx} className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-2">{a.name}</td>
              <td className="px-3 py-2">{a.passwordHash ? 'å·²è¨­å®š' : 'å°šæœªè¨­å®š'}</td>
              <td className="px-3 py-2">
                <div className="flex justify-end gap-2">
                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const newName = prompt('è¼¸å…¥æ–°åç¨±', a.name) || '';
                      const trimmed = newName.trim();
                      if(!trimmed){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
                      if(trimmed !== a.name && admins.some(x=>x.name === trimmed)){
                        alert('åç¨±å·²å­˜åœ¨'); return;
                      }
                      const next = admins.map(x => x.name === a.name ? ({ ...x, name: trimmed }) : x);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(trimmed); }
                      alert('åç¨±å·²æ›´æ–°');
                    }}
                  >æ”¹å</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const pwd = prompt('è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
                      if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
                      const hash = await hashTextSHA256(pwd);
                      const next = admins.map(x => x.name === a.name ? ({ ...x, passwordHash: hash }) : x);
                      setAdmins(next);
                      alert('å¯†ç¢¼å·²æ›´æ–°');
                    }}
                  >æ”¹å¯†ç¢¼</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={()=>{
                      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ç®¡ç†è€…ã€Œ${a.name}ã€ï¼Ÿ`)) return;
                      const next = admins.filter(x => x.name !== a.name);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(''); setAdminMode(false); }
                      alert('å·²åˆªé™¤');
                    }}
                  >åˆªé™¤</button>
                </div>
              </td>
            </tr>
          ))}
          {admins.length === 0 && (
            <tr className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-6 text-center text-slate-500" colSpan={3}>ç›®å‰æ²’æœ‰ç®¡ç†è€…</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    {/* æ–°å¢ */}
    <div className="flex gap-2">
      <button
        className="rounded-lg border px-3 py-1.5"
        onClick={async ()=>{
          const name = prompt('è¼¸å…¥æ–°ç®¡ç†è€…åç¨±') || '';
          const n = name.trim();
          if(!n){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
          if(admins.some(a => a.name === n)){ alert('åç¨±å·²å­˜åœ¨'); return; }
          const pwd = prompt('è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
          if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
          const hash = await hashTextSHA256(pwd);
          setAdmins([...admins, { name: n, passwordHash: hash }]);
          alert('å·²æ–°å¢ç®¡ç†è€…');
        }}
      >æ–°å¢ç®¡ç†è€…</button>
    </div>
  </div>
</Section>
     
 {/* å¦‚æœªä¾†è¦æ“´å……æ›´å¤šè¨­å®šï¼Œå¯åœ¨æ­¤ç¹¼çºŒåˆ†æ®µ */}
      {/* ä¾‹ï¼šç¶²ç«™è³‡è¨Š / æ¬Šé™ / å‚™ä»½å·¥å…· / ä¸»é¡Œé¢¨æ ¼ ç­‰ */}
    </Section>
  );
}

function ImageInput({ label="åœ–ç‰‡", value="", onChange }) {
  const [mode, setMode] = React.useState(value && /^https?:\/\//i.test(value) ? 'url' : (value ? 'data' : 'url'));
  const fileRef = React.useRef(null);

  const pickFile = ()=> fileRef.current?.click();
  const onFile = async (f)=>{
    if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=> onChange?.(String(e.target?.result||""));
    reader.readAsDataURL(f);
  };

  return (
    <div className="grid gap-1.5">
      <label className="text-sm text-slate-600 dark:text-slate-300">{label}</label>
      <div className="flex items-center gap-2">
        <button
          type="button"
          onClick={()=>setMode('url')}
          className={`px-2 py-1 rounded border text-xs ${mode==='url'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >ç¶²å€</button>
        <button
          type="button"
          onClick={()=>setMode('data')}
          className={`px-2 py-1 rounded border text-xs ${mode==='data'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >æœ¬æ©Ÿæª”æ¡ˆ</button>
      </div>

      {mode==='url' ? (
        <input
          className="rounded-lg border px-3 py-2"
          value={value}
          onChange={e=>onChange?.(e.target.value)}
          placeholder="https://... æˆ–ç›´æ¥è²¼ä¸Šç¶²å€"
        />
      ) : (
        <>
          <div className="flex items-center gap-2">
            <button type="button" onClick={pickFile} className="rounded-lg border px-3 py-2 text-sm">é¸æ“‡æª”æ¡ˆ</button>
            <span className="text-xs text-slate-500">ï¼ˆå°‡è®€ç‚º base64ï¼Œé›¢ç·šä¹Ÿå¯é¡¯ç¤ºï¼‰</span>
          </div>
          <input
            ref={fileRef}
            type="file"
            accept="image/*"
            className="hidden"
            onChange={e=>onFile(e.target.files?.[0]||null)}
          />
        </>
      )}

      {value && (
        <div className="mt-2">
          <img src={value} alt="" className="max-h-40 rounded border bg-slate-50 dark:bg-slate-800 object-contain"/>
        </div>
      )}
    </div>
  );
}

function ShopImageQuickset({ data, setData, admin }) {
  if (!admin) return null; // åªçµ¦ç®¡ç†æ¨¡å¼ç”¨

  // ç›®å‰å•†å“æ¸…å–®
  const items = Array.isArray(data?.shop?.items) ? data.shop.items : [];

  // â€”â€” ç›¸å®¹ï¼šæŠŠèˆŠçš„å–®å¼µ image è½‰ç‚º images é™£åˆ—ï¼ˆä¸è¦†è“‹åŸæ¬„ä½ï¼Œåªè£œä¸Šï¼‰â€”â€”
  const ensureImagesArr = (it) => {
    const nx = { ...it };
    if (!Array.isArray(nx.images)) {
      const one = String(nx.image || "").trim();
      nx.images = one ? [one] : [];
    }
    return nx;
  };

  // è‰ç¨¿ï¼šä»¥ image æ¬„ä½ç‚ºæº–ï¼ˆä½ åŸæœ¬çš„è¡Œç‚ºä¿ç•™ï¼‰
  const [drafts, setDrafts] = React.useState(() =>
    items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    }))
  );

  // è‹¥å¤–éƒ¨ items æ”¹è®Šï¼Œè‰ç¨¿åŒæ­¥ä¸€æ¬¡ï¼ˆä½ åŸæœ¬çš„è¡Œç‚ºä¿ç•™ï¼‰
  React.useEffect(() => {
    setDrafts(items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    })));
  }, [items]);

  // æ­£è¦åŒ–ï¼šå»é ­å°¾å¼•è™Ÿèˆ‡ç©ºç™½ï¼ˆåªæä¾›çµ¦ã€Œæª”åè‡ªå‹•è£œè³‡æ–™å¤¾ã€æŒ‰éˆ•ç”¨ï¼›saveAll ä¸ç”¨å®ƒï¼‰
  const normPath = (s) => String(s || '').trim().replace(/^"+|"+$/g, '');

  // å„²å­˜ï¼šæŠŠè‰ç¨¿å¯«å› data.shop.items[i].imageï¼ˆâ˜… åŸæ¨£ä¿å­˜ï¼Œä¸åŠ å·¥ï¼‰
  const saveAll = () => {
    const next = items.map((it, i) => {
      const image = drafts[i]?.image ?? '';   // ä¸åšä»»ä½•è™•ç†ï¼ŒåŸæ¨£å­—ä¸²
      return { ...it, image };                // â† ä¿®æ­£ ...it
    });
    setData({
      ...data,                                // â† ä¿®æ­£ ...data
      shop: { ...(data.shop || {}), items: next }  // â† ä¿®æ­£ ...(data.shop || {})
    });
    alert('å·²å„²å­˜åœ–ç‰‡è·¯å¾‘åˆ°å•†å“ã€‚ä¹‹å¾Œã€ŒåŒ¯å‡ºã€å³å¯æŠŠè·¯å¾‘å¸¶å‡ºã€‚');
  };

  // è‹¥åªè²¼ã€Œæª”å.jpgã€æ²’æœ‰è³‡æ–™å¤¾ï¼Œè‡ªå‹•è£œ ./assets/products/ï¼ˆâ˜… åƒ…åœ¨ä½ æŒ‰é€™é¡†éˆ•æ™‚æ‰æœƒè®Šå‹•ï¼‰
  const applyBaseToEmpty = () => {
    const base = './assets/products/';
    setDrafts(ds => ds.map(d => {
      const v = normPath(d.image);
      if (!v) return d;
      if (!v.includes('/')) return { ...d, image: base + v }; // â† ä¿®æ­£ ...d
      return d;
    }));
  };

  // ====== ä»¥ä¸‹æ˜¯ã€Œå¤šåœ–ç®¡ç†ã€æ–°å¢åŠŸèƒ½ï¼ˆä¸å½±éŸ¿ä¸Šé¢æ—¢æœ‰æµç¨‹ï¼‰ ======

  // å–®å¼µæ–°å¢åˆ° images[]
  const addOneImage = (id, url) => {
    const u = String(url || "").trim();
    if (!u) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      if (!nx.images.includes(u)) {
        nx.images = [...nx.images, u];
        if (!nx.image) nx.image = u;          // æ²’å°é¢æ™‚è£œä¸Š
      }
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // å¤šå¼µæ‰¹é‡ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰
  const addMultiImages = (id, text) => {
    const lines = String(text || "")
      .split(/\r?\n/)
      .map((s) => s.trim())
      .filter(Boolean);
    if (lines.length === 0) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const set = new Set(nx.images);
      for (const l of lines) set.add(l);
      nx.images = Array.from(set);
      if (!nx.image && nx.images.length > 0) nx.image = nx.images[0]; // æ²’å°é¢â†’ç¬¬ä¸€å¼µ
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // åˆªé™¤æŸå¼µåœ–ç‰‡ï¼ˆä¸¦å›é€€å°é¢ç‚ºæ–°ç¬¬ä¸€å¼µï¼‰
  const removeImageAt = (id, idx) => {
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const arr = [...nx.images];
      if (idx < 0 || idx >= arr.length) return it;
      arr.splice(idx, 1);
      nx.images = arr;
      nx.image = arr[0] || ""; // å°é¢å›é€€
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  return (
    <section
      className="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4"
      aria-label="å•†å“åœ–ç‰‡è·¯å¾‘å¿«é€Ÿè¨­å®šï¼‹å¤šåœ–ç®¡ç†"
    >
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-base font-semibold">ğŸ–¼ï¸ å•†å“åœ–ç‰‡ç®¡ç†ï¼ˆä¿ç•™èˆŠåŠŸèƒ½ï¼‹æ–°å¢å¤šåœ–ï¼‰</h3>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={applyBaseToEmpty}
            className="rounded-lg border px-3 py-1.5 text-sm"
            title="è‹¥è¼¸å…¥åƒ…æª”åï¼Œå¹«ä½ è‡ªå‹•åŠ ä¸Š ./assets/products/"
          >
            æª”åè‡ªå‹•è£œè³‡æ–™å¤¾
          </button>
          <button
            type="button"
            onClick={saveAll}
            className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm"
            title="æŠŠè¼¸å…¥çš„è·¯å¾‘å¯«å› data.shop.items"
          >
            å„²å­˜å…¨éƒ¨ï¼ˆå°é¢ imageï¼‰
          </button>
        </div>
      </div>

      {items.length === 0 ? (
        <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å•†å“å¯è¨­å®šåœ–ç‰‡ã€‚</div>
      ) : (
        <div className="grid gap-4">
          {items.map((raw, i) => {
            const it = ensureImagesArr({ ...raw });
            const d  = drafts[i] || { id: it.id, name: it.name || '', image: it.image || '' };
            return (
              <div key={it.id || i} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3">
                {/* æ¨™é¡Œåˆ— */}
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm">
                    <div className="font-medium truncate">{it.name || 'ï¼ˆæœªå‘½åï¼‰'}</div>
                    {it.id && <div className="text-xs text-slate-500">IDï¼š{it.id}</div>}
                  </div>
                  <div className="text-xs text-slate-500">{(it.images || []).length} å¼µ</div>
                </div>

                {/* ä½ åŸæœ¬çš„ï¼šå–®ä¸€å°é¢ image è¼¸å…¥ï¼ˆä¿ç•™ï¼‰ */}
                <div className="grid sm:grid-cols-2 gap-2 items-center mb-3">
                  <label className="text-xs text-slate-500 sm:col-span-1">å°é¢ imageï¼ˆå–®ä¸€å­—ä¸²ï¼‰</label>
                  <input
                    className="rounded-lg border px-3 py-2 text-sm sm:col-span-1"
                    placeholder="è²¼ä¸Šå°é¢åœ–ç‰‡è·¯å¾‘æˆ–å®Œæ•´ç¶²å€"
                    value={d.image}
                    onChange={e => {
                      const v = e.target.value;
                      setDrafts(ds => ds.map((x, j) => (j === i ? { ...x, image: v } : x)));
                    }}
                  />
                </div>

                {/* æ–°å¢ï¼šå¤šåœ–ç¸®åœ–æ¸…å–®ï¼ˆç®¡ç†å¯åˆªå–®å¼µï¼‰ */}
                <div>
                  <div className="text-xs text-slate-500 mb-1">æ›´å¤šåœ–ç‰‡ï¼ˆimages[]ï¼‰</div>
                  <div className="no-scrollbar overflow-x-auto flex gap-2 mb-2">
                    {(it.images || []).length === 0 ? (
                      <div className="text-xs text-slate-500">å°šç„¡å…¶ä»–åœ–ç‰‡</div>
                    ) : (
                      it.images.map((src, k) => (
                        <div key={k} className="relative shrink-0">
                          <img
                            src={src}
                            alt={`åœ–${k + 1}`}
                            className="w-28 h-28 object-cover rounded-lg border border-slate-200/70 dark:border-slate-700/70"
                            loading="lazy"
                          />
                          <button
                            className="absolute -top-2 -right-2 bg-rose-600 text-white w-6 h-6 rounded-full text-xs"
                            title="åˆªé™¤æ­¤åœ–"
                            onClick={() => removeImageAt(it.id, k)}
                          >
                            Ã—
                          </button>
                        </div>
                      ))
                    )}
                  </div>

                  {/* å–®å¼µæ–°å¢ */}
                  <div className="flex gap-2 items-center mb-2">
                    <input
                      type="url"
                      placeholder="è²¼ä¸Šå–®å¼µåœ–ç‰‡ç¶²å€..."
                      className="flex-1 rounded-lg border px-3 py-1.5 text-sm bg-white/80 dark:bg-slate-800/70"
                      onKeyDown={(e) => {
                        if (e.key === "Enter") {
                          addOneImage(it.id, e.currentTarget.value);
                          e.currentTarget.value = "";
                        }
                      }}
                    />
                    <button
                      className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={(e) => {
                        const input = e.currentTarget.previousElementSibling;
                        if (input && input.value) {
                          addOneImage(it.id, input.value);
                          input.value = "";
                        }
                      }}
                    >
                      æ–°å¢
                    </button>
                  </div>

                  {/* å¤šå¼µæ‰¹é‡è²¼ä¸Šï¼ˆæ¯è¡Œä¸€å¼µï¼›è²¼ä¸Šå³åŒ¯å…¥ä¸¦æ¸…ç©ºï¼‰ */}
                  <div className="grid gap-2">
                    <label className="text-xs text-slate-500">æ‰¹é‡è²¼ä¸Šï¼ˆæ¯è¡Œä¸€å€‹åœ–ç‰‡ç¶²å€ï¼‰</label>
                    <textarea
                      rows={3}
                      placeholder="https://...1.jpg
https://...2.png"
                      className="rounded-lg border px-3 py-2 text-sm bg-white/80 dark:bg-slate-800/70"
                      onPaste={(e) => {
                        setTimeout(() => {
                          const v = e.currentTarget.value;
                          if (v && v.trim()) {
                            addMultiImages(it.id, v);
                            e.currentTarget.value = "";
                          }
                        }, 0);
                      }}
                    />
                    <div className="text-xs text-slate-500">
                      è²¼ä¸Šå¾Œæœƒè‡ªå‹•åŒ¯å…¥ä¸¦æ¸…ç©ºè¼¸å…¥æ¡†ï¼›é‡è¤‡ç¶²å€æœƒè‡ªå‹•ç•¥éã€‚
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <p className="mt-3 text-xs text-slate-500">
        å°æé†’ï¼šæŠŠåœ–ç‰‡æ”¾é€² <code>assets/products/</code> å¾Œï¼Œå¯ä»¥åªè²¼
        <code> æª”å.jpg</code>ï¼Œå†æŒ‰ã€Œæª”åè‡ªå‹•è£œè³‡æ–™å¤¾ã€ã€‚æˆ–ç›´æ¥è²¼ç›¸å°è·¯å¾‘ <code>./assets/products/æª”å.jpg</code>ï¼Œ
        ä¹Ÿæ”¯æ´å®Œæ•´ç¶²å€ <code>https://...</code>ã€‚<br/>
        å¤šåœ–å€æœƒå³æ™‚æ›´æ–° <code>images[]</code> èˆ‡å°é¢ <code>image</code>ï¼ˆåˆªé™¤æ™‚å°é¢è‡ªå‹•å›é€€ï¼‰ã€‚
      </p>
    </section>
  );
}

// ===== é€šç”¨ç‡ˆç®±ï¼ˆå¿…è¦åŠŸèƒ½ç‰ˆï¼‰ =====
function LightboxRoot() {
  const [open, setOpen] = React.useState(false);
  const [imgs, setImgs] = React.useState([]);
  const [idx, setIdx]   = React.useState(0);
  const originRef = React.useRef(null);

  // å½±åƒå¹³ç§»/ç¸®æ”¾ï¼ˆç°¡ç‰ˆï¼‰
  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);
  const last = React.useRef({ x:0, y:0, p1:null, p2:null, dist:0 });

  // é–‹å•Ÿ APIï¼ˆå…¨åŸŸï¼‰
  React.useEffect(()=>{
    window.__LB__ = {
      openFrom(el){
        // å¾€ä¸Šæ‰¾ data-gallery
        const node = el.closest("[data-gallery]");
        if(!node) return;
        const group = node.getAttribute("data-gallery");
        const all = Array.from(document.querySelectorAll(`[data-zoomable][data-gallery="${group}"]`));
        const sources = all.map(n => n.getAttribute("src"));
        const start = Number(el.getAttribute("data-index") || "0");
        originRef.current = el;
        setImgs(sources);
        setIdx(Math.max(0, Math.min(start, sources.length-1)));
        setScale(1); setTx(0); setTy(0);
        setOpen(true);
      }
    };
  },[]);

  // éµç›¤æ§åˆ¶ï¼ˆESC/å·¦å³éµï¼‰
  React.useEffect(()=>{
    if(!open) return;
    const onKey = (e)=>{
      if(e.key === "Escape"){ e.preventDefault(); close(); }
      else if(e.key === "ArrowLeft"){ setIdx(i=>Math.max(0, i-1)); resetTransform(); }
      else if(e.key === "ArrowRight"){ setIdx(i=>Math.min(imgs.length-1, i+1)); resetTransform(); }
    };
    window.addEventListener("keydown", onKey);
    return ()=>window.removeEventListener("keydown", onKey);
  },[open, imgs.length]);

  function resetTransform(){ setScale(1); setTx(0); setTy(0); }

  function close(){
    setOpen(false);
    // ç„¦é»å›åˆ°åŸåœ–
    setTimeout(()=>{ originRef.current?.focus?.(); }, 0);
  }

  // æ»‘é¼ æ‹–æ›³ / è§¸æ§ç¸®æ”¾
  function onPointerDown(e){
    e.preventDefault();
    e.currentTarget.setPointerCapture(e.pointerId);
    if(last.current.p1 && !last.current.p2) last.current.p2 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    if(!last.current.p1) last.current.p1 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    last.current.x = e.clientX; last.current.y = e.clientY;
    if(last.current.p1 && last.current.p2){
      const dx = last.current.p1.x - last.current.p2.x;
      const dy = last.current.p1.y - last.current.p2.y;
      last.current.dist = Math.hypot(dx, dy) || 1;
    }
  }
  function onPointerMove(e){
    if(!open) return;
    if(last.current.p1 && last.current.p2){
      // é›™æŒ‡ç¸®æ”¾
      const p = (p)=>p?.id===e.pointerId ? { id:e.pointerId, x:e.clientX, y:e.clientY } : p;
      last.current.p1 = p(last.current.p1);
      last.current.p2 = p(last.current.p2);
      const dx = (last.current.p1.x - last.current.p2.x);
      const dy = (last.current.p1.y - last.current.p2.y);
      const d  = Math.hypot(dx, dy) || 1;
      const s  = Math.min(4, Math.max(1, scale * (d / (last.current.dist || d))));
      setScale(s);
      last.current.dist = d;
    }else{
      // å–®æŒ‡/æ»‘é¼ æ‹–æ›³
      const dx = e.clientX - last.current.x;
      const dy = e.clientY - last.current.y;
      setTx(t=>t+dx); setTy(t=>t+dy);
      last.current.x = e.clientX; last.current.y = e.clientY;
    }
  }
  function onPointerUp(e){
    if(last.current.p2?.id===e.pointerId) last.current.p2=null;
    else if(last.current.p1?.id===e.pointerId) last.current.p1=null;
  }
   function onDblClick(){ setScale(s => s>1 ? 1 : 2); setTx(0); setTy(0); }

  if(!open) return null;
  return (
    <div className="fixed inset-0 z-[9999] bg-black/90 backdrop-blur-sm flex flex-col" role="dialog" aria-modal="true">
      <div className="flex items-center justify-between px-3 py-2">
        <div className="text-slate-200 text-sm">{idx+1} / {imgs.length}</div>
        <div className="flex items-center gap-2">
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.max(0,i-1)); resetTransform(); }} disabled={idx<=0}>â†</button>
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.min(imgs.length-1,i+1)); resetTransform(); }} disabled={idx>=imgs.length-1}>â†’</button>
          <button className="rounded-md bg-white text-black px-2 py-1 text-sm" onClick={close}>é—œé–‰</button>
        </div>
      </div>
      <div className="relative flex-1 overflow-hidden touch-pan-y">
        <img
          src={imgs[idx]}
          alt=""
          className="absolute left-1/2 top-1/2 select-none"
          style={{
            transform:`translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`,
            maxWidth:"90vw", maxHeight:"75vh"
          }}
          onPointerDown={onPointerDown}
          onPointerMove={onPointerMove}
          onPointerUp={onPointerUp}
          onPointerCancel={onPointerUp}
          onDoubleClick={onDblClick}
          draggable={false}
        />
      </div>
    </div>
  );
}


    // â€”â€” Render â€”â€”
    // â€”â€” Render â€”â€”
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<><App /><LightboxRoot /></>);

  </script>

<!-- [IMGIO JS START] -->
<script>
(function(){
  // â€”â€” çµ±ä¸€çš„åœ–ç‰‡ç‹€æ…‹ï¼ˆkey -> { src, type, fit, opacity, offsetX, offsetY, scale, rotateDeg }ï¼‰
  // æ³¨æ„ï¼šæˆ‘å€‘ä¸æœƒå‹•ä½ è²¼é€²ä¾†çš„ src å­—ä¸²ï¼ˆçµ•ä¸æ­£è¦åŒ–ã€çµ•ä¸è£œå‰ç¶´ï¼‰ã€‚
  const imageState = new Map();

  // ä»¥ dataset æˆ– DOM è·¯å¾‘å–å¾—ç©©å®š keyï¼ˆæ²’æœ‰ data-img-key ä¹Ÿèƒ½é‹ä½œï¼‰
  function getStableKeyFor(el){
    if(el.dataset && el.dataset.imgKey) return el.dataset.imgKey;
    // ç”Ÿæˆ DOM è·¯å¾‘ï¼ˆé¿å…é‡æ•´å¾Œè®Šå‹•ï¼Œç›¡é‡åŒ…å«åŒå±¤ç´¢å¼•ï¼‰
    const parts=[];
    let node=el;
    while(node && node.nodeType===1 && node.tagName.toLowerCase()!=='html'){
      const tag=node.tagName.toLowerCase();
      const parent=node.parentElement;
      let idx=0;
      if(parent){
        const siblings=[...parent.children].filter(c=>c.tagName===node.tagName);
        idx=siblings.indexOf(node);
      }
      parts.unshift(`${tag}:nth-of-type(${idx+1})`);
      node=parent;
    }
    return parts.join('>');
  }

  // åµæ¸¬å…ƒç´ æ˜¯ <img> é‚„æ˜¯å®¹å™¨èƒŒæ™¯
  function detectType(el){
    return el.tagName && el.tagName.toLowerCase()==='img' ? 'img' : 'bg';
  }

  // å¥—ç”¨ç‹€æ…‹åˆ°å…ƒç´ 
  function applyToElement(el, state){
    const type = detectType(el);
    if(type==='img'){
      if(state.src !== undefined) el.src = state.src; // åŸæ¨£å­—ä¸²
      // å…¶ä»–èª¿æ•´å¯ç”¨ style ä¾†å¥—
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      // img çš„ fit å¯ç”¨ object-fit / object-position
      if(state.fit) el.style.objectFit = state.fit; // 'cover' | 'contain' | 'fill' | 'none' | 'scale-down'
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.objectPosition = `${ox}px ${oy}px`;
      }
    }else{
      // èƒŒæ™¯å®¹å™¨
      if(state.src !== undefined) el.style.backgroundImage = state.src ? `url("${state.src}")` : 'none';
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      if(state.fit){
        // å°èƒŒæ™¯ä½¿ç”¨ background-size
        const map = { cover:'cover', contain:'contain', fill:'100% 100%', none:'auto', 'scale-down':'contain' };
        el.style.backgroundSize = map[state.fit] || state.fit;
      }
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.backgroundPosition = `${ox}px ${oy}px`;
      }
    }
  }

  function buildTransform(state){
    const ops=[];
    if(state.scale!=null && state.scale!==1) ops.push(`scale(${state.scale})`);
    if(state.rotateDeg!=null && state.rotateDeg!==0) ops.push(`rotate(${state.rotateDeg}deg)`);
    if(ops.length===0) return '';
    return ops.join(' ');
  }

  // æƒæé é¢ä¸Šæ‰€æœ‰å¯èƒ½çš„åœ–ç‰‡å…ƒç´ 
  function collectImageElements(){
    const all = new Set();
    // 1) å…·æœ‰ data-img-key çš„å…ƒç´ 
    document.querySelectorAll('[data-img-key]').forEach(el=>all.add(el));
    // 2) æ‰€æœ‰ <img>
    document.querySelectorAll('img').forEach(el=>all.add(el));
    // 3) æ˜ç¢ºå®£å‘Šç‚ºèƒŒæ™¯åœ–å®¹å™¨çš„å…ƒç´ ï¼ˆå¯é¸ï¼‰
    document.querySelectorAll('[data-img-type="bg"]').forEach(el=>all.add(el));
    return [...all];
  }

  // æŠŠå…ƒç´ è¨»å†Šé€²ç‹€æ…‹è¡¨ï¼ˆè‹¥å·²æœ‰å°±ä¸è¦†è“‹ï¼‰
  function ensureStateForElement(el){
    const key = getStableKeyFor(el);
    if(!imageState.has(key)){
      imageState.set(key, {
        src: readCurrentSrc(el),
        type: detectType(el),
        fit: undefined, opacity: undefined, offsetX: 0, offsetY: 0,
        scale: 1, rotateDeg: 0
      });
    }
    return key;
  }

  function readCurrentSrc(el){
    if(detectType(el)==='img'){
      return el.getAttribute('src') || '';
    }else{
      // å¾ style.backgroundImage å– url(...)ï¼ˆè‹¥ç„¡å‰‡ç©ºï¼‰
      const bg = getComputedStyle(el).backgroundImage;
      if(!bg || bg==='none') return '';
      // ç°¡å–®æŠ½å– url("...") å…§å®¹
      const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
      return m ? m[2] : '';
    }
  }

  // å°å–®ä¸€ key è¨­å®šè·¯å¾‘ï¼ˆåŸæ¨£ä¿å­˜ï¼Œä¸æ”¹å­—ä¸²ï¼‰
  function setPath(key, rawPath){
    const state = imageState.get(key) || { };
    state.src = (rawPath==null ? '' : String(rawPath));
    imageState.set(key, state);
    // æŠŠå®ƒå¥—å›å°æ‡‰å…ƒç´ 
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  // å°å–®ä¸€ key èª¿æ•´å±¬æ€§ï¼ˆä¸å½±éŸ¿ srcï¼‰
  function setAdjust(key, patch){
    const state = imageState.get(key) || { };
    Object.assign(state, patch);
    imageState.set(key, state);
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  function findElementByKey(key){
    // å…ˆæ‰¾ data-img-key
    let el = document.querySelector(`[data-img-key="${CSS.escape(key)}"]`);
    if(el) return el;
    // è‹¥ä¸æ˜¯ data-img-keyï¼Œå¯èƒ½æ˜¯è‡ªå‹•ç”¢ç”Ÿçš„ DOM è·¯å¾‘ key
    try{
      el = document.querySelector(key.split('>').map(seg=>{
        // seg å½¢å¦‚ "div:nth-of-type(1)"ï¼Œç›´æ¥ç”¨
        return seg.trim();
      }).join(' > '));
    }catch(e){}
    return el || null;
  }

  // å°‡ç›®å‰ imageState åŒ¯å‡ºç‚º JSONï¼ˆå­—ä¸²ï¼‰
  function exportImagesJSON(){
    // Map -> ç´”ç‰©ä»¶
    const obj = {};
    for(const [k,v] of imageState.entries()){
      obj[k] = {
        src: v.src ?? '',
        type: v.type ?? 'img',
        fit: v.fit ?? undefined,
        opacity: v.opacity ?? undefined,
        offsetX: v.offsetX ?? 0,
        offsetY: v.offsetY ?? 0,
        scale: v.scale ?? 1,
        rotateDeg: v.rotateDeg ?? 0
      };
    }
    return JSON.stringify({ __kind: 'images.v1', data: obj }, null, 2);
  }

  // å¾ JSONï¼ˆå­—ä¸²æˆ–ç‰©ä»¶ï¼‰åŒ¯å…¥ï¼ŒåŸæ¨£é‚„åŸä¸¦ç«‹å³å¥—ç”¨
  function importImagesJSON(json){
    const payload = (typeof json==='string') ? JSON.parse(json) : json;
    if(!payload || payload.__kind!=='images.v1' || !payload.data) return;
    for(const k of Object.keys(payload.data)){
      imageState.set(k, { ...payload.data[k] });
      const el = findElementByKey(k);
      if(el) applyToElement(el, imageState.get(k));
    }
  }

  // ç¶å®šè¼¸å…¥æ¡†ï¼šä»»ä½• input/textarea åªè¦æœ‰ data-img-input="key" å°±æœƒè²¼ä¸Šå³å¥—ç”¨
  function bindInputsLive(){
    document.querySelectorAll('[data-img-input]').forEach(inp=>{
      const keyAttr = inp.getAttribute('data-img-input');
      const elKey = keyAttr && keyAttr.trim() ? keyAttr.trim() : null;
      // è‹¥æ²’å¡« keyï¼Œå˜—è©¦ç”¨æœ€è¿‘çš„ data-img-key å®¹å™¨
      let key = elKey;
      if(!key){
        const host = inp.closest('[data-img-key]');
        if(host) key = getStableKeyFor(host);
      }
      if(!key) return;

      // ç¢ºä¿æœ‰ç‹€æ…‹
      imageState.has(key) || imageState.set(key, {});

      // åˆå§‹åŒ–ï¼šå¦‚æœ input æœ‰å€¼å°±å…ˆå¥—
      if(inp.value && inp.value.trim()){
        setPath(key, inp.value.trim());
      }

      // å³æ™‚ç›£è½ï¼ˆè²¼ä¸Š/è¼¸å…¥/è®Šæ›´ï¼‰
      ['input','change','paste'].forEach(ev=>{
        inp.addEventListener(ev, ()=>{
          setPath(key, inp.value);
        });
      });
    });
  }

  // æ›åœ¨å…¨åŸŸï¼Œæ–¹ä¾¿ä½ å‘¼å«
  window.ImageIO = {
    setPath, setAdjust, exportImagesJSON, importImagesJSON,
    refreshAll(){
      collectImageElements().forEach(el=>{
        const key = ensureStateForElement(el);
        applyToElement(el, imageState.get(key));
      });
    }
  };

  // åˆæ¬¡å•Ÿå‹•ï¼šæ”¶é›†å…ƒç´  â†’ å»ºç‹€æ…‹ â†’ ç¶å®šè¼¸å…¥æ¡† â†’ é¦–æ¬¡å¥—ç”¨
  function boot(){
    const els = collectImageElements();
    els.forEach(el=>{
      const key = ensureStateForElement(el);
      // åˆå§‹å¥—ç”¨ï¼ˆä»¥ DOM ç›®å‰çš„ src / èƒŒæ™¯ç‚ºåŸºæº–ï¼‰
      applyToElement(el, imageState.get(key));
    });
    bindInputsLive();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', boot);
  }else{
    boot();
  }

  // â€”â€” ä¸‹é¢æ˜¯ã€Œç¤ºç¯„ç”¨ã€çš„åŒ¯å‡º/åŒ¯å…¥æŒ‰éˆ•ï¼ˆå¯ä¿ç•™æˆ–æ•´åˆåˆ°ä½ ç¾æœ‰ UIï¼‰ â€”â€” //
  // åŒ¯å‡ºï¼šä¸‹è¼‰ .jsonï¼ˆä¿ç•™åŸå­—ä¸²è·¯å¾‘ï¼‰
  function downloadJSON(filename, content){
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename || 'images.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 0);
  }

  // ä½ å¯ä»¥åœ¨ä»»ä½•äº‹ä»¶ä¸­å‘¼å« window.ImageIO.exportImagesJSON()
  window.addEventListener('click', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-export]')){
      const json = exportImagesJSON();
      downloadJSON('images.json', json);
    }
  });

  // åŒ¯å…¥ï¼šè®€æª”å¾Œç«‹å³é‚„åŸ
  window.addEventListener('change', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-import]') && t.files && t.files[0]){
      const f = t.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        try{
          importImagesJSON(reader.result);
          alert('åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´å·²åŒ¯å…¥ä¸¦å¥—ç”¨å®Œæˆã€‚');
        }catch(err){
          alert('åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ä¸ç¬¦ã€‚');
        }
        t.value = '';
      };
      reader.readAsText(f);
    }
  });
})();
</script>
<!-- [IMGIO JS END] -->

</body>

</html>