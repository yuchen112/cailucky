<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é–‹çæ‰€ï½œå…¬å…±/ç®¡ç†é›™æ¨¡å¼ï¼ˆç©ºè³‡æ–™ç‰ˆï¼‰â€”Part 1</title>
  <meta name="color-scheme" content="light dark">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          brand: { DEFAULT: '#14b8a6', fg: '#0f766e', amber: '#f59e0b' }
        },
        boxShadow: {
          soft: '0 10px 25px -10px rgb(0 0 0 / 0.25)',
          elevate: '0 12px 30px -12px rgba(0,0,0,.35)'
        },
        borderRadius: { 'xl2': '1rem' },
        keyframes: {
          fadeIn: { '0%': {opacity:0, transform:'translateY(6px)'},
                    '100%': {opacity:1, transform:'translateY(0)'} },
          pulseSoft: { '0%,100%': {opacity:.75}, '50%': {opacity:1} }
        },
        animation: {
          fadeIn: 'fadeIn .35s ease-out both',
          pulseSoft: 'pulseSoft 2.4s ease-in-out infinite'
        }
      }
    }
  }
</script>

  <!-- React 18 UMD + Babel for in-browser JSX -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
 
/* æŸ”å’Œæ ¼é»èƒŒæ™¯ + æ¼¸å±¤åŸºåº• */
body {
  background-image:
    radial-gradient(at 20% 0%, rgba(20,184,166,.08), transparent 35%),
    radial-gradient(at 80% 10%, rgba(245,158,11,.08), transparent 35%),
    radial-gradient(at 50% 100%, rgba(15,118,110,.08), transparent 35%);
}

   
    .tap-target{padding:10px 12px; min-width:44px; min-height:44px}

    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  
/* === èƒŒæ™¯åœ–ç‰‡ï¼ˆæ•´ç«™ï¼‰ ================================== */
html, body { min-height: 100%; }
body::before{
  content:"";
  position: fixed; inset: 0; z-index:-1;
  background-image:
    linear-gradient(var(--bg-tint, rgba(255,255,255,0.0)), var(--bg-tint, rgba(255,255,255,0.0))),
    var(--bg-img, none);
  background-size: var(--bg-size, cover);
  background-position: var(--bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--bg-brightness,1)) blur(var(--bg-blur,0px));
  opacity: var(--bg-opacity,1);
  transition: filter .25s ease, opacity .25s ease, background .25s ease;
}

/* === æ¼¢å ¡é¸å–®èƒŒæ™¯ ======================= */
.menu-pane{
  position: relative;
  overflow: hidden;
  background: var(--menu-fallback, rgba(255,255,255,.92));
  border-right: 1px solid rgba(15,23,42,.08);
}
.menu-pane::before{
  content:"";
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(var(--menu-tint, rgba(255,255,255,0.0)), var(--menu-tint, rgba(255,255,255,0.0))),
    var(--menu-bg-img, none);
  background-size: var(--menu-bg-size, cover);
  background-position: var(--menu-bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--menu-brightness,1)) blur(var(--menu-blur,0px));
  opacity: var(--menu-opacity,1);
}
.menu-pane > *{ position: relative; z-index:1; }

</style>
</head>
<body class="bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    // â€”â€” LocalStorage Keys â€”â€”
    const LS = { data: 'kjs_site_data_v1', admin: 'kjs_admin_pass' };

  // === Default Settingsï¼ˆå¯è¢«ç®¡ç†é¢æ¿è¦†å¯«ï¼‰ ===
const DEFAULT_SETTINGS = {
  drawMaxPerRun: 500,      // å–®æ¬¡æœ€å¤šæŠ½å‡ºäººæ•¸ä¸Šé™ï¼ˆåé¡ï¼‰
  drawPublicShowLimit: 50, // å…¬é–‹çµæœæœ€å¤šé¡¯ç¤ºå¹¾ä½
  drawCooldownSec: 10,     // åŒä¸€æ´»å‹•é‡è·‘å†·å»ç§’æ•¸
};

// === History ç‹€æ…‹é¸å–® ===
const HISTORY_STATUS_OPTIONS = [
  { value: "å·²å¯„å‡º",   label: "âœ… å·²å¯„å‡º" },
  { value: "è™•ç†ä¸­",   label: "â³ è™•ç†ä¸­" },
  { value: "æœªå›è¦†",   label: "ğŸ”´ æœªå›è¦†" },
  { value: "å†å¯„é€ä¸­", label: "ğŸ“¦ å†å¯„é€ä¸­" },
  { value: "å¾…å¯„é€",   label: "ğŸŸ¡ å¾…å¯„é€" },
  { value: "æ”¾æ£„é ˜ç", label: "ğŸš« æ”¾æ£„é ˜ç" },
];
// é¡¯ç¤ºç”¨ï¼ˆæ­·å²åˆ—è¡¨ï¼‰
const HISTORY_STATUS_ICON = {
  "å·²å¯„å‡º":"âœ…","è™•ç†ä¸­":"â³","æœªå›è¦†":"ğŸ”´","å†å¯„é€ä¸­":"ğŸ“¦","å¾…å¯„é€":"ğŸŸ¡","æ”¾æ£„é ˜ç":"ğŸš«"
};

// ========== ç‹€æ…‹æ¨™ç±¤æ¨£å¼ï¼ˆæŸ”å’Œã€ä¸åˆºçœ¼ï¼‰ ==========
const HISTORY_STATUS_STYLE = {
  "å·²å¯„å‡º":   { bg: "bg-emerald-100/70 dark:bg-emerald-300/15", text: "text-emerald-700 dark:text-emerald-300", ring:"ring-emerald-500/20" },
  "è™•ç†ä¸­":   { bg: "bg-sky-100/70 dark:bg-sky-300/15",         text: "text-sky-700 dark:text-sky-300",         ring:"ring-sky-500/20" },
  "æœªå›è¦†":   { bg: "bg-rose-100/70 dark:bg-rose-300/15",       text: "text-rose-700 dark:text-rose-300",       ring:"ring-rose-500/20" },
  "å†å¯„é€ä¸­": { bg: "bg-indigo-100/70 dark:bg-indigo-300/15",   text: "text-indigo-700 dark:text-indigo-300",   ring:"ring-indigo-500/20" },
  "å¾…å¯„é€":   { bg: "bg-amber-100/70 dark:bg-amber-300/15",     text: "text-amber-800 dark:text-amber-300",     ring:"ring-amber-500/20" },
  "æ”¾æ£„é ˜ç": { bg: "bg-slate-200/70 dark:bg-slate-300/15",     text: "text-slate-700 dark:text-slate-300",     ring:"ring-slate-400/20" },
};

// å°å…ƒä»¶ï¼šç‹€æ…‹è† å›Šï¼ˆå« emojiï¼‰
function StatusTag({ value }) {
  const v = String(value || "").trim();
  if (!v) return null;
  const icon = HISTORY_STATUS_ICON[v] || "ğŸ·ï¸";
  const style = HISTORY_STATUS_STYLE[v] || { bg: "bg-slate-100/70 dark:bg-slate-300/10", text: "text-slate-600 dark:text-slate-300", ring:"ring-slate-400/20" };
  return (
    <span
      className={[
        "inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs",
        "border border-transparent ring-1", style.ring, style.bg, style.text
      ].join(" ")}
      title={`ç‹€æ…‹ï¼š${v}`}
    >
      <span aria-hidden="true">{icon}</span>
      <span className="leading-none">{v}</span>
    </span>
  );
}


// â€”â€” å°å·¥å…· â€”â€”ï¼ˆä½ å‰›å‰›ä¸å°å¿ƒåˆªæ‰çš„ï¼‰
const cx = (...xs) => xs.filter(Boolean).join(' ');
const nid = () => Math.random().toString(36).slice(2,10);

function useLocalState(key, initial){
  const [state, setState] = React.useState(()=>{
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    }catch{
      return initial;
    }
  });
  React.useEffect(()=>{
    localStorage.setItem(key, JSON.stringify(state));
  },[key, state]);
  return [state, setState];
}

// æ–‡å­—åå–®æ¸…æ´—ï¼šå»ç©ºç™½ã€å…¨/åŠå½¢ç©ºç™½ã€é€£çºŒç©ºç™½ã€å¤§å°å¯«ä¸æ•æ„Ÿå»é‡
function parseLinesClean(txt="") {
  const normalize = s => s.replace(/\u3000/g, " ").replace(/\s+/g, " ").trim();
  const set = new Set(), out = [];
  for (const raw of String(txt).split(/\r?\n/)) {
    const v = normalize(raw);
    if (!v) continue;
    const key = v.toLowerCase();
    if (!set.has(key)) { set.add(key); out.push(v); }
  }
  return out;
}

// â€”â€” æ–‡å­—æ¯”å°ï¼šå¤§å°å¯«ä¸æ•æ„Ÿã€å…¨å½¢ç©ºç™½è½‰åŠå½¢ã€é€£çºŒç©ºç™½æ­¸ä¸€åŒ– â€”â€” //
function matchText(hay="", needle=""){
  const norm = (s)=> String(s||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase();
  const a = norm(hay), b = norm(needle);
  if (!b) return true; // ç©ºå­—ä¸²è¦–ç‚ºå…¨éƒ¨åŒ¹é…
  return a.includes(b);
}

// â€”â€” History æœå°‹è¦å‰‡ï¼ˆä¾æ¨¡å¼ï¼‰â€”â€” //
// rec: { title, winners[], note, status, youtube, ... }
// mode: 'all' | 'prize' | 'winner' | 'note'
// q: é—œéµå­—
function historyMatchByMode(rec, q, mode){
  const m = mode || 'all';
  const title = rec?.title || "";
  const note  = rec?.note  || rec?.desc || "";
  const winners = Array.isArray(rec?.winners) ? rec.winners : [];

  if (!q) return true; // æ²’è¼¸å…¥é—œéµå­— => ä¸éæ¿¾

  switch (m) {
    case 'prize':
      return matchText(title, q);

    case 'winner':
      return winners.some(w => matchText(w, q));

    case 'note':
      // å‚™è¨»/èªªæ˜ï¼šå„ªå…ˆ note/descï¼Œå…¶æ¬¡ statusã€youtube ä¹Ÿç´å…¥é—œè¯æœå°‹
      return (
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );

    case 'all':
    default:
      // å…¨éƒ¨ï¼štitleã€winnersã€note/status/youtube çš†ç´å…¥
      return (
        matchText(title, q) ||
        winners.some(w => matchText(w, q)) ||
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );
  }
}

// === Adminï¼šç´”å‰ç«¯ SHA-256 é›œæ¹Šï¼ˆé¿å…æ˜æ–‡å­˜å¯†ç¢¼ï¼‰ ===
async function hashTextSHA256(text) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(String(text)));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, "0")).join("");
}


// === è£œé½Šå°å·¥å…·ï¼ˆä¸ä¾è³´å›æ”¶ç«™ï¼‰ ===
function nowISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function exportCSV(filename, rows){
  const csv = rows
    .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// å–å¾—å•†å“å‰©é¤˜æ•¸é‡ï¼ˆç›¸å®¹å¤šç¨®æ¬„ä½å‘½åï¼‰
function getRemain(x){
  const cand = [x?.stock, x?.qty, x?.quantity, x?.remaining];
  for (const v of cand){
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    if (typeof v === 'string' && v.trim()!=='' && !Number.isNaN(+v)) return +v;
  }
  return null; // æ²’æœ‰æ•¸é‡å°±ä¸é¡¯ç¤º
}

// é˜²å‘†åˆªé™¤é—œéµå­—ç¢ºèªï¼ˆé è¨­é—œéµå­—ï¼šåˆªé™¤ï¼‰
function confirmKeyword({ label='', keyword='åˆªé™¤' } = {}){
  const input = prompt(`ç‚ºäº†é˜²å‘†ï¼Œè«‹è¼¸å…¥ã€Œ${keyword}ã€ä»¥ç¢ºèªï¼š\n${label}`);
  return input === keyword;
}

// â€”â€” ç©ºè³‡æ–™ï¼ˆå…¨éƒ¨ç•™çµ¦ä½ ç”¨ Admin å¾ŒçºŒæ–°å¢ï¼‰ â€”â€”
// ç›´æ¥åœ¨ EMPTY å…§æ”¾å…¥ settingsï¼ˆæ³¨æ„ others å¾Œé¢çš„é€—è™Ÿï¼‰
const EMPTY = {
  homepage: { title: 'é–‹çæ‰€', subtitle: 'å…è²»æŠ½çãƒ»ä¸å®šæœŸé©šå–œ', announcements: [] },
  history: [],     // ğŸ“š æ­·å²æŠ½çç´€éŒ„
  pending: [],     // â³ ç­‰å¾…é–‹ç
  ongoing: [],     // ğŸ”„ é€²è¡Œä¸­æ´»å‹•
  shop: { items: [], people: [] }, // ğŸ›ï¸ é»æ•¸å•†åŸï¼ˆå•†å“/å¯é¸äººå“¡é»æ•¸è¡¨ï¼‰
  others: { cards: [] },           // ğŸ“Œ å…¶ä»–è³‡æ–™å¡ç‰‡é›†åˆï¼ˆé€™è¡Œå¾Œé¢ä¸€å®šè¦é€—è™Ÿï¼‰
  settings: { ...DEFAULT_SETTINGS },
};



function normName(s=""){ return s.replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase(); }
function parseISODate(d=""){ // å°ˆåƒ YYYY-MM-DDï¼ˆç©ºå­—ä¸²å› NaNï¼‰
  if(!d) return NaN;
  // å¼·åˆ¶ç”¨ UTC é˜²æ­¢æ™‚å€åç§»
  const m = String(d).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return NaN;
  return Date.UTC(+m[1], +m[2]-1, +m[3]);
}
function sortHistoryDesc(arr=[]) {
  const safe = (x)=> {
    const t = parseISODate(x?.date || "");
    return Number.isNaN(t) ? -Infinity : t; // æ²’æ—¥æœŸçš„æ’æœ€ä¸‹
  };
  return [...arr].sort((a,b)=> safe(b) - safe(a));
}

// === Calendar helpers for History ===
function ymdStringUTC(y, mZeroBased, d) {
  const y4 = String(y).padStart(4, '0');
  const m2 = String(mZeroBased + 1).padStart(2, '0');
  const d2 = String(d).padStart(2, '0');
  return `${y4}-${m2}-${d2}`;
}

function buildMonthDaysUTC(y, mZeroBased) {
  // ä»¥ UTC è¨ˆç®—æœˆæ›†ï¼Œé¿å…æ™‚å€åç§»
  const first = new Date(Date.UTC(y, mZeroBased, 1));
  const startDow = first.getUTCDay(); // 0=Sun..6=Sat
  const daysInMonth = new Date(Date.UTC(y, mZeroBased + 1, 0)).getUTCDate();

  const days = [];
  for (let i = 0; i < startDow; i++) days.push(null); // å‰å°ç©ºæ ¼
  for (let d = 1; d <= daysInMonth; d++) {
    days.push(ymdStringUTC(y, mZeroBased, d));
  }
  return days;
}

// === Utils: æŠ½çç”¨ï¼ˆå®‰å…¨éš¨æ©Ÿ / å¯é¸ç¨®å­ï¼‰ ===
// å°‡å­—ä¸²è®Šæˆ 32-bit æ•´æ•¸ç¨®å­
function hash32(str="") {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
// xorshift32 ç”¢ç”Ÿå™¨ï¼ˆå¯é‡ç¾ï¼‰
function makePRNG(seedStr="") {
  if (!seedStr) return null; // æ²’ç¨®å­å°±ç”¨å®‰å…¨éš¨æ©Ÿ
  let x = hash32(seedStr) || 1;
  return function next() {
    // ç”¢ 0..1 çš„æµ®é»æ•¸
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    // è½‰æˆ 0..1
    return ((x >>> 0) / 4294967296);
  };
}
// Fisherâ€“Yates æ´—ç‰Œï¼›å„ªå…ˆä½¿ç”¨ prngï¼Œå¦å‰‡ç”¨ crypto å®‰å…¨éš¨æ©Ÿ
function shufflePick(arr, k, prng=null) {
  const a = arr.slice();
  const n = a.length;
  // åªæ´—åˆ°å–åˆ° k å€‹ç‚ºæ­¢
  for (let i = 0; i < k; i++) {
    let r;
    if (prng) {
      r = i + Math.floor(prng() * (n - i));
    } else {
      const buf = new Uint32Array(1);
      crypto.getRandomValues(buf);
      r = i + (buf[0] % (n - i));
    }
    [a[i], a[r]] = [a[r], a[i]];
  }
  return a.slice(0, k);
}

function drawCooldownKey(pendingId){ return `kjs_draw_cd_${pendingId}`; }

// === Announcement helpers (NEW) ===
// å®‰å…¨æŠŠ YYYY-MM-DD åŠ å¤©æ•¸ï¼ˆUTCï¼Œä¸åƒæ™‚å€èª¤å·®ï¼‰
function addDaysUTC(ymd="", days=1){
  const ts = parseISODate(ymd);
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  d.setUTCDate(d.getUTCDate() + days);
  const y = d.getUTCFullYear(), m = d.getUTCMonth(), day = d.getUTCDate();
  return ymdStringUTC(y, m, day);
}

// ä¾å¡ç‰‡è³‡æ–™ç”¢ç”Ÿå…¬å‘Šæ¨¡æ¿ï¼ˆå›å‚³å­—ä¸²ï¼‰
function buildAnnouncementText(p){
  const title   = p?.title || "ï¼ˆæœªå‘½åï¼‰";
  const planned = (typeof p?.plannedWinners === 'number' && p.plannedWinners>0) ? String(p.plannedWinners) : "ï¼ˆæœªå¡«ï¼‰";
  const deadline = p?.deadline || "ï¼ˆæœªå¡«ï¼‰";
  const announce = p?.deadline ? addDaysUTC(p.deadline, 1) : "ï¼ˆæœªå¡«ï¼‰";
  const noteLine = p?.note ? `ï¼ˆ${p.note}ï¼‰\n` : ""; // è‹¥æƒ³ç”¨ desc ç•¶å‚™è¨»ï¼Œå¯æŠŠ p.note æ›æˆ p.desc

  return [
    "ğŸ‰ã€é™æ™‚æŠ½çä¾†å•¦ï¼ã€‘ğŸ‰",
    "",
    `ğŸ ${title}`,
    noteLine ? noteLine : "",
    `ğŸ“Œ æŠ½å‡ºåé¡ï¼š${planned} ä½å¹¸é‹å…’`,
    `ğŸ“… æˆªæ­¢æ™‚é–“ï¼š${deadline} æ™šä¸Š 23:59 å‰`,
    `ğŸ•° é–‹çå…¬å‘Šï¼š${announce} æ™šé–“å…¬å¸ƒæ–¼ç¾¤çµ„`,
    "",
    "ğŸ“£ åƒåŠ æ–¹å¼ï¼š",
    "ç›´æ¥åœ¨é€™ç¯‡ç•™è¨€ã€Œæˆ‘è¦åƒåŠ ã€å³å¯ï¼",
    "",
    "âœ… å®Œå…¨å…è²»åƒåŠ ",
    "âœ… å¾—çåªéœ€è‡ªä»˜é‹è²»ï¼ˆå¯é¸è²¨åˆ°ä»˜æ¬¾ï¼‰"
  ].filter(Boolean).join("\n");
}

// === Collapseï¼ˆæ”¶åˆ/å±•é–‹ï¼‰â€” æ”¯æ´å¤–éƒ¨æ§åˆ¶ force: 'open' | 'close' | null ===
function Collapse({ header, children, defaultOpen=false, force=null }) {
  const { useState, useRef, useEffect } = React;
  const [open, setOpen] = useState(!!defaultOpen);
  const ref = useRef(null);

  useEffect(()=>{ if (force==='open') setOpen(true); else if(force==='close') setOpen(false); },[force]);
  useEffect(()=>{ if(ref.current){ ref.current.style.height = open ? ref.current.scrollHeight+'px' : '0px'; }},[open,children]);

  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white/70 dark:bg-slate-900/40">
      <button
        className="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-slate-50/80 dark:hover:bg-slate-800/60 transition"
        onClick={()=>setOpen(o=>!o)}
      >
        <div className="font-medium">{header}</div>
        <svg className={"w-4 h-4 transition " + (open ? "rotate-180" : "")} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
      <div ref={ref} className="px-4 pb-4 transition-[height] duration-300 ease-in-out" style={{height: defaultOpen?'auto':'0px'}}>
        <div className="pt-2">{children}</div>
      </div>
    </div>
  );
}


    // â€”â€” ä¸» Appï¼ˆPart 1ï¼šéª¨æ¶/å°è¦½/é›™æ¨¡å¼/åŒ¯å…¥åŒ¯å‡ºï¼Œæœªå«ç·¨è¼¯å™¨ï¼‰ â€”â€”
    function App(){
      const [data, setData] = useLocalState(LS.data, EMPTY);

// é€²ç«™æ™‚è‡ªå‹•æŠ“ ./data/app.jsonï¼Œè¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Œç¢ºä¿å¤§å®¶çœ‹åˆ°æœ€æ–°
React.useEffect(() => {
  (async () => {
    try {
      const res = await fetch('./data/app.json?v=' + Date.now(), { cache: 'no-store' });
      const obj = await res.json();
      // è®“æ­·å²ç”±æ–°åˆ°èˆŠï¼ˆä½ çš„åŒ¯å…¥ä¹Ÿæœ‰åšåŒæ¨£çš„äº‹ï¼‰
      if (Array.isArray(obj.history)) obj.history = sortHistoryDesc(obj.history);
      setData(obj);
    } catch (e) {
      console.error('è®€å– data/app.json å¤±æ•—ï¼š', e);
    }
  })();
}, []);


// === PointsPanel å±•é–‹ç‹€æ…‹ï¼ˆé è¨­å±•é–‹ï¼Œæœƒè¨˜ä½ä½¿ç”¨è€…é¸æ“‡ï¼‰ ===
const [pointsOpen, setPointsOpen] = useLocalState('kjs_points_open', true);
      
const [tab, setTab] = useState('home'); // home | history | pending | ongoing | shop | others
      const [menuOpen, setMenuOpen] = useState(false);
      const [adminMode, setAdminMode] = useState(false);
      const [query, setQuery] = useState('');
const [queryMode, setQueryMode] = useLocalState('kjs_query_mode', 'all'); // all | prize | winner | note


// === Adminï¼šç®¡ç†å“¡åå–®ï¼‹ç›®å‰ç™»å…¥è€… ===
const [admins, setAdmins] = useLocalState('kjs_admins', [
  { 
    name: 'admin', 
    passwordHash: '8efdbb89a7394f7a1a3f3a81d1b91a2781a5a66d74f40bfa7f2f5a5a8d79f5f2' 
  }
]);
const [currentAdmin, setCurrentAdmin] = useLocalState('kjs_current_admin', ''); // ç©ºå­—ä¸²ï¼æœªç™»å…¥

// === Adminï¼šç™»å…¥ Modal ç‹€æ…‹ï¼ˆå…©æ®µå¼ï¼‰===
const [showAdminLogin, setShowAdminLogin] = React.useState(false);
const [adminLoginStep, setAdminLoginStep] = React.useState(1); // 1=è¼¸å…¥/é¸æ“‡åç¨±ï¼›2=è¼¸å…¥å¯†ç¢¼
const [loginName, setLoginName] = React.useState('');
const [loginPwd, setLoginPwd] = React.useState('');
const [loginAttempts, setLoginAttempts] = React.useState(0);
const [loginLockUntil, setLoginLockUntil] = React.useState(0); // Date.now() æ¯«ç§’
const [showAdminHint, setShowAdminHint] = React.useState(false);

// === Admin å¯†æŠ€ï¼šé•·æŒ‰ 5~8 ç§’ï¼ˆæ‰‹æ©Ÿï¼‰ï¼æ¡Œé¢é€£é» 7 ä¸‹ ===
const secretHoldMsRef = React.useRef(6000);        // æ¯æ¬¡é–‹å•Ÿç™»å…¥è¦–çª—ï¼Œéš¨æ©Ÿ 5000~8000ms
const secretTimerRef = React.useRef(null);
const secretClicksRef = React.useRef(0);
const secretClicksTimerRef = React.useRef(null);

React.useEffect(() => {
  if (showAdminLogin) {
    secretHoldMsRef.current = 5000 + Math.floor(Math.random() * 3000); // 5000~8000
    secretClicksRef.current = 0;
  } else {
    if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
    if (secretClicksTimerRef.current) clearTimeout(secretClicksTimerRef.current);
    secretClicksTimerRef.current = null;
    setShowAdminHint(false);
  }
}, [showAdminLogin, setShowAdminHint]);

function startSecretHold(e) {
  e.preventDefault();
  if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
  secretTimerRef.current = setTimeout(() => {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
  }, secretHoldMsRef.current);
}
function cancelSecretHold() {
  if (secretTimerRef.current) {
    clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
  }
}

// æ¡Œé¢ï¼šåœ¨åŒä¸€å…ƒç´ ä¸Š 7 æ¬¡é»æ“Šï¼ˆ4 ç§’å…§ï¼‰
function secretClick() {
  secretClicksRef.current += 1;
  if (!secretClicksTimerRef.current) {
    secretClicksTimerRef.current = setTimeout(() => {
      secretClicksRef.current = 0;
      secretClicksTimerRef.current = null;
    }, 4000);
  }
  if (secretClicksRef.current >= 7) {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
    // é‡ç½®
    secretClicksRef.current = 0;
    if (secretClicksTimerRef.current) { clearTimeout(secretClicksTimerRef.current); secretClicksTimerRef.current = null; }
  }
}


// å°è£ï¼šé–‹å•Ÿç™»å…¥è¦–çª— / ç™»å‡º
function enterAdmin() {
  setLoginName('');
  setLoginPwd('');
  setAdminLoginStep(1);
  setShowAdminLogin(true);
}
function exitAdmin() {
  setAdminMode(false);
  setCurrentAdmin('');
  alert('å·²ç™»å‡ºç®¡ç†æ¨¡å¼');
}

// === Drawer A11yï¼šåƒè€ƒç¯€é» ===
const menuPaneRef = React.useRef(null);     // æŠ½å±œ <aside>
const menuButtonRef = React.useRef(null);   // é–‹å•ŸæŠ½å±œçš„æ¼¢å ¡æŒ‰éˆ•
const appContentRef = React.useRef(null);   // ä¸»å…§å®¹å®¹å™¨ï¼ˆè¦ aria-hiddenï¼‰

// === BackToTopï¼šç‹€æ…‹ï¼ˆæ»¾åˆ°ä¸€å®šé«˜åº¦æ‰é¡¯ç¤ºï¼‰ ===
const [showBackTop, setShowBackTop] = React.useState(false);

      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
useEffect(()=>{
  let g = false;
  const onKey = (e)=>{
    // è‹¥æ­£åœ¨è¼¸å…¥æ¬„ä½/æ–‡å­—å€æˆ–çµ„å­—ä¸­å°±å¿½ç•¥
    const tag = (e.target && e.target.tagName || '').toString().toLowerCase();
    if (e.isComposing || tag === 'input' || tag === 'textarea' || tag === 'select' || e.metaKey || e.ctrlKey || e.altKey) return;

    const k = (e.key || '').toLowerCase();     // â† é˜²å‘†
    if (k === '/') { e.preventDefault(); document.getElementById('kjs-search')?.focus(); return; }
    if (k === 'g') { g = true; setTimeout(()=> g = false, 800); return; }
    if (k === 'h' && g) { e.preventDefault(); setTab('home'); return; }
    if (k === 'm' && g) { e.preventDefault(); setMenuOpen(true); return; }
  };
  window.addEventListener('keydown', onKey);
  return ()=> window.removeEventListener('keydown', onKey);
},[]);

// === Drawer A11yï¼šç„¦é»é™·é˜±ã€Esc é—œé–‰ã€é–å®š body æ»¾å‹• ===
React.useEffect(() => {
  if (!menuOpen) return;

  const pane = menuPaneRef.current;
  if (!pane) return;

  // 1) é– body æ»¾å‹•
  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';

  // 2) èšç„¦æŠ½å±œå…§ç¬¬ä¸€å€‹å¯èšç„¦å…ƒç´ 
  const selectors = 'a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const focusables = Array.from(pane.querySelectorAll(selectors));
  const first = focusables[0];
  const last = focusables[focusables.length - 1];
  const prevActive = document.activeElement;

  first?.focus();

  // 3) éµç›¤è¡Œç‚ºï¼šEsc é—œé–‰ã€Tab ç„¦é»ç’°
  const onKeyDown = (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      setMenuOpen(false);
      return;
    }
    if (e.key === 'Tab' && focusables.length > 0) {
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus(); return;
      }
      if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus(); return;
      }
    }
  };

  document.addEventListener('keydown', onKeyDown);

  // 4) æ¸…ç†ï¼šé‚„åŸ bodyã€è§£é™¤ç›£è½ã€æŠŠç„¦é»é‚„çµ¦é–‹å•Ÿéˆ•
  return () => {
    document.body.style.overflow = prevOverflow;
    document.removeEventListener('keydown', onKeyDown);
    // å„ªå…ˆå›åˆ°æ¼¢å ¡æŒ‰éˆ•ï¼›æ²’æ‰¾åˆ°å°±å›åˆ°åŸå…ˆ focus
    if (menuButtonRef.current && typeof menuButtonRef.current.focus === 'function') {
      menuButtonRef.current.focus();
    } else if (prevActive && typeof prevActive.focus === 'function') {
      prevActive.focus();
    }
  };
}, [menuOpen, setMenuOpen]);

// === BackToTopï¼šæ»¾å‹•ç›£è½ï¼ˆ> 480px æ‰é¡¯ç¤ºï¼‰ ===
React.useEffect(() => {
  let ticking = false;
  const threshold = 480; // ä½ å¯ä»¥æ”¹æˆ 400~600 è¦–è¦ºå–œå¥½

  const onScroll = () => {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        setShowBackTop(y > threshold);
        ticking = false;
      });
    }
  };

  // å…ˆè·‘ä¸€æ¬¡ï¼Œé¿å…åˆæ¬¡é€²é é¢åœ¨ä¸­æ®µä½ç½®æ™‚ç‹€æ…‹ä¸æº–
  onScroll();

  window.addEventListener('scroll', onScroll, { passive: true });
  return () => window.removeEventListener('scroll', onScroll);
}, []);

// === èƒŒæ™¯è¨­å®šï¼ˆä¸»ç•«é¢ & æ¼¢å ¡é¸å–®ï¼‰ ===
const [bg, setBg] = useLocalState('kjs_bg', {
  url: "",
  tint: "rgba(255,255,255,0.0)",
  brightness: 1,
  blur: 0,
  opacity: 1,
  size: "cover",
  pos: "center",
  menuUseMain: true,
  menuUrl: "",
  menuTint: "rgba(255,255,255,0.0)",
  menuBrightness: 1,
  menuBlur: 0,
  menuOpacity: 1,
  menuSize: "cover",
  menuPos: "center",
});

// æŠŠè¨­å®šå¥—åˆ° CSS è®Šæ•¸
useEffect(()=>{
  const r = document.documentElement;
  // ä¸»ç•«é¢
  r.style.setProperty('--bg-img', bg.url ? `url("${bg.url}")` : 'none');
  r.style.setProperty('--bg-tint', bg.tint);
  r.style.setProperty('--bg-brightness', String(bg.brightness));
  r.style.setProperty('--bg-blur', bg.blur + 'px');
  r.style.setProperty('--bg-opacity', String(bg.opacity));
  r.style.setProperty('--bg-size', bg.size);
  r.style.setProperty('--bg-pos', bg.pos);

  // æ¼¢å ¡é¸å–®
  const useMain = !!bg.menuUseMain;
  const mUrl = useMain ? bg.url : bg.menuUrl;
  const mTint = useMain ? bg.tint : bg.menuTint;
  const mBri  = useMain ? bg.brightness : bg.menuBrightness;
  const mBlur = useMain ? bg.blur : bg.menuBlur;
  const mOpa  = useMain ? bg.opacity : bg.menuOpacity;
  const mSize = useMain ? bg.size : bg.menuSize;
  const mPos  = useMain ? bg.pos : bg.menuPos;

  r.style.setProperty('--menu-bg-img', mUrl ? `url("${mUrl}")` : 'none');
  r.style.setProperty('--menu-tint', mTint);
  r.style.setProperty('--menu-brightness', String(mBri));
  r.style.setProperty('--menu-blur', mBlur + 'px');
  r.style.setProperty('--menu-opacity', String(mOpa));
  r.style.setProperty('--menu-bg-size', mSize);
  r.style.setProperty('--menu-bg-pos', mPos);
}, [bg]);


      // åŒ¯å…¥/åŒ¯å‡ºï¼ˆJSONï¼Œä¾›ä½ å‚™ä»½æ¬ç§»ï¼‰
      const exportJSON = ()=>{
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `kjs_export_${new Date().toISOString().slice(0,10)}.json`;
        a.click(); URL.revokeObjectURL(a.href);
      };
      const importJSON = (file)=>{
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const obj = JSON.parse(String(e.target.result||'{}'));
      // âœ… åŒ¯å…¥å¾ŒæŠŠ history æ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
      if (Array.isArray(obj.history)) obj.history = sortHistoryDesc(obj.history);
      setData(obj);
      alert('åŒ¯å…¥å®Œæˆï¼ˆå·²è‡ªå‹•æ’åºæ­·å²ï¼‰');
    } catch{
      alert('åŒ¯å…¥å¤±æ•—ï¼šä¸æ˜¯æœ‰æ•ˆ JSON');
    }
  }; reader.readAsText(file);
};


      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="sticky top-0 z-30 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200/60 dark:border-slate-800">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2">
             <button
  ref={menuButtonRef}
  type="button"
  aria-controls="app-menu-pane"
  aria-expanded={menuOpen ? 'true' : 'false'}
  aria-label="é–‹å•Ÿä¸»é¸å–®"
  className="tap-target -ml-2"
  onClick={() => setMenuOpen(true)}
  title="é–‹å•Ÿé¸å–®"
>
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>

              <h1 className="text-lg font-semibold">é–‹çæ‰€</h1>
              <div className="ml-auto flex items-center gap-2">
                <div className="hidden sm:flex items-center gap-2">
  {/* æ¨¡å¼é¸å–® */}
  <label htmlFor="kjs-search-mode" className="sr-only">æœå°‹æ¨¡å¼</label>
  <select
    id="kjs-search-mode"
    value={queryMode}
    onChange={(e)=>setQueryMode(e.target.value)}
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-2 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70"
    title="é¸æ“‡æœå°‹æ¨¡å¼"
    aria-label="æœå°‹æ¨¡å¼"
  >
    <option value="all">å…¨éƒ¨</option>
    <option value="prize">çå“åç¨±</option>
    <option value="winner">å¾—çè€…</option>
    <option value="note">å‚™è¨»ãƒ»èªªæ˜</option>
  </select>

  {/* æœå°‹è¼¸å…¥æ¡† */}
  <label htmlFor="kjs-search" className="sr-only">æœå°‹é—œéµå­—</label>
  <input
    id="kjs-search"
    value={query}
    onChange={e=>setQuery(e.target.value)}
    placeholder="æœå°‹...ï¼ˆæŒ‰ / èšç„¦ï¼‰"
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70 focus:outline-none focus:ring-2 focus:ring-brand"
  />
</div>

                {!adminMode && (
                  <button onClick={enterAdmin} className="tap-target rounded-xl bg-brand text-white px-3 py-1.5 text-sm shadow-soft">ç®¡ç†</button>
                )}
                {adminMode && (
  <div className="flex items-center gap-2">
    <button onClick={exportJSON} className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm">åŒ¯å‡º</button>
    <label className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm cursor-pointer">åŒ¯å…¥
      <input type="file" accept="application/json" className="hidden" onChange={e=>e.target.files&&importJSON(e.target.files[0])}/>
    </label>

    {/* å°‡åŸæœ¬çš„ã€Œé‡è¨­å¯†ç¢¼ã€æ”¹æˆå°å‘ç³»çµ±è¨­ç½®é ï¼ˆåœ¨é‚£è£¡æ”¹å¸³è™Ÿ/å¯†ç¢¼ï¼‰ */}
    <button
      onClick={() => { setTab('system'); /* å¯é¸ï¼šå¸¶å…¥éŒ¨é» */ const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
      className="tap-target rounded-xl bg-amber-200 text-amber-900 dark:bg-amber-300/20 dark:text-amber-200 px-3 py-1.5 text-sm"
      title="å‰å¾€ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®"
    >
      ç®¡ç†å“¡è¨­å®š
    </button>

    <button onClick={exitAdmin} className="tap-target rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-3 py-1.5 text-sm">é€€å‡º</button>
  </div>
)}

              </div>
            </div>
          </header>

          {/* Main */}
          <div ref={appContentRef} aria-hidden={menuOpen ? 'true' : 'false'}>
  <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">

            {tab==='home' && <Home setTab={setTab} data={data} setData={setData} admin={adminMode} />}

            {tab==='history' && <History data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='pending' && <Pending data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='ongoing' && <Ongoing data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='shop' && (
  <>
    {/* æŸ¥è©¢é»æ•¸ï¼šå¯æ”¶åˆå¡ï¼ˆé è¨­å±•é–‹ï¼Œè¨˜æ†¶ç‹€æ…‹ï¼‰ */}
    <section
      className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-0 overflow-hidden"
      aria-label="æŸ¥è©¢é»æ•¸"
    >
      {/* å¡ç‰‡æ¨™é¡Œåˆ— */}
      <div className="flex items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <span className="text-lg">ğŸ’³</span>
          <h2 className="text-base font-semibold">æŸ¥è©¢é»æ•¸</h2>
        </div>
        <button
          type="button"
          aria-controls="points-panel-body"
          aria-expanded={pointsOpen ? 'true' : 'false'}
          onClick={()=>setPointsOpen(v=>!v)}
          className="tap-target rounded-lg border px-3 py-1.5 text-sm"
          title={pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        >
          {pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        </button>
      </div>

      {/* åˆ†éš”ç·š */}
      <div className="h-px bg-slate-200 dark:bg-slate-700" />

      {/* å¡ç‰‡å…§å®¹ï¼ˆå¯æ”¶åˆï¼‰ */}
      {pointsOpen && (
        <div id="points-panel-body" className="p-4">
          <PointsPanel data={data} admin={adminMode} setData={setData} />
        </div>
      )}
    </section>

    {/* èˆ‡æŸ¥è©¢å¡ç‰‡ç•™é»é–“è· */}
    <div className="h-4" />

    {/* é»æ•¸å•†åŸå…§å®¹ */}
    <Shop data={data} admin={adminMode} setData={setData} query={query} />

<ShopImageQuickset data={data} setData={setData} admin={adminMode} />

  </>
)}


{tab==='others' && <Others data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}

{tab==='system' && adminMode && (
  <SystemSettings
    data={data}
    setData={setData}
    bg={bg}
    setBg={setBg}
    admins={admins}
    setAdmins={setAdmins}
    currentAdmin={currentAdmin}
    setCurrentAdmin={setCurrentAdmin}
  />
)}

{/* è¿”å›é ‚éƒ¨ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ï¼šåƒ…åœ¨æ»¾åˆ°ä¸€å®šé«˜åº¦å¾Œé¡¯ç¤º */}
{showBackTop && (
  <button
    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
    className="fixed right-4 bottom-20 md:bottom-6 z-40 rounded-full border shadow-soft bg-white/90 dark:bg-slate-900/80 backdrop-blur px-3 py-2 tap-target"
    aria-label="å›åˆ°æœ€ä¸Šé¢"
    title="å›åˆ°æœ€ä¸Šé¢"
  >
    â†‘
  </button>
)}

{/* === Admin ç™»å…¥ï¼ˆäºŒæ®µå¼ Modalï¼‰=== */}
{showAdminLogin && (
  <div className="fixed inset-0 z-50">
    {/* èƒŒæ™¯ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setShowAdminLogin(false)} />
    <div className="absolute inset-0 flex items-center justify-center p-4">
      <div className="relative w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4" onClick={(e)=>e.stopPropagation()}>

{/* ï¼ˆå¯†æŠ€ï¼‰å·¦ä¸Šè§’ 10Ã—10 px è£é£¾é»ï¼šçœ‹èµ·ä¾†åƒè£é£¾ï¼Œå¯¦éš›æ˜¯é•·æŒ‰/é€£é»å•Ÿå‹•å™¨ */}
<div
  aria-hidden="true"
  tabIndex={-1}
  className="absolute top-1 left-1 w-2.5 h-2.5 rounded-full bg-slate-300/70 dark:bg-slate-600/70 cursor-default select-none"
  // æ‰‹æ©Ÿï¼šé•·æŒ‰ 5~8 ç§’
  onPointerDown={startSecretHold}
  onPointerUp={cancelSecretHold}
  onPointerLeave={cancelSecretHold}
  onPointerCancel={cancelSecretHold}
  // æ¡Œé¢ï¼šé€£é» 7 ä¸‹ï¼ˆæ­¤å…ƒç´ ä¸é¡¯ç¤ºä»»ä½•æŒ‰éˆ•æ¨£å¼ï¼Œæ¸¸æ¨™ä¸è®Šï¼‰
  onClick={secretClick}
  onContextMenu={(e)=>e.preventDefault()} // é˜»æ“‹é•·æŒ‰å«å‡ºé¸å–®
/>


        <div className="text-base font-semibold mb-2">ç®¡ç†è€…ç™»å…¥</div>

        {/* é–å®šæç¤º */}
        {Date.now() < loginLockUntil && (
          <div className="text-sm text-red-600 mb-2">
            å˜—è©¦éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ï¼ˆ{Math.ceil((loginLockUntil - Date.now())/1000)} ç§’ï¼‰
          </div>
        )}

        {/* Step 1ï¼šç®¡ç†è€…åç¨± */}
{adminLoginStep === 1 && (
  <div className="grid gap-2">
    <label className="text-sm text-slate-600 dark:text-slate-300">ç®¡ç†è€…åç¨±</label>
    <input
      className="rounded-lg border px-3 py-2"
      placeholder="ä¾‹å¦‚ï¼šadmin æˆ–è¼¸å…¥æ–°åç¨±"
      value={loginName}
      onChange={e=>setLoginName(e.target.value)}
      disabled={Date.now() < loginLockUntil}
    />

    {/* æ³¨æ„ï¼šä¸å†é¡¯ç¤ºä»»ä½•é¡¯ç¤ºå¸³è™Ÿçš„æŒ‰éˆ•æˆ–æç¤ºï¼›åªåœ¨å¯†æŠ€è§¸ç™¼æ™‚çŸ­æš«é¡¯ç¤ºåå–® */}
    {showAdminHint && admins.length > 0 && (
      <div className="text-xs text-slate-600 dark:text-slate-300 rounded-lg border px-3 py-2">
        {admins.map((a,i)=>(
          <button
            key={i}
            className="mr-2 mb-1 inline-flex items-center px-2 py-0.5 rounded border hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={()=>setLoginName(a.name)}
            disabled={Date.now() < loginLockUntil}
            title="é»ä¸€ä¸‹å¸¶å…¥åç¨±ï¼ˆ5 ç§’å¾Œè‡ªå‹•éš±è—ï¼‰"
          >
            {a.name}
          </button>
        ))}
      </div>
    )}

    <div className="flex justify-end gap-2 mt-2">
      <button className="rounded-lg border px-3 py-1.5" onClick={()=>setShowAdminLogin(false)}>å–æ¶ˆ</button>
      <button
        className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
        onClick={()=>{
          if(!loginName.trim()) { alert('è«‹è¼¸å…¥ç®¡ç†è€…åç¨±'); return; }
          setAdminLoginStep(2);
        }}
      >
        ä¸‹ä¸€æ­¥
      </button>
    </div>
  </div>
)}


        {/* Step 2ï¼šå¯†ç¢¼ */}
        {adminLoginStep === 2 && (
          <div className="grid gap-2">
            <label className="text-sm text-slate-600 dark:text-slate-300">å¯†ç¢¼</label>
            <input
              type="password"
              className="rounded-lg border px-3 py-2"
              placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
              value={loginPwd}
              onChange={e=>setLoginPwd(e.target.value)}
              disabled={Date.now() < loginLockUntil}
            />
            <div className="flex justify-between items-center mt-2">
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setAdminLoginStep(1)}>ä¸Šä¸€æ­¥</button>
              <button
  className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
  disabled={Date.now() < loginLockUntil}
  onClick={async ()=>{
    const name = (loginName||"").trim();
    const pass = (loginPwd||"").trim();            // â† ä¿®æ­£ï¼šç”¨ loginPwdï¼Œä¸æ˜¯ loginPassword

    if(!name || !pass){
      alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
      return;
    }

    // ç›´æ¥ä½¿ç”¨ç‹€æ…‹ä¸­çš„ç®¡ç†å“¡åå–®ï¼ˆä¸è¦å†è®€ LS.adminsï¼‰
    const list = Array.isArray(admins) ? admins : [];
    const found = list.find(u => u && u.name === name);

    if(!found){
      // ğŸš« ç™»å…¥æµç¨‹ä¸å…è¨±å»ºç«‹æ–°ç®¡ç†å“¡ï¼ˆåªèƒ½ç”¨æ—¢æœ‰å¸³è™Ÿç™»å…¥ï¼‰
      alert("æ­¤å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹è¯çµ¡æ—¢æœ‰ç®¡ç†å“¡æ–¼ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€æ–°å¢ã€‚");
      return;
    }

    // å¿…é ˆå·²è¨­å®šå¯†ç¢¼ï¼ˆæœ‰ hashï¼‰ï¼Œä¸å…è¨±åœ¨ç™»å…¥æµç¨‹å»ºç«‹æˆ–è®Šæ›´å¯†ç¢¼
    if(!found.passwordHash || String(found.passwordHash).trim()===""){
      alert("æ­¤å¸³è™Ÿå°šæœªè¨­å®šå¯†ç¢¼ï¼Œè«‹å…ˆç”±æ—¢æœ‰ç®¡ç†å“¡åœ¨ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€ç‚ºè©²å¸³è™Ÿè¨­å®šå¯†ç¢¼ã€‚");
      return;
    }

    // æ¯”å° SHA-256 é›œæ¹Š
    const hash = await hashTextSHA256(pass);
    if(hash !== found.passwordHash){
      alert("å¯†ç¢¼éŒ¯èª¤");
      return;
    }

    // âœ… ç™»å…¥æˆåŠŸ
    setCurrentAdmin(name);
    setAdminMode(true);
    setShowAdminLogin(false);
    setLoginName("");
    setLoginPwd("");         // â† ä¿®æ­£ï¼šæ¸…ç©º loginPwdï¼ˆä¸æ˜¯ setLoginPasswordï¼‰
    alert(`å·²ä»¥ã€Œ${name}ã€ç™»å…¥ç®¡ç†æ¨¡å¼`);
  }}
>
  ç™»å…¥
</button>

            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}

          </main>
</div>

{/* åº•éƒ¨å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿï¼‰ */}
<nav className="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white/95 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700 backdrop-blur">
  <div className="max-w-5xl mx-auto grid grid-cols-4">
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='home'?'text-brand':'')} onClick={()=>setTab('home')} title="é¦–é ">ğŸ </button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='pending'?'text-brand':'')} onClick={()=>setTab('pending')} title="ç­‰å¾…é–‹ç">â³</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='shop'?'text-brand':'')} onClick={()=>setTab('shop')} title="é»æ•¸å•†åŸ">ğŸ›ï¸</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='history'?'text-brand':'')} onClick={()=>setTab('history')} title="æ­·å²ç´€éŒ„">ğŸ“š</button>
  </div>
</nav>

          {/* æŠ½å±œå¼æ¼¢å ¡é¸å–® */}
      {menuOpen && (
  <div className="fixed inset-0 z-50">
    {/* é®ç½©ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setMenuOpen(false)} />
    {/* æŠ½å±œæœ¬é«” */}
    <aside
      id="app-menu-pane"
      ref={menuPaneRef}
      role="dialog"
      aria-modal="true"
      aria-label="ä¸»é¸å–®"
      tabIndex={-1}
      className="menu-pane absolute left-0 top-0 h-full w-80 max-w-[85%] shadow-xl no-scrollbar overflow-y-auto"
    >
      {/* ä½ çš„é¸å–®å…§å®¹ç¶­æŒä¸è®Šï¼šæŠŠåŸæœ¬ aside è£¡çš„å…§å®¹æ•´æ®µè²¼å›ä¾† */}
      <div className="p-4 border-b ... flex items-center justify-between">
  <div className="font-semibold">
    å°è¦½{adminMode && currentAdmin ? <span className="ml-2 text-xs text-slate-500">ï¼ˆ{currentAdmin}ï¼‰</span> : null}
  </div>
        <button className="tap-target" onClick={()=>setMenuOpen(false)} aria-label="é—œé–‰">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <nav className="p-2 grid gap-1">
  {/* â€”â€” ä¸»å°è¦½ â€”â€” */}
  <NavItem
    label="ğŸ  é¦–é "
    active={tab==='home'}
    onClick={()=>{ setTab('home'); setMenuOpen(false); }}
  />
  <NavItem
    label="â³ ç­‰å¾…é–‹ç"
    active={tab==='pending'}
    onClick={()=>{ setTab('pending'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ›ï¸ é»æ•¸å•†åŸ"
    active={tab==='shop'}
    onClick={()=>{ setTab('shop'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ“š æ­·å²ç´€éŒ„"
    active={tab==='history'}
    onClick={()=>{ setTab('history'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ”„ é€²è¡Œä¸­æ´»å‹•"
    active={tab==='ongoing'}
    onClick={()=>{ setTab('ongoing'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ“Œ å…¶ä»–è³‡æ–™"
    active={tab==='others'}
    onClick={()=>{ setTab('others'); setMenuOpen(false); }}
  />

  {/* åˆ†éš”ç·š */}
  <div className="my-2 h-px bg-slate-200 dark:bg-slate-700" />

  {/* â€”â€” ç®¡ç†å€ï¼ˆä¾ç‹€æ…‹åˆ‡æ›ï¼‰ â€”â€” */}
  {!adminMode ? (
    <button
      className="w-full text-left px-3 py-2 rounded-xl tap-target hover:bg-slate-100 dark:hover:bg-slate-800"
      onClick={()=>{ enterAdmin(); /* æˆåŠŸé€²å…¥å¾Œä¿ç•™æŠ½å±œé–‹å•Ÿï¼Œæˆ–ä½ ä¹Ÿå¯é—œé–‰ */ }}
      title="é€²å…¥ç®¡ç†æ¨¡å¼"
    >
      ğŸ” é€²å…¥ç®¡ç†æ¨¡å¼
    </button>
  ) : (
    <>
      {/* ç³»çµ±è¨­ç½®åˆ†é ï¼ˆä½ ä¹‹å‰è¦æ±‚é›†ä¸­è¨­å®šåœ¨æ­¤ï¼‰ */}
      <NavItem
        label="ğŸ› ï¸ ç³»çµ±è¨­ç½®"
        active={tab==='system'}
        onClick={()=>{ setTab('system'); setMenuOpen(false); }}
      />

      {/* ç®¡ç†å¸¸ç”¨å·¥å…· */}
      <div className="grid grid-cols-2 gap-2 p-2">
  <button
    onClick={exportJSON}
    className="rounded-lg border px-3 py-2 text-sm"
    title="åŒ¯å‡ºæ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    åŒ¯å‡º
  </button>

  <label
    className="rounded-lg border px-3 py-2 text-sm cursor-pointer text-center"
    title="åŒ¯å…¥æ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    ç´”åŒ¯å…¥
    <input
      type="file"
      accept="application/json"
      className="hidden"
      onChange={e=>e.target.files && importJSON(e.target.files[0])}
    />
  </label>

  {/* å°å‘ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®ï¼ˆå–ä»£èˆŠçš„ resetAdminï¼‰ */}
  <button
    onClick={()=>{ setTab('system'); setMenuOpen(false); const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="å‰å¾€ç³»çµ±è¨­ç½®ï¼ˆç®¡ç†è€…æ¸…å–®ï¼‰"
  >
    ç®¡ç†å“¡è¨­å®š
  </button>

  <button
    onClick={()=>{ exitAdmin(); setMenuOpen(false); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="é€€å‡ºç®¡ç†æ¨¡å¼"
  >
    é€€å‡ºç®¡ç†
  </button>
</div>

    </>
  )}
</nav>

      <div className="p-4 text-xs text-slate-500 border-t border-slate-200/60 dark:border-slate-800">
        <div>æç¤ºï¼š</div>
        <ul className="list-disc pl-5 mt-1 space-y-1">
          <li>æŒ‰ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">/</kbd> èšç„¦æœå°‹</li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">h</kbd>ï¼šå›é¦–é </li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">m</kbd>ï¼šé–‹é¸å–®</li>
        </ul>
      </div>
    </aside>
  </div>
)}

        </div>
      );
    }

    // â€”â€” åŸºç¤ UI å…ƒä»¶ â€”â€”
    function NavItem({ label, active, onClick }){
  return (
    <button
      onClick={onClick}
      className={cx(
        'w-full text-left px-3 py-2 rounded-xl tap-target transition',
        active
          ? 'bg-brand/10 text-brand-fg border border-brand/30'
          : 'hover:bg-slate-100 dark:hover:bg-slate-800',
        // æ‰‹æ©Ÿ/éµç›¤çš„è§¸è¦ºå›é¥‹ï¼ˆæ²’æœ‰ hover ä¹Ÿæœ‰æ¸…æ¥šçš„ pressed/focus ç‹€æ…‹ï¼‰
        'active:bg-slate-100 dark:active:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50'
      )}
      // è¼”åŠ©æŠ€è¡“å¯è®€æ€§ï¼ˆé«˜äº®ç•¶å‰é ï¼‰
      aria-current={active ? 'page' : undefined}
    >
      {label}
    </button>
  );
}


function StickyBulkToggles({ onOpenAll, onCloseAll, className="" }) {
  return (
    <div className={cx(
      "sticky top-[60px] z-20 flex items-center gap-2 justify-end",
      className
    )}>
      <button
        type="button"
        onClick={onOpenAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨å±•é–‹"
        aria-label="å…¨éƒ¨å±•é–‹"
      >
        {/* å±•é–‹ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="6 15 12 9 18 15"></polyline>
        </svg>
      </button>
      <button
        type="button"
        onClick={onCloseAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨æ”¶åˆ"
        aria-label="å…¨éƒ¨æ”¶åˆ"
      >
        {/* æ”¶åˆ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="18 9 12 15 6 9"></polyline>
        </svg>
      </button>
    </div>
  );
}

   function Section({ title, subtitle, children }){
  return (
    <section className="animate-fadeIn">
      <div className="mb-3">
        <h2 className="text-[1.25rem] font-semibold tracking-tight">{title}</h2>
        {subtitle && <p className="text-[13px] text-slate-500 mt-1">{subtitle}</p>}
      </div>

      {/* åŸæœ¬çš„ .section-card æ”¹ç‚ºç›´æ¥å¥—å·¥å…·é¡ */}
      <div className="
        bg-white/80 dark:bg-slate-800/70 backdrop-blur
        border border-slate-200/70 dark:border-slate-700/60
        rounded-2xl
        shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
        hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
        transition-shadow
        p-4 sm:p-5
      ">
        {children}
      </div>
    </section>
  );
}



    function EmptyCard({ text, admin }){
      return (
        <div className="border border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 text-center text-slate-500">
          {text}
          {admin && <div className="mt-3 text-xs">ï¼ˆé€²å…¥ç®¡ç†å¾Œå¯æ–°å¢è³‡æ–™ï¼‰</div>}
        </div>
      );
    }

    // === Homeï¼ˆä¸»é ï¼‰ï¼šé—œæ–¼ï¼‹ç¤¾ç¾¤é€£çµï¼‹å¿«æ·å…¥å£ ===
function Home({ setTab, data, setData, admin }) {
  const { useState, useMemo, useEffect } = React;

  // === ä¾†æºè³‡æ–™ ===
  const about = data.homepage?.about ?? "é€™è£¡æ˜¯ã€Œé–‹çæ‰€ã€ï¼Œæä¾›æ­·å²æŠ½çç´€éŒ„ã€ç­‰å¾…é–‹çã€é€²è¡Œä¸­æ´»å‹•èˆ‡é»æ•¸å•†åŸç­‰è³‡è¨Šã€‚";
  const links = data.homepage?.links ?? []; // [{id, name, url}]

  // === å„€è¡¨æ¿çµ±è¨ˆï¼ˆå››æ ¼ï¼‰ ===
  // æ•¸å­—ç‚º 0 æ™‚å°±é¡¯ç¤º 0ï¼ˆä¸é¡¯ç¤ºä»»ä½•é¡å¤–æ–‡å­—ï¼‰
  const stats = useMemo(() => {
    const historyCount  = Array.isArray(data.history)         ? data.history.length        : 0;
    const pendingCount  = Array.isArray(data.pending)         ? data.pending.length        : 0;
    const ongoingCount  = Array.isArray(data.ongoing)         ? data.ongoing.length        : 0;
    const shopItemCount = Array.isArray(data.shop?.items)     ? data.shop.items.length     : 0;
    return [
      { key: 'history',  icon: 'ğŸ“š', label: 'æ­·å²ç´€éŒ„',    value: historyCount,  onClick: () => setTab('history') },
      { key: 'pending',  icon: 'â³', label: 'ç­‰å¾…é–‹ç',    value: pendingCount,  onClick: () => setTab('pending') },
      { key: 'ongoing',  icon: 'ğŸ”„', label: 'é€²è¡Œä¸­æ´»å‹•',  value: ongoingCount,  onClick: () => setTab('ongoing') },
      { key: 'shop',     icon: 'ğŸ›ï¸', label: 'å•†åŸå•†å“',    value: shopItemCount, onClick: () => setTab('shop') },
    ];
  }, [data, setTab]);

  // === ç½®é ‚å…¬å‘Š â†’ æ”¹ç‚ºé€²ç«™å½ˆçª—ï¼ˆåƒ…ç•¶æ¬¡é–‹å•Ÿé¡¯ç¤ºä¸€æ¬¡ï¼‰ ===
  const pinnedCards = useMemo(() => {
    const list = data.others?.cards || [];
    return list.filter(x => x.pin === true);
  }, [data.others]);

  const [showPinModal, setShowPinModal] = useState(false);

  useEffect(() => {
    // ä½¿ç”¨ sessionStorageï¼Œç¢ºä¿åŒä¸€æ¬¡é–‹å•ŸæœŸé–“åªé¡¯ç¤ºä¸€æ¬¡
    const SEEN_KEY = 'kjs_pin_modal_seen_v1';
    const seen = sessionStorage.getItem(SEEN_KEY);
    if (!seen && pinnedCards.length > 0) {
      setShowPinModal(true);
      sessionStorage.setItem(SEEN_KEY, '1');
    }
  }, [pinnedCards]);

  const closePinModal = () => setShowPinModal(false);

  // === ä¸»é ã€Œé—œæ–¼ã€èˆ‡ã€Œé€£çµã€è‰ç¨¿ ===
  const [draft, setDraft] = useState({ about, linkName: "", linkUrl: "" });

  const saveAbout = () => {
    if (!admin) return;
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links } });
    alert("å·²æ›´æ–°ä¸»é ä»‹ç´¹");
  };

  const addLink = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const name = (draft.linkName || "").trim();
    const url  = (draft.linkUrl  || "").trim();
    if (!name || !url) return alert("è«‹è¼¸å…¥é€£çµåç¨±èˆ‡ç¶²å€");
    if (!/^https?:\/\//i.test(url)) return alert("ç¶²å€éœ€ä»¥ http:// æˆ– https:// é–‹é ­");
    const next = [...links, { id: Math.random().toString(36).slice(2, 10), name, url }];
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
    setDraft(d => ({ ...d, linkName: "", linkUrl: "" }));
  };

  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm("åˆªé™¤æ­¤é€£çµï¼Ÿ")) return;
    const next = links.filter(x => x.id !== id);
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
  };

  // === å…¶ä»–è³‡æ–™ï¼ˆåœ¨é¦–é ä¸­ä»¥ç°¡åŒ–åˆ—è¡¨ç¤ºæ„ï¼Œæä¾›å‰å¾€æŒ‰éˆ•ï¼‰ ===
  const otherCards = useMemo(() => {
    const all = data.others?.cards || [];
    // ä¸é¡¯ç¤ºç½®é ‚çš„ï¼ˆç½®é ‚æ”¹ç”±å½ˆçª—é¡¯ç¤ºï¼‰ï¼Œåƒ…åˆ—éç½®é ‚å¡ç‰‡çš„å‰ 5 ç­†ä½œç‚ºé è¦½
    return all.filter(c => !c.pin).slice(0, 5);
  }, [data.others]);

  return (
    <Section title="ä¸»é ï¼šé–‹çæ‰€" subtitle="é¦–é è³‡è¨Šæ¿ƒç¸®ç‰ˆ">
      {/* 1) é—œæ–¼é€™å€‹ç¶²é ï¼ˆç¬¬ä¸€å€ï¼‰ */}
      <Collapse header="ğŸ§¾ é—œæ–¼é€™å€‹ç¶²é ï¼ˆé»æˆ‘å±•é–‹ï¼‰" defaultOpen={true}>
        {!admin && <p className="text-sm whitespace-pre-wrap">{about}</p>}
        {admin && (
          <div className="grid gap-3">
            <textarea
              className="rounded-lg border px-3 py-2 min-h-[100px]"
              value={draft.about}
              onChange={e => setDraft(d => ({ ...d, about: e.target.value }))}
              placeholder="ç°¡çŸ­ä»‹ç´¹æ­¤ç¶²é ã€ç”¨é€”èˆ‡è¦å‰‡é‡é»"
            />
            <div className="flex justify-end">
              <button onClick={saveAbout} className="rounded-lg bg-brand text-white px-4 py-2">
                å„²å­˜ä»‹ç´¹
              </button>
            </div>
          </div>
        )}
      </Collapse>

      {/* 2) å››æ ¼å„€è¡¨æ¿ï¼ˆç¬¬äºŒå€ï¼‰ */}
      <div
        className="
          my-4 grid gap-2
          grid-cols-2 sm:grid-cols-4
        "
        aria-label="é¦–é ç¸½è¦½å„€è¡¨æ¿"
      >
        {stats.map(s => (
          <button
            key={s.key}
            onClick={s.onClick}
            className="
              group rounded-2xl border border-slate-200 dark:border-slate-700
              bg-white/80 dark:bg-slate-800/70 backdrop-blur
              px-3 py-3 text-left shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
              hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
              transition
              focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50
              active:scale-[0.99]
            "
            title={s.label}
            aria-label={s.label}
          >
            <div className="flex items-center justify-between">
              <div className="text-xl leading-none">{s.icon}</div>
              <div className="text-[11px] text-slate-500 opacity-80 group-hover:opacity-100">
                é»æ“Šå‰å¾€
              </div>
            </div>
            <div className="mt-1 text-[13px] text-slate-500">{s.label}</div>
            <div className="mt-0.5 text-2xl font-semibold tabular-nums">{s.value}</div>
          </button>
        ))}
      </div>

      {/* 3) ç¤¾ç¾¤èˆ‡å®˜æ–¹é€£çµï¼ˆç¬¬ä¸‰å€ï¼‰ */}
      <Collapse header="ğŸ”— ç¤¾ç¾¤èˆ‡å®˜æ–¹é€£çµ" defaultOpen={false}>
        {links.length === 0 && <div className="text-sm text-slate-500">å°šæœªæ–°å¢é€£çµ</div>}
        <div className="grid gap-2">
          {links.map(x => (
            <div key={x.id} className="flex items-center justify-between rounded-lg border px-3 py-2">
              <a className="text-brand underline truncate" href={x.url} target="_blank" rel="noreferrer">
                {x.name}
              </a>
              {admin && (
                <button
                  onClick={() => removeLink(x.id)}
                  className="rounded-lg bg-red-500 text-white px-3 py-1.5 text-sm"
                >
                  åˆªé™¤
                </button>
              )}
            </div>
          ))}
        </div>
        {admin && (
          <div className="mt-3 grid sm:grid-cols-2 gap-2">
            <input
              className="rounded-lg border px-3 py-2"
              value={draft.linkName}
              onChange={e => setDraft(d => ({ ...d, linkName: e.target.value }))}
              placeholder="é€£çµåç¨±ï¼ˆä¾‹å¦‚ï¼šå®˜æ–¹ç¶²ç«™ / Facebook / IG / LINEï¼‰"
            />
            <input
              className="rounded-lg border px-3 py-2"
              value={draft.linkUrl}
              onChange={e => setDraft(d => ({ ...d, linkUrl: e.target.value }))}
              placeholder="é€£çµä½å€ï¼ˆhttps://...ï¼‰"
            />
            <div className="sm:col-span-2 flex justify-end">
              <button onClick={addLink} className="rounded-lg bg-brand text-white px-4 py-2">
                æ–°å¢é€£çµ
              </button>
            </div>
          </div>
        )}
      </Collapse>

      {/* 4) å…¶ä»–è³‡æ–™ï¼ˆç¬¬å››å€ï¼‰ */}
      <Collapse header="ğŸ“Œ å…¶ä»–è³‡æ–™" defaultOpen={false}>
        {otherCards.length === 0 ? (
          <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å…¶ä»–è³‡æ–™</div>
        ) : (
          <div className="grid gap-2">
            {otherCards.map(c => (
              <div key={c.id} className="rounded-lg border px-3 py-2">
                <div className="text-sm font-medium mb-1">{c.title || "æœªå‘½å"}</div>
                <div className="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">
                  {(c.content || "").split("\n").join(" / ")}
                </div>
              </div>
            ))}
          </div>
        )}
        <div className="mt-3 flex justify-end">
          <button onClick={() => setTab('others')} className="rounded-lg border px-3 py-1.5 text-sm">
            å‰å¾€ã€Œå…¶ä»–è³‡æ–™ã€
          </button>
        </div>
      </Collapse>

      {/* === ç½®é ‚å…¬å‘Šå½ˆçª—ï¼ˆåƒ…ç•¶æ¬¡é–‹å•Ÿé¡¯ç¤ºä¸€æ¬¡ï¼‰ === */}
      {showPinModal && (
        <div className="fixed inset-0 z-50">
          {/* èƒŒæ™¯é®ç½©ï¼šé»æ“Šé—œé–‰ */}
          <div className="absolute inset-0 bg-black/40" onClick={closePinModal} />
          {/* è¦–çª—æœ¬é«” */}
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div
              className="
                relative w-full max-w-md rounded-2xl
                bg-white dark:bg-slate-900
                border border-slate-200 dark:border-slate-700
                shadow-xl p-4
              "
              onClick={(e) => e.stopPropagation()}
              role="dialog"
              aria-modal="true"
              aria-label="ç½®é ‚å…¬å‘Š"
            >
              <div className="flex items-center justify-between mb-2">
                <div className="text-base font-semibold">ğŸ“£ æœ€æ–°å…¬å‘Š</div>
                <button
                  className="tap-target rounded-lg border px-2 py-1 text-sm"
                  onClick={closePinModal}
                  aria-label="é—œé–‰å…¬å‘Š"
                  title="é—œé–‰"
                >
                  âœ•
                </button>
              </div>

              <div className="grid gap-3 max-h-[60vh] overflow-auto pr-1">
                {pinnedCards.map((c) => (
                  <div key={c.id} className="rounded-lg border px-3 py-2">
                    <div className="text-sm font-medium mb-1">{c.title || "æœªå‘½å"}</div>
                    <div className="text-sm whitespace-pre-wrap">{c.content || "ï¼ˆç„¡å…§å®¹ï¼‰"}</div>
                  </div>
                ))}
              </div>

              <div className="mt-3 text-right">
                <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={closePinModal}>
                  æˆ‘çŸ¥é“äº†
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </Section>
  );
}

    function HomeShortcut({ label, onClick }) {
  return (
    <button
      onClick={onClick}
      className="rounded-xl2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-5 text-left shadow-soft hover:shadow-elevate transition-shadow"
    >
      <div className="text-base font-medium">{label}</div>
      <div className="text-xs text-slate-500 mt-1">é»æ“Šé€²å…¥</div>
    </button>
  );
}


// === Historyï¼ˆæ­·å²æŠ½çç´€éŒ„ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/è¤‡è£½åå–®ï¼ˆå«åˆ†é èˆ‡å½ˆå±¤æœˆæ›†ï¼‰ ===
function History({ data, admin, setData, query="", queryMode="all" }) {
  const [bulk, setBulk] = useState(null); // 'open' | 'close' | null
  const [draft, setDraft] = useState({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  const [editingId, setEditingId] = useState(null);
  const [showCal, setShowCal] = useState(false);

  // ğŸ“… æœˆæ›†ï¼šç›®å‰æª¢è¦–çš„å¹´æœˆï¼ˆUTCï¼‰èˆ‡è¢«ç¯©é¸æ—¥æœŸ
  const [cal, setCal] = useState(()=>{
    const now = new Date();
    return { y: now.getUTCFullYear(), m: now.getUTCMonth() }; // ä½¿ç”¨ UTC
  });
  const [filterDate, setFilterDate] = useState(""); // YYYY-MM-DDï¼ˆç©ºå­—ä¸²ï¼ä¸éæ¿¾ï¼‰

  // ç•¶æœˆæ—¥æ›†èˆ‡æ¯æ—¥ç´€éŒ„æ•¸
  const dayList = React.useMemo(()=> buildMonthDaysUTC(cal.y, cal.m), [cal]);
  const dateCounts = React.useMemo(()=>{
    const map = Object.create(null);
    for (const r of (data.history || [])) {
      const d = r?.date || "";
      if (!d) continue;
      map[d] = (map[d] || 0) + 1;
    }
    return map;
  }, [data.history]);

 // ç¯©é¸ï¼‹æœå°‹å¾Œçš„æ¸…å–®ï¼ˆå…ˆä¾æ—¥æœŸç¯©é¸ã€å†ä¾æœå°‹æ¨¡å¼ï¼‰
const items = React.useMemo(()=>{
  let list = data.history || [];

  // 1) æ—¥æœŸç¯©é¸
  if (filterDate) {
    list = list.filter(x => (x.date || "") === filterDate);
  }

  // 2) æœå°‹æ¨¡å¼
  const q = String(query || "").trim();
  if (!q) return list;

  return list.filter(rec => historyMatchByMode(rec, q, queryMode));
}, [data.history, filterDate, query, queryMode]);


  // === åˆ†é ï¼ˆå›ºå®šæ¯é  20 ç­†ï¼›History ç„¡ list/grid æ¨¡å¼ï¼‰ ===
  const [historyPage, setHistoryPage] = useLocalState('kjs_history_page', 1);
  const historyPageSize = 20;
  const historyTotal = items.length;
  const historyMaxPage = Math.max(1, Math.ceil(historyTotal / historyPageSize));

  React.useEffect(() => {
    if (historyPage > historyMaxPage) setHistoryPage(historyMaxPage);
  }, [historyPage, historyMaxPage, setHistoryPage]);

  // ç¯©é¸æˆ–æœå°‹è®ŠåŒ–æ™‚å›åˆ°ç¬¬ 1 é 
  React.useEffect(() => {
    setHistoryPage(1);
  }, [filterDate, query, setHistoryPage]);

  const historyStart = (historyPage - 1) * historyPageSize;
  const historyEnd = Math.min(historyStart + historyPageSize, historyTotal);
  const historyPageItems = items.slice(historyStart, historyEnd);

  // é ç¢¼è¦–çª—ï¼ˆæœ€å¤š 5 æ ¼ï¼‰
  const historyWindowSize = 5;
  const historyStartPage = Math.max(
    1,
    Math.min(historyPage - Math.floor(historyWindowSize / 2), historyMaxPage - historyWindowSize + 1)
  );
  const historyEndPage = Math.min(historyMaxPage, historyStartPage + historyWindowSize - 1);

  // â€”â€” å‹•ä½œï¼šå­˜æª” / ç·¨è¼¯ / å–æ¶ˆ / åˆªé™¤ / è¤‡è£½ â€”â€” //
  const saveRecord = () => {
    if (!admin) return alert('è«‹é€²å…¥ç®¡ç†æ¨¡å¼');
    if (!draft.title) return alert('è«‹å¡«å¯«ã€çé …åç¨±ã€‘');

    const dateText = draft.date || "";
    const ts = parseISODate(dateText);
    if (dateText && Number.isNaN(ts)) return alert("æ—¥æœŸæ ¼å¼éœ€ç‚º YYYY-MM-DDï¼ˆä¾‹å¦‚ 2025-08-30ï¼‰");

    const rawLines = String(draft.winnersText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const winners = parseLinesClean(draft.winnersText);
    const removedDup = Math.max(0, rawLines.length - winners.length);

    const winnerCount = Number(draft.winnerCount || winners.length || 0);
    const totalParticipants = Number(draft.totalParticipants || 0);
    if (winnerCount < 0 || totalParticipants < 0) return alert("åé¡èˆ‡ç¸½åƒèˆ‡äººæ•¸éœ€ç‚º 0 æˆ–æ­£æ•´æ•¸");

    const summary = [
      `ç¢ºèªè¦${editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}å—ï¼Ÿ`,
      `çé …åç¨±ï¼š${draft.title}`,
      `æ—¥æœŸï¼š${dateText || "ï¼ˆæœªå¡«ï¼‰"}`,
      `å¾—çè€…äººæ•¸ï¼š${winners.length}${removedDup ? `ï¼ˆå·²è‡ªå‹•å»é‡ ${removedDup} ç­†ï¼‰` : ""}`,
      `æŠ½å‡ºåé¡ï¼š${winnerCount}`,
      `ç¸½åƒèˆ‡äººæ•¸ï¼š${totalParticipants || "ï¼ˆæœªå¡«ï¼‰"}`
    ].join("\n");
    if (!confirm(summary)) return;

    const rec = {
      id: editingId || Math.random().toString(36).slice(2,10),
      title: draft.title,
      date: dateText,
      winners,
      winnerCount,
      totalParticipants,
      youtube: draft.youtube || "",
      status: draft.status || "",
      note: draft.note || ""
    };

    const base = data.history || [];
    const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];
    const sorted = sortHistoryDesc(next); // å­˜æª”å³æ’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
    setData({ ...data, history: sorted });

    setEditingId(null);
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  };

  const editRecord = (x) => {
    if (!admin) return;
    setEditingId(x.id);
    setDraft({
      date: x.date||'',
      title: x.title||'',
      winnersText: (x.winners||[]).join('\n'),
      winnerCount: String(x.winnerCount??''),
      totalParticipants: String(x.totalParticipants??''),
      youtube: x.youtube||'',
      status: x.status||'',
      note: x.note||''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
    setEditingId(null);
  };

  const removeRecord = (id) => {
    if (!admin) return;
    if (!confirm('åˆªé™¤æ­¤ç­†æ­·å²ç´€éŒ„ï¼Ÿ')) return;
    setData({ ...data, history: (data.history || []).filter(x => x.id !== id) });
  };

  const copyWinners = (arr=[]) => navigator.clipboard.writeText((arr||[]).join('\n')).then(()=>alert('å·²è¤‡è£½å¾—çè€…åå–®'));

  // â€”â€” ç•«é¢ â€”â€” //
  return (
    <Section title="ğŸ“š æ­·å²æŠ½çç´€éŒ„" subtitle="å®Œæ•´æ­·å±†æ´»å‹•ç´€éŒ„ã€‚">
      {/* ğŸ“… æœˆæ›†å¿«ç¯©ï¼ˆé ‚éƒ¨ï¼‰â€” å°æŒ‰éˆ• + å½ˆå±¤ */}
      <div className="flex items-center justify-between mb-3">
  <div className="text-sm text-slate-500">ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸</div>
  <div className="flex items-center gap-2">
    {filterDate && (
      <button
        type="button"
        className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
        title="æ¸…é™¤æ—¥æœŸç¯©é¸ï¼Œæ¢å¾©å…¨éƒ¨ç€è¦½"
        onClick={() => { setFilterDate(""); setHistoryPage(1); }}
      >
        æ¸…é™¤ç¯©é¸
      </button>
    )}
    <button
      onClick={()=>setShowCal(true)}
      className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
      title="é–‹å•Ÿæœˆæ›†"
    >
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      æœˆæ›†
    </button>
  </div>
</div>


      {/* ç•¶å‰ç¯©é¸æç¤º */}
      <div className="text-xs text-slate-500 mb-3">
        {filterDate
          ? <>å·²å¥—ç”¨æ—¥æœŸç¯©é¸ï¼š<b>{filterDate}</b>ï¼ˆé»æœˆæ›†æ¸…é™¤ï¼‰</>
          : <>å¯ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸ç´€éŒ„</>}
      </div>

      {/* å½ˆå±¤æœˆæ›†ï¼ˆé®ç½© + ç½®ä¸­å¡ç‰‡ï¼‰ */}
      {showCal && (
  <div className="fixed inset-0 z-50" onClick={()=>setShowCal(false)}>
    {/* é»‘è‰²é®ç½©ï¼ˆæ­¤å±¤ä¸å†éœ€è¦ onClickï¼Œç¶­æŒè¦–è¦ºï¼‰ */}
    <div className="absolute inset-0 bg-black/40" />
    <div className="absolute inset-0 flex items-center justify-center p-4">
      {/* å¡ç‰‡ä¸»é«”ï¼šé˜»æ­¢å†’æ³¡ï¼Œé¿å…é»æ“Šå¡ç‰‡å…§éƒ¨ä¹Ÿè¢«ç•¶æˆé—œé–‰ */}
      <div
        className="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4"
        onClick={(e)=>e.stopPropagation()}
      >
        <div className="flex items-center justify-between">
          <div className="text-sm font-medium">{cal.y} å¹´ {cal.m + 1} æœˆ</div>
          <div className="flex items-center gap-1">
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m-1<0?{y:y-1,m:11}:{y,m:m-1})); }}
              title="å‰ä¸€å€‹æœˆ"
            >â€¹</button>
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m+1>11?{y:y+1,m:0}:{y,m:m+1})); }}
              title="ä¸‹ä¸€å€‹æœˆ"
            >â€º</button>
            {/* ç›´æ¥åœ¨å½ˆå±¤å…§æä¾›ã€Œæ¸…é™¤ã€ï¼šä¸€éµæ¢å¾©å…¨éƒ¨ç€è¦½ */}
            {filterDate && (
              <button
                className="rounded-lg border px-2 py-1.5 text-sm"
                onClick={()=>{ setFilterDate(""); setHistoryPage(1); }}
                title="æ¸…é™¤æ—¥æœŸç¯©é¸"
              >
                æ¸…é™¤
              </button>
            )}
            {/* é¡å¤–çš„é—œé–‰æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰ */}
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>setShowCal(false)}
              title="é—œé–‰"
            >âœ•</button>
          </div>
        </div>

        {/* æ˜ŸæœŸåˆ— */}
        <div className="grid grid-cols-7 text-xs text-slate-500 mt-3">
          {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((w,i)=>(<div key={i} className="px-1 py-1 text-center">{w}</div>))}
        </div>

        {/* æ—¥æ›†æ ¼ */}
        <div className="grid grid-cols-7 gap-1 mt-1">
          {dayList.map((d, i)=>{
            if (!d) return <div key={i} className="h-9 rounded-lg" />;
            const count = dateCounts[d] || 0;
            const active = !!count;
            const selected = filterDate === d;
            return (
              <button
                key={i}
                onClick={()=>{
                  setFilterDate(prev => prev === d ? "" : d);
                  setHistoryPage(1);
                  setShowCal(false);
                }}
                className={[
                  "h-9 rounded-lg border text-sm flex flex-col items-center justify-center",
                  selected ? "border-brand bg-brand/10" : "border-slate-200 dark:border-slate-700",
                  active ? "hover:bg-slate-50 dark:hover:bg-slate-800" : "opacity-60"
                ].join(" ")}
                title={active ? `æ­¤æ—¥å…±æœ‰ ${count} ç­†ç´€éŒ„` : "æ­¤æ—¥æ²’æœ‰ç´€éŒ„"}
              >
                <div className="leading-none">{parseInt(d.slice(-2),10)}</div>
                {active && (
                  <div className="text-[10px] leading-none mt-0.5 inline-flex items-center px-1 rounded border bg-white/70 dark:bg-slate-800/70">
                    {count}
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  </div>
)}


      {/* ç®¡ç†è¡¨å–® */}
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d,date:e.target.value}))} placeholder="æˆªæ­¢/é–‹çæ—¥æœŸ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="çé …åç¨±"/>
            <input className="rounded-lg border px-3 py-2" value={draft.winnerCount} onChange={e=>setDraft(d=>({...d,winnerCount:e.target.value}))} placeholder="æŠ½å‡ºåé¡ï¼ˆç•™ç©ºï¼ä»¥åå–®æ•¸é‡ï¼‰"/>
            <input className="rounded-lg border px-3 py-2" value={draft.totalParticipants} onChange={e=>setDraft(d=>({...d,totalParticipants:e.target.value}))} placeholder="ç¸½åƒèˆ‡äººæ•¸"/>
            <input className="rounded-lg border px-3 py-2 sm:col-span-2" value={draft.youtube} onChange={e=>setDraft(d=>({...d,youtube:e.target.value}))} placeholder="æŠ½çå½±ç‰‡ï¼ˆYouTube é€£çµï¼Œå¯ç©ºç™½ï¼‰"/>
            <select
              className="rounded-lg border px-3 py-2"
              value={draft.status}
              onChange={e=>setDraft(d=>({...d,status:e.target.value}))}
            >
              <option value="">ï¼ˆä¸å¡«ï¼‰</option>
              {HISTORY_STATUS_OPTIONS.map(opt=>(
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
            </select>
            <input className="rounded-lg border px-3 py-2" value={draft.note} onChange={e=>setDraft(d=>({...d,note:e.target.value}))} placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">å¾—çè€…åå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
            <textarea className="mt-1 w-full rounded-lg border px-3 py-2 min-h-[120px]" value={draft.winnersText} onChange={e=>setDraft(d=>({...d,winnersText:e.target.value}))} placeholder="ä¸€è¡Œä¸€å€‹ LINE æš±ç¨±"></textarea>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveRecord} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      {/* å…¨å±•/å…¨æ”¶ï¼ˆåƒ…å°ç•¶é æœ‰æ•ˆï¼‰ */}
      <div className="flex gap-2 justify-end mt-4">
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('open')}>å…¨éƒ¨å±•é–‹</button>
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('close')}>å…¨éƒ¨æ”¶åˆ</button>
      </div>

      {/* æ¸…å–®ï¼ˆç•¶é è³‡æ–™ï¼‰ */}
      <div className="grid gap-4 mt-4">
        {historyPageItems.map(x => (
          <Collapse
            key={x.id}
            header={
              <div className="flex items-center gap-3">
                <span className="inline-flex items-center px-2 py-0.5 rounded border text-xs bg-white/70 dark:bg-slate-800/70">
                  {x.date || "æœªå¡«æ—¥æœŸ"}
                </span>
                <span className="text-sm font-medium truncate">{x.title || "æœªå‘½å"}</span>
              </div>
            }
            force={bulk}
          >
            <div className="text-sm grid sm:grid-cols-2 gap-x-6 gap-y-1">
              <div>æŠ½å‡ºåé¡ï¼š{x.winnerCount ?? (x.winners?.length||0)}</div>
              <div>ç¸½åƒèˆ‡äººæ•¸ï¼š{x.totalParticipants ?? '-'}</div>
              {x.youtube && (
                <div className="sm:col-span-2 truncate">
                  å½±ç‰‡ï¼š<a className="text-brand underline" href={x.youtube} target="_blank" rel="noreferrer">{x.youtube}</a>
                </div>
              )}
              {x.status && (
  <div className="sm:col-span-2">
    <StatusTag value={x.status} />
  </div>
)}

              {x.note && <div className="sm:col-span-2">å‚™è¨»ï¼š{x.note}</div>}
            </div>

            <div className="mt-3">
              <div className="text-sm text-slate-500 mb-1">å¾—çè€…ï¼š</div>
              <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
                {(x.winners||[]).join('\n')}
              </pre>
            </div>

            <div className="mt-3 flex gap-2 justify-end">
              <button onClick={()=>copyWinners(x.winners)} className="rounded-lg border px-3 py-1.5">è¤‡è£½åå–®</button>
              {admin && (
                <>
                  <button onClick={()=>editRecord(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
                  <button onClick={()=>removeRecord(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
                </>
              )}
            </div>
          </Collapse>
        ))}
      </div>

      {/* åˆ†é æ§åˆ¶ï¼ˆHistoryï¼‰ */}
      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage <= 1}
          onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
        >
          ä¸Šä¸€é 
        </button>

        {Array.from({ length: (historyEndPage - historyStartPage + 1) }, (_, i) => historyStartPage + i).map(p => (
          <button
            key={p}
            type="button"
            className={`rounded-lg border px-3 py-1.5 text-sm ${p === historyPage ? 'bg-brand text-white border-brand' : ''}`}
            onClick={() => setHistoryPage(p)}
          >
            {p}
          </button>
        ))}

        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage >= historyMaxPage}
          onClick={() => setHistoryPage(p => Math.min(historyMaxPage, p + 1))}
        >
          ä¸‹ä¸€é 
        </button>
      </div>
    </Section>
  );
}

// === Pendingï¼ˆç­‰å¾…é–‹çï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/è¤‡è£½åå–®/è½‰æ­·å² ===
function Pending({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);


const [draft, setDraft] = useState({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  const [editingId, setEditingId] = useState(null);

  // å­˜æ¯å¼µå¡ç‰‡çš„æ¨¡æ“¬çµæœï¼šsim[id] = { winners:[], seedUsed:"", taken: number }
  const [sim, setSim] = useState({});

  // ğŸ‘€ æª¢è¦–æ¨¡å¼ï¼šlist | grid9 | grid16ï¼ˆç”¨ localStorage è¨˜ä½åå¥½ï¼‰
  const [view, setView] = useLocalState('kjs_view_pending', 'list');

const [selectMode, setSelectMode] = useState(false);
// å‹¾é¸æš«å­˜ï¼ˆæ¯å¼µå¡ç‰‡å„è‡ªä¸€çµ„ï¼‰
const [selected, setSelected] = useState({}); // selected[pendingId] = Set(names)

  const limits = data.settings || DEFAULT_SETTINGS;

  const participants = React.useMemo(
    () => parseLinesClean(draft.participantsText),
    [draft.participantsText]
  );

  const items = React.useMemo(()=>{
    const list = data.pending || [];
    const q = String(query).trim().toLowerCase();
    if(!q) return list;
    return list.filter(x=>{
      if((x.title||"").toLowerCase().includes(q)) return true;
      return (x.participants||[]).some(p => String(p).toLowerCase().includes(q));
    });
  },[data.pending, query]);

// === åˆ†é ï¼ˆPendingï¼‰â€” æ”¾åœ¨ view èˆ‡ items ä¹‹å¾Œ ===
const [pendingPage, setPendingPage] = useLocalState('kjs_pending_page', 1);
const pendingPageSize = 20;

const pendingTotal = items.length;
const pendingMaxPage = Math.max(1, Math.ceil(pendingTotal / pendingPageSize));

React.useEffect(() => {
  if (pendingPage > pendingMaxPage) setPendingPage(pendingMaxPage);
}, [pendingPage, pendingMaxPage, setPendingPage]);

React.useEffect(() => {
  setPendingPage(1);
}, [view, query, setPendingPage]);

const pendingStart = (pendingPage - 1) * pendingPageSize;
const pendingEnd = Math.min(pendingStart + pendingPageSize, pendingTotal);
const pendingPageItems = items.slice(pendingStart, pendingEnd);

const pendingWindowSize = 5;
const pendingStartPage = Math.max(
  1,
  Math.min(pendingPage - Math.floor(pendingWindowSize / 2), pendingMaxPage - pendingWindowSize + 1)
);
const pendingEndPage = Math.min(pendingMaxPage, pendingStartPage + pendingWindowSize - 1);

  const savePending = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«ã€çé …åç¨±ã€‘");

    const dateText = draft.date || "";
    const ts = parseISODate(dateText);
    if (dateText && Number.isNaN(ts)) return alert("é–‹çæ—¥æœŸæ ¼å¼éœ€ç‚º YYYY-MM-DDï¼ˆä¾‹å¦‚ 2025-08-30ï¼‰");

    const rawLines = String(draft.participantsText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const cleaned = parseLinesClean(draft.participantsText);
    const removedDup = Math.max(0, rawLines.length - cleaned.length);

    const planned = draft.plannedWinners ? Number(draft.plannedWinners) : undefined;
    const summary = [
      `ç¢ºèªè¦${editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢æ´»å‹•"}å—ï¼Ÿ`,
      `çé …åç¨±ï¼š${draft.title}`,
      `é–‹çæ—¥æœŸï¼š${dateText || "ï¼ˆæœªå¡«ï¼‰"}`,
      `åƒèˆ‡äººæ•¸ï¼š${cleaned.length}${removedDup ? `ï¼ˆå·²è‡ªå‹•å»é‡ ${removedDup} ç­†ï¼‰` : ""}`,
      typeof planned === 'number' ? `é è¨ˆæŠ½å‡ºåé¡ï¼š${planned}` : null
    ].filter(Boolean).join("\n");
    if (!confirm(summary)) return;

    const patch = { title: draft.title, deadline: dateText, image: draft.image || "", participants: cleaned };
    if (Number.isFinite(planned)) patch.plannedWinners = planned;

    const base = data.pending || [];
    if (editingId) {
      const next = base.map(x => x.id===editingId ? { ...x, ...patch } : x);
      setData({ ...data, pending: next });
      setEditingId(null);
    } else {
      const rec = { id: Math.random().toString(36).slice(2,10), ...patch };
      setData({ ...data, pending: [rec, ...base] });
    }

    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  };

  const editPending = (x) => {
    if (!admin) return;
    setEditingId(x.id);
    setDraft({
      date: x.deadline||"",
      title: x.title||"",
      image: x.image||"",
      participantsText: (x.participants||[]).join("\n"),
      plannedWinners: typeof x.plannedWinners === 'number' ? String(x.plannedWinners) : ""
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const cancelEdit = () => {
    setEditingId(null);
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  };

  const removePending = (id) => {
    if (!admin) return;
    if (!confirm("åˆªé™¤æ­¤ç­†ç­‰å¾…é–‹çæ´»å‹•ï¼Ÿ")) return;
    setData({ ...data, pending: (data.pending || []).filter(x => x.id !== id) });
  };

  const copyParticipants = (arr=[]) =>
    navigator.clipboard.writeText((arr||[]).join("\n")).then(()=>alert("å·²è¤‡è£½å ±ååå–®"));

  const moveToHistory = (id) => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const it = (data.pending || []).find(x => x.id === id);
    if (!it) return;
    if (!confirm("å°‡æ­¤æ´»å‹•è½‰åˆ°ã€Œæ­·å²æŠ½çç´€éŒ„ã€ï¼Ÿï¼ˆä¸æŠ½ç±¤ï¼Œåå–®å°‡ç›´æ¥è¦–ç‚ºå¾—çè€…ï¼‰")) return;

    const winners = parseLinesClean((it.participants || []).join("\n"));
    const rec = {
      id: Math.random().toString(36).slice(2, 10),
      title: it.title,
      date: it.deadline || "",
      winners,
      winnerCount: winners.length,
      totalParticipants: winners.length,
      youtube: "",
      status: "å·²çµæŸï¼ˆç”±ç­‰å¾…é–‹çè½‰å…¥ï¼‰",
      note: ""
    };

    const nextHistory = sortHistoryDesc([rec, ...(data.history || [])]);
    setData({
      ...data,
      pending: (data.pending || []).filter(x => x.id !== id),
      history: nextHistory
    });
    alert("å·²è½‰å…¥æ­·å²ï¼›è«‹åˆ°ã€ŒğŸ“š æ­·å²æŠ½çç´€éŒ„ã€è£œå½±ç‰‡èˆ‡å‚™è¨»ã€‚");
  };

  const HasImageInput = typeof ImageInput === "function";

  // âœ… é‡é»ï¼šç”¨ Fragment åŒ…ä½é ‚éƒ¨ã€Œæª¢è¦–åˆ‡æ›ã€å’Œ Sectionï¼Œé¿å…å›å‚³å¤šå€‹æ ¹ç¯€é»
  return (
    <>
      {/* ğŸ‘€ æª¢è¦–åˆ‡æ›ï¼šåˆ—è¡¨ / 9 / 16 */}
      <div className="mb-4 flex items-center gap-2">
        <span className="text-sm text-slate-500">æª¢è¦–ï¼š</span>
<button
  onClick={()=>setView('list')}
  className={`rounded-lg border px-3 py-1.5 text-sm ${view==='list' ? 'bg-brand text-white border-brand' : ''}`}
  title="åˆ—è¡¨"
>â‰¡</button>
<button
  onClick={()=>setView('grid9')}
  className={`rounded-lg border px-3 py-1.5 text-sm ${view==='grid9' ? 'bg-brand text-white border-brand' : ''}`}
  title="9 å®®æ ¼"
>â–¦</button>
<button
  onClick={()=>setView('grid16')}
  className={`rounded-lg border px-3 py-1.5 text-sm ${view==='grid16' ? 'bg-brand text-white border-brand' : ''}`}
  title="16 å®®æ ¼"
>â–©</button>

        <div className="ml-auto text-xs text-slate-500">ï¼ˆåˆ‡åˆ°å®®æ ¼æœƒè‡ªå‹•å±•é–‹å¡ç‰‡ï¼‰</div>
      </div>

      <Section title="â³ ç­‰å¾…é–‹ç" subtitle="å ±åä¸­/å°šæœªæŠ½å‡ºã€‚å®Œæ•´åå–®å¯ä¸€éµè¤‡è£½åšæŠ½çç”¨ã€‚">
        {admin && (
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
            <div className="grid sm:grid-cols-2 gap-3">
              <input className="rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d,date:e.target.value}))} placeholder="é–‹çæ—¥æœŸ"/>
              <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="çé …åç¨±"/>
              <input className="rounded-lg border px-3 py-2" value={draft.plannedWinners} onChange={e=>setDraft(d=>({...d, plannedWinners: e.target.value.replace(/[^0-9]/g,'')}))} placeholder="é è¨ˆæŠ½å‡ºåé¡ï¼ˆæ•´æ•¸ï¼‰"/>
              <div className="sm:col-span-2">
                {HasImageInput
                  ? <ImageInput label="çé …åœ–ç‰‡" value={draft.image} onChange={(v)=>setDraft(d=>({...d,image:v}))}/>
                  : <input className="rounded-lg border px-3 py-2 w-full" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="çé …åœ–ç‰‡ï¼ˆç¶²å€æˆ– base64ï¼‰"/>}
              </div>
            </div>
            <div>
              <label className="text-sm text-slate-500">å·²æˆåŠŸå ±ååå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
              <textarea className="mt-1 w-full rounded-lg border px-3 py-2 min-h-[140px]" value={draft.participantsText} onChange={e=>setDraft(d=>({...d,participantsText:e.target.value}))} placeholder="ä¸€è¡Œä¸€å€‹ LINE æš±ç¨±"></textarea>
              <div className="mt-1 text-xs text-slate-500">ç›®å‰åƒèˆ‡äººæ•¸ï¼š{participants.length}</div>
            </div>
            <div className="flex gap-2 justify-end">
              {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
              <button onClick={savePending} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢æ´»å‹•"}</button>
            </div>
          </div>
        )}

        {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

        <div className="flex gap-2 justify-end mt-4">
          {view === 'list' ? (
            <>
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('open')}>å…¨éƒ¨å±•é–‹</button>
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('close')}>å…¨éƒ¨æ”¶åˆ</button>
              
            </>
          ) : (
            <span className="text-xs text-slate-500">ï¼ˆå®®æ ¼æª¢è¦–ï¼šé»å¡ç‰‡å±•é–‹ï¼‰</span>

          )}
        </div>

{/* ğŸ” ç½®é ‚æ‰¹æ¬¡é–‹åˆï¼ˆç­‰å¾…é–‹çï¼‰ */}
<StickyBulkToggles
  onOpenAll={()=> setBulk('open')}
  onCloseAll={()=> setBulk('close')}
/>

        {/* ä¾æª¢è¦–æ¨¡å¼åˆ‡æ›å®¹å™¨ç¶²æ ¼ï¼›å®®æ ¼æ¨¡å¼å›ºå®šå±•é–‹ */}
<div
  className={
    view === "list"
      ? "grid gap-4 mt-4"
      : view === "grid9"
      ? "grid gap-4 mt-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"
      : "grid gap-4 mt-4 grid-cols-2 md:grid-cols-3 xl:grid-cols-4"
  }
>
  {pendingPageItems.map(x => (
    <Collapse
      key={x.id}
            header={
  view === 'list' ? (
    /* åˆ—è¡¨ï¼šåªé¡¯ç¤º é–‹çæ—¥æœŸ + çå“åç¨±ï¼ˆä¸é¡¯ç¤ºåœ–ç‰‡ï¼‰ */
    <div className="flex items-center gap-3">
      <span className="inline-flex items-center px-2 py-0.5 rounded border text-xs bg-white/70 dark:bg-slate-800/70">
        {x.deadline || "æœªå¡«æ—¥æœŸ"}
      </span>
      <span className="text-sm font-medium truncate">{x.title || "æœªå‘½å"}</span>
    </div>
  ) : (
    /* å®®æ ¼ï¼šå®Œæ•´åœ–ç‰‡ + åç¨±ï¼ˆé»æ“Šæ‰å±•é–‹å…§å®¹ï¼‰ */
    <div className="w-full">
      <div className="w-full aspect-square rounded-lg bg-slate-50 dark:bg-slate-800 overflow-hidden flex items-center justify-center">
        {x.image ? (
          <img src={x.image} alt="" className="w-full h-full object-contain" loading="lazy" />
        ) : (
          <div className="text-xs text-slate-500">ç„¡åœ–</div>
        )}
      </div>
      <div className="mt-2 text-sm font-medium">
        {(x.title || 'æœªå‘½å').length > 18
          ? (x.title || 'æœªå‘½å').slice(0, 18) + '****'
          : (x.title || 'æœªå‘½å')}
      </div>
    </div>
  )
}



      force={view === "list" ? bulk : "close"}

    >
     

      <div className="mt-3 text-sm">
        ç›®å‰åƒèˆ‡äººæ•¸ï¼š{x.participants?.length || 0}
      </div>

      {typeof x.plannedWinners === "number" && (
        <div className="text-sm">é è¨ˆæŠ½å‡ºåé¡ï¼š{x.plannedWinners}</div>
      )}

      {admin && (
        <div className="mt-2">
          <label className="inline-flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={!!selectMode}
              onChange={(e) => setSelectMode(e.target.checked)}
            />
            é¸å–å¾—çè€…æ¨¡å¼ï¼ˆæ‰‹å‹•å‹¾é¸ï¼‰
          </label>
        </div>
      )}

      {/* åå–®å€ */}
      <div className="mt-2">
        <div className="text-sm text-slate-500 mb-1">å·²æˆåŠŸå ±ååå–®ï¼š</div>

        {!selectMode ? (
          <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
            {(x.participants || []).join("\n")}
          </pre>
        ) : (
          <div className="rounded-lg bg-slate-50 dark:bg-slate-800 p-3 max-h-56 overflow-auto">
            {(x.participants || []).map((name) => {
              const set = selected[x.id] || new Set();
              const checked = set.has(name);
              return (
                <label
                  key={`${x.id}-${name}`}
                  className="flex items-center gap-2 text-sm py-0.5"
                >
                  <input
                    type="checkbox"
                    checked={checked}
                    onChange={(e) => {
                      setSelected((prev) => {
                        const cur = new Set(prev[x.id] || []);
                        if (e.target.checked) cur.add(name);
                        else cur.delete(name);
                        return { ...prev, [x.id]: cur };
                      });
                    }}
                  />
                  <span className="truncate">{name}</span>
                </label>
              );
            })}
          </div>
        )}
      </div>

      {/* ğŸ² æŠ½çæ¨¡æ“¬ï¼ˆä¸å¯«å›è³‡æ–™ï¼‰ */}
      <div className="mt-4 rounded-lg border border-slate-200 dark:border-slate-700 p-3">
        <div className="flex items-center justify-between mb-2">
          <div className="text-sm font-medium flex items-center gap-2">
            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border">
              æ¨¡æ“¬çµæœï¼ˆéæ­£å¼ï¼‰
            </span>
            <span className="text-slate-500">ä¸æœƒæ›´å‹•è³‡æ–™</span>
          </div>
        </div>

        <div className="grid sm:grid-cols-3 gap-2">
          <input
            className="rounded-lg border px-3 py-2 text-sm"
            type="number"
            min="1"
            defaultValue={
              typeof x.plannedWinners === "number" && x.plannedWinners > 0
                ? x.plannedWinners
                : 1
            }
            placeholder="æŠ½å‡ºåé¡"
            id={`draw-count-${x.id}`}
          />
          <input
            className="rounded-lg border px-3 py-2 text-sm"
            placeholder="ç¨®å­ï¼ˆå¯ç•™ç™½ï¼Œç•™ç™½ä½¿ç”¨å®‰å…¨éš¨æ©Ÿï¼‰"
            id={`draw-seed-${x.id}`}
          />
          <button
            className="rounded-lg bg-brand text-white px-4 py-2 text-sm"
            onClick={() => {
              const participants = (x.participants || []).slice();
              const total = participants.length;
              if (total === 0) {
                alert("æ²’æœ‰å¯æŠ½åå–®");
                return;
              }
              const countEl = document.getElementById(`draw-count-${x.id}`);
              const seedEl = document.getElementById(`draw-seed-${x.id}`);
              const want = Math.max(
                1,
                parseInt(countEl?.value || "1", 10)
              );
              const maxAllowed = Math.min(
                total,
                (data.settings || DEFAULT_SETTINGS).drawMaxPerRun
              );
              if (want > total) {
                alert(`æŠ½å‡ºåé¡ä¸å¯è¶…éåƒèˆ‡äººæ•¸ï¼ˆåƒèˆ‡ ${total} äººï¼‰`);
                return;
              }
              if (want > maxAllowed) {
                alert(`æŠ½å‡ºåé¡ä¸å¯è¶…éä¸Šé™ ${maxAllowed}`);
                return;
              }

              const key = drawCooldownKey(x.id);
              const now = Date.now();
              const last = parseInt(localStorage.getItem(key) || "0", 10);
              const waitMs = Math.max(
                0,
                (data.settings || DEFAULT_SETTINGS).drawCooldownSec * 1000 -
                  (now - last)
              );
              if (waitMs > 0) {
                const sec = Math.ceil(waitMs / 1000);
                alert(`è«‹ç¨å€™ ${sec} ç§’å†è©¦`);
                return;
              }

              const seedStr = (seedEl?.value || "").trim();
              const prng = makePRNG(seedStr);
              const cleaned = parseLinesClean(participants.join("\n"));
              const winners = shufflePick(cleaned, want, prng);

              const pool = cleaned.slice(0, Math.min(20, cleaned.length));
              setSim((prev) => ({
                ...prev,
                [x.id]: { anim: true, rolling: pool, taken: want, seedUsed: seedStr },
              }));
              localStorage.setItem(key, String(now));

              setTimeout(() => {
                setSim((prev) => ({
                  ...prev,
                  [x.id]: { winners, seedUsed: seedStr, taken: want },
                }));
              }, 1200);
            }}
          >
            é–‹å§‹æ¨¡æ“¬
          </button>
        </div>

        {sim[x.id]?.anim && (
          <div className="mt-3">
            <div className="text-xs text-slate-500 mb-1">æŠ½çä¸­â€¦</div>
            <div className="rounded-lg bg-slate-50 dark:bg-slate-800 p-3 h-24 overflow-hidden">
              <div className="animate-pulseSoft text-sm">
                {(sim[x.id].rolling || [])
                  .sort(() => Math.random() - 0.5)
                  .slice(0, 5)
                  .map((n, i) => (
                    <div key={i} className="py-0.5">
                      {n}
                    </div>
                  ))}
              </div>
            </div>
          </div>
        )}

        {sim[x.id]?.winners?.length > 0 && (
          <div className="mt-3">
            <div className="text-xs text-slate-500 mb-1">
              æŠ½å‡º {sim[x.id].taken} ä½ï½œ
              Seedï¼š
              {sim[x.id].seedUsed ? sim[x.id].seedUsed : "å®‰å…¨éš¨æ©Ÿ"}
              {sim[x.id].winners.length >
                (data.settings || DEFAULT_SETTINGS).drawPublicShowLimit &&
                `ï¼ˆåƒ…é¡¯ç¤ºå‰ ${
                  (data.settings || DEFAULT_SETTINGS).drawPublicShowLimit
                } ä½ï¼‰`}
            </div>
            <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
              {sim[x.id].winners
                .slice(
                  0,
                  (data.settings || DEFAULT_SETTINGS).drawPublicShowLimit
                )
                .join("\n")}
            </pre>
            <div className="mt-2 flex gap-2 justify-end">
              <button
                className="rounded-lg border px-3 py-1.5 text-sm"
                onClick={() => {
                  const title = x.title || "æœªå‘½åæ´»å‹•";
                  const date = x.deadline || "(æœªå¡«æ—¥æœŸ)";
                  const seed = sim[x.id]?.seedUsed
                    ? sim[x.id].seedUsed
                    : "å®‰å…¨éš¨æ©Ÿ";
                  const lines = (sim[x.id]?.winners || []).join("\n");
                  const text = `ã€æŠ½çæ¨¡æ“¬çµæœã€‘\næ´»å‹•ï¼š${title}\næ—¥æœŸï¼š${date}\nSeedï¼š${seed}\nåé¡ï¼š${
                    sim[x.id]?.taken || 0
                  }\nâ€”â€”â€”\n${lines}`;
                  navigator.clipboard
                    .writeText(text)
                    .then(() => alert("å·²è¤‡è£½æ¨¡æ“¬çµæœ"));
                }}
              >
                è¤‡è£½æ¨¡æ“¬çµæœ
              </button>
            </div>
          </div>
        )}
      </div>

      {/* åº•éƒ¨æ“ä½œ */}
      <div className="mt-3 flex gap-2 justify-end">
        <button
          onClick={() => copyParticipants(x.participants)}
          className="rounded-lg border px-3 py-1.5"
        >
          è¤‡è£½åå–®
        </button>

        {admin && (
          <>
            <button
              onClick={() => editPending(x)}
              className="rounded-lg border px-3 py-1.5"
            >
              ç·¨è¼¯
            </button>

            <button
              onClick={() => {
                const raw = buildAnnouncementText(x);
                const edited = prompt("å…¬å‘Šå…§å®¹ï¼ˆå¯ç·¨è¼¯ï¼Œç¢ºå®šå¾Œè‡ªå‹•è¤‡è£½ï¼‰", raw);
                if (edited === null) return;
                navigator.clipboard
                  .writeText(edited)
                  .then(() => alert("å·²è¤‡è£½å…¬å‘Šæ¨¡æ¿"))
                  .catch(() => alert("è¤‡è£½å¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™"));
              }}
              className="rounded-lg border px-3 py-1.5"
            >
              å¥—ç”¨å…¬å‘Šæ¨¡æ¿
            </button>

            <button
              onClick={() => {
                const s = sim[x.id];
                if (!s || !s.winners || s.winners.length === 0) {
                  alert("è«‹å…ˆåœ¨ä¸Šæ–¹å€å¡Šè·‘ä¸€æ¬¡ã€é–‹å§‹æ¨¡æ“¬ã€ï¼Œå†ä½¿ç”¨æ­¤æŒ‰éˆ•ã€‚");
                  return;
                }
                const winners = s.winners.slice();
                const rec = {
                  id: nid(),
                  title: x.title,
                  date: x.deadline || "",
                  winners,
                  winnerCount: winners.length,
                  totalParticipants: x.participants?.length || winners.length,
                  youtube: "",
                  status: "è™•ç†ä¸­",
                  note: "ç”±ç­‰å¾…é–‹çï¼ˆæ¨¡æ“¬çµæœï¼‰è½‰å…¥",
                };
                const nextHistory = sortHistoryDesc([
                  rec,
                  ...(data.history || []),
                ]);
                setData({
                  ...data,
                  pending: (data.pending || []).filter((i) => i.id !== x.id),
                  history: nextHistory,
                });
                alert("å·²ç”¨ã€æ¨¡æ“¬çµæœã€è½‰å…¥æ­·å²");
              }}
              className="rounded-lg border px-3 py-1.5"
            >
              ä»¥æ¨¡æ“¬çµæœè½‰æ­·å²
            </button>

            <button
              onClick={() => {
                const setSel = selected[x.id] || new Set();
                const winners = Array.from(setSel);
                if (winners.length === 0) {
                  alert("å°šæœªå‹¾é¸ä»»ä½•äºº");
                  return;
                }
                const rec = {
                  id: nid(),
                  title: x.title,
                  date: x.deadline || "",
                  winners,
                  winnerCount: winners.length,
                  totalParticipants: x.participants?.length || winners.length,
                  youtube: "",
                  status: "è™•ç†ä¸­",
                  note: "ç”±ç­‰å¾…é–‹çï¼ˆæ‰‹å‹•å‹¾é¸ï¼‰è½‰å…¥",
                };
                const nextHistory = sortHistoryDesc([
                  rec,
                  ...(data.history || []),
                ]);
                setData({
                  ...data,
                  pending: (data.pending || []).filter((i) => i.id !== x.id),
                  history: nextHistory,
                });
                alert("å·²ä»¥ã€å‹¾é¸åå–®ã€è½‰å…¥æ­·å²");
              }}
              className="rounded-lg border px-3 py-1.5"
            >
              ä»¥å‹¾é¸åå–®è½‰æ­·å²
            </button>

            <button
              onClick={() => moveToHistory(x.id)}
              className="rounded-lg bg-brand text-white px-3 py-1.5"
            >
              æ•´ä»½åå–®è½‰æ­·å²
            </button>

            <button
              onClick={() => removePending(x.id)}
              className="rounded-lg bg-red-500 text-white px-3 py-1.5"
            >
              åˆªé™¤
            </button>
          </>
        )}
      </div>
    </Collapse>
  ))}
</div>

      </Section>
    </>
  );
}


// === Ongoingï¼ˆé€²è¡Œä¸­æ´»å‹•ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/ä¸Šä¸‹ç§»å‹•/å•Ÿç”¨åœç”¨ ===
function Ongoing({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  const [editingId, setEditingId] = useState(null);

  const items = React.useMemo(()=>{
  let list = data.ongoing || [];
  if(!admin) list = list.filter(x => x.enabled !== false);
  const q = String(query).trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>{
    const hay = [
      x.title, x.desc, x.rules, x.link
    ].map(s => String(s||"").toLowerCase()).join(" ");
    return hay.includes(q);
  });
},[data.ongoing, admin, query]);

  const HasImageInput = typeof ImageInput === "function";

  const saveOngoing = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, desc: draft.desc||"", rules: draft.rules||"", link: draft.link||"", image: draft.image||"", enabled: !!draft.enabled };
    const base = data.ongoing || [];
const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];

    setData({ ...data, ongoing: next });
    setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  };

  const editOngoing = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", desc:x.desc||"", rules:x.rules||"", link:x.link||"", image:x.image||"", enabled: !!x.enabled }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true }); };

  const removeOngoing = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, ongoing: (data.ongoing || []).filter(x => x.id !== id) }); };

  const toggleEnabled = (id) => { if(!admin) return; setData({ ...data, ongoing: (data.ongoing || []).map(x => x.id===id ? { ...x, enabled: !x.enabled } : x) });
 };

  const move = (id, dir) => {
  if (!admin) return;
  const arr = [...(data.ongoing || [])];
  const i = arr.findIndex(x => x.id === id);
  const j = dir === "up" ? i - 1 : i + 1;
  if (i < 0 || j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  setData({ ...data, ongoing: arr });
};

  const moveUp = (id) => move(id, 'up');
  const moveDown = (id) => move(id, 'down');

  return (
    <Section title="ğŸ”„ é€²è¡Œä¸­æ´»å‹•" subtitle="å¡ç‰‡å¼å±•ç¤ºï¼ˆå¯ä¸Šä¸‹ç§»å‹•ã€å•Ÿç”¨/åœç”¨ã€ç·¨è¼¯ï¼‰ã€‚">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="æ¨™é¡Œ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.link} onChange={e=>setDraft(d=>({...d,link:e.target.value}))} placeholder="é€£çµï¼ˆå¯ç©ºç™½ï¼‰"/>
            <div className="sm:col-span-2">
              {HasImageInput
                ? <ImageInput label="å±•ç¤ºåœ–ç‰‡" value={draft.image} onChange={(v)=>setDraft(d=>({...d,image:v}))}/>
                : <input className="rounded-lg border px-3 py-2 w-full" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="å±•ç¤ºåœ–ç‰‡ï¼ˆç¶²å€æˆ– base64ï¼‰"/>}
            </div>
          </div>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))} placeholder="ä»‹ç´¹ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.rules} onChange={e=>setDraft(d=>({...d,rules:e.target.value}))} placeholder="è¦å‰‡ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.enabled} onChange={e=>setDraft(d=>({...d,enabled:e.target.checked}))}/>å•Ÿç”¨ï¼ˆå‹¾é¸ï¼å°å¤–é¡¯ç¤ºï¼‰</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveOngoing} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('open')}>å…¨éƒ¨å±•é–‹</button>
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('close')}>å…¨éƒ¨æ”¶åˆ</button>
        
      </div>

      <div className="grid gap-4 mt-4">
        {items.map((x)=> (
          <Collapse key={x.id} header={`${x.title || "æœªå‘½åæ´»å‹•"}`} force={bulk}>
            {x.image && <img src={x.image} alt="æ´»å‹•åœ–ç‰‡" className="rounded-lg max-h-56 object-contain w-full bg-slate-50 dark:bg-slate-800 mb-2"/>}
            {x.link && <div className="text-sm mb-2">é€£çµï¼š<a className="underline text-brand" href={x.link} target="_blank" rel="noreferrer">{x.link}</a></div>}
            {x.desc && <div className="text-sm whitespace-pre-wrap mb-2">{x.desc}</div>}
            {x.rules && <div className="text-sm whitespace-pre-wrap mb-2"><span className="text-slate-500">è¦å‰‡ï¼š</span>{x.rules}</div>}
            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>moveUp(x.id)} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>moveDown(x.id)} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>toggleEnabled(x.id)} className="rounded-lg border px-3 py-1.5">
                  {x.enabled ? "åœç”¨" : "å•Ÿç”¨"}
                </button>
                <button onClick={()=>removeOngoing(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

function Shop({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = React.useState(null); // 'open' | 'close' | nullï¼ˆåªç”¨åœ¨åˆ—è¡¨æª¢è¦–ï¼‰
  const [draft, setDraft] = React.useState({ name:"", points:"", stock:"", desc:"", image:"", enabled:true });
  const [editingId, setEditingId] = React.useState(null);

  // ğŸ‘€ æª¢è¦–æ¨¡å¼ï¼šlist | grid9 | grid16ï¼ˆç”¨ localStorage è¨˜ä½åå¥½ï¼‰
  const [view, setView] = useLocalState('kjs_view_shop', 'list');

  // å•†å“æ¸…å–®ï¼ˆä¾æœå°‹éæ¿¾ï¼›éç®¡ç†æ¨¡å¼æœƒéš±è—åœç”¨å“ï¼‰
  const items = React.useMemo(()=>{
    let list = data.shop?.items || [];
    if(!admin) list = list.filter(x => x.enabled !== false);
    const q = String(query).trim().toLowerCase();
    if(!q) return list;
    return list.filter(x=>{
      const hay = [x.name, x.desc].map(s => String(s||"").toLowerCase()).join(" ");
      return hay.includes(q);
    });
  },[data.shop?.items, admin, query]);

  // === åˆ†é ï¼ˆShopï¼‰ ===
  const [shopPage, setShopPage] = useLocalState('kjs_shop_page', 1);
  const shopPageSize = 20; // åˆ—è¡¨/å®®æ ¼éƒ½æ¯é  20
  const shopTotal = items.length;
  const shopMaxPage = Math.max(1, Math.ceil(shopTotal / shopPageSize));

  React.useEffect(() => {
    if (shopPage > shopMaxPage) setShopPage(shopMaxPage);
  }, [shopPage, shopMaxPage, setShopPage]);

  // æª¢è¦–æˆ–æœå°‹è®ŠåŒ–æ™‚å›åˆ°ç¬¬ 1 é 
  React.useEffect(() => { setShopPage(1); }, [view, query, setShopPage]);

  const shopStart = (shopPage - 1) * shopPageSize;
  const shopEnd = Math.min(shopStart + shopPageSize, shopTotal);
  const shopPageItems = items.slice(shopStart, shopEnd);

  // é ç¢¼è¦–çª—ï¼ˆæœ€å¤š 5 æ ¼ï¼‰
  const shopWindowSize = 5;
  const shopStartPage = Math.max(
    1,
    Math.min(shopPage - Math.floor(shopWindowSize / 2), shopMaxPage - shopWindowSize + 1)
  );
  const shopEndPage = Math.min(shopMaxPage, shopStartPage + shopWindowSize - 1);

  // æ˜¯å¦æœ‰æª”æ¡ˆé¸æ“‡å™¨å…ƒä»¶ï¼ˆä¿ç•™ä½ å…ˆå‰ã€Œå¯ç›´æ¥æ”¾æª”æ¡ˆã€çš„éœ€æ±‚ï¼‰
  const HasImageInput = typeof ImageInput === "function";

  // â€”â€” å‹•ä½œï¼šæ–°å¢/ä¿®æ”¹/åˆªé™¤/å•Ÿåœ â€”â€” //
  const saveItem = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.name) return alert("è«‹å¡«å¯«å•†å“åç¨±");
    const rec = {
      id: editingId || Math.random().toString(36).slice(2,10),
      name: draft.name,
      points: Number(draft.points||0),
      stock: Number(draft.stock||0),
      desc: draft.desc||"",
      image: draft.image||"",
      enabled: !!draft.enabled
    };
    const base = data.shop?.items || [];
    const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];
    setData({ ...data, shop: { ...data.shop, items: next } });
    setEditingId(null);
    setDraft({ name:"", points:"", stock:"", desc:"", image:"", enabled:true });
  };

  const editItem = (x) => {
    if(!admin) return;
    setEditingId(x.id);
    setDraft({
      name:x.name||"",
      points:String(x.points??""),
      stock:String(x.stock??""),
      desc:x.desc||"",
      image:x.image||"",
      enabled: !!x.enabled
    });
    window.scrollTo({top:0,behavior:"smooth"});
  };

  const cancelEdit = () => {
    setEditingId(null);
    setDraft({ name:"", points:"", stock:"", desc:"", image:"", enabled:true });
  };

  const removeItem = (id) => {
    if(!admin) return;
    if(!confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) return;
    setData({ ...data, shop: { ...data.shop, items: (data.shop?.items || []).filter(x => x.id !== id) } });
  };

  const toggleEnabled = (id) => {
    if(!admin) return;
    setData({ ...data, shop: { ...data.shop, items: (data.shop?.items || []).map(x => x.id===id ? {...x, enabled: !x.enabled} : x) } });
  };

  // â€”â€” ç•«é¢ â€”â€” //
  return (
    <Section title="ğŸ›ï¸ é»æ•¸å•†åŸï½œå…Œæ›å¥½ç¦®" subtitle="åˆ—è¡¨åªé¡¯ç¤ºåç¨±ï¼›9/16 å®®æ ¼ç‚ºå®Œæ•´åœ–ç‰‡+åç¨±ï¼Œé»æ“Šå¡ç‰‡æ‰å±•é–‹è©³ç´°å…§å®¹ã€‚">
      {/* æª¢è¦–åˆ‡æ›ï¼ˆåœ–ç¤ºï¼‰ */}
      <div className="flex items-center justify-between mb-3">
        <div className="text-sm text-slate-500">å…± {shopTotal} é …</div>
        <div className="flex items-center gap-1">
          <button
            type="button"
            className={"tap-target rounded-lg border px-2 py-1 text-sm " + (view==='list'?'bg-brand text-white border-brand':'')}
            title="åˆ—è¡¨"
            onClick={()=>setView('list')}
          >â˜°</button>
          <button
            type="button"
            className={"tap-target rounded-lg border px-2 py-1 text-sm " + (view==='grid9'?'bg-brand text-white border-brand':'')}
            title="ä¹å®®æ ¼"
            onClick={()=>setView('grid9')}
          >â–¦</button>
          <button
            type="button"
            className={"tap-target rounded-lg border px-2 py-1 text-sm " + (view==='grid16'?'bg-brand text-white border-brand':'')}
            title="åå…­å®®æ ¼"
            onClick={()=>setView('grid16')}
          >â–¤</button>
        </div>
      </div>

      {/* ç®¡ç†è¡¨å–® */}
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))} placeholder="å•†å“åç¨±"/>
            <input className="rounded-lg border px-3 py-2" value={draft.points} onChange={e=>setDraft(d=>({...d,points:e.target.value}))} placeholder="æ‰€éœ€é»æ•¸ï¼ˆæ•¸å­—ï¼‰" inputMode="numeric"/>
            <input className="rounded-lg border px-3 py-2" value={draft.stock} onChange={e=>setDraft(d=>({...d,stock:e.target.value}))} placeholder="åº«å­˜ï¼ˆæ•¸å­—ï¼‰" inputMode="numeric"/>

            {/* åœ–ç‰‡ä¸Šå‚³/é€£çµï¼šè‹¥æœ‰ ImageInput å…ƒä»¶å°±çµ¦ç›´æ¥ä¸Šå‚³ï¼›å¦å‰‡ç¶­æŒ URL è¼¸å…¥ */}
            {HasImageInput ? (
              <ImageInput value={draft.image} onChange={url=>setDraft(d=>({...d,image:url}))} className="sm:col-span-2" />
            ) : (
              <input className="rounded-lg border px-3 py-2 sm:col-span-2" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="åœ–ç‰‡ç¶²å€ï¼ˆæˆ–ä¿ç•™ç©ºç™½ï¼‰"/>
            )}

            <textarea className="rounded-lg border px-3 py-2 sm:col-span-2 min-h-[100px]" value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))} placeholder="å•†å“æè¿°ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>

            <label className="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" checked={!!draft.enabled} onChange={e=>setDraft(d=>({...d,enabled:e.target.checked}))}/>
              ä¸Šæ¶ï¼ˆå•Ÿç”¨ï¼‰
            </label>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveItem} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å•†å“"}</button>
          </div>
        </div>
      )}

      {/* ç„¡è³‡æ–™ */}
      {items.length === 0 && <EmptyCard text="ç›®å‰æ²’æœ‰å•†å“" admin={admin} />}

      {/* æ‰¹æ¬¡å±•é–‹/æ”¶åˆï¼ˆåªåœ¨åˆ—è¡¨æ¨¡å¼æœ‰æ„ç¾©ï¼‰ */}
      <div className="flex gap-2 justify-end mt-4">
        {view === 'list' ? (
          <>
            <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('open')}>å…¨éƒ¨å±•é–‹</button>
            <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('close')}>å…¨éƒ¨æ”¶åˆ</button>
          </>
        ) : (
          <span className="text-xs text-slate-500">ï¼ˆå®®æ ¼æª¢è¦–ï¼šé»å¡ç‰‡æ‰å±•é–‹è©³ç´°ï¼‰</span>
        )}
      </div>

      {/* æ¸…å–®/å®®æ ¼å®¹å™¨ */}
      <div
        className={
          view === 'list'
            ? "grid gap-4 mt-4"
            : view === 'grid9'
              ? "grid gap-4 mt-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"
              : "grid gap-4 mt-4 grid-cols-2 md:grid-cols-3 xl:grid-cols-4"
        }
      >
        {shopPageItems.map(x => (
          <Collapse
            key={x.id}
            // headerï¼šåˆ—è¡¨=åªé¡¯ç¤ºåç¨±ï¼›å®®æ ¼=å®Œæ•´åœ–ç‰‡ + åç¨±ï¼ˆåœ–ç‰‡æœƒç­‰æ¯”ä¾‹ç¸®æ”¾å¡æ»¿æ–¹æ¡†ï¼‰
            header={
              view === 'list' ? (
                <div className="text-sm font-medium truncate">{x.name || 'æœªå‘½å'}</div>
              ) : (
                <div className="w-full">
                  {/* åœ–ç‰‡ï¼šå®Œæ•´åœ–ç­‰æ¯”ç¸®å°å¡é€²æ–¹æ¡†ï¼Œä¸è£åˆ‡ */}
                  <div className="relative w-full aspect-square rounded-lg bg-slate-50 dark:bg-slate-800 overflow-hidden flex items-center justify-center">
  {/* å‰©é¤˜æ•¸é‡å¾½ç« ï¼ˆæœªå±•é–‹ç‹€æ…‹ä¸‹ä¹Ÿå¯è¦‹ï¼‰ */}
  {getRemain(x) !== null && (
    <div className="absolute top-2 left-2 inline-flex items-center gap-1 rounded-full bg-white/90 dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 px-2 py-0.5 text-[12px] leading-none">
      <span className="inline-block w-1.5 h-1.5 rounded-full bg-emerald-500" aria-hidden="true"></span>
      å‰©é¤˜ {getRemain(x)}
    </div>
  )}

  {/* å®Œæ•´åœ–ç‰‡ï¼ˆç­‰æ¯”ç¸®æ”¾ï¼Œä¸è£åˆ‡ï¼‰ */}
  {x.image ? (
    <img
      src={x.image}
      alt={x.title || 'å•†å“åœ–ç‰‡'}
      className="max-w-full max-h-full object-contain"
      loading="lazy"
      decoding="async"
    />
  ) : (
    <div className="text-xs text-slate-400">ç„¡åœ–ç‰‡</div>
  )}
</div>

                  {/* åç¨±ï¼šæœªå±•é–‹å‰éé•·ä»¥ **** æ”¶æ–‚ï¼›å±•é–‹å¾Œåœ¨å…§å®¹å€æœƒæœ‰å®Œæ•´æè¿° */}
                  <div className="mt-2 text-sm font-medium">
                    {(x.name || 'æœªå‘½å').length > 18
                      ? (x.name || 'æœªå‘½å').slice(0, 18) + '****'
                      : (x.name || 'æœªå‘½å')}
                  </div>
                </div>
              )
            }
            force={view === 'list' ? bulk : null}
          >
            {/* å…§å®¹ï¼šé»æ“Šå¾Œå±•é–‹æ‰çœ‹åˆ° */}
            <div className="mt-2 text-sm"><b>æ‰€éœ€é»æ•¸ï¼š</b>{x.points} é»</div>
            {x.desc && <div className="mt-2 text-sm whitespace-pre-wrap">{x.desc}</div>}

            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>editItem(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
                <button onClick={()=>toggleEnabled(x.id)} className="rounded-lg border px-3 py-1.5">
                  {x.enabled ? "åœç”¨" : "å•Ÿç”¨"}
                </button>
                <button onClick={()=>removeItem(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>

      {/* åˆ†é æ§åˆ¶ï¼ˆShopï¼‰â€”â€” ä¸€å®šè¦æ”¾åœ¨æ¸…å–®ä¹‹å¾Œï¼Œä¸èƒ½æ”¾åœ¨ header å…§ï¼ */}
      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={shopPage <= 1}
          onClick={() => setShopPage(p => Math.max(1, p - 1))}
        >
          ä¸Šä¸€é 
        </button>

        {Array.from({ length: (shopEndPage - shopStartPage + 1) }, (_, i) => shopStartPage + i).map(p => (
          <button
            key={p}
            type="button"
            className={`rounded-lg border px-3 py-1.5 text-sm ${p === shopPage ? 'bg-brand text-white border-brand' : ''}`}
            onClick={() => setShopPage(p)}
          >
            {p}
          </button>
        ))}

        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={shopPage >= shopMaxPage}
          onClick={() => setShopPage(p => Math.min(shopMaxPage, p + 1))}
        >
          ä¸‹ä¸€é 
        </button>
      </div>
    </Section>
  );
}

function Others({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", content:"", pin:false });
  const [editingId, setEditingId] = useState(null);

  const cards = React.useMemo(()=> data.others?.cards || [], [data.others]);

  const orderedCards = React.useMemo(()=>{
    const list = data.others?.cards || [];
    const q = String(query).trim().toLowerCase();
    const filtered = q
      ? list.filter(x =>
          String(x.title||"").toLowerCase().includes(q) ||
          String(x.content||"").toLowerCase().includes(q)
        )
      : list;
    // pin=true ç½®é ‚å„ªå…ˆ
    return [...filtered].sort((a,b)=> (b.pin===true) - (a.pin===true));
  },[data.others, query]);

  const saveCard = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, content: draft.content||"", pin: !!draft.pin };
    const next = editingId ? cards.map(x=>x.id===editingId?rec:x) : [rec, ...cards];
    setData({ ...data, others: { ...data.others, cards: next } });
    setEditingId(null); setDraft({ title:"", content:"", pin:false });
  };

  const editCard = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", content:x.content||"", pin: !!x.pin }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", content:"", pin:false }); };

  const removeCard = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, others: { ...data.others, cards: cards.filter(x=>x.id!==id) } }); };
  const togglePin = (id) => { if(!admin) return; setData({ ...data, others: { ...data.others, cards: cards.map(x=>x.id===id?{...x,pin:!x.pin}:x) } }); };

  const move = (id, dir) => {
    if (!admin) return;
    const arr = [...cards], i = arr.findIndex(x=>x.id===id), j = dir==="up" ? i-1 : i+1;
    if (i<0 || j<0 || j>=arr.length) return;
    [arr[i], arr[j]] = [arr[j], arr[i]];
    setData({ ...data, others: { ...data.others, cards: arr } });
  };

  return (
    <Section title="ğŸ“Œ å…¶ä»–è³‡æ–™" subtitle="å‰µç«‹åˆè¡·ã€å…¬å‘Šã€é–‹çæ–¹å¼ã€è£œå¯„/å†æŠ½è¦å‰‡ã€é»æ•¸è¦å‰‡ã€è´ŠåŠ©èªªæ˜ã€è´ŠåŠ©è€…åå–®ã€æŸ¥è©¢é»æ•¸â€¦">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="å¡ç‰‡æ¨™é¡Œï¼ˆå¦‚ï¼šæœ€æ–°å…¬å‘Šï¼‰"/>
          <textarea className="rounded-lg border px-3 py-2 min-h-[120px]" value={draft.content} onChange={e=>setDraft(d=>({...d,content:e.target.value}))} placeholder="å…§å®¹ï¼ˆå¯è²¼é€£çµï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.pin} onChange={e=>setDraft(d=>({...d,pin:e.target.checked}))}/>ç½®é ‚</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveCard} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {cards.length === 0 && <EmptyCard text="ç›®å‰æ²’æœ‰å¡ç‰‡å…§å®¹" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('open')}>å…¨éƒ¨å±•é–‹</button>
        <button className="rounded-lg border px-3 py-1.5" onClick={()=>setBulk('close')}>å…¨éƒ¨æ”¶åˆ</button>
        
      </div>

      <div className="grid gap-4 mt-4">
        {orderedCards.map((x)=> (
          <Collapse key={x.id} header={`${x.title || "æœªå‘½åå¡ç‰‡"}`} force={bulk}>
            <div className="whitespace-pre-wrap text-sm">{x.content || "ï¼ˆç„¡å…§å®¹ï¼‰"}</div>
            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>move(x.id,'up')} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>move(x.id,'down')} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>togglePin(x.id)} className="rounded-lg border px-3 py-1.5">{x.pin ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
                <button onClick={()=>editCard(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
                <button onClick={()=>removeCard(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

function PointsPanel({ data, admin, setData }) {
  const people = React.useMemo(() => data.shop?.people || [], [data.shop]);
  const logs   = React.useMemo(() => data.shop?.logs   || [], [data.shop]); // {id, personId, delta, note, at}
  const [q, setQ] = useState("");
  const [draft, setDraft] = useState({ name: "", points: "" });

  // æŠŠã€Œé¸æ“‡äººå“¡ã€æ”¹æˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼šç”¨ datalist
  const [logDraft, setLogDraft] = useState({ name:"", delta:"", note:"" });

  const norm = (s="") => s.trim().toLowerCase();

  const result = React.useMemo(() => {
    if (!q.trim()) return null;
    const key = norm(q);
    const exact = people.find(p => norm(p.name) === key);
    if (exact) return exact;
    const fuzzy = people.find(p => norm(p.name).includes(key));
    return fuzzy || null;
  }, [q, people]);

const personIdFilter = React.useMemo(() => result?.id || null, [result]);

  const addOrUpdate = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const raw = draft.name || "";
    const name = raw.replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if (!name) return alert("è«‹è¼¸å…¥å§“å/æš±ç¨±");
    const pts = Number(draft.points || 0);
    if (!Number.isFinite(pts)) return alert("é»æ•¸éœ€ç‚ºæ•¸å­—");

    const key = normName(name);
    const exists = people.find(p => normName(p.name) === key);

    const summary = exists
      ? `å·²å­˜åœ¨ã€Œ${exists.name}ã€ï¼Œç›®å‰é»æ•¸ï¼š${exists.points}\nè¦å°‡é»æ•¸æ”¹ç‚ºï¼š${pts} å—ï¼Ÿ`
      : `ç¢ºèªæ–°å¢äººå“¡ï¼š${name}\né»æ•¸ï¼š${pts}`;
    if (!confirm(summary)) return;

    let nextPeople;
    if (exists) {
      nextPeople = people.map(p => normName(p.name) === key ? { ...p, name, points: pts } : p);
    } else {
      nextPeople = [{ id: nid(), name, points: pts }, ...people];
    }
    setData({ ...data, shop: { ...data.shop, people: nextPeople } });
    setDraft({ name: "", points: "" });
  };

  const adjust = (id, delta) => {
    if (!admin) return;
    const next = people.map(p => p.id === id ? { ...p, points: Math.max(0, Number(p.points||0) + delta) } : p);
    const log = { id: nid(), personId:id, delta, note: delta>0?'+èª¿æ•´':'-èª¿æ•´', at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: next, logs: [log, ...logs] } });
  };

  // âœ… åˆªé™¤äººå“¡ï¼šé—œéµå­—ç¢ºèªï¼Œä¸”ä¸å†ä¸Ÿå›æ”¶ç«™
  const removePerson = (id) => {
    if (!admin) return;
    const p = people.find(x=>x.id===id); if(!p) return;
    if(!confirmKeyword({label: `æ¬²åˆªé™¤ï¼š${p.name}`, keyword:'åˆªé™¤'})) return;
    const nextShop = {
      ...data.shop,
      people: people.filter(x=>x.id!==id),
      logs   : logs // äººå“¡åˆªé™¤ä¸å‹•æ­·å²æµæ°´
    };
    setData({ ...data, shop: nextShop });
  };

  // âœ… æ–°å¢ç•°å‹•ï¼šç”¨åå­—æ‰¾äººï¼›ä¸å­˜åœ¨å°±è‡ªå‹•å»ºç«‹
  const addLog = () => {
    if(!admin) return;
    const rawName = (logDraft.name||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if(!rawName) return alert('è«‹è¼¸å…¥äººå“¡å§“å/æš±ç¨±');
    const delta = Number(logDraft.delta||0);
    if(!Number.isFinite(delta) || delta===0) return alert('è«‹è¼¸å…¥é 0 çš„æ•´æ•¸ç•°å‹•');

    // å…ˆæ‰¾ç¾æœ‰äººå“¡
    const key = normName(rawName);
    let person = people.find(x => normName(x.name) === key);

    let nextPeople = [...people];
    if (!person) {
      // è‡ªå‹•å»ºç«‹æ–°çš„äººå“¡ï¼ˆ0 é»ï¼‰
      person = { id: nid(), name: rawName, points: 0 };
      nextPeople = [person, ...people];
    }

    // å¯«å…¥é»æ•¸èˆ‡æµæ°´
    nextPeople = nextPeople.map(x => x.id===person.id ? { ...x, points: Math.max(0, Number(x.points||0) + delta) } : x);
    const log = { id: nid(), personId: person.id, delta, note: logDraft.note||'', at: nowISO() };

    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [log, ...logs] } });

setQ(rawName);

    setLogDraft({ name:"", delta:"", note:"" });
  };

  const revokeLog = (logId) => {
    if(!admin) return;
    const lg = logs.find(l=>l.id===logId); if(!lg) return;
    if(!confirm('è¦æ’¤éŠ·é€™ç­†ç•°å‹•å—ï¼Ÿæœƒå¯«å…¥ä¸€ç­†ç›¸åæ•¸çš„è£œè¨˜ã€‚')) return;
    const pid = lg.personId; const delta = -lg.delta;
    const nextPeople = people.map(x=> x.id===pid ? { ...x, points: Math.max(0, Number(x.points||0)+delta) } : x);
    const newLog = { id: nid(), personId: pid, delta, note: `æ’¤éŠ· ${logId}`, at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [newLog, ...logs] } });
  };

  const sorted  = React.useMemo(()=> [...people].sort((a,b)=> a.name.localeCompare(b.name, "zh-Hant")), [people]);
  // ä¾ç›®å‰æŸ¥è©¢åˆ°çš„äººï¼ˆresultï¼‰ä¾†éæ¿¾å…¶å€‹äººæµæ°´ï¼Œä¸¦åªå– 5 ç­†
const latest5 = React.useMemo(() => {
  const filtered = personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
  return filtered.slice(0,5);
}, [logs, personIdFilter]);

const visibleLogs = React.useMemo(()=>{
  return personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
}, [logs, personIdFilter]);


  return (
    <Section title="ğŸ” æŸ¥è©¢é»æ•¸" subtitle="å…¬é–‹æœ€å¤šé¡¯ç¤ºæœ€è¿‘ 5 ç­†ç•°å‹•ï¼›ç®¡ç†å¯çœ‹å…¨éƒ¨ã€åŠ ä¸€ç­†/æ’¤éŠ·ã€å¯åŒ¯å‡ºã€‚">
      <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
        <input className="rounded-lg border px-3 py-2" value={q} onChange={(e)=>setQ(e.target.value)} placeholder="è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢"/>
        <div className="text-sm">
          {q.trim()
            ? (result
                ? <span>ã€Œ<b>{result.name}</b>ã€ç›®å‰é»æ•¸ï¼š<b>{result.points}</b></span>
                : <span>æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</span>)
            : <span className="text-slate-500">è«‹è¼¸å…¥è¦æŸ¥è©¢çš„å§“å/æš±ç¨±</span>}
        </div>
      </div>

      {/* å…¬é–‹æµæ°´ï¼šåƒ…é¡¯ç¤ºæŸ¥è©¢åˆ°çš„æ­¤äººæœ€è¿‘ 5 ç­† */}
<div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 mt-3">
  <div className="text-sm font-medium mb-2">æœ€è¿‘ 5 ç­†é»æ•¸ç•°å‹•ï¼ˆåƒ…æ­¤äººï¼‰</div>

  {!q.trim() ? (
    <div className="text-sm text-slate-500">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢</div>
  ) : !result ? (
    <div className="text-sm text-slate-500">æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</div>
  ) : latest5.length === 0 ? (
    <div className="text-sm text-slate-500">ã€Œ{result.name}ã€ç›®å‰æ²’æœ‰ç•°å‹•ç´€éŒ„</div>
  ) : (
    <div className="grid gap-2">
      {latest5.map(l=>{
        const p = people.find(x=>x.id===l.personId);
        return (
          <div key={l.id} className="text-sm flex items-center justify-between">
            <div className="truncate">{p?.name || '(å·²åˆª)'}ï½œ{l.delta>0?`+${l.delta}`:l.delta}ï½œ{l.note||'ï¼ˆç„¡å‚™è¨»ï¼‰'}</div>
            <div className="text-xs text-slate-500">{l.at}</div>
          </div>
        );
      })}
    </div>
  )}
</div>


      {admin && (
        <>
          {/* æ–°å¢/æ›´æ–°äººå“¡ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="grid sm:grid-cols-2 gap-3">
              <input className="rounded-lg border px-3 py-2" value={draft.name} onChange={(e)=>setDraft(d=>({ ...d, name: e.target.value }))} placeholder="å§“å/æš±ç¨±"/>
              <input className="rounded-lg border px-3 py-2" value={draft.points} onChange={(e)=>setDraft(d=>({ ...d, points: e.target.value }))} placeholder="é»æ•¸ï¼ˆæ•´æ•¸ï¼‰"/>
            </div>
            <div className="flex justify-end">
              <button onClick={addOrUpdate} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢/æ›´æ–°</button>
            </div>
          </div>

          {/* ç®¡ç†ï¼šå…¨éƒ¨æµæ°´è¡¨ã€åŠ ä¸€ç­† / æ’¤éŠ· / åŒ¯å‡º */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="flex items-center justify-between">
              <div className="text-sm font-medium">å…¨éƒ¨ç•°å‹•</div>
              <div className="flex items-center gap-2">
  {q.trim() && (
    <button
      className="rounded-lg border px-3 py-1.5 text-sm"
      onClick={()=>setQ("")}
      title="æ¸…é™¤äººå“¡éæ¿¾"
    >
      æ¸…é™¤éæ¿¾
    </button>
  )}
  <button
    className="rounded-lg border px-3 py-1.5 text-sm"
    onClick={()=>{
      const rows = [['at','person','delta','note']];
      const list = personIdFilter ? logs.filter(l=>l.personId===personIdFilter) : logs;
      list.forEach(l=>{
        const p = people.find(x=>x.id===l.personId);
        rows.push([l.at, p?.name||'(å·²åˆª)', l.delta, l.note||'']);
      });
      exportCSV('points_logs.csv', rows);
    }}
  >
    åŒ¯å‡º CSV
  </button>
</div>

            </div>

            {/* âœ… æ–°å¢ä¸€ç­†ç•°å‹•ï¼šå¯è¼¸å…¥æˆ–ä¸‹æ‹‰é¸æ“‡ */}
            <div className="grid sm:grid-cols-3 gap-2">
              <div className="sm:col-span-1">
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  list="people-list"
                  placeholder="äººå“¡ï¼ˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼‰"
                  value={logDraft.name}
                  onChange={e=>setLogDraft(d=>({...d, name:e.target.value}))}
                />
                <datalist id="people-list">
                  {people.map(p => <option key={p.id} value={p.name} />)}
                </datalist>
              </div>
              <input className="rounded-lg border px-3 py-2" placeholder="ç•°å‹•ï¼ˆæ•´æ•¸ï¼Œå¯è² ï¼‰" value={logDraft.delta} onChange={e=>setLogDraft(d=>({...d,delta:e.target.value}))}/>
              <input className="rounded-lg border px-3 py-2 sm:col-span-1" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰" value={logDraft.note} onChange={e=>setLogDraft(d=>({...d,note:e.target.value}))}/>
              <div className="sm:col-span-3 flex justify-end">
                <button onClick={addLog} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢ç•°å‹•</button>
              </div>
            </div>

            {/* è¡¨æ ¼ */}
            <div className="rounded-xl border overflow-hidden">
              <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
                <div className="col-span-3">æ™‚é–“</div>
                <div className="col-span-3">äººå“¡</div>
                <div className="col-span-2">ç•°å‹•</div>
                <div className="col-span-3">å‚™è¨»</div>
                <div className="col-span-1 text-right">æ“ä½œ</div>
              </div>
              {logs.length===0 && <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡ç•°å‹•</div>}
              {visibleLogs.map(l=>{

                const p = people.find(x=>x.id===l.personId);
                return (
                  <div key={l.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                    <div className="col-span-3 text-xs">{l.at}</div>
                    <div className="col-span-3">
  {p
    ? <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">{p.name}</button>
    : '(å·²åˆª)'}
</div>

                    <div className="col-span-2">{l.delta>0?`+${l.delta}`:l.delta}</div>
                    <div className="col-span-3 truncate">{l.note||''}</div>
                    <div className="col-span-1 flex justify-end">
                      <button onClick={()=>revokeLog(l.id)} className="rounded-lg border px-2 py-1 text-xs">æ’¤éŠ·</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* äººå“¡åˆ—è¡¨ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mt-3">
            <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
              <div className="col-span-6">å§“å/æš±ç¨±</div>
              <div className="col-span-3">é»æ•¸</div>
              <div className="col-span-3 text-right">æ“ä½œ</div>
            </div>
            {sorted.length === 0 && (
              <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡äººå“¡é»æ•¸è³‡æ–™</div>
            )}
            {sorted.map(p => (
              <div key={p.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                <div className="col-span-6">
  <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">
    {p.name}
  </button>
</div>

                <div className="col-span-3">{p.points}</div>
                <div className="col-span-3 flex justify-end gap-2">
                  <button onClick={()=>adjust(p.id, +1)} className="rounded-lg border px-3 py-1.5">+1</button>
                  <button onClick={()=>adjust(p.id, -1)} className="rounded-lg border px-3 py-1.5">-1</button>
                  <button onClick={()=>removePerson(p.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
                </div>
              </div>
            ))}
          </div>
        </>
      )}
    </Section>
  );
}

function SettingsPanel({ data, setData, bg, setBg }) {
  const DEFAULTS = DEFAULT_SETTINGS;
  const s = data.settings || DEFAULTS;
  const [draft, setDraft] = React.useState({ ...s });

  const save = () => {
    const a = Math.max(1, parseInt(draft.drawMaxPerRun, 10) || DEFAULTS.drawMaxPerRun);
    const b = Math.max(1, parseInt(draft.drawPublicShowLimit, 10) || DEFAULTS.drawPublicShowLimit);
    const c = Math.max(0, parseInt(draft.drawCooldownSec, 10) || DEFAULTS.drawCooldownSec);
    setData({ ...data, settings: { drawMaxPerRun: a, drawPublicShowLimit: b, drawCooldownSec: c } });
    alert("å·²æ›´æ–°ç³»çµ±è¨­å®š");
  };

  const HasImageInput = typeof ImageInput === "function";

  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­å®š" subtitle="èª¿æ•´æŠ½çæ¨¡æ“¬å™¨é™åˆ¶èˆ‡é¡¯ç¤ºè¡Œç‚º + èƒŒæ™¯åœ–ç‰‡ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰">
      {/* æŠ½çæ¨¡æ“¬å™¨åƒæ•¸ */}
      <div className="grid sm:grid-cols-3 gap-3">
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æŠ½çå–®æ¬¡åé¡ä¸Šé™</label>
          <input
            className="rounded-lg border px-3 py-2"
            type="number" min="1"
            value={draft.drawMaxPerRun}
            onChange={e=>setDraft(d=>({ ...d, drawMaxPerRun: e.target.value }))}
          />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">å…¬é–‹çµæœé¡¯ç¤ºç­†æ•¸ä¸Šé™</label>
          <input
            className="rounded-lg border px-3 py-2"
            type="number" min="1"
            value={draft.drawPublicShowLimit}
            onChange={e=>setDraft(d=>({ ...d, drawPublicShowLimit: e.target.value }))}
          />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æ¨¡æ“¬é‡è·‘å†·å»ï¼ˆç§’ï¼‰</label>
          <input
            className="rounded-lg border px-3 py-2"
            type="number" min="0"
            value={draft.drawCooldownSec}
            onChange={e=>setDraft(d=>({ ...d, drawCooldownSec: e.target.value }))}
          />
        </div>
      </div>

      <div className="flex justify-end mt-3">
        <button onClick={save} className="rounded-lg bg-brand text-white px-4 py-2">å„²å­˜æŠ½çè¨­å®š</button>
      </div>

      {/* åˆ†éš”ç·š */}
      <div className="my-6 border-t border-slate-200 dark:border-slate-700" />

      {/* èƒŒæ™¯åœ–ç‰‡è¨­å®šï¼ˆä¸»ç•«é¢ + æ¼¢å ¡é¸å–®ï¼‰ */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* ä¸»ç•«é¢èƒŒæ™¯ */}
        <div>
          <h3 className="text-base font-semibold mb-3">ğŸ–¼ ä¸»ç•«é¢èƒŒæ™¯</h3>

          <div className="grid gap-2">
            <div>
              {HasImageInput ? (
                <ImageInput label="èƒŒæ™¯åœ–ç‰‡" value={bg.url} onChange={v=>setBg({ ...bg, url: v })} />
              ) : (
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  placeholder="åœ–ç‰‡ç¶²å€æˆ– base64"
                  value={bg.url}
                  onChange={e=>setBg({ ...bg, url: e.target.value })}
                />
              )}
            </div>

            <label className="block text-sm mt-2">äº®åº¦ï¼š{bg.brightness.toFixed(2)}</label>
            <input
              type="range" min="0.6" max="1.4" step="0.02"
              value={bg.brightness}
              onChange={e=>setBg({ ...bg, brightness: parseFloat(e.target.value) })}
            />

            <label className="block text-sm mt-2">æ¨¡ç³Šï¼š{bg.blur}px</label>
            <input
              type="range" min="0" max="20" step="1"
              value={bg.blur}
              onChange={e=>setBg({ ...bg, blur: parseInt(e.target.value,10) })}
            />

            <label className="block text-sm mt-2">é€æ˜åº¦ï¼š{Math.round(bg.opacity*100)}%</label>
            <input
              type="range" min="0" max="1" step="0.05"
              value={bg.opacity}
              onChange={e=>setBg({ ...bg, opacity: parseFloat(e.target.value) })}
            />

            <div className="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label className="block text-sm mb-1">ä½ç½®</label>
                <select
                  className="rounded-lg border px-3 py-2 w-full"
                  value={bg.pos}
                  onChange={e=>setBg({ ...bg, pos: e.target.value })}
                >
                  <option value="center">ç½®ä¸­</option>
                  <option value="top">ç½®é ‚</option>
                  <option value="bottom">ç½®åº•</option>
                  <option value="left">ç½®å·¦</option>
                  <option value="right">ç½®å³</option>
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1">å°ºå¯¸</label>
                <select
                  className="rounded-lg border px-3 py-2 w-full"
                  value={bg.size}
                  onChange={e=>setBg({ ...bg, size: e.target.value })}
                >
                  <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                  <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                  <option value="auto">auto</option>
                </select>
              </div>
            </div>

            <div className="mt-2">
              <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼Œä¾‹ï¼šrgba(255,255,255,0.2)ï¼‰</label>
              <input
                className="rounded-lg border px-3 py-2 w-full"
                placeholder="rgba(â€¦)"
                value={bg.tint}
                onChange={e=>setBg({ ...bg, tint: e.target.value })}
              />
            </div>
          </div>
        </div>

        {/* æ¼¢å ¡é¸å–®èƒŒæ™¯ */}
        <div>
          <h3 className="text-base font-semibold mb-3">ğŸ“‚ æ¼¢å ¡é¸å–®èƒŒæ™¯</h3>

          <label className="inline-flex items-center gap-2 text-sm mb-3">
            <input
              type="checkbox"
              checked={!!bg.menuUseMain}
              onChange={e=>setBg({ ...bg, menuUseMain: e.target.checked })}
            />
            æ²¿ç”¨ä¸»ç•«é¢èƒŒæ™¯ï¼ˆå‹¾é¸å¾Œï¼Œä¸‹åˆ—é¸å–®å°ˆå±¬è¨­å®šæœƒè¢«å¿½ç•¥ï¼‰
          </label>

          {!bg.menuUseMain && (
            <div className="grid gap-2">
              <div>
                {HasImageInput ? (
                  <ImageInput label="é¸å–®èƒŒæ™¯åœ–ç‰‡" value={bg.menuUrl} onChange={v=>setBg({ ...bg, menuUrl: v })} />
                ) : (
                  <input
                    className="rounded-lg border px-3 py-2 w-full"
                    placeholder="åœ–ç‰‡ç¶²å€æˆ– base64"
                    value={bg.menuUrl}
                    onChange={e=>setBg({ ...bg, menuUrl: e.target.value })}
                  />
                )}
              </div>

              <label className="block text-sm mt-2">äº®åº¦ï¼š{bg.menuBrightness.toFixed(2)}</label>
              <input
                type="range" min="0.6" max="1.4" step="0.02"
                value={bg.menuBrightness}
                onChange={e=>setBg({ ...bg, menuBrightness: parseFloat(e.target.value) })}
              />

              <label className="block text-sm mt-2">æ¨¡ç³Šï¼š{bg.menuBlur}px</label>
              <input
                type="range" min="0" max="20" step="1"
                value={bg.menuBlur}
                onChange={e=>setBg({ ...bg, menuBlur: parseInt(e.target.value,10) })}
              />

              <label className="block text-sm mt-2">é€æ˜åº¦ï¼š{Math.round(bg.menuOpacity*100)}%</label>
              <input
                type="range" min="0" max="1" step="0.05"
                value={bg.menuOpacity}
                onChange={e=>setBg({ ...bg, menuOpacity: parseFloat(e.target.value) })}
              />

              <div className="grid grid-cols-2 gap-2 mt-2">
                <div>
                  <label className="block text-sm mb-1">ä½ç½®</label>
                  <select
                    className="rounded-lg border px-3 py-2 w-full"
                    value={bg.menuPos}
                    onChange={e=>setBg({ ...bg, menuPos: e.target.value })}
                  >
                    <option value="center">ç½®ä¸­</option>
                    <option value="top">ç½®é ‚</option>
                    <option value="bottom">ç½®åº•</option>
                    <option value="left">ç½®å·¦</option>
                    <option value="right">ç½®å³</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm mb-1">å°ºå¯¸</label>
                  <select
                    className="rounded-lg border px-3 py-2 w-full"
                    value={bg.menuSize}
                    onChange={e=>setBg({ ...bg, menuSize: e.target.value })}
                  >
                    <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                    <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                    <option value="auto">auto</option>
                  </select>
                </div>
              </div>

              <div className="mt-2">
                <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼‰</label>
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  placeholder="rgba(â€¦)"
                  value={bg.menuTint}
                  onChange={e=>setBg({ ...bg, menuTint: e.target.value })}
                />
              </div>
            </div>
          )}
        </div>
      </div>

      {/* å¿«é€Ÿé¢¨æ ¼ï¼ˆå¯é¸ï¼‰ */}
      <div className="mt-6 flex flex-wrap gap-2">
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.20)", brightness:1.0, blur:2, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…çˆ½</button>
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.35)", brightness:0.95, blur:6, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æŸ”éœ§</button>
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(0,0,0,0.35)", brightness:1.1, blur:0, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æš—åº•</button>
        <button
          onClick={()=>setBg({
            url:"", tint:"rgba(255,255,255,0.0)", brightness:1, blur:0, opacity:1,
            size:"cover", pos:"center",
            menuUseMain:true, menuUrl:"", menuTint:"rgba(255,255,255,0.0)",
            menuBrightness:1, menuBlur:0, menuOpacity:1, menuSize:"cover", menuPos:"center"
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…é™¤èƒŒæ™¯</button>
      </div>
    </Section>
  );
}

function SystemSettings({ data, setData, bg, setBg, admins, setAdmins, currentAdmin, setCurrentAdmin }) {
  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­ç½®" subtitle="é›†ä¸­ç®¡ç†æ‰€æœ‰è¨­å®šé …ç›®ã€‚">
      {/* ä½ åŸæœ¬ä½¿ç”¨çš„ SettingsPanel å®Œæ•´æ¬åˆ°é€™è£¡å‘ˆç¾ */}
      <SettingsPanel data={data} setData={setData} bg={bg} setBg={setBg} />

{/* === ç®¡ç†è€…æ¸…å–®ï¼ˆæœ¬åœ°ï¼‰=== */}
<Section id="admin-list-panel" title="ğŸ‘¤ ç®¡ç†è€…æ¸…å–®" subtitle="æ–°å¢ï¼åˆªé™¤ï¼æ”¹åï¼æ”¹å¯†ç¢¼ï¼ˆè³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿï¼‰ã€‚">
  <div className="grid gap-3">
    {/* åˆ—è¡¨ */}
    <div className="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 dark:bg-slate-800/50">
          <tr>
            <th className="text-left px-3 py-2">åç¨±</th>
            <th className="text-left px-3 py-2">å¯†ç¢¼ç‹€æ…‹</th>
            <th className="text-right px-3 py-2">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {admins.map((a, idx)=>(
            <tr key={idx} className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-2">{a.name}</td>
              <td className="px-3 py-2">{a.passwordHash ? 'å·²è¨­å®š' : 'å°šæœªè¨­å®š'}</td>
              <td className="px-3 py-2">
                <div className="flex justify-end gap-2">
                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const newName = prompt('è¼¸å…¥æ–°åç¨±', a.name) || '';
                      const trimmed = newName.trim();
                      if(!trimmed){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
                      if(trimmed !== a.name && admins.some(x=>x.name === trimmed)){
                        alert('åç¨±å·²å­˜åœ¨'); return;
                      }
                      const next = admins.map(x => x.name === a.name ? ({ ...x, name: trimmed }) : x);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(trimmed); }
                      alert('åç¨±å·²æ›´æ–°');
                    }}
                  >æ”¹å</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const pwd = prompt('è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
                      if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
                      const hash = await hashTextSHA256(pwd);
                      const next = admins.map(x => x.name === a.name ? ({ ...x, passwordHash: hash }) : x);
                      setAdmins(next);
                      alert('å¯†ç¢¼å·²æ›´æ–°');
                    }}
                  >æ”¹å¯†ç¢¼</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={()=>{
                      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ç®¡ç†è€…ã€Œ${a.name}ã€ï¼Ÿ`)) return;
                      const next = admins.filter(x => x.name !== a.name);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(''); setAdminMode(false); }
                      alert('å·²åˆªé™¤');
                    }}
                  >åˆªé™¤</button>
                </div>
              </td>
            </tr>
          ))}
          {admins.length === 0 && (
            <tr className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-6 text-center text-slate-500" colSpan={3}>ç›®å‰æ²’æœ‰ç®¡ç†è€…</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    {/* æ–°å¢ */}
    <div className="flex gap-2">
      <button
        className="rounded-lg border px-3 py-1.5"
        onClick={async ()=>{
          const name = prompt('è¼¸å…¥æ–°ç®¡ç†è€…åç¨±') || '';
          const n = name.trim();
          if(!n){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
          if(admins.some(a => a.name === n)){ alert('åç¨±å·²å­˜åœ¨'); return; }
          const pwd = prompt('è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
          if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
          const hash = await hashTextSHA256(pwd);
          setAdmins([...admins, { name: n, passwordHash: hash }]);
          alert('å·²æ–°å¢ç®¡ç†è€…');
        }}
      >æ–°å¢ç®¡ç†è€…</button>
    </div>
  </div>
</Section>
     
 {/* å¦‚æœªä¾†è¦æ“´å……æ›´å¤šè¨­å®šï¼Œå¯åœ¨æ­¤ç¹¼çºŒåˆ†æ®µ */}
      {/* ä¾‹ï¼šç¶²ç«™è³‡è¨Š / æ¬Šé™ / å‚™ä»½å·¥å…· / ä¸»é¡Œé¢¨æ ¼ ç­‰ */}
    </Section>
  );
}

function ImageInput({ label="åœ–ç‰‡", value="", onChange }) {
  const [mode, setMode] = React.useState(value && /^https?:\/\//i.test(value) ? 'url' : (value ? 'data' : 'url'));
  const fileRef = React.useRef(null);

  const pickFile = ()=> fileRef.current?.click();
  const onFile = async (f)=>{
    if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=> onChange?.(String(e.target?.result||""));
    reader.readAsDataURL(f);
  };

  return (
    <div className="grid gap-1.5">
      <label className="text-sm text-slate-600 dark:text-slate-300">{label}</label>
      <div className="flex items-center gap-2">
        <button
          type="button"
          onClick={()=>setMode('url')}
          className={`px-2 py-1 rounded border text-xs ${mode==='url'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >ç¶²å€</button>
        <button
          type="button"
          onClick={()=>setMode('data')}
          className={`px-2 py-1 rounded border text-xs ${mode==='data'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >æœ¬æ©Ÿæª”æ¡ˆ</button>
      </div>

      {mode==='url' ? (
        <input
          className="rounded-lg border px-3 py-2"
          value={value}
          onChange={e=>onChange?.(e.target.value)}
          placeholder="https://... æˆ–ç›´æ¥è²¼ä¸Šç¶²å€"
        />
      ) : (
        <>
          <div className="flex items-center gap-2">
            <button type="button" onClick={pickFile} className="rounded-lg border px-3 py-2 text-sm">é¸æ“‡æª”æ¡ˆ</button>
            <span className="text-xs text-slate-500">ï¼ˆå°‡è®€ç‚º base64ï¼Œé›¢ç·šä¹Ÿå¯é¡¯ç¤ºï¼‰</span>
          </div>
          <input
            ref={fileRef}
            type="file"
            accept="image/*"
            className="hidden"
            onChange={e=>onFile(e.target.files?.[0]||null)}
          />
        </>
      )}

      {value && (
        <div className="mt-2">
          <img src={value} alt="" className="max-h-40 rounded border bg-slate-50 dark:bg-slate-800 object-contain"/>
        </div>
      )}
    </div>
  );
}

function ShopImageQuickset({ data, setData, admin }) {
  if (!admin) return null; // åªçµ¦ç®¡ç†æ¨¡å¼ç”¨

  const items = Array.isArray(data?.shop?.items) ? data.shop.items : [];

  const [drafts, setDrafts] = React.useState(() =>
    items.map(it => ({ id: it.id || nid(), name: it.name || '', img: it.img || '' }))
  );

  // è‹¥å¤–éƒ¨ items æ”¹è®Šï¼Œè‰ç¨¿åŒæ­¥ä¸€æ¬¡
  React.useEffect(() => {
    setDrafts(items.map(it => ({ id: it.id || nid(), name: it.name || '', img: it.img || '' })));
  }, [items]);

  const normPath = (s) => String(s || '').trim().replace(/^"+|"+$/g, '');

  const saveAll = () => {
    const next = items.map((it, i) => {
      const img = normPath(drafts[i]?.img || '');
      return { ...it, img };   // âœ… ä¿®æ­£ï¼šåŸæœ¬æ˜¯ {.it, img}
    });
    setData({ ...data, shop: { ...(data.shop || {}), items: next } });  // âœ… ä¿®æ­£ï¼šåŸæœ¬æ˜¯ {.data, ...}
    alert('å·²å„²å­˜åœ–ç‰‡è·¯å¾‘åˆ°å•†å“ã€‚ä¹‹å¾Œã€ŒåŒ¯å‡ºã€å³å¯æŠŠè·¯å¾‘å¸¶å‡ºã€‚');
  };

  const applyBaseToEmpty = () => {
    const base = './assets/products/';
    setDrafts(ds => ds.map(d => {
      const v = normPath(d.img);
      if (!v) return d;
      // è‹¥åªæ˜¯æª”åï¼ˆä¸å« / ï¼‰ï¼Œè‡ªå‹•è£œä¸Šè³‡æ–™å¤¾
      if (!v.includes('/')) return { ...d, img: base + v };  // âœ… ä¿®æ­£ï¼šåŸæœ¬æ˜¯ {.d, ...}
      return d;
    }));
  };

  return (
    <section
      className="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4"
      aria-label="å•†å“åœ–ç‰‡è·¯å¾‘å¿«é€Ÿè¨­å®š"
    >
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-base font-semibold">ğŸ–¼ï¸ å•†å“åœ–ç‰‡è·¯å¾‘ï¼ˆå¿«é€Ÿè¨­å®šï¼‰</h3>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={applyBaseToEmpty}
            className="rounded-lg border px-3 py-1.5 text-sm"
            title="è‹¥è¼¸å…¥åƒ…æª”åï¼Œå¹«ä½ è‡ªå‹•åŠ ä¸Š ./assets/products/"
          >
            æª”åè‡ªå‹•è£œè³‡æ–™å¤¾
          </button>
          <button
            type="button"
            onClick={saveAll}
            className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm"
            title="æŠŠè¼¸å…¥çš„è·¯å¾‘å¯«å› data.shop.items"
          >
            å„²å­˜å…¨éƒ¨
          </button>
        </div>
      </div>

      {items.length === 0 ? (
        <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å•†å“é …ç›®ã€‚</div>
      ) : (
        <div className="grid gap-2">
          {drafts.map((d, i) => (
            <div key={i} className="grid sm:grid-cols-2 gap-2 items-center rounded-xl border px-3 py-2">
              <div className="text-sm">
                <div className="font-medium">{items[i]?.name || d.name || 'ï¼ˆæœªå‘½åï¼‰'}</div>
                {items[i]?.id && <div className="text-xs text-slate-500">IDï¼š{items[i].id}</div>}
              </div>
              <input
                className="rounded-lg border px-3 py-2 text-sm"
                placeholder="è²¼ä¸Šåœ–ç‰‡è·¯å¾‘ï¼ˆå¯å« ./assets/products/... æˆ–å®Œæ•´ç¶²å€ï¼‰"
                value={d.img}
                onChange={e => {
                  const v = e.target.value;
                  setDrafts(ds => ds.map((x, j) => (j === i ? { ...x, img: v } : x)));
                }}
              />
            </div>
          ))}
        </div>
      )}

      <p className="mt-3 text-xs text-slate-500">
        å°æé†’ï¼šä¸Šå‚³åœ–ç‰‡åˆ° <code>assets/products/</code> å¾Œï¼Œé€™è£¡å¯ä»¥ç›´æ¥è²¼
        <code> æª”å.jpg</code>ï¼Œå†æŒ‰ã€Œæª”åè‡ªå‹•è£œè³‡æ–™å¤¾ã€ã€‚æˆ–ç›´æ¥è²¼å®Œæ•´ç›¸å°è·¯å¾‘ï¼š<code>./assets/products/æª”å.jpg</code>ã€‚
      </p>
    </section>
  );
}

    // â€”â€” Render â€”â€”
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

</body>
</html>