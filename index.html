<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>開獎所｜官方網站</title>
  <meta name="color-scheme" content="light dark">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          brand: { DEFAULT: '#14b8a6', fg: '#0f766e', amber: '#f59e0b' }
        },
        boxShadow: {
          soft: '0 10px 25px -10px rgb(0 0 0 / 0.25)',
          elevate: '0 12px 30px -12px rgba(0,0,0,.35)'
        },
        borderRadius: { 'xl2': '1rem' },
        keyframes: {
          fadeIn: { '0%': {opacity:0, transform:'translateY(6px)'},
                    '100%': {opacity:1, transform:'translateY(0)'} },
          pulseSoft: { '0%,100%': {opacity:.75}, '50%': {opacity:1} }
        },
        animation: {
          fadeIn: 'fadeIn .35s ease-out both',
          pulseSoft: 'pulseSoft 2.4s ease-in-out infinite'
        }
      }
    }
  }
</script>

  <!-- React 18 UMD + Babel for in-browser JSX -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
 
/* 柔和格點背景 + 漸層基底 */
body {
  background-image:
    radial-gradient(at 20% 0%, rgba(20,184,166,.08), transparent 35%),
    radial-gradient(at 80% 10%, rgba(245,158,11,.08), transparent 35%),
    radial-gradient(at 50% 100%, rgba(15,118,110,.08), transparent 35%);
}

   
    .tap-target{padding:10px 12px; min-width:44px; min-height:44px}

    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  
/* === 背景圖片（整站） ================================== */
html, body { min-height: 100%; }
body::before{
  content:"";
  position: fixed; inset: 0; z-index:-1;
  background-image:
    linear-gradient(var(--bg-tint, rgba(255,255,255,0.0)), var(--bg-tint, rgba(255,255,255,0.0))),
    var(--bg-img, none);
  background-size: var(--bg-size, cover);
  background-position: var(--bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--bg-brightness,1)) blur(var(--bg-blur,0px));
  opacity: var(--bg-opacity,1);
  transition: filter .25s ease, opacity .25s ease, background .25s ease;
}

/* === 漢堡選單背景 ======================= */

.menu-pane{
  position: relative;
  overflow: hidden;
  background: var(--menu-fallback, rgba(255,255,255,.92));
  border-right: 1px solid rgba(15,23,42,.08);
}
.menu-pane::before{
  content:"";
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(var(--menu-tint, rgba(255,255,255,0.0)), var(--menu-tint, rgba(255,255,255,0.0))),
    var(--menu-bg-img, none);
  background-size: var(--menu-bg-size, cover);
  background-position: var(--menu-bg-pos, center);
  background-repeat: no-repeat;
  filter: brightness(var(--menu-brightness,1)) blur(var(--menu-blur,0px));
  opacity: var(--menu-opacity,1);
}
.menu-pane > *{ position: relative; z-index:1; }

/* === Mobile tweaks (不影響桌機) === */
@media (max-width: 640px) {
  .toolbar-grid, .flex-wrap, .px-2 { gap: 8px; }
  .paginator-top { display: none; }     /* 上方分頁器在手機隱藏，保留下方那組 */
  .min-h-\[44px\] { min-height: 44px !important; }
  .sheet-w { width: min(96vw, 560px) !important; }
}

</style>

<!-- [IMGIO CSS START] -->
<style>
  /* 基本：當作容器調整時會用到（背景圖等） */
  [data-img-key]{
    background-repeat: no-repeat;
    background-position: center center;
    background-size: cover;
  }
  /* 若你要用透明度/偏移/縮放等，這裡提供通用 class（JS 會直接改 style，不會動你 class） */

/* === Dark mode 增強：主頁背景與漢堡選單對比/可讀性 === */
/* 以「媒體查詢」偵測系統深色；Tailwind 預設 darkMode: 'media' 也相容 */
@media (prefers-color-scheme: dark) {

  /* 1) 調整全站（主頁）漸層背景在深色下的觀感：更柔和、更有層次 */
  body {
    background-image:
      radial-gradient(at 20% 0%, rgba(20,184,166,.12), transparent 35%),
      radial-gradient(at 80% 10%, rgba(245,158,11,.10), transparent 35%),
      radial-gradient(at 50% 100%, rgba(100,116,139,.18), transparent 38%); /* slate-500-ish */
    /* 這裡不動你原本的 --bg-* 變數；若有自訂背景圖仍會照常套用 */
  }

  /* 2) 提升漢堡抽屜（menu-pane）可讀性：深底＋亮字＋柔和邊界 */
  :root {
    /* 若未另行指定 menu 背景，提供深色下更適合的預設 fallback */
    --menu-fallback: rgba(2, 6, 23, 0.92); /* slate-950 近似值、帶 92% 不透明 */
  }

  .menu-pane {
    background: var(--menu-fallback, rgba(2, 6, 23, 0.92)) !important;
    color: #e5e7eb; /* slate-200：抽屜內一般文字 */
    border-right-color: rgba(148, 163, 184, 0.25); /* slate-400-ish */
  }

  /* 抽屜內的分隔線/邊框，在深色下更柔和 */
  .menu-pane .border,
  .menu-pane .border-b,
  .menu-pane .border-t,
  .menu-pane .border-l,
  .menu-pane .border-r {
    border-color: rgba(148, 163, 184, 0.25) !important;
  }

  /* 抽屜內連結/按鈕維持繼承的亮字色，避免個別元素顏色過暗 */
  .menu-pane a,
  .menu-pane button,
  .menu-pane [role="button"] {
    color: inherit;
  }

  /* 抽屜項目的 hover/active 狀態在深色下給更淺的高亮底，對比更清楚 */
  .menu-pane .hover\:bg-slate-100:hover,
  .menu-pane .active\:bg-slate-100:active {
    background-color: rgba(30, 41, 59, 0.6) !important; /* slate-800 60% */
  }

  /* 抽屜頂部工具列（你原本的 header 區塊）底色與文字也一併優化 */
  .menu-pane .bg-white,
  .menu-pane .bg-white\/85,
  .menu-pane .bg-slate-50 {
    background-color: rgba(2, 6, 23, 0.92) !important;
    color: #e5e7eb !important;
  }
  .menu-pane .text-slate-500 { color: #cbd5e1 !important; } /* slate-300 近似 */
}

:root{
  /* 若你的底部工具列高度不同，這裡改數值即可（手機常見 56~64px） */
  --bottom-nav-height: 56px;
}

/* 給浮動清單條專用，會自動避開底部工具列與安全區 */
.floating-pickbar {
  position: fixed;
  left: 0; right: 0;
  z-index: 40;
  padding-left: 0.75rem; padding-right: 0.75rem; /* = px-3 */
  bottom: calc(env(safe-area-inset-bottom) + var(--bottom-nav-height) + 12px);
}

/* 有浮動條時，頁面底部留出空間避免被擋住 */
.pickbar-spacer {
  height: calc(var(--bottom-nav-height) + 96px);
}

</style>
<!-- [IMGIO CSS END] -->

</head>
<body class="bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useEffect, useState } = React;

    // —— LocalStorage Keys ——
    const LS = { data: 'kjs_site_data_v1', admin: 'kjs_admin_pass' };

  // === Default Settings（可被管理面板覆寫） ===
const DEFAULT_SETTINGS = {
  drawMaxPerRun: 500,      // 單次最多抽出人數上限（名額）
  drawPublicShowLimit: 50, // 公開結果最多顯示幾位
  drawCooldownSec: 10,     // 同一活動重跑冷卻秒數
  contactUrl: ""           // ★ 全域「聯絡管理員」網址（可留空）
};
// === History 狀態選單 ===
const HISTORY_STATUS_OPTIONS = [
  { value: "已寄出",   label: "✅ 已寄出" },
  { value: "處理中",   label: "⏳ 處理中" },
  { value: "未回覆",   label: "🔴 未回覆" },
  { value: "再寄送中", label: "📦 再寄送中" },
  { value: "待寄送",   label: "🟡 待寄送" },
  { value: "放棄領獎", label: "🚫 放棄領獎" },
];
// 顯示用（歷史列表）
const HISTORY_STATUS_ICON = {
  "已寄出":"✅","處理中":"⏳","未回覆":"🔴","再寄送中":"📦","待寄送":"🟡","放棄領獎":"🚫"
};

// ========== 狀態標籤樣式（柔和、不刺眼） ==========
const HISTORY_STATUS_STYLE = {
  "已寄出":   { bg: "bg-emerald-100/70 dark:bg-emerald-300/15", text: "text-emerald-700 dark:text-emerald-300", ring:"ring-emerald-500/20" },
  "處理中":   { bg: "bg-sky-100/70 dark:bg-sky-300/15",         text: "text-sky-700 dark:text-sky-300",         ring:"ring-sky-500/20" },
  "未回覆":   { bg: "bg-rose-100/70 dark:bg-rose-300/15",       text: "text-rose-700 dark:text-rose-300",       ring:"ring-rose-500/20" },
  "再寄送中": { bg: "bg-indigo-100/70 dark:bg-indigo-300/15",   text: "text-indigo-700 dark:text-indigo-300",   ring:"ring-indigo-500/20" },
  "待寄送":   { bg: "bg-amber-100/70 dark:bg-amber-300/15",     text: "text-amber-800 dark:text-amber-300",     ring:"ring-amber-500/20" },
  "放棄領獎": { bg: "bg-slate-200/70 dark:bg-slate-300/15",     text: "text-slate-700 dark:text-slate-300",     ring:"ring-slate-400/20" },
};

/* =========================================
 * 全域捲動鎖：避免彈窗/檢視器異常造成整站卡住
 * ========================================= */
(function(){
  const lockKey = "__BODY_SCROLL_LOCK_COUNT__";
  if (!window[lockKey]) window[lockKey] = 0;
  function apply() {
    if (window[lockKey] > 0) {
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";
    } else {
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      document.body.style.touchAction = "";
    }
  }
  window.BodyScrollLock = {
    lock() { window[lockKey] = Math.max(0, (window[lockKey]||0)) + 1; apply(); },
    unlock() { window[lockKey] = Math.max(0, (window[lockKey]||0) - 1); apply(); },
    reset() { window[lockKey] = 0; apply(); }
  };
  // 保險機制：頁面隱藏/離開時自動還原
  window.addEventListener("pagehide", ()=>window.BodyScrollLock.reset());
  document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState !== "visible") window.BodyScrollLock.reset(); });
})();

// === 列頭：日期 / 獎品名稱(截斷) / 狀態（靠右不換行） ===
function HistoryHeaderRow({ rec }) {
  const date = formatDateYMD(rec?.date || "") || "—";
  const title = rec?.title || "（未命名）";
  const status = rec?.status || "";

  return (
    <div className="grid grid-cols-[94px_1fr_auto] sm:grid-cols-[110px_1fr_auto] items-center gap-2 sm:gap-3 w-full">
      {/* 日期：等寬字體，固定寬度 */}
      <span className="font-mono text-[13px] text-slate-500">{date}</span>

      {/* 名稱：單行截斷，手機限制字數更緊 */}
      <div className="flex items-center min-w-0">
        <span className="mr-2" aria-hidden="true">🎁</span>
        <span
          className="truncate max-w-[18ch] sm:max-w-[48ch] text-[15px]"
          title={title}
        >
          {title}
        </span>
      </div>

      {/* 狀態：固定在右側、不可縮小 */}
      <div className="shrink-0">
        <StatusTag value={status} />
      </div>
    </div>
  );
}


/*** =========================
 * 共用：標籤彙整、標籤勾選條、選購清單（離線剪貼簿）
 * ========================== */

// 從 item 陣列自動彙整唯一標籤（跳過空字串）
function collectUniqueTags(items, tagField='tags') {
  const set = new Set();
  for (const it of (items||[])) {
    const tags = Array.isArray(it?.[tagField]) ? it[tagField] :
                 typeof it?.[tagField] === 'string' ? it[tagField].split(',') : [];
    for (const t of tags) {
      const v = String(t||'').trim();
      if (v) set.add(v);
    }
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
}

// HOOK：多選標籤（增：setPicked 以支援彈窗一次套用）
function useTagFilter(allTags = []) {
  const [picked, setPicked] = React.useState([]);
  const toggle = (t) =>
    setPicked((list) => (list.includes(t) ? list.filter((x) => x !== t) : [...list, t]));
  const clear = () => setPicked([]);
  return { picked, toggle, clear, setPicked, allTags };
}

// 元件：標籤 Chips（可多選）
function TagChips({ tags=[], picked=[], onToggle, onClear }) {
  if (!tags.length) return (
    <div className="text-xs text-slate-500">目前沒有標籤</div>
  );
  return (
    <div className="flex items-center gap-2 overflow-x-auto no-scrollbar py-1">
      {tags.map(t => {
        const active = picked.includes(t);
        return (
          <button
            key={t}
            onClick={()=>onToggle(t)}
            className={
              "tap-target rounded-full border px-3 py-1 text-sm whitespace-nowrap " +
              (active ? "bg-brand text-white border-brand" : "bg-white/70 dark:bg-slate-900/60")
            }
            title={active ? "取消此標籤" : "選取此標籤"}
          >
            {t}
          </button>
        );
      })}
      {picked.length>0 && (
        <button onClick={onClear} className="tap-target rounded-full border px-3 py-1 text-sm whitespace-nowrap">
          清除標籤
        </button>
      )}
    </div>
  );
}

/* === 詳情視窗底部：數量步進 + 加入清單（支援現金/點數） === */
function SheetPickControls({ item, mode='cash' }) {
  const React = window.React || globalThis.React;
  const pick = usePickList(mode==='pts' ? 'kjs_pointshop_picklist' : 'kjs_store_picklist');

  // 取 id / 名稱 / 價格或點數（相容多欄位）
  const id    = String(item?.id ?? (item?.name ?? 'item'));
  const name  = item?.name || item?.title || '（未命名）';
  const price = mode==='cash'
    ? (['price','cash','priceNTD','priceTWD'].map(k=>item?.[k]).find(v => v!=='' && v!=null))
    : null;
  const needPts = mode==='pts'
    ? (['points','pts','need','needPoints','cost','costPts','pricePts']
        .map(k=>+item?.[k]).find(n=>Number.isFinite(n)) ?? null)
    : null;

  const qty = pick.map[id]?.qty || 0;
  const setQ = (n)=> pick.setQty(id, { name, price, pts: needPts }, n);

  return (
    <div className="sticky bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/90 backdrop-blur border-t border-slate-200 dark:border-slate-700 rounded-b-2xl px-3 py-2">
      <div className="flex items-center gap-2">
        <div className="flex items-center gap-1">
          <button className="rounded-lg border px-3 py-2 min-w-[44px]" onClick={()=>setQ(Math.max(0, qty-1))}>－</button>
          <input
            className="w-16 text-center rounded-lg border px-2 py-2"
            inputMode="numeric"
            value={qty||0}
            onChange={e=>setQ(Math.max(0, Number(e.target.value)||0))}
          />
          <button className="rounded-lg border px-3 py-2 min-w-[44px]" onClick={()=>setQ((qty||0)+1)}>＋</button>
        </div>

        <button
          className="ml-auto rounded-lg bg-brand text-white px-4 py-2 shadow-soft"
          onClick={()=>{ if ((qty||0) < 1) setQ(1); alert('✅ 已加入清單，可在底部「完成挑選／複製清單」複製傳給管理員'); }}
        >
          加入清單
        </button>
      </div>

      <div className="mt-1 text-xs text-slate-500">
        {mode==='cash' && price!=null ? <>單價：NT$ {price}</> : null}
        {mode==='pts'  && needPts!=null ? <>每件需：{needPts} 點</> : null}
      </div>
    </div>
  );
}

// ── 直接覆蓋原本的 usePickList，全域同步＋即時更新版本 ──
function usePickList(lsKey = 'kjs_picklist') {
  const read = () => {
    try { return JSON.parse(localStorage.getItem(lsKey) || "{}"); }
    catch { return {}; }
  };

  const [map, setMap] = React.useState(read);

  // 封裝 write：寫入 LS 後發送自定事件，讓同頁其他 hook 也能即時收到
  const write = (next) => {
    try { localStorage.setItem(lsKey, JSON.stringify(next)); } catch {}
    // 同分頁（同一個 tab）的即時同步
    try { window.dispatchEvent(new CustomEvent('kjs:picklist:update', { detail: { key: lsKey } })); } catch {}
  };

  // 設定數量（0 或空值 = 刪除）
  const setQty = (key, payload, qty) => {
    setMap(prev => {
      const next = { ...prev };
      if (!qty || qty <= 0) {
        delete next[key];
      } else {
        next[key] = {
          ...(prev[key] || {}),
          ...payload,
          qty: Math.min(999, Math.max(1, Math.floor(qty)))
        };
      }
      write(next);
      return next;
    });
  };

  // 清空整份清單
  const clear = () => {
    setMap(() => {
      const empty = {};
      write(empty);
      return empty;
    });
  };

  // 跨分頁（或同分頁其他 hook）同步：storage + 自定事件
  React.useEffect(() => {
    const onStorage = (e) => {
      if (e.key === lsKey) setMap(read());
    };
    const onCustom = (e) => {
      if (e?.detail?.key === lsKey) setMap(read());
    };
    window.addEventListener('storage', onStorage);
    window.addEventListener('kjs:picklist:update', onCustom);
    return () => {
      window.removeEventListener('storage', onStorage);
      window.removeEventListener('kjs:picklist:update', onCustom);
    };
  }, [lsKey]);

  const totalQty = Object.values(map).reduce((s, x) => s + (x?.qty || 0), 0);
  return { map, setQty, clear, totalQty };
}

// 生成文字清單（現金或點數）
function buildListText(map, mode='cash') {
  const rows = [];
  let sumCash = 0, sumPts = 0;
  for (const k of Object.keys(map)) {
    const { name, qty, price, pts } = map[k] || {};
    const line = mode==='pts'
      ? `- ${name} x${qty}（${pts ?? '?'} 點）`
      : `- ${name} x${qty}（NT$ ${price ?? '?'}）`;
    rows.push(line);
    if (mode==='pts' && Number.isFinite(+pts)) sumPts += (+pts)*(qty||0);
    if (mode==='cash' && Number.isFinite(+price)) sumCash += (+price)*(qty||0);
  }
  const head = mode==='pts' ? '[點數兌換清單]' : '[購物清單]';
  const tail = mode==='pts'
    ? (rows.length ? `\n合計點數：約 ${sumPts} 點` : '')
    : (rows.length ? `\n預估金額：約 NT$ ${sumCash}` : '');
  return [head, ...rows, tail].filter(Boolean).join('\n');
}

// 複製輔助（離線可用）
async function copyText(s) {
  try { await navigator.clipboard.writeText(String(s)); return true; }
  catch { return false; }
}

/* =========================
* 🧩 TagFilterSheet：標籤挑選彈窗（新增）
* ========================= */
function TagFilterSheet({ open=false, onClose=()=>{}, groups=[], allTags=[], picked=[], onApply=()=>{} }) {
  const React = window.React || globalThis.React;
  if (!open) return null;

  // 本地暫存選擇：打開時或外部 picked 變化時同步
  const [local, setLocal] = React.useState(()=> new Set(picked || []));
  React.useEffect(() => {
    if (open) setLocal(new Set(picked || []));
  }, [open, picked]);

  const toggle = (t) => setLocal(s => { const nx=new Set(s); nx.has(t)?nx.delete(t):nx.add(t); return nx; });
  const clearAll = ()=> setLocal(new Set());

  // 群組 + 其他（未分組）呈現；groups 的順序與每組 tags 的順序皆保留
  const grouped = React.useMemo(()=>{
    const normGroups = Array.isArray(groups) ? groups.map(g => ({
      name: g?.name || '未命名群組',
      tags: Array.isArray(g?.tags) ? g.tags.filter(Boolean) : []
    })) : [];

    const inGroup = new Set(normGroups.flatMap(g => g.tags || []));
    const rest = (Array.isArray(allTags) ? allTags : []).filter(t => !inGroup.has(t));
    return [ ...normGroups, ...(rest.length ? [{ name: '其他', tags: rest }] : []) ];
  }, [groups, allTags]);

  // Escape 關閉（不影響你的原操作）
  React.useEffect(() => {
    if (!open) return;
    const onKey = (e)=>{ if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, onClose]);

  return (
    <div className="fixed inset-0 z-[1000]" role="dialog" aria-modal="true" aria-label="篩選標籤">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="absolute inset-0 flex items-end sm:items-center justify-center p-3">
        <div className="w-[min(96vw,720px)] max-h=[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl flex flex-col">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">篩選標籤</div>
            <div className="flex items-center gap-2">
              <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={clearAll}>清除全部</button>
              <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>關閉</button>
            </div>
          </div>

          <div className="p-3 overflow-y-auto space-y-3">
            {grouped.map((g,gi)=> (
              <div key={(g.name||'其他') + '_' + gi} className="rounded-xl border border-slate-200 dark:border-slate-700">
                <div className="px-3 py-2 font-medium">{g.name || '未命名群組'}</div>
                <div className="px-3 pb-3 flex flex-wrap gap-2">
                  {(g.tags||[]).map(t => (
                    <button
                      key={t}
                      onClick={()=>toggle(t)}
                      className={
                        "tap-target rounded-full border px-3 py-1 text-sm " +
                        (local.has(t) ? "bg-brand text-white border-brand" : "bg-white/70 dark:bg-slate-900/60")
                      }
                    >
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="px-3 py-3 border-t border-slate-200 dark:border-slate-700 flex items-center gap-2">
            <div className="text-xs text-slate-500">已選 {local.size} 個標籤</div>
            <button
              className="ml-auto rounded-lg bg-brand text-white px-4 py-2 text-sm"
              onClick={()=>{
                onApply(Array.from(local));
                onClose();
              }}
            >
              套用
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}




/* =========================
* ⬆️ 覆蓋：浮動挑選條（避免與底部工具列重疊 + a11y + safe-area + portal）
* ========================= */
function FloatingPickbar({ count = 0, onOpen = () => {} }) {
  const React = window.React || globalThis.React;
  const ReactDOM = window.ReactDOM || globalThis.ReactDOM;

  if (!count) return null;

  const node = (
    <div
      className="floating-pickbar"
      // 若外層沒設 safe-area，這裡補一層底部內距，避免被 iOS 導覽列吃掉
      style={{ paddingBottom: 'max(0px, env(safe-area-inset-bottom, 0px))' }}
    >
      <div className="mx-auto max-w-screen-sm rounded-xl2 shadow-elevate border border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur p-2">
        <div className="flex items-center justify-between gap-3">
          {/* 讀屏友善：數量變動會即時播報 */}
          <div className="text-sm" role="status" aria-live="polite" aria-atomic="true">
            已挑選 <span className="font-semibold">{count}</span> 項
          </div>
          <button
            type="button"
            onClick={onOpen}
            className="tap-target rounded-lg bg-brand text-white px-4 py-2 text-sm"
            title="完成挑選／複製清單"
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                onOpen();
              }
            }}
          >
            完成挑選／複製清單
          </button>
        </div>
      </div>
    </div>
  );

  // 若可用 Portal，掛到 body，避免被父層 overflow 截掉
  return (ReactDOM && typeof ReactDOM.createPortal === 'function')
    ? ReactDOM.createPortal(node, document.body)
    : node;
}

// 清單確認對話框（無輸入欄，全部勾選確認）
function ConfirmListDialog({ open, onClose, map, mode = 'cash', onSetQty }) {
  const React = window.React || globalThis.React;
  if (!open) return null;

  const keys = React.useMemo(() => Object.keys(map || {}), [map]);

  // 勾選狀態：對應 keys 變動時同步（新項目默認勾選）
  const [checked, setChecked] = React.useState({});
  React.useEffect(() => {
    setChecked(prev => {
      const next = { ...prev };
      // 移除不存在的 key
      Object.keys(next).forEach(k => { if (!keys.includes(k)) delete next[k]; });
      // 新增的新 key 預設勾選
      keys.forEach(k => { if (!(k in next)) next[k] = true; });
      return next;
    });
  }, [keys]);

  const toggle = (k) => setChecked((c) => ({ ...c, [k]: !c[k] }));

  const qtyOf = (k) => (map?.[k]?.qty || 0);

  // 夾取成非負整數；0 會觸發刪除
  const setQtySafe = (k, n) => {
    const nx = Number.isFinite(+n) ? Math.max(0, Math.floor(+n)) : 0;
    onSetQty?.(k, map?.[k] || {}, nx);
  };

  const buildListText = (m) => {
    const rows = [];
    let sumCash = 0, sumPts = 0;
    for (const k of Object.keys(m)) {
      const { name, qty, price, pts } = m[k] || {};
      if (!qty) continue;
      const line = mode === 'pts'
        ? `- ${name} x${qty}（${pts ?? '?'} 點）`
        : `- ${name} x${qty}（NT$ ${price ?? '?'}）`;
      rows.push(line);
      if (mode === 'pts' && Number.isFinite(+pts)) sumPts += (+pts) * (qty || 0);
      if (mode === 'cash' && Number.isFinite(+price)) sumCash += (+price) * (qty || 0);
    }
    const head = mode === 'pts' ? '[點數兌換清單]' : '[購物清單]';
    const tail = mode === 'pts'
      ? (rows.length ? `\n合計點數：約 ${sumPts} 點` : '')
      : (rows.length ? `\n預估金額：約 NT$ ${sumCash}` : '');
    return [head, ...rows, tail].filter(Boolean).join('\n');
  };

  const listMap = keys
    .filter((k) => checked[k])
    .reduce((o, k) => ((o[k] = map[k]), o), {});
  const text = buildListText(listMap);

  return (
    <div className="fixed inset-0 z-[1000]" role="dialog" aria-modal="true">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="sheet-w w-[min(560px,96vw)] max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">{mode === 'pts' ? '點數兌換清單' : '購物清單'}</div>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>關閉</button>
          </div>

          <div className="p-3 overflow-y-auto max-h-[calc(86vh-96px)] space-y-2">
            {keys.length === 0 ? (
              <div className="text-sm text-slate-500">尚未挑選任何商品</div>
            ) : keys.map((k) => {
              const x = map[k] || {};
              return (
                <div key={k} className="flex items-center justify-between gap-3 rounded-lg border px-3 py-2">
                  <label className="flex items-center gap-2 min-w-0 flex-1">
                    <input type="checkbox" checked={!!checked[k]} onChange={() => toggle(k)} />
                    <div className="min-w-0">
                      <div className="truncate text-sm">{x.name}</div>
                      <div className="text-xs text-slate-500">
                        {mode === 'pts'
                          ? `需要 ${x.pts ?? '?'} 點 × ${x.qty}`
                          : `NT$ ${x.price ?? '?'} × ${x.qty}`}
                      </div>
                    </div>
                  </label>

                  {/* 數量步進器 */}
                  <div className="flex items-center gap-1">
                    <button className="rounded border px-2 py-1" onClick={() => setQtySafe(k, qtyOf(k) - 1)}>－</button>
                    <input
                      className="w-14 text-center rounded border px-2 py-1"
                      inputMode="numeric"
                      value={qtyOf(k)}
                      onChange={(e) => setQtySafe(k, e.target.value)}
                    />
                    <button className="rounded border px-2 py-1" onClick={() => setQtySafe(k, qtyOf(k) + 1)}>＋</button>
                  </div>

                  {/* 刪除 */}
                  <button className="rounded border px-2 py-1 text-sm" title="刪除此項" onClick={() => setQtySafe(k, 0)}>🗑</button>
                </div>
              );
            })}
          </div>

          <div className="p-3 border-t border-slate-200 dark:border-slate-700 flex items-center gap-2">
            <button
              className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm"
              onClick={async () => {
                try { await navigator.clipboard.writeText(text); alert('✅ 已複製清單，請貼到官方 LINE 帳號聯絡管理員確認。'); onClose(); }
                catch { alert('無法自動複製，請手動選取文字複製：\n\n' + text); }
              }}
            >
              複製清單
            </button>
            <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>取消</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// 管理員專用：顯示某一位成員「全部」點數異動紀錄
function FullLogsDialog({ open=false, onClose=()=>{}, logs=[], people=[], person=null }) {
  if (!open) return null;
  const name = person?.name || '（未命名）';
  const list = Array.isArray(logs) ? logs : [];

  return (
    <div className="fixed inset-0 z-[1100]" role="dialog" aria-modal="true">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="w-[min(96vw,720px)] max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-elevate flex flex-col">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">「{name}」的全部點數異動</div>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>關閉</button>
          </div>

          <div className="p-3 overflow-y-auto text-sm">
            {list.length === 0 ? (
              <div className="text-slate-500">目前沒有異動紀錄</div>
            ) : (
              <div className="grid gap-2">
                {list.map(l => (
                  <div key={l.id || (l.at + String(l.delta))}
                       className="flex items-center justify-between rounded-lg border px-3 py-2">
                    <div className="min-w-0 truncate">
                      <span className="font-medium">
                        {people.find(x => x.id === l.personId)?.name || '(已刪)'}
                      </span>
                      <span className="mx-2">｜</span>
                      <span className={l.delta > 0 ? 'text-emerald-600' : 'text-rose-600'}>
                        {l.delta > 0 ? `+${l.delta}` : l.delta}
                      </span>
                      {l.note && <span className="mx-2 text-slate-500">｜{l.note}</span>}
                    </div>
                    <div className="shrink-0 text-xs text-slate-500">{l.at}</div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="px-3 py-3 border-t border-slate-200 dark:border-slate-700 flex items-center gap-2">
            <button
              className="rounded-lg bg-brand text-white px-3 py-2 text-sm"
              onClick={async ()=>{
                const text = list.map(l=>{
                  const who = people.find(x=>x.id===l.personId)?.name || '(已刪)';
                  return `${l.at}｜${who}｜${l.delta>0?`+${l.delta}`:l.delta}｜${l.note||''}`;
                }).join('\n');
                try { await navigator.clipboard.writeText(text); alert('✅ 已複製全部異動紀錄'); }
                catch { alert('無法自動複製，請手動選取'); }
              }}
            >
              複製全部
            </button>
            <button className="ml-auto rounded-lg border px-3 py-2 text-sm" onClick={onClose}>關閉</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// 依 tagGroups 的群組順序 + 群內順序來產生扁平的標籤清單
function orderTagsByGroups(allTags = [], groups = []) {
  const seen = new Set();
  const out = [];

  // 先依群組內順序排
  (Array.isArray(groups) ? groups : []).forEach(g => {
    (g?.tags || []).forEach(t => {
      if (allTags.includes(t) && !seen.has(t)) {
        seen.add(t);
        out.push(t);
      }
    });
  });

  // 再把剩下未分組/未涵蓋的補上（維持 allTags 原本順序）
  allTags.forEach(t => { if (!seen.has(t)) out.push(t); });

  return out;
}


// 社群商店（現金購買）— 「搜尋改標籤」＋「一鍵購物清單」，九/十六宮格保留
function Store({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  const prefKey = "store_prefs_v5";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9");
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(() => savePrefs({ view }), [view]);
  React.useEffect(() => savePrefs({ pageSize }), [pageSize]);

  const [showEditor, setShowEditor] = React.useState(false);
  const HasStoreEditor = typeof StoreEditor === "function";

  const [sheet, setSheet] = React.useState({ open: false, item: null });

  // ★ 新增：標籤小卡彈窗開關 & 群組資料來源
  const [tagSheetOpen, setTagSheetOpen] = React.useState(false);
  const tagGroups = Array.isArray(data?.store?.tagGroups) ? data.store.tagGroups : [];

  const safeNumber = (v) => {
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) return +v;
    return null;
  };
  const getRemain = (x) => [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find((n) => n != null);

  const itemsRaw = Array.isArray(data?.store?.items) ? data.store.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : it?.image ? [String(it.image)] : [];
    const tags = Array.isArray(it?.tags)
      ? it.tags
      : typeof it?.tags === "string"
      ? it.tags.split(",").map((s) => s.trim()).filter(Boolean)
      : [];
    return { ...it, _images: images.filter(Boolean), _tags: tags };
  };
  const allItems = React.useMemo(() => itemsRaw.map(normalizeItem), [itemsRaw]);

  const allTags = React.useMemo(() => collectUniqueTags(allItems, "_tags"), [allItems]);

  // ★ 新增：依群組排序的扁平 tags（保留；目前未在 Toolbar 顯示 chips）
  const tagsOrdered = React.useMemo(
    () => orderTagsByGroups(allTags, tagGroups),
    [allTags, tagGroups]
  );
  const tag = useTagFilter(allTags);

  const [sortBy, setSortBy] = React.useState("latest");
  const [onlyInStock, setOnlyInStock] = React.useState(false);

  const filtered = React.useMemo(() => {
    return allItems.filter((x) => {
      const okTag = !tag.picked.length || tag.picked.every((t) => (x._tags || []).includes(t));
      const remain = getRemain(x);
      const okStock = !onlyInStock || remain == null || remain > 0;
      return okTag && okStock;
    });
  }, [allItems, tag.picked, onlyInStock]);

  const sorted = React.useMemo(() => {
    const arr = [...filtered];
    if (sortBy === "priceAsc") arr.sort((a, b) => (+a?.price || Infinity) - (+b?.price || Infinity));
    else if (sortBy === "priceDesc") arr.sort((a, b) => (+b?.price || -Infinity) - (+a?.price || -Infinity));
    else arr.sort((a, b) => new Date(b?.updatedAt || b?.createdAt || 0) - new Date(a?.updatedAt || a?.createdAt || 0));
    return arr;
  }, [filtered, sortBy]);

  const total = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(() => { if (page > maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(() => { setPage(1); }, [tag.picked, sortBy, view, pageSize, onlyInStock]);
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize / 2), maxPage - windowSize + 1));
  const endPage = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems = sorted.slice(start, end);

  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  const pick = usePickList("kjs_store_picklist");
  const [showConfirm, setShowConfirm] = React.useState(false);

  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        {/* ⛔ 移除：整排 TagChips 不再顯示，只保留彈窗按鈕 */}
        {/* <TagChips tags={tagsOrdered} picked={tag.picked} onToggle={tag.toggle} onClear={tag.clear} /> */}

        {/* ★ 篩選標籤按鈕（顯示已選數量） */}
        <button className="rounded-lg border px-3 py-2" onClick={() => setTagSheetOpen(true)}>
          {tag.picked.length > 0 ? `篩選標籤（${tag.picked.length}）` : "篩選標籤"}
        </button>

        <select className="rounded border px-2 py-2" value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
          <option value="latest">最新更新</option>
          <option value="priceAsc">價格（低→高）</option>
          <option value="priceDesc">價格（高→低）</option>
        </select>
        <label className="flex items-center gap-1">
          <input type="checkbox" checked={onlyInStock} onChange={(e) => setOnlyInStock(e.target.checked)} />
          只看有貨
        </label>

        <label className="flex items-center gap-1">
          版面
          <select className="rounded border px-2 py-2" value={view} onChange={(e) => setView(e.target.value)}>
            <option value="grid9">9 宮格</option>
            <option value="grid16">16 宮格</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          每頁
          <select className="rounded border px-2 py-2" value={pageSize} onChange={(e) => setPageSize(+e.target.value || 20)}>
            <option value="20">20</option>
            {/* ★ 修正：40 的 option 多餘字元 */}
            <option value="40">40</option>
            <option value="80">80</option>
          </select>
        </label>

        <div className="grow basis-full sm:basis-auto" />
        {admin && HasStoreEditor && (
          <button className="rounded-lg border px-3 py-2" onClick={() => setShowEditor(true)}>管理</button>
        )}
      </div>
    </div>
  );

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>上一頁</button>
      {Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i).map((p) => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p === page ? "bg-brand text-white border-brand" : ""}`} onClick={() => setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page >= maxPage} onClick={() => setPage((p) => Math.min(maxPage, p + 1))}>下一頁</button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      <div className={`grid ${gridCols} gap-3`} aria-label="社群商店清單">
        {pageItems.map((x, i) => {
          const id = x.id || i;
          const name = x?.name || "（未命名）";
          const price = (x?.price ?? "") !== "" ? +x.price : null;
          const cover = Array.isArray(x._images) && x._images.length > 0 ? x._images[0] : "";
          const buyUrl = x?.buyUrl || x?.url || "";
          const remain = getRemain(x);

          return (
            <div key={id} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none flex flex-col">
              <button className="block w-full text-left p-3 pb-2" onClick={() => setSheet({ open: true, item: x })} title={name}>
                <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                  {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">無圖片</div>}
                </div>
              </button>

              <button className="px-3 text-left" onClick={() => setSheet({ open: true, item: x })} title={name}>
                <div className="text-[13px] font-medium truncate">{name}</div>
                {Array.isArray(x._tags) && x._tags.length > 0 && (
                  <div className="text-xs text-slate-500 truncate">{x._tags.join(" / ")}</div>
                )}
              </button>

              <div className="px-3 pt-2 pb-1">
                <div className="text-sm font-semibold tabular-nums">
                  {price != null ? `NT$ ${price}` : "　"}
                  {remain != null && <span className="ml-2 text-xs font-normal text-slate-500">剩餘：{remain}</span>}
                </div>
              </div>

              {(x?.availability === "預售" || x?.availability === "現貨") && (
                <div className="px-3 pb-1">
                  <span
                    className={
                      "inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs " +
                      (x.availability === "預售"
                        ? "bg-amber-100 text-amber-800 dark:bg-amber-300/15 dark:text-amber-300"
                        : "bg-emerald-100 text-emerald-700 dark:bg-emerald-300/15 dark:text-emerald-300")
                    }
                  >
                    {x.availability === "預售" ? "⏳ 預售" : "✅ 現貨"}
                  </span>
                </div>
              )}

              <div className="px-3 pb-3 mt-1">
                {buyUrl ? (
                  <a href={buyUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center justify-center w-full rounded-lg bg-brand text-white px-4 py-2 text-sm shadow-soft" title="前往購買">
                    前往購買
                  </a>
                ) : (
                  <button disabled className="inline-flex items-center justify-center w-full rounded-lg border px-4 py-2 text-sm text-slate-400" title="尚未提供購買連結">
                    尚未提供購買連結
                  </button>
                )}
              </div>
            </div>
          );
        })}
      </div>

      <Paginator />

      {admin && HasStoreEditor && showEditor && (
        <StoreEditor data={data} setData={setData} onClose={() => setShowEditor(false)} />
      )}

      <ProductSheet open={sheet.open} item={sheet.item} context="store" onClose={() => setSheet({ open: false, item: null })} />

      {/* 浮動清單條＋確認清單 */}
      <FloatingPickbar count={pick.totalQty} onOpen={() => setShowConfirm(true)} />
      <ConfirmListDialog open={showConfirm} onClose={() => setShowConfirm(false)} map={pick.map} mode="cash" onSetQty={(k, p, n) => pick.setQty(k, p, n)} />

      {/* ★ 新增：標籤小卡彈窗掛載點 */}
      <TagFilterSheet
        open={tagSheetOpen}
        onClose={() => setTagSheetOpen(false)}
        groups={tagGroups}
        allTags={allTags}
        picked={tag.picked}
        onApply={(list) => tag.setPicked(list)}
      />

      {/* ★ 避免被底部挑選條遮住的空白區 */}
      {pick.totalQty > 0 && <div className="pickbar-spacer" />}
    </section>
  );
}

function StoreCard({ item }) {
  const images = Array.isArray(item?.images) ? item.images.filter(Boolean) : [];
  const thumb = images[0] || '';
  return (
    <CardCollapse
      summary={
        <div className="p-3 space-y-2">
          <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
            {thumb
              ? <img src={thumb} alt="" className="w-full h-full object-contain" loading="lazy" />
              : <div className="w-full h-full flex items-center justify-center text-slate-400">無圖</div>}
          </div>
          <div className="flex items-center justify-between gap-2">
            <div className="min-w-0">
              <div className="font-medium truncate" title={item?.name||''}>
                {item?.name || '（未命名）'}
              </div>
              {Array.isArray(item?.tags) && item.tags.length>0 && (
                <div className="text-xs text-slate-500 truncate" title={item.tags.join(' / ')}>
                  {item.tags.join(' / ')}
                </div>
              )}
            </div>
            {(item?.price ?? '') !== '' && (
              <div className="shrink-0 font-semibold">{String(item.price)}</div>
            )}
          </div>
        </div>
      }
    >
      {/* 詳細內容（展開後才顯示） */}
      <div className="space-y-3">
        {/* 圖片輪播（縮圖切換） */}
        {images.length > 0 && <ImageStrip images={images} alt={item?.name||'商品圖片'} />}

        {/* 介紹文字 */}
        {item?.desc && (
          <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
            {item.desc}
          </p>
        )}

        {/* 操作列 */}
        <div>
          {item?.buyUrl ? (
            <a
              href={item.buyUrl}
              target="_blank" rel="noopener noreferrer"
              className="inline-flex items-center justify-center w-full rounded-lg bg-brand text-white px-4 py-2 text-sm shadow-soft"
              title="前往購買"
            >
              前往購買
            </a>
          ) : (
            <button
              disabled
              className="inline-flex items-center justify-center w-full rounded-lg border px-4 py-2 text-sm text-slate-400"
              title="尚未提供購買連結"
            >
              尚未提供購買連結
            </button>
          )}
        </div>
      </div>
    </CardCollapse>
  );
}

/* 簡易圖片縮圖帶切換 */
function ImageStrip({ images = [], alt = '' }) {
  const [idx, setIdx] = React.useState(0);
  const main = images[idx] || images[0] || '';
  return (
    <div className="space-y-2">
      {/* 大圖預覽 */}
      <div className="rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800">
        {main
          ? <img src={main} alt={alt} className="w-full h-auto object-cover" loading="lazy" />
          : <div className="w-full aspect-[4/3] flex items-center justify-center text-slate-400">無圖片</div>}
      </div>

      {/* 縮圖：改用 Grid，會自動換行成多列 */}
      {images.length > 1 && (
        <div className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          {images.map((src, i) => (
            <button
              key={src + i}
              onClick={() => setIdx(i)}
              className={
                "w-full aspect-square rounded-lg overflow-hidden border " +
                (i === idx ? "border-brand ring-2 ring-brand/50" : "border-slate-200 dark:border-slate-700")
              }
              title={`圖片 ${i + 1}`}
            >
              <img src={src} alt="" className="w-full h-full object-cover" loading="lazy" />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

/*********************************
 * 🛒 商店編輯器（Admin 專用）
 * - 多圖：一行一張 URL
 * - 匯出 CSV：含 images 陣列（以 | 串接）
 *********************************/
function StoreEditor({ data, setData, onClose }) {
  const items = Array.isArray(data?.store?.items) ? data.store.items : [];
  const [drafts, setDrafts] = React.useState(() => items.map(cloneStoreItem));
  const [filter, setFilter] = React.useState('');

  // ★ 新增：群組狀態（初始化自 data.store.tagGroups）
  const [groupsState, setGroupsState] = React.useState(() =>
    Array.isArray(data?.store?.tagGroups)
      ? data.store.tagGroups.map(g => ({ name: g?.name || '', tags: Array.isArray(g?.tags) ? [...g.tags] : [] }))
      : []
  );
  // ★ 動態蒐集全部標籤（提供給群組編輯器）
  const allTags = React.useMemo(() => normalizeAllTagsFromItems(drafts), [drafts]);

  function cloneStoreItem(it = {}) {
    return {
      id: it.id || nid(),
      name: it.name || '',
      price: it.price ?? '',
      stock: it.stock ?? '',
      desc: it.desc || it.intro || '',
      images: Array.isArray(it.images) ? it.images.filter(Boolean) : [],
      imagesText: Array.isArray(it.images) ? it.images.join('\n') : '',
      buyUrl: it.buyUrl || '',
      tags: Array.isArray(it.tags) ? it.tags.filter(Boolean) : [],
      // ★ 新增：現貨/預售欄位（預設現貨）
      availability: it.availability || '現貨',
    };
  }

  const filtered = filter
    ? drafts.filter(it =>
        matchText(it.name, filter) ||
        matchText(it.desc, filter) ||
        (Array.isArray(it.tags) && it.tags.some(t => matchText(t, filter)))
      )
    : drafts;

  const up = (id, field, value) => {
    setDrafts(d => d.map(x => (x.id === id ? { ...x, [field]: value } : x)));
  };

  const remove = id => {
    if (!confirmKeyword({ label: '確定要刪除此商品嗎？打「刪除」確認', keyword: '刪除' })) return;
    setDrafts(d => d.filter(x => x.id !== id));
  };

  const addNew = () => {
    setDrafts(d => [
      {
        id: nid(),
        name: '',
        price: '',
        stock: '',
        desc: '',
        images: [],
        buyUrl: '',
        tags: [],
        // ★ 新增：預設現貨
        availability: '現貨',
      },
      ...d,
    ]);
  };

  const saveAll = () => {
    // ★ 一起寫回 tagGroups（經清洗，避免重複/不存在的標籤）
    const cleanedGroups = ensureUniqueTagsInGroups(groupsState, allTags);
    setData(s => ({
      ...s,
      store: { ...(s.store || {}), items: drafts, tagGroups: cleanedGroups },
    }));
    alert('社群商店已儲存');
    onClose?.();
  };

  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="w-full max-w-4xl max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl">
          {/* header */}
          <div className="px-4 py-3 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
            <div className="font-semibold">編輯社群商店</div>
            <div className="flex items-center gap-2">
              <input
                value={filter}
                onChange={e => setFilter(e.target.value)}
                placeholder="搜尋草稿..."
                className="rounded-lg border px-2 py-1.5 text-sm"
              />
              <button onClick={addNew} className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm">新增商品</button>
              <button onClick={() => exportStoreCSV(drafts)} className="rounded-lg border px-3 py-1.5 text-sm">匯出 CSV</button>
              <button onClick={saveAll} className="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm">儲存</button>
              <button onClick={onClose} className="rounded-lg border px-3 py-1.5 text-sm">關閉</button>
            </div>
          </div>

          {/* body */}
          <div className="p-3 overflow-y-auto max-h-[calc(86vh-56px)] space-y-3">
            {/* ★★★ 新增：標籤群組編輯（排序／整合） */}
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                <div className="font-medium">標籤群組（排序／整合）</div>
                <div className="text-xs text-slate-500">未分組標籤會自動歸入「其他」</div>
              </div>
              <div className="p-3">
                <TagGroupsEditor
                  groups={groupsState}
                  allTags={allTags}
                  onChange={setGroupsState}
                />
              </div>
            </div>

            {filtered.length === 0 ? (
              <div className="text-slate-500 text-sm">沒有符合條件的草稿。</div>
            ) : (
              filtered.map(it => (
                <div key={it.id} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3 space-y-2">
                  {/* ★ 原本 md:grid-cols-6 -> 調成 7，容納 availability */}
                  <div className="grid grid-cols-1 md:grid-cols-7 gap-2">
                    <input
                      className="md:col-span-3 rounded-lg border px-3 py-2"
                      placeholder="商品名稱"
                      value={it.name}
                      onChange={e => up(it.id, 'name', e.target.value)}
                    />
                    <input
                      className="md:col-span-1 rounded-lg border px-3 py-2"
                      placeholder="售價（字串或數字）"
                      value={it.price}
                      onChange={e => up(it.id, 'price', e.target.value)}
                    />
                    <input
                      className="md:col-span-1 rounded-lg border px-3 py-2"
                      placeholder="庫存（可省略）"
                      value={it.stock}
                      onChange={e => up(it.id, 'stock', e.target.value)}
                    />
                    {/* ★ 新增：現貨/預售選擇 */}
                    <select
                      className="md:col-span-1 rounded-lg border px-3 py-2"
                      value={it.availability}
                      onChange={e => up(it.id, 'availability', e.target.value)}
                    >
                      <option value="現貨">現貨</option>
                      <option value="預售">預售</option>
                    </select>
                    <input
                      className="md:col-span-1 rounded-lg border px-3 py-2"
                      placeholder="購買連結（buyUrl）"
                      value={it.buyUrl}
                      onChange={e => up(it.id, 'buyUrl', e.target.value)}
                    />
                  </div>

                  <textarea
                    className="w-full rounded-lg border px-3 py-2"
                    placeholder="商品介紹（desc）"
                    rows={3}
                    value={it.desc}
                    onChange={e => up(it.id, 'desc', e.target.value)}
                  />

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <textarea
                      className="rounded-lg border px-3 py-2"
                      placeholder="多張圖片：每行一個 URL（images）"
                      rows={5}
                      value={it.imagesText ?? (it.images || []).join('\n')}
                      onChange={e => {
                        const raw = e.target.value; // 原樣保留（含空白行）
                        up(it.id, 'imagesText', raw); // 1) 儲存原始文字
                        const imgs = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        up(it.id, 'images', imgs); // 2) 同步解析給預覽/儲存用
                      }}
                    />
                    <input
                      className="rounded-lg border px-3 py-2"
                      placeholder="標籤（逗號分隔），例如：玩具,家電"
                      value={(it.tags || []).join(',')}
                      onChange={e =>
                        up(
                          it.id,
                          'tags',
                          e.target.value.split(',').map(s => s.trim()).filter(Boolean)
                        )
                      }
                    />
                  </div>

                  {/* 預覽縮圖列 */}
                  {Array.isArray(it.images) && it.images.length > 0 && (
                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 pt-1">
                      {it.images.map((src, idx) => (
                        <div key={src + idx} className="aspect-square rounded-lg overflow-hidden border">
                          <img src={src} alt="" className="w-full h-full object-cover" />
                        </div>
                      ))}
                    </div>
                  )}

                  <div className="flex justify-between items-center pt-1">
                    <span className="text-xs text-slate-500">ID：{it.id}</span>
                    <button onClick={() => remove(it.id)} className="rounded-lg border px-2 py-1 text-sm">
                      刪除
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


/***********************
 * 匯出 CSV（社群商店）
 ***********************/
function exportStoreCSV(items=[]) {
  const header = ['id','name','price','stock','buyUrl','tags','images','desc'];
  const rows = [header];
  for (const it of (items||[])) {
    rows.push([
      it?.id || '',
      it?.name || '',
      it?.price ?? '',
      it?.stock ?? '',
      it?.buyUrl || '',
      Array.isArray(it?.tags) ? it.tags.join('|') : '',
      Array.isArray(it?.images) ? it.images.join('|') : '',
      (it?.desc || '').replace(/\r?\n/g, ' '),
    ]);
  }
  exportCSV(`store_items_${new Date().toISOString().slice(0,10)}.csv`, rows);
}


// 小元件：狀態膠囊（含 emoji，統一規格）
function StatusTag({ value }) {
  const v = String(value || "").trim();
  if (!v) return null;
  const icon = HISTORY_STATUS_ICON[v] || "🏷️";
  const style = HISTORY_STATUS_STYLE[v] || { bg: "bg-slate-100/70 dark:bg-slate-300/10", text: "text-slate-600 dark:text-slate-300", ring:"ring-slate-400/20" };
  return (
    <span
      className={[
        "inline-flex items-center justify-center gap-1.5 px-2.5 py-1 rounded-full text-xs min-w-[80px] text-center",
        "border border-transparent ring-1", style.ring, style.bg, style.text
      ].join(" ")}
      title={`狀態：${v}`}
    >
      <span aria-hidden="true">{icon}</span>
      <span className="leading-none">{v}</span>
    </span>
  );
}


// —— 小工具 ——（你剛剛不小心刪掉的）
const cx = (...xs) => xs.filter(Boolean).join(' ');
const nid = () => Math.random().toString(36).slice(2,10);

function useLocalState(key, initial){
  const [state, setState] = React.useState(()=>{
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    }catch{
      return initial;
    }
  });
  React.useEffect(()=>{
    localStorage.setItem(key, JSON.stringify(state));
  },[key, state]);
  return [state, setState];
}

// 文字名單清洗：去空白、全/半形空白、連續空白、大小寫不敏感去重
function parseLinesClean(txt="") {
  const normalize = s => s.replace(/\u3000/g, " ").replace(/\s+/g, " ").trim();
  const set = new Set(), out = [];
  for (const raw of String(txt).split(/\r?\n/)) {
    const v = normalize(raw);
    if (!v) continue;
    const key = v.toLowerCase();
    if (!set.has(key)) { set.add(key); out.push(v); }
  }
  return out;
}

// —— 文字比對：大小寫不敏感、全形空白轉半形、連續空白歸一化 —— //
function matchText(hay="", needle=""){
  const norm = (s)=> String(s||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase();
  const a = norm(hay), b = norm(needle);
  if (!b) return true; // 空字串視為全部匹配
  return a.includes(b);
}

// —— History 搜尋規則（依模式）—— //
// rec: { title, winners[], note, status, youtube, ... }
// mode: 'all' | 'prize' | 'winner' | 'note'
// q: 關鍵字
function historyMatchByMode(rec, q, mode){
  const m = mode || 'all';
  const title = rec?.title || "";
  const note  = rec?.note  || rec?.desc || "";
  const winners = Array.isArray(rec?.winners) ? rec.winners : [];

  if (!q) return true; // 沒輸入關鍵字 => 不過濾

  switch (m) {
    case 'prize':
      return matchText(title, q);

    case 'winner':
      return winners.some(w => matchText(w, q));

    case 'note':
      // 備註/說明：優先 note/desc，其次 status、youtube 也納入關聯搜尋
      return (
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );

    case 'all':
    default:
      // 全部：title、winners、note/status/youtube 皆納入
      return (
        matchText(title, q) ||
        winners.some(w => matchText(w, q)) ||
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );
  }
}

// === Admin：純前端 SHA-256 雜湊（避免明文存密碼） ===
async function hashTextSHA256(text) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(String(text)));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, "0")).join("");
}


// === 補齊小工具（不依賴回收站） ===
function nowISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function exportCSV(filename, rows){
  const csv = rows
    .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* === Grid 工具（9/16 宮格切換） === */
function useGridSize(lsKey='kjs_grid_cols', defaultCols=3){
  const [cols, setCols] = useLocalState(lsKey, defaultCols); // 3=9宮格, 4=16宮格
  const toggle = ()=> setCols(c => (c===3?4:3));
  const colClass = cols===3 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4';
  const label = cols===3 ? '9 宮格' : '16 宮格';
  return { cols, setCols, toggle, colClass, label };
}

/* 卡片展開容器：點卡片後展開詳細（卡片內部控制 open 狀態） */
function CardCollapse({summary, children, defaultOpen=false}) {
  const [open, setOpen] = React.useState(!!defaultOpen);
  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 shadow-soft overflow-hidden">
      <button
        type="button"
        className="block w-full text-left"
        onClick={()=>setOpen(o=>!o)}
        aria-expanded={open?'true':'false'}
      >
        {summary}
      </button>
      {open && (
        <div className="border-t border-slate-200/70 dark:border-slate-700/70 p-3">
          {children}
        </div>
      )}
    </div>
  );
}

/* =========================================
 * 全域 Viewer（圖片查看器，供各處使用）
 * - 點遮罩空白區域關閉
 * - 左右點/滑切換、雙擊放大、下滑關閉
 * - 使用 BodyScrollLock 避免整站卡住
 * ========================================= */
function Viewer({ state, setState }) {
  const React = window.React || globalThis.React;
  const containerRef = React.useRef(null);
  const imgRef = React.useRef(null);

  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);

  const hasImages = Array.isArray(state?.images) && state.images.length > 0;
  const index = Math.max(0, Math.min(state?.index || 0, (state?.images?.length || 1) - 1));
  const src = hasImages ? state.images[index] : "";

  // 鍵盤 & 鎖捲動（使用全域鎖）
  React.useEffect(() => {
    if (!state?.open) return;
    BodyScrollLock.lock();
    const onKey = (e) => {
      if (e.key === "Escape") setState(v => ({ ...v, open: false }));
      if (e.key === "ArrowLeft") setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      if (e.key === "ArrowRight") setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    return () => { document.removeEventListener("keydown", onKey); BodyScrollLock.unlock(); };
  }, [state?.open, state?.images?.length, setState]);

  // 換圖時重置縮放位移
  React.useEffect(() => { setScale(1); setTx(0); setTy(0); }, [index]);

  const onOverlayClick = (e) => { if (e.target === containerRef.current) setState(v => ({ ...v, open: false })); };
  const onDoubleClick = (e) => { e.preventDefault(); setScale(s => s === 1 ? 2 : 1); if (scale !== 1) { setTx(0); setTy(0); } };

  // 手勢：左右滑換圖、下滑關閉、拖曳平移（放大時）
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchMove = (e) => { if (!dragging) return; const dx = e.touches[0].clientX - sx; const dy = e.touches[0].clientY - sy; if (scale > 1) { setTx(dx / 2); setTy(dy / 2); } };
  const onTouchEnd = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dy) > 120 && Math.abs(dy) > Math.abs(dx)) { setState(v => ({ ...v, open: false })); return; }
    if (Math.abs(dx) > 80 && scale === 1 && hasImages) {
      if (dx > 0) setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      else setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    }
    setTx(0); setTy(0);
  };

  if (!state?.open) return null;

  return (
    <div ref={containerRef} className="fixed inset-0 z-[999] bg-black/85 flex flex-col" role="dialog" aria-modal="true" onClick={onOverlayClick}>
      <div className="flex items-center justify-between px-3 py-2 text-white text-sm">
        <div className="truncate pr-2">{state?.title || ""}</div>
        <div className="flex items-center gap-2">
          {hasImages && <span>{index + 1} / {state.images.length}</span>}
          <button className="px-2 py-1 rounded bg-white/10" onClick={() => setState(v => ({ ...v, open: false }))}>關閉</button>
        </div>
      </div>

      <div className="relative flex-1 flex items-center justify-center select-none"
           onDoubleClick={onDoubleClick} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
        {hasImages && (
          <>
            <button className="absolute left-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length })); }} aria-label="上一張" />
            <button className="absolute right-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index + 1) % v.images.length })); }} aria-label="下一張" />
          </>
        )}
        {src
          ? <img ref={imgRef} src={src} alt="" style={{ transform: `translate(${tx}px, ${ty}px) scale(${scale})`, transition: 'transform .15s ease-out' }}
                 className="max-w-[min(100vw,1200px)] max-h-[calc(100vh-90px)] object-contain select-none" />
          : <div className="text-white/70">無圖片</div>}
      </div>

      <div className="px-3 py-2 border-t border-white/10 text-xs text-white/70 text-center">
        左右滑動換圖 · 雙擊放大 · 點空白關閉
      </div>
    </div>
  );
}


/* ============================
 * 等待開獎（清單 + 跳出式資訊 + 抽獎展示）
 * - 不刪任何既有功能（編輯/新增/刪除/三種轉歷史/搜尋/分頁/9或16宮格…）
 * - 點卡片：打開 ProductSheet（context="pending"）
 * ============================ */
function Pending({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;
  const nidSafe = (typeof nid === "function") ? nid : () => Math.random().toString(36).slice(2);

  const prefKey = "pending_prefs_v2";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9"); // grid9 / grid16
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // 兼容：pending.items 或 pending 陣列
  const raw = Array.isArray(data?.pending?.items) ? data.pending.items :
              (Array.isArray(data?.pending) ? data.pending : []);

  const parseLinesClean = (txt) => String(txt||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    const tags   = Array.isArray(it?.tags) ? it.tags   : (typeof it?.tags === "string" ? it.tags.split(",").map(s=>s.trim()).filter(Boolean) : []);
    let candidates = [];
    if (Array.isArray(it?.participants)) candidates = it.participants;
    else if (Array.isArray(it?.members)) candidates = it.members;
    else if (Array.isArray(it?.list)) candidates = it.list;
    else if (Array.isArray(it?.candidates)) candidates = it.candidates;
    else if (typeof it?.listText === "string") candidates = parseLinesClean(it.listText);
    const planned = Number.isFinite(+it?.plannedWinners) ? +it.plannedWinners : 1;
    return { ...it, _images: images, _tags: tags, _candidates: candidates.map(String).filter(Boolean), _planned: planned };
  };

  const allItems = React.useMemo(()=> raw.map(normalizeItem), [raw]);

  // ===== 新增：我的名字 + 參與狀態篩選 =====
  const [myName, setMyName] = React.useState("");        // 使用者輸入的「我的名字」（精確比對）
  const [mineFilter, setMineFilter] = React.useState("all"); // all / joined / notJoined

  // 搜尋（先跑關鍵字）
  const [search, setSearch] = React.useState(query || "");
  const filteredBySearch = React.useMemo(()=>{
    const kw = String(search||"").trim().toLowerCase();
    return allItems.filter(x=>{
      const hay = [x?.title, x?.name, x?.desc, x?.intro, x?._tags?.join(" ")].map(s=>String(s||"").toLowerCase()).join(" ");
      return !kw || hay.includes(kw);
    });
  }, [allItems, search]);

  // 再依「我的名字」分成 我已參加 / 我未參加 / 全部
  const filtered = React.useMemo(()=>{
    const name = myName.trim();
    if (!name) return filteredBySearch; // 沒輸入名字 → 不做參與狀態切分
    const joinedSet = new Set(
      filteredBySearch
        .filter(x => Array.isArray(x._candidates) && x._candidates.includes(name))
        .map(x => x.id ?? x)
    );
    if (mineFilter === "joined") {
      return filteredBySearch.filter(x => joinedSet.has(x.id ?? x));
    } else if (mineFilter === "notJoined") {
      return filteredBySearch.filter(x => !joinedSet.has(x.id ?? x));
    }
    return filteredBySearch; // all
  }, [filteredBySearch, myName, mineFilter]);

  // 排序（按更新時間）
  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered]);

  // 分頁
  const total = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  // ★ 保留你的重置行為，並加上 myName/mineFilter 讓每次切換都回到第 1 頁
  React.useEffect(()=>{ setPage(1); }, [search, view, pageSize, myName, mineFilter]);

  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems = sorted.slice(start, end);

  // Viewer（保留你原本的鍵盤左右切圖與 overflow 鎖定）
  const [viewer, setViewer] = React.useState({ open:false, images:[], index:0, title:"" });
  React.useEffect(()=>{
    if (!viewer.open) return;
    const onKey = (e)=>{
      if (e.key==="Escape") setViewer(v=>({ ...v, open:false }));
      if (e.key==="ArrowLeft") setViewer(v=>({ ...v, index:(v.index-1+v.images.length)%v.images.length }));
      if (e.key==="ArrowRight") setViewer(v=>({ ...v, index:(v.index+1)%v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return ()=>{ document.removeEventListener("keydown", onKey); document.body.style.overflow = prev; };
  }, [viewer.open, viewer.images.length]);
  const openViewer = (images, index, title="")=>{
    const list = Array.isArray(images) ? images.filter(Boolean) : (images ? [images] : []);
    if (!list.length) return;
    setViewer({ open:true, images:list, index: Math.max(0, Math.min(index||0, list.length-1)), title });
  };

  // 表單（新增/編輯）
  const [draft, setDraft] = React.useState({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  const [editingId, setEditingId] = React.useState(null);

  function upsertFromDraft() {
    if (!admin) return alert("請先登入管理模式");
    const title = (draft.title || "").trim();
    if (!title) return alert("請填寫【獎項名稱】");
    const planned = draft.plannedWinners !== "" ? Number(draft.plannedWinners) : 1;
    if (draft.plannedWinners !== "" && !Number.isFinite(planned)) return alert("抽出名額需為數字");
    const rec = {
      id: editingId || nidSafe(),
      title,
      date: draft.date || "",
      image: (draft.image || "").trim(),
      participants: parseLinesClean(draft.participantsText),
      plannedWinners: planned
    };
    if (editingId) {
      const next = raw.map(x => x.id === editingId ? rec : x);
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); setEditingId(null); alert("已儲存修改");
    } else {
      const next = [rec, ...raw];
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); alert("已新增活動");
    }
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function editItem(x) {
    if (!admin) return;
    setEditingId(x?.id || null);
    setDraft({
      date: x?.date || "",
      title: x?.title || "",
      image: x?.image || (Array.isArray(x?._images)&&x._images[0]) || "",
      participantsText: Array.isArray(x?._candidates) ? x._candidates.join("\n") : (Array.isArray(x?.participants) ? x.participants.join("\n") : ""),
      plannedWinners: Number.isFinite(+x?._planned) ? String(x._planned) : (x?.plannedWinners ?? "")
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function cancelEdit(){
    setEditingId(null);
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function removeItemObj(x){
    if (!admin) return;
    if (!confirm("確定刪除此活動？")) return;
    const next = raw.filter(it => (it.id ?? it) !== (x.id ?? x));
    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
    setData(s => ({ ...s, pending: nextP }));
  }

  // 轉歷史（共用）
  function convertToHistoryByWinners(id, winners) {
    if (!admin) return;
    const now = raw.find(x => x.id === id);
    if (!now) return;
    const rest = raw.filter(x => x.id !== id);
    const history = Array.isArray(data?.history) ? data.history : [];
    const rec = {
      id: nidSafe(),
      date: now.date || "",
      title: now.title || "",
      winners: Array.isArray(winners) ? winners : [],
      status: "已抽出",
      note: ""
    };
    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: rest } : rest;
    setData(s => ({ ...s, pending: nextP, history: [rec, ...history] }));
    alert("已轉入歷史");
  }

  // 管理用：一次性模擬（不走動畫；展示動畫用 DrawSimulator）
  function simulateOnce(list, count){
    const names = Array.isArray(list) ? list.slice() : [];
    const n = Math.max(1, Math.min(count || 1, names.length));
    for (let k = names.length-1; k > 0; k--) {
      const j = Math.floor(Math.random()*(k+1));
      [names[k], names[j]] = [names[j], names[k]];
    }
    return names.slice(0, n);
  }
  function convertBySimulation(x){ // 用模擬結果（一次性）
    const winners = simulateOnce(x._candidates, x._planned || 1);
    convertToHistoryByWinners(x.id, winners);
  }
  function convertByChecked(x, checkedMap){
    const names = Object.keys(checkedMap||{}).filter(k => checkedMap[k]);
    if (!names.length) return alert("尚未勾選人員");
    convertToHistoryByWinners(x.id, names);
  }
  function convertByInput(x){
    const txt = prompt("請貼上得獎名單（每行一名）",""); 
    if (txt==null) return;
    const names = parseLinesClean(txt);
    if (!names.length) return alert("沒有有效人名");
    convertToHistoryByWinners(x.id, names);
  }

  // 一鍵複製抽獎貼文（含自動星期）
  function copyAdText(x){
    const planned = Number.isFinite(+x?._planned) ? +x._planned : 1;
    const dateStr = String(x?.date || "").trim(); // 例如 2025-09-08
    const weekday = (s) => {
      if (!s) return "";
      const d = new Date(s + "T00:00:00");
      const zh = ["日","一","二","三","四","五","六"];
      return zh[d.getDay()] || "";
    };
    const endW = weekday(dateStr);
    let announceDate = "";
    let announceW = "";
    if (dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate()+1);
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
      announceDate = `${y}-${m}-${dd}`;
      announceW = weekday(announceDate);
    }
    const perCount = 1; // 每人預設 1
    const howTo = "直接在這篇留言「我要參加」即可！";

    const text = [
      "🎉【限時抽獎來啦！】🎉",
      "這次要送出的獎品是 👇",
      "",
      `🎁 ${x?.title || "（獎品名稱）"}`,
      `共抽 ${planned} 名，每人 ${perCount} ！`,
      "",
      `📌 抽出名額：${planned} 位幸運兒`,
      `📅 截止時間：${dateStr ? `${dateStr}（星期${endW}）` : "（自選/填日期）"} 晚上 23:59 前`,
      `🕰 開獎公告：${announceDate ? `${announceDate}（星期${announceW}）` : "（截止翌日）"} 晚間公布於群組`,
      "",
      "📣 參加方式：（可自填）",
      howTo,
      "",
      "✅ 完全免費參加",
      "✅ 得獎只需自付運費（可選貨到付款）",
    ].join("\n");

    navigator.clipboard?.writeText(text)
      .then(()=>alert("已複製抽獎貼文"))
      .catch(()=>alert("無法自動複製，請手動選取"));
  }

  // 跳出式資訊面板
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // 抽獎展示
  const [draw, setDraw] = React.useState({ open:false, item:null });

  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  // 分頁器（保留你的 windowSize/startPage/endPage 寫法）
  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>上一頁</button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>下一頁</button>
    </div>
  );

  // 工具列（新增「我的名字」與三段式切換）
  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        <input className="min-h-[44px] flex-1 rounded border px-3 py-2" placeholder="搜尋活動..." value={search} onChange={e=>setSearch(e.target.value)} />

        {/* 新增：輸入你的名字（精確比對） */}
        <input className="min-h-[44px] rounded border px-3 py-2" style={{minWidth:220}} placeholder="輸入你的名字（精確比對）" value={myName} onChange={e=>setMyName(e.target.value)} />

        {/* 新增：切換 全部 / 我已參加 / 我未參加 */}
        <div className="inline-flex rounded-lg overflow-hidden border">
          <button className={`px-3 py-2 text-sm ${mineFilter==='all'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('all')}>全部</button>
          <button className={`px-3 py-2 text-sm ${mineFilter==='joined'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('joined')}>我已參加</button>
          <button className={`px-3 py-2 text-sm ${mineFilter==='notJoined'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('notJoined')}>我未參加</button>
        </div>

        <label className="flex items-center gap-1">
          版面
          <select className="min-h-[44px] rounded border px-2 py-1" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 宮格</option><option value="grid16">16 宮格</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          每頁
          <select className="min-h-[44px] rounded border px-2 py-1" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>
        {admin && (
          <button className="ml-auto rounded-lg border px-3 py-1.5" onClick={()=>window.scrollTo({top:0,behavior:"smooth"})}>新增/編輯</button>
        )}
      </div>
    </div>
  );

  // 卡片（完整保留你原本的 details + 勾選名單 + 各種管理按鈕）
  const Card = ({ x, i }) => {
    const title = x?.title || x?.name || '（未命名）';
    const cover = Array.isArray(x?._images) && x._images.length>0 ? x._images[0] : (x?.image || "");
    const images = x._images || (cover ? [cover] : []);
    const count  = Array.isArray(x._candidates) ? x._candidates.length : 0;

    const [checkedMap, setCheckedMap] = React.useState({});
    const toggleCheck = (name) => setCheckedMap(m => ({...m, [name]: !m[name]}));

    return (
      <details key={x.id || i} className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden">
        <summary className="list-none cursor-pointer p-3" onClick={(e)=>{ e.preventDefault(); setSheet({ open:true, item:x }); }}>
          <div className="flex flex-col">
            <div className="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
              {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">無圖片</div>}
              <div className="absolute left-2 top-2 rounded bg-black/60 text-white text-xs px-2 py-1">候選 {count} 人</div>
            </div>
            <div className="mt-2 text-[13px] font-medium truncate" title={title}>{title}</div>
            {x.date && <div className="text-xs text-slate-500">日期：{x.date}</div>}
          </div>
        </summary>

        {/* 展開內容（保留相容；仍可展開） */}
        <div className="px-3 pb-3">
          {Array.isArray(images) && images.length>0 && (
            <div className="mt-2 -mx-1 px-1 flex overflow-x-auto gap-2 snap-x snap-mandatory">
              {images.map((src,idx)=>(
                <button key={idx} className="shrink-0 w-24 aspect-square rounded-lg overflow-hidden border snap-start bg-white/60 dark:bg-slate-900/50" title={`圖片 ${idx+1}`} onClick={(e)=>{ e.preventDefault(); openViewer(images, idx, title); }}>
                  <img src={src} alt="" className="w-full h-full object-contain" loading="lazy" />
                </button>
              ))}
            </div>
          )}

          {/* 管理員操作（保留） */}
          {admin && (
            <div className="mt-3 space-y-2">
              {/* 勾選名單 */}
              <div>
                <div className="mb-1 text-sm font-medium">已報名（{x._candidates.length} 人）</div>
                {x._candidates.length===0 ? <div className="text-slate-500">尚無名單</div> : (
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
                    {x._candidates.map((n,ii)=>(
                      <label key={ii} className="rounded border px-2 py-1 flex items-center gap-2">
                        <input type="checkbox" checked={!!checkedMap[n]} onChange={()=>toggleCheck(n)} />
                        <span>{n}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>

              {/* 管理按鈕 */}
              <div className="flex flex-wrap gap-2 justify-end">
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>editItem(x)}>編輯</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>copyAdText(x)}>一鍵複製抽獎貼文</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertBySimulation(x)}>以模擬結果轉歷史</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByChecked(x, checkedMap)}>以勾選名單轉歷史</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByInput(x)}>直接輸入名單轉歷史</button>
                <button className="rounded-lg bg-rose-500 text-white px-3 py-1.5" onClick={()=>removeItemObj(x)}>刪除</button>
              </div>
            </div>
          )}
        </div>
      </details>
    );
  };

  return (
    <section className="space-y-3">
      {/* 新增/編輯表單（管理員可見） */}
      {admin && (
        <div className="rounded-xl border p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="min-h-[44px] rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d, date:e.target.value}))} placeholder="開獎/截止日期"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d, title:e.target.value}))} placeholder="獎項名稱"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.plannedWinners} onChange={e=>setDraft(d=>({...d, plannedWinners:e.target.value}))} placeholder="抽出名額（可空，預設1）"/>
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.image} onChange={e=>setDraft(d=>({...d, image:e.target.value}))} placeholder="封面圖片 URL（可空）"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">已報名名單（每行一位）</label>
            <textarea className="mt-1 w-full rounded-lg border p-2 h-28" value={draft.participantsText} onChange={e=>setDraft(d=>({...d, participantsText:e.target.value}))}/>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-3 py-1.5">取消</button>}
            <button onClick={upsertFromDraft} className="rounded-lg bg-brand text-white px-3 py-1.5">{editingId?"儲存修改":"新增活動"}</button>
          </div>
        </div>
      )}

      {/* 工具列 + 分頁器 */}
      <div className="sticky top-0 z-10"><Toolbar /></div>
      <div className="sm:flex"><Paginator /></div>

      {/* 清單 */}
      <div className={`grid ${gridCols} gap-3`} aria-label="等待開獎清單">
        {pageItems.map((x, i) => <Card key={x.id || i} x={x} i={i} />)}
      </div>

      <Paginator />

      {/* 內建 Viewer（共用） */}
      <Viewer state={viewer} setState={setViewer} />

      {/* 跳出式資訊面板（等待開獎） */}
      <ProductSheet
        open={sheet.open}
        item={sheet.item}
        context="pending"
        admin={!!admin}
        onClose={()=>setSheet({ open:false, item:null })}
        onOpenViewer={(images, idx, title)=>openViewer(images, idx, title)}
        onStartDraw={(it)=>setDraw({ open:true, item:it })}
        onAdmin={{
          onEdit:  (it)=>editItem(it),
          onDelete:(it)=>removeItemObj(it),
          onCopyAd:(it)=>copyAdText(it),
          onConvertBySim:(it)=>convertBySimulation(it),
          // 面板與卡片的勾選 state 不同：這裡提供快速「全選轉歷史」
          onConvertByChecked:(it)=>{
            convertByChecked(it, Object.fromEntries((it?._candidates||[]).map(n=>[n,true])));
          },
          onConvertByInput:(it)=>convertByInput(it),
          checkedMap:{}, toggleCheck:()=>{}
        }}
      />

      {/* 抽獎展示（全螢幕覆蓋） */}
      <DrawSimulator
        open={draw.open}
        onClose={()=>setDraw({ open:false, item:null })}
        participants={draw.item ? normalizeItem(draw.item)._candidates : []}
        defaultCount={draw.item ? normalizeItem(draw.item)._planned || 1 : 1}
      />
    </section>
  );
}


/* ============================
 * 跳出式資訊面板（社群商店 / 點數商城 / 等待開獎）
 * ============================ */
function ProductSheet({
  open = false,
  item = null,
  context = "store",
  onClose = () => {},
  onOpenViewer = () => {},
  contactUrl = "",
  onCopyTemplate = () => {},
  onStartDraw = () => {},        // for pending：開展示動畫
  admin = false,                 // for pending：是否顯示管理區塊
  onAdmin = {}                   // for pending：{ onEdit, onDelete, onConvertBySim, onConvertByChecked, onConvertByInput, onCopyAd, checkedMap, toggleCheck }
}) {
  const React = window.React || globalThis.React;

  // ---- hooks 皆無條件呼叫（避免 #310）----
  const overlayRef = React.useRef(null);
  const [index, setIndex] = React.useState(0);

  // 鎖捲動 / ESC / 返回鍵（使用全域鎖）
  React.useEffect(() => {
    if (!open) return;
    BodyScrollLock.lock();
    const onKey = (e) => { if (e.key === "Escape") onClose(); };
    const onPop = () => onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    try { history.pushState({ sheet: true }, "", location.href); } catch {}
    return () => {
      document.removeEventListener("keydown", onKey);
      window.removeEventListener("popstate", onPop);
      BodyScrollLock.unlock();
    };
  }, [open, onClose]);

  // item 變動重置圖片索引
  React.useEffect(() => { setIndex(0); }, [item]);

  // ---- 非 hook 的衍生資料 ----
  const title = (item?.title || item?.name || "（未命名）");
  const images = (() => {
    const arr = Array.isArray(item?.images) ? item.images : (item?.image ? [String(item.image)] : []);
    return (arr || []).filter(Boolean);
  })();
  const tags = (() => {
    if (Array.isArray(item?.tags)) return item.tags;
    if (typeof item?.tags === "string") return item.tags.split(",").map(s => s.trim()).filter(Boolean);
    return [];
  })();
  const buyUrl = item?.buyUrl || item?.url || "";
  const price  = (item?.price ?? "") !== "" ? item?.price : null;
  const needPoints = (() => {
    const p = item?.points ?? item?.point ?? item?.needPoints ?? item?.need_point;
    const n = (typeof p === "string" ? +p : p);
    return Number.isFinite(n) ? n : null;
  })();
  const remain = item?.stock ?? item?.qty ?? item?.quantity ?? item?.remaining ?? null;

  // pending：候選名單（不寫回資料）
  const candidates = (() => {
    const list = Array.isArray(item?.participants) ? item.participants
      : Array.isArray(item?.members) ? item.members
      : Array.isArray(item?.list) ? item.list
      : Array.isArray(item?.candidates) ? item.candidates
      : (typeof item?.listText === "string" ? item.listText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean) : []);
    return (list || []).map(String).filter(Boolean);
  })();
  const candidateCount = candidates.length;

  // 觸控左右滑換圖
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchEnd = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy) && images.length > 1) {
      setIndex(i => (dx > 0 ? (i - 1 + images.length) : (i + 1)) % images.length);
    }
  };

  // ---- shop 用聯絡管理員連結（多來源 fallback）----
  const effectiveContactUrl =
    contactUrl ||
    item?.contactUrl ||            // 單一商品可覆寫
    window.__CONTACT_URL__ || "";  // 全域設定（可在初始化時設定）

  if (!open) return null;
  const handleOverlayClick = (e) => { if (e.target === overlayRef.current) onClose(); };

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      onMouseDown={handleOverlayClick}
    >
      <div className="w-[min(96vw,44rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        {/* header */}
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div className="min-w-0">
            <div className="font-semibold truncate">{title}</div>
            {context==="store"   && price!=null      && <div className="text-sm text-slate-500">售價：{price}</div>}
            {context==="shop"    && needPoints!=null && <div className="text-sm text-slate-500">需求點數：{needPoints}</div>}
            {context==="pending" && <div className="text-sm text-slate-500">候選人數：{candidateCount}</div>}
          </div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose}>關閉</button>
        </div>

        {/* 【保留】pending 專用：參與人員名單 */}
        {context === "pending" && (
          <div className="px-4 pt-3 pb-4">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium">參與人員名單</div>
              <div className="text-xs text-slate-500">共 {candidateCount} 位</div>
            </div>

            <div className="max-h-48 sm:max-h-64 overflow-y-auto rounded-lg border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/40 p-3 text-sm leading-6">
              {candidates && candidates.length ? (
                candidates.map((name, i) => (
                  <div key={i} className="truncate">
                    {i + 1}. {name}
                  </div>
                ))
              ) : (
                <div className="text-slate-500">目前沒有參與人員</div>
              )}
            </div>
          </div>
        )}

        {/* body：主圖 + 縮圖 + 文字 */}
        <div className="flex-1 overflow-y-auto">
          <div className="relative bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
            <div className="aspect-square w-full grid place-content-center" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
              {images.length ? (
                <img
                  src={images[index]}
                  alt=""
                  className="w-full h-full object-contain select-none"
                  onClick={() => { if (context === "pending") onOpenViewer?.(images, index, title, buyUrl); }}
                />
              ) : (
                <div className="text-slate-400 text-sm">無圖片</div>
              )}
            </div>
            {images.length>1 && (
              <div className="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1">
                {images.map((_, i) => (
                  <span key={i} className={"h-1.5 w-1.5 rounded-full " + (i===index ? "bg-slate-900 dark:bg-white" : "bg-slate-300 dark:bg-slate-600")}/>
                ))}
              </div>
            )}
          </div>

          {images.length>1 && (
            <div className="px-4 py-3 -mx-1 flex overflow-x-auto gap-2 snap-x snap-mandatory">
              {images.map((src, i) => (
                <button
                  key={src+i}
                  className={"shrink-0 w-20 aspect-square rounded-lg overflow-hidden border snap-start " + (i===index ? "border-brand ring-2 ring-brand/40" : "border-slate-200 dark:border-slate-700")}
                  onClick={()=>setIndex(i)}
                  title={`圖片 ${i+1}`}
                >
                  <img src={src} alt="" className="w-full h-full object-contain" loading="lazy" />
                </button>
              ))}
            </div>
          )}

          <div className="px-4 pb-4 space-y-2 text-sm">
            {context==="store" && remain!=null && <div className="text-slate-600">剩餘數量：{remain}</div>}
            {Array.isArray(tags) && tags.length>0 && <div className="text-slate-500">標籤：{tags.join(" / ")}</div>}
            {item?.desc  && <div className="whitespace-pre-wrap">{item.desc}</div>}
            {item?.intro && <div className="whitespace-pre-wrap">{item.intro}</div>}
            {item?.extra && <div className="whitespace-pre-wrap">{String(item.extra)}</div>}

            {/* pending：管理員用名單勾選（保留功能，不寫回） */}
            {context==="pending" && admin && Array.isArray(candidates) && candidates.length>0 && (
              <div className="mt-2">
                <div className="mb-1 text-sm font-medium">已報名（{candidates.length} 人）</div>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
                  {candidates.map((n,i)=>(
                    <label key={i} className="rounded border px-2 py-1 flex items-center gap-2">
                      <input type="checkbox" checked={!!onAdmin?.checkedMap?.[n]} onChange={()=>onAdmin?.toggleCheck?.(n)} />
                      <span>{n}</span>
                    </label>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* === 詳情底部的「數量步進器 + 加入清單」 === */}
        {item && (context === "store" || context === "shop") ? (
          context === "shop"
            ? <SheetPickControls item={item} mode="pts" />
            : <SheetPickControls item={item} mode="cash" />
        ) : null}

        {/* footer（原樣保留） */}
        <div className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {context==="store" ? (
            <>
              {buyUrl
                ? <a href={buyUrl} target="_blank" rel="noopener noreferrer" className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm text-center">前往購買</a>
                : <button className="flex-1 rounded-lg border px-4 py-2 text-sm text-slate-400" disabled>尚未提供購買連結</button>}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>關閉</button>
            </>
          ) : context==="shop" ? (
            <>
              <button className="flex-1 rounded-lg border px-4 py-2 text-sm" onClick={() => onCopyTemplate(item)}>📋 複製模板</button>
              <button
                className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm"
                onClick={() => {
                  const url = effectiveContactUrl;
                  if (url) window.open(url, "_blank", "noopener,noreferrer");
                  else alert("尚未設定『聯絡管理員』連結：可在商品 data 加上 contactUrl，或在全域設置 window.__CONTACT_URL__。");
                }}
              >
                💬 聯絡管理員
              </button>
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>關閉</button>
            </>
          ) : (
            // pending
            <>
              <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={() => onStartDraw(item)}>🎰 模擬抽獎（展示）</button>
              {admin && (
                <div className="flex-1 flex flex-wrap gap-2 justify-end">
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onEdit?.(item)}>編輯</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onCopyAd?.(item)}>一鍵複製抽獎貼文</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertBySim?.(item)}>以模擬結果轉歷史</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertByChecked?.(item)}>以勾選名單轉歷史</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertByInput?.(item)}>直接輸入名單轉歷史</button>
                  <button className="rounded-lg bg-rose-500 text-white px-3 py-2 text-sm" onClick={()=>onAdmin?.onDelete?.(item)}>刪除</button>
                </div>
              )}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>關閉</button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}


/* ============================
 * 抽獎模擬器（展示用）
 * - 只顯示動畫與結果，不寫回資料、不提供複製/套用
 * props:
 *   open, onClose, participants (string[]), defaultCount (number)
 * ============================ */
function DrawSimulator({ open=false, onClose=()=>{}, participants=[], defaultCount=1 }) {
  const React = window.React || globalThis.React;
  const overlayRef = React.useRef(null);

  const [count, setCount] = React.useState(Math.max(1, defaultCount||1));
  const [duration, setDuration] = React.useState(2200); // 2.2s
  const [running, setRunning] = React.useState(false);
  const [displayName, setDisplayName] = React.useState("");
  const [results, setResults] = React.useState([]);

  React.useEffect(()=>{
    if (!open) return;
    const onKey = (e)=>{ if (e.key==="Escape") onClose(); };
    const onPop = ()=> onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    try { history.pushState({ draw:true }, "", location.href); } catch {}
    return ()=> {
      document.removeEventListener("keydown", onKey);
      window.removeEventListener("popstate", onPop);
      document.body.style.overflow = prev;
    };
  }, [open]);

  const handleOverlayClick = (e)=>{ if (e.target === overlayRef.current && !running) onClose(); };

  const pickWinners = (arr, k) => {
    const list = [...arr];
    for (let i=list.length-1;i>0;i--) {
      const j = Math.floor(Math.random()*(i+1));
      [list[i], list[j]] = [list[j], list[i]];
    }
    return list.slice(0, Math.max(1, Math.min(k, list.length)));
  };

  const start = ()=>{
    if (!Array.isArray(participants) || participants.length===0) { alert("沒有候選名單"); return; }
    setResults([]);
    setRunning(true);
    const startTime = performance.now();
    const total = participants.length;
    let acc = 0, last = startTime;
    const loop = (t)=>{
      const dt = t - last; last = t;
      const p = Math.min(1, (t - startTime) / Math.max(800, duration));
      const ease = 1 - Math.pow(1 - p, 3); // easeOutCubic
      const speed = 30 + (180 - 30) * (1 - ease);
      acc += dt * (speed / 1000) * 20;
      const idx = Math.floor(acc) % total;
      setDisplayName(participants[idx] || "");
      if (p < 1) requestAnimationFrame(loop);
      else { setResults(pickWinners(participants, Math.max(1, +count||1))); setRunning(false); }
    };
    requestAnimationFrame(loop);
  };

  if (!open) return null;

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[1000] bg-black/70 backdrop-blur flex items-center justify-center"
      role="dialog" aria-modal="true"
      onMouseDown={handleOverlayClick}
    >
      <div className="w-[min(96vw,50rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
          <div className="font-semibold">抽獎模擬（展示）</div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose} disabled={running}>關閉</button>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">抽出人數</span>
              <input type="number" min="1" max={Math.max(1, participants.length)} value={count} onChange={e=>setCount(Math.max(1, Math.min(+e.target.value||1, participants.length||1)))} className="w-20 rounded border px-2 py-1" />
            </label>
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">動畫時長(ms)</span>
              <input type="number" min="800" step="100" value={duration} onChange={e=>setDuration(Math.max(800, +e.target.value||2200))} className="w-28 rounded border px-2 py-1" />
            </label>
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 p-6 min-h-[140px] grid place-content-center">
            <div className="text-2xl md:text-3xl font-semibold text-slate-800 dark:text-white tracking-wide animate-pulse select-none">
              {running ? (displayName || "抽選中...") : (results.length ? "抽選完成" : "準備開始")}
            </div>
            {!running && !results.length && (
              <div className="mt-2 text-xs text-slate-500">名單數：{participants.length}</div>
            )}
          </div>

          {!!results.length && (
            <div className="space-y-2">
              <div className="text-sm text-slate-600">中獎名單（{results.length}）</div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {results.map((name, i)=>(
                  <div key={name+i} className="rounded-lg border border-emerald-300/70 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 px-3 py-2 text-sm animate-[fadeIn_.6s_ease-out]">
                    <span className="opacity-70 mr-1">#{i+1}</span>{name}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="p-3 border-t border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {!running && <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={start}>開始抽獎</button>}
          {running && <button className="flex-1 rounded-lg border px-4 py-2 text-sm" disabled>抽選進行中...</button>}
          <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose} disabled={running}>關閉</button>
        </div>
      </div>
    </div>
  );
}

/* 小工具：hash/PRNG（for 種子重現） */
function xmur3(str) { let h = 1779033703 ^ str.length; for (let i=0;i<str.length;i++) { h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h<<13 | h>>>19; } return function() { h = Math.imul(h ^ (h>>>16), 2246822507); h = Math.imul(h ^ (h>>>13), 3266489909); return (h ^= h>>>16) >>> 0; }; }
function mulberry32(a) { return function() { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }

// 取得商品剩餘數量（相容多種欄位命名）
function getRemain(x){
  const cand = [x?.stock, x?.qty, x?.quantity, x?.remaining];
  for (const v of cand){
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    if (typeof v === 'string' && v.trim()!=='' && !Number.isNaN(+v)) return +v;
  }
  return null; // 沒有數量就不顯示
}

// 防呆刪除關鍵字確認（預設關鍵字：刪除）
function confirmKeyword({ label='', keyword='刪除' } = {}){
  const input = prompt(`為了防呆，請輸入「${keyword}」以確認：\n${label}`);
  return input === keyword;
}

// —— 空資料（全部留給你用 Admin 後續新增） ——
// 直接在 EMPTY 內放入 settings（注意 others 後面的逗號）
const EMPTY = {
  homepage: { title: '開獎所', subtitle: '免費抽獎・不定期驚喜', announcements: [] },
  history: [],     // 📚 歷史抽獎紀錄
  pending: [],     // ⏳ 等待開獎
  ongoing: [],     // 🔄 進行中活動

  // 🛍️ 點數商城（原本就有）
  shop: { items: [], people: [] },

  // 🛒（新增）社群商店：真錢販售用；支援多圖、介紹、外部購買連結
  // images: [string]（圖片 URL 或 ImageIO key），會跟著 data 一起匯出
  // buyUrl: 外部購買網址
  // stock: 數量（可選），price: 售價（字串或數字）
  // tags: 例如 ["玩具","家電"]，可被搜尋
  store: { items: [] },

  // 📌 其他資料卡片集合（這行後面一定要逗號）
  others: { cards: [] },

  settings: { ...DEFAULT_SETTINGS },
};



function normName(s=""){ return s.replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase(); }
function parseISODate(d=""){ // 專吃 YYYY-MM-DD（空字串回 NaN）
  if(!d) return NaN;
  // 強制用 UTC 防止時區偏移
  const m = String(d).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return NaN;
  return Date.UTC(+m[1], +m[2]-1, +m[3]);
}
function sortHistoryDesc(arr=[]) {
  const safe = (x)=> {
    const t = parseISODate(x?.date || "");
    return Number.isNaN(t) ? -Infinity : t; // 沒日期的排最下
  };
  return [...arr].sort((a,b)=> safe(b) - safe(a));
}


/* === 統一日期顯示：把 YYYY-MM-DD → YYYY/MM/DD（用 UTC 免時區偏差） === */
function formatDateYMD(ymd=""){
  const ts = parseISODate(ymd);        // 你檔案裡已存在的函式:contentReference[oaicite:2]{index=2}
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2, '0');
  const day = String(d.getUTCDate()).padStart(2, '0');
  return `${y}/${m}/${day}`;
}

/* === 依歷史「狀態」回傳一個柔和底色（可選用） === */
function rowClassByStatus(status=""){
  switch(String(status).trim()){
    case "已寄出":   return "bg-emerald-50/60 dark:bg-emerald-300/10";
    case "處理中":   return "bg-sky-50/60 dark:bg-sky-300/10";
    case "未回覆":   return "bg-rose-50/60 dark:bg-rose-300/10";
    case "再寄送中": return "bg-indigo-50/60 dark:bg-indigo-300/10";
    case "待寄送":   return "bg-amber-50/60 dark:bg-amber-300/10";
    case "放棄領獎": return "bg-slate-50/60 dark:bg-slate-300/10";
    default:         return "";
  }
}

// === Calendar helpers for History ===
function ymdStringUTC(y, mZeroBased, d) {
  const y4 = String(y).padStart(4, '0');
  const m2 = String(mZeroBased + 1).padStart(2, '0');
  const d2 = String(d).padStart(2, '0');
  return `${y4}-${m2}-${d2}`;
}

function buildMonthDaysUTC(y, mZeroBased) {
  // 以 UTC 計算月曆，避免時區偏移
  const first = new Date(Date.UTC(y, mZeroBased, 1));
  const startDow = first.getUTCDay(); // 0=Sun..6=Sat
  const daysInMonth = new Date(Date.UTC(y, mZeroBased + 1, 0)).getUTCDate();

  const days = [];
  for (let i = 0; i < startDow; i++) days.push(null); // 前導空格
  for (let d = 1; d <= daysInMonth; d++) {
    days.push(ymdStringUTC(y, mZeroBased, d));
  }
  return days;
}






// === Utils: 抽獎用（安全隨機 / 可選種子） ===
// 將字串變成 32-bit 整數種子
function hash32(str="") {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
// xorshift32 產生器（可重現）
function makePRNG(seedStr="") {
  if (!seedStr) return null; // 沒種子就用安全隨機
  let x = hash32(seedStr) || 1;
  return function next() {
    // 產 0..1 的浮點數
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    // 轉成 0..1
    return ((x >>> 0) / 4294967296);
  };
}
// Fisher–Yates 洗牌；優先使用 prng，否則用 crypto 安全隨機
function shufflePick(arr, k, prng=null) {
  const a = arr.slice();
  const n = a.length;
  // 只洗到取到 k 個為止
  for (let i = 0; i < k; i++) {
    let r;
    if (prng) {
      r = i + Math.floor(prng() * (n - i));
    } else {
      const buf = new Uint32Array(1);
      crypto.getRandomValues(buf);
      r = i + (buf[0] % (n - i));
    }
    [a[i], a[r]] = [a[r], a[i]];
  }
  return a.slice(0, k);
}

function drawCooldownKey(pendingId){ return `kjs_draw_cd_${pendingId}`; }

// === Announcement helpers (NEW) ===
// 安全把 YYYY-MM-DD 加天數（UTC，不吃時區誤差）
function addDaysUTC(ymd="", days=1){
  const ts = parseISODate(ymd);
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  d.setUTCDate(d.getUTCDate() + days);
  const y = d.getUTCFullYear(), m = d.getUTCMonth(), day = d.getUTCDate();
  return ymdStringUTC(y, m, day);
}

// 依卡片資料產生公告模板（回傳字串）
function buildAnnouncementText(p = {}, opts = {}) {
  const title   = p?.title || p?.name || "（未命名）";
  const planned = Number(p?.planned || p?.quota || p?.winners || 1);
  const deadline = (p?.deadline || p?.date || "").toString().trim();
  const announce = deadline ? plusDays(deadline, 1) : "";
  const howTo = (typeof opts.howTo === "string" && opts.howTo.trim())
    ? opts.howTo.trim()
    : "直接在這篇留言「我要參加」即可！";

  return [
    "🎉【限時抽獎來啦！】🎉",
    "這次要送出的實用好物是 👇",
    "",
    `🎁 ${title}`,
    `📌 抽出名額：${planned} 位幸運兒`,
    `📅 截止時間：${deadline} 晚上 23:59 前`,
    `🕰 開獎公告：${announce} 晚間公布於群組`,
    "",
    "📣 參加方式：(初始如下，應能更改，如有特別任務可自填)",
    howTo,
    "",
    "✅ 完全免費參加",
    "✅ 得獎只需自付運費（可選貨到付款）",
  ].join("\n");
}

// 小工具：把 YYYY-MM-DD 加 N 天
function plusDays(ymd, days){
  const d = new Date(ymd);
  if (Number.isNaN(d.getTime())) return ymd;
  d.setDate(d.getDate() + (days||0));
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2, "0"), dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

// === Collapse（強化版，向下相容）===
// 保留原：header, children, defaultOpen=false, force=null
// 新增：group（同一群手風琴 id），uid（該項唯一 id）
function Collapse({ header, children, defaultOpen=false, force=null, group=null, uid=null }) {
  const { useState, useRef, useEffect } = React;
  const [open, setOpen] = useState(!!defaultOpen);
  const ref = useRef(null);
  const idRef = useRef(uid || Math.random().toString(36).slice(2,10));
  const grp = group || null;

  // force 覆寫（配合你的「全部展開／收合」）
  useEffect(() => {
    if (force === 'open') setOpen(true);
    else if (force === 'close') setOpen(false);
  }, [force]);

  // 高度動畫：依 open/children 重新計算
  useEffect(() => {
    if (!ref.current) return;
    ref.current.style.height = open ? ref.current.scrollHeight + 'px' : '0px';
  }, [open, children]);

  // 手風琴：同群有其它項目打開 → 關閉我
  useEffect(() => {
    if (!grp) return;
    const onOpen = (e) => {
      const { group, uid } = e.detail || {};
      if (group === grp && uid !== idRef.current) setOpen(false);
    };
    document.addEventListener('kjs:accordionOpen', onOpen);
    return () => document.removeEventListener('kjs:accordionOpen', onOpen);
  }, [grp]);

  const handleToggle = () => {
    if (force === 'open' || force === 'close') return;
    const next = !open;
    setOpen(next);
    if (next && grp) {
      const ev = new CustomEvent('kjs:accordionOpen', { detail: { group: grp, uid: idRef.current }});
      document.dispatchEvent(ev);
    }
  };

  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white/70 dark:bg-slate-900/40">
      <button
        className="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-slate-50/80 dark:hover:bg-slate-800/60 transition"
        onClick={handleToggle}
        aria-expanded={open ? 'true' : 'false'}
        type="button"
      >
        <div className="font-medium">
          {typeof header === 'function' ? header(open) : header}
        </div>
        <svg className={"w-4 h-4 transition " + (open ? "rotate-180" : "")} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
      <div ref={ref} className="px-4 pb-4 transition-[height] duration-300 ease-in-out" style={{height: open?'auto':'0px'}}>
        <div className="pt-2">{children}</div>
      </div>
    </div>
  );
}


/***************************************************
 * useAccordionController：手風琴控制（一次只開一個）
 * 也支援「全部展開 / 全部收合」覆寫
 ***************************************************/
function useAccordionController() {
  const [activeId, setActiveId] = React.useState(null); // 正在展開的 id
  const [force, setForce] = React.useState(null);       // 'open' | 'close' | null

  const openAll  = () => setForce('open');
  const closeAll = () => { setForce('close'); setActiveId(null); };
  const clearForce = () => setForce(null);

  // 綁到每個 Collapse 用
  const bind = (id) => ({
    isOpen: force === 'open' ? true : force === 'close' ? false : activeId === id,
    force,
    onToggle: () => {
      if (force) setForce(null); // 只要手動切換，回歸手風琴模式
      setActiveId(prev => (prev === id ? null : id));
    }
  });

  return { activeId, setActiveId, force, setForce, openAll, closeAll, clearForce, bind };
}

    // —— 主 App（Part 1：骨架/導覽/雙模式/匯入匯出，未含編輯器） ——
    function App(){
      const [data, setData] = useLocalState(LS.data, EMPTY);

// 進站時自動抓 ./data/app.json，覆蓋本機資料，並同步管理員名單（admins）
React.useEffect(() => {
  (async () => {
    try {
      const res = await fetch('./data/app.json?v=' + Date.now(), { cache: 'no-store' });
      const raw = await res.json();

      // 同時相容兩種格式：扁平 { ... } 或 包一層 { _meta, data, admins }
      const obj = raw && typeof raw === 'object' && 'data' in raw ? raw.data : raw;

      // 歷史由新到舊
      if (obj && Array.isArray(obj.history)) {
        obj.history = sortHistoryDesc(obj.history);
      }

      // 寫入資料本體
      if (obj && typeof obj === 'object') {
        setData(obj);
      } else {
        console.error('app.json 結構異常：期望為物件，實得', obj);
      }

// ★ 新增：把 app.json 的背景設定也灌回 state（含 url / pos / menu...）
if (raw && typeof raw === 'object' && raw.bg) {
  setBg(raw.bg);
}

// （可選）若你有用 ImageIO，順手把 images 也匯入
if (raw && typeof raw === 'object' && raw.images && window.ImageIO?.importImagesJSON) {
  try { window.ImageIO.importImagesJSON(raw.images); } catch {}
}

      // ★ 新增：若 app.json 提供 admins，覆蓋本機的管理員名單，避免不同步
      if (raw && typeof raw === 'object' && Array.isArray(raw.admins)) {
        setAdmins(raw.admins);
      }
    } catch (e) {
      console.error('讀取 data/app.json 失敗：', e);
    }
  })();
}, []);


// === PointsPanel 展開狀態（預設展開，會記住使用者選擇） ===
const [pointsOpen, setPointsOpen] = useLocalState('kjs_points_open', false);
      
const [tab, setTab] = useState('home'); // home | history | pending | ongoing | shop | others
      const [menuOpen, setMenuOpen] = useState(false);
      const [adminMode, setAdminMode] = useState(false);
      const [query, setQuery] = useState('');
const [queryMode, setQueryMode] = useLocalState('kjs_query_mode', 'all'); // all | prize | winner | note


// === Admin：管理員名單＋目前登入者 ===
const [admins, setAdmins] = useLocalState('kjs_admins', [
  { 
    name: 'admin', 
    passwordHash: '8efdbb89a7394f7a1a3f3a81d1b91a2781a5a66d74f40bfa7f2f5a5a8d79f5f2' 
  }
]);
const [currentAdmin, setCurrentAdmin] = useLocalState('kjs_current_admin', ''); // 空字串＝未登入

// === Admin：登入 Modal 狀態（兩段式）===
const [showAdminLogin, setShowAdminLogin] = React.useState(false);
const [adminLoginStep, setAdminLoginStep] = React.useState(1); // 1=輸入/選擇名稱；2=輸入密碼
const [loginName, setLoginName] = React.useState('');
const [loginPwd, setLoginPwd] = React.useState('');
const [loginAttempts, setLoginAttempts] = React.useState(0);
const [loginLockUntil, setLoginLockUntil] = React.useState(0); // Date.now() 毫秒
const [showAdminHint, setShowAdminHint] = React.useState(false);

// === Admin 密技：長按 5~8 秒（手機）／桌面連點 7 下 ===
const secretHoldMsRef = React.useRef(6000);        // 每次開啟登入視窗，隨機 5000~8000ms
const secretTimerRef = React.useRef(null);
const secretClicksRef = React.useRef(0);
const secretClicksTimerRef = React.useRef(null);

React.useEffect(() => {
  if (showAdminLogin) {
    secretHoldMsRef.current = 5000 + Math.floor(Math.random() * 3000); // 5000~8000
    secretClicksRef.current = 0;
  } else {
    if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
    if (secretClicksTimerRef.current) clearTimeout(secretClicksTimerRef.current);
    secretClicksTimerRef.current = null;
    setShowAdminHint(false);
  }
}, [showAdminLogin, setShowAdminHint]);

function startSecretHold(e) {
  e.preventDefault();
  if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
  secretTimerRef.current = setTimeout(() => {
    setShowAdminHint(true);
    // 5 秒後自動隱藏
    setTimeout(() => setShowAdminHint(false), 5000);
  }, secretHoldMsRef.current);
}
function cancelSecretHold() {
  if (secretTimerRef.current) {
    clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
  }
}

// 桌面：在同一元素上 7 次點擊（4 秒內）
function secretClick() {
  secretClicksRef.current += 1;
  if (!secretClicksTimerRef.current) {
    secretClicksTimerRef.current = setTimeout(() => {
      secretClicksRef.current = 0;
      secretClicksTimerRef.current = null;
    }, 4000);
  }
  if (secretClicksRef.current >= 7) {
    setShowAdminHint(true);
    // 5 秒後自動隱藏
    setTimeout(() => setShowAdminHint(false), 5000);
    // 重置
    secretClicksRef.current = 0;
    if (secretClicksTimerRef.current) { clearTimeout(secretClicksTimerRef.current); secretClicksTimerRef.current = null; }
  }
}


// 封裝：開啟登入視窗 / 登出
function enterAdmin() {
  setLoginName('');
  setLoginPwd('');
  setAdminLoginStep(1);
  setShowAdminLogin(true);
}
function exitAdmin() {
  setAdminMode(false);
  setCurrentAdmin('');
  alert('已登出管理模式');
}

// === Drawer A11y：參考節點 ===
const menuPaneRef = React.useRef(null);     // 抽屜 <aside>
const menuButtonRef = React.useRef(null);   // 開啟抽屜的漢堡按鈕
const appContentRef = React.useRef(null);   // 主內容容器（要 aria-hidden）

// === BackToTop：狀態（滾到一定高度才顯示） ===
const [showBackTop, setShowBackTop] = React.useState(false);

      // 快捷鍵：/ 搜尋、g h 回首頁、g m 開選單
      // 快捷鍵：/ 搜尋、g h 回首頁、g m 開選單
useEffect(()=>{
  let g = false;
  const onKey = (e)=>{
    // 若正在輸入欄位/文字區或組字中就忽略
    const tag = (e.target && e.target.tagName || '').toString().toLowerCase();
    if (e.isComposing || tag === 'input' || tag === 'textarea' || tag === 'select' || e.metaKey || e.ctrlKey || e.altKey) return;

    const k = (e.key || '').toLowerCase();     // ← 防呆
    if (k === '/') { e.preventDefault(); document.getElementById('kjs-search')?.focus(); return; }
    if (k === 'g') { g = true; setTimeout(()=> g = false, 800); return; }
    if (k === 'h' && g) { e.preventDefault(); setTab('home'); return; }
    if (k === 'm' && g) { e.preventDefault(); setMenuOpen(true); return; }
  };
  window.addEventListener('keydown', onKey);
  return ()=> window.removeEventListener('keydown', onKey);
},[]);

// === Drawer A11y：焦點陷阱、Esc 關閉、鎖定 body 滾動 ===
React.useEffect(() => {
  if (!menuOpen) return;

  const pane = menuPaneRef.current;
  if (!pane) return;

  // 1) 鎖 body 滾動
  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';

  // 2) 聚焦抽屜內第一個可聚焦元素
  const selectors = 'a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const focusables = Array.from(pane.querySelectorAll(selectors));
  const first = focusables[0];
  const last = focusables[focusables.length - 1];
  const prevActive = document.activeElement;

  first?.focus();

  // 3) 鍵盤行為：Esc 關閉、Tab 焦點環
  const onKeyDown = (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      setMenuOpen(false);
      return;
    }
    if (e.key === 'Tab' && focusables.length > 0) {
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus(); return;
      }
      if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus(); return;
      }
    }
  };

  document.addEventListener('keydown', onKeyDown);

  // 4) 清理：還原 body、解除監聽、把焦點還給開啟鈕
  return () => {
    document.body.style.overflow = prevOverflow;
    document.removeEventListener('keydown', onKeyDown);
    // 優先回到漢堡按鈕；沒找到就回到原先 focus
    if (menuButtonRef.current && typeof menuButtonRef.current.focus === 'function') {
      menuButtonRef.current.focus();
    } else if (prevActive && typeof prevActive.focus === 'function') {
      prevActive.focus();
    }
  };
}, [menuOpen, setMenuOpen]);

// === BackToTop：滾動監聽（> 480px 才顯示） ===
React.useEffect(() => {
  let ticking = false;
  const threshold = 480; // 你可以改成 400~600 視覺喜好

  const onScroll = () => {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        setShowBackTop(y > threshold);
        ticking = false;
      });
    }
  };

  // 先跑一次，避免初次進頁面在中段位置時狀態不準
  onScroll();

  window.addEventListener('scroll', onScroll, { passive: true });
  return () => window.removeEventListener('scroll', onScroll);
}, []);

// === 背景設定（主畫面 & 漢堡選單） ===
const [bg, setBg] = useLocalState('kjs_bg', {
  url: "",
  tint: "rgba(255,255,255,0.0)",
  brightness: 1,
  blur: 0,
  opacity: 1,
  size: "cover",
  pos: "center",
  menuUseMain: true,
  menuUrl: "",
  menuTint: "rgba(255,255,255,0.0)",
  menuBrightness: 1,
  menuBlur: 0,
  menuOpacity: 1,
  menuSize: "cover",
  menuPos: "center",
});

// 把設定套到 CSS 變數
useEffect(()=>{
  const r = document.documentElement;
  // 主畫面
  r.style.setProperty('--bg-img', bg.url ? `url("${bg.url}")` : 'none');
  r.style.setProperty('--bg-tint', bg.tint);
  r.style.setProperty('--bg-brightness', String(bg.brightness));
  r.style.setProperty('--bg-blur', bg.blur + 'px');
  r.style.setProperty('--bg-opacity', String(bg.opacity));
  r.style.setProperty('--bg-size', bg.size);
  r.style.setProperty('--bg-pos', bg.pos);

  // 漢堡選單
  const useMain = !!bg.menuUseMain;
  const mUrl = useMain ? bg.url : bg.menuUrl;
  const mTint = useMain ? bg.tint : bg.menuTint;
  const mBri  = useMain ? bg.brightness : bg.menuBrightness;
  const mBlur = useMain ? bg.blur : bg.menuBlur;
  const mOpa  = useMain ? bg.opacity : bg.menuOpacity;
  const mSize = useMain ? bg.size : bg.menuSize;
  const mPos  = useMain ? bg.pos : bg.menuPos;

  r.style.setProperty('--menu-bg-img', mUrl ? `url("${mUrl}")` : 'none');
  r.style.setProperty('--menu-tint', mTint);
  r.style.setProperty('--menu-brightness', String(mBri));
  r.style.setProperty('--menu-blur', mBlur + 'px');
  r.style.setProperty('--menu-opacity', String(mOpa));
  r.style.setProperty('--menu-bg-size', mSize);
  r.style.setProperty('--menu-bg-pos', mPos);
}, [bg]);


 // 匯入/匯出（JSON，供你備份搬移）——【整段覆蓋版】
// 本版會把「站內資料 data」與「管理員名單 admins（只含雜湊，不含明文密碼）」一起匯出；
// 匯入時同時支援「新格式（含 data/admins）」與「舊格式（只有 data）」。

const exportJSON = () => {
  // 取出目前所有圖片路徑與調整（ImageIO 會回傳字串 JSON）
  const imagesStr = window.ImageIO ? window.ImageIO.exportImagesJSON() : null;
  const images = imagesStr ? JSON.parse(imagesStr) : null;

  const full = {
    _meta: {
      app: 'kjs',
      version: 2, // 升級一下版本號，方便之後辨識
      exportedAt: new Date().toISOString()
    },
    data,            // 站內資料
    admins,          // 管理員名單（hash）
    images,          // ← 新增：全站圖片路徑與調整（images.v1 結構）
    bg               // ← 新增：背景設定（主畫面 / 漢堡選單）
  };

  const blob = new Blob([JSON.stringify(full, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_full_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// （可選）僅匯出站內資料，不含管理員名單——如果要給一般成員備份，可以綁這顆
const exportDataOnly = () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_data_only_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// 匯入支援兩種格式：
// 1) 新格式：{ _meta?, data: {...}, admins: [...] } —— 同時覆蓋站內資料與管理員名單
// 2) 舊格式：{ ...直接就是 data 內容... } —— 只覆蓋站內資料，保留本機 admins
const importJSON = (file) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const obj = JSON.parse(String(e.target.result || '{}'));

      const looksNew = obj && typeof obj === 'object' && ('data' in obj || 'admins' in obj);

      if (looksNew) {
        const nextData   = obj.data  ?? {};
        const nextAdmins = Array.isArray(obj.admins) ? obj.admins : null;

        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        if (nextAdmins) setAdmins(nextAdmins);

        // ★ 新增：若包了 images（images.v1 結構），呼叫 ImageIO 立即套用
        if (obj.images && window.ImageIO && typeof window.ImageIO.importImagesJSON === 'function') {
          try { window.ImageIO.importImagesJSON(obj.images); } catch {}
        }

        // ★ 新增：若包了 bg（背景設定），直接寫回
        if (obj.bg) {
          try { setBg(obj.bg); } catch {}
        }

        alert(`匯入完成${nextAdmins ? '（含管理員名單）' : ''}，歷史已自動排序`);
      } else {
        // 舊格式：只有 data
        const nextData = obj;
        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        alert('匯入完成（舊格式，已自動排序歷史）');
      }
    } catch {
      alert('匯入失敗：不是有效 JSON');
    }
  };
  reader.readAsText(file);
};


      return (
        <div className="min-h-screen flex flex-col">
          {/* Header */}
          <header className="sticky top-0 z-30 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200/60 dark:border-slate-800">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2">
             <button
  ref={menuButtonRef}
  type="button"
  aria-controls="app-menu-pane"
  aria-expanded={menuOpen ? 'true' : 'false'}
  aria-label="開啟主選單"
  className="tap-target -ml-2"
  onClick={() => setMenuOpen(true)}
  title="開啟選單"
>
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>

              <h1 className="text-lg font-semibold">開獎所</h1>
              <div className="ml-auto flex items-center gap-2">
                <div className="hidden sm:flex items-center gap-2">
  {/* 模式選單 */}
  <label htmlFor="kjs-search-mode" className="sr-only">搜尋模式</label>
  <select
    id="kjs-search-mode"
    value={queryMode}
    onChange={(e)=>setQueryMode(e.target.value)}
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-2 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70"
    title="選擇搜尋模式"
    aria-label="搜尋模式"
  >
    <option value="all">全部</option>
    <option value="prize">獎品名稱</option>
    <option value="winner">得獎者</option>
    <option value="note">備註・說明</option>
  </select>

  {/* 搜尋輸入框 */}
  <label htmlFor="kjs-search" className="sr-only">搜尋關鍵字</label>
  <input
    id="kjs-search"
    value={query}
    onChange={e=>setQuery(e.target.value)}
    placeholder="搜尋...（按 / 聚焦）"
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70 focus:outline-none focus:ring-2 focus:ring-brand"
  />
</div>

                {!adminMode && (
                  <button onClick={enterAdmin} className="tap-target rounded-xl bg-brand text-white px-3 py-1.5 text-sm shadow-soft">管理</button>
                )}
                {adminMode && (
  <div className="flex items-center gap-2">
    <button onClick={exportJSON} className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm">匯出</button>
    <label className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm cursor-pointer">匯入
      <input type="file" accept="application/json" className="hidden" onChange={e=>e.target.files&&importJSON(e.target.files[0])}/>
    </label>

    {/* 將原本的「重設密碼」改成導向系統設置頁（在那裡改帳號/密碼） */}
    <button
      onClick={() => { setTab('system'); /* 可選：帶入錨點 */ const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
      className="tap-target rounded-xl bg-amber-200 text-amber-900 dark:bg-amber-300/20 dark:text-amber-200 px-3 py-1.5 text-sm"
      title="前往系統設置 > 管理者清單"
    >
      管理員設定
    </button>

    <button onClick={exitAdmin} className="tap-target rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-3 py-1.5 text-sm">退出</button>
  </div>
)}

              </div>
            </div>
          </header>

          {/* Main */}
          <div ref={appContentRef} aria-hidden={menuOpen ? 'true' : 'false'}>
  <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">

            {tab==='home' && <Home setTab={setTab} data={data} setData={setData} admin={adminMode} />}

{tab==='links' && <LinksPage data={data} setData={setData} admin={adminMode} />}

            {tab==='history' && <History data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='pending' && <Pending data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='ongoing' && <Ongoing data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='store' && (
  <Store
    data={data}
    admin={adminMode}
    setData={setData}
    query={query}
  />
)}

{tab==='shop' && (
  <>
    {/* 查詢點數：可收合卡（預設展開，記憶狀態） */}
    <section
      className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-0 overflow-hidden"
      aria-label="查詢點數"
    >
      {/* 卡片標題列 */}
      <div className="flex items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <span className="text-lg">💳</span>
          <h2 className="text-base font-semibold">查詢點數</h2>
        </div>
        <button
          type="button"
          aria-controls="points-panel-body"
          aria-expanded={pointsOpen ? 'true' : 'false'}
          onClick={()=>setPointsOpen(v=>!v)}
          className="tap-target rounded-lg border px-3 py-1.5 text-sm"
          title={pointsOpen ? '收合' : '展開'}
        >
          {pointsOpen ? '收合' : '展開'}
        </button>
      </div>

      {/* 分隔線 */}
      <div className="h-px bg-slate-200 dark:bg-slate-700" />

      {/* 卡片內容（可收合） */}
      {pointsOpen && (
        <div id="points-panel-body" className="p-4">
          <PointsPanel data={data} admin={adminMode} setData={setData} />
        </div>
      )}
    </section>

    {/* 與查詢卡片留點間距 */}
    <div className="h-4" />

    {/* 點數商城內容 */}
    <Shop data={data} admin={adminMode} setData={setData} query={query} />

<ShopImageQuickset data={data} setData={setData} admin={adminMode} />

  </>
)}


{tab==='others' && <Others data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}

{tab==='system' && adminMode && (
  <SystemSettings
    data={data}
    setData={setData}
    bg={bg}
    setBg={setBg}
    admins={admins}
    setAdmins={setAdmins}
    currentAdmin={currentAdmin}
    setCurrentAdmin={setCurrentAdmin}
  />
)}

{/* 返回頂部（手機友善）：僅在滾到一定高度後顯示 */}
{showBackTop && (
  <button
    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
    className="fixed right-4 bottom-20 md:bottom-6 z-40 rounded-full border shadow-soft bg-white/90 dark:bg-slate-900/80 backdrop-blur px-3 py-2 tap-target"
    aria-label="回到最上面"
    title="回到最上面"
  >
    ↑
  </button>
)}

{/* === Admin 登入（二段式 Modal）=== */}
{showAdminLogin && (
  <div className="fixed inset-0 z-50">
    {/* 背景：點擊關閉 */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setShowAdminLogin(false)} />
    <div className="absolute inset-0 flex items-center justify-center p-4">
      <div className="relative w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4" onClick={(e)=>e.stopPropagation()}>

{/* （密技）左上角 10×10 px 裝飾點：看起來像裝飾，實際是長按/連點啟動器 */}
<div
  aria-hidden="true"
  tabIndex={-1}
  className="absolute top-1 left-1 w-2.5 h-2.5 rounded-full bg-slate-300/70 dark:bg-slate-600/70 cursor-default select-none"
  // 手機：長按 5~8 秒
  onPointerDown={startSecretHold}
  onPointerUp={cancelSecretHold}
  onPointerLeave={cancelSecretHold}
  onPointerCancel={cancelSecretHold}
  // 桌面：連點 7 下（此元素不顯示任何按鈕樣式，游標不變）
  onClick={secretClick}
  onContextMenu={(e)=>e.preventDefault()} // 阻擋長按叫出選單
/>


        <div className="text-base font-semibold mb-2">管理者登入</div>

        {/* 鎖定提示 */}
        {Date.now() < loginLockUntil && (
          <div className="text-sm text-red-600 mb-2">
            嘗試過多，請稍後再試（{Math.ceil((loginLockUntil - Date.now())/1000)} 秒）
          </div>
        )}

        {/* Step 1：管理者名稱 */}
{adminLoginStep === 1 && (
  <div className="grid gap-2">
    <label className="text-sm text-slate-600 dark:text-slate-300">管理者名稱</label>
    <input
      className="rounded-lg border px-3 py-2"
      placeholder="例如：admin 或輸入新名稱"
      value={loginName}
      onChange={e=>setLoginName(e.target.value)}
      disabled={Date.now() < loginLockUntil}
    />

    {/* 注意：不再顯示任何顯示帳號的按鈕或提示；只在密技觸發時短暫顯示名單 */}
    {showAdminHint && admins.length > 0 && (
      <div className="text-xs text-slate-600 dark:text-slate-300 rounded-lg border px-3 py-2">
        {admins.map((a,i)=>(
          <button
            key={i}
            className="mr-2 mb-1 inline-flex items-center px-2 py-0.5 rounded border hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={()=>setLoginName(a.name)}
            disabled={Date.now() < loginLockUntil}
            title="點一下帶入名稱（5 秒後自動隱藏）"
          >
            {a.name}
          </button>
        ))}
      </div>
    )}

    <div className="flex justify-end gap-2 mt-2">
      <button className="rounded-lg border px-3 py-1.5" onClick={()=>setShowAdminLogin(false)}>取消</button>
      <button
        className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
        onClick={()=>{
          if(!loginName.trim()) { alert('請輸入管理者名稱'); return; }
          setAdminLoginStep(2);
        }}
      >
        下一步
      </button>
    </div>
  </div>
)}


        {/* Step 2：密碼 */}
        {adminLoginStep === 2 && (
          <div className="grid gap-2">
            <label className="text-sm text-slate-600 dark:text-slate-300">密碼</label>
            <input
              type="password"
              className="rounded-lg border px-3 py-2"
              placeholder="請輸入密碼"
              value={loginPwd}
              onChange={e=>setLoginPwd(e.target.value)}
              disabled={Date.now() < loginLockUntil}
            />
            <div className="flex justify-between items-center mt-2">
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setAdminLoginStep(1)}>上一步</button>
              <button
  className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
  disabled={Date.now() < loginLockUntil}
  onClick={async ()=>{
    const name = (loginName||"").trim();
    const pass = (loginPwd||"").trim();            // ← 修正：用 loginPwd，不是 loginPassword

    if(!name || !pass){
      alert("請輸入帳號與密碼");
      return;
    }

    // 直接使用狀態中的管理員名單（不要再讀 LS.admins）
    const list = Array.isArray(admins) ? admins : [];
    const found = list.find(u => u && u.name === name);

    if(!found){
      // 🚫 登入流程不允許建立新管理員（只能用既有帳號登入）
      alert("此帳號不存在，請聯絡既有管理員於「🛠️ 系統設置」新增。");
      return;
    }

    // 必須已設定密碼（有 hash），不允許在登入流程建立或變更密碼
    if(!found.passwordHash || String(found.passwordHash).trim()===""){
      alert("此帳號尚未設定密碼，請先由既有管理員在「🛠️ 系統設置」為該帳號設定密碼。");
      return;
    }

    // 比對 SHA-256 雜湊
    const hash = await hashTextSHA256(pass);
    if(hash !== found.passwordHash){
      alert("密碼錯誤");
      return;
    }

    // ✅ 登入成功
    setCurrentAdmin(name);
    setAdminMode(true);
    setShowAdminLogin(false);
    setLoginName("");
    setLoginPwd("");         // ← 修正：清空 loginPwd（不是 setLoginPassword）
    alert(`已以「${name}」登入管理模式`);
  }}
>
  登入
</button>

            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}

          </main>
</div>

{/* 底部工具列（手機） */}
<nav className="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white/95 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700 backdrop-blur">
  <div className="max-w-5xl mx-auto grid grid-cols-5">
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='home'?'text-brand':'')} onClick={()=>setTab('home')} title="首頁">🏠</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='pending'?'text-brand':'')} onClick={()=>setTab('pending')} title="等待開獎">⏳</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='shop'?'text-brand':'')} onClick={()=>setTab('shop')} title="點數商城">🛍️</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='store'?'text-brand':'')} onClick={()=>setTab('store')} title="社群商店">🛒</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='history'?'text-brand':'')} onClick={()=>setTab('history')} title="歷史紀錄">📚</button>
  </div>
</nav>

          {/* 抽屜式漢堡選單 */}
      {menuOpen && (
  <div className="fixed inset-0 z-50">
    {/* 遮罩：點擊關閉 */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setMenuOpen(false)} />
    {/* 抽屜本體 */}
    <aside
      id="app-menu-pane"
      ref={menuPaneRef}
      role="dialog"
      aria-modal="true"
      aria-label="主選單"
      tabIndex={-1}
      className="menu-pane absolute left-0 top-0 h-full w-80 max-w-[85%] shadow-xl no-scrollbar overflow-y-auto"
    >
      {/* 你的選單內容維持不變：把原本 aside 裡的內容整段貼回來 */}
      <div className="p-4 border-b ... flex items-center justify-between">
  <div className="font-semibold">
    導覽{adminMode && currentAdmin ? <span className="ml-2 text-xs text-slate-500">（{currentAdmin}）</span> : null}
  </div>
        <button className="tap-target" onClick={()=>setMenuOpen(false)} aria-label="關閉">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <nav className="p-2 grid gap-1">
  {/* —— 主導覽 —— */}
  <NavItem
    label="🏠 首頁"
    active={tab==='home'}
    onClick={()=>{ setTab('home'); setMenuOpen(false); }}
  />
 
<NavItem
  label="🛒 社群商店"
  active={tab==='store'}
  onClick={()=>{ setTab('store'); setMenuOpen(false); }}
  />  

  <NavItem
    label="🛍️ 點數商城"
    active={tab==='shop'}
    onClick={()=>{ setTab('shop'); setMenuOpen(false); }}
  />
  
<NavItem
    label="⏳ 等待開獎"
    active={tab==='pending'}
    onClick={()=>{ setTab('pending'); setMenuOpen(false); }}
  />

<NavItem
    label="📚 歷史紀錄"
    active={tab==='history'}
    onClick={()=>{ setTab('history'); setMenuOpen(false); }}
  />
  
<NavItem
    label="🔄 進行中活動"
    active={tab==='ongoing'}
    onClick={()=>{ setTab('ongoing'); setMenuOpen(false); }}
  />
  <NavItem
    label="📌 其他資料"
    active={tab==='others'}
    onClick={()=>{ setTab('others'); setMenuOpen(false); }}
  />

  {/* 分隔線 */}
  <div className="my-2 h-px bg-slate-200 dark:bg-slate-700" />

  {/* —— 管理區（依狀態切換） —— */}
  {!adminMode ? (
    <button
      className="w-full text-left px-3 py-2 rounded-xl tap-target hover:bg-slate-100 dark:hover:bg-slate-800"
      onClick={()=>{ enterAdmin(); /* 成功進入後保留抽屜開啟，或你也可關閉 */ }}
      title="進入管理模式"
    >
      🔐 進入管理模式
    </button>
  ) : (
    <>
      {/* 系統設置分頁（你之前要求集中設定在此） */}
      <NavItem
        label="🛠️ 系統設置"
        active={tab==='system'}
        onClick={()=>{ setTab('system'); setMenuOpen(false); }}
      />

      {/* 管理常用工具 */}
      <div className="grid grid-cols-2 gap-2 p-2">
  <button
    onClick={exportJSON}
    className="rounded-lg border px-3 py-2 text-sm"
    title="匯出整站資料（JSON）"
  >
    匯出
  </button>

  <label
    className="rounded-lg border px-3 py-2 text-sm cursor-pointer text-center"
    title="匯入整站資料（JSON）"
  >
    純匯入
    <input
      type="file"
      accept="application/json"
      className="hidden"
      onChange={e=>e.target.files && importJSON(e.target.files[0])}
    />
  </label>

  {/* 導向系統設置 > 管理者清單（取代舊的 resetAdmin） */}
  <button
    onClick={()=>{ setTab('system'); setMenuOpen(false); const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="前往系統設置（管理者清單）"
  >
    管理員設定
  </button>

  <button
    onClick={()=>{ exitAdmin(); setMenuOpen(false); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="退出管理模式"
  >
    退出管理
  </button>
</div>

    </>
  )}
</nav>

      <div className="p-4 text-xs text-slate-500 border-t border-slate-200/60 dark:border-slate-800">
        <div>提示：</div>
        <ul className="list-disc pl-5 mt-1 space-y-1">
          <li>按 <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">/</kbd> 聚焦搜尋</li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> → <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">h</kbd>：回首頁</li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> → <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">m</kbd>：開選單</li>
        </ul>
      </div>
    </aside>
  </div>
)}

        </div>
      );
    }

    // —— 基礎 UI 元件 ——
    function NavItem({ label, active, onClick }){
  return (
    <button
      onClick={onClick}
      className={cx(
        'w-full text-left px-3 py-2 rounded-xl tap-target transition',
        active
          ? 'bg-brand/10 text-brand-fg border border-brand/30'
          : 'hover:bg-slate-100 dark:hover:bg-slate-800',
        // 手機/鍵盤的觸覺回饋（沒有 hover 也有清楚的 pressed/focus 狀態）
        'active:bg-slate-100 dark:active:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50'
      )}
      // 輔助技術可讀性（高亮當前頁）
      aria-current={active ? 'page' : undefined}
    >
      {label}
    </button>
  );
}


function StickyBulkToggles({ onOpenAll, onCloseAll, className="" }) {
  return (
    <div className={cx(
      "sticky top-[60px] z-20 flex items-center gap-2 justify-end",
      className
    )}>
      <button
        type="button"
        onClick={onOpenAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="全部展開"
        aria-label="全部展開"
      >
        {/* 展開 icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="6 15 12 9 18 15"></polyline>
        </svg>
      </button>
      <button
        type="button"
        onClick={onCloseAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="全部收合"
        aria-label="全部收合"
      >
        {/* 收合 icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="18 9 12 15 6 9"></polyline>
        </svg>
      </button>
    </div>
  );
}

   function Section({ title, subtitle, children }){
  return (
    <section className="animate-fadeIn">
      <div className="mb-3">
        <h2 className="text-[1.25rem] font-semibold tracking-tight">{title}</h2>
        {subtitle && <p className="text-[13px] text-slate-500 mt-1">{subtitle}</p>}
      </div>

      {/* 原本的 .section-card 改為直接套工具類 */}
      <div className="
        bg-white/80 dark:bg-slate-800/70 backdrop-blur
        border border-slate-200/70 dark:border-slate-700/60
        rounded-2xl
        shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
        hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
        transition-shadow
        p-4 sm:p-5
      ">
        {children}
      </div>
    </section>
  );
}



    function EmptyCard({ text, admin }){
      return (
        <div className="border border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 text-center text-slate-500">
          {text}
          {admin && <div className="mt-3 text-xs">（進入管理後可新增資料）</div>}
        </div>
      );
    }

    // === Home（主頁）：關於＋社群連結＋快捷入口 ===
function Home({ setTab, data, setData, admin }) {
  const { useState, useMemo, useEffect } = React;

  // === 來源資料 ===
  const about = data.homepage?.about ?? "這裡是「開獎所」，提供歷史抽獎紀錄、等待開獎、進行中活動與點數商城等資訊。";
  const links = data.homepage?.links ?? []; // [{id, name, url}]

  // === 快捷入口（六格，固定排序） ===
const entries = React.useMemo(() => {
  const storeCount   = Array.isArray(data.store?.items) ? data.store.items.length : 0;
  const linkCount    = Array.isArray(links) ? links.length : 0;
  const shopCount    = Array.isArray(data.shop?.items) ? data.shop.items.length : 0;
  const pendingCount = Array.isArray(data.pending) ? data.pending.length : 0;
  const ongoingCount = Array.isArray(data.ongoing) ? data.ongoing.length : 0;
  const historyCount = Array.isArray(data.history) ? data.history.length : 0;

  return [
    { key:'store',   icon:'🛒', label:'社群商店',       value:storeCount,   onClick:()=>setTab('store') },
    { key:'links',   icon:'🔗', label:'社群與官方連結', value:linkCount,    onClick:()=>setTab('links') }, // 留在首頁，下方區塊
    { key:'shop',    icon:'🛍️', label:'點數商店',       value:shopCount,    onClick:()=>setTab('shop') },
    { key:'pending', icon:'⏳', label:'等待開獎',       value:pendingCount, onClick:()=>setTab('pending') },
    { key:'ongoing', icon:'🔄', label:'進行中活動',     value:ongoingCount, onClick:()=>setTab('ongoing') },
    { key:'history', icon:'📚', label:'歷史紀錄',       value:historyCount, onClick:()=>setTab('history') },
  ];
}, [data, links, setTab]);


  // === 置頂公告 → 改為進站彈窗（僅當次開啟顯示一次） ===
  const pinnedCards = useMemo(() => {
    const list = data.others?.cards || [];
    return list.filter(x => x.pin === true);
  }, [data.others]);

  const [showPinModal, setShowPinModal] = useState(false);

  useEffect(() => {
    // 使用 sessionStorage，確保同一次開啟期間只顯示一次
    const SEEN_KEY = 'kjs_pin_modal_seen_v1';
    const seen = sessionStorage.getItem(SEEN_KEY);
    if (!seen && pinnedCards.length > 0) {
      setShowPinModal(true);
      sessionStorage.setItem(SEEN_KEY, '1');
    }
  }, [pinnedCards]);

  const closePinModal = () => setShowPinModal(false);

  // === 主頁「關於」與「連結」草稿 ===
  const [draft, setDraft] = useState({ about, linkName: "", linkUrl: "" });

  const saveAbout = () => {
    if (!admin) return;
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links } });
    alert("已更新主頁介紹");
  };

  const addLink = () => {
    if (!admin) return alert("請進入管理模式");
    const name = (draft.linkName || "").trim();
    const url  = (draft.linkUrl  || "").trim();
    if (!name || !url) return alert("請輸入連結名稱與網址");
    if (!/^https?:\/\//i.test(url)) return alert("網址需以 http:// 或 https:// 開頭");
    const next = [...links, { id: Math.random().toString(36).slice(2, 10), name, url }];
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
    setDraft(d => ({ ...d, linkName: "", linkUrl: "" }));
  };

  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm("刪除此連結？")) return;
    const next = links.filter(x => x.id !== id);
    setData({ ...data, homepage: { ...(data.homepage || {}), about: draft.about, links: next } });
  };

  // === 其他資料（在首頁中以簡化列表示意，提供前往按鈕） ===
  const otherCards = useMemo(() => {
    const all = data.others?.cards || [];
    // 不顯示置頂的（置頂改由彈窗顯示），僅列非置頂卡片的前 5 筆作為預覽
    return all.filter(c => !c.pin).slice(0, 5);
  }, [data.others]);

  return (
    <Section title="主頁：開獎所" subtitle="首頁資訊濃縮版">
      {/* 1) 關於這個網頁（第一區） */}
      <Collapse header="🧾 關於這個網頁（點我展開）" defaultOpen={false}>
        {!admin && <p className="text-sm whitespace-pre-wrap">{about}</p>}
        {admin && (
          <div className="grid gap-3">
            <textarea
              className="rounded-lg border px-3 py-2 min-h-[100px]"
              value={draft.about}
              onChange={e => setDraft(d => ({ ...d, about: e.target.value }))}
              placeholder="簡短介紹此網頁、用途與規則重點"
            />
            <div className="flex justify-end">
              <button onClick={saveAbout} className="rounded-lg bg-brand text-white px-4 py-2">
                儲存介紹
              </button>
            </div>
          </div>
        )}
      </Collapse>

     {/* 2) 六格快捷入口（第二區） */}
<div
  className="
    my-4 grid gap-2
    grid-cols-2 sm:grid-cols-3
  "
  aria-label="首頁六格快捷入口"
>
  {entries.map(s => (
    <button
      key={s.key}
      onClick={s.onClick}
      className="
        group rounded-2xl border border-slate-200 dark:border-slate-700
        bg-white/80 dark:bg-slate-800/70 backdrop-blur
        px-3 py-3 text-left shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
        hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
        transition
        focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50
        active:scale-[0.99]
      "
      title={s.label}
      aria-label={s.label}
    >
      <div className="flex items-center justify-between">
        <div className="text-xl leading-none">{s.icon}</div>
        <div className="text-[11px] text-slate-500 opacity-80 group-hover:opacity-100">
          點擊前往
        </div>
      </div>
      <div className="mt-1 text-[13px] text-slate-500">{s.label}</div>
      <div className="mt-0.5 text-2xl font-semibold tabular-nums">{s.value}</div>
    </button>
  ))}
</div>


      

      {/* 4) 其他資料（第四區） */}
      <Collapse header="📌 其他資料" defaultOpen={false}>
        {otherCards.length === 0 ? (
          <div className="text-sm text-slate-500">目前沒有其他資料</div>
        ) : (
          <div className="grid gap-2">
            {otherCards.map(c => (
              <div key={c.id} className="rounded-lg border px-3 py-2">
                <div className="text-sm font-medium mb-1">{c.title || "未命名"}</div>
                <div className="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">
                  {(c.content || "").split("\n").join(" / ")}
                </div>
              </div>
            ))}
          </div>
        )}
        <div className="mt-3 flex justify-end">
          <button onClick={() => setTab('others')} className="rounded-lg border px-3 py-1.5 text-sm">
            前往「其他資料」
          </button>
        </div>
      </Collapse>

      {/* === 置頂公告彈窗（僅當次開啟顯示一次） === */}
      {showPinModal && (
        <div className="fixed inset-0 z-50">
          {/* 背景遮罩：點擊關閉 */}
          <div className="absolute inset-0 bg-black/40" onClick={closePinModal} />
          {/* 視窗本體 */}
          <div className="absolute inset-0 flex items-center justify-center p-4">
            <div
              className="
                relative w-full max-w-md rounded-2xl
                bg-white dark:bg-slate-900
                border border-slate-200 dark:border-slate-700
                shadow-xl p-4
              "
              onClick={(e) => e.stopPropagation()}
              role="dialog"
              aria-modal="true"
              aria-label="置頂公告"
            >
              <div className="flex items-center justify-between mb-2">
                <div className="text-base font-semibold">📣 最新公告</div>
                <button
                  className="tap-target rounded-lg border px-2 py-1 text-sm"
                  onClick={closePinModal}
                  aria-label="關閉公告"
                  title="關閉"
                >
                  ✕
                </button>
              </div>

              <div className="grid gap-3 max-h-[60vh] overflow-auto pr-1">
                {pinnedCards.map((c) => (
                  <div key={c.id} className="rounded-lg border px-3 py-2">
                    <div className="text-sm font-medium mb-1">{c.title || "未命名"}</div>
                    <div className="text-sm whitespace-pre-wrap">{c.content || "（無內容）"}</div>
                  </div>
                ))}
              </div>

              <div className="mt-3 text-right">
                <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={closePinModal}>
                  我知道了
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </Section>
  );
}

    function HomeShortcut({ label, onClick }) {
  return (
    <button
      onClick={onClick}
      className="rounded-xl2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-5 text-left shadow-soft hover:shadow-elevate transition-shadow"
    >
      <div className="text-base font-medium">{label}</div>
      <div className="text-xs text-slate-500 mt-1">點擊進入</div>
    </button>
  );
}



// === History（歷史抽獎紀錄）— 可新增/編輯/刪除/複製名單（含分頁與彈層月曆） ===
function History({ data, admin, setData, query="", queryMode="all" }) {
  const [bulk, setBulk] = useState(null); // 'open' | 'close' | null
  const [draft, setDraft] = useState({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  const [editingId, setEditingId] = useState(null);
  const [showCal, setShowCal] = useState(false);

  // 📅 月曆：目前檢視的年月（UTC）與被篩選日期
  const [cal, setCal] = useState(()=>{
    const now = new Date();
    return { y: now.getUTCFullYear(), m: now.getUTCMonth() }; // 使用 UTC
  });
  const [filterDate, setFilterDate] = useState(""); // YYYY-MM-DD（空字串＝不過濾）

  // 當月日曆與每日紀錄數
  const dayList = React.useMemo(()=> buildMonthDaysUTC(cal.y, cal.m), [cal]);
  const dateCounts = React.useMemo(()=>{
    const map = Object.create(null);
    for (const r of (data.history || [])) {
      const d = r?.date || "";
      if (!d) continue;
      map[d] = (map[d] || 0) + 1;
    }
    return map;
  }, [data.history]);

 // 篩選＋搜尋後的清單（先依日期篩選、再依搜尋模式）
const items = React.useMemo(()=>{
  let list = data.history || [];

  // 1) 日期篩選
  if (filterDate) {
    list = list.filter(x => (x.date || "") === filterDate);
  }

  // 2) 搜尋模式
  const q = String(query || "").trim();
  if (!q) return list;

  return list.filter(rec => historyMatchByMode(rec, q, queryMode));
}, [data.history, filterDate, query, queryMode]);


  // === 分頁（固定每頁 20 筆；History 無 list/grid 模式） ===
  const [historyPage, setHistoryPage] = useLocalState('kjs_history_page', 1);
  const historyPageSize = 20;
  const historyTotal = items.length;
  const historyMaxPage = Math.max(1, Math.ceil(historyTotal / historyPageSize));

  React.useEffect(() => {
    if (historyPage > historyMaxPage) setHistoryPage(historyMaxPage);
  }, [historyPage, historyMaxPage, setHistoryPage]);

// 統一日期顯示為 YYYY-MM-DD（也容忍 2025/9/2 這種）
const fmtDate = React.useCallback((d) => {
  if (!d) return "未填日期";
  const m = String(d).trim().match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  // m 可能有兩種群組，整理成 y, mo, da
  let y, mo, da;
  if (m) {
    y  = m[1]  || m[4];
    mo = m[2]  || m[5];
    da = m[3]  || m[6];
    return `${y}-${String(+mo).padStart(2, '0')}-${String(+da).padStart(2, '0')}`;
  }
  // 非以上格式就不勉強，顯示「未填日期」
  return "未填日期";
}, []);
 
 // 篩選或搜尋變化時回到第 1 頁
  React.useEffect(() => {
    setHistoryPage(1);
  }, [filterDate, query, setHistoryPage]);

  const historyStart = (historyPage - 1) * historyPageSize;
  const historyEnd = Math.min(historyStart + historyPageSize, historyTotal);
  const historyPageItems = items.slice(historyStart, historyEnd);

  // 頁碼視窗（最多 5 格）
  const historyWindowSize = 5;
  const historyStartPage = Math.max(
    1,
    Math.min(historyPage - Math.floor(historyWindowSize / 2), historyMaxPage - historyWindowSize + 1)
  );
  const historyEndPage = Math.min(historyMaxPage, historyStartPage + historyWindowSize - 1);

  // —— 動作：存檔 / 編輯 / 取消 / 刪除 / 複製 —— //
  const saveRecord = () => {
    if (!admin) return alert('請進入管理模式');
    if (!draft.title) return alert('請填寫【獎項名稱】');

    const dateText = draft.date || "";
    const ts = parseISODate(dateText);
    if (dateText && Number.isNaN(ts)) return alert("日期格式需為 YYYY-MM-DD（例如 2025-08-30）");

    const rawLines = String(draft.winnersText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const winners = parseLinesClean(draft.winnersText);
    const removedDup = Math.max(0, rawLines.length - winners.length);

    const winnerCount = Number(draft.winnerCount || winners.length || 0);
    const totalParticipants = Number(draft.totalParticipants || 0);
    if (winnerCount < 0 || totalParticipants < 0) return alert("名額與總參與人數需為 0 或正整數");

    const summary = [
      `確認要${editingId ? "儲存修改" : "新增紀錄"}嗎？`,
      `獎項名稱：${draft.title}`,
      `日期：${dateText || "（未填）"}`,
      `得獎者人數：${winners.length}${removedDup ? `（已自動去重 ${removedDup} 筆）` : ""}`,
      `抽出名額：${winnerCount}`,
      `總參與人數：${totalParticipants || "（未填）"}`
    ].join("\n");
    if (!confirm(summary)) return;

    const rec = {
      id: editingId || Math.random().toString(36).slice(2,10),
      title: draft.title,
      date: dateText,
      winners,
      winnerCount,
      totalParticipants,
      youtube: draft.youtube || "",
      status: draft.status || "",
      note: draft.note || ""
    };

    const base = data.history || [];
    const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];
    const sorted = sortHistoryDesc(next); // 存檔即排序（最新在上）
    setData({ ...data, history: sorted });

    setEditingId(null);
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  };

  const editRecord = (x) => {
    if (!admin) return;
    setEditingId(x.id);
    setDraft({
      date: x.date||'',
      title: x.title||'',
      winnersText: (x.winners||[]).join('\n'),
      winnerCount: String(x.winnerCount??''),
      totalParticipants: String(x.totalParticipants??''),
      youtube: x.youtube||'',
      status: x.status||'',
      note: x.note||''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
    setEditingId(null);
  };

  const removeRecord = (id) => {
    if (!admin) return;
    if (!confirm('刪除此筆歷史紀錄？')) return;
    setData({ ...data, history: (data.history || []).filter(x => x.id !== id) });
  };

  const copyWinners = (arr=[]) => navigator.clipboard.writeText((arr||[]).join('\n')).then(()=>alert('已複製得獎者名單'));

  // —— 畫面 —— //
  return (
    <Section title="📚 歷史抽獎紀錄" subtitle="完整歷屆活動紀錄。">
      {/* 📅 月曆快篩（頂部）— 小按鈕 + 彈層 */}
      <div className="flex items-center justify-between mb-3">
  <div className="text-sm text-slate-500">依日期快速篩選</div>
  <div className="flex items-center gap-2">
    {filterDate && (
      <button
        type="button"
        className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
        title="清除日期篩選，恢復全部瀏覽"
        onClick={() => { setFilterDate(""); setHistoryPage(1); }}
      >
        清除篩選
      </button>
    )}
    <button
      onClick={()=>setShowCal(true)}
      className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
      title="開啟月曆"
    >
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      月曆
    </button>
  </div>
</div>


      {/* 當前篩選提示 */}
      <div className="text-xs text-slate-500 mb-3">
        {filterDate
          ? <>已套用日期篩選：<b>{filterDate}</b>（點月曆清除）</>
          : <>可依日期快速篩選紀錄</>}
      </div>

      {/* 彈層月曆（遮罩 + 置中卡片） */}
      {showCal && (
  <div className="fixed inset-0 z-50" onClick={()=>setShowCal(false)}>
    {/* 黑色遮罩（此層不再需要 onClick，維持視覺） */}
    <div className="absolute inset-0 bg-black/40" />
    <div className="absolute inset-0 flex items-start justify-center p-4 overflow-auto sm:items-center">

      {/* 卡片主體：阻止冒泡，避免點擊卡片內部也被當成關閉 */}
      <div
        className="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4"
        onClick={(e)=>e.stopPropagation()}
      >
        <div className="flex items-center justify-between">
          <div className="text-sm font-medium">{cal.y} 年 {cal.m + 1} 月</div>
          <div className="flex items-center gap-1">
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m-1<0?{y:y-1,m:11}:{y,m:m-1})); }}
              title="前一個月"
            >‹</button>
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m+1>11?{y:y+1,m:0}:{y,m:m+1})); }}
              title="下一個月"
            >›</button>
            {/* 直接在彈層內提供「清除」：一鍵恢復全部瀏覽 */}
            {filterDate && (
              <button
                className="rounded-lg border px-2 py-1.5 text-sm"
                onClick={()=>{ setFilterDate(""); setHistoryPage(1); }}
                title="清除日期篩選"
              >
                清除
              </button>
            )}
            {/* 額外的關閉按鈕（可選） */}
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>setShowCal(false)}
              title="關閉"
            >✕</button>
          </div>
        </div>

        {/* 星期列 */}
        <div className="grid grid-cols-7 text-xs text-slate-500 mt-3">
          {['日','一','二','三','四','五','六'].map((w,i)=>(<div key={i} className="px-1 py-1 text-center">{w}</div>))}
        </div>

        {/* 日曆格 */}
        <div className="grid grid-cols-7 gap-1 mt-1">
          {dayList.map((d, i)=>{
            if (!d) return <div key={i} className="h-9 rounded-lg" />;
            const count = dateCounts[d] || 0;
            const active = !!count;
            const selected = filterDate === d;
            return (
              <button
                key={i}
                onClick={()=>{
                  setFilterDate(prev => prev === d ? "" : d);
                  setHistoryPage(1);
                  setShowCal(false);
                }}
                className={[
                  "h-9 rounded-lg border text-sm flex flex-col items-center justify-center",
                  selected ? "border-brand bg-brand/10" : "border-slate-200 dark:border-slate-700",
                  active ? "hover:bg-slate-50 dark:hover:bg-slate-800" : "opacity-60"
                ].join(" ")}
                title={active ? `此日共有 ${count} 筆紀錄` : "此日沒有紀錄"}
              >
                <div className="leading-none">{parseInt(d.slice(-2),10)}</div>
                {active && (
                  <div className="text-[10px] leading-none mt-0.5 inline-flex items-center px-1 rounded border bg-white/70 dark:bg-slate-800/70">
                    {count}
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  </div>
)}


      {/* 管理表單 */}
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d,date:e.target.value}))} placeholder="截止/開獎日期"/>
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="獎項名稱"/>
            <input className="rounded-lg border px-3 py-2" value={draft.winnerCount} onChange={e=>setDraft(d=>({...d,winnerCount:e.target.value}))} placeholder="抽出名額（留空＝以名單數量）"/>
            <input className="rounded-lg border px-3 py-2" value={draft.totalParticipants} onChange={e=>setDraft(d=>({...d,totalParticipants:e.target.value}))} placeholder="總參與人數"/>
            <input className="rounded-lg border px-3 py-2 sm:col-span-2" value={draft.youtube} onChange={e=>setDraft(d=>({...d,youtube:e.target.value}))} placeholder="抽獎影片（YouTube 連結，可空白）"/>
            <select
              className="rounded-lg border px-3 py-2"
              value={draft.status}
              onChange={e=>setDraft(d=>({...d,status:e.target.value}))}
            >
              <option value="">（不填）</option>
              {HISTORY_STATUS_OPTIONS.map(opt=>(
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
            </select>
            <input className="rounded-lg border px-3 py-2" value={draft.note} onChange={e=>setDraft(d=>({...d,note:e.target.value}))} placeholder="備註（可空白）"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">得獎者名單（每行一位）</label>
            <textarea className="mt-1 w-full rounded-lg border px-3 py-2 min-h-[120px]" value={draft.winnersText} onChange={e=>setDraft(d=>({...d,winnersText:e.target.value}))} placeholder="一行一個 LINE 暱稱"></textarea>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">取消</button>}
            <button onClick={saveRecord} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "儲存修改" : "新增紀錄"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="目前沒有資料" admin={admin} />}

      {/* 全展/全收（僅對當頁有效） */}
      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // 重置，恢復單項可點擊
  }}
>
  全部展開
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // 重置
  }}
>
  全部收合
</button>

      </div>

      {/* 清單（當頁資料） */}
      <div className="grid gap-4 mt-4">
        {historyPageItems.map(x => (
          <Collapse
  key={x.id}
  group="history"
  uid={x.id}
  force={bulk}  // 保留
  header={(open) => <HistoryHeaderRow rec={x} />}
>
  {/* 手機：展開後顯示完整獎品名稱 */}
  <div className="sm:hidden mb-2">
    <div className="text-[15px] font-medium whitespace-normal break-words">
      <span className="mr-1" aria-hidden="true">🎁</span>
      {x.title || "（未命名）"}
    </div>
  </div>

  <div className="text-sm grid sm:grid-cols-2 gap-x-6 gap-y-1">
    <div>抽出名額：{x.winnerCount ?? (x.winners?.length||0)}</div>
    <div>總參與人數：{x.totalParticipants ?? '-'}</div>

    {x.youtube && (
      <div className="sm:col-span-2 truncate">
        影片：
        <a className="text-brand underline" href={x.youtube} target="_blank" rel="noreferrer">
          {x.youtube}
        </a>
      </div>
    )}

    {x.status && (
      <div className="sm:col-span-2">
        <StatusTag value={x.status} />
      </div>
    )}

    {x.note && <div className="sm:col-span-2">備註：{x.note}</div>}
  </div>

  <div className="mt-3">
    <div className="text-sm text-slate-500 mb-1">得獎者：</div>
    <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
      {(x.winners||[]).join('\n')}
    </pre>
  </div>

  <div className="mt-3 flex gap-2 justify-end">
    <button onClick={()=>copyWinners(x.winners)} className="rounded-lg border px-3 py-1.5">複製名單</button>
    {admin && (
      <>
        <button onClick={()=>editRecord(x)} className="rounded-lg border px-3 py-1.5">編輯</button>
        <button onClick={()=>removeRecord(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">刪除</button>
      </>
    )}
  </div>
</Collapse>

        ))}
      </div>

      {/* 分頁控制（History） */}
      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage <= 1}
          onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
        >
          上一頁
        </button>

        {Array.from({ length: (historyEndPage - historyStartPage + 1) }, (_, i) => historyStartPage + i).map(p => (
          <button
            key={p}
            type="button"
            className={`rounded-lg border px-3 py-1.5 text-sm ${p === historyPage ? 'bg-brand text-white border-brand' : ''}`}
            onClick={() => setHistoryPage(p)}
          >
            {p}
          </button>
        ))}

        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage >= historyMaxPage}
          onClick={() => setHistoryPage(p => Math.min(historyMaxPage, p + 1))}
        >
          下一頁
        </button>
      </div>
    </Section>
  );
}

function LinksPage({ data, setData, admin }) {
  const links = Array.isArray(data?.homepage?.links) ? data.homepage.links : [];
  const [page, setPage] = useLocalState('kjs_links_page', 1);
  const pageSize = 20;
  const total = links.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);

  const [draft, setDraft] = React.useState({ name: '', url: '' });

  const addLink = () => {
    if (!admin) return;
    if (!draft.name.trim() || !draft.url.trim()) return alert('請填名稱與網址');
    const next = [{ id: nid(), name: draft.name.trim(), url: draft.url.trim() }, ...links];
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: next } }));
    setDraft({ name:'', url:'' });
  };
  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm('刪除此連結？')) return;
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: (s.homepage?.links||[]).filter(x=>x.id!==id) } }));
  };

  return (
    <Section title="🔗 社群與官方連結" subtitle="可自訂多個連結，支援分頁。">
      {admin && (
        <div className="mb-3 grid sm:grid-cols-[1fr_2fr_auto] gap-2">
          <input className="rounded-lg border px-3 py-2" placeholder="名稱"
                 value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))}/>
          <input className="rounded-lg border px-3 py-2" placeholder="https://..."
                 value={draft.url} onChange={e=>setDraft(d=>({...d,url:e.target.value}))}/>
          <button className="rounded-lg bg-brand text-white px-3 py-2" onClick={addLink}>新增</button>
        </div>
      )}

      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
        {links.slice(start, end).map(x => (
          <a key={x.id} href={x.url} target="_blank" rel="noreferrer"
             className="rounded-xl border p-3 hover:border-brand">
            <div className="font-medium truncate">{x.name || x.url}</div>
            <div className="text-xs text-slate-500 truncate">{x.url}</div>
            {admin && (
              <div className="mt-2 text-right">
                <button className="rounded-lg border px-2 py-1 text-xs"
                        onClick={(e)=>{e.preventDefault(); removeLink(x.id);}}>刪除</button>
              </div>
            )}
          </a>
        ))}
      </div>

      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>上一頁</button>
        {Array.from({length:(endPage - startPage + 1)}, (_,i)=>startPage+i).map(p=>(
          <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page?'bg-brand text-white border-brand':''}`}
                  onClick={()=>setPage(p)}>{p}</button>
        ))}
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>下一頁</button>
      </div>
    </Section>
  );
}




// === Ongoing（進行中活動）— 可新增/編輯/刪除/上下移動/啟用停用 ===
function Ongoing({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  const [editingId, setEditingId] = useState(null);

  const items = React.useMemo(()=>{
  let list = data.ongoing || [];
  if(!admin) list = list.filter(x => x.enabled !== false);
  const q = String(query).trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>{
    const hay = [
      x.title, x.desc, x.rules, x.link
    ].map(s => String(s||"").toLowerCase()).join(" ");
    return hay.includes(q);
  });
},[data.ongoing, admin, query]);

  const HasImageInput = typeof ImageInput === "function";

  const saveOngoing = () => {
    if (!admin) return alert("請進入管理模式");
    if (!draft.title) return alert("請填寫標題");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, desc: draft.desc||"", rules: draft.rules||"", link: draft.link||"", image: draft.image||"", enabled: !!draft.enabled };
    const base = data.ongoing || [];
const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];

    setData({ ...data, ongoing: next });
    setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  };

  const editOngoing = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", desc:x.desc||"", rules:x.rules||"", link:x.link||"", image:x.image||"", enabled: !!x.enabled }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true }); };

  const removeOngoing = (id) => { if(!admin) return; if(!confirm("刪除此卡片？")) return; setData({ ...data, ongoing: (data.ongoing || []).filter(x => x.id !== id) }); };

  const toggleEnabled = (id) => { if(!admin) return; setData({ ...data, ongoing: (data.ongoing || []).map(x => x.id===id ? { ...x, enabled: !x.enabled } : x) });
 };

  const move = (id, dir) => {
  if (!admin) return;
  const arr = [...(data.ongoing || [])];
  const i = arr.findIndex(x => x.id === id);
  const j = dir === "up" ? i - 1 : i + 1;
  if (i < 0 || j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  setData({ ...data, ongoing: arr });
};

  const moveUp = (id) => move(id, 'up');
  const moveDown = (id) => move(id, 'down');

  return (
    <Section title="🔄 進行中活動" subtitle="卡片式展示（可上下移動、啟用/停用、編輯）。">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="標題"/>
            <input className="rounded-lg border px-3 py-2" value={draft.link} onChange={e=>setDraft(d=>({...d,link:e.target.value}))} placeholder="連結（可空白）"/>
            <div className="sm:col-span-2">
              {HasImageInput
                ? <ImageInput label="展示圖片" value={draft.image} onChange={(v)=>setDraft(d=>({...d,image:v}))}/>
                : <input className="rounded-lg border px-3 py-2 w-full" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="展示圖片（網址或 base64）"/>}
            </div>
          </div>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))} placeholder="介紹（可空白）"></textarea>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.rules} onChange={e=>setDraft(d=>({...d,rules:e.target.value}))} placeholder="規則（可空白）"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.enabled} onChange={e=>setDraft(d=>({...d,enabled:e.target.checked}))}/>啟用（勾選＝對外顯示）</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">取消</button>}
            <button onClick={saveOngoing} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "儲存修改" : "新增卡片"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="目前沒有資料" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // 重置，恢復單項可點擊
  }}
>
  全部展開
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // 重置
  }}
>
  全部收合
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {items.map((x)=> (
          <Collapse key={x.id} 
 group="ongoing"        // ★ 新增
  uid={x.id}             // ★ 新增
  force={bulk}           // 你原本就有，留著
header={`${x.title || "未命名活動"}`} force={bulk}>
            {x.image && <img src={x.image} alt="活動圖片" className="rounded-lg max-h-56 object-contain w-full bg-slate-50 dark:bg-slate-800 mb-2"/>}
            {x.link && <div className="text-sm mb-2">連結：<a className="underline text-brand" href={x.link} target="_blank" rel="noreferrer">{x.link}</a></div>}
            {x.desc && <div className="text-sm whitespace-pre-wrap mb-2">{x.desc}</div>}
            {x.rules && <div className="text-sm whitespace-pre-wrap mb-2"><span className="text-slate-500">規則：</span>{x.rules}</div>}
            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>moveUp(x.id)} className="rounded-lg border px-3 py-1.5">上移</button>
                <button onClick={()=>moveDown(x.id)} className="rounded-lg border px-3 py-1.5">下移</button>
                <button onClick={()=>toggleEnabled(x.id)} className="rounded-lg border px-3 py-1.5">
                  {x.enabled ? "停用" : "啟用"}
                </button>
                <button onClick={()=>removeOngoing(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">刪除</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

// 點數商城（點數兌換）— 「搜尋改標籤」＋「一鍵購物清單(點數)」，九/十六宮格保留
function Shop({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  // 偏好（九/十六宮格、每頁）
  const prefKey = "pointshop_prefs_v5";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9");
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // 我的點數（相容多欄位）
  const initialMyPts =
    (Number.isFinite(+data?.points?.myPoints) ? +data.points.myPoints : null) ??
    (Number.isFinite(+data?.myPoints) ? +data.myPoints : 0);
  const [myPts, setMyPts] = React.useState(initialMyPts || 0);

  // 管理面板
  const [showEditor, setShowEditor] = React.useState(false);
  const HasShopEditor = typeof ShopEditor === "function";

  // 詳情
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // ★ 小卡式「篩選標籤」彈窗開關與群組資料
  const [tagSheetOpen, setTagSheetOpen] = React.useState(false);
  const tagGroups = Array.isArray(data?.shop?.tagGroups) ? data.shop.tagGroups : [];

  // 數值解析
  const safeNumber = (v) => (typeof v === "number" && Number.isFinite(v)) ? v : ((typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) ? +v : null);
  const getRemain = (x) => [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find(n=>n!=null);
  const getNeedPts = (x) => ['points','pts','need','needPoints','cost','costPts','pricePts'].map(k=>safeNumber(x?.[k])).find(n=>n!=null);

  // 原始資料
  const itemsRaw = Array.isArray(data?.shop?.items) ? data.shop.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    const tags   = Array.isArray(it?.tags) ? it.tags : (typeof it?.tags==='string'? it.tags.split(',').map(s=>s.trim()).filter(Boolean):[]);
    return { ...it, _images: images.filter(Boolean), _tags: tags, _needPts: getNeedPts(it) };
  };
  const allItems = React.useMemo(()=> itemsRaw.map(normalizeItem), [itemsRaw]);

  // 標籤（收集 → 依群組順序重排）
  const allTags = React.useMemo(()=> collectUniqueTags(allItems, '_tags'), [allItems]);

  // ★★★ 依群組順序重排（保留運算，不在 Toolbar 顯示 chips）
  const tagsOrdered = React.useMemo(() => {
    if (!Array.isArray(tagGroups) || tagGroups.length === 0) return allTags;
    const seen = new Set();
    const ordered = [];
    tagGroups.forEach(g => {
      (g?.tags || []).forEach(t => {
        if (allTags.includes(t) && !seen.has(t)) { seen.add(t); ordered.push(t); }
      });
    });
    allTags.forEach(t => { if (!seen.has(t)) ordered.push(t); });
    return ordered;
  }, [allTags, tagGroups]);

  const tag = useTagFilter(allTags);

  // 只看我可兌換
  const [onlyAffordable, setOnlyAffordable] = React.useState(false);

  // 篩選
  const filtered = React.useMemo(()=>{
    return allItems.filter(x=>{
      const okTag = !tag.picked.length || tag.picked.every(t => (x._tags||[]).includes(t));
      const need  = x._needPts ?? getNeedPts(x);
      const okPts = !onlyAffordable || (need!=null && myPts>=need);
      return (x?.enabled!==false) && okTag && okPts;
    });
  }, [allItems, tag.picked, onlyAffordable, myPts]);

  // 排序（以更新時間）
  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered]);

  // 分頁
  const total   = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [tag.picked, view, pageSize, onlyAffordable, myPts]);
  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage  = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage    = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems  = sorted.slice(start, end);

  // 9/16 宮格
  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  // 一鍵清單（點數）
  const pick = usePickList('kjs_pointshop_picklist');
  const [showConfirm, setShowConfirm] = React.useState(false);

  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        {/* ⛔ 移除整排 TagChips，只保留彈窗按鈕 */}
        {/* <TagChips tags={tagsOrdered} picked={tag.picked} onToggle={tag.toggle} onClear={tag.clear} /> */}

        {/* 小卡式「篩選標籤」— 顯示已選數量 */}
        <button className="rounded-lg border px-3 py-2" onClick={()=>setTagSheetOpen(true)}>
          {tag.picked.length > 0 ? `篩選標籤（${tag.picked.length}）` : '篩選標籤'}
        </button>

        <div className="flex items-center gap-2 ml-auto">
          <label className="flex items-center gap-1">
            我的點數
            <input
              type="number"
              inputMode="numeric"
              className="w-20 rounded border px-2 py-2 text-right"
              value={myPts}
              onChange={e=>setMyPts(Math.max(0, Number(e.target.value)||0))}
            />
          </label>
          <label className="flex items-center gap-1">
            <input type="checkbox" checked={onlyAffordable} onChange={e=>setOnlyAffordable(e.target.checked)} />
            只看「我可兌換」
          </label>
        </div>

        <label className="flex items-center gap-1">
          版面
          <select className="rounded border px-2 py-2" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 宮格</option>
            <option value="grid16">16 宮格</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          每頁
          <select className="rounded border px-2 py-2" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>

        <div className="grow basis-full sm:basis-auto" />
        {admin && HasShopEditor && (
          <button className="rounded-lg border px-3 py-2" onClick={()=>setShowEditor(true)}>管理</button>
        )}
      </div>
    </div>
  );

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>上一頁</button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>下一頁</button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      {/* 小卡：圖片 → 名稱(單行省略) → 點數（不疊在圖片上）→ 主按鈕；不顯示數量步進器 */}
      <div className={`grid ${gridCols} gap-3`} aria-label="點數商城清單">
        {pageItems.map((x, i) => {
          const id      = x.id || i;
          const name    = x?.name || x?.title || '（未命名）';
          const needPts = x._needPts ?? getNeedPts(x);
          const cover   = Array.isArray(x._images) && x._images.length>0 ? x._images[0] : '';
          const remain  = getRemain(x);
          const afford  = (needPts!=null && myPts>=needPts);

          return (
            <div key={id} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none flex flex-col">
              {/* 圖片（點開詳情） */}
              <button className="block w-full text-left p-3 pb-2" onClick={()=>setSheet({ open:true, item:x })}>
                <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                  {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">無圖片</div>}
                </div>
              </button>

              {/* 名稱（單行省略） */}
              <button className="px-3 text左" onClick={()=>setSheet({ open:true, item:x })} title={name}>
                <div className="text-[13px] font-medium truncate">{name}</div>
                {Array.isArray(x._tags)&&x._tags.length>0 && <div className="text-xs text-slate-500 truncate">{x._tags.join(' / ')}</div>}
              </button>

              {/* 點數（不放步進器） */}
              <div className="px-3 pt-2 pb-1">
                <div className="text-sm font-semibold tabular-nums">
                  {needPts!=null ? `${needPts} 點` : '　'}
                  {remain!=null && <span className="ml-2 text-xs font-normal text-slate-500">剩餘：{remain}</span>}
                  {needPts!=null && !afford && <span className="ml-2 text-xs text-rose-500">點數不足</span>}
                </div>
              </div>

              {/* 主按鈕：我要兌換（不足則灰階） */}
              <div className="px-3 pb-3 mt-1">
                <button
                  disabled={needPts==null || !afford}
                  className={`inline-flex items-center justify-center w-full rounded-lg px-4 py-2 text-sm shadow-soft
                    ${needPts!=null && afford ? 'bg-brand text-white' : 'border text-slate-400'}`}
                >
                  {needPts!=null && afford ? '我要兌換' : '無法兌換'}
                </button>
              </div>
            </div>
          );
        })}
      </div>

      <Paginator />

      {/* 管理面板（保留） */}
     {admin && HasShopEditor && showEditor && (
  <ShopEditor
    items={Array.isArray(data?.shop?.items) ? data.shop.items : []}
    groups={Array.isArray(data?.shop?.tagGroups) ? data.shop.tagGroups : []}
    onSave={(nextItems, nextGroups) => {
      // onSave 接 2 參數：商品、群組
      const safeNext   = Array.isArray(nextItems)  ? nextItems  : [];
      const safeGroups = Array.isArray(nextGroups) ? nextGroups : [];
      setData(s => ({ ...s, shop: { ...(s.shop || {}), items: safeNext, tagGroups: safeGroups } }));
      setShowEditor(false);
    }}
    onClose={() => setShowEditor(false)}
  />
)}



      {/* 詳情彈窗（保留） */}
      <ProductSheet open={sheet.open} item={sheet.item} context="shop" onClose={()=>setSheet({ open:false, item:null })} />

      {/* 一鍵清單（保留） */}
      <FloatingPickbar count={pick.totalQty} onOpen={()=>setShowConfirm(true)} />
      {/* ★ 修復重點：串上 onSetQty，讓清單可加減/刪除 */}
      <ConfirmListDialog open={showConfirm} onClose={()=>setShowConfirm(false)} map={pick.map} mode="pts" onSetQty={(k,p,n)=>pick.setQty(k,p,n)} />

      {/* ★ 標籤小卡：吃 data.shop.tagGroups */}
      <TagFilterSheet
        open={tagSheetOpen}
        onClose={()=>setTagSheetOpen(false)}
        groups={tagGroups}
        allTags={allTags}
        picked={tag.picked}
        onApply={(list)=>{ tag.setPicked(list); setTagSheetOpen(false); }}
      />

      {/* ★ 避免被底部挑選條遮住的空白區 */}
      {pick.totalQty > 0 && <div className="pickbar-spacer" />}
    </section>
  );
}


// ============================
// ShopEditor：專為點數商城的管理編輯器（不影響 StoreEditor）
// ============================
function ShopEditor({ items = [], groups = [], onSave, onClose }) {
  const React = window.React || globalThis.React;
  const [list, setList] = React.useState(()=> (Array.isArray(items) ? items.map(x=>({ ...x })) : []));
  const [editingIndex, setEditingIndex] = React.useState(-1);

  // ★ 新增：群組狀態（從 props.groups 初始化）
  const [groupsState, setGroupsState] = React.useState(()=> Array.isArray(groups) ? groups.map(g=>({ name: g?.name||'', tags: Array.isArray(g?.tags)? [...g.tags] : [] })) : []);
  // ★ 由當前清單動態收集所有標籤（提供給群組編輯器）
  const allTags = React.useMemo(()=> normalizeAllTagsFromItems(list), [list]);

  // 預設項目：新增就有 stock 欄位；不再使用 intro
  const blankItem = () => ({
    enabled: true,
    name: "",
    points: "",
    stock: "",         // 新增：剩餘數量
    desc: "",
    tags: "",
    image: "",
    images: []
  });

  const move = (i, dir) => {
    setList(arr=>{
      const a = [...arr];
      const j = i + dir;
      if (j<0 || j>=a.length) return a;
      const tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      return a;
    });
  };
  const remove = (i) => setList(arr => arr.filter((_,k)=>k!==i));
  const toggle = (i) => setList(arr => arr.map((x,k)=> k===i ? ({ ...x, enabled: !(x.enabled !== false) }) : x));
  const addNew = () => { setList(arr => [...arr, blankItem()]); setEditingIndex(list.length); };

  const parseImages = (text) => {
    const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    return Array.from(new Set(lines));
  };

  const ItemRow = ({x, i}) => {
    const need = x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? "";
    const cover = Array.isArray(x?.images) && x.images.length ? x.images[0] : (x?.image || "");
    const stock = x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "";
    return (
      <div className="grid grid-cols-[auto_1fr_auto] items-center gap-3 px-3 py-2 border-b">
        <div className="w-12 h-12 rounded bg-slate-100 overflow-hidden grid place-content-center">
          {cover ? <img src={cover} alt="" className="w-full h-full object-cover" /> : <span className="text-xs text-slate-400">無</span>}
        </div>
        <div className="min-w-0">
          <div className="font-medium truncate">{x?.name || "（未命名）"}</div>
          <div className="text-xs text-slate-500 truncate">
            需要點數：{need||"—"}　剩餘數量：{(stock===""||stock==null)?"—":stock}　標籤：{Array.isArray(x?.tags)? x.tags.join(",") : (x?.tags||"—")}
          </div>
        </div>
        <div className="flex items-center gap-1">
          <button className={`px-2 py-1 rounded text-xs border ${x?.enabled!==false ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : ''}`} onClick={()=>toggle(i)}>
            {x?.enabled!==false ? '上架中' : '已停用'}
          </button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>move(i,-1)}>上移</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>move(i, 1)}>下移</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={()=>setEditingIndex(i)}>編輯</button>
          <button className="px-2 py-1 rounded text-xs border text-rose-600" onClick={()=>remove(i)}>刪除</button>
        </div>
      </div>
    );
  };

  // 匯出 CSV：移除 intro 欄位，新增 stock 欄位
  const exportCSV = ()=>{
    const headers = ["enabled","name","points","stock","desc","tags","image","images"];
    const rows = list.map(x=>{
      const tags = Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags||"");
      const images = Array.isArray(x?.images) ? x.images.join("|") : (x?.image ? String(x.image) : "");
      const needPts = (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? "");
      const stock = (x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "");
      return [ (x?.enabled!==false), (x?.name||""), needPts, stock, (x?.desc||""), tags, (x?.image||""), images ];
    });
    const csv = [headers.join(","), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "shop_items.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  const EditorModal = ({x, i}) => {
    // 讀入時把任何舊欄位（qty/quantity/remaining）也帶成 stock 供編修
    const initialStock = (x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "");
    const [draft, setDraft] = React.useState(()=>({
      enabled: x?.enabled !== false,
      name: x?.name || "",
      points: (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? ""),
      stock: (initialStock === null || initialStock === undefined) ? "" : String(initialStock),
      desc: x?.desc || "",
      tags: Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags || ""),
      image: x?.image || "",
      imagesText: (Array.isArray(x?.images) ? x.images : (x?.image ? [x.image] : [])).join("\n"),
    }));

    const save = ()=>{
      const next = { ...x };
      next.enabled = !!draft.enabled;
      next.name    = String(draft.name||"").trim();
      const n = draft.points;
      if (n==="" || n==null) { delete next.points; } else { next.points = n; }

      // 新增：stock
      const s = String(draft.stock||"").trim();
      if (s==="") { delete next.stock; }
      else {
        const sn = +s;
        next.stock = Number.isFinite(sn) ? sn : s;
      }

      next.desc  = draft.desc;
      if ('intro' in next) delete next.intro;

      next.tags = draft.tags ? draft.tags.split(",").map(s=>s.trim()).filter(Boolean) : [];
      const imgs = parseImages(draft.imagesText);
      next.images = imgs;
      next.image  = imgs[0] || "";

      setList(arr => arr.map((it,k)=> k===i ? next : it));
      setEditingIndex(-1);
    };

    return (
      <div className="fixed inset-0 z-[1100] bg-black/60 grid place-content-center p-3" role="dialog" aria-modal="true">
        <div className="w-[min(720px,96vw)] max-h-[90vh] overflow-auto rounded-2xl bg-white dark:bg-slate-900 shadow-xl">
          <div className="flex items-center justify-between px-4 py-3 border-b">
            <div className="font-semibold">編輯項目</div>
            <div className="flex items-center gap-2">
              <button className="rounded border px-3 py-1.5 text-sm" onClick={()=>setEditingIndex(-1)}>關閉</button>
              <button className="rounded bg-brand text-white px-3 py-1.5 text-sm" onClick={save}>儲存</button>
            </div>
          </div>

          <div className="p-4 space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label className="text-sm">
                名稱
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))}/>
              </label>
              <label className="text-sm">
                需要點數（points）
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.points} onChange={e=>setDraft(d=>({...d,points:e.target.value}))}/>
              </label>
              <label className="text-sm">
                剩餘數量（stock）
                <input className="mt-1 w-full rounded-lg border px-3 py-2" inputMode="numeric" value={draft.stock} onChange={e=>setDraft(d=>({...d,stock:e.target.value}))} placeholder="例如：10"/>
              </label>
              <label className="text-sm">
                封面圖片（image）
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))}/>
              </label>
            </div>

            <label className="text-sm block">
              描述（desc）
              <textarea className="mt-1 w-full rounded-lg border px-3 py-2" rows={4} value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))}/>
            </label>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label className="text-sm block">
                多張圖片：每行一個 URL（images）
                <textarea className="mt-1 w-full rounded-lg border px-3 py-2" rows={5} value={draft.imagesText}
                  onChange={e=>{
                    const raw = e.target.value;
                    setDraft(d=>({...d, imagesText: raw}));
                  }}/>
              </label>
              <label className="text-sm block">
                標籤（逗號分隔）
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.tags} onChange={e=>setDraft(d=>({...d,tags:e.target.value}))}/>
              </label>
            </div>

            <div className="flex items-center justify-between">
              <label className="text-sm inline-flex items-center gap-2">
                <input type="checkbox" checked={!!draft.enabled} onChange={e=>setDraft(d=>({...d, enabled:e.target.checked}))}/>
                上架（enabled）
              </label>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 z-[1000] bg黑/60 flex items-center justify-center" role="dialog" aria-modal="true">
      <div className="w=[min(1024px,96vw)] max-h-[90vh] overflow-hidden rounded-2xl bg白 dark:bg-slate-900 shadow-xl flex flex-col">
        {/* header */}
        <div className="flex items-center justify-between px-4 py-3 border-b">
          <div className="font-semibold">點數商城管理</div>
          <div className="flex items-center gap-2">
            <button className="rounded border px-3 py-1.5 text-sm" onClick={exportCSV}>匯出 CSV</button>
            <button className="rounded border px-3 py-1.5 text-sm" onClick={onClose}>關閉</button>
            {/* ★ 儲存：多傳一個參數 groups（舊呼叫者會自動忽略第二參數） */}
            <button
              className="rounded bg-brand text-white px-3 py-1.5 text-sm"
              onClick={()=>{
                const cleaned = ensureUniqueTagsInGroups(groupsState, allTags);
                onSave?.(list, cleaned);
              }}
            >
              儲存
            </button>
          </div>
        </div>

        {/* body */}
        <div className="flex-1 overflow-auto">
          <div className="p-2 space-y-4">
            {/* ★★★ 標籤群組編輯器 */}
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                <div className="font-medium">標籤群組（排序／整合）</div>
                <div className="text-xs text-slate-500">未分組標籤會自動歸入「其他」</div>
              </div>
              <div className="p-3">
                <TagGroupsEditor
                  groups={groupsState}
                  allTags={allTags}
                  onChange={setGroupsState}
                />
              </div>
            </div>

            {/* 原有：商品清單 */}
            <div>
              <button className="mb-2 rounded bg-emerald-600 text-white px-3 py-1.5 text-sm" onClick={addNew}>新增項目</button>
              <div className="rounded border overflow-hidden">
                {list.length===0 && <div className="p-6 text-center text-slate-500 text-sm">目前沒有項目</div>}
                {list.map((x,i)=> <ItemRow key={i} x={x} i={i} />)}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* editor modal */}
      {editingIndex>=0 && <EditorModal x={list[editingIndex]} i={editingIndex} />}
    </div>
  );
}

/* ====== 小工具：從商品清單蒐集唯一標籤 ====== */
function normalizeAllTagsFromItems(list) {
  const set = new Set();
  (Array.isArray(list)? list: []).forEach(it => {
    let tags = [];
    if (Array.isArray(it?.tags)) tags = it.tags;
    else if (typeof it?.tags === 'string') tags = it.tags.split(',').map(s=>s.trim()).filter(Boolean);
    tags.forEach(t => set.add(t));
  });
  return Array.from(set);
}

/* ====== 小工具：清洗群組，去重／過濾不存在的標籤，保留先出現的群組與順序 ====== */
function ensureUniqueTagsInGroups(groups, allTags) {
  const ok = new Set(allTags || []);
  const seen = new Set();
  const cleaned = [];

  (Array.isArray(groups)? groups: []).forEach(g => {
    const name = String(g?.name || '').trim() || '未命名群組';
    const tags = [];
    (Array.isArray(g?.tags)? g.tags: []).forEach(t => {
      if (!ok.has(t)) return;     // 忽略不存在於 allTags 的標籤
      if (seen.has(t)) return;    // 去重複：第一個出現的群組保留
      seen.add(t);
      tags.push(t);
    });
    cleaned.push({ name, tags });
  });

  return cleaned;
}

/* =========================
 * TagGroupsEditor：群組可視化編輯器（新增／刪除／改名／排序；群內排序；從 allTags 選入）
 * ========================= */
function TagGroupsEditor({ groups = [], allTags = [], onChange = () => {} }) {
  const React = window.React || globalThis.React;

  const addGroup = () => onChange([ ...groups, { name: '', tags: [] } ]);
  const removeGroup = (i) => onChange(groups.filter((_, idx) => idx !== i));
  const moveGroup = (i, dir) => {
    const j = i + dir;
    if (j<0 || j>=groups.length) return;
    const arr = [...groups];
    const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    onChange(arr);
  };
  const renameGroup = (i, name) => {
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, name }) : g);
    onChange(arr);
  };

  // 已放入群組的標籤
  const inGroup = new Set(groups.flatMap(g => g?.tags || []));
  // 未分組標籤（可加入任一群組）
  const rest = (allTags || []).filter(t => !inGroup.has(t));

  const addTagToGroup = (i, t) => {
    if (!t) return;
    // 不允許重複：若 tag 已在其他群組，先移出
    const arr = groups.map((g, idx) => {
      if (idx === i) return { ...g, tags: Array.from(new Set([...(g?.tags||[]), t])) };
      return { ...g, tags: (g?.tags||[]).filter(x => x !== t) };
    });
    onChange(arr);
  };
  const removeTagFromGroup = (i, t) => {
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, tags: (g?.tags||[]).filter(x=>x!==t) }) : g);
    onChange(arr);
  };
  const moveTag = (i, t, dir) => {
    const tags = [...(groups[i]?.tags || [])];
    const k = tags.indexOf(t);
    const j = k + dir;
    if (k<0 || j<0 || j>=tags.length) return;
    const tmp = tags[k]; tags[k] = tags[j]; tags[j] = tmp;
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, tags }) : g);
    onChange(arr);
  };

  return (
    <div className="space-y-3">
      {/* 未分組標籤 */}
      <div className="rounded-lg border border-slate-200 dark:border-slate-700 p-2">
        <div className="text-xs text-slate-500 mb-1">未分組標籤（{rest.length}）</div>
        <div className="flex flex-wrap gap-2">
          {rest.length ? rest.map(t => (
            <span key={t} className="inline-flex items-center rounded-full border px-3 py-1 text-xs bg-white/70 dark:bg-slate-900/60">{t}</span>
          )) : <span className="text-xs text-slate-400">—</span>}
        </div>
      </div>

      {/* 群組清單 */}
      {groups.map((g, i) => {
        const availableToAdd = rest.concat( // 可加入的：未分組 + 不在本群組內（去重）
          (g?.tags || []).filter(t => !rest.includes(t))
        ).filter(Boolean);
        return (
          <div key={i} className="rounded-lg border border-slate-200 dark:border-slate-700 p-2 space-y-2">
            <div className="flex items-center gap-2">
              <input
                className="min-w-0 flex-1 rounded border px-2 py-1 text-sm"
                placeholder="群組名稱（例如：角色、生活用品、3C）"
                value={g?.name || ''}
                onChange={e=>renameGroup(i, e.target.value)}
              />
              <button className="rounded border px-2 py-1 text-xs" onClick={()=>moveGroup(i,-1)}>上移</button>
              <button className="rounded border px-2 py-1 text-xs" onClick={()=>moveGroup(i, 1)}>下移</button>
              <button className="rounded border px-2 py-1 text-xs text-rose-600" onClick={()=>removeGroup(i)}>刪除</button>
            </div>

            {/* 群內標籤 */}
            <div className="flex flex-wrap gap-2">
              {(g?.tags || []).map(t => (
                <span key={t} className="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs">
                  {t}
                  <button className="rounded border px-1 text-[10px]" title="上移" onClick={()=>moveTag(i,t,-1)}>↑</button>
                  <button className="rounded border px-1 text-[10px]" title="下移" onClick={()=>moveTag(i,t, 1)}>↓</button>
                  <button className="rounded border px-1 text-[10px] text-rose-600" title="移出群組" onClick={()=>removeTagFromGroup(i,t)}>×</button>
                </span>
              ))}
              {(g?.tags || []).length===0 && <span className="text-xs text-slate-400">尚未加入任何標籤</span>}
            </div>

            {/* 加入標籤到此群組 */}
            <div className="flex items-center gap-2">
              <select className="rounded border px-2 py-1 text-sm"
                value=""
                onChange={e=> addTagToGroup(i, e.target.value)}
              >
                <option value="" disabled>＋ 從未分組標籤加入</option>
                {availableToAdd
                  .filter(t => !(g?.tags||[]).includes(t) && !groups.some((gg,idx)=> idx!==i && (gg?.tags||[]).includes(t)))
                  .map(t => <option key={t} value={t}>{t}</option>)
                }
              </select>
            </div>
          </div>
        );
      })}

      {/* 新增群組 */}
      <div>
        <button className="rounded bg-slate-900 text-white px-3 py-1.5 text-sm dark:bg-slate-100 dark:text-slate-900" onClick={addGroup}>新增群組</button>
      </div>
    </div>
  );
}

function Others({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", content:"", pin:false });
  const [editingId, setEditingId] = useState(null);

  const cards = React.useMemo(()=> data.others?.cards || [], [data.others]);

  const orderedCards = React.useMemo(()=>{
    const list = data.others?.cards || [];
    const q = String(query).trim().toLowerCase();
    const filtered = q
      ? list.filter(x =>
          String(x.title||"").toLowerCase().includes(q) ||
          String(x.content||"").toLowerCase().includes(q)
        )
      : list;
    // pin=true 置頂優先
    return [...filtered].sort((a,b)=> (b.pin===true) - (a.pin===true));
  },[data.others, query]);

  const saveCard = () => {
    if (!admin) return alert("請進入管理模式");
    if (!draft.title) return alert("請填寫標題");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, content: draft.content||"", pin: !!draft.pin };
    const next = editingId ? cards.map(x=>x.id===editingId?rec:x) : [rec, ...cards];
    setData({ ...data, others: { ...data.others, cards: next } });
    setEditingId(null); setDraft({ title:"", content:"", pin:false });
  };

  const editCard = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", content:x.content||"", pin: !!x.pin }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", content:"", pin:false }); };

  const removeCard = (id) => { if(!admin) return; if(!confirm("刪除此卡片？")) return; setData({ ...data, others: { ...data.others, cards: cards.filter(x=>x.id!==id) } }); };
  const togglePin = (id) => { if(!admin) return; setData({ ...data, others: { ...data.others, cards: cards.map(x=>x.id===id?{...x,pin:!x.pin}:x) } }); };

  const move = (id, dir) => {
    if (!admin) return;
    const arr = [...cards], i = arr.findIndex(x=>x.id===id), j = dir==="up" ? i-1 : i+1;
    if (i<0 || j<0 || j>=arr.length) return;
    [arr[i], arr[j]] = [arr[j], arr[i]];
    setData({ ...data, others: { ...data.others, cards: arr } });
  };

  return (
    <Section title="📌 其他資料" subtitle="創立初衷、公告、開獎方式、補寄/再抽規則、點數規則、贊助說明、贊助者名單、查詢點數…">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="卡片標題（如：最新公告）"/>
          <textarea className="rounded-lg border px-3 py-2 min-h-[120px]" value={draft.content} onChange={e=>setDraft(d=>({...d,content:e.target.value}))} placeholder="內容（可貼連結）"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.pin} onChange={e=>setDraft(d=>({...d,pin:e.target.checked}))}/>置頂</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">取消</button>}
            <button onClick={saveCard} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "儲存修改" : "新增卡片"}</button>
          </div>
        </div>
      )}

      {cards.length === 0 && <EmptyCard text="目前沒有卡片內容" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // 重置，恢復單項可點擊
  }}
>
  全部展開
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // 重置
  }}
>
  全部收合
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {orderedCards.map((x)=> (
          <Collapse key={x.id} 
group="others"         // ★ 新增
  uid={x.id}             // ★ 新增
  force={bulk}           // 你原本就有，留著
header={`${x.title || "未命名卡片"}`} force={bulk}>
            <div className="whitespace-pre-wrap text-sm max-h-60 overflow-auto">
  {x.content || "（無內容）"}
</div>

            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>move(x.id,'up')} className="rounded-lg border px-3 py-1.5">上移</button>
                <button onClick={()=>move(x.id,'down')} className="rounded-lg border px-3 py-1.5">下移</button>
                <button onClick={()=>togglePin(x.id)} className="rounded-lg border px-3 py-1.5">{x.pin ? "取消置頂" : "置頂"}</button>
                <button onClick={()=>editCard(x)} className="rounded-lg border px-3 py-1.5">編輯</button>
                <button onClick={()=>removeCard(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">刪除</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

function PointsPanel({ data, admin, setData }) {
  const people = React.useMemo(() => data.shop?.people || [], [data.shop]);
  const logs   = React.useMemo(() => data.shop?.logs   || [], [data.shop]); // {id, personId, delta, note, at}
  const [q, setQ] = useState("");
  const [draft, setDraft] = useState({ name: "", points: "" });

  // 把「選擇人員」改成可輸入或選擇：用 datalist
  const [logDraft, setLogDraft] = useState({ name:"", delta:"", note:"" });

  const norm = (s="") => s.trim().toLowerCase();

  const result = React.useMemo(() => {
    if (!q.trim()) return null;
    const key = norm(q);
    const exact = people.find(p => norm(p.name) === key);
    if (exact) return exact;
    const fuzzy = people.find(p => norm(p.name).includes(key));
    return fuzzy || null;
  }, [q, people]);

const personIdFilter = React.useMemo(() => result?.id || null, [result]);

  const addOrUpdate = () => {
    if (!admin) return alert("請進入管理模式");
    const raw = draft.name || "";
    const name = raw.replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if (!name) return alert("請輸入姓名/暱稱");
    const pts = Number(draft.points || 0);
    if (!Number.isFinite(pts)) return alert("點數需為數字");

    const key = normName(name);
    const exists = people.find(p => normName(p.name) === key);

    const summary = exists
      ? `已存在「${exists.name}」，目前點數：${exists.points}\n要將點數改為：${pts} 嗎？`
      : `確認新增人員：${name}\n點數：${pts}`;
    if (!confirm(summary)) return;

    let nextPeople;
    if (exists) {
      nextPeople = people.map(p => normName(p.name) === key ? { ...p, name, points: pts } : p);
    } else {
      nextPeople = [{ id: nid(), name, points: pts }, ...people];
    }
    setData({ ...data, shop: { ...data.shop, people: nextPeople } });
    setDraft({ name: "", points: "" });
  };

  const adjust = (id, delta) => {
    if (!admin) return;
    const next = people.map(p => p.id === id ? { ...p, points: Math.max(0, Number(p.points||0) + delta) } : p);
    const log = { id: nid(), personId:id, delta, note: delta>0?'+調整':'-調整', at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: next, logs: [log, ...logs] } });
  };

  // ✅ 刪除人員：關鍵字確認，且不再丟回收站
  const removePerson = (id) => {
    if (!admin) return;
    const p = people.find(x=>x.id===id); if(!p) return;
    if(!confirmKeyword({label: `欲刪除：${p.name}`, keyword:'刪除'})) return;
    const nextShop = {
      ...data.shop,
      people: people.filter(x=>x.id!==id),
      logs   : logs // 人員刪除不動歷史流水
    };
    setData({ ...data, shop: nextShop });
  };

  // ✅ 新增異動：用名字找人；不存在就自動建立
  const addLog = () => {
    if(!admin) return;
    const rawName = (logDraft.name||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if(!rawName) return alert('請輸入人員姓名/暱稱');
    const delta = Number(logDraft.delta||0);
    if(!Number.isFinite(delta) || delta===0) return alert('請輸入非 0 的整數異動');

    // 先找現有人員
    const key = normName(rawName);
    let person = people.find(x => normName(x.name) === key);

    let nextPeople = [...people];
    if (!person) {
      // 自動建立新的人員（0 點）
      person = { id: nid(), name: rawName, points: 0 };
      nextPeople = [person, ...people];
    }

    // 寫入點數與流水
    nextPeople = nextPeople.map(x => x.id===person.id ? { ...x, points: Math.max(0, Number(x.points||0) + delta) } : x);
    const log = { id: nid(), personId: person.id, delta, note: logDraft.note||'', at: nowISO() };

    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [log, ...logs] } });

setQ(rawName);

    setLogDraft({ name:"", delta:"", note:"" });
  };

  const revokeLog = (logId) => {
    if(!admin) return;
    const lg = logs.find(l=>l.id===logId); if(!lg) return;
    if(!confirm('要撤銷這筆異動嗎？會寫入一筆相反數的補記。')) return;
    const pid = lg.personId; const delta = -lg.delta;
    const nextPeople = people.map(x=> x.id===pid ? { ...x, points: Math.max(0, Number(x.points||0)+delta) } : x);
    const newLog = { id: nid(), personId: pid, delta, note: `撤銷 ${logId}`, at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [newLog, ...logs] } });
  };

  const sorted  = React.useMemo(()=> [...people].sort((a,b)=> a.name.localeCompare(b.name, "zh-Hant")), [people]);
  // 依目前查詢到的人（result）來過濾其個人流水，並只取 5 筆
const latest5 = React.useMemo(() => {
  const filtered = personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
  return filtered.slice(0,5);
}, [logs, personIdFilter]);

const visibleLogs = React.useMemo(()=>{
  return personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
}, [logs, personIdFilter]);

const [showAllLogs, setShowAllLogs] = React.useState(false);


  return (
    <Section title="🔍 查詢點數" subtitle="公開最多顯示最近 5 筆異動；管理可看全部、加一筆/撤銷、可匯出。">
      <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
        <input className="rounded-lg border px-3 py-2" value={q} onChange={(e)=>setQ(e.target.value)} placeholder="輸入姓名/暱稱進行查詢"/>
        <div className="text-sm">
          {q.trim()
            ? (result
                ? <span>「<b>{result.name}</b>」目前點數：<b>{result.points}</b></span>
                : <span>找不到「{q}」的點數紀錄</span>)
            : <span className="text-slate-500">請輸入要查詢的姓名/暱稱</span>}
        </div>
      </div>

      {/* 公開流水：僅顯示查詢到的此人最近 5 筆 */}
<div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 mt-3">
  <div className="text-sm font-medium mb-2">最近 5 筆點數異動（僅此人）</div>

{admin && result && (
  <div className="mt-2">
    <button
      className="rounded-lg border px-3 py-2 text-sm"
      onClick={()=> setShowAllLogs(true)}
      title="打開此人的全部點數異動紀錄"
    >
      查看「{result.name}」全部紀錄
    </button>
  </div>
)}


  {!q.trim() ? (
    <div className="text-sm text-slate-500">請先在上方輸入姓名/暱稱進行查詢</div>
  ) : !result ? (
    <div className="text-sm text-slate-500">找不到「{q}」的點數紀錄</div>
  ) : latest5.length === 0 ? (
    <div className="text-sm text-slate-500">「{result.name}」目前沒有異動紀錄</div>
  ) : (
    <div className="grid gap-2">
      {latest5.map(l=>{
        const p = people.find(x=>x.id===l.personId);
        return (
          <div key={l.id} className="text-sm flex items-center justify-between">
            <div className="truncate">{p?.name || '(已刪)'}｜{l.delta>0?`+${l.delta}`:l.delta}｜{l.note||'（無備註）'}</div>
            <div className="text-xs text-slate-500">{l.at}</div>
          </div>
        );
      })}
    </div>
  )}
</div>


      {admin && (
        <>
          {/* 新增/更新人員 */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="grid sm:grid-cols-2 gap-3">
              <input className="rounded-lg border px-3 py-2" value={draft.name} onChange={(e)=>setDraft(d=>({ ...d, name: e.target.value }))} placeholder="姓名/暱稱"/>
              <input className="rounded-lg border px-3 py-2" value={draft.points} onChange={(e)=>setDraft(d=>({ ...d, points: e.target.value }))} placeholder="點數（整數）"/>
            </div>
            <div className="flex justify-end">
              <button onClick={addOrUpdate} className="rounded-lg bg-brand text-white px-4 py-2">新增/更新</button>
            </div>
          </div>

          {/* 管理：全部流水表、加一筆 / 撤銷 / 匯出 */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="flex items-center justify-between">
              <div className="text-sm font-medium">全部異動</div>
              <div className="flex items-center gap-2">
  {q.trim() && (
    <button
      className="rounded-lg border px-3 py-1.5 text-sm"
      onClick={()=>setQ("")}
      title="清除人員過濾"
    >
      清除過濾
    </button>
  )}
  <button
    className="rounded-lg border px-3 py-1.5 text-sm"
    onClick={()=>{
      const rows = [['at','person','delta','note']];
      const list = personIdFilter ? logs.filter(l=>l.personId===personIdFilter) : logs;
      list.forEach(l=>{
        const p = people.find(x=>x.id===l.personId);
        rows.push([l.at, p?.name||'(已刪)', l.delta, l.note||'']);
      });
      exportCSV('points_logs.csv', rows);
    }}
  >
    匯出 CSV
  </button>
</div>

            </div>

            {/* ✅ 新增一筆異動：可輸入或下拉選擇 */}
            <div className="grid sm:grid-cols-3 gap-2">
              <div className="sm:col-span-1">
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  list="people-list"
                  placeholder="人員（可輸入或選擇）"
                  value={logDraft.name}
                  onChange={e=>setLogDraft(d=>({...d, name:e.target.value}))}
                />
                <datalist id="people-list">
                  {people.map(p => <option key={p.id} value={p.name} />)}
                </datalist>
              </div>
              <input className="rounded-lg border px-3 py-2" placeholder="異動（整數，可負）" value={logDraft.delta} onChange={e=>setLogDraft(d=>({...d,delta:e.target.value}))}/>
              <input className="rounded-lg border px-3 py-2 sm:col-span-1" placeholder="備註（可空白）" value={logDraft.note} onChange={e=>setLogDraft(d=>({...d,note:e.target.value}))}/>
              <div className="sm:col-span-3 flex justify-end">
                <button onClick={addLog} className="rounded-lg bg-brand text-white px-4 py-2">新增異動</button>
              </div>
            </div>

            {/* 表格 */}
            <div className="rounded-xl border overflow-hidden">
              <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
                <div className="col-span-3">時間</div>
                <div className="col-span-3">人員</div>
                <div className="col-span-2">異動</div>
                <div className="col-span-3">備註</div>
                <div className="col-span-1 text-right">操作</div>
              </div>
              {logs.length===0 && <div className="px-4 py-3 text-sm text-slate-500">尚無異動</div>}
              {visibleLogs.map(l=>{

                const p = people.find(x=>x.id===l.personId);
                return (
                  <div key={l.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                    <div className="col-span-3 text-xs">{l.at}</div>
                    <div className="col-span-3">
  {p
    ? <button className="underline text-brand" onClick={()=>setQ(p.name)} title="只看此人">{p.name}</button>
    : '(已刪)'}
</div>

                    <div className="col-span-2">{l.delta>0?`+${l.delta}`:l.delta}</div>
                    <div className="col-span-3 truncate">{l.note||''}</div>
                    <div className="col-span-1 flex justify-end">
                      <button onClick={()=>revokeLog(l.id)} className="rounded-lg border px-2 py-1 text-xs">撤銷</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* 人員列表 */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mt-3">
            <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
              <div className="col-span-6">姓名/暱稱</div>
              <div className="col-span-3">點數</div>
              <div className="col-span-3 text-right">操作</div>
            </div>
            {sorted.length === 0 && (
              <div className="px-4 py-3 text-sm text-slate-500">尚無人員點數資料</div>
            )}
            {sorted.map(p => (
              <div key={p.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                <div className="col-span-6">
  <button className="underline text-brand" onClick={()=>setQ(p.name)} title="只看此人">
    {p.name}
  </button>
</div>

                <div className="col-span-3">{p.points}</div>
                <div className="col-span-3 flex justify-end gap-2">
                  <button onClick={()=>adjust(p.id, +1)} className="rounded-lg border px-3 py-1.5">+1</button>
                  <button onClick={()=>adjust(p.id, -1)} className="rounded-lg border px-3 py-1.5">-1</button>
                  <button onClick={()=>removePerson(p.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">刪除</button>
                </div>
              </div>
            ))}
          </div>
        </>
      )}
    </Section>
  );
}

function SettingsPanel({ data, setData, bg, setBg }) {
  const DEFAULTS = DEFAULT_SETTINGS;
  const s = (data && data.settings) ? data.settings : DEFAULTS;

  // 表單暫存（抽獎參數 + 聯絡管理員連結）
  const [draft, setDraft] = React.useState({
    drawMaxPerRun:       s.drawMaxPerRun       ?? DEFAULTS.drawMaxPerRun,
    drawPublicShowLimit: s.drawPublicShowLimit ?? DEFAULTS.drawPublicShowLimit,
    drawCooldownSec:     s.drawCooldownSec     ?? DEFAULTS.drawCooldownSec,
    contactUrl:          s.contactUrl          ?? ""
  });

  // 讓彈窗可直接讀到全域聯絡連結（商品未覆寫時使用）
  React.useEffect(() => {
    window.__CONTACT_URL__ = draft.contactUrl || s.contactUrl || "";
  }, [draft.contactUrl, s.contactUrl]);

  const onNum  = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));
  const onText = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));

  const saveSettings = () => {
    const a = Math.max(1, parseInt(draft.drawMaxPerRun, 10)       || DEFAULTS.drawMaxPerRun);
    const b = Math.max(1, parseInt(draft.drawPublicShowLimit, 10) || DEFAULTS.drawPublicShowLimit);
    const c = Math.max(0, parseInt(draft.drawCooldownSec, 10)     || DEFAULTS.drawCooldownSec);
    const contact = String(draft.contactUrl || "").trim();

    const nextSettings = {
      drawMaxPerRun: a,
      drawPublicShowLimit: b,
      drawCooldownSec: c,
      contactUrl: contact
    };

    setData(prev => {
      const prevObj = (prev && typeof prev === "object") ? prev : {};
      return { ...prevObj, settings: nextSettings };
    });
    window.__CONTACT_URL__ = contact;
    alert("已更新系統設定");
  };

  const HasImageInput = (typeof ImageInput === "function");

  return (
    <Section title="⚙️ 系統設置" subtitle="抽獎參數 + 聯絡管理員連結 + 背景管理（主畫面/漢堡選單）">
      {/* 抽獎模擬器參數 */}
      <div className="grid sm:grid-cols-3 gap-3">
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">抽獎單次名額上限</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawMaxPerRun} onChange={onNum("drawMaxPerRun")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">公開結果顯示筆數上限</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawPublicShowLimit} onChange={onNum("drawPublicShowLimit")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">模擬重跑冷卻（秒）</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="0"
            value={draft.drawCooldownSec} onChange={onNum("drawCooldownSec")} />
        </div>
      </div>

      {/* 聯絡管理員（全域外部連結） */}
      <div className="mt-4 grid gap-1">
        <label className="text-sm text-slate-500">聯絡管理員·外部連結（可空）</label>
        <input
          className="rounded-lg border px-3 py-2 w-full"
          placeholder="https://..."
          value={draft.contactUrl}
          onChange={onText("contactUrl")}
        />
        <div className="text-xs text-slate-500">商品未自訂時，彈窗的「聯絡管理員」按鈕將使用此連結。</div>
      </div>

      {/* 背景管理（主畫面 / 漢堡選單） */}
      <div className="mt-6 grid md:grid-cols-2 gap-6">
        {/* 主畫面背景 */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">🎨 主畫面背景</div>

          {HasImageInput ? (
            <ImageInput
              label="背景圖片（可空）"
              value={bg.url || ""}
              onChange={(url) => setBg({ ...bg, url })}
            />
          ) : (
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">背景圖片 URL（可空）</label>
              <input
                className="rounded-lg border px-3 py-2 w-full"
                placeholder="https://..."
                value={bg.url || ""}
                onChange={e=>setBg({ ...bg, url: e.target.value })}
              />
            </div>
          )}

          <div className="grid sm:grid-cols-2 gap-3 mt-3">
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">亮度 {bg.brightness ?? 1}</label>
              <input type="range" min="0.2" max="2" step="0.05"
                value={bg.brightness ?? 1}
                onChange={e=>setBg({ ...bg, brightness: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">霧化（px） {bg.blur ?? 0}</label>
              <input type="range" min="0" max="16" step="1"
                value={bg.blur ?? 0}
                onChange={e=>setBg({ ...bg, blur: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">透明度 {bg.opacity ?? 1}</label>
              <input type="range" min="0" max="1" step="0.05"
                value={bg.opacity ?? 1}
                onChange={e=>setBg({ ...bg, opacity: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">位置</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.pos || "center"}
                onChange={e=>setBg({ ...bg, pos: e.target.value })}
              >
                <option value="center">center</option>
                <option value="top">top</option>
                <option value="bottom">bottom</option>
                <option value="left">left</option>
                <option value="right">right</option>
                <option value="top left">top left</option>
                <option value="top right">top right</option>
                <option value="bottom left">bottom left</option>
                <option value="bottom right">bottom right</option>
              </select>
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">尺寸</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.size || "cover"}
                onChange={e=>setBg({ ...bg, size: e.target.value })}
              >
                <option value="cover">cover（滿版）</option>
                <option value="contain">contain（等比完整）</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div className="mt-2">
            <label className="block text-sm mb-1">色彩覆蓋（Tint）</label>
            <input
              className="rounded-lg border px-3 py-2 w-full"
              placeholder="例如：rgba(0,0,0,0.25)"
              value={bg.tint || ""}
              onChange={e=>setBg({ ...bg, tint: e.target.value })}
            />
          </div>
        </div>

        {/* 漢堡選單背景 */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">📂 漢堡選單背景</div>

          <label className="inline-flex items-center gap-2 text-sm">
            <input type="checkbox"
              checked={!!bg.menuUseMain}
              onChange={e=>setBg({ ...bg, menuUseMain: e.target.checked })}
            />
            <span>沿用主畫面設定</span>
          </label>

          {!bg.menuUseMain && (
            <>
              {HasImageInput ? (
                <ImageInput
                  label="選單背景圖片（可空）"
                  value={bg.menuUrl || ""}
                  onChange={(url) => setBg({ ...bg, menuUrl: url })}
                />
              ) : (
                <div className="grid gap-1 mt-2">
                  <label className="text-sm text-slate-500">選單背景圖片 URL（可空）</label>
                  <input
                    className="rounded-lg border px-3 py-2 w-full"
                    placeholder="https://..."
                    value={bg.menuUrl || ""}
                    onChange={e=>setBg({ ...bg, menuUrl: e.target.value })}
                  />
                </div>
              )}

              <div className="grid sm:grid-cols-2 gap-3 mt-3">
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">亮度 {bg.menuBrightness ?? 1}</label>
                  <input type="range" min="0.2" max="2" step="0.05"
                    value={bg.menuBrightness ?? 1}
                    onChange={e=>setBg({ ...bg, menuBrightness: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">霧化（px） {bg.menuBlur ?? 0}</label>
                  <input type="range" min="0" max="16" step="1"
                    value={bg.menuBlur ?? 0}
                    onChange={e=>setBg({ ...bg, menuBlur: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">透明度 {bg.menuOpacity ?? 1}</label>
                  <input type="range" min="0" max="1" step="0.05"
                    value={bg.menuOpacity ?? 1}
                    onChange={e=>setBg({ ...bg, menuOpacity: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">位置</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuPos || "center"}
                    onChange={e=>setBg({ ...bg, menuPos: e.target.value })}
                  >
                    <option value="center">center</option>
                    <option value="top">top</option>
                    <option value="bottom">bottom</option>
                    <option value="left">left</option>
                    <option value="right">right</option>
                    <option value="top left">top left</option>
                    <option value="top right">top right</option>
                    <option value="bottom left">bottom left</option>
                    <option value="bottom right">bottom right</option>
                  </select>
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">尺寸</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuSize || "cover"}
                    onChange={e=>setBg({ ...bg, menuSize: e.target.value })}
                  >
                    <option value="cover">cover（滿版）</option>
                    <option value="contain">contain（等比完整）</option>
                    <option value="auto">auto</option>
                  </select>
                </div>
              </div>

              <div className="mt-2">
                <label className="block text-sm mb-1">色彩覆蓋（Tint）</label>
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  placeholder="例如：rgba(0,0,0,0.25)"
                  value={bg.menuTint || ""}
                  onChange={e=>setBg({ ...bg, menuTint: e.target.value })}
                />
              </div>
            </>
          )}
        </div>
      </div>

      {/* 快速風格（可選） */}
      <div className="mt-6 flex flex-wrap gap-2">
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.20)", brightness:1.0, blur:2, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >清爽</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.35)", brightness:0.95, blur:6, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >柔霧</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(0,0,0,0.35)", brightness:1.1, blur:0, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >暗底</button>

        <button
          onClick={()=>setBg({
            url:"", tint:"rgba(255,255,255,0.0)", brightness:1, blur:0, opacity:1,
            size:"cover", pos:"center",
            menuUseMain:true, menuUrl:"", menuTint:"rgba(255,255,255,0.0)",
            menuBrightness:1, menuBlur:0, menuOpacity:1, menuSize:"cover", menuPos:"center"
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >清除背景</button>
      </div>

      {/* 儲存（只寫抽獎參數與聯絡連結；背景透過 setBg 即時生效/另有本地儲存） */}
      <div className="mt-6 flex justify-end">
        <button onClick={saveSettings} className="rounded-lg bg-brand text-white px-4 py-2">儲存系統設定</button>
      </div>
    </Section>
  );
}

function SystemSettings({ data, setData, bg, setBg, admins, setAdmins, currentAdmin, setCurrentAdmin }) {
  return (
    <Section title="⚙️ 系統設置" subtitle="集中管理所有設定項目。">
      {/* 你原本使用的 SettingsPanel 完整搬到這裡呈現 */}
      <SettingsPanel data={data} setData={setData} bg={bg} setBg={setBg} />

{/* === 管理者清單（本地）=== */}
<Section id="admin-list-panel" title="👤 管理者清單" subtitle="新增／刪除／改名／改密碼（資料儲存在本機）。">
  <div className="grid gap-3">
    {/* 列表 */}
    <div className="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 dark:bg-slate-800/50">
          <tr>
            <th className="text-left px-3 py-2">名稱</th>
            <th className="text-left px-3 py-2">密碼狀態</th>
            <th className="text-right px-3 py-2">操作</th>
          </tr>
        </thead>
        <tbody>
          {admins.map((a, idx)=>(
            <tr key={idx} className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-2">{a.name}</td>
              <td className="px-3 py-2">{a.passwordHash ? '已設定' : '尚未設定'}</td>
              <td className="px-3 py-2">
                <div className="flex justify-end gap-2">
                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const newName = prompt('輸入新名稱', a.name) || '';
                      const trimmed = newName.trim();
                      if(!trimmed){ alert('名稱不可為空'); return; }
                      if(trimmed !== a.name && admins.some(x=>x.name === trimmed)){
                        alert('名稱已存在'); return;
                      }
                      const next = admins.map(x => x.name === a.name ? ({ ...x, name: trimmed }) : x);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(trimmed); }
                      alert('名稱已更新');
                    }}
                  >改名</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const pwd = prompt('輸入新密碼（至少 4 碼）') || '';
                      if(pwd.length < 4){ alert('密碼太短'); return; }
                      const hash = await hashTextSHA256(pwd);
                      const next = admins.map(x => x.name === a.name ? ({ ...x, passwordHash: hash }) : x);
                      setAdmins(next);
                      alert('密碼已更新');
                    }}
                  >改密碼</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={()=>{
                      if(!confirm(`確定要刪除管理者「${a.name}」？`)) return;
                      const next = admins.filter(x => x.name !== a.name);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(''); setAdminMode(false); }
                      alert('已刪除');
                    }}
                  >刪除</button>
                </div>
              </td>
            </tr>
          ))}
          {admins.length === 0 && (
            <tr className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-6 text-center text-slate-500" colSpan={3}>目前沒有管理者</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    {/* 新增 */}
    <div className="flex gap-2">
      <button
        className="rounded-lg border px-3 py-1.5"
        onClick={async ()=>{
          const name = prompt('輸入新管理者名稱') || '';
          const n = name.trim();
          if(!n){ alert('名稱不可為空'); return; }
          if(admins.some(a => a.name === n)){ alert('名稱已存在'); return; }
          const pwd = prompt('設定密碼（至少 4 碼）') || '';
          if(pwd.length < 4){ alert('密碼太短'); return; }
          const hash = await hashTextSHA256(pwd);
          setAdmins([...admins, { name: n, passwordHash: hash }]);
          alert('已新增管理者');
        }}
      >新增管理者</button>
    </div>
  </div>
</Section>
     
 {/* 如未來要擴充更多設定，可在此繼續分段 */}
      {/* 例：網站資訊 / 權限 / 備份工具 / 主題風格 等 */}
    </Section>
  );
}

function ImageInput({ label="圖片", value="", onChange }) {
  const [mode, setMode] = React.useState(value && /^https?:\/\//i.test(value) ? 'url' : (value ? 'data' : 'url'));
  const fileRef = React.useRef(null);

  const pickFile = ()=> fileRef.current?.click();
  const onFile = async (f)=>{
    if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=> onChange?.(String(e.target?.result||""));
    reader.readAsDataURL(f);
  };

  return (
    <div className="grid gap-1.5">
      <label className="text-sm text-slate-600 dark:text-slate-300">{label}</label>
      <div className="flex items-center gap-2">
        <button
          type="button"
          onClick={()=>setMode('url')}
          className={`px-2 py-1 rounded border text-xs ${mode==='url'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >網址</button>
        <button
          type="button"
          onClick={()=>setMode('data')}
          className={`px-2 py-1 rounded border text-xs ${mode==='data'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >本機檔案</button>
      </div>

      {mode==='url' ? (
        <input
          className="rounded-lg border px-3 py-2"
          value={value}
          onChange={e=>onChange?.(e.target.value)}
          placeholder="https://... 或直接貼上網址"
        />
      ) : (
        <>
          <div className="flex items-center gap-2">
            <button type="button" onClick={pickFile} className="rounded-lg border px-3 py-2 text-sm">選擇檔案</button>
            <span className="text-xs text-slate-500">（將讀為 base64，離線也可顯示）</span>
          </div>
          <input
            ref={fileRef}
            type="file"
            accept="image/*"
            className="hidden"
            onChange={e=>onFile(e.target.files?.[0]||null)}
          />
        </>
      )}

      {value && (
        <div className="mt-2">
          <img src={value} alt="" className="max-h-40 rounded border bg-slate-50 dark:bg-slate-800 object-contain"/>
        </div>
      )}
    </div>
  );
}

function ShopImageQuickset({ data, setData, admin }) {
  if (!admin) return null; // 只給管理模式用

  // 目前商品清單
  const items = Array.isArray(data?.shop?.items) ? data.shop.items : [];

  // —— 相容：把舊的單張 image 轉為 images 陣列（不覆蓋原欄位，只補上）——
  const ensureImagesArr = (it) => {
    const nx = { ...it };
    if (!Array.isArray(nx.images)) {
      const one = String(nx.image || "").trim();
      nx.images = one ? [one] : [];
    }
    return nx;
  };

  // 草稿：以 image 欄位為準（你原本的行為保留）
  const [drafts, setDrafts] = React.useState(() =>
    items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    }))
  );

  // 若外部 items 改變，草稿同步一次（你原本的行為保留）
  React.useEffect(() => {
    setDrafts(items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    })));
  }, [items]);

  // 正規化：去頭尾引號與空白（只提供給「檔名自動補資料夾」按鈕用；saveAll 不用它）
  const normPath = (s) => String(s || '').trim().replace(/^"+|"+$/g, '');

  // 儲存：把草稿寫回 data.shop.items[i].image（★ 原樣保存，不加工）
  const saveAll = () => {
    const next = items.map((it, i) => {
      const image = drafts[i]?.image ?? '';   // 不做任何處理，原樣字串
      return { ...it, image };                // ← 修正 ...it
    });
    setData({
      ...data,                                // ← 修正 ...data
      shop: { ...(data.shop || {}), items: next }  // ← 修正 ...(data.shop || {})
    });
    alert('已儲存圖片路徑到商品。之後「匯出」即可把路徑帶出。');
  };

  // 若只貼「檔名.jpg」沒有資料夾，自動補 ./assets/products/（★ 僅在你按這顆鈕時才會變動）
  const applyBaseToEmpty = () => {
    const base = './assets/products/';
    setDrafts(ds => ds.map(d => {
      const v = normPath(d.image);
      if (!v) return d;
      if (!v.includes('/')) return { ...d, image: base + v }; // ← 修正 ...d
      return d;
    }));
  };

  // ====== 以下是「多圖管理」新增功能（不影響上面既有流程） ======

  // 單張新增到 images[]
  const addOneImage = (id, url) => {
    const u = String(url || "").trim();
    if (!u) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      if (!nx.images.includes(u)) {
        nx.images = [...nx.images, u];
        if (!nx.image) nx.image = u;          // 沒封面時補上
      }
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // 多張批量（每行一個）
  const addMultiImages = (id, text) => {
    const lines = String(text || "")
      .split(/\r?\n/)
      .map((s) => s.trim())
      .filter(Boolean);
    if (lines.length === 0) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const set = new Set(nx.images);
      for (const l of lines) set.add(l);
      nx.images = Array.from(set);
      if (!nx.image && nx.images.length > 0) nx.image = nx.images[0]; // 沒封面→第一張
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // 刪除某張圖片（並回退封面為新第一張）
  const removeImageAt = (id, idx) => {
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const arr = [...nx.images];
      if (idx < 0 || idx >= arr.length) return it;
      arr.splice(idx, 1);
      nx.images = arr;
      nx.image = arr[0] || ""; // 封面回退
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  return (
    <section
      className="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4"
      aria-label="商品圖片路徑快速設定＋多圖管理"
    >
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-base font-semibold">🖼️ 商品圖片管理（保留舊功能＋新增多圖）</h3>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={applyBaseToEmpty}
            className="rounded-lg border px-3 py-1.5 text-sm"
            title="若輸入僅檔名，幫你自動加上 ./assets/products/"
          >
            檔名自動補資料夾
          </button>
          <button
            type="button"
            onClick={saveAll}
            className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm"
            title="把輸入的路徑寫回 data.shop.items"
          >
            儲存全部（封面 image）
          </button>
        </div>
      </div>

      {items.length === 0 ? (
        <div className="text-sm text-slate-500">目前沒有商品可設定圖片。</div>
      ) : (
        <div className="grid gap-4">
          {items.map((raw, i) => {
            const it = ensureImagesArr({ ...raw });
            const d  = drafts[i] || { id: it.id, name: it.name || '', image: it.image || '' };
            return (
              <div key={it.id || i} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3">
                {/* 標題列 */}
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm">
                    <div className="font-medium truncate">{it.name || '（未命名）'}</div>
                    {it.id && <div className="text-xs text-slate-500">ID：{it.id}</div>}
                  </div>
                  <div className="text-xs text-slate-500">{(it.images || []).length} 張</div>
                </div>

                {/* 你原本的：單一封面 image 輸入（保留） */}
                <div className="grid sm:grid-cols-2 gap-2 items-center mb-3">
                  <label className="text-xs text-slate-500 sm:col-span-1">封面 image（單一字串）</label>
                  <input
                    className="rounded-lg border px-3 py-2 text-sm sm:col-span-1"
                    placeholder="貼上封面圖片路徑或完整網址"
                    value={d.image}
                    onChange={e => {
                      const v = e.target.value;
                      setDrafts(ds => ds.map((x, j) => (j === i ? { ...x, image: v } : x)));
                    }}
                  />
                </div>

                {/* 新增：多圖縮圖清單（管理可刪單張） */}
                <div>
                  <div className="text-xs text-slate-500 mb-1">更多圖片（images[]）</div>
                  <div className="no-scrollbar overflow-x-auto flex gap-2 mb-2">
                    {(it.images || []).length === 0 ? (
                      <div className="text-xs text-slate-500">尚無其他圖片</div>
                    ) : (
                      it.images.map((src, k) => (
                        <div key={k} className="relative shrink-0">
                          <img
                            src={src}
                            alt={`圖${k + 1}`}
                            className="w-28 h-28 object-cover rounded-lg border border-slate-200/70 dark:border-slate-700/70"
                            loading="lazy"
                          />
                          <button
                            className="absolute -top-2 -right-2 bg-rose-600 text-white w-6 h-6 rounded-full text-xs"
                            title="刪除此圖"
                            onClick={() => removeImageAt(it.id, k)}
                          >
                            ×
                          </button>
                        </div>
                      ))
                    )}
                  </div>

                  {/* 單張新增 */}
                  <div className="flex gap-2 items-center mb-2">
                    <input
                      type="url"
                      placeholder="貼上單張圖片網址..."
                      className="flex-1 rounded-lg border px-3 py-1.5 text-sm bg-white/80 dark:bg-slate-800/70"
                      onKeyDown={(e) => {
                        if (e.key === "Enter") {
                          addOneImage(it.id, e.currentTarget.value);
                          e.currentTarget.value = "";
                        }
                      }}
                    />
                    <button
                      className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={(e) => {
                        const input = e.currentTarget.previousElementSibling;
                        if (input && input.value) {
                          addOneImage(it.id, input.value);
                          input.value = "";
                        }
                      }}
                    >
                      新增
                    </button>
                  </div>

                  {/* 多張批量貼上（每行一張；貼上即匯入並清空） */}
                  <div className="grid gap-2">
                    <label className="text-xs text-slate-500">批量貼上（每行一個圖片網址）</label>
                    <textarea
                      rows={3}
                      placeholder="https://...1.jpg
https://...2.png"
                      className="rounded-lg border px-3 py-2 text-sm bg-white/80 dark:bg-slate-800/70"
                      onPaste={(e) => {
                        setTimeout(() => {
                          const v = e.currentTarget.value;
                          if (v && v.trim()) {
                            addMultiImages(it.id, v);
                            e.currentTarget.value = "";
                          }
                        }, 0);
                      }}
                    />
                    <div className="text-xs text-slate-500">
                      貼上後會自動匯入並清空輸入框；重複網址會自動略過。
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <p className="mt-3 text-xs text-slate-500">
        小提醒：把圖片放進 <code>assets/products/</code> 後，可以只貼
        <code> 檔名.jpg</code>，再按「檔名自動補資料夾」。或直接貼相對路徑 <code>./assets/products/檔名.jpg</code>，
        也支援完整網址 <code>https://...</code>。<br/>
        多圖區會即時更新 <code>images[]</code> 與封面 <code>image</code>（刪除時封面自動回退）。
      </p>
    </section>
  );
}

// ===== 通用燈箱（必要功能版） =====
function LightboxRoot() {
  const [open, setOpen] = React.useState(false);
  const [imgs, setImgs] = React.useState([]);
  const [idx, setIdx]   = React.useState(0);
  const originRef = React.useRef(null);

  // 影像平移/縮放（簡版）
  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);
  const last = React.useRef({ x:0, y:0, p1:null, p2:null, dist:0 });

  // 開啟 API（全域）
  React.useEffect(()=>{
    window.__LB__ = {
      openFrom(el){
        // 往上找 data-gallery
        const node = el.closest("[data-gallery]");
        if(!node) return;
        const group = node.getAttribute("data-gallery");
        const all = Array.from(document.querySelectorAll(`[data-zoomable][data-gallery="${group}"]`));
        const sources = all.map(n => n.getAttribute("src"));
        const start = Number(el.getAttribute("data-index") || "0");
        originRef.current = el;
        setImgs(sources);
        setIdx(Math.max(0, Math.min(start, sources.length-1)));
        setScale(1); setTx(0); setTy(0);
        setOpen(true);
      }
    };
  },[]);

  // 鍵盤控制（ESC/左右鍵）
  React.useEffect(()=>{
    if(!open) return;
    const onKey = (e)=>{
      if(e.key === "Escape"){ e.preventDefault(); close(); }
      else if(e.key === "ArrowLeft"){ setIdx(i=>Math.max(0, i-1)); resetTransform(); }
      else if(e.key === "ArrowRight"){ setIdx(i=>Math.min(imgs.length-1, i+1)); resetTransform(); }
    };
    window.addEventListener("keydown", onKey);
    return ()=>window.removeEventListener("keydown", onKey);
  },[open, imgs.length]);

  function resetTransform(){ setScale(1); setTx(0); setTy(0); }

  function close(){
    setOpen(false);
    // 焦點回到原圖
    setTimeout(()=>{ originRef.current?.focus?.(); }, 0);
  }

  // 滑鼠拖曳 / 觸控縮放
  function onPointerDown(e){
    e.preventDefault();
    e.currentTarget.setPointerCapture(e.pointerId);
    if(last.current.p1 && !last.current.p2) last.current.p2 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    if(!last.current.p1) last.current.p1 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    last.current.x = e.clientX; last.current.y = e.clientY;
    if(last.current.p1 && last.current.p2){
      const dx = last.current.p1.x - last.current.p2.x;
      const dy = last.current.p1.y - last.current.p2.y;
      last.current.dist = Math.hypot(dx, dy) || 1;
    }
  }
  function onPointerMove(e){
    if(!open) return;
    if(last.current.p1 && last.current.p2){
      // 雙指縮放
      const p = (p)=>p?.id===e.pointerId ? { id:e.pointerId, x:e.clientX, y:e.clientY } : p;
      last.current.p1 = p(last.current.p1);
      last.current.p2 = p(last.current.p2);
      const dx = (last.current.p1.x - last.current.p2.x);
      const dy = (last.current.p1.y - last.current.p2.y);
      const d  = Math.hypot(dx, dy) || 1;
      const s  = Math.min(4, Math.max(1, scale * (d / (last.current.dist || d))));
      setScale(s);
      last.current.dist = d;
    }else{
      // 單指/滑鼠拖曳
      const dx = e.clientX - last.current.x;
      const dy = e.clientY - last.current.y;
      setTx(t=>t+dx); setTy(t=>t+dy);
      last.current.x = e.clientX; last.current.y = e.clientY;
    }
  }
  function onPointerUp(e){
    if(last.current.p2?.id===e.pointerId) last.current.p2=null;
    else if(last.current.p1?.id===e.pointerId) last.current.p1=null;
  }
   function onDblClick(){ setScale(s => s>1 ? 1 : 2); setTx(0); setTy(0); }

  if(!open) return null;
  return (
    <div className="fixed inset-0 z-[9999] bg-black/90 backdrop-blur-sm flex flex-col" role="dialog" aria-modal="true">
      <div className="flex items-center justify-between px-3 py-2">
        <div className="text-slate-200 text-sm">{idx+1} / {imgs.length}</div>
        <div className="flex items-center gap-2">
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.max(0,i-1)); resetTransform(); }} disabled={idx<=0}>←</button>
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.min(imgs.length-1,i+1)); resetTransform(); }} disabled={idx>=imgs.length-1}>→</button>
          <button className="rounded-md bg-white text-black px-2 py-1 text-sm" onClick={close}>關閉</button>
        </div>
      </div>
      <div className="relative flex-1 overflow-hidden touch-pan-y">
        <img
          src={imgs[idx]}
          alt=""
          className="absolute left-1/2 top-1/2 select-none"
          style={{
            transform:`translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`,
            maxWidth:"90vw", maxHeight:"75vh"
          }}
          onPointerDown={onPointerDown}
          onPointerMove={onPointerMove}
          onPointerUp={onPointerUp}
          onPointerCancel={onPointerUp}
          onDoubleClick={onDblClick}
          draggable={false}
        />
      </div>
    </div>
  );
}


    // —— Render ——
    // —— Render ——
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<><App /><LightboxRoot /></>);

  </script>

<!-- [IMGIO JS START] -->
<script>
(function(){
  // —— 統一的圖片狀態（key -> { src, type, fit, opacity, offsetX, offsetY, scale, rotateDeg }）
  // 注意：我們不會動你貼進來的 src 字串（絕不正規化、絕不補前綴）。
  const imageState = new Map();

  // 以 dataset 或 DOM 路徑取得穩定 key（沒有 data-img-key 也能運作）
  function getStableKeyFor(el){
    if(el.dataset && el.dataset.imgKey) return el.dataset.imgKey;
    // 生成 DOM 路徑（避免重整後變動，盡量包含同層索引）
    const parts=[];
    let node=el;
    while(node && node.nodeType===1 && node.tagName.toLowerCase()!=='html'){
      const tag=node.tagName.toLowerCase();
      const parent=node.parentElement;
      let idx=0;
      if(parent){
        const siblings=[...parent.children].filter(c=>c.tagName===node.tagName);
        idx=siblings.indexOf(node);
      }
      parts.unshift(`${tag}:nth-of-type(${idx+1})`);
      node=parent;
    }
    return parts.join('>');
  }

  // 偵測元素是 <img> 還是容器背景
  function detectType(el){
    return el.tagName && el.tagName.toLowerCase()==='img' ? 'img' : 'bg';
  }

  // 套用狀態到元素
  function applyToElement(el, state){
    const type = detectType(el);
    if(type==='img'){
      if(state.src !== undefined) el.src = state.src; // 原樣字串
      // 其他調整可用 style 來套
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      // img 的 fit 可用 object-fit / object-position
      if(state.fit) el.style.objectFit = state.fit; // 'cover' | 'contain' | 'fill' | 'none' | 'scale-down'
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.objectPosition = `${ox}px ${oy}px`;
      }
    }else{
      // 背景容器
      if(state.src !== undefined) el.style.backgroundImage = state.src ? `url("${state.src}")` : 'none';
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      if(state.fit){
        // 對背景使用 background-size
        const map = { cover:'cover', contain:'contain', fill:'100% 100%', none:'auto', 'scale-down':'contain' };
        el.style.backgroundSize = map[state.fit] || state.fit;
      }
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.backgroundPosition = `${ox}px ${oy}px`;
      }
    }
  }

  function buildTransform(state){
    const ops=[];
    if(state.scale!=null && state.scale!==1) ops.push(`scale(${state.scale})`);
    if(state.rotateDeg!=null && state.rotateDeg!==0) ops.push(`rotate(${state.rotateDeg}deg)`);
    if(ops.length===0) return '';
    return ops.join(' ');
  }

  // 掃描頁面上所有可能的圖片元素
  function collectImageElements(){
    const all = new Set();
    // 1) 具有 data-img-key 的元素
    document.querySelectorAll('[data-img-key]').forEach(el=>all.add(el));
    // 2) 所有 <img>
    document.querySelectorAll('img').forEach(el=>all.add(el));
    // 3) 明確宣告為背景圖容器的元素（可選）
    document.querySelectorAll('[data-img-type="bg"]').forEach(el=>all.add(el));
    return [...all];
  }

  // 把元素註冊進狀態表（若已有就不覆蓋）
  function ensureStateForElement(el){
    const key = getStableKeyFor(el);
    if(!imageState.has(key)){
      imageState.set(key, {
        src: readCurrentSrc(el),
        type: detectType(el),
        fit: undefined, opacity: undefined, offsetX: 0, offsetY: 0,
        scale: 1, rotateDeg: 0
      });
    }
    return key;
  }

  function readCurrentSrc(el){
    if(detectType(el)==='img'){
      return el.getAttribute('src') || '';
    }else{
      // 從 style.backgroundImage 取 url(...)（若無則空）
      const bg = getComputedStyle(el).backgroundImage;
      if(!bg || bg==='none') return '';
      // 簡單抽取 url("...") 內容
      const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
      return m ? m[2] : '';
    }
  }

  // 對單一 key 設定路徑（原樣保存，不改字串）
  function setPath(key, rawPath){
    const state = imageState.get(key) || { };
    state.src = (rawPath==null ? '' : String(rawPath));
    imageState.set(key, state);
    // 把它套回對應元素
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  // 對單一 key 調整屬性（不影響 src）
  function setAdjust(key, patch){
    const state = imageState.get(key) || { };
    Object.assign(state, patch);
    imageState.set(key, state);
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  function findElementByKey(key){
    // 先找 data-img-key
    let el = document.querySelector(`[data-img-key="${CSS.escape(key)}"]`);
    if(el) return el;
    // 若不是 data-img-key，可能是自動產生的 DOM 路徑 key
    try{
      el = document.querySelector(key.split('>').map(seg=>{
        // seg 形如 "div:nth-of-type(1)"，直接用
        return seg.trim();
      }).join(' > '));
    }catch(e){}
    return el || null;
  }

  // 將目前 imageState 匯出為 JSON（字串）
  function exportImagesJSON(){
    // Map -> 純物件
    const obj = {};
    for(const [k,v] of imageState.entries()){
      obj[k] = {
        src: v.src ?? '',
        type: v.type ?? 'img',
        fit: v.fit ?? undefined,
        opacity: v.opacity ?? undefined,
        offsetX: v.offsetX ?? 0,
        offsetY: v.offsetY ?? 0,
        scale: v.scale ?? 1,
        rotateDeg: v.rotateDeg ?? 0
      };
    }
    return JSON.stringify({ __kind: 'images.v1', data: obj }, null, 2);
  }

  // 從 JSON（字串或物件）匯入，原樣還原並立即套用
  function importImagesJSON(json){
    const payload = (typeof json==='string') ? JSON.parse(json) : json;
    if(!payload || payload.__kind!=='images.v1' || !payload.data) return;
    for(const k of Object.keys(payload.data)){
      imageState.set(k, { ...payload.data[k] });
      const el = findElementByKey(k);
      if(el) applyToElement(el, imageState.get(k));
    }
  }

  // 綁定輸入框：任何 input/textarea 只要有 data-img-input="key" 就會貼上即套用
  function bindInputsLive(){
    document.querySelectorAll('[data-img-input]').forEach(inp=>{
      const keyAttr = inp.getAttribute('data-img-input');
      const elKey = keyAttr && keyAttr.trim() ? keyAttr.trim() : null;
      // 若沒填 key，嘗試用最近的 data-img-key 容器
      let key = elKey;
      if(!key){
        const host = inp.closest('[data-img-key]');
        if(host) key = getStableKeyFor(host);
      }
      if(!key) return;

      // 確保有狀態
      imageState.has(key) || imageState.set(key, {});

      // 初始化：如果 input 有值就先套
      if(inp.value && inp.value.trim()){
        setPath(key, inp.value.trim());
      }

      // 即時監聽（貼上/輸入/變更）
      ['input','change','paste'].forEach(ev=>{
        inp.addEventListener(ev, ()=>{
          setPath(key, inp.value);
        });
      });
    });
  }

  // 掛在全域，方便你呼叫
  window.ImageIO = {
    setPath, setAdjust, exportImagesJSON, importImagesJSON,
    refreshAll(){
      collectImageElements().forEach(el=>{
        const key = ensureStateForElement(el);
        applyToElement(el, imageState.get(key));
      });
    }
  };

  // 初次啟動：收集元素 → 建狀態 → 綁定輸入框 → 首次套用
  function boot(){
    const els = collectImageElements();
    els.forEach(el=>{
      const key = ensureStateForElement(el);
      // 初始套用（以 DOM 目前的 src / 背景為基準）
      applyToElement(el, imageState.get(key));
    });
    bindInputsLive();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', boot);
  }else{
    boot();
  }

  // —— 下面是「示範用」的匯出/匯入按鈕（可保留或整合到你現有 UI） —— //
  // 匯出：下載 .json（保留原字串路徑）
  function downloadJSON(filename, content){
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename || 'images.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 0);
  }

  // 你可以在任何事件中呼叫 window.ImageIO.exportImagesJSON()
  window.addEventListener('click', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-export]')){
      const json = exportImagesJSON();
      downloadJSON('images.json', json);
    }
  });

  // 匯入：讀檔後立即還原
  window.addEventListener('change', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-import]') && t.files && t.files[0]){
      const f = t.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        try{
          importImagesJSON(reader.result);
          alert('圖片路徑與調整已匯入並套用完成。');
        }catch(err){
          alert('匯入失敗：JSON 格式錯誤或內容不符。');
        }
        t.value = '';
      };
      reader.readAsText(f);
    }
  });
})();
</script>
<!-- [IMGIO JS END] -->

</body>

</html>