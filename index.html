<!doctype html>
<html lang="zh-Hant">
<head>
   
  <link rel="icon" href="/cailucky/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/cailucky/apple-touch-icon.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CxQé–‹çæ‰€ï½œå®˜æ–¹å¹³å°</title>
  <meta name="color-scheme" content="light dark">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#14b8a6', fg: '#0f766e', amber: '#f59e0b' }
          },
          boxShadow: {
            soft: '0 10px 25px -10px rgb(0 0 0 / 0.25)',
            elevate: '0 12px 30px -12px rgba(0,0,0,.35)'
          },
          borderRadius: { 'xl2': '1rem' },
          keyframes: {
            fadeIn: { '0%': {opacity:0, transform:'translateY(6px)'},
                      '100%': {opacity:1, transform:'translateY(0)'} },
            pulseSoft: { '0%,100%': {opacity:.75}, '50%': {opacity:1} }
          },
          animation: {
            fadeIn: 'fadeIn .35s ease-out both',
            pulseSoft: 'pulseSoft 2.4s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <!-- React 18 UMD + Babel for in-browser JSX -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- å…¨åŸŸæ¨£å¼ -->
  <style>

    /* ============================
       Global Game UX / Viewport Core
       - Safe-area governance
       - VisualViewport-based height
       - Consistent game stage sizing
       ============================ */
    :root{
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --sar: env(safe-area-inset-right);

      /* Visual viewport (iOS address bar aware) */
      --vvh: 100vh;
      --vvw: 100vw;

      /* Measured chrome (header / bottom nav) */
      --app-header-h: 0px;
      --app-bottom-nav-h: 0px;

      /* Optional in-game controls bar (e.g., Tetris buttons) */
      --game-controls-h: 0px;

      /* Default paddings */
      --game-shell-bottom-pad: 96px;
    }

    /* Prefer visualViewport height when available */
    .app-min-vvh{ min-height: var(--vvh, 100vh); }

    /* Prevent iOS overscroll bounce inside game-only surfaces */
    .game-gesture-surface{
      overscroll-behavior: contain;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Game stage uses usable viewport (minus header/nav/controls/safe-area) */
    .game-stage{
      height: calc(var(--vvh, 100vh) - var(--app-header-h, 0px) - var(--app-bottom-nav-h, 0px) - var(--game-controls-h, 0px) - var(--sat, 0px) - var(--sab, 0px));
      max-height: calc(var(--vvh, 100vh) - var(--app-header-h, 0px) - var(--app-bottom-nav-h, 0px) - var(--game-controls-h, 0px) - var(--sat, 0px) - var(--sab, 0px));
      overflow: hidden;
    }

    /* Allow scroll only where explicitly intended */
    .game-scroll{
      height: auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Touch behavior: only game area blocks page scroll */
    .game-touch-lock{
      touch-action: none;
    }
    /* æŸ”å’Œæ ¼é»èƒŒæ™¯ + æ¼¸å±¤åŸºåº•ï¼ˆä¿ç•™ï¼‰ */
    body {
      background-image:
        radial-gradient(at 20% 0%, rgba(20,184,166,.08), transparent 35%),
        radial-gradient(at 80% 10%, rgba(245,158,11,.08), transparent 35%),
        radial-gradient(at 50% 100%, rgba(15,118,110,.08), transparent 35%);
    }

    /* è¡Œå‹•ç«¯è§¸æ§ç›®æ¨™ï¼šæ›´ç©©å¥çš„ hit areaï¼ˆâ‰¥44pxï¼‰ */
    .tap-target { padding: 12px 14px; min-width: 44px; min-height: 44px; }

    /* è‡ªè¨‚æ²è»¸éš±è—ï¼ˆä¿ç•™ï¼‰ */
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}

    /* === èƒŒæ™¯åœ–ç‰‡ï¼ˆæ•´ç«™ï¼‰ ================================== */
    html, body { min-height: 100%; }
    body::before{
      content:"";
      position: fixed; inset: 0; z-index:-1;
      background-image:
        linear-gradient(var(--bg-tint, rgba(255,255,255,0.0)), var(--bg-tint, rgba(255,255,255,0.0))),
        var(--bg-img, none);
      background-size: var(--bg-size, cover);
      background-position: var(--bg-pos, center);
      background-repeat: no-repeat;
      filter: brightness(var(--bg-brightness,1)) blur(var(--bg-blur,0px));
      opacity: var(--bg-opacity,1);
      transition: filter .25s ease, opacity .25s ease, background .25s ease;
    }

    /* === æ¼¢å ¡é¸å–®èƒŒæ™¯ ======================= */
    .menu-pane{
      position: relative;
      overflow: hidden;
      background: var(--menu-fallback, rgba(255,255,255,.92));
      border-right: 1px solid rgba(15,23,42,.08);
    }
    .menu-pane::before{
      content:"";
      position: absolute; inset: 0; z-index: 0;
      background-image:
        linear-gradient(var(--menu-tint, rgba(255,255,255,0.0)), var(--menu-tint, rgba(255,255,255,0.0))),
        var(--menu-bg-img, none);
      background-size: var(--menu-bg-size, cover);
      background-position: var(--menu-bg-pos, center);
      background-repeat: no-repeat;
      filter: brightness(var(--menu-brightness,1)) blur(var(--menu-blur,0px));
      opacity: var(--menu-opacity,1);
    }
    .menu-pane > *{ position: relative; z-index:1; }

    /* === å…±ç”¨ï¼šå½ˆçª—å…§å®¹å®¹å™¨é˜²æŠ–å‹•ï¼ˆiOS/Safari å‹å¥½ï¼‰ === */
    .modal-scroll{
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    /* === Mobile tweaks (ä¸å½±éŸ¿æ¡Œæ©Ÿ) === */
  @media (max-width: 640px) {
  .toolbar-grid, .flex-wrap, .px-2 { gap: 8px; }
  .paginator-top { display: none; }     /* ä¸Šæ–¹åˆ†é å™¨åœ¨æ‰‹æ©Ÿéš±è—ï¼Œä¿ç•™ä¸‹æ–¹é‚£çµ„ */
  .min-h-\[44px\] { min-height: 44px !important; }
  .sheet-w { width: min(96vw, 560px) !important; }

  /* è®“è¡Œå‹•ç«¯æ•´é«”æŒ‰éˆ•æ›´å¥½é» */
  .tap-target { padding: 12px 16px; }

  /* â˜… ä¸‹æ–¹åˆ†é å™¨ï¼šé¿å…è¢« iOS åº•éƒ¨å·¥å…·åˆ—/å®‰å…¨å€åƒæ‰ */
  .paginator-bottom { padding-bottom: env(safe-area-inset-bottom); }
}

  
/* ============================
   Product-grade UI tokens + controls
   - unified typography, buttons, inputs, panels
   ============================ */
:root{
  --font-sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 18px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
  --shadow-md: 0 10px 26px rgba(0,0,0,.08);
  --panel-border: rgba(15, 23, 42, .10);
  --panel-border-dark: rgba(148, 163, 184, .18);
  --focus: rgba(20,184,166,.35);
  --btn-h: 40px;
  --btn-h-sm: 34px;
  --btn-pad: 0 14px;
  --text-1: #0f172a;
  --text-2: rgba(15,23,42,.70);
  --bg-0: rgba(255,255,255,.66);
  --bg-1: rgba(255,255,255,.86);
  --bg-2: rgba(255,255,255,.95);
  --accent: #14b8a6;
  --danger: #ef4444;
}
html, body{ font-family: var(--font-sans); }

/* Focus & selection */
:where(button, a, input, select, textarea):focus-visible{
  outline: 2px solid var(--focus);
  outline-offset: 2px;
  border-radius: var(--radius-sm);
}
::selection{ background: rgba(20,184,166,.20); }

/* Unified controls */
button{
  min-height: var(--btn-h);
  padding: var(--btn-pad);
  border-radius: var(--radius-md);
  border: 1px solid var(--panel-border);
  background: var(--bg-2);
  color: var(--text-1);
  box-shadow: var(--shadow-sm);
  transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
  touch-action: manipulation;
}
@media (hover:hover){ button:hover{ box-shadow: var(--shadow-md); } }
button:active{ transform: translateY(1px) scale(.995); }
button[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; }

select, input, textarea{
  min-height: var(--btn-h);
  padding: 0 12px;
  border-radius: var(--radius-md);
  border: 1px solid var(--panel-border);
  background: var(--bg-2);
  color: var(--text-1);
  box-shadow: var(--shadow-sm);
}

/* Panels/cards refinement */
.kjs-card, .card, .panel, .game-panel{
  border-radius: var(--radius-lg);
  border: 1px solid var(--panel-border);
  background: var(--bg-1);
  box-shadow: var(--shadow-sm);
}
.kjs-card:hover{ box-shadow: var(--shadow-md); }

/* Dark mode alignment (works with existing dark classes) */
@media (prefers-color-scheme: dark){
  :root{
    --text-1: rgba(248,250,252,.95);
    --text-2: rgba(248,250,252,.72);
    --bg-0: rgba(2,6,23,.55);
    --bg-1: rgba(2,6,23,.70);
    --bg-2: rgba(15,23,42,.85);
  }
  button, select, input, textarea{
    border-color: var(--panel-border-dark);
  }
}

/* Mobile comfort: keep game stage clean, reduce accidental scroll */
@media (max-width: 820px){
  .game-stage, .game-shell, .game-view{
    -webkit-tap-highlight-color: transparent;
  }
}


button{
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}
button.is-pressed{
  transform: translateY(1px) scale(.995);
}
/* Glass header for in-game HUD on busy backgrounds */
.game-head{
  padding: 10px 12px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--panel-border);
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
}
.dark .game-head{
  background: rgba(2,6,23,.55);
  border-color: var(--panel-border-dark);
}
.game-subtitle{
  font-size: 13px;
  line-height: 1.35;
 color: rgba(15,23,42,.78); font-size: 0.9rem; line-height: 1.25rem; }
.dark .game-subtitle{
  font-size: 13px;
  line-height: 1.35;
 color: rgba(226,232,240,.78); }
/* Tighter, clearer control row */
.game-controls{
  padding: 10px 12px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--panel-border);
  background: rgba(255,255,255,.70);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-sm);
}
.dark .game-controls{
  background: rgba(2,6,23,.50);
  border-color: var(--panel-border-dark);
}


/* =========================
   Immersive Mobile Game Mode
   - When a game is active, hide site chrome and maximize playfield
   ========================= */
html[data-kjs-game="1"] [data-app-header="1"],
html[data-kjs-game="1"] [data-app-bottomnav="1"]{
  display: none !important;
}
html[data-kjs-game="1"] body{
  overscroll-behavior: none;
}
/* Make in-game HUD stick and remain readable */
html[data-kjs-game="1"] .game-head{
  position: sticky;
  top: calc(var(--sat, env(safe-area-inset-top)) + 8px);
  z-index: 30;
  margin-top: 8px;
  background: rgba(255,255,255,.82);
  border-color: rgba(15,23,42,.18);
  box-shadow: 0 10px 24px rgba(2,6,23,.14);
}
html[data-kjs-game="1"] .game-subtitle{
  font-size: 13px;
  line-height: 1.35;

  color: rgba(2,6,23,.88);
  text-shadow: 0 1px 0 rgba(255,255,255,.35);
}
.dark html[data-kjs-game="1"] .game-head{
  background: rgba(2,6,23,.70);
  border-color: rgba(148,163,184,.18);
  box-shadow: 0 14px 28px rgba(0,0,0,.35);
}
.dark html[data-kjs-game="1"] .game-subtitle{
  font-size: 13px;
  line-height: 1.35;

  color: rgba(226,232,240,.92);
  text-shadow: 0 1px 0 rgba(0,0,0,.25);
}
/* Reduce bottom padding while immersive (bottom nav hidden) */
html[data-kjs-game="1"] [data-game-shell="1"]{
  padding-bottom: calc(20px + var(--sab, env(safe-area-inset-bottom))) !important;
}
html[data-kjs-game="1"] .game-gesture-surface{
  padding-bottom: calc(150px + var(--sab, env(safe-area-inset-bottom))) !important;
}

body.kjs-game-lock{
  user-select: none;
  -webkit-user-select: none;
}


/* ===== Mobile game mode: Tetris floating HUD (does not consume layout height) ===== */
.tetris-hud{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(env(safe-area-inset-bottom) + 12px);
  z-index: 60;
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 0 12px;
  pointer-events: none; /* only buttons receive events */
}
.tetris-hud .tetris-pad{
  pointer-events: auto;
  background: rgba(15, 23, 42, 0.78);
  border: 1px solid rgba(148, 163, 184, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 18px;
  padding: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}
.tetris-hud .tetris-pad-inner{
  display: flex;
  gap: 10px;
}
.tetris-hud .tetris-pad.right .tetris-pad-inner{
  gap: 10px;
}
.tetris-hud .tetris-hint{
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: calc(env(safe-area-inset-bottom) + 86px);
  z-index: 59;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.55);
  border: 1px solid rgba(148, 163, 184, 0.22);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-size: 11px;
  color: rgba(226, 232, 240, 0.92);
  pointer-events: none;
}

.tetris-hud{
  flex-wrap: wrap;
  align-items: flex-end;
}
.tetris-center{
  pointer-events: auto;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  padding: 10px 12px;
  border-radius: 18px;
  background: rgba(15, 23, 42, 0.78);
  border: 1px solid rgba(148, 163, 184, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.tetris-mini{
  appearance: none;
  -webkit-appearance: none;
  border: 1px solid rgba(148, 163, 184, 0.28);
  background: rgba(2, 6, 23, 0.15);
  color: rgba(226, 232, 240, 0.95);
  padding: 10px 12px;
  min-width: 64px;
  border-radius: 14px;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: .2px;
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
}
.tetris-mini.primary{
  background: rgba(99, 102, 241, 0.88);
  border-color: rgba(99, 102, 241, 0.22);
}
.tetris-mini:active{
  transform: translateY(1px);
}
@media (max-width: 380px){
  .tetris-mini{ padding: 9px 10px; min-width: 58px; font-size: 12px; }
  .tetris-center{ padding: 9px 10px; }
}

/* Keep HUD only on touch devices */
@media (hover:hover) and (pointer:fine){
  .tetris-hud, .tetris-hint{ display:none !important; }
}

</style>

  <!-- [IMGIO CSS START] -->
  <style>
    /* åŸºæœ¬ï¼šç•¶ä½œå®¹å™¨èª¿æ•´æ™‚æœƒç”¨åˆ°ï¼ˆèƒŒæ™¯åœ–ç­‰ï¼‰ */
    [data-img-key]{
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
    }

    /* === Dark mode å¢å¼·ï¼šä¸»é èƒŒæ™¯èˆ‡æ¼¢å ¡é¸å–®å°æ¯”/å¯è®€æ€§ === */
    @media (prefers-color-scheme: dark) {
      /* 1) èª¿æ•´å…¨ç«™ï¼ˆä¸»é ï¼‰æ¼¸å±¤èƒŒæ™¯åœ¨æ·±è‰²ä¸‹çš„è§€æ„Ÿï¼šæ›´æŸ”å’Œã€æ›´æœ‰å±¤æ¬¡ */
      body {
        background-image:
          radial-gradient(at 20% 0%, rgba(20,184,166,.12), transparent 35%),
          radial-gradient(at 80% 10%, rgba(245,158,11,.10), transparent 35%),
          radial-gradient(at 50% 100%, rgba(100,116,139,.18), transparent 38%); /* slate-500-ish */
      }

      /* 2) æå‡æ¼¢å ¡æŠ½å±œï¼ˆmenu-paneï¼‰å¯è®€æ€§ï¼šæ·±åº•ï¼‹äº®å­—ï¼‹æŸ”å’Œé‚Šç•Œ */
      :root {
        --menu-fallback: rgba(2, 6, 23, 0.92); /* slate-950 è¿‘ä¼¼å€¼ã€å¸¶ 92% ä¸é€æ˜ */
      }
      .menu-pane {
        background: var(--menu-fallback, rgba(2, 6, 23, 0.92)) !important;
        color: #e5e7eb; /* slate-200ï¼šæŠ½å±œå…§ä¸€èˆ¬æ–‡å­— */
        border-right-color: rgba(148, 163, 184, 0.25); /* slate-400-ish */
      }
      .menu-pane .border,
      .menu-pane .border-b,
      .menu-pane .border-t,
      .menu-pane .border-l,
      .menu-pane .border-r {
        border-color: rgba(148, 163, 184, 0.25) !important;
      }
      .menu-pane a,
      .menu-pane button,
      .menu-pane [role="button"] {
        color: inherit;
      }
      .menu-pane .hover\:bg-slate-100:hover,
      .menu-pane .active\:bg-slate-100:active {
        background-color: rgba(30, 41, 59, 0.6) !important; /* slate-800 60% */
      }
      .menu-pane .bg-white,
      .menu-pane .bg-white\/85,
      .menu-pane .bg-slate-50 {
        background-color: rgba(2, 6, 23, 0.92) !important;
        color: #e5e7eb !important;
      }
      .menu-pane .text-slate-500 { color: #cbd5e1 !important; } /* slate-300 è¿‘ä¼¼ */
    }

    :root{
      /* è‹¥ä½ çš„åº•éƒ¨å·¥å…·åˆ—é«˜åº¦ä¸åŒï¼Œé€™è£¡æ”¹æ•¸å€¼å³å¯ï¼ˆæ‰‹æ©Ÿå¸¸è¦‹ 56~64pxï¼‰ */
      --bottom-nav-height: 56px;
    }

    /* çµ¦æµ®å‹•æ¸…å–®æ¢å°ˆç”¨ï¼Œæœƒè‡ªå‹•é¿é–‹åº•éƒ¨å·¥å…·åˆ—èˆ‡å®‰å…¨å€ */
    .floating-pickbar {
      position: fixed;
      left: 0; right: 0;
      z-index: 40;
      padding-left: 0.75rem; padding-right: 0.75rem; /* = px-3 */
      bottom: calc(env(safe-area-inset-bottom) + var(--bottom-nav-height) + 12px);
    }

    /* æœ‰æµ®å‹•æ¢æ™‚ï¼Œé é¢åº•éƒ¨ç•™å‡ºç©ºé–“é¿å…è¢«æ“‹ä½ */
    .pickbar-spacer {
      height: calc(var(--bottom-nav-height) + 96px);
    }
  </style>
  <!-- [IMGIO CSS END] -->
</head>

<body class="bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">

// Global "pressed" state fix for mobile: prevents sticky active/hover visuals
(() => {
  const press = (el) => { if (el && el.tagName === 'BUTTON') el.classList.add('is-pressed'); };
  const releaseAll = () => { document.querySelectorAll('button.is-pressed').forEach(b=>b.classList.remove('is-pressed')); };
  document.addEventListener('pointerdown', (e)=>{
    const b = e.target && e.target.closest ? e.target.closest('button') : null;
    if (b) press(b);
  }, {passive:true});
  document.addEventListener('pointerup', releaseAll, {passive:true});
  document.addEventListener('pointercancel', releaseAll, {passive:true});
  document.addEventListener('blur', releaseAll);
})();

    const { useEffect, useState } = React;

    // â€”â€” LocalStorage Keys â€”â€”
    const LS = { data: 'kjs_site_data_v1', admin: 'kjs_admin_pass' };

    // === Default Settingsï¼ˆå¯è¢«ç®¡ç†é¢æ¿è¦†å¯«ï¼‰ ===
    const DEFAULT_SETTINGS = {
      drawMaxPerRun: 500,      // å–®æ¬¡æœ€å¤šæŠ½å‡ºäººæ•¸ä¸Šé™ï¼ˆåé¡ï¼‰
      drawPublicShowLimit: 50, // å…¬é–‹çµæœæœ€å¤šé¡¯ç¤ºå¹¾ä½
      drawCooldownSec: 10,     // åŒä¸€æ´»å‹•é‡è·‘å†·å»ç§’æ•¸
      contactUrl: "",          // â˜… å…¨åŸŸã€Œå®˜æ–¹LINEï¼è¯çµ¡ç®¡ç†å“¡ã€ç¶²å€ï¼ˆå¯ç•™ç©ºï¼‰
      lineGroupUrl: ""         // â˜… å…¨åŸŸã€ŒåŠ å…¥LINEç¾¤ã€ç¶²å€ï¼ˆå¯ç•™ç©ºï¼‰
    };

    // === History ç‹€æ…‹é¸å–® ===
    const HISTORY_STATUS_OPTIONS = [
      { value: "å·²å¯„å‡º",   label: "âœ… å·²å¯„å‡º" },
      { value: "è™•ç†ä¸­",   label: "â³ è™•ç†ä¸­" },
      { value: "æœªå›è¦†",   label: "ğŸ”´ æœªå›è¦†" },
      { value: "å†å¯„é€ä¸­", label: "ğŸ“¦ å†å¯„é€ä¸­" },
      { value: "å¾…å¯„é€",   label: "ğŸŸ¡ å¾…å¯„é€" },
      { value: "æ”¾æ£„é ˜ç", label: "ğŸš« æ”¾æ£„é ˜ç" },
    ];

    // é¡¯ç¤ºç”¨ï¼ˆæ­·å²åˆ—è¡¨ï¼‰
    const HISTORY_STATUS_ICON = {
      "å·²å¯„å‡º":"âœ…","è™•ç†ä¸­":"â³","æœªå›è¦†":"ğŸ”´","å†å¯„é€ä¸­":"ğŸ“¦","å¾…å¯„é€":"ğŸŸ¡","æ”¾æ£„é ˜ç":"ğŸš«"
    };

    // ========== ç‹€æ…‹æ¨™ç±¤æ¨£å¼ï¼ˆæŸ”å’Œã€ä¸åˆºçœ¼ï¼‰ ==========
    const HISTORY_STATUS_STYLE = {
      "å·²å¯„å‡º":   { bg: "bg-emerald-100/70 dark:bg-emerald-300/15", text: "text-emerald-700 dark:text-emerald-300", ring:"ring-emerald-500/20" },
      "è™•ç†ä¸­":   { bg: "bg-sky-100/70 dark:bg-sky-300/15",         text: "text-sky-700 dark:text-sky-300",         ring:"ring-sky-500/20" },
      "æœªå›è¦†":   { bg: "bg-rose-100/70 dark:bg-rose-300/15",       text: "text-rose-700 dark:text-rose-300",       ring:"ring-rose-500/20" },
      "å†å¯„é€ä¸­": { bg: "bg-indigo-100/70 dark:bg-indigo-300/15",   text: "text-indigo-700 dark:text-indigo-300",   ring:"ring-indigo-500/20" },
      "å¾…å¯„é€":   { bg: "bg-amber-100/70 dark:bg-amber-300/15",     text: "text-amber-800 dark:text-amber-300",     ring:"ring-amber-500/20" },
      "æ”¾æ£„é ˜ç": { bg: "bg-slate-200/70 dark:bg-slate-300/15",     text: "text-slate-700 dark:text-slate-300",     ring:"ring-slate-400/20" },
    };

    /* =========================================
     * å…¨åŸŸæ²å‹•é–ï¼šé¿å…å½ˆçª—/æª¢è¦–å™¨ç•°å¸¸é€ æˆæ•´ç«™å¡ä½
     * ========================================= */
    (function(){

  /* ============================
     Viewport / Safe-Area Manager
     - Uses visualViewport when available (iOS address bar aware)
     - Measures header + bottom nav heights
     - Exposes CSS vars: --vvh, --vvw, --app-header-h, --app-bottom-nav-h, --game-controls-h
     ============================ */
  const KJSViewport = (function(){
    const doc = document.documentElement;

    function px(n){ return (Number.isFinite(n) ? Math.max(0, n) : 0) + 'px'; }

    function measureHeights(){
      const header = document.querySelector('[data-app-header="1"]');
      const bottomNav = document.querySelector('[data-app-bottomnav="1"]');
      const gameControls = document.querySelector('[data-game-controls="1"]');

      const headerH = header ? header.getBoundingClientRect().height : 0;
      const bottomH = bottomNav ? bottomNav.getBoundingClientRect().height : 0;
      const controlsH = gameControls ? gameControls.getBoundingClientRect().height : 0;

      doc.style.setProperty('--app-header-h', px(headerH));
      doc.style.setProperty('--app-bottom-nav-h', px(bottomH));
      doc.style.setProperty('--game-controls-h', px(controlsH));
    }

    function update(){
      const vv = window.visualViewport;
      const h = vv && vv.height ? vv.height : window.innerHeight;
      const w = vv && vv.width ? vv.width : window.innerWidth;

      doc.style.setProperty('--vvh', px(h));
      doc.style.setProperty('--vvw', px(w));

      measureHeights();
    }

    let rafId = 0;
    function schedule(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(()=>{ rafId = 0; update(); });
    }

    function bind(){
      // Initial
      schedule();

      // Resize / orientation
      window.addEventListener('resize', schedule, { passive: true });
      window.addEventListener('orientationchange', schedule, { passive: true });

      // visualViewport (iOS Safari)
      if (window.visualViewport){
        window.visualViewport.addEventListener('resize', schedule, { passive: true });
        window.visualViewport.addEventListener('scroll', schedule, { passive: true });
      }

      // DOM mutations (route changes / bottom nav visibility)
      const mo = new MutationObserver(schedule);
      mo.observe(document.body, { childList: true, subtree: true, attributes: true });

      // Font loading can change measured heights
      if (document.fonts && document.fonts.ready){
        document.fonts.ready.then(schedule).catch(()=>{});
      }

      return ()=>{ mo.disconnect(); };
    }

    return { update: schedule, bind };
  })();

  KJSViewport.bind();

  /* ============================
     Page Visibility â†’ Game Pause Signal
     Dispatches: window 'kjs:visibility' with detail { hidden: boolean }
     ============================ */
  document.addEventListener('visibilitychange', ()=>{
    try{
      window.dispatchEvent(new CustomEvent('kjs:visibility', { detail: { hidden: document.hidden } }));
    }catch{}
  }, { passive: true });


      const lockKey = "__BODY_SCROLL_LOCK_COUNT__";
      if (!window[lockKey]) window[lockKey] = 0;
      function apply() {
        if (window[lockKey] > 0) {
          document.documentElement.style.overflow = "hidden";
          document.body.style.overflow = "hidden";
          document.body.style.touchAction = "none";
        } else {
          document.documentElement.style.overflow = "";
          document.body.style.overflow = "";
          document.body.style.touchAction = "";
        }
      }
      window.BodyScrollLock = {
        lock() { window[lockKey] = Math.max(0, (window[lockKey]||0)) + 1; apply(); },
        unlock() { window[lockKey] = Math.max(0, (window[lockKey]||0) - 1); apply(); },
        reset() { window[lockKey] = 0; apply(); }
      };
      // ä¿éšªæ©Ÿåˆ¶ï¼šé é¢éš±è—/é›¢é–‹æ™‚è‡ªå‹•é‚„åŸ
      window.addEventListener("pagehide", ()=>window.BodyScrollLock.reset());
      document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState !== "visible") window.BodyScrollLock.reset(); });
    })();



// === åˆ—é ­ï¼šæ—¥æœŸ / çå“åç¨±(æˆªæ–·) / ç‹€æ…‹ï¼ˆé å³ä¸æ›è¡Œï¼‰ ===
function HistoryHeaderRow({ rec }) {
  const date = formatDateYMD(rec?.date || "") || "â€”";
  const title = rec?.title || "ï¼ˆæœªå‘½åï¼‰";
  const status = rec?.status || "";

  return (
    <div className="grid grid-cols-[94px_1fr_auto] sm:grid-cols-[110px_1fr_auto] items-center gap-2 sm:gap-3 w-full">
      {/* æ—¥æœŸï¼šç­‰å¯¬å­—é«”ï¼Œå›ºå®šå¯¬åº¦ï¼ˆ14pxï¼‰ */}
      <span className="font-mono text-sm text-slate-500">{date}</span>

      {/* åç¨±ï¼šå–®è¡Œæˆªæ–·ï¼ˆæ‰‹æ©Ÿ 14px / æ¡Œæ©Ÿ 15pxï¼‰ */}
      <div className="flex items-center min-w-0">
        <span className="mr-2" aria-hidden="true">ğŸ</span>
        <span
          className="truncate max-w-[18ch] sm:max-w-[48ch] text-base sm:text-[15px]"
          title={title}
        >
          {title}
        </span>
      </div>

      {/* ç‹€æ…‹ï¼šå›ºå®šåœ¨å³å´ã€ä¸å¯ç¸®å° */}
      <div className="shrink-0">
        <StatusTag value={status} />
      </div>
    </div>
  );
}


/*** =========================
 * å…±ç”¨ï¼šæ¨™ç±¤å½™æ•´ã€æ¨™ç±¤å‹¾é¸æ¢ã€é¸è³¼æ¸…å–®ï¼ˆé›¢ç·šå‰ªè²¼ç°¿ï¼‰
 * ========================== */

// å¾ item é™£åˆ—è‡ªå‹•å½™æ•´å”¯ä¸€æ¨™ç±¤ï¼ˆè·³éç©ºå­—ä¸²ï¼‰
function collectUniqueTags(items, tagField='tags') {
  const set = new Set();
  for (const it of (items||[])) {
    const tags = Array.isArray(it?.[tagField]) ? it[tagField] :
                 typeof it?.[tagField] === 'string' ? it[tagField].split(',') : [];
    for (const t of tags) {
      const v = String(t||'').trim();
      if (v) set.add(v);
    }
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
}

// HOOKï¼šå¤šé¸æ¨™ç±¤ï¼ˆå¢ï¼šsetPicked ä»¥æ”¯æ´å½ˆçª—ä¸€æ¬¡å¥—ç”¨ï¼‰
function useTagFilter(allTags = []) {
  const [picked, setPicked] = React.useState([]);
  const toggle = (t) =>
    setPicked((list) => (list.includes(t) ? list.filter((x) => x !== t) : [...list, t]));
  const clear = () => setPicked([]);
  return { picked, toggle, clear, setPicked, allTags };
}

// ä¾ tagGroups çš„ç¾¤çµ„é †åº + ç¾¤å…§é †åºä¾†ç”¢ç”Ÿæ‰å¹³çš„æ¨™ç±¤æ¸…å–®ï¼ˆå¯ç›´æ¥è¦†è“‹ï¼‰
function orderTagsByGroups(allTags = [], groups = []) {
  const seen = new Set();
  const out = [];

  // 1) å…ˆä¾ç¾¤çµ„å®šç¾©çš„é †åºï¼Œå°‡ç¾¤çµ„ä¸­çš„æ¨™ç±¤ä¾åºæ¨å…¥
  (Array.isArray(groups) ? groups : []).forEach((g) => {
    const tags = Array.isArray(g?.tags) ? g.tags : [];
    tags.forEach((t) => {
      const tag = String(t || '').trim();
      if (!tag) return;
      if (allTags.includes(tag) && !seen.has(tag)) {
        seen.add(tag);
        out.push(tag);
      }
    });
  });

  // 2) å†æŠŠæœªåˆ†çµ„ / æœªæ¶µè“‹çš„æ¨™ç±¤è£œä¸Šï¼ˆç¶­æŒ allTags åŸæœ¬æ’åºï¼‰
  (Array.isArray(allTags) ? allTags : []).forEach((t) => {
    const tag = String(t || '').trim();
    if (!tag) return;
    if (!seen.has(tag)) out.push(tag);
  });

  return out;
}

// å…ƒä»¶ï¼šæ¨™ç±¤ Chipsï¼ˆå¯å¤šé¸ï¼‰
function TagChips({ tags = [], picked = [], onToggle, onClear }) {
  if (!tags.length) return (
    <div className="text-xs text-slate-500">ç›®å‰æ²’æœ‰æ¨™ç±¤</div>
  );
  return (
    <div className="flex items-center gap-2.5 overflow-x-auto no-scrollbar py-1.5">
      {tags.map(t => {
        const active = picked.includes(t);
        return (
          <button
            key={t}
            onClick={() => onToggle(t)}
            className={
              "tap-target rounded-full border px-3.5 py-1.5 text-sm whitespace-nowrap min-h-[44px] " +
              (active ? "bg-brand text-white border-brand" : "bg-white/70 dark:bg-slate-900/60")
            }
            title={active ? "å–æ¶ˆæ­¤æ¨™ç±¤" : "é¸å–æ­¤æ¨™ç±¤"}
          >
            {t}
          </button>
        );
      })}
      {picked.length > 0 && (
        <button
          onClick={onClear}
          className="tap-target rounded-full border px-3.5 py-1.5 text-sm whitespace-nowrap min-h-[44px]"
        >
          æ¸…é™¤æ¨™ç±¤
        </button>
      )}
    </div>
  );
}

function ProductSheet({
  open = false,
  item = null,
  context = "store",
  onClose = () => {},
  onOpenViewer = () => {},
  contactUrl = "",
  onCopyTemplate = () => {},     // ä»ä¿ç•™åƒæ•¸ç›¸å®¹ï¼Œä¸åœ¨ shop é¡¯ç¤º
  onStartDraw = () => {},        // for pendingï¼šé–‹å±•ç¤ºå‹•ç•«
  admin = false,                 // for pendingï¼šæ˜¯å¦é¡¯ç¤ºç®¡ç†å€å¡Š
  // onAdminï¼šfor pending
  // - onEdit                (æ—¢æœ‰ï¼šèˆŠç‰ˆå¯èƒ½æ‹¿ä¾†é–‹ç·¨è¼¯å™¨ï¼Œä¸ä¿è­‰è½ç›¤)
  // - onDelete              (æ—¢æœ‰)
  // - onConvertBySim        (æ—¢æœ‰)
  // - onConvertByChecked    (æ—¢æœ‰)
  // - onConvertByInput      (æ—¢æœ‰)
  // - onCopyAd              (æ—¢æœ‰)
  // - checkedMap, toggleCheck (æ—¢æœ‰)
  // â˜…æ–°å¢ï¼šonUpdateParticipants(payload)
  //   payload: { id, item, lines, text }
  //   çˆ¶å±¤è«‹ç”¨å®ƒæŠŠ listText èˆ‡ participants ä¸€èµ·å¯«å›ã€æŒä¹…åŒ–ã€ä¸¦è§¸ç™¼é‡æ¸²æŸ“
  onAdmin = {}
}) {
  const React = window.React || globalThis.React;

  const overlayRef = React.useRef(null);
  const [index, setIndex] = React.useState(0);

  // === é‡è¤‡æª¢æŸ¥ï¼ˆåªä¿®ç©ºç™½ï¼‰ç›¸é—œçš„æœ¬åœ°ç‹€æ…‹ ===
  const [dupOpen, setDupOpen] = React.useState(false);           // æ˜¯å¦é¡¯ç¤ºæª¢æŸ¥å½ˆçª—
  const [dupGroups, setDupGroups] = React.useState([]);          // æª¢æŸ¥å¾—åˆ°çš„ç¾¤çµ„
  const [dupMeta, setDupMeta] = React.useState({ groups: 0, dups: 0 }); // çµ±è¨ˆï¼šçµ„æ•¸ï¼é‡è¤‡ç­†æ•¸
  const [lastActionMsg, setLastActionMsg] = React.useState("");  // å¥—ç”¨å¾Œçš„å°æç¤ºï¼ˆä¾‹å¦‚ï¼šå·²ç§»é™¤ X ç­†é‡è¤‡ï¼‰

  // === æœ¬åœ°è¦†å¯«ï¼šç‚ºäº†ã€Œå¥—ç”¨åˆªé™¤ã€å¾Œå°å¡ç«‹å³æ›´æ–°ï¼ˆå³ä½¿çˆ¶å±¤é‚„æ²’å›å¯«ï¼‰ ===
  // è‹¥ç‚º null è¡¨ç¤ºæ²¿ç”¨ props.item çš„åŸå§‹è³‡æ–™ï¼›ä¸€æ—¦ä½¿ç”¨è€…åœ¨å°å¡ã€Œå¥—ç”¨åˆªé™¤ã€ï¼Œå°±æ”¹ç”±é€™ä»½æœ¬åœ°æ–‡å­—é©…å‹•ç•«é¢ã€‚
  const [localListText, setLocalListText] = React.useState(null);

  // è¦æ ¼é¸æ“‡
  const [sel1, setSel1] = React.useState(null);
  const [sel2, setSel2] = React.useState(null);

  // é–æ²å‹• / ESC / è¿”å›éµ
  React.useEffect(() => {
    if (!open) return;
    BodyScrollLock.lock();
    const onKey = (e) => { if (e.key === "Escape") onClose(); };
    const onPop = () => onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    try { history.pushState({ sheet: true }, "", location.href); } catch {}
    return () => {
      document.removeEventListener("keydown", onKey);
      window.removeEventListener("popstate", onPop);
      BodyScrollLock.unlock();
    };
  }, [open, onClose]);

  // æ›å•†å“æ™‚é‡ç½®
  React.useEffect(() => {
    setIndex(0);
    setSel1(null);
    setSel2(null);
    setLastActionMsg("");
    setLocalListText(null); // æ› item å°±å›åˆ°ä»¥ props ç‚ºæº–
  }, [item]);

  // ---- æ´¾ç”Ÿè³‡æ–™ ----
  const title  = (item?.title || item?.name || "ï¼ˆæœªå‘½åï¼‰");
  const baseId = String(item?.id ?? (item?.name ?? "item"));

  const images = (() => {
    const arr = Array.isArray(item?.images) ? item.images : (item?.image ? [String(item.image)] : []);
    return (arr || []).filter(Boolean);
  })();
  const tags = (() => {
    if (Array.isArray(item?.tags)) return item.tags;
    if (typeof item?.tags === "string") return item.tags.split(",").map(s => s.trim()).filter(Boolean);
    return [];
  })();
  const buyUrl = item?.buyUrl || item?.url || "";
  const price  = (item?.price ?? "") !== "" ? item?.price : null;
  const needPoints = (() => {
    const p = item?.points ?? item?.point ?? item?.needPoints ?? item?.need_point;
    const n = (typeof p === "string" ? +p : p);
    return Number.isFinite(n) ? n : null;
  })();
  const remain = item?.stock ?? item?.qty ?? item?.quantity ?? item?.remaining ?? null;

  // pendingï¼šå€™é¸åå–®ï¼ˆåŸæ¨£åˆ†è¡Œï¼Œç”¨æ–¼é¡¯ç¤ºï¼›ä¸åœ¨æ­¤æ­¥é©Ÿè‡ªå‹•å»é‡ï¼‰
  const splitLinesRaw = (txt) => {
    if (typeof txt !== "string") return [];
    return txt.split(/\r?\n/); // ä¿ç•™åŸæ¨£ï¼ˆåŒ…å«ç©ºç™½ï¼‰ï¼Œè®“æª¢æŸ¥æµç¨‹èƒ½å°ä¸Šç´¢å¼•
  };

  // ä¾†æº listTextï¼šè‹¥æœ‰æœ¬åœ°è¦†å¯«å°±ç”¨è¦†å¯«ï¼Œå¦å‰‡ç”¨ props.item
  const sourceListText = (
    localListText != null
      ? localListText
      : (typeof item?.listText === "string" ? item.listText : null)
  );

  // rawLinesï¼šå„ªå…ˆä¾†è‡ª sourceListTextï¼›è‹¥æ²’æœ‰ï¼Œå†å¾é™£åˆ—æ¬„ä½è½‰
  const rawLines = React.useMemo(() => {
    if (typeof sourceListText === "string") return splitLinesRaw(sourceListText);
    const list = Array.isArray(item?.participants) ? item.participants
      : Array.isArray(item?.members) ? item.members
      : Array.isArray(item?.list) ? item.list
      : Array.isArray(item?.candidates) ? item.candidates
      : [];
    return (list || []).map(v => String(v ?? ""));
  }, [sourceListText, item]);

  const candidates = (() => {
    // é¡¯ç¤ºç”¨ï¼šéæ¿¾æ‰å®Œå…¨ç©ºç™½çš„è¡Œï¼ˆä½†æª¢æŸ¥åŠŸèƒ½æœƒç”¨ rawLines åšåˆ¤å®šï¼‰
    return rawLines
      .map(s => String(s ?? ""))
      .map(s => s.trim())
      .filter(Boolean);
  })();
  const candidateCount = candidates.length;

  // è§¸æ§æ›åœ–ï¼ˆé–€æª» 80 -> 40ï¼Œæ›´å¥½æ»‘ï¼‰
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchEnd   = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy) && images.length > 1) {
      setIndex(i => (dx > 0 ? (i - 1 + images.length) : (i + 1)) % images.length);
    }
  };

  const gotoPrev = () => setIndex(i => (i - 1 + images.length) % images.length);
  const gotoNext = () => setIndex(i => (i + 1) % images.length);

  // è¯çµ¡é€£çµ
  const effectiveContactUrl =
    contactUrl ||
    item?.contactUrl ||
    window.__CONTACT_URL__ || "";

  // ---------- è¦æ ¼å·¥å…· ----------
  const normalizeVariants = (it) => {
    const v = it?.variants;
    if (!v || !v.mode || v.mode === "none") return { mode: "none", attrs: [], items: [] };
    const mode  = (v.mode === "double" ? "double" : "single");
    const attrs = Array.isArray(v.attrs)
      ? v.attrs.slice(0, mode === "double" ? 2 : 1).map(a => ({
          name: a?.name || "",
          values: Array.isArray(a?.values) ? a.values.filter(Boolean) : []
        }))
      : [];
    const items = Array.isArray(v.items)
      ? v.items.map(s => ({
          key: String(s?.key || ""),
          stock: (s?.stock ?? s?.qty ?? s?.quantity ?? s?.remaining ?? ""),
          price: (s?.price ?? ""),
          points: (s?.points ?? s?.needPoints ?? ""),
          image: s?.image || "",
          enabled: (s?.enabled !== false)
        }))
      : [];
    return { mode, attrs, items };
  };
  const V = normalizeVariants(item);

  const buildKey = (a, b) => (V.mode === "double" ? `${a||""}|${b||""}` : `${a||""}`);
  const skuMap = (() => {
    const m = new Map();
    for (const s of (V.items || [])) m.set(String(s.key || ""), s);
    return m;
  })();
  const selectedDone = (V.mode === "none")
    || (V.mode === "single" && !!sel1)
    || (V.mode === "double" && !!sel1 && !!sel2);
  const selectedKey = selectedDone ? buildKey(sel1, sel2) : "";
  const selSku      = selectedDone ? (skuMap.get(selectedKey) || null) : null;

  const num = (v) => { if (v === "" || v == null) return null; const n = +v; return Number.isFinite(n) ? n : null; };
  const effStock = (() => {
    if (selSku && selSku.enabled !== false && num(selSku.stock) != null) return num(selSku.stock);
    return num(remain);
  })();
  const effPriceOrPts = (() => {
    if (context === "store") {
      if (selSku && selSku.enabled !== false && num(selSku.price) != null)  return num(selSku.price);
      return num(price);
    } else if (context === "shop") {
      if (selSku && selSku.enabled !== false && num(selSku.points) != null) return num(selSku.points);
      return num(needPoints);
    }
    return null;
  })();
  const specSuffix = (() => {
    const parts = V.mode === "none" ? [] : (V.mode === "single" ? [sel1].filter(Boolean) : [sel1, sel2].filter(Boolean));
    return parts.length ? `ï¼ˆ${parts.join("ï¼")}ï¼‰` : "";
  })();

  // å»£æ’­è¦æ ¼è®Šæ›´ï¼ˆèˆ‡å¤–éƒ¨æ§åˆ¶åˆ—æ©‹æ¥ï¼‰
  const publishPick = (s1, s2) => {
    const key = String(item?.id ?? item?._id ?? item?.name ?? "item");
    window.__VARIANT_PICKED__ = window.__VARIANT_PICKED__ || {};
    window.__VARIANT_PICKED__[key] = { sel1: s1 || "", sel2: s2 || "" };
    try {
      window.dispatchEvent(new CustomEvent("kjs:variant:picked", {
        detail: { id: key, sel1: s1 || "", sel2: s2 || "" }
      }));
    } catch {}
  };
  React.useEffect(() => {
    if (!open) return;
    publishPick(null, null);
  }, [open, item?.id]);

  // å‚³çµ¦æ­¥é€²å™¨çš„æ´¾ç”Ÿ itemï¼ˆå«æ‰€é¸è¦æ ¼ï¼›ç„¡è¦æ ¼ç›´æ¥æ²¿ç”¨ï¼‰
  const controlsItem = (() => {
    if (context !== "store" && context !== "shop") return item;
    if (V.mode === "none") return { ...item, __baseId: baseId };
    if (!selectedDone) return null;

    const composedId   = `${baseId}::${selectedKey}`;
    const composedName = `${title}${specSuffix}`;
    const merged = { ...item };
    merged.id = composedId;
    merged.name = merged.title = composedName;
    merged.__baseId = baseId;
    if (context === "store") {
      if (effPriceOrPts != null)  merged.price  = effPriceOrPts;
    } else {
      if (effPriceOrPts != null)  merged.points = effPriceOrPts;
    }
    if (effStock != null) {
      merged.stock = merged.remaining = merged.qty = effStock;
    }
    merged._variant = { mode: V.mode, key: selectedKey, sel1, sel2, attrs: V.attrs };
    return merged;
  })();

  // ======ã€Œåªä¿®ç©ºç™½ã€æ¨™æº–åŒ–ï¼šä¸å‹•å¤§å°å¯«ã€ä¸å‹• @ï¼Œé€£çºŒç©ºç™½æŠ˜æˆ 1 å€‹ ======
  const normalizeNameSafe = (str) => {
    if (typeof str !== "string") return "";
    // å»é™¤å‰å¾Œç©ºç™½ï¼ˆå«å…¨å½¢ï¼‰
    let s = str.replace(/^[\s\u3000]+|[\s\u3000]+$/g, "");
    // é€£çºŒç©ºç™½ï¼ˆå«å…¨å½¢ç©ºæ ¼ï¼‰æŠ˜ç–Šæˆ 1 å€‹åŠå½¢ç©ºæ ¼
    s = s.replace(/[\s\u3000]+/g, " ");
    return s;
  };

  // ====== ä»¥ã€Œåªä¿®ç©ºç™½ã€ç‚ºå£å¾‘åˆ†çµ„ï¼Œä¸¦æä¾›ç´¢å¼•ï¼Œæ–¹ä¾¿ç²¾æº–åˆªé™¤ ======
  const groupDuplicatesSafe = (lines) => {
    // linesï¼šrawLinesï¼ˆä¿ç•™åŸæ¨£ï¼‰ï¼Œæˆ‘å€‘ç”¨ index ä¾†åˆªé™¤ï¼Œé¿å…åŒå­—ä¸²é›£åˆ†
    const map = new Map(); // key -> { firstIndex, firstText, others: Array<{index, text}> }
    for (let i = 0; i < lines.length; i++) {
      const raw = String(lines[i] ?? "");
      const key = normalizeNameSafe(raw);
      if (!key) continue; // å¿½ç•¥ç©ºç™½è¡Œ
      if (!map.has(key)) {
        map.set(key, { key, firstIndex: i, firstText: raw, others: [] });
      } else {
        map.get(key).others.push({ index: i, text: raw });
      }
    }
    const groups = [];
    let dupCount = 0;
    for (const g of map.values()) {
      if (g.others.length > 0) {
        groups.push(g);
        dupCount += g.others.length;
      }
    }
    // ä¾ç¬¬ä¸€å€‹å‡ºç¾çš„é †åºæ’åºï¼Œå‘ˆç¾æ›´ç›´è¦º
    groups.sort((a,b) => a.firstIndex - b.firstIndex);
    return { groups, dupCount };
  };

  // ====== é‡è¤‡æª¢æŸ¥å½ˆçª—ï¼ˆç™½è©± UIï¼‰ ======
  const DuplicateCheckDialog = ({ open, groups, onCancel, onApply }) => {
    const [checks, setChecks] = React.useState(() => {
      // é è¨­ï¼šæ¯çµ„çš„ others éƒ½å»ºè­°åˆªé™¤ï¼ˆtrueï¼‰
      const init = new Map();
      groups.forEach((g) => {
        const m = new Map();
        g.others.forEach(o => m.set(o.index, true));
        init.set(g.key, m);
      });
      return init;
    });

    const toggleOne = (gkey, idx, val) => {
      setChecks(prev => {
        const next = new Map(prev);
        const m = new Map(next.get(gkey));
        m.set(idx, val);
        next.set(gkey, m);
        return next;
      });
    };

    const checkAllOthers = (gkey, v) => {
      setChecks(prev => {
        const next = new Map(prev);
        const m = new Map(next.get(gkey));
        for (const k of m.keys()) m.set(k, v);
        next.set(gkey, m);
        return next;
      });
    };

    if (!open) return null;
    return (
      <div className="fixed inset-0 z-[1000] bg-black/50 flex items-center justify-center p-4">
        <div className="w-[min(92vw,44rem)] max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 shadow-elevate flex flex-col">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="min-w-0">
              <div className="font-semibold truncate">é‡è¤‡æª¢æŸ¥ï¼ˆåªä¿®ç©ºç™½ãƒ»æœ€å®‰å…¨ï¼‰</div>
              <div className="text-xs text-slate-500 mt-0.5">
                åªè™•ç†å‰å¾Œç©ºç™½èˆ‡é€£çºŒç©ºç™½ï¼›ä¸å‹•å¤§å°å¯«ã€ä¸å‹• @ã€‚è«‹å‹¾é¸è¦åˆªé™¤çš„é …ç›®ã€‚
              </div>
            </div>
            <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onCancel}>é—œé–‰</button>
          </div>

          <div className="px-4 py-2 text-sm text-slate-600">
            æ‰¾åˆ° <b>{groups.length}</b> çµ„ç–‘ä¼¼é‡è¤‡ï¼Œå…± <b>{
              groups.reduce((acc,g)=>acc+g.others.length,0)
            }</b> ç­†å¯èƒ½é‡è¤‡ã€‚
          </div>

          <div className="flex-1 overflow-auto px-4 pb-4">
            {groups.length === 0 ? (
              <div className="text-sm text-slate-500 py-8 text-center">æœªç™¼ç¾é‡è¤‡ï¼ˆåªä¿®ç©ºç™½ï¼‰</div>
            ) : (
              <ul className="space-y-3">
                {groups.map((g, i) => {
                  const m = checks.get(g.key);
                  const allChecked = m && Array.from(m.values()).every(Boolean);
                  const anyChecked = m && Array.from(m.values()).some(Boolean);
                  return (
                    <li key={g.key} className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                      <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center justify-between">
                        <div className="text-sm">
                          ç¬¬ {i+1} çµ„ã€€<span className="text-slate-500">ï¼ˆæ­£æœ¬ + {g.others.length} ç­†é‡è¤‡ï¼‰</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            type="button"
                            className="text-xs rounded border px-2 py-1"
                            title="åªç•™ç¬¬ä¸€ç­†ï¼ˆå‹¾é¸å…¶é¤˜ï¼‰"
                            onClick={()=>checkAllOthers(g.key, true)}
                          >åªç•™ç¬¬ä¸€ç­†</button>
                          <button
                            type="button"
                            className="text-xs rounded border px-2 py-1"
                            title="å…¨éƒ¨ä¿ç•™ï¼ˆæ¸…é™¤å‹¾é¸ï¼‰"
                            onClick={()=>checkAllOthers(g.key, false)}
                          >å…¨éƒ¨ä¿ç•™</button>
                          <span className={"text-xs px-2 py-1 rounded " + (anyChecked ? "bg-rose-50 text-rose-600 border border-rose-200" : "text-slate-400 border border-slate-200")}>
                            {anyChecked ? "å°‡åˆªé™¤éƒ¨åˆ†" : "ä¸åˆªé™¤"}
                          </span>
                        </div>
                      </div>
                      <div className="p-3 text-sm">
                        <div className="mb-2">
                          <span className="inline-block min-w-[4em] text-slate-500">æ­£æœ¬</span>
                          <span className="font-medium break-all">{normalizeNameSafe(g.firstText) || g.firstText}</span>
                          <span className="ml-2 text-xs text-slate-400">(åŸæ¨£ï¼š<span className="break-all">{g.firstText || "ï¼ˆç©ºè¡Œï¼‰"}</span>)</span>
                        </div>
                        {g.others.length > 0 && (
                          <ul className="space-y-1">
                            {g.others.map(o => {
                              const checked = m ? !!m.get(o.index) : true;
                              return (
                                <li key={o.index} className="flex items-start gap-2">
                                  <input
                                    type="checkbox"
                                    className="mt-0.5 h-4 w-4"
                                    checked={checked}
                                    onChange={(e)=>toggleOne(g.key, o.index, e.target.checked)}
                                  />
                                  <div className="flex-1">
                                    <div className="break-all">{normalizeNameSafe(o.text) || o.text}</div>
                                    <div className="text-xs text-slate-400">åŸæ¨£ï¼š{o.text || "ï¼ˆç©ºè¡Œï¼‰"}</div>
                                  </div>
                                </li>
                              );
                            })}
                          </ul>
                        )}
                      </div>
                    </li>
                  );
                })}
              </ul>
            )}
          </div>

          <div className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center justify-between">
            <div className="text-xs text-slate-500">å¥—ç”¨å¾Œæœƒå›å¯«åå–®ï¼Œä»å¯å†ç·¨è¼¯æˆ–å†æ¬¡æª¢æŸ¥ã€‚</div>
            <div className="flex items-center gap-2">
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onCancel}>å–æ¶ˆ</button>
              <button
                className="rounded-lg bg-brand text-white px-4 py-2 text-sm"
                onClick={()=>{
                  // å½™æ•´è¦åˆªé™¤çš„ index
                  const toDelete = new Set();
                  for (const g of groups) {
                    const m = checks.get(g.key);
                    if (!m) continue;
                    for (const [idx, v] of m.entries()) {
                      if (v) toDelete.add(idx);
                    }
                  }
                  onApply(toDelete);
                }}
              >å¥—ç”¨åˆªé™¤</button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  if (!open) return null;
  const handleOverlayClick = (e) => { if (e.target === overlayRef.current) onClose(); };

  // è§¸ç™¼æª¢æŸ¥é‡è¤‡ï¼ˆåªä¿®ç©ºç™½ï¼‰
  const openDuplicateCheck = () => {
    const { groups, dupCount } = groupDuplicatesSafe(rawLines);
    if (groups.length === 0) {
      alert("æœªç™¼ç¾é‡è¤‡ï¼ˆåªä¿®ç©ºç™½ï¼‰ã€‚");
      return;
    }
    setDupGroups(groups);
    setDupMeta({ groups: groups.length, dups: dupCount });
    setDupOpen(true);
  };

  // å¥—ç”¨åˆªé™¤å›å¯«ï¼ˆâ˜…å·²ä¿®æ­£ï¼šæœ¬åœ°ç«‹å³æ›´æ–° + å°å¤–å›å¯«/äº‹ä»¶ï¼‰
  const applyDuplicateDeletion = (toDeleteSet) => {
    setDupOpen(false);

    // 1) è¨ˆç®—åˆªé™¤å¾Œçš„æ–°è¡Œåˆ—
    const nextLines = rawLines.filter((_, idx) => !toDeleteSet.has(idx));
    const nextText  = nextLines.join("\n");

    // 2) å°å¡æœ¬åœ°ç«‹åˆ»åæ˜ ï¼ˆä¸ç­‰çˆ¶å±¤ï¼‰ï¼šè®“ç•«é¢çš„äººæ•¸èˆ‡åˆ—è¡¨å³æ™‚è®Šå°‘
    setLocalListText(nextText);

    // 3) æº–å‚™å°å¤–å›å¯« payloadï¼ˆçˆ¶å±¤å¯æŒä¹…åŒ–ï¼‰
    const payload = {
      id: (item?.id ?? baseId),
      item,
      lines: nextLines,
      text: nextText
    };

    // 3a) å„ªå…ˆï¼šçˆ¶å±¤æ˜ç¢ºæä¾›çš„å›å¯«æ¥å£
    if (typeof onAdmin?.onUpdateParticipants === "function") {
      try { onAdmin.onUpdateParticipants(payload); } catch (e) { /* ignore */ }
    }

    // 3b) äº‹ä»¶åˆ¶ï¼šçˆ¶å±¤è‹¥æœ‰ç›£è½ä¹Ÿèƒ½æ”¶åˆ°
    try {
      window.dispatchEvent(new CustomEvent("kjs:pending:updateParticipants", { detail: payload }));
    } catch {}

    // 3c) å…¼å®¹ï¼šè‹¥åªæœ‰ onEditï¼ˆèˆŠæµç¨‹ï¼‰ï¼Œç›¡åŠ›æŠŠæ–° list å¯«é€²å»äº¤çµ¦å®ƒ
    if (typeof onAdmin?.onEdit === "function") {
      const nextItem = {
        ...item,
        listText: nextText,
        participants: nextLines.map(s => String(s).trim()).filter(Boolean)
      };
      try { onAdmin.onEdit(nextItem); } catch {}
    } else if (!onAdmin?.onUpdateParticipants) {
      // 3d) æœ€å¾Œç„¡å¥ˆï¼šç›´æ¥æ”¹ props åƒè€ƒï¼ˆä¸ä¿è­‰æŒä¹…åŒ–ï¼Œä½†è‡³å°‘è³‡æ–™åœ¨çˆ¶å±¤ä¸æ¥æ™‚ä¹Ÿèƒ½æš«æ™‚ä¿ç•™ï¼‰
      try {
        item.listText = nextText;
        item.participants = nextLines.map(s => String(s).trim()).filter(Boolean);
      } catch {}
    }

    // 4) æˆåŠŸæç¤ºï¼ˆUIï¼‰
    const removed = toDeleteSet.size;
    setLastActionMsg(removed > 0 ? `âœ… å·²ç§»é™¤ ${removed} ç­†é‡è¤‡ï¼ˆåªä¿®ç©ºç™½ï¼‰` : "æœªç§»é™¤ä»»ä½•é …ç›®");
    setTimeout(()=>setLastActionMsg(""), 4000);
  };

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center"
      role="dialog"
      aria-modal="true"
      onMouseDown={handleOverlayClick}
    >
      <div className="w-[min(96vw,44rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        {/* header */}
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div className="min-w-0">
            <div className="font-semibold truncate">{title}{specSuffix}</div>
            {context==="store"   && price!=null      && <div className="text-sm text-slate-500">å”®åƒ¹ï¼š{price}</div>}
            {context==="shop"    && needPoints!=null && <div className="text-sm text-slate-500">éœ€æ±‚é»æ•¸ï¼š{needPoints}</div>}
            {context==="pending" && (
              <div className="text-sm text-slate-500 flex items-center gap-2">
                <span>å€™é¸äººæ•¸ï¼š{candidateCount}</span>
                {lastActionMsg && <span className="text-emerald-600 text-xs">ï¼ˆ{lastActionMsg}ï¼‰</span>}
              </div>
            )}
          </div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
        </div>

        {/* bodyï¼šæ”¹ç”¨å…±ç”¨ .modal-scroll class */}
        <div className="flex-1 overflow-y-auto modal-scroll">

          {/* ä¸»åœ– */}
          <div className="relative bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
            <div
              className="aspect-square w-full grid place-content-center select-none"
              onTouchStart={onTouchStart}
              onTouchEnd={onTouchEnd}
            >
              {images.length ? (
                <img src={images[index]} alt="" className="w-full h-full object-contain select-none" />
              ) : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
            </div>

            {/* åœ–ç‰‡åœ“é» */}
            {images.length>1 && (
              <div className="absolute bottom-2 inset-x-0 flex items-center justify-center gap-1">
                {images.map((_, i) => (
                  <span key={i} className={"h-1.5 w-1.5 rounded-full " + (i===index ? "bg-slate-900 dark:bg-white" : "bg-slate-300 dark:bg-slate-600")}/>
                ))}
              </div>
            )}

            {/* å·¦å³ç®­é ­ï¼ˆè¡Œå‹•ç«¯åŠ å¤§é»æ“Šå€ï¼‰ */}
            {images.length>1 && (
              <>
                <button
                  type="button"
                  onClick={gotoPrev}
                  className="absolute left-2 top-1/2 -translate-y-1/2 tap-target rounded-full bg-white/80 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 shadow-soft px-3"
                  title="ä¸Šä¸€å¼µ"
                >â€¹</button>
                <button
                  type="button"
                  onClick={gotoNext}
                  className="absolute right-2 top-1/2 -translate-y-1/2 tap-target rounded-full bg-white/80 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 shadow-soft px-3"
                  title="ä¸‹ä¸€å¼µ"
                >â€º</button>
              </>
            )}
          </div>

          {/* æ–‡å­—èˆ‡è¦æ ¼ */}
          <div className="px-4 pb-4 space-y-2 text-sm">
            {context==="store" && remain!=null && <div className="text-slate-600">å‰©é¤˜æ•¸é‡ï¼š{remain}</div>}
            {Array.isArray(tags) && tags.length>0 && <div className="text-slate-500">æ¨™ç±¤ï¼š{tags.join(" / ")}</div>}
            {item?.desc  && <div className="whitespace-pre-wrap">{item.desc}</div>}
            {item?.intro && <div className="whitespace-pre-wrap">{item.intro}</div>}
            {item?.extra && <div className="whitespace-pre-wrap">{String(item.extra)}</div>}

            {(context==="store" || context==="shop") && V.mode !== "none" && (
              <div className="mt-3 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 text-sm font-medium">é¸æ“‡è¦æ ¼</div>
                <div className="p-3 space-y-2">
                  {/* è¦æ ¼1 */}
                  {V.attrs[0] && (
                    <div className="flex items-start gap-2">
                      <div className="w-16 shrink-0 text-slate-500">{V.attrs[0].name || "è¦æ ¼1"}</div>
                      <div className="flex flex-wrap gap-2">
                        {(V.attrs[0].values||[]).map(v => (
                          <button
                            key={"v1-"+v}
                            type="button"
                            onClick={() => {
                              const next = (v === sel1 ? null : v);
                              setSel1(next);
                              if (V.mode === "double") setSel2(null);
                              try {
                                window.dispatchEvent(new CustomEvent('kjs:variant:picked', {
                                  detail: { id: baseId, sel1: next || '', sel2: sel2 || '' }
                                }));
                              } catch {}
                            }}
                            className={"tap-target px-3.5 py-1.5 rounded-full border text-sm " + (v===sel1 ? "bg-brand text-white border-brand" : "")}
                            title={v}
                          >{v}</button>
                        ))}
                      </div>
                    </div>
                  )}
                  {/* è¦æ ¼2 */}
                  {V.mode === "double" && V.attrs[1] && (
                    <div className="flex items-start gap-2">
                      <div className="w-16 shrink-0 text-slate-500">{V.attrs[1].name || "è¦æ ¼2"}</div>
                      <div className="flex flex-wrap gap-2">
                        {(V.attrs[1].values||[]).map(v => (
                          <button
                            key={"v2-"+v}
                            type="button"
                            onClick={() => {
                              const next = (v === sel2 ? null : v);
                              setSel2(next);
                              try {
                                window.dispatchEvent(new CustomEvent('kjs:variant:picked', {
                                  detail: { id: baseId, sel1: sel1 || '', sel2: next || '' }
                                }));
                              } catch {}
                            }}
                            className={"tap-target px-3.5 py-1.5 rounded-full border text-sm " + (v===sel2 ? "bg-brand text-white border-brand" : "")}
                            title={v}
                          >{v}</button>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* å³æ™‚é¡¯ç¤ºæœ‰æ•ˆå–®åƒ¹/é»æ•¸èˆ‡åº«å­˜ */}
                  <div className="text-sm text-slate-600">
                    {selectedDone ? (
                      <>
                        {context==="store" && <span>å–®åƒ¹ï¼š{effPriceOrPts!=null ? `NT$ ${effPriceOrPts}` : "â€”"}ã€€</span>}
                        {context==="shop"  && <span>é»æ•¸ï¼š{effPriceOrPts!=null ? `${effPriceOrPts} é»` : "â€”"}ã€€</span>}
                        <span>å‰©é¤˜ï¼š{effStock!=null ? effStock : "â€”"}</span>
                      </>
                    ) : (
                      <span className="text-slate-500">è«‹å…ˆé¸æ“‡å®Œæ•´è¦æ ¼</span>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* pendingï¼šåƒèˆ‡åå–®èˆ‡å‹¾é¸ï¼ˆç¶­æŒåŸé‚è¼¯ + æ–°å¢ã€Œæª¢æŸ¥é‡è¤‡ã€ï¼‰ */}
          {context==="pending" && (
            <div className="px-4 pb-4">
              <div className="mb-2 text-sm font-medium flex items-center justify-between">
                <span>åƒèˆ‡äººå“¡ï¼ˆ{candidateCount}ï¼‰</span>
                <div className="flex items-center gap-2">
                  {admin && (
                    <button
                      type="button"
                      className="text-xs rounded border px-2 py-1"
                      onClick={openDuplicateCheck}
                      title="æª¢æŸ¥é‡è¤‡ï¼ˆåªä¿®ç©ºç™½ï¼‰"
                    >æª¢æŸ¥é‡è¤‡</button>
                  )}
                  {admin && (
                    <span className="text-xs text-slate-500">
                      å·²å‹¾é¸ {Object.values(onAdmin?.checkedMap||{}).filter(Boolean).length} äºº
                    </span>
                  )}
                </div>
              </div>

              {!admin ? (
                <ul className="space-y-1 text-sm text-slate-700 dark:text-slate-300">
                  {candidates.map((name, i) => (<li key={i}>â€¢ {name}</li>))}
                </ul>
              ) : (
                <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                  <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 text-sm bg-slate-50 dark:bg-slate-800 flex items-center justify-between">
                    <div>å‹¾é¸å¾—çè€…</div>
                    <div className="flex items-center gap-2">
                      <button
                        type="button"
                        className="text-xs rounded border px-2 py-1"
                        onClick={()=>{
                          if (typeof onAdmin?.toggleCheck === 'function') {
                            candidates.forEach(n => onAdmin.toggleCheck(n, true));
                          }
                        }}
                        title="å…¨é¸"
                      >å…¨é¸</button>
                      <button
                        type="button"
                        className="text-xs rounded border px-2 py-1"
                        onClick={()=>{
                          if (typeof onAdmin?.toggleCheck === 'function') {
                            candidates.forEach(n => onAdmin.toggleCheck(n, false));
                          }
                        }}
                        title="å…¨ä¸é¸"
                      >å…¨ä¸é¸</button>
                    </div>
                  </div>
                  <ul className="max-h-[40vh] overflow-auto divide-y divide-slate-200 dark:divide-slate-700">
                    {candidates.map((name, i) => {
                      const checked = !!(onAdmin?.checkedMap && onAdmin.checkedMap[name]);
                      return (
                        <li key={i} className="flex items-center gap-3 px-3 py-2 text-sm">
                          <input
                            type="checkbox"
                            className="h-4 w-4"
                            checked={checked}
                            onChange={(e)=>{
                              const next = e.target.checked;
                              if (typeof onAdmin?.toggleCheck === 'function') onAdmin.toggleCheck(name, next);
                            }}
                          />
                          <span className="truncate">{name}</span>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              )}
            </div>
          )}

          {/* â˜…â˜…â˜… å•†åº—/é»æ•¸å•†åŸçš„ã€ŒåŠ å…¥æ¸…å–®ã€æ§åˆ¶ï¼ˆç¶­æŒåŸé‚è¼¯ï¼‰ â˜…â˜…â˜… */}
          {item && (context === "store" || context === "shop") ? (
            (V.mode !== "none" && !selectedDone)
              ? (
                <div className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center justify-between">
                  <div className="text-sm text-amber-600">è«‹å…ˆåœ¨ä¸Šæ–¹ã€Œé¸æ“‡è¦æ ¼ã€å€å¡Šå®Œæˆè¦æ ¼é¸æ“‡</div>
                  <button className="rounded-lg border px-4 py-2 text-sm text-slate-400" disabled>åŠ å…¥æ¸…å–®</button>
                </div>
              )
              : (
                context === "shop"
                  ? <SheetPickControls item={controlsItem || { ...item, __baseId: baseId }} mode="pts" />
                  : <SheetPickControls item={controlsItem || { ...item, __baseId: baseId }} mode="cash" />
              )
          ) : null}
        </div>

        {/* footer */}
        <div className="p-3 border-t border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {context==="store" ? (
            <>
              {buyUrl
                ? <a href={buyUrl} target="_blank" rel="noopener noreferrer" className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm text-center">å‰å¾€è³¼è²·</a>
                : <button className="flex-1 rounded-lg border px-4 py-2 text-sm text-slate-400" disabled>å°šæœªæä¾›è³¼è²·é€£çµ</button>}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          ) : context==="shop" ? (
            <>
              <button
                className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm"
                onClick={() => {
                  const url = effectiveContactUrl;
                  if (url) window.open(url, "_blank", "noopener,noreferrer");
                  else alert("å°šæœªè¨­å®šã€è¯çµ¡ç®¡ç†å“¡ã€é€£çµï¼šå¯åœ¨å•†å“ data åŠ ä¸Š contactUrlï¼Œæˆ–åœ¨å…¨åŸŸè¨­ç½® window.__CONTACT_URL__ã€‚");
                }}
              >
                ğŸ’¬ è¯çµ¡ç®¡ç†å“¡
              </button>
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          ) : (
            // pending
            <>
              <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={() => onStartDraw(item)}>ğŸ° æ¨¡æ“¬æŠ½çï¼ˆå±•ç¤ºï¼‰</button>
              {admin && (
                <div className="flex-1 flex flex-wrap gap-2 justify-end">
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onEdit?.(item)}>ç·¨è¼¯</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onCopyAd?.(item)}>ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡</button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertBySim?.(item)}>ä»¥æ¨¡æ“¬çµæœè½‰æ­·å²</button>
                  <button
                    className="rounded-lg border px-3 py-2 text-sm"
                    onClick={()=>{
                      const map = (onAdmin && typeof onAdmin.checkedMap === 'object') ? onAdmin.checkedMap : {};
                      onAdmin?.onConvertByChecked?.(item, map);
                    }}
                  >
                    ä»¥å‹¾é¸åå–®è½‰æ­·å²
                  </button>
                  <button className="rounded-lg border px-3 py-2 text-sm" onClick={()=>onAdmin?.onConvertByInput?.(item)}>ç›´æ¥è¼¸å…¥åå–®è½‰æ­·å²</button>
                  <button className="rounded-lg bg-rose-500 text-white px-3 py-2 text-sm" onClick={()=>onAdmin?.onDelete?.(item)}>åˆªé™¤</button>
                </div>
              )}
              <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose}>é—œé–‰</button>
            </>
          )}
        </div>
      </div>

      {/* é‡è¤‡æª¢æŸ¥å½ˆçª— */}
      <DuplicateCheckDialog
        open={dupOpen}
        groups={dupGroups}
        onCancel={()=>setDupOpen(false)}
        onApply={applyDuplicateDeletion}
      />
    </div>
  );
}


/***** ========= å…±ç”¨å·¥å…·ï¼ˆID / åˆå§‹åŒ– / ä¿å­˜ï¼‰========= *****/
function kjsNid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

const KJS_LS_KEY = 'kjs_site_data_v1'; // èˆ‡ä½ ç¾æœ‰è³‡æ–™æµä¸€è‡´
function kjsSaveData(data) {
  try { localStorage.setItem(KJS_LS_KEY, JSON.stringify(data)); } catch {}
}

/* --- Gallery åˆå§‹åŒ– --- */
function kjsEnsureGallery(data) {
  const d = data || {};
  if (!d.gallery) d.gallery = {};
  if (!Array.isArray(d.gallery.items)) d.gallery.items = [];
  // â˜… æ–°å¢ï¼šé¦–é é–‹ç®±/åˆ°è²¨å¯¦æ‹é¸æ“‡æ¸…å–®ï¼ˆåƒ…å½±éŸ¿é¦–é ï¼‰
  if (!Array.isArray(d.gallery.homepage_showcase)) d.gallery.homepage_showcase = [];
  return d;
}

/* --- FAQ åˆå§‹åŒ– --- */
function kjsEnsureFaq(data) {
  const d = data || {};
  if (!d.faq) d.faq = {};
  if (!Array.isArray(d.faq.categories)) d.faq.categories = [];
  return d;
}

/* --- Games åˆå§‹åŒ–ï¼ˆç´”å¨›æ¨‚ã€ä¸é€£ç·šã€ä¸å›å‚³ã€ä¸é˜²åˆ·ã€ä¸ç™¼çï¼‰ --- */
function kjsEnsureGames(data) {
  const d = data || {};
  if (!d.games) d.games = {};

  // å…±ç”¨ï¼šç¢ºä¿é™£åˆ—
  const arr = (v)=>Array.isArray(v)?v:[];

  // Memory Match
  if (!d.games.memory) d.games.memory = {};
  d.games.memory.themes = arr(d.games.memory.themes);
  if (!d.games.memory.themes.length) {
    d.games.memory.themes = [
      { id: kjsNid(), name: "å‹•ç‰©", imagesText: "", images: [] },
      { id: kjsNid(), name: "é¢¨æ™¯", imagesText: "", images: [] },
    ];
  }
  if (!d.games.memory.defaultThemeId) d.games.memory.defaultThemeId = d.games.memory.themes[0]?.id || "";

  // Whack-a-mole
  if (!d.games.mole) d.games.mole = {};
  d.games.mole.themes = arr(d.games.mole.themes);
  if (!d.games.mole.themes.length) {
    d.games.mole.themes = [
      { id: kjsNid(), name: "è€é¼ ", imagesText: "", images: [] },
      { id: kjsNid(), name: "è¡¨æƒ…", imagesText: "", images: [] },
    ];
  }
  if (!d.games.mole.defaultThemeId) d.games.mole.defaultThemeId = d.games.mole.themes[0]?.id || "";

  // 2048
  if (!d.games.g2048) d.games.g2048 = {};
  if (!d.games.g2048.tileImages) d.games.g2048.tileImages = {}; // {2:{src,opacity},4:{...}}
  if (d.games.g2048.defaultTileOpacity == null) d.games.g2048.defaultTileOpacity = 0.22;

  // Luck today
  if (!d.games.luck) d.games.luck = {};
  d.games.luck.items = arr(d.games.luck.items);
  if (!d.games.luck.items.length) {
    d.games.luck.items = [
      { id: kjsNid(), emoji:"ğŸ€", title:"æ‰‹æ°£ä¸éŒ¯", content:"ä»Šå¤©é©åˆæŠŠæƒ³åšçš„äº‹æ¨é€²ä¸€é»é»", image:"", weight: 3 },
      { id: kjsNid(), emoji:"ğŸŒ¤ï¸", title:"å¹³ç©©æ—¥", content:"ç¶­æŒç¯€å¥å°±æœƒæœ‰æ”¶ç©«", image:"", weight: 5 },
      { id: kjsNid(), emoji:"ğŸ§Š", title:"æ”¾æ…¢ä¸€é»", content:"åˆ¥ç¡¬æ’ï¼Œåšå¿…è¦çš„å°±å¥½", image:"", weight: 2 },
    ];
  }

  // Tetris
  if (!d.games.tetris) d.games.tetris = {};
  if (!d.games.tetris.style) d.games.tetris.style = { mode: "color", imagesText: "", images: [] }; // mode: color|image
  return d;
}

/* å°å·¥å…·ï¼šå®‰å…¨ cloneï¼ˆUMD ç’°å¢ƒï¼‰ */
function kjsClone(x){ return window.structuredClone ? structuredClone(x) : JSON.parse(JSON.stringify(x||{})); }

/* å°å·¥å…·ï¼šä¾æ¬Šé‡æŠ½é¸ï¼ˆweight é è¨­ 1ï¼‰ */
function pickWeighted(items){
  const arr = Array.isArray(items) ? items.filter(Boolean) : [];
  if (!arr.length) return null;
  let total = 0;
  const weights = arr.map(it=>{
    const w = Number(it.weight);
    const ww = (Number.isFinite(w) && w > 0) ? w : 1;
    total += ww;
    return ww;
  });
  if (total <= 0) return arr[0] || null;
  let r = Math.random() * total;
  for (let i=0;i<arr.length;i++){
    r -= weights[i];
    if (r <= 0) return arr[i];
  }
  return arr[arr.length-1] || null;
}


/***** ========= Gallery Lightbox ========= *****/
function GalleryLightbox({ open, items = [], index = 0, onClose = ()=>{}, onStep = ()=>{} }) {
  const React = window.React || globalThis.React;

  React.useEffect(() => {
    if (!open) return;
    const onKey = (e) => {
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowLeft') onStep(-1);
      if (e.key === 'ArrowRight') onStep(+1);
    };
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [open, onClose, onStep]);

  if (!open) return null;
  const item = items[index] || null;

  return (
    <div className="fixed inset-0 z-[998] bg-black/70 backdrop-blur-sm flex items-center justify-center p-3" onClick={onClose}>
      <div className="relative w-[min(92vw,960px)]" onClick={(e)=>e.stopPropagation()}>
        <div className="relative bg-white dark:bg-slate-900 rounded-2xl overflow-hidden shadow-elevate">
          <div className="w-full max-h-[80vh] grid place-content-center bg-slate-50 dark:bg-slate-800 p-2">
            {item?.src
              ? <img src={item.src} alt="" className="max-h-[78vh] w-auto h-auto object-contain select-none"/>
              : <div className="text-slate-400">ç„¡åœ–ç‰‡</div>}
          </div>
          <div className="flex items-center justify-between px-3 py-2 border-t border-slate-200 dark:border-slate-700 text-sm">
            <div className="truncate">
              {item?.prize ? <span className="text-slate-700 dark:text-slate-200">{item.prize}</span> : <span className="text-slate-400">æœªå¡«å“å</span>}
              {item?.at ? <span className="ml-2 text-slate-400">{item.at}</span> : null}
            </div>
            <button className="rounded-lg border px-3 py-1.5" onClick={onClose}>é—œé–‰</button>
          </div>
        </div>

        <button className="absolute left-0 top-1/2 -translate-y-1/2 tap-target rounded-full bg-white/80 dark:bg-slate-900/70 border shadow-soft px-3" onClick={()=>onStep(-1)} title="ä¸Šä¸€å¼µ">â€¹</button>
        <button className="absolute right-0 top-1/2 -translate-y-1/2 tap-target rounded-full bg-white/80 dark:bg-slate-900/70 border shadow-soft px-3" onClick={()=>onStep(+1)} title="ä¸‹ä¸€å¼µ">â€º</button>
      </div>
    </div>
  );
}

/***** ========= Gallery å‰å° ========= *****/
function GalleryWall({ data, admin=false, onOpenAdmin=()=>{} }) {
  const React = window.React || globalThis.React;
  const items = (data?.gallery?.items || [])
    .filter(x => x?.visible)
    .sort((a,b) => {
      if ((b?.pin|0)!==(a?.pin|0)) return (b?.pin|0)-(a?.pin|0);
      return String(b?.at||'').localeCompare(String(a?.at||''));
    });

  const [open, setOpen] = React.useState(false);
  const [idx, setIdx] = React.useState(0);
  const openAt = (i) => { setIdx(i); setOpen(true); };
  const step = (d) => setIdx(i => (i + d + items.length) % items.length);

  if (!items.length && !admin) return null;

  return (
  <section id="gallery" className="my-10">

      <div className="flex items-center justify-between mb-3">
        <h2 className="text-lg font-semibold">ğŸ–¼ é–‹ç®±/åˆ°è²¨å¯¦æ‹</h2>
        {admin && (
          <button className="tap-target rounded-lg bg-brand text-white px-3 py-2 text-sm" onClick={onOpenAdmin}>
            ï¼‹ æ–°å¢æˆªåœ–
          </button>
        )}
      </div>

      {!items.length ? (
        <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å…¬é–‹çš„æˆªåœ–</div>
      ) : (
        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
          {items.map((it, i) => (
            <button key={it.id || i} className="group relative rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border" onClick={()=>openAt(i)} title={it?.prize||''}>
              <div className="aspect-square w-full grid place-content-center">
                {it.src ? <img src={it.src} alt="" className="w-full h-full object-cover select-none"/> : <div className="text-slate-400">ç„¡åœ–ç‰‡</div>}
              </div>
              {it.prize && (
                <div className="absolute bottom-0 inset-x-0 bg-black/40 text-white px-2 py-1 text-xs truncate">
                  {it.prize}
                </div>
              )}
              {it.pin ? <span className="absolute top-2 left-2 text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded">ç½®é ‚</span> : null}
            </button>
          ))}
        </div>
      )}

      <GalleryLightbox open={open} items={items} index={idx} onClose={()=>setOpen(false)} onStep={step}/>
    </section>
  );
}

/***** ========= Gallery å¾Œå°ï¼ˆæ–°å¢/åˆªé™¤/ç·¨è¼¯/æ’åºï¼‰ ========= *****/
function GalleryAdmin({ data, setData, onClose=()=>{} }) {
  const React = window.React || globalThis.React;
  const [draft, setDraft] = React.useState(() => kjsEnsureGallery(kjsClone(data)));
  const items = draft.gallery.items;

  const [bulk, setBulk] = React.useState("");
  const addFromBulk = () => {
    const lines = (bulk || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (!lines.length) return;
    const existed = new Set(items.map(x => x.src));
    const added = [];
    for (const src of lines) {
      if (existed.has(src)) continue;
      existed.add(src);
      added.push({
        id: kjsNid(),
        src,
        prize: "",
        at: new Date().toISOString().slice(0,10),
        visible: false,
        pin: false,
        tags: []
      });
    }
    if (added.length) {
      setDraft(prev => ({ ...prev, gallery: { ...prev.gallery, items: [...prev.gallery.items, ...added] }}));
      setBulk("");
    } else {
      alert("æ²’æœ‰å¯æ–°å¢çš„ç¶²å€ï¼ˆå¯èƒ½éƒ½é‡è¤‡ï¼‰");
    }
  };

  const updateItem = (id, patch) => {
    setDraft(prev => ({ ...prev, gallery: { ...prev.gallery, items: prev.gallery.items.map(it => it.id===id ? { ...it, ...patch } : it) }}));
  };

  const removeItem = (id) => {
    setDraft(prev => ({ ...prev, gallery: { ...prev.gallery, items: prev.gallery.items.filter(it => it.id!==id) }}));
  };

  const moveItem = (id, dir) => {
    const arr = items.slice();
    const i = arr.findIndex(x => x.id===id);
    if (i<0) return;
    const j = i + dir;
    if (j<0 || j>=arr.length) return;
    const tmp = arr[i]; arr[i]=arr[j]; arr[j]=tmp;
    setDraft(prev => ({ ...prev, gallery: { ...prev.gallery, items: arr }}));
  };

  const bulkVisible = (v) => {
    setDraft(prev => ({ ...prev, gallery: { ...prev.gallery, items: prev.gallery.items.map(it => ({ ...it, visible: !!v })) }}));
  };

  const saveAll = () => {
    setData(draft);
    kjsSaveData(draft);
    onClose();
  };

  const view = items.slice().sort((a,b)=>{
    if ((b?.pin|0)!==(a?.pin|0)) return (b?.pin|0)-(a?.pin|0);
    return String(b?.at||'').localeCompare(String(a?.at||''));
  });

  return (
    <div className="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-[min(96vw,1000px)] max-h-[92vh] bg-white dark:bg-slate-900 rounded-2xl shadow-elevate overflow-hidden flex flex-col">
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div className="font-semibold">ğŸ“ é–‹ç®±/åˆ°è²¨å¯¦æ‹ç®¡ç†</div>
          <div className="flex items-center gap-2">
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkVisible(false)}>å…¨éƒ¨éš±è—</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkVisible(true)}>å…¨éƒ¨å…¬é–‹</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
            <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={saveAll}>ğŸ’¾ å„²å­˜</button>
          </div>
        </div>

        <div className="p-4 grid gap-4 overflow-auto modal-scroll">
          <div className="rounded-xl border p-3">
            <div className="text-sm font-medium mb-2">æ‰¹æ¬¡æ–°å¢åœ–ç‰‡ç¶²å€ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</div>
            <textarea className="w-full h-24 rounded-lg border p-2 text-sm" placeholder="https://...jpg\nhttps://...png" value={bulk} onChange={e=>setBulk(e.target.value)} />
            <div className="mt-2 flex items-center justify-end">
              <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={addFromBulk}>åŠ å…¥æ¸…å–®</button>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {view.map(it => (
              <div key={it.id} className="rounded-xl border overflow-hidden">
                <div className="aspect-square bg-slate-100 dark:bg-slate-800 grid place-content-center">
                  {it.src ? <img src={it.src} alt="" className="w-full h-full object-cover"/> : <div className="text-slate-400">ç„¡åœ–ç‰‡</div>}
                </div>
                <div className="p-3 space-y-2 text-sm">
                  <label className="block">
                    <span className="text-slate-500">å“åï¼ˆå¯ç©ºï¼‰</span>
                    <input className="w-full rounded-lg border px-2 py-1.5 mt-1" value={it.prize||""} onChange={e=>updateItem(it.id,{prize:e.target.value})}/>
                  </label>
                  <label className="block">
                    <span className="text-slate-500">æ—¥æœŸ</span>
                    <input type="date" className="w-full rounded-lg border px-2 py-1.5 mt-1" value={it.at||""} onChange={e=>updateItem(it.id,{at:e.target.value})}/>
                  </label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-1">
                      <input type="checkbox" checked={!!it.visible} onChange={e=>updateItem(it.id,{visible:e.target.checked})}/>
                      <span>å…¬é–‹</span>
                    </label>
                    <label className="inline-flex items-center gap-1">
                      <input type="checkbox" checked={!!it.pin} onChange={e=>updateItem(it.id,{pin:e.target.checked})}/>
                      <span>ç½®é ‚</span>
                    </label>
                  </div>

                  <div className="flex items-center justify-between pt-1">
                    <div className="flex items-center gap-1">
                      <button className="rounded border px-2 py-1" onClick={()=>moveItem(it.id, -1)}>ä¸Šç§»</button>
                      <button className="rounded border px-2 py-1" onClick={()=>moveItem(it.id, +1)}>ä¸‹ç§»</button>
                    </div>
                    <button className="rounded bg-rose-600 text-white px-2 py-1" onClick={()=>{ if(confirm('ç¢ºå®šåˆªé™¤é€™å¼µæˆªåœ–ï¼Ÿ')) removeItem(it.id); }}>åˆªé™¤</button>
                  </div>
                </div>
              </div>
            ))}
            {!view.length && <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰é …ç›®</div>}
          </div>
        </div>
      </div>
    </div>
  );
}

/***** ========= FAQ å‰å°ï¼ˆåªå±•é–‹ä¸€å€‹åˆ†é¡ï¼‹æœå°‹ï¼‰ ========= *****/
function FaqSection({ data, admin=false, onOpenAdmin=()=>{} }) {
  const React = window.React || globalThis.React;
  const [q, setQ] = React.useState("");
  const [openCatId, setOpenCatId] = React.useState(null); // â† åªé–‹ä¸€å€‹åˆ†é¡

  const cats = (data?.faq?.categories || [])
    .filter(c => c?.visible !== false)
    .sort((a, b) => (a?.order|0) - (b?.order|0));

  const filter = (text) => String(text||'').toLowerCase().includes(q.toLowerCase());

  const view = cats.map(cat => {
    const items = (cat.items||[])
      .filter(it => it?.visible !== false && (filter(it.q) || filter(it.a)))
      .sort((a,b) => (a?.order|0) - (b?.order|0));
    return { cat, items };
  }).filter(x => x.items.length);

  return (
    <section id="faq" className="my-10">
      <div className="flex items-center justify-between mb-3">
        <h2 className="text-xl font-semibold tracking-tight">â“ FAQ å¸¸è¦‹å•é¡Œ</h2>
        {admin && (
          <button
            className="tap-target rounded-lg border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={onOpenAdmin}
          >
            ç®¡ç† FAQ
          </button>
        )}
      </div>

      <div className="mb-5">
        <input
          className="w-full rounded-xl border bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-brand/40"
          placeholder="è¼¸å…¥é—œéµå­—æœå°‹ï¼ˆå•é¡Œ / ç­”æ¡ˆï¼‰"
          value={q}
          onChange={e=>setQ(e.target.value)}
        />
      </div>

      {!view.length ? (
        <div className="text-sm text-slate-500">å°šç„¡ç¬¦åˆçš„å•é¡Œ</div>
      ) : (
        <div className="space-y-3">
          {view.map(({cat, items}) => (
            <FaqCategoryAccordion
              key={cat.id}
              cat={cat}
              items={items}
              isOpen={openCatId===cat.id}                       // â† æ˜¯å¦å±•é–‹æ­¤åˆ†é¡
              onToggle={() => setOpenCatId(openCatId===cat.id ? null : cat.id)}  // â† åˆ‡æ›åªç•™ä¸€å€‹
            />
          ))}
        </div>
      )}
    </section>
  );
}


/***** ========= FAQ åˆ†é¡ï¼ˆåªå±•é–‹ä¸€å€‹å•é¡Œï¼‹å¹³æ»‘å‹•ç•«ï¼‰ ========= *****/
function FaqCategoryAccordion({ cat, items, isOpen, onToggle }) {
  const React = window.React || globalThis.React;
  const bodyRef = React.useRef(null);
  const [h, setH] = React.useState(0);

  // åŒä¸€åˆ†é¡å…§ï¼šåªå±•é–‹ä¸€å€‹å•é¡Œ
  const [openItemId, setOpenItemId] = React.useState(null);

  // åˆ†é¡é–‹åˆ â†’ é‡æ¸¬é«˜åº¦
  React.useEffect(() => {
    if (!bodyRef.current) return;
    setH(isOpen ? bodyRef.current.scrollHeight : 0);
  }, [isOpen, items, openItemId]);

  // è§€å¯Ÿå…§å®¹å°ºå¯¸ï¼ˆå•é¡Œå±•é–‹/æ”¶åˆæ™‚ï¼Œåˆ†é¡å®¹å™¨é«˜åº¦è¦è·Ÿè‘—æ›´æ–°ï¼‰
  React.useEffect(() => {
    const recalc = () => {
      if (!bodyRef.current) return;
      setH(isOpen ? bodyRef.current.scrollHeight : 0);
    };
    const ro = new ResizeObserver(recalc);
    if (bodyRef.current) ro.observe(bodyRef.current);
    window.addEventListener('resize', recalc);
    return () => { ro.disconnect(); window.removeEventListener('resize', recalc); };
  }, [isOpen]);

  // é»æŸä¸€é¡Œ â†’ åªé–‹è©²é¡Œï¼Œå…¶é¤˜è‡ªå‹•é—œ
  const handleItemToggle = (id) => {
    setOpenItemId(prev => (prev === id ? null : id));
  };

  return (
    <div
      className="
        rounded-2xl border border-slate-200 dark:border-slate-700
        bg-white/70 dark:bg-slate-900/60 backdrop-blur
        shadow-[0_6px_18px_-10px_rgba(0,0,0,0.25)]
      "
    >
      {/* åˆ†é¡æ¨™é¡Œï¼ˆåªé–‹ä¸€å€‹åˆ†é¡ï¼‰ */}
      <button
        className="w-full px-4 py-3 text-left flex items-center justify-between gap-3 hover:bg-slate-50/70 dark:hover:bg-slate-800/60 transition rounded-2xl focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
        onClick={onToggle}
        aria-expanded={isOpen}
        aria-controls={`faqc-${cat.id}`}
        title={isOpen ? 'æ”¶åˆåˆ†é¡' : 'å±•é–‹åˆ†é¡'}
      >
        <div className="flex items-center gap-2">
          <span className="h-5 w-1.5 rounded-full bg-brand/70"></span>
          <div className="font-semibold">{cat.name || 'æœªå‘½ååˆ†é¡'}</div>
          <span className="text-xs text-slate-500">ï¼ˆ{items.length}ï¼‰</span>
        </div>
        <svg
          className={`h-4 w-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
        >
          <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.24 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clipRule="evenodd" />
        </svg>
      </button>

      {/* é¡Œç›®åˆ—è¡¨å®¹å™¨ï¼ˆåˆ†é¡é«˜åº¦å‹•ç•«ï¼‰ */}
      <div id={`faqc-${cat.id}`} style={{height: h, transition:'height 240ms ease'}} className="overflow-hidden">
        <div ref={bodyRef} className="px-4 pb-4 pt-0">
          <ul className="grid gap-2">
            {items.map(it => (
              <FaqAccordionItem
                key={it.id}
                item={it}
                isOpen={openItemId===it.id}          // â† æ˜¯å¦å±•é–‹è©²é¡Œ
                onToggle={() => handleItemToggle(it.id)} // â† åˆ‡æ›åªç•™ä¸€é¡Œ
              />
            ))}
          </ul>
        </div>
      </div>
    </div>
  );
}


/***** ========= FAQ å–®é¡Œï¼ˆå—æ§å¼ï¼‹å¹³æ»‘é«˜åº¦ï¼‰ ========= *****/
function FaqAccordionItem({ item, isOpen=false, onToggle=()=>{} }) {
  const React = window.React || globalThis.React;
  const bodyRef = React.useRef(null);
  const [h, setH] = React.useState(0);

  // ç”±çˆ¶å±¤æ§åˆ¶ isOpenï¼›é€™è£¡åªç®¡é«˜åº¦å‹•ç•«
  React.useEffect(() => {
    if (!bodyRef.current) return;
    setH(isOpen ? bodyRef.current.scrollHeight : 0);
  }, [isOpen, item.a]);

  return (
    <li
      className="
        rounded-2xl border border-slate-200 dark:border-slate-700
        bg-white/70 dark:bg-slate-900/60 backdrop-blur
        shadow-[0_6px_18px_-10px_rgba(0,0,0,0.25)]
      "
    >
      {/* å•é¡Œåˆ—ï¼ˆäº¤ç”±çˆ¶å±¤åˆ‡æ›ï¼Œåªé–‹ä¸€é¡Œï¼‰ */}
      <button
        className="
          w-full px-4 py-3 text-left flex items-center justify-between gap-3
          hover:bg-slate-50/70 dark:hover:bg-slate-800/60 transition
          focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/40 rounded-2xl
        "
        onClick={onToggle}
        aria-expanded={isOpen}
        aria-controls={`faqp-${item.id}`}
        title={isOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
      >
        <div className="flex items-center gap-2">
          <span className="grid place-items-center h-7 w-7 rounded-lg bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100">Q</span>
          <span className="text-sm sm:text-[15px] font-medium">{item.q || 'æœªå‘½åå•é¡Œ'}</span>
        </div>
        <svg
          className={`h-4 w-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
        >
          <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.24 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clipRule="evenodd" />
        </svg>
      </button>

      {/* ç­”æ¡ˆï¼ˆé«˜åº¦å‹•ç•«ï¼Œé•·æ–‡å®Œæ•´å±•é–‹ï¼‰ */}
      <div
        id={`faqp-${item.id}`}
        style={{ height: h, transition: 'height 220ms ease' }}
        className="overflow-hidden"
      >
        <div ref={bodyRef} className="px-4 pb-4 pt-0 text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap break-words">
          {item.a || 'ï¼ˆå°šæœªå¡«å¯«ç­”æ¡ˆï¼‰'}
        </div>
      </div>
    </li>
  );
}


/***** ========= FAQ å¾Œå°ï¼ˆåˆ†é¡ï¼‹é¡Œç›®ï¼šæ–°å¢/åˆªé™¤/æ’åº/é¡¯ç¤ºï¼‰ ========= *****/
function FaqAdmin({ data, setData, onClose=()=>{} }) {
  const React = window.React || globalThis.React;
  const [draft, setDraft] = React.useState(() => kjsEnsureFaq(kjsClone(data)));

  const cats = draft.faq.categories;

  const addCategory = () => {
    const next = { id: kjsNid(), name: "æœªå‘½ååˆ†é¡", visible: true, order: (cats?.length||0)+1, items: [] };
    setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: [...prev.faq.categories, next] }}));
  };

  const renameCategory = (id, name) => {
    setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: prev.faq.categories.map(c => c.id===id? { ...c, name } : c) }}));
  };

  const removeCategory = (id) => {
    setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: prev.faq.categories.filter(c => c.id!==id) }}));
  };

  const moveCategory = (id, dir) => {
    const arr = cats.slice();
    const i = arr.findIndex(x => x.id===id);
    if (i<0) return;
    const j = i + dir;
    if (j<0 || j>=arr.length) return;
    const tmp = arr[i]; arr[i]=arr[j]; arr[j]=tmp;
    // é‡æ’ order
    arr.forEach((c,idx)=>c.order = idx+1);
    setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: arr }}));
  };

  const toggleCategoryVisible = (id, v) => {
    setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: prev.faq.categories.map(c => c.id===id? { ...c, visible: !!v } : c) }}));
  };

  const addFaqItem = (catId) => {
    setDraft(prev => ({
      ...prev,
      faq: {
        ...prev.faq,
        categories: prev.faq.categories.map(c => c.id!==catId ? c : {
          ...c,
          items: [...(c.items||[]), { id: kjsNid(), q: "æ–°å•é¡Œ", a: "", visible: true, order: (c.items?.length||0)+1 }]
        })
      }
    }));
  };

  const updateFaqItem = (catId, itemId, patch) => {
    setDraft(prev => ({
      ...prev,
      faq: {
        ...prev.faq,
        categories: prev.faq.categories.map(c => c.id!==catId ? c : {
          ...c,
          items: (c.items||[]).map(it => it.id===itemId ? { ...it, ...patch } : it)
        })
      }
    }));
  };

  const removeFaqItem = (catId, itemId) => {
    setDraft(prev => ({
      ...prev,
      faq: {
        ...prev.faq,
        categories: prev.faq.categories.map(c => c.id!==catId ? c : {
          ...c,
          items: (c.items||[]).filter(it => it.id!==itemId).map((it,idx)=>({ ...it, order: idx+1 }))
        })
      }
    }));
  };

  const moveFaqItem = (catId, itemId, dir) => {
    const cat = cats.find(c => c.id===catId);
    if (!cat) return;
    const arr = (cat.items||[]).slice();
    const i = arr.findIndex(x => x.id===itemId);
    if (i<0) return;
    const j = i + dir;
    if (j<0 || j>=arr.length) return;
    const tmp = arr[i]; arr[i]=arr[j]; arr[j]=tmp;
    arr.forEach((it,idx)=>it.order = idx+1);
    setDraft(prev => ({
      ...prev,
      faq: { ...prev.faq, categories: prev.faq.categories.map(c => c.id===catId ? { ...c, items: arr } : c) }
    }));
  };

  const bulkSetVisible = (level, v) => {
    if (level === 'category') {
      setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: prev.faq.categories.map(c => ({ ...c, visible: !!v })) }}));
    } else {
      setDraft(prev => ({ ...prev, faq: { ...prev.faq, categories: prev.faq.categories.map(c => ({ ...c, items: (c.items||[]).map(it => ({ ...it, visible: !!v })) })) }}));
    }
  };

  const saveAll = () => {
    setData(draft);
    kjsSaveData(draft);
    onClose();
  };

  const view = cats.slice().sort((a,b)=>(a?.order|0)-(b?.order|0));

  return (
    <div className="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-[min(96vw,1000px)] max-h-[92vh] bg-white dark:bg-slate-900 rounded-2xl shadow-elevate overflow-hidden flex flex-col">
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
          <div className="font-semibold">ğŸ“š FAQ ç®¡ç†</div>
          <div className="flex items-center gap-2">
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkSetVisible('category', true)}>å…¨éƒ¨åˆ†é¡é¡¯ç¤º</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkSetVisible('category', false)}>å…¨éƒ¨åˆ†é¡éš±è—</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkSetVisible('item', true)}>å…¨éƒ¨é¡Œç›®é¡¯ç¤º</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>bulkSetVisible('item', false)}>å…¨éƒ¨é¡Œç›®éš±è—</button>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
            <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={saveAll}>ğŸ’¾ å„²å­˜</button>
          </div>
        </div>

        <div className="p-4 grid gap-4 overflow-auto modal-scroll">
          <div className="flex items-center justify-between">
            <div className="text-sm text-slate-600">åˆ†é¡èˆ‡é¡Œç›®çš†å¯æ’åºã€é¡¯ç¤º/éš±è—ã€‚</div>
            <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={addCategory}>ï¼‹ æ–°å¢åˆ†é¡</button>
          </div>

          <div className="grid grid-cols-1 gap-3">
            {view.map(cat => (
              <div key={cat.id} className="rounded-xl border overflow-hidden">
                <div className="px-3 py-2 border-b bg-slate-50 dark:bg-slate-800 flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <input className="rounded border px-2 py-1 text-sm" value={cat.name||""} onChange={e=>renameCategory(cat.id, e.target.value)} />
                    <label className="inline-flex items-center gap-1 text-sm">
                      <input type="checkbox" checked={cat.visible!==false} onChange={e=>toggleCategoryVisible(cat.id, e.target.checked)} />
                      <span>é¡¯ç¤º</span>
                    </label>
                  </div>
                  <div className="flex items-center gap-2">
                    <button className="rounded border px-2 py-1 text-sm" onClick={()=>moveCategory(cat.id, -1)}>ä¸Šç§»</button>
                    <button className="rounded border px-2 py-1 text-sm" onClick={()=>moveCategory(cat.id, +1)}>ä¸‹ç§»</button>
                    <button className="rounded bg-rose-600 text-white px-2 py-1 text-sm" onClick={()=>{ if(confirm('åˆªé™¤æ­¤åˆ†é¡èˆ‡å…¶æ‰€æœ‰é¡Œç›®ï¼Ÿ')) removeCategory(cat.id) }}>åˆªé™¤åˆ†é¡</button>
                    <button className="rounded bg-brand text-white px-2 py-1 text-sm" onClick={()=>addFaqItem(cat.id)}>ï¼‹ æ–°å¢é¡Œç›®</button>
                  </div>
                </div>

                <div className="p-3 space-y-2">
                  {(cat.items||[]).sort((a,b)=>(a?.order|0)-(b?.order|0)).map(it => (
                    <div key={it.id} className="rounded-lg border p-2">
                      <div className="flex items-center justify-between">
                        <label className="flex-1 mr-2">
                          <span className="block text-xs text-slate-500">å•é¡Œ</span>
                          <input className="w-full rounded border px-2 py-1 text-sm" value={it.q||""} onChange={e=>updateFaqItem(cat.id, it.id, { q: e.target.value })}/>
                        </label>
                        <label className="inline-flex items-center gap-1 text-sm shrink-0">
                          <input type="checkbox" checked={it.visible!==false} onChange={e=>updateFaqItem(cat.id, it.id, { visible: e.target.checked })}/>
                          <span>é¡¯ç¤º</span>
                        </label>
                      </div>
                      <label className="block mt-2">
                        <span className="block text-xs text-slate-500">ç­”æ¡ˆ</span>
                        <textarea className="w-full rounded border px-2 py-1 text-sm h-20" value={it.a||""} onChange={e=>updateFaqItem(cat.id, it.id, { a: e.target.value })}/>
                      </label>
                      <div className="flex items-center justify-between mt-2">
                        <div className="flex items-center gap-1">
                          <button className="rounded border px-2 py-1 text-sm" onClick={()=>moveFaqItem(cat.id, it.id, -1)}>ä¸Šç§»</button>
                          <button className="rounded border px-2 py-1 text-sm" onClick={()=>moveFaqItem(cat.id, it.id, +1)}>ä¸‹ç§»</button>
                        </div>
                        <button className="rounded bg-rose-600 text-white px-2 py-1 text-sm" onClick={()=>{ if(confirm('åˆªé™¤æ­¤é¡Œç›®ï¼Ÿ')) removeFaqItem(cat.id, it.id); }}>åˆªé™¤é¡Œç›®</button>
                      </div>
                    </div>
                  ))}
                  {(!cat.items || !cat.items.length) && <div className="text-sm text-slate-500">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰é¡Œç›®</div>}
                </div>
              </div>
            ))}
            {!view.length && <div className="text-sm text-slate-500">å°šç„¡åˆ†é¡ï¼Œè«‹å…ˆæ–°å¢</div>}
          </div>
        </div>
      </div>
    </div>
  );
}

/***** ========= HomeSectionsï¼ˆå·²æ•´åˆé€² Homeï¼›ä¿ç•™å…¼å®¹ï¼‰ ========= *****/
function HomeSections({ data, setData, admin }) {
  // å·²æ•´åˆåˆ° Homeï¼›æ­¤å…ƒä»¶æš«ä¸æ¸²æŸ“å…§å®¹ï¼Œé¿å…é‡è¤‡èˆ‡ç‹€æ…‹åˆ†è£‚ã€‚
  return null;
}

/* ========= æ–°å¢ï¼šé–‹ç®±/åˆ°è²¨å¯¦æ‹ç¨ç«‹é é¢ ========= */
function GalleryPage({ data, setData, admin=false }) {
  const React = window.React || globalThis.React;

  // ç¢ºä¿è³‡æ–™ç¯€é»å­˜åœ¨ï¼ˆé¿å…ç©ºè¼‰æ™‚å‡ºéŒ¯ï¼‰
  React.useEffect(() => { try { kjsEnsureGallery(data); } catch {} }, [data]);

  const [showAdmin, setShowAdmin] = React.useState(false);

  return (
    <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">
      <section className="my-2">
        <div className="flex items-center justify-between mb-3">
          <h1 className="text-xl font-semibold">ğŸ–¼ é–‹ç®±/åˆ°è²¨å¯¦æ‹</h1>
          {admin && (
            <button className="tap-target rounded-lg bg-brand text-white px-3 py-2 text-sm"
                    onClick={()=>setShowAdmin(true)}>ç®¡ç†é–‹ç®±/åˆ°è²¨å¯¦æ‹</button>
          )}
        </div>

        <GalleryWall data={data} admin={admin} onOpenAdmin={()=>setShowAdmin(true)} />
        {admin && showAdmin && (
          <GalleryAdmin data={data} setData={setData} onClose={()=>setShowAdmin(false)} />
        )}
      </section>
    </main>
  );
}

/* ========= æ–°å¢ï¼šFAQ ç¨ç«‹é é¢ ========= */
function FaqPage({ data, setData, admin=false }) {
  const React = window.React || globalThis.React;

  // ç¢ºä¿è³‡æ–™ç¯€é»å­˜åœ¨
  React.useEffect(() => { try { kjsEnsureFaq(data); } catch {} }, [data]);

  const [showAdmin, setShowAdmin] = React.useState(false);

  return (
    <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">
      <section className="my-2">
        <div className="flex items-center justify-between mb-3">
          <h1 className="text-xl font-semibold">â“ FAQ å¸¸è¦‹å•é¡Œ</h1>
          {admin && (
            <button className="tap-target rounded-lg bg-brand text-white px-3 py-2 text-sm"
                    onClick={()=>setShowAdmin(true)}>ç®¡ç† FAQ</button>
          )}
        </div>

        <FaqSection data={data} admin={admin} onOpenAdmin={()=>setShowAdmin(true)} />
        {admin && showAdmin && (
          <FaqAdmin data={data} setData={setData} onClose={()=>setShowAdmin(false)} />
        )}
      </section>
    </main>
  );
}

function SheetPickControls({ item, mode='cash' }) {
  const React = window.React || globalThis.React;
  const pick = usePickList(mode==='pts' ? 'kjs_pointshop_picklist' : 'kjs_store_picklist');

  // ğŸ”” äº‹ä»¶è§¸ç™¼ re-renderï¼ˆä¿éšªç”¨ï¼›å¯¦å‹™ä¸Šå·²ç”±çˆ¶å±¤æ§åˆ¶é¡¯ç¤ºï¼‰
  const [variantSignal, setVariantSignal] = React.useState(0); void variantSignal;

  // key èˆ‡ã€ŒåŸå§‹ baseIdã€ï¼ˆå»æ‰ ::variantï¼‰
  const id      = String(item?.id ?? item?.name ?? 'item');
  const baseKey = String(item?.__baseId || id).split('::')[0];

  // åƒ¹æ ¼/é»æ•¸/åº«å­˜ï¼ˆçˆ¶å±¤å·²ä¾è¦æ ¼è¦†å¯«ï¼‰
  const unitPrice = (mode==='cash')
    ? (['price','cash','priceNTD','priceTWD'].map(k=>item?.[k]).find(v => v!=='' && v!=null))
    : null;
  const unitPts = (mode==='pts')
    ? (['points','pts','need','needPoints','cost','costPts','pricePts']
        .map(k=>+item?.[k]).find(n=>Number.isFinite(n)) ?? null)
    : null;
  const remain = (item?.stock ?? item?.qty ?? item?.quantity ?? item?.remaining ?? null);

  // æ˜¯å¦å·²é¸é½Šï¼ˆçˆ¶å±¤è‹¥æœ‰ _variant ç›´æ¥è¦–ç‚ºé¸é½Šï¼‰
  const vMode = item?._variant?.mode || item?.variants?.mode || 'none';
  const pickedEvent = window.__VARIANT_PICKED__?.[baseKey] || null;
  const sel1 = item?._variant?.sel1 ?? pickedEvent?.sel1 ?? '';
  const sel2 = item?._variant?.sel2 ?? pickedEvent?.sel2 ?? '';
  const selectionReady =
    (vMode==='none') || !!item?._variant || (vMode==='single' && !!sel1) || (vMode==='double' && !!sel1 && !!sel2);

  // æ¸…å–® keyï¼šç›´æ¥ç”¨ item.idï¼ˆå·²å« ::variantï¼‰
  const qty = pick.map[id]?.qty || 0;

  // å¯«å…¥æ¸…å–® payloadï¼ˆåŒ…å«è¦æ ¼è³‡è¨Šï¼Œä¾›æ¸…å–®é¡¯ç¤ºï¼‰
  const variantPayload = item?._variant
    ? { _variant: item._variant }
    : (vMode==='none' ? undefined : { _variant: { mode: vMode, sel1, sel2: vMode==='double' ? sel2 : undefined } });

  const setQ = (n)=> {
    const base = (mode==='cash')
      ? { name: item?.name || item?.title || 'ï¼ˆæœªå‘½åï¼‰', price: unitPrice, pts: null }
      : { name: item?.name || item?.title || 'ï¼ˆæœªå‘½åï¼‰', price: null, pts: unitPts };
    pick.setQty(id, { ...base, ...(variantPayload||{}) }, n);
  };

  // äº‹ä»¶åŒæ­¥ï¼ˆä¿éšªï¼šè‹¥çˆ¶å±¤æœªé‡æ–°å»ºç«‹ controlsItemï¼Œä¹Ÿèƒ½å³æ™‚å•Ÿç”¨ï¼‰
  React.useEffect(() => {
    const onPick = (e) => {
      const d = e?.detail || {};
      const key = baseKey;
      if (String(d.id) !== key) return;
      setVariantSignal(s => s + 1);
    };
    window.addEventListener('kjs:variant:picked', onPick);
    return () => window.removeEventListener('kjs:variant:picked', onPick);
  }, [baseKey]);

  const variantLabel = item?._variant
    ? (() => {
        const a = item._variant;
        if (a.mode==='single') return `${(a.attrs?.[0]?.name || 'è¦æ ¼')}ï¼š${a.sel1}`;
        if (a.mode==='double') return `${(a.attrs?.[0]?.name || 'è¦æ ¼1')}ï¼š${a.sel1} ï¼ ${(a.attrs?.[1]?.name || 'è¦æ ¼2')}ï¼š${a.sel2}`;
        return '';
      })()
    : (vMode==='none' ? '' : (vMode==='single' ? `è¦æ ¼ï¼š${sel1||'â€”'}` : `è¦æ ¼1ï¼š${sel1||'â€”'} ï¼ è¦æ ¼2ï¼š${sel2||'â€”'}`));

  return (
    <div className="sticky bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/90 backdrop-blur border-t border-slate-200 dark:border-slate-700 rounded-b-2xl px-3 py-2">
      {vMode!=='none' && !selectionReady && (
        <div className="mb-2 text-xs px-3 py-2 rounded-lg bg-amber-50 text-amber-800 border border-amber-200">
          è«‹å…ˆåœ¨ä¸Šæ–¹ã€Œé¸æ“‡è¦æ ¼ã€å€å¡Šå®Œæˆè¦æ ¼é¸æ“‡
        </div>
      )}

      <div className="flex items-center gap-2">
        <div className="flex items-center gap-2">
          <button className="tap-target rounded-lg border px-3.5 py-2.5 min-w-[48px]" disabled={!selectionReady} onClick={()=>setQ(Math.max(0,(qty||0)-1))}>ï¼</button>
          <input className="w-20 text-center rounded-lg border px-2 py-2" inputMode="numeric" value={qty||0} disabled={!selectionReady} onChange={e=>setQ(Math.max(0, Number(e.target.value)||0))}/>
          <button className="tap-target rounded-lg border px-3.5 py-2.5 min-w-[48px]" disabled={!selectionReady} onClick={()=>setQ((qty||0)+1)}>ï¼‹</button>
        </div>

        <button
          className={`ml-auto rounded-lg px-4 py-2.5 shadow-soft ${selectionReady ? 'bg-brand text-white' : 'bg-slate-300 text-white cursor-not-allowed'}`}
          disabled={!selectionReady}
          onClick={()=>{ if (!selectionReady) return; if ((qty||0) < 1) setQ(1); alert('âœ… å·²åŠ å…¥æ¸…å–®ï¼Œå¯åœ¨åº•éƒ¨ã€Œå®ŒæˆæŒ‘é¸ï¼è¤‡è£½æ¸…å–®ã€è¤‡è£½å‚³çµ¦ç®¡ç†å“¡'); }}
        >
          åŠ å…¥æ¸…å–®
        </button>
      </div>

      <div className="mt-1 text-xs text-slate-600 dark:text-slate-400 space-y-0.5">
        {variantLabel && <div>è¦æ ¼ï¼š{variantLabel}</div>}
        {mode==='cash' && (unitPrice!=null) && <div>å–®åƒ¹ï¼šNT$ {unitPrice}</div>}
        {mode==='pts'  && (unitPts!=null)   && <div>æ¯ä»¶éœ€ï¼š{unitPts} é»</div>}
        {remain!=null && <div>å‰©é¤˜ï¼š{remain}</div>}
      </div>
    </div>
  );
}

/* â”€â”€ ç›´æ¥è¦†è“‹åŸæœ¬çš„ usePickListï¼Œå…¨åŸŸåŒæ­¥ï¼‹å³æ™‚æ›´æ–°ï¼ˆæ”¯æ´è¤‡åˆ key èˆ‡ _variantï¼‰ â”€â”€ */
function usePickList(lsKey = 'kjs_picklist') {
  const React = window.React || globalThis.React;

  const read = () => {
    try { return JSON.parse(localStorage.getItem(lsKey) || "{}"); }
    catch { return {}; }
  };

  const [map, setMap] = React.useState(read);

  // å°è£ writeï¼šå¯«å…¥ LS å¾Œç™¼é€è‡ªå®šäº‹ä»¶ï¼Œè®“åŒé å…¶ä»– hook ä¹Ÿèƒ½å³æ™‚æ”¶åˆ°
  const write = (next) => {
    try { localStorage.setItem(lsKey, JSON.stringify(next)); } catch {}
    // åŒåˆ†é ï¼ˆåŒä¸€å€‹ tabï¼‰çš„å³æ™‚åŒæ­¥
    try { window.dispatchEvent(new CustomEvent('kjs:picklist:update', { detail: { key: lsKey } })); } catch {}
  };

  /**
   * è¨­å®šæ•¸é‡ï¼ˆ0 æˆ–ç©ºå€¼ = åˆªé™¤ï¼‰
   * keyï¼šå¯ç‚ºè¤‡åˆ keyï¼ˆä¾‹ï¼š<itemId>|<sel1>|<sel2>ï¼‰
   * payloadï¼š{ name, price?, pts?, _variant? }
   * ğŸ”§ è¡Œå‹•é«”é©—å„ªåŒ–ï¼š
   * - æ›´åš´æ ¼çš„æ•¸å€¼é˜²å‘†ï¼ˆéæ•¸å­— â†’ è¦–ç‚º 0ï¼‰
   * - ä¸Šé™å¾ 999 ä¸‹ä¿®ç‚º 199ï¼ˆé¿å…æ‰‹æ©Ÿèª¤è§¸ç‹‚åŠ ï¼‰
   */
  const setQty = (key, payload, qty) => {
    const k = String(key || '');
    if (!k) return;
    setMap(prev => {
      const next = { ...prev };
      const raw = Number.isFinite(+qty) ? +qty : 0;
      const safe = Math.max(0, Math.floor(raw || 0));
      if (safe <= 0) {
        delete next[k];
      } else {
        next[k] = {
          ...(prev[k] || {}),
          ...payload,
          qty: Math.min(199, safe)
        };
      }
      write(next);
      return next;
    });
  };

  // æ¸…ç©ºæ•´ä»½æ¸…å–®
  const clear = () => {
    setMap(() => {
      const empty = {};
      write(empty);
      return empty;
    });
  };

  // è·¨åˆ†é ï¼ˆæˆ–åŒåˆ†é å…¶ä»– hookï¼‰åŒæ­¥ï¼šstorage + è‡ªå®šäº‹ä»¶
  React.useEffect(() => {
    const onStorage = (e) => {
      if (e.key === lsKey) setMap(read());
    };
    const onCustom = (e) => {
      if (e?.detail?.key === lsKey) setMap(read());
    };
    window.addEventListener('storage', onStorage);
    window.addEventListener('kjs:picklist:update', onCustom);
    return () => {
      window.removeEventListener('storage', onStorage);
      window.removeEventListener('kjs:picklist:update', onCustom);
    };
  }, [lsKey]);

  const totalQty = Object.values(map).reduce((s, x) => s + (x?.qty || 0), 0);
  return { map, setQty, clear, totalQty };
}

/* ç”Ÿæˆæ–‡å­—æ¸…å–®ï¼ˆç¾é‡‘æˆ–é»æ•¸ï¼›è‹¥å¸¶è¦æ ¼æœƒé¡¯ç¤ºï¼‰ */
function buildListText(map, mode='cash') {
  const rows = [];
  let sumCash = 0, sumPts = 0;

  const labelOfVariant = (x) => {
    const v = x?._variant;
    if (!v) return '';
    const parts = [];
    if (v.sel1!=null && v.attrs?.[0]?.name) parts.push(`${v.attrs[0].name}: ${v.sel1||'-'}`);
    if (v.sel2!=null && v.attrs?.[1]?.name) parts.push(`${v.attrs[1].name}: ${v.sel2||'-'}`);
    return parts.length ? `ï¼ˆ${parts.join('ï½œ')}ï¼‰` : '';
  };

  for (const k of Object.keys(map||{})) {
    const x = map[k] || {};
    const spec = labelOfVariant(x);
    const { name, qty, price, pts } = x;
    const line = mode==='pts'
      ? `- ${name}${spec ? ' ' + spec : ''} x${qty}ï¼ˆ${pts ?? '?'} é»ï¼‰`
      : `- ${name}${spec ? ' ' + spec : ''} x${qty}ï¼ˆNT$ ${price ?? '?'}ï¼‰`;
    rows.push(line);
    if (mode==='pts' && Number.isFinite(+pts)) sumPts += (+pts)*(qty||0);
    if (mode==='cash' && Number.isFinite(+price)) sumCash += (+price)*(qty||0);
  }
  const head = mode==='pts' ? '[é»æ•¸å…Œæ›æ¸…å–®]' : '[è³¼ç‰©æ¸…å–®]';
  const tail = mode==='pts'
    ? (rows.length ? `\nåˆè¨ˆé»æ•¸ï¼šç´„ ${sumPts} é»` : '')
    : (rows.length ? `\né ä¼°é‡‘é¡ï¼šç´„ NT$ ${sumCash}` : '');
  return [head, ...rows, tail].filter(Boolean).join('\n');
}

// è¤‡è£½è¼”åŠ©ï¼ˆé›¢ç·šå¯ç”¨ï¼‰
async function copyText(s) {
  try { await navigator.clipboard.writeText(String(s)); return true; }
  catch { return false; }
}

/* =========================
* ğŸ§© TagFilterSheetï¼šæ¨™ç±¤æŒ‘é¸å½ˆçª—ï¼ˆæ–°å¢ï¼‰
* ========================= */
function TagFilterSheet({ open=false, onClose=()=>{}, groups=[], allTags=[], picked=[], onApply=()=>{} }) {
  const React = window.React || globalThis.React;
  if (!open) return null;

  // æœ¬åœ°æš«å­˜é¸æ“‡ï¼šæ‰“é–‹æ™‚æˆ–å¤–éƒ¨ picked è®ŠåŒ–æ™‚åŒæ­¥
  const [local, setLocal] = React.useState(()=> new Set(picked || []));
  React.useEffect(() => {
    if (open) setLocal(new Set(picked || []));
  }, [open, picked]);

  const toggle = (t) => setLocal(s => { const nx=new Set(s); nx.has(t)?nx.delete(t):nx.add(t); return nx; });
  const clearAll = ()=> setLocal(new Set());

  // ç¾¤çµ„ + å…¶ä»–ï¼ˆæœªåˆ†çµ„ï¼‰å‘ˆç¾ï¼›groups çš„é †åºèˆ‡æ¯çµ„ tags çš„é †åºçš†ä¿ç•™
  const grouped = React.useMemo(()=>{
    const normGroups = Array.isArray(groups) ? groups.map(g => ({
      name: g?.name || 'æœªå‘½åç¾¤çµ„',
      tags: Array.isArray(g?.tags) ? g.tags.filter(Boolean) : []
    })) : [];

    const inGroup = new Set(normGroups.flatMap(g => g.tags || []));
    const rest = (Array.isArray(allTags) ? allTags : []).filter(t => !inGroup.has(t));
    return [ ...normGroups, ...(rest.length ? [{ name: 'å…¶ä»–', tags: rest }] : []) ];
  }, [groups, allTags]);

  // Escape é—œé–‰ï¼ˆä¸å½±éŸ¿ä½ çš„åŸæ“ä½œï¼‰
  React.useEffect(() => {
    if (!open) return;
    const onKey = (e)=>{ if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open, onClose]);

  return (
    <div className="fixed inset-0 z-[1000]" role="dialog" aria-modal="true" aria-label="ç¯©é¸æ¨™ç±¤">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="absolute inset-0 flex items-end sm:items-center justify-center p-3">
        <div className="w-[min(96vw,720px)] max-h=[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl flex flex-col">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">ç¯©é¸æ¨™ç±¤</div>
            <div className="flex items-center gap-2">
              <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={clearAll}>æ¸…é™¤å…¨éƒ¨</button>
              <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
            </div>
          </div>

          <div className="p-3 overflow-y-auto space-y-3">
            {grouped.map((g,gi)=> (
              <div key={(g.name||'å…¶ä»–') + '_' + gi} className="rounded-xl border border-slate-200 dark:border-slate-700">
                <div className="px-3 py-2 font-medium">{g.name || 'æœªå‘½åç¾¤çµ„'}</div>
                <div className="px-3 pb-3 flex flex-wrap gap-2">
                  {(g.tags||[]).map(t => (
                    <button
                      key={t}
                      onClick={()=>toggle(t)}
                      className={
                        "tap-target rounded-full border px-3 py-1 text-sm " +
                        (local.has(t) ? "bg-brand text-white border-brand" : "bg-white/70 dark:bg-slate-900/60")
                      }
                    >
                      {t}
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="px-3 py-3 border-t border-slate-200 dark:border-slate-700 flex items-center gap-2">
            <div className="text-xs text-slate-500">å·²é¸ {local.size} å€‹æ¨™ç±¤</div>
            <button
              className="ml-auto rounded-lg bg-brand text-white px-4 py-2 text-sm"
              onClick={()=>{
                onApply(Array.from(local));
                onClose();
              }}
            >
              å¥—ç”¨
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


/* =========================
* â¬†ï¸ è¦†è“‹ï¼šæµ®å‹•æŒ‘é¸æ¢ï¼ˆé¿å…èˆ‡åº•éƒ¨å·¥å…·åˆ—é‡ç–Š + a11y + safe-area + portalï¼‰
* ========================= */
function FloatingPickbar({ count = 0, onOpen = () => {} }) {
  const React = window.React || globalThis.React;
  const ReactDOM = window.ReactDOM || globalThis.ReactDOM;

  if (!count) return null;

  const node = (
    <div
      className="floating-pickbar"
      // è‹¥å¤–å±¤æ²’è¨­ safe-areaï¼Œé€™è£¡è£œä¸€å±¤åº•éƒ¨å…§è·ï¼Œé¿å…è¢« iOS å°è¦½åˆ—åƒæ‰
      style={{ paddingBottom: 'calc(max(0px, env(safe-area-inset-bottom, 0px)) + 4px)' }}
    >
      <div className="mx-auto max-w-screen-sm rounded-xl2 shadow-elevate border border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/90 backdrop-blur p-2">
        <div className="flex items-center justify-between gap-3">
          {/* è®€å±å‹å–„ï¼šæ•¸é‡è®Šå‹•æœƒå³æ™‚æ’­å ± */}
          <div className="text-sm" role="status" aria-live="polite" aria-atomic="true">
            å·²æŒ‘é¸ <span className="font-semibold">{count}</span> é …
          </div>
          <button
            type="button"
            onClick={onOpen}
            className="tap-target rounded-lg bg-brand text-white px-4 py-2 text-sm min-h-[44px]"
            title="å®ŒæˆæŒ‘é¸ï¼è¤‡è£½æ¸…å–®"
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                onOpen();
              }
            }}
          >
            å®ŒæˆæŒ‘é¸ï¼è¤‡è£½æ¸…å–®
          </button>
        </div>
      </div>
    </div>
  );

  // è‹¥å¯ç”¨ Portalï¼Œæ›åˆ° bodyï¼Œé¿å…è¢«çˆ¶å±¤ overflow æˆªæ‰
  return (ReactDOM && typeof ReactDOM.createPortal === 'function')
    ? ReactDOM.createPortal(node, document.body)
    : node;
}


// æ¸…å–®ç¢ºèªå°è©±æ¡†ï¼ˆä¿ç•™ä»£è™Ÿï¼Œä½†ä»¥äººæ€§åŒ–æ–¹å¼å‘ˆç¾ï¼‰
function ConfirmListDialog({ open, onClose, map, mode = 'cash', onSetQty }) {
  const React = window.React || globalThis.React;
  if (!open) return null;

  const keys = React.useMemo(() => Object.keys(map || {}), [map]);

  // å‹¾é¸ç‹€æ…‹ï¼šå°æ‡‰ keys è®Šå‹•æ™‚åŒæ­¥ï¼ˆæ–°é …ç›®é»˜èªå‹¾é¸ï¼‰
  const [checked, setChecked] = React.useState({});
  React.useEffect(() => {
    setChecked(prev => {
      const next = { ...prev };
      Object.keys(next).forEach(k => { if (!keys.includes(k)) delete next[k]; });
      keys.forEach(k => { if (!(k in next)) next[k] = true; });
      return next;
    });
  }, [keys]);

  const toggle = (k) => setChecked((c) => ({ ...c, [k]: !c[k] }));
  const qtyOf  = (k) => (map?.[k]?.qty || 0);
  const setQtySafe = (k, n) => {
    const nx = Number.isFinite(+n) ? Math.max(0, Math.floor(+n)) : 0;
    onSetQty?.(k, map?.[k] || {}, nx);
  };

  // ---------- è¦æ ¼/åç¨±è¼”åŠ© ----------
  const getVariantInfo = (x) => {
    const v = x?._variant || x?.variant || null;
    if (!v) return { suffix: '', named: '' };
    const names = Array.isArray(v?.attrs) ? v.attrs.map(a => a?.name || '') : [];
    const v1 = v?.sel1 ?? v?.v1 ?? v?.first ?? v?.attr1 ?? null;
    const v2 = v?.sel2 ?? v?.v2 ?? v?.second ?? v?.attr2 ?? null;
    const parts = [v1, v2].filter(Boolean);
    const suffix = parts.length ? parts.join('ï¼') : '';
    const named  = parts.length
      ? parts.map((val, i) => `${names[i] || `è¦æ ¼${i+1}`}:${val}`).join(' ãƒ» ')
      : '';
    return { suffix, named };
  };

  // é¡¯ç¤ºå‹å–„ä½†ä»ä¿ç•™ä»£è™Ÿï¼šæŠ½å‡ºä»£è™Ÿï¼ˆæ”¾å¾½ç« ï¼‰ã€ä¸»æ¨™åªé¡¯ç¤ºç´”åç¨±
  const splitCodeFromName = (raw = '') => {
    const s = String(raw || '');
    // å…è¨±æ ¼å¼ï¼šF006: xxxã€F006ï¼šxxxã€ABC-01 xxx ç­‰ï¼›ç›¡é‡åªæŠ½å‰ç¶´
    const m = s.match(/^\s*([A-Za-z]\w{1,7}(?:[-_]\w{1,6})?)\s*[:ï¼š]?\s*(.+)$/);
    if (m) return { code: m[1], title: m[2] };
    return { code: '', title: s };
  };

  const withVariantSuffix = (name, x) => {
    const { suffix } = getVariantInfo(x);
    if (!suffix) return name || '';
    const s = String(name || '');
    const marker = `ï¼ˆ${suffix}ï¼‰`;
    return s.includes(marker) ? s : `${s}${marker}`;
  };

  // ç”¢ç”Ÿå¯è¤‡è£½æ–‡å­—ï¼ˆå«åˆè¨ˆï¼‰â€” ç”¨ã€ŒåŸå§‹ nameã€ï¼ˆå«ä»£è™Ÿï¼‰ï¼Œä¸æ”¹è³‡æ–™
  const buildListText = (m) => {
    const rows = [];
    let sumCash = 0, sumPts = 0;
    for (const k of Object.keys(m)) {
      const it = m[k] || {};
      const { name, qty, price, pts } = it;
      if (!qty) continue;
      const label = withVariantSuffix(name, it);
      const line = mode === 'pts'
        ? `- ${label} x${qty}ï¼ˆ${pts ?? '?'} é»ï¼‰`
        : `- ${label} x${qty}ï¼ˆNT$ ${price ?? '?'})`;
      rows.push(line);
      if (mode === 'pts'  && Number.isFinite(+pts))   sumPts  += (+pts)   * qty;
      if (mode === 'cash' && Number.isFinite(+price)) sumCash += (+price) * qty;
    }
    const head = mode === 'pts' ? '[é»æ•¸å…Œæ›æ¸…å–®]' : '[è³¼ç‰©æ¸…å–®]';
    const tail = mode === 'pts'
      ? (rows.length ? `\nåˆè¨ˆé»æ•¸ï¼šç´„ ${sumPts} é»` : '')
      : (rows.length ? `\né ä¼°é‡‘é¡ï¼šç´„ NT$ ${sumCash}` : '');
    return [head, ...rows, tail].filter(Boolean).join('\n');
  };

  // åªå–å·²å‹¾é¸çš„é …ç›®
  const listMap = keys.filter(k => checked[k]).reduce((o, k) => (o[k] = map[k], o), {});
  const { sumCash, sumPts } = React.useMemo(() => {
    let sc = 0, sp = 0;
    for (const k of Object.keys(listMap)) {
      const it = listMap[k] || {};
      const qty = it.qty || 0;
      if (mode === 'cash' && Number.isFinite(+it.price)) sc += (+it.price) * qty;
      if (mode === 'pts'  && Number.isFinite(+it.pts))   sp += (+it.pts)   * qty;
    }
    return { sumCash: sc, sumPts: sp };
  }, [listMap, mode]);

  const nf   = React.useMemo(() => new Intl.NumberFormat('zh-TW'), []);
  const text = buildListText(listMap);

  return (
    <div className="fixed inset-0 z-[1000]" role="dialog" aria-modal="true">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="sheet-w w-[min(560px,96vw)] max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl flex flex-col">
          {/* Header */}
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">{mode === 'pts' ? 'é»æ•¸å…Œæ›æ¸…å–®' : 'è³¼ç‰©æ¸…å–®'}</div>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
          </div>

          {/* æ¸…å–®å…§å®¹ï¼ˆè¡Œå‹•å‹å–„ï¼‰ */}
          <div className="p-3 overflow-y-auto max-h-[calc(86vh-148px)] space-y-3 modal-scroll">
            {keys.length === 0 ? (
              <div className="text-sm text-slate-500">å°šæœªæŒ‘é¸ä»»ä½•å•†å“</div>
            ) : (
              keys.map((k) => {
                const x = map[k] || {};
                const qty = qtyOf(k) || 0;

                // UIï¼šæŠ½å‡ºä»£è™Ÿé¡¯ç¤ºå¾½ç« ï¼›ä¸»æ¨™åªæ”¾ç´”åç¨±
                const { code, title } = splitCodeFromName(String(x.name || ''));
                const shownTitle = splitCodeFromName(withVariantSuffix(x.name, x)).title; // è¦æ ¼çºŒæ¥åˆ°åç¨±ï¼ˆé¡¯ç¤ºï¼‰

                const vNamed = (getVariantInfo(x)?.named || ""); // ç°å­—ä¸€è¡Œ
                const subtotal =
                  mode === 'pts'
                    ? (Number.isFinite(+x.pts)   ? (+x.pts)   * qty : null)
                    : (Number.isFinite(+x.price) ? (+x.price) * qty : null);

                return (
                  <div
                    key={k}
                    className="rounded-xl border border-slate-200 dark:border-slate-700 p-3 bg-white/90 dark:bg-slate-900/70"
                  >
                    <div className="flex items-start gap-2">
                      <input
                        type="checkbox"
                        className="mt-1.5 h-5 w-5 shrink-0"
                        checked={!!checked[k]}
                        onChange={() => toggle(k)}
                        aria-label="é¸å–æ­¤é …"
                      />

                      <div className="min-w-0 flex-1">
                        <div className="flex items-start gap-2">
                          <div className="min-w-0 flex-1">
                            {/* ä¸»æ¨™ï¼šç´”åç¨±ï¼ˆå«è¦æ ¼å¾Œç¶´ï¼‰ï¼Œä¸æˆªæ–· */}
                            <div className="text-[15px] leading-5 font-medium break-words">{shownTitle}</div>
                            {/* è¦æ ¼ç°å­—ï¼še.g. å°ºå¯¸ï¼šå¤§ ãƒ» é¡è‰²ï¼šé»ƒè‰² */}
                            {vNamed && (
                              <div className="mt-0.5 text-xs text-slate-500 break-words">{vNamed}</div>
                            )}
                            {/* å–®åƒ¹ Ã— æ•¸é‡ï¼ˆæ›´ç›´è¦ºï¼‰ */}
                            <div className="mt-1 text-xs text-slate-600 dark:text-slate-400">
                              {mode === 'pts'
                                ? `å–®åƒ¹ ${x.pts ?? '?'} é» / ä»¶ã€€Ã—ã€€${qty}`
                                : `å–®åƒ¹ NT$ ${x.price ?? '?'} / ä»¶ã€€Ã—ã€€${qty}`}
                            </div>
                          </div>

                          {/* ä»£è™Ÿå¾½ç« ï¼šä¿ç•™ä»£è™Ÿä½†ä¸æ¶ç‰ˆé¢ */}
                          {code && (
                            <span className="shrink-0 px-2 py-0.5 text-[11px] rounded-full border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                              {code}
                            </span>
                          )}
                        </div>

                        {/* æ­¥é€²å™¨ + å°è¨ˆ + åˆªé™¤ */}
                        <div className="mt-2 flex items-center gap-2">
                          <div className="flex items-center gap-1.5">
                            <button
                              className="tap-target rounded border px-3 py-2 min-w-[44px] min-h-[44px]"
                              onClick={() => setQtySafe(k, qty - 1)}
                              aria-label="æ¸›å°‘æ•¸é‡"
                            >ï¼</button>
                            <input
                              className="w-16 text-center rounded border px-2 py-2"
                              inputMode="numeric"
                              value={qty}
                              onChange={(e) => setQtySafe(k, e.target.value)}
                              aria-label="æ•¸é‡"
                            />
                            <button
                              className="tap-target rounded border px-3 py-2 min-w-[44px] min-h-[44px]"
                              onClick={() => setQtySafe(k, qty + 1)}
                              aria-label="å¢åŠ æ•¸é‡"
                            >ï¼‹</button>
                          </div>

                          <div className="ml-auto text-right">
                            <div className="text-xs text-slate-500">å°è¨ˆ</div>
                            <div className="text-[15px] font-semibold">
                              {mode === 'pts'
                                ? (subtotal != null ? `${subtotal} é»` : 'â€”')
                                : (subtotal != null ? `NT$ ${nf.format(subtotal)}` : 'â€”')}
                            </div>
                          </div>

                          <button
                            className="tap-target rounded border px-3 py-2 text-sm"
                            onClick={() => setQtySafe(k, 0)}
                            aria-label="åˆªé™¤é€™å€‹é …ç›®"
                            title="åˆªé™¤"
                          >ğŸ—‘</button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* åˆè¨ˆå€å¡Š */}
          <div className="px-3 py-2 border-t border-slate-200 dark:border-slate-700 text-right text-sm font-semibold">
            {mode === 'cash'
              ? <>ç¸½é‡‘é¡ï¼šNT$ {nf.format(sumCash)}</>
              : <>åˆè¨ˆé»æ•¸ï¼šç´„ {nf.format(sumPts)} é»</>}
          </div>

          {/* å‹•ä½œåˆ— */}
          <div className="p-3 border-t border-slate-200 dark:border-slate-700 flex items-center gap-2">
            <button
              className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm tap-target"
              onClick={async () => {
                try {
                  await navigator.clipboard.writeText(text);
                  alert('âœ… å·²è¤‡è£½æ¸…å–®ï¼Œè«‹è²¼åˆ°å®˜æ–¹ LINE å¸³è™Ÿè¯çµ¡ç®¡ç†å“¡ç¢ºèªã€‚');
                  onClose();
                } catch {
                  alert('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ï¼š\n\n' + text);
                }
              }}
            >
              è¤‡è£½æ¸…å–®
            </button>
            <button className="rounded-lg border px-3 py-2 text-sm tap-target" onClick={onClose}>å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  );
}



// ç¤¾ç¾¤å•†åº—ï¼ˆç¾é‡‘è³¼è²·ï¼‰â€” ã€Œæœå°‹æ”¹æ¨™ç±¤ã€ï¼‹ã€Œä¸€éµè³¼ç‰©æ¸…å–®ã€ï¼Œä¹/åå…­å®®æ ¼ä¿ç•™
function Store({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  const prefKey = "store_prefs_v5";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9");
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);

  // â˜… æ–°å¢ï¼šç‹€æ…‹ç¯©é¸ï¼ˆå…¨éƒ¨/ç¾è²¨/é å”®ï¼‰â€” å–ä»£ã€Œåªçœ‹æœ‰è²¨ã€
  // å€¼ï¼šall | instock | presale
  const [statusFilter, setStatusFilter] = React.useState(loadPrefs().statusFilter || "all");

  const [page, setPage] = React.useState(1);
  React.useEffect(() => savePrefs({ view }), [view]);
  React.useEffect(() => savePrefs({ pageSize }), [pageSize]);
  React.useEffect(() => savePrefs({ statusFilter }), [statusFilter]);

  const [showEditor, setShowEditor] = React.useState(false);
  const HasStoreEditor = typeof StoreEditor === "function";

  const [sheet, setSheet] = React.useState({ open: false, item: null });

  // â˜… æ¨™ç±¤å°å¡
  const [tagSheetOpen, setTagSheetOpen] = React.useState(false);
  const tagGroups = Array.isArray(data?.store?.tagGroups) ? data.store.tagGroups : [];

  const safeNumber = (v) => {
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) return +v;
    return null;
  };
  const getRemain = (x) => [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find((n) => n != null);

  const itemsRaw = Array.isArray(data?.store?.items) ? data.store.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : it?.image ? [String(it.image)] : [];
    const tags = Array.isArray(it?.tags)
      ? it.tags
      : typeof it?.tags === "string"
      ? it.tags.split(",").map((s) => s.trim()).filter(Boolean)
      : [];
    return { ...it, _images: images.filter(Boolean), _tags: tags };
  };
  const allItems = React.useMemo(() => itemsRaw.map(normalizeItem), [itemsRaw]);

  const allTags = React.useMemo(() => collectUniqueTags(allItems, "_tags"), [allItems]);

  const tagsOrdered = React.useMemo(
    () => orderTagsByGroups(allTags, tagGroups),
    [allTags, tagGroups]
  );
  const tag = useTagFilter(allTags);

  const [sortBy, setSortBy] = React.useState("latest");

  // â˜… ç‹€æ…‹ç¯©é¸ï¼šä¾ availabilityï¼ˆç¾è²¨/é å”®ï¼‰éæ¿¾
  const filtered = React.useMemo(() => {
    return allItems.filter((x) => {
      const okTag = !tag.picked.length || tag.picked.every((t) => (x._tags || []).includes(t));

      const availability = typeof x?.availability === "string" ? x.availability.trim() : "";
      const okStatus =
        statusFilter === "all"
          ? true
          : statusFilter === "instock"
          ? availability === "ç¾è²¨"
          : statusFilter === "presale"
          ? availability === "é å”®"
          : true;

      return okTag && okStatus;
    });
  }, [allItems, tag.picked, statusFilter]);

  const sorted = React.useMemo(() => {
    const arr = [...filtered];
    if (sortBy === "priceAsc") arr.sort((a, b) => (+a?.price || Infinity) - (+b?.price || Infinity));
    else if (sortBy === "priceDesc") arr.sort((a, b) => (+b?.price || -Infinity) - (+a?.price || -Infinity));
    else arr.sort((a, b) => new Date(b?.updatedAt || b?.createdAt || 0) - new Date(a?.updatedAt || a?.createdAt || 0));
    return arr;
  }, [filtered, sortBy]);

  const total = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(() => { if (page > maxPage) setPage(maxPage); }, [maxPage, page]);

  // â˜… ç¯©é¸/æ’åº/ç‰ˆé¢/æ¯é /ç‹€æ…‹è®Šå‹• â†’ å›åˆ°ç¬¬ 1 é 
  React.useEffect(() => { setPage(1); }, [tag.picked, sortBy, view, pageSize, statusFilter]);

  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize / 2), maxPage - windowSize + 1));
  const endPage = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems = sorted.slice(start, end);

  // âœ… 9/16 å®®æ ¼ â†’ æ‰‹æ©Ÿå›ºå®š 2 æ¬„ï¼›è¼ƒå¤§å°ºå¯¸ä¾é¸é …å±•é–‹
  const gridCols =
    view === "grid16"
      ? "grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-6"
      : "grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-5";

  const pick = usePickList("kjs_store_picklist");
  const [showConfirm, setShowConfirm] = React.useState(false);

  // â˜… æ‰‹æ©Ÿå‹å–„ï¼šä¸‰æ®µå¼ç‹€æ…‹åˆ‡æ›ï¼ˆå…¨éƒ¨/ç¾è²¨/é å”®ï¼‰ï¼Œé»æ“Šå€åŠ å¤§ã€å¯æ›è¡Œ
  const StatusSegment = () => {
    const base =
      "tap-target rounded-lg px-3 py-2 text-sm whitespace-nowrap min-h-[44px] " +
      "transition-colors";
    const wrap =
      "flex items-center gap-1 rounded-xl border border-slate-200 dark:border-slate-700 " +
      "bg-white/70 dark:bg-slate-900/60 p-1";
    const on = "bg-brand text-white border-brand";
    const off = "bg-transparent";

    return (
      <div className={wrap} role="tablist" aria-label="è²©å”®ç‹€æ…‹ç¯©é¸">
        <button
          type="button"
          className={base + " " + (statusFilter === "all" ? on : off)}
          onClick={() => setStatusFilter("all")}
          role="tab"
          aria-selected={statusFilter === "all"}
          title="é¡¯ç¤ºå…¨éƒ¨ï¼ˆç¾è²¨ï¼‹é å”®ï¼‰"
        >
          å…¨éƒ¨
        </button>
        <button
          type="button"
          className={base + " " + (statusFilter === "instock" ? on : off)}
          onClick={() => setStatusFilter("instock")}
          role="tab"
          aria-selected={statusFilter === "instock"}
          title="åªé¡¯ç¤ºç¾è²¨"
        >
          ç¾è²¨
        </button>
        <button
          type="button"
          className={base + " " + (statusFilter === "presale" ? on : off)}
          onClick={() => setStatusFilter("presale")}
          role="tab"
          aria-selected={statusFilter === "presale"}
          title="åªé¡¯ç¤ºé å”®"
        >
          é å”®
        </button>
      </div>
    );
  };

  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="game-controls flex flex-wrap items-center gap-2">
        {/* <TagChips tags={tagsOrdered} picked={tag.picked} onToggle={tag.toggle} onClear={tag.clear} /> */}
        <button className="tap-target rounded-lg border px-3 py-2 min-h-[44px]" onClick={() => setTagSheetOpen(true)}>
          {tag.picked.length > 0 ? `ç¯©é¸æ¨™ç±¤ï¼ˆ${tag.picked.length}ï¼‰` : "ç¯©é¸æ¨™ç±¤"}
        </button>

        <select className="tap-target rounded border px-2 py-2 min-h-[44px]" value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
          <option value="latest">æœ€æ–°æ›´æ–°</option>
          <option value="priceAsc">åƒ¹æ ¼ï¼ˆä½â†’é«˜ï¼‰</option>
          <option value="priceDesc">åƒ¹æ ¼ï¼ˆé«˜â†’ä½ï¼‰</option>
        </select>

        {/* â˜… æ–°å¢ï¼šç‹€æ…‹ç¯©é¸ï¼ˆå–ä»£åªçœ‹æœ‰è²¨ï¼‰ */}
        <StatusSegment />

        <label className="flex items-center gap-1">
          ç‰ˆé¢
          <select className="tap-target rounded border px-2 py-2 min-h-[44px]" value={view} onChange={(e) => setView(e.target.value)}>
            <option value="grid9">9 å®®æ ¼</option>
            <option value="grid16">16 å®®æ ¼</option>
          </select>
        </label>

        <label className="flex items-center gap-1">
          æ¯é 
          <select className="tap-target rounded border px-2 py-2 min-h-[44px]" value={pageSize} onChange={(e) => setPageSize(+e.target.value || 20)}>
            <option value="20">20</option>
            <option value="40">40</option>
            <option value="80">80</option>
          </select>
        </label>

        <div className="grow basis-full sm:basis-auto" />
        {admin && HasStoreEditor && (
          <button className="tap-target rounded-lg border px-3 py-2 min-h-[44px]" onClick={() => setShowEditor(true)}>ç®¡ç†</button>
        )}
      </div>
    </div>
  );

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>ä¸Šä¸€é </button>
      {Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i).map((p) => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p === page ? "bg-brand text-white border-brand" : ""}`} onClick={() => setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page >= maxPage} onClick={() => setPage((p) => Math.min(maxPage, p + 1))}>ä¸‹ä¸€é </button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      <div className={`grid ${gridCols} gap-3`} aria-label="ç¤¾ç¾¤å•†åº—æ¸…å–®">
        {pageItems.map((x, i) => {
          const id = x.id || i;
          const name = x?.name || "ï¼ˆæœªå‘½åï¼‰";
          const price = (x?.price ?? "") !== "" ? +x.price : null;
          const cover = Array.isArray(x._images) && x._images.length > 0 ? x._images[0] : "";
          const remain = getRemain(x);

          // â˜…â˜…â˜…â˜…â˜… ç‹€æ…‹å¾½ç« ï¼ˆåƒ… Store ä½¿ç”¨ï¼‰â€”â€” ä¾ availability é¡¯ç¤ºã€Œç¾è²¨ï¼é å”®ã€
          const availability = typeof x?.availability === "string" ? x.availability.trim() : "";
          const showBadge = availability === "ç¾è²¨" || availability === "é å”®";
          const badgeClass =
            availability === "ç¾è²¨"
              ? "bg-emerald-600 text-white"
              : "bg-amber-500 text-white";

          return (
            <div key={id} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none flex flex-col">
              {/* åœ–ç‰‡ï¼é»æ“Šé–‹è©³æƒ… */}
              <button className="block w-full textå·¦ p-3 pb-2" onClick={() => setSheet({ open: true, item: x })} title={name}>
                <div className="relative aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                  {/* å·¦ä¸Šè§’ç‹€æ…‹å¾½ç« ï¼ˆç¾è²¨ï¼é å”®ï¼‰ */}
                  {showBadge && (
                    <span
                      className={
                        "pointer-events-none absolute left-2 top-2 z-[1] rounded-full px-2.5 py-1 text-xs font-medium shadow-soft " +
                        badgeClass
                      }
                      aria-hidden="true"
                    >
                      {availability}
                    </span>
                  )}

                  {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
                </div>
              </button>

              {/* åç¨± / æ¨™ç±¤ï¼ˆè¦†è“‹å¾Œï¼‰ */}
              {(() => {
                const displayName = getShownTitle(x);         // é¡¯ç¤ºï¼šç´”åç¨±ï¼ˆéš±è—ä»£ç¢¼ï¼‰
                const fullName    = String(x?.name || "");     // æç¤ºï¼šå®Œæ•´åç¨±ï¼ˆå«ä»£ç¢¼ï¼‰
                return (
                  <button
                    className="px-3 text-left"
                    onClick={() => setSheet({ open: true, item: x })}
                    title={fullName}
                  >
                    <div className="text-[13px] font-medium truncate">{displayName || 'ï¼ˆæœªå‘½åï¼‰'}</div>
                    {Array.isArray(x._tags) && x._tags.length > 0 && (
                      <div className="text-xs text-slate-500 truncate">{x._tags.join(" / ")}</div>
                    )}
                  </button>
                );
              })()}

              {/* åƒ¹æ ¼ / åº«å­˜ */}
              <div className="px-3 pt-2 pb-1">
                <div className="text-sm font-semibold tabular-nums">
                  {price != null ? `NT$ ${price}` : "ã€€"}
                  {remain != null && <span className="ml-2 text-xs font-normal text-slate-500">å‰©é¤˜ï¼š{remain}</span>}
                </div>
              </div>

              {/* åº•éƒ¨å‹•ä½œåˆ—ï¼šçµ±ä¸€å³ä¸‹ã€Œå±•é–‹è©³æƒ…ã€ */}
              <div className="px-3 pb-3 mt-auto flex justify-end">
                {(() => {
                  const displayName = getShownTitle(x);
                  return (
                    <button
                      type="button"
                      className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={() => setSheet({ open: true, item: x })}
                      aria-label={`å±•é–‹ ${displayName || 'æ­¤å•†å“'} è©³æƒ…`}
                    >
                      å±•é–‹è©³æƒ…
                    </button>
                  );
                })()}
              </div>
            </div>
          );
        })}
      </div>

      <Paginator />

      {admin && HasStoreEditor && showEditor && (
        <StoreEditor data={data} setData={setData} onClose={() => setShowEditor(false)} />
      )}

      {/* è©³æƒ…å½ˆçª—ï¼ˆä¿ç•™ï¼‰ */}
      <ProductSheet open={sheet.open} item={sheet.item} context="store" onClose={() => setSheet({ open: false, item: null })} />

      {/* æµ®å‹•æ¸…å–®æ¢ï¼‹ç¢ºèªæ¸…å–®ï¼ˆä¿ç•™ï¼‰ */}
      <FloatingPickbar count={pick.totalQty} onOpen={() => setShowConfirm(true)} />
      <ConfirmListDialog open={showConfirm} onClose={() => setShowConfirm(false)} map={pick.map} mode="cash" onSetQty={(k, p, n) => pick.setQty(k, p, n)} />

      {/* æ¨™ç±¤å°å¡ï¼ˆä¿ç•™ï¼‰ */}
      <TagFilterSheet
        open={tagSheetOpen}
        onClose={() => setTagSheetOpen(false)}
        groups={tagGroups}
        allTags={allTags}
        picked={tag.picked}
        onApply={(list) => tag.setPicked(list)}
      />

      {/* é¿å…è¢«åº•éƒ¨æŒ‘é¸æ¢é®ä½çš„ç©ºç™½å€ */}
      {pick.totalQty > 0 && <div className="pickbar-spacer" />}
    </section>
  );
}



/* =========================
 * å“åå‰ç¶´ä»£ç¢¼ â†’ ç´”åç¨± æ‹†è§£å·¥å…·
 * ä¾‹ï¼š
 *  A0001: æ°¸ç”ŸèŠ± â†’ { code:"A0001", title:"æ°¸ç”ŸèŠ±" }
 *  F0003-è Ÿç­†å°æ–° â†’ { code:"F0003", title:"è Ÿç­†å°æ–°" }
 *  C0002 10000æ¯«å®‰ â†’ { code:"C0002", title:"10000æ¯«å®‰" }
 * ç„¡ä»£ç¢¼æ™‚ï¼šcode=""ï¼Œtitle=åŸå­—ä¸²
 * ========================= */
function splitCodeFromName(raw) {
  const s = String(raw || "").trim();
  // æ”¯æ´åˆ†éš”ï¼šç©ºç™½ / å†’è™Ÿ(:ã€ï¼š) / ç ´æŠ˜è™Ÿ(-ã€â€“ã€â€”)
  // ä»£ç¢¼æ¨£å¼ï¼šè‹±æ–‡å­—æ¯é–‹é ­ + è‹±æ•¸
  const m = s.match(/^(?<code>[A-Za-z][A-Za-z0-9]{1,10})\s*(?:[:ï¼š\-â€“â€”]\s*|\s+)(?<title>.+)$/);
  if (m && m.groups) {
    return { code: (m.groups.code || "").trim(), title: (m.groups.title || "").trim() };
  }
  return { code: "", title: s };
}

/* å–å¾—å‰å°é¡¯ç¤ºåç¨±ï¼ˆæŠŠä»£ç¢¼æ‹¿æ‰ï¼‰ */
function getShownTitle(item) {
  const rawName = String(item?.name || "");
  return splitCodeFromName(rawName).title;
}

/* =========================
 * å•†å“æ¸…å–®å¡ç‰‡ï¼ˆè¦†è“‹ç‰ˆï¼‰
 * ========================= */
function StoreCard({ item }) {
  const images = Array.isArray(item?.images) ? item.images.filter(Boolean) : [];
  const thumb = images[0] || '';

  // é¡¯ç¤ºç”¨ï¼šç´”åç¨±ï¼ˆè‡ªå‹•éš±è—ä»£ç¢¼ï¼‰
  const shownName = getShownTitle(item);
  // æç¤ºç”¨ï¼šå®Œæ•´åç¨±ï¼ˆå«ä»£ç¢¼ï¼‰ï¼Œæ»‘é¼  hover æœƒçœ‹åˆ°
  const fullName = item?.name || '';

  return (
    <CardCollapse
      summary={
        <div className="p-3 space-y-2">
          <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
            {thumb
              ? <img src={thumb} alt="" className="w-full h-full object-contain" loading="lazy" />
              : <div className="w-full h-full flex items-center justify-center text-slate-400">ç„¡åœ–</div>}
          </div>
          <div className="flex items-center justify-between gap-2">
            <div className="min-w-0">
              {/* é¡¯ç¤ºç´”åç¨±ï¼›title æç¤ºé¡¯ç¤ºå®Œæ•´ï¼ˆå«ä»£ç¢¼ï¼‰ */}
              <div className="font-medium truncate" title={fullName}>
                {shownName || 'ï¼ˆæœªå‘½åï¼‰'}
              </div>
              {Array.isArray(item?.tags) && item.tags.length>0 && (
                <div className="text-xs text-slate-500 truncate" title={item.tags.join(' / ')}>
                  {item.tags.join(' / ')}
                </div>
              )}
            </div>
            {(item?.price ?? '') !== '' && (
              <div className="shrink-0 font-semibold">{String(item.price)}</div>
            )}
          </div>
        </div>
      }
    >
      {/* è©³ç´°å…§å®¹ï¼ˆå±•é–‹å¾Œæ‰é¡¯ç¤ºï¼‰ */}
      <div className="space-y-3">
        {/* åœ–ç‰‡è¼ªæ’­ï¼ˆç¸®åœ–åˆ‡æ›ï¼‰ */}
        {images.length > 0 && <ImageStrip images={images} alt={shownName || 'å•†å“åœ–ç‰‡'} />}

        {/* ä»‹ç´¹æ–‡å­— */}
        {item?.desc && (
          <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
            {item.desc}
          </p>
        )}

        {/* æ“ä½œåˆ— */}
        <div>
          {item?.buyUrl ? (
            <a
              href={item.buyUrl}
              target="_blank" rel="noopener noreferrer"
              className="inline-flex items-center justify-center w-full rounded-lg bg-brand text-white px-4 py-2 text-sm shadow-soft"
              title="å‰å¾€è³¼è²·"
            >
              å‰å¾€è³¼è²·
            </a>
          ) : (
            <button
              disabled
              className="inline-flex items-center justify-center w-full rounded-lg border px-4 py-2 text-sm text-slate-400"
              title="å°šæœªæä¾›è³¼è²·é€£çµ"
            >
              å°šæœªæä¾›è³¼è²·é€£çµ
            </button>
          )}
        </div>
      </div>
    </CardCollapse>
  );
}

/* ç°¡æ˜“åœ–ç‰‡ç¸®åœ–å¸¶åˆ‡æ›ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰ */
function ImageStrip({ images = [], alt = '' }) {
  const [idx, setIdx] = React.useState(0);
  const main = images[idx] || images[0] || '';
  return (
    <div className="space-y-2">
      {/* å¤§åœ–é è¦½ */}
      <div className="rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800">
        {main
          ? <img src={main} alt={alt} className="w-full h-auto object-cover" loading="lazy" />
          : <div className="w-full aspect-[4/3] flex items-center justify-center text-slate-400">ç„¡åœ–ç‰‡</div>}
      </div>

      {/* ç¸®åœ–ï¼šGrid ç‰ˆï¼Œè‡ªå‹•æ›è¡Œ */}
      {images.length > 1 && (
        <div className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          {images.map((src, i) => (
            <button
              key={src + i}
              onClick={() => setIdx(i)}
              className={
                "w-full aspect-square rounded-lg overflow-hidden border " +
                (i === idx ? "border-brand ring-2 ring-brand/50" : "border-slate-200 dark:border-slate-700")
              }
              title={`åœ–ç‰‡ ${i + 1}`}
            >
              <img src={src} alt="" className="w-full h-full object-cover" loading="lazy" />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}


/*********************************
 * ğŸ›’ å•†åº—ç·¨è¼¯å™¨ï¼ˆAdmin å°ˆç”¨ï¼‰â€” è¦æ ¼ç‰ˆ
 * - å¤šåœ–ï¼šä¸€è¡Œä¸€å¼µ URL
 * - åŒ¯å‡º CSVï¼šå« images é™£åˆ—ï¼ˆä»¥ | ä¸²æ¥ï¼‰
 *********************************/
function StoreEditor({ data, setData, onClose }) {
  const React = window.React || globalThis.React;

  const items = Array.isArray(data?.store?.items) ? data.store.items : [];
  const [drafts, setDrafts] = React.useState(() => items.map(cloneStoreItem));
  const [filter, setFilter] = React.useState('');

  // â˜… æ–°å¢ï¼šç¾¤çµ„ç‹€æ…‹ï¼ˆåˆå§‹åŒ–è‡ª data.store.tagGroupsï¼‰
  const [groupsState, setGroupsState] = React.useState(() =>
    Array.isArray(data?.store?.tagGroups)
      ? data.store.tagGroups.map(g => ({ name: g?.name || '', tags: Array.isArray(g?.tags) ? [...g.tags] : [] }))
      : []
  );
  // â˜… å‹•æ…‹è’é›†å…¨éƒ¨æ¨™ç±¤ï¼ˆæä¾›çµ¦ç¾¤çµ„ç·¨è¼¯å™¨ï¼‰
  const allTags = React.useMemo(() => normalizeAllTagsFromItems(drafts), [drafts]);

  // â˜… æ–°å¢ï¼šè¦æ ¼ç·¨è¼¯ Modal æ§åˆ¶
  const [variantEditId, setVariantEditId] = React.useState(null);

  function cloneStoreItem(it = {}) {
    return {
      id: it.id || nid(),
      name: it.name || '',
      price: it.price ?? '',
      stock: it.stock ?? '',
      desc: it.desc || it.intro || '',
      images: Array.isArray(it.images) ? it.images.filter(Boolean) : [],
      imagesText: Array.isArray(it.images) ? it.images.join('\n') : '',
      buyUrl: it.buyUrl || '',
      tags: Array.isArray(it.tags) ? it.tags.filter(Boolean) : [],
      availability: it.availability || 'ç¾è²¨',
      // è¦æ ¼æ²¿ç”¨
      variants: it.variants ? { ...it.variants } : undefined,
    };
  }

  const filtered = filter
    ? drafts.filter(it =>
        matchText(it.name, filter) ||
        matchText(it.desc, filter) ||
        (Array.isArray(it.tags) && it.tags.some(t => matchText(t, filter)))
      )
    : drafts;

  const up = (id, field, value) => {
    setDrafts(d => d.map(x => (x.id === id ? { ...x, [field]: value } : x)));
  };

  const upMany = (id, patch) => {
    setDrafts(d => d.map(x => (x.id === id ? { ...x, ...patch } : x)));
  };

  const remove = id => {
    if (!confirmKeyword({ label: 'ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿæ‰“ã€Œåˆªé™¤ã€ç¢ºèª', keyword: 'åˆªé™¤' })) return;
    setDrafts(d => d.filter(x => x.id !== id));
  };

  const addNew = () => {
    setDrafts(d => [
      {
        id: nid(),
        name: '',
        price: '',
        stock: '',
        desc: '',
        images: [],
        imagesText: '',
        buyUrl: '',
        tags: [],
        availability: 'ç¾è²¨',
        variants: undefined,
      },
      ...d,
    ]);
  };

  const saveAll = () => {
    const cleanedGroups = ensureUniqueTagsInGroups(groupsState, allTags);
    // æŠŠ imagesText è§£æå› imagesï¼ˆä¿éšªï¼‰
    const nextItems = drafts.map(it => ({
      ...it,
      images: Array.isArray(it.images) ? it.images : String(it.imagesText || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
    }));
    setData(s => ({
      ...s,
      store: { ...(s.store || {}), items: nextItems, tagGroups: cleanedGroups },
    }));
    alert('ç¤¾ç¾¤å•†åº—å·²å„²å­˜');
    onClose?.();
  };

  // ====== è¦æ ¼ Modalï¼ˆç¾é‡‘ï¼‰ ======
  const VariantEditorModal = ({ it }) => {
    if (!it) return null;

    const readV = (v) => {
      const mode = v?.mode && v.mode !== "none" ? (v.mode === "double" ? "double" : "single") : "none";
      const a1 = Array.isArray(v?.attrs) && v.attrs[0] ? v.attrs[0] : { name: "", values: [] };
      const a2 = Array.isArray(v?.attrs) && v.attrs[1] ? v.attrs[1] : { name: "", values: [] };
      return {
        vMode: mode,
        v1Name: a1.name || "",
        v1ValuesText: Array.isArray(a1.values) ? a1.values.join(",") : "",
        v2Name: a2.name || "",
        v2ValuesText: Array.isArray(a2.values) ? a2.values.join(",") : "",
        vSkus: Array.isArray(v?.items) ? v.items.map(s => ({
          key: String(s?.key || ""),
          stock: s?.stock ?? "",
          price: s?.price ?? "",
          image: s?.image || "",
          enabled: (s?.enabled !== false)
        })) : []
      };
    };
    const writeV = (d) => {
      const mode = d.vMode || "none";
      if (mode === "none") return { mode: "none", attrs: [], items: [] };
      const v1Values = (d.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const v2Values = (d.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const attrs = mode === "single"
        ? [{ name: d.v1Name || "è¦æ ¼", values: v1Values }]
        : [{ name: d.v1Name || "è¦æ ¼1", values: v1Values }, { name: d.v2Name || "è¦æ ¼2", values: v2Values }];
      return {
        mode,
        attrs,
        items: Array.isArray(d.vSkus) ? d.vSkus.map(s => ({
          key: String(s.key || ""),
          stock: s.stock ?? "",
          price: s.price ?? "",
          image: s.image || "",
          enabled: (s.enabled !== false)
        })) : []
      };
    };
    const buildCombos = (mode, v1, v2) => {
      const res = [];
      if (mode === "single") v1.forEach(a => res.push(a));
      if (mode === "double") v1.forEach(a => v2.forEach(b => res.push(`${a}|${b}`)));
      return res;
    };

    const [vd, setVd] = React.useState(() => readV(it.variants));

    const syncSkus = () => {
      const mode = vd.vMode || "none";
      if (mode === "none") return;
      const v1 = (vd.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const v2 = (vd.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const combos = buildCombos(mode, v1, v2);
      const old = new Map((vd.vSkus || []).map(s => [String(s.key||""), s]));
      const next = combos.map(key => old.get(key) ? { ...old.get(key) } : { key, stock:"", price:"", image:"", enabled:true });
      setVd(d => ({ ...d, vSkus: next }));
    };
    const batchApply = ({ stock, price, emptyOnly=false }) => {
      setVd(d => ({
        ...d,
        vSkus: (d.vSkus || []).map(s => {
          const n = { ...s };
          if (stock !== undefined) {
            if (!emptyOnly || String(n.stock||"")==="") n.stock = stock;
          }
          if (price !== undefined) {
            if (!emptyOnly || String(n.price||"")==="") n.price = price;
          }
          return n;
        })
      }));
    };
    const close = () => setVariantEditId(null);
    const save = () => {
      const v = writeV(vd);
      upMany(it.id, { variants: (v.mode==="none" ? undefined : v) });
      close();
    };

    const SingleList = () => {
      const v1 = (vd.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const rows = (vd.vSkus || []).filter(s => v1.includes(s.key));
      return (
        <div className="space-y-2">
          <div className="text-xs text-slate-500">é¸é …åˆ—è¡¨ï¼ˆé€åˆ—å¡«ã€Œåº«å­˜ / åƒ¹æ ¼ã€ï¼‰</div>
          <div className="rounded border">
            <div className="grid grid-cols-[auto_1fr_1fr_auto_auto] items-center gap-2 px-3 py-2 border-b text-xs text-slate-500">
              <div>#</div><div>é¸é …</div><div>åº«å­˜</div><div>åƒ¹æ ¼</div><div>å•Ÿç”¨</div>
            </div>
            {rows.map((s, idx) => (
              <div key={s.key} className="grid grid-cols-[auto_1fr_1fr_auto_auto] items-center gap-2 px-3 py-2 border-b">
                <div className="text-xs text-slate-500">{idx+1}</div>
                <div className="text-sm">{s.key}</div>
                <input className="rounded border px-2 py-1 text-sm" value={s.stock} onChange={e=>{
                  const val = e.target.value; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, stock:val}:x)}));
                }} />
                <input className="rounded border px-2 py-1 text-sm" value={s.price} onChange={e=>{
                  const val = e.target.value; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, price:val}:x)}));
                }} />
                <label className="text-sm inline-flex items-center gap-1">
                  <input type="checkbox" checked={!!s.enabled} onChange={e=>{
                    const v = e.target.checked; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, enabled:v}:x)}));
                  }}/> å•Ÿç”¨
                </label>
              </div>
            ))}
            {rows.length===0 && <div className="px-3 py-6 text-center text-sm text-slate-500">å°šæœªç”¢ç”Ÿé¸é …ï¼Œè«‹å…ˆå¡«å®Œã€Œè¦æ ¼åç¨± / é¸é …ã€ä¸¦é»ã€Œç”Ÿæˆ/åŒæ­¥ã€</div>}
          </div>
        </div>
      );
    };
    const DoubleMatrix = () => {
      const v1 = (vd.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const v2 = (vd.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const find = (a,b) => (vd.vSkus || []).find(s => s.key === `${a}|${b}`);
      return (
        <div className="space-y-2">
          <div className="text-xs text-slate-500">äº¤å‰è¡¨ï¼ˆæ¯æ ¼å¯å¡«ã€Œåº«å­˜ / åƒ¹æ ¼ã€æˆ–åœç”¨ï¼‰</div>
          <div className="overflow-auto rounded border">
            <table className="min-w-[560px] w-full border-collapse">
              <thead>
                <tr className="bg-slate-50 text-xs text-slate-600">
                  <th className="border px-2 py-1 text-left">{vd.v1Name || "è¦æ ¼1"}ï¼¼{vd.v2Name || "è¦æ ¼2"}</th>
                  {v2.map(v => <th key={v} className="border px-2 py-1 text-left">{v}</th>)}
                </tr>
              </thead>
              <tbody>
                {v1.map(a => (
                  <tr key={a}>
                    <th className="border px-2 py-1 text-left bg-slate-50 text-xs">{a}</th>
                    {v2.map(b => {
                      const s = find(a,b);
                      if (!s) return <td key={b} className="border px-2 py-1 text-center text-xs text-slate-400">â€”</td>;
                      return (
                        <td key={b} className="border px-2 py-1">
                          <div className="flex items-center gap-2">
                            <input className="w-20 rounded border px-2 py-1 text-sm" placeholder="åº«å­˜" value={s.stock} onChange={e=>{
                              const val = e.target.value; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, stock:val}:x)}));
                            }} />
                            <input className="w-24 rounded border px-2 py-1 text-sm" placeholder="åƒ¹æ ¼" value={s.price} onChange={e=>{
                              const val = e.target.value; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, price:val}:x)}));
                            }} />
                            <label className="text-xs inline-flex items-center gap-1">
                              <input type="checkbox" checked={!!s.enabled} onChange={e=>{
                                const v = e.target.checked; setVd(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, enabled:v}:x)}));
                              }}/> å•Ÿç”¨
                            </label>
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
                {v1.length===0 && (
                  <tr><td className="border px-3 py-6 text-center text-sm text-slate-500" colSpan={Math.max(1, v2.length+1)}>å°šæœªç”¢ç”ŸçŸ©é™£ï¼Œè«‹å…ˆå¡«å®Œå…©å€‹è¦æ ¼ä¸¦é»ã€Œç”Ÿæˆ/åŒæ­¥ã€</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    return (
      <div className="fixed inset-0 z-[1000]" role="dialog" aria-modal="true">
        <div className="absolute inset-0 bg-black/50" onClick={() => setVariantEditId(null)} />
        <div className="absolute inset-0 flex items-center justify-center p-4">
          <div className="w-[min(820px,96vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl">
            <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div className="font-semibold">ç·¨è¼¯è¦æ ¼ â€” {it.name || 'ï¼ˆæœªå‘½åï¼‰'}</div>
              <div className="flex items-center gap-2">
                <button className="rounded border px-3 py-1.5 text-sm" onClick={()=>setVariantEditId(null)}>é—œé–‰</button>
                <button className="rounded bg-brand text-white px-3 py-1.5 text-sm" onClick={save}>å„²å­˜</button>
              </div>
            </div>
            <div className="p-3 space-y-3 overflow-y-auto max-h-[calc(90vh-60px)]">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                <label className="text-sm">
                  æ¨¡å¼
                  <select className="mt-1 w-full rounded-lg border px-3 py-2" value={vd.vMode}
                    onChange={e => setVd(d => ({ ...d, vMode: e.target.value }))}>
                    <option value="none">ç„¡è¦æ ¼</option>
                    <option value="single">å–®è¦æ ¼</option>
                    <option value="double">é›™è¦æ ¼</option>
                  </select>
                </label>

                {vd.vMode !== "none" && (
                  <label className="text-sm">
                    {vd.vMode === "double" ? "è¦æ ¼1 åç¨±" : "è¦æ ¼åç¨±"}
                    <input className="mt-1 w-full rounded-lg border px-3 py-2"
                      value={vd.v1Name} onChange={e => setVd(d => ({ ...d, v1Name: e.target.value }))} placeholder="ä¾‹ï¼šé¡è‰²" />
                  </label>
                )}
                {vd.vMode !== "none" && (
                  <label className="text-sm">
                    {vd.vMode === "double" ? "è¦æ ¼1 é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰" : "é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"}
                    <input className="mt-1 w-full rounded-lg border px-3 py-2"
                      value={vd.v1ValuesText} onChange={e => setVd(d => ({ ...d, v1ValuesText: e.target.value }))} placeholder="ç´…, ç™½, è—" />
                  </label>
                )}
              </div>

              {vd.vMode === "double" && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 items-center">
                  <label className="text-sm">
                    è¦æ ¼2 åç¨±
                    <input className="mt-1 w-full rounded-lg border px-3 py-2"
                      value={vd.v2Name} onChange={e => setVd(d => ({ ...d, v2Name: e.target.value }))} placeholder="ä¾‹ï¼šå°ºå¯¸" />
                  </label>
                  <label className="text-sm">
                    è¦æ ¼2 é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
                    <input className="mt-1 w-full rounded-lg border px-3 py-2"
                      value={vd.v2ValuesText} onChange={e => setVd(d => ({ ...d, v2ValuesText: e.target.value }))} placeholder="S, M, L" />
                  </label>
                </div>
              )}

              {vd.vMode !== "none" && (
                <div className="flex flex-wrap items-center gap-2">
                  <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={syncSkus}>ç”Ÿæˆ/åŒæ­¥ é¸é …</button>
                  <span className="text-xs text-slate-500">å°‡ä¾é¸é …è‡ªå‹•ç”¢ç”Ÿ SKU åˆ—è¡¨/çŸ©é™£ï¼Œä¿ç•™æ—¢æœ‰è³‡æ–™</span>
                </div>
              )}

              {vd.vMode === "single" && <SingleList />}

              {vd.vMode === "double" && (
                <>
                  <div className="flex flex-wrap items-center gap-2">
                    <span className="text-sm">æ‰¹æ¬¡å¥—ç”¨ï¼š</span>
                    <input className="w-24 rounded border px-2 py-1 text-sm" placeholder="åº«å­˜"
                      onChange={(e) => (e.target.__v = e.target.value)} />
                    <input className="w-28 rounded border px-2 py-1 text-sm" placeholder="åƒ¹æ ¼"
                      onChange={(e) => (e.target.__p = e.target.value)} />
                    <button className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={(e) => {
                        const wrap = e.currentTarget.parentElement;
                        const stock = wrap.querySelector('input[placeholder="åº«å­˜"]')?.__v;
                        const price = wrap.querySelector('input[placeholder="åƒ¹æ ¼"]')?.__p;
                        batchApply({ stock, price, emptyOnly: false });
                      }}>å¥—ç”¨å…¨éƒ¨</button>
                    <button className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={(e) => {
                        const wrap = e.currentTarget.parentElement;
                        const stock = wrap.querySelector('input[placeholder="åº«å­˜"]')?.__v;
                        const price = wrap.querySelector('input[placeholder="åƒ¹æ ¼"]')?.__p;
                        batchApply({ stock, price, emptyOnly: true });
                      }}>åªå¡«ç©ºæ ¼</button>
                  </div>
                  <DoubleMatrix />
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="w-full max-w-4xl max-h-[86vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl">
          {/* header */}
          <div className="px-4 py-3 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
            <div className="font-semibold">ç·¨è¼¯ç¤¾ç¾¤å•†åº—</div>
            <div className="flex items-center gap-2">
              <input
                value={filter}
                onChange={e => setFilter(e.target.value)}
                placeholder="æœå°‹è‰ç¨¿..."
                className="rounded-lg border px-2 py-1.5 text-sm"
              />
              <button onClick={addNew} className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm">æ–°å¢å•†å“</button>
              <button onClick={() => exportStoreCSV(drafts)} className="rounded-lg border px-3 py-1.5 text-sm">åŒ¯å‡º CSV</button>
              <button onClick={saveAll} className="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm">å„²å­˜</button>
              <button onClick={onClose} className="rounded-lg border px-3 py-1.5 text-sm">é—œé–‰</button>
            </div>
          </div>

          {/* body */}
          <div className="p-3 overflow-y-auto max-h-[calc(86vh-56px)] space-y-3">
            {/* æ¨™ç±¤ç¾¤çµ„ç·¨è¼¯ï¼ˆæ’åºï¼æ•´åˆï¼‰ */}
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                <div className="font-medium">æ¨™ç±¤ç¾¤çµ„ï¼ˆæ’åºï¼æ•´åˆï¼‰</div>
                <div className="text-xs text-slate-500">æœªåˆ†çµ„æ¨™ç±¤æœƒè‡ªå‹•æ­¸å…¥ã€Œå…¶ä»–ã€</div>
              </div>
              <div className="p-3">
                <TagGroupsEditor
                  groups={groupsState}
                  allTags={allTags}
                  onChange={setGroupsState}
                />
              </div>
            </div>

            {filtered.length === 0 ? (
              <div className="text-slate-500 text-sm">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‰ç¨¿ã€‚</div>
            ) : (
              filtered.map(it => {
                const hasV = !!(it?.variants && it.variants.mode && it.variants.mode!=="none");
                return (
                  <div key={it.id} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3 space-y-2">
                    {/* åŸæœ¬ md:grid-cols-6 -> èª¿æˆ 7ï¼Œå®¹ç´ availability */}
                    <div className="grid grid-cols-1 md:grid-cols-7 gap-2">
                      <input
                        className="md:col-span-3 rounded-lg border px-3 py-2"
                        placeholder="å•†å“åç¨±"
                        value={it.name}
                        onChange={e => up(it.id, 'name', e.target.value)}
                      />
                      <input
                        className="md:col-span-1 rounded-lg border px-3 py-2"
                        placeholder="å”®åƒ¹ï¼ˆå­—ä¸²æˆ–æ•¸å­—ï¼‰"
                        value={it.price}
                        onChange={e => up(it.id, 'price', e.target.value)}
                      />
                      <input
                        className="md:col-span-1 rounded-lg border px-3 py-2"
                        placeholder="åº«å­˜ï¼ˆå¯çœç•¥ï¼‰"
                        value={it.stock}
                        onChange={e => up(it.id, 'stock', e.target.value)}
                      />
                      <select
                        className="md:col-span-1 rounded-lg border px-3 py-2"
                        value={it.availability}
                        onChange={e => up(it.id, 'availability', e.target.value)}
                      >
                        <option value="ç¾è²¨">ç¾è²¨</option>
                        <option value="é å”®">é å”®</option>
                      </select>
                      <input
                        className="md:col-span-1 rounded-lg border px-3 py-2"
                        placeholder="è³¼è²·é€£çµï¼ˆbuyUrlï¼‰"
                        value={it.buyUrl}
                        onChange={e => up(it.id, 'buyUrl', e.target.value)}
                      />
                    </div>

                    <textarea
                      className="w-full rounded-lg border px-3 py-2"
                      placeholder="å•†å“ä»‹ç´¹ï¼ˆdescï¼‰"
                      rows={3}
                      value={it.desc}
                      onChange={e => up(it.id, 'desc', e.target.value)}
                    />

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      <textarea
                        className="rounded-lg border px-3 py-2"
                        placeholder="å¤šå¼µåœ–ç‰‡ï¼šæ¯è¡Œä¸€å€‹ URLï¼ˆimagesï¼‰"
                        rows={5}
                        value={it.imagesText ?? (it.images || []).join('\n')}
                        onChange={e => {
                          const raw = e.target.value; // åŸæ¨£ä¿ç•™ï¼ˆå«ç©ºç™½è¡Œï¼‰
                          up(it.id, 'imagesText', raw); // 1) å„²å­˜åŸå§‹æ–‡å­—
                          const imgs = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                          up(it.id, 'images', imgs); // 2) åŒæ­¥è§£æçµ¦é è¦½/å„²å­˜ç”¨
                        }}
                      />
                      <input
                        className="rounded-lg border px-3 py-2"
                        placeholder="æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ï¼Œä¾‹å¦‚ï¼šç©å…·,å®¶é›»"
                        value={(it.tags || []).join(',')}
                        onChange={e =>
                          up(
                            it.id,
                            'tags',
                            e.target.value.split(',').map(s => s.trim()).filter(Boolean)
                          )
                        }
                      />
                    </div>

                    {/* é è¦½ç¸®åœ–åˆ— */}
                    {Array.isArray(it.images) && it.images.length > 0 && (
                      <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 pt-1">
                        {it.images.map((src, idx) => (
                          <div key={src + idx} className="aspect-square rounded-lg overflow-hidden border">
                            <img src={src} alt="" className="w-full h-full object-cover" />
                          </div>
                        ))}
                      </div>
                    )}

                    <div className="flex justify-between items-center pt-1">
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-slate-500">IDï¼š{it.id}</span>
                        {hasV && <span className="text-xs text-emerald-600">å·²è¨­å®šè¦æ ¼ï¼ˆ{it.variants.mode==='double'?'é›™':'å–®'}ï¼‰</span>}
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={() => setVariantEditId(it.id)} className="rounded-lg border px-2 py-1 text-sm">
                          ç·¨è¼¯è¦æ ¼
                        </button>
                        <button onClick={() => remove(it.id)} className="rounded-lg border px-2 py-1 text-sm">
                          åˆªé™¤
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>

      {/* è¦æ ¼ Modal */}
      {variantEditId && <VariantEditorModal it={drafts.find(d=>d.id===variantEditId)} />}
    </div>
  );
}


/***********************
 * åŒ¯å‡º CSVï¼ˆç¤¾ç¾¤å•†åº—ï¼‰
 ***********************/
function exportStoreCSV(items=[]) {
  const header = ['id','name','price','stock','buyUrl','tags','images','desc'];
  const rows = [header];
  for (const it of (items||[])) {
    rows.push([
      it?.id || '',
      it?.name || '',
      it?.price ?? '',
      it?.stock ?? '',
      it?.buyUrl || '',
      Array.isArray(it?.tags) ? it.tags.join('|') : '',
      Array.isArray(it?.images) ? it.images.join('|') : '',
      (it?.desc || '').replace(/\r?\n/g, ' '),
    ]);
  }
  exportCSV(`store_items_${new Date().toISOString().slice(0,10)}.csv`, rows);
}


// å°å…ƒä»¶ï¼šç‹€æ…‹è† å›Šï¼ˆå« emojiï¼Œçµ±ä¸€è¦æ ¼ï¼‰
function StatusTag({ value }) {
  const v = String(value || "").trim();
  if (!v) return null;
  const icon = HISTORY_STATUS_ICON[v] || "ğŸ·ï¸";
  const style = HISTORY_STATUS_STYLE[v] || { bg: "bg-slate-100/70 dark:bg-slate-300/10", text: "text-slate-600 dark:text-slate-300", ring:"ring-slate-400/20" };
  return (
    <span
      className={[
        "inline-flex items-center justify-center gap-1.5 px-2.5 py-1 rounded-full text-xs min-w-[80px] text-center",
        "border border-transparent ring-1", style.ring, style.bg, style.text
      ].join(" ")}
      title={`ç‹€æ…‹ï¼š${v}`}
    >
      <span aria-hidden="true">{icon}</span>
      <span className="leading-none">{v}</span>
    </span>
  );
}


// â€”â€” å°å·¥å…· â€”â€”ï¼ˆä½ å‰›å‰›ä¸å°å¿ƒåˆªæ‰çš„ï¼‰
const cx = (...xs) => xs.filter(Boolean).join(' ');
const nid = () => Math.random().toString(36).slice(2,10);

function useLocalState(key, initial){
  const store = (globalThis.__kjs_ls_debounce ||= { t:{}, last:{} });

  const [state, setState] = React.useState(()=>{
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : initial;
    }catch{
      return initial;
    }
  });

  // å¯«å…¥ç¯€æµï¼šé¿å…é »ç¹ setItem é€ æˆå¡é “ï¼ˆå°¤å…¶æ‰‹æ©Ÿï¼‰
  React.useEffect(()=>{
    let serialized = "";
    try{ serialized = JSON.stringify(state); }catch{ serialized = ""; }

    // è‹¥åºåˆ—åŒ–çµæœæœªè®Šæ›´ï¼Œè·³éå¯«å…¥
    if (store.last[key] === serialized) return;

    // æ¸…æ‰èˆŠçš„æ’ç¨‹
    if (store.t[key]) { try{ clearTimeout(store.t[key]); }catch{} }

    store.t[key] = setTimeout(()=>{
      try{
        // å¯èƒ½é‡åˆ° quota æˆ–ç§å¯†æ¨¡å¼é™åˆ¶ï¼Œé€™è£¡åšä¿åº•ä¸è®“æµç¨‹ä¸­æ–·
        localStorage.setItem(key, serialized);
        store.last[key] = serialized;
      }catch{}
      store.t[key] = null;
    }, 180);
  },[key, state]);

  return [state, setState];
}



/* =========================
   Toast / é€šçŸ¥ï¼ˆå…¨åŸŸï¼‰
   - ç›®çš„ï¼šæä¾›ä¸€è‡´ã€éé˜»æ–·å¼çš„ã€Œå·²å„²å­˜ã€æç¤ºï¼Œé¿å… toast æœªå®šç¾©é€ æˆå„²å­˜æµç¨‹ä¸­æ–·
   ========================= */
function toast(message, opts){
  try{
    const cfg = (opts && typeof opts==='object') ? opts : {};
    const ms = Number.isFinite(cfg.ms) ? cfg.ms : 1600;
    const type = cfg.type || "info"; // info|success|warning|error
    const id = "kjs-toast-root";
    let root = document.getElementById(id);
    if(!root){
      root = document.createElement("div");
      root.id = id;
      root.style.position = "fixed";
      root.style.left = "0";
      root.style.right = "0";
      root.style.bottom = "16px";
      root.style.zIndex = "2147483647";
      root.style.display = "flex";
      root.style.justifyContent = "center";
      root.style.pointerEvents = "none";
      document.body.appendChild(root);
    }
    const el = document.createElement("div");
    const bg =
      type==="success" ? "rgba(16,185,129,.92)" :
      type==="warning" ? "rgba(245,158,11,.92)" :
      type==="error"   ? "rgba(244,63,94,.92)" :
                         "rgba(15,23,42,.92)";
    el.textContent = String(message ?? "");
    el.style.maxWidth = "min(92vw, 560px)";
    el.style.padding = "10px 14px";
    el.style.borderRadius = "14px";
    el.style.color = "white";
    el.style.fontSize = "14px";
    el.style.lineHeight = "18px";
    el.style.background = bg;
    el.style.boxShadow = "0 10px 30px rgba(0,0,0,.22)";
    el.style.pointerEvents = "none";
    el.style.opacity = "0";
    el.style.transform = "translateY(6px)";
    el.style.transition = "opacity 140ms ease, transform 140ms ease";
    root.appendChild(el);
    requestAnimationFrame(()=>{
      el.style.opacity = "1";
      el.style.transform = "translateY(0)";
    });
    window.setTimeout(()=>{
      el.style.opacity = "0";
      el.style.transform = "translateY(6px)";
      window.setTimeout(()=>{ el.remove(); }, 220);
    }, ms);
  }catch(err){
    // ä¿åº•ï¼štoast ä¸æ‡‰å†ä¸­æ–·ä¸»æµç¨‹
    console.warn("toast failed:", err);
  }
}
window.toast = toast;

// æ–‡å­—åå–®æ¸…æ´—ï¼šå»ç©ºç™½ã€å…¨/åŠå½¢ç©ºç™½ã€é€£çºŒç©ºç™½ã€å¤§å°å¯«ä¸æ•æ„Ÿå»é‡
function parseLinesClean(txt="") {
  const normalize = s => s.replace(/\u3000/g, " ").replace(/\s+/g, " ").trim();
  const set = new Set(), out = [];
  for (const raw of String(txt).split(/\r?\n/)) {
    const v = normalize(raw);
    if (!v) continue;
    const key = v.toLowerCase();
    if (!set.has(key)) { set.add(key); out.push(v); }
  }
  return out;
}

// â€”â€” æ–‡å­—æ¯”å°ï¼šå¤§å°å¯«ä¸æ•æ„Ÿã€å…¨å½¢ç©ºç™½è½‰åŠå½¢ã€é€£çºŒç©ºç™½æ­¸ä¸€åŒ– â€”â€” //
function matchText(hay="", needle=""){
  const norm = (s)=> String(s||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase();
  const a = norm(hay), b = norm(needle);
  if (!b) return true; // ç©ºå­—ä¸²è¦–ç‚ºå…¨éƒ¨åŒ¹é…
  return a.includes(b);
}

// â€”â€” History æœå°‹è¦å‰‡ï¼ˆä¾æ¨¡å¼ï¼‰â€”â€” //
// rec: { title, winners[], note, status, youtube, ... }
// mode: 'all' | 'prize' | 'winner' | 'note'
// q: é—œéµå­—
function historyMatchByMode(rec, q, mode){
  const m = mode || 'all';
  const title = rec?.title || "";
  const note  = rec?.note  || rec?.desc || "";
  const winners = Array.isArray(rec?.winners) ? rec.winners : [];

  if (!q) return true; // æ²’è¼¸å…¥é—œéµå­— => ä¸éæ¿¾

  switch (m) {
    case 'prize':
      return matchText(title, q);

    case 'winner':
      return winners.some(w => matchText(w, q));

    case 'note':
      // å‚™è¨»/èªªæ˜ï¼šå„ªå…ˆ note/descï¼Œå…¶æ¬¡ statusã€youtube ä¹Ÿç´å…¥é—œè¯æœå°‹
      return (
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );

    case 'all':
    default:
      // å…¨éƒ¨ï¼štitleã€winnersã€note/status/youtube çš†ç´å…¥
      return (
        matchText(title, q) ||
        winners.some(w => matchText(w, q)) ||
        matchText(note, q) ||
        matchText(rec?.status || "", q) ||
        matchText(rec?.youtube || "", q)
      );
  }
}

// === Adminï¼šç´”å‰ç«¯ SHA-256 é›œæ¹Šï¼ˆé¿å…æ˜æ–‡å­˜å¯†ç¢¼ï¼‰ ===
async function hashTextSHA256(text) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(String(text)));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2, "0")).join("");
}


// === è£œé½Šå°å·¥å…·ï¼ˆä¸ä¾è³´å›æ”¶ç«™ï¼‰ ===
function nowISO(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function exportCSV(filename, rows){
  const csv = rows
    .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}


/* =========================
   Input Guardsï¼ˆå…¨åŸŸï¼‰
   - é˜²æ­¢æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§ / æåˆç¸®æ”¾æ‰“æ–·éŠæˆ²
   - åªåœ¨éŠæˆ²äº’å‹•å€åŸŸé–å®š touchmoveï¼Œé¿å…é é¢èª¤æ»¾
   ========================= */
function installGlobalInputGuards(){
  try{
    if (globalThis.__kjs_input_guard_installed) return;
    globalThis.__kjs_input_guard_installed = true;

    // iOS Safari: prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouchEnd <= 260) {
        // only prevent when interacting inside game containers
        if (e.target && (e.target.closest?.('.game-touch-lock') || e.target.closest?.('[data-game-root]'))) {
          e.preventDefault();
        }
      }
      lastTouchEnd = now;
    }, { passive: false });

    // Prevent gesture zoom inside game views
    document.addEventListener('gesturestart', (e)=>{
      if (e.target && (e.target.closest?.('.game-touch-lock') || e.target.closest?.('[data-game-root]'))) e.preventDefault();
    }, { passive: false });

    // Lock scrolling while touching inside game areas
    document.addEventListener('touchmove', (e)=>{
      if (e.target && (e.target.closest?.('.game-touch-lock') || e.target.closest?.('[data-game-root]'))) {
        e.preventDefault();
      }
    }, { passive: false });
  }catch{}
}




/* === Grid å·¥å…·ï¼ˆ9/16 å®®æ ¼åˆ‡æ›ï¼‰ === */
function useGridSize(lsKey='kjs_grid_cols', defaultCols=3){
  const [cols, setCols] = useLocalState(lsKey, defaultCols); // 3=9å®®æ ¼, 4=16å®®æ ¼
  const toggle = ()=> setCols(c => (c===3?4:3));
  const colClass = cols===3 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4';
  const label = cols===3 ? '9 å®®æ ¼' : '16 å®®æ ¼';
  return { cols, setCols, toggle, colClass, label };
}

/* å¡ç‰‡å±•é–‹å®¹å™¨ï¼šé»å¡ç‰‡å¾Œå±•é–‹è©³ç´°ï¼ˆå¡ç‰‡å…§éƒ¨æ§åˆ¶ open ç‹€æ…‹ï¼‰ */
function CardCollapse({summary, children, defaultOpen=false}) {
  const [open, setOpen] = React.useState(!!defaultOpen);
  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 shadow-soft overflow-hidden">
      <button
        type="button"
        className="block w-full text-left"
        onClick={()=>setOpen(o=>!o)}
        aria-expanded={open?'true':'false'}
      >
        {summary}
      </button>
      {open && (
        <div className="border-t border-slate-200/70 dark:border-slate-700/70 p-3">
          {children}
        </div>
      )}
    </div>
  );
}

/* =========================================
 * å…¨åŸŸ Viewerï¼ˆåœ–ç‰‡æŸ¥çœ‹å™¨ï¼Œä¾›å„è™•ä½¿ç”¨ï¼‰
 * - é»é®ç½©ç©ºç™½å€åŸŸé—œé–‰
 * - å·¦å³é»/æ»‘åˆ‡æ›ã€é›™æ“Šæ”¾å¤§ã€ä¸‹æ»‘é—œé–‰
 * - ä½¿ç”¨ BodyScrollLock é¿å…æ•´ç«™å¡ä½
 * ========================================= */
function Viewer({ state, setState }) {
  const React = window.React || globalThis.React;
  const containerRef = React.useRef(null);
  const imgRef = React.useRef(null);

  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);

  const hasImages = Array.isArray(state?.images) && state.images.length > 0;
  const index = Math.max(0, Math.min(state?.index || 0, (state?.images?.length || 1) - 1));
  const src = hasImages ? state.images[index] : "";

  // éµç›¤ & é–æ²å‹•ï¼ˆä½¿ç”¨å…¨åŸŸé–ï¼‰
  React.useEffect(() => {
    if (!state?.open) return;
    BodyScrollLock.lock();
    const onKey = (e) => {
      if (e.key === "Escape") setState(v => ({ ...v, open: false }));
      if (e.key === "ArrowLeft") setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      if (e.key === "ArrowRight") setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    return () => { document.removeEventListener("keydown", onKey); BodyScrollLock.unlock(); };
  }, [state?.open, state?.images?.length, setState]);

  // æ›åœ–æ™‚é‡ç½®ç¸®æ”¾ä½ç§»
  React.useEffect(() => { setScale(1); setTx(0); setTy(0); }, [index]);

  const onOverlayClick = (e) => { if (e.target === containerRef.current) setState(v => ({ ...v, open: false })); };
  const onDoubleClick = (e) => { e.preventDefault(); setScale(s => s === 1 ? 2 : 1); if (scale !== 1) { setTx(0); setTy(0); } };

  // æ‰‹å‹¢ï¼šå·¦å³æ»‘æ›åœ–ã€ä¸‹æ»‘é—œé–‰ã€æ‹–æ›³å¹³ç§»ï¼ˆæ”¾å¤§æ™‚ï¼‰
  let sx = 0, sy = 0, dragging = false;
  const onTouchStart = (e) => { if (e.touches.length === 1) { sx = e.touches[0].clientX; sy = e.touches[0].clientY; dragging = true; } };
  const onTouchMove = (e) => { if (!dragging) return; const dx = e.touches[0].clientX - sx; const dy = e.touches[0].clientY - sy; if (scale > 1) { setTx(dx / 2); setTy(dy / 2); } };
  const onTouchEnd = (e) => {
    if (!dragging) return; dragging = false;
    const ex = e.changedTouches?.[0]?.clientX ?? sx; const ey = e.changedTouches?.[0]?.clientY ?? sy;
    const dx = ex - sx, dy = ey - sy;
    if (Math.abs(dy) > 120 && Math.abs(dy) > Math.abs(dx)) { setState(v => ({ ...v, open: false })); return; }
    if (Math.abs(dx) > 80 && scale === 1 && hasImages) {
      if (dx > 0) setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length }));
      else setState(v => ({ ...v, index: (v.index + 1) % v.images.length }));
    }
    setTx(0); setTy(0);
  };

  if (!state?.open) return null;

  return (
    <div ref={containerRef} className="fixed inset-0 z-[999] bg-black/85 flex flex-col" role="dialog" aria-modal="true" onClick={onOverlayClick}>
      <div className="flex items-center justify-between px-3 py-2 text-white text-sm">
        <div className="truncate pr-2">{state?.title || ""}</div>
        <div className="flex items-center gap-2">
          {hasImages && <span>{index + 1} / {state.images.length}</span>}
          <button className="px-2 py-1 rounded bg-white/10" onClick={() => setState(v => ({ ...v, open: false }))}>é—œé–‰</button>
        </div>
      </div>

      <div className="relative flex-1 flex items-center justify-center select-none"
           onDoubleClick={onDoubleClick} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
        {hasImages && (
          <>
            <button className="absolute left-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index - 1 + v.images.length) % v.images.length })); }} aria-label="ä¸Šä¸€å¼µ" />
            <button className="absolute right-0 top-0 h-full w-1/5" onClick={(e)=>{ e.stopPropagation(); setState(v => ({ ...v, index: (v.index + 1) % v.images.length })); }} aria-label="ä¸‹ä¸€å¼µ" />
          </>
        )}
        {src
          ? <img ref={imgRef} src={src} alt="" style={{ transform: `translate(${tx}px, ${ty}px) scale(${scale})`, transition: 'transform .15s ease-out' }}
                 className="max-w-[min(100vw,1200px)] max-h-[calc(100vh-90px)] object-contain select-none" />
          : <div className="text-white/70">ç„¡åœ–ç‰‡</div>}
      </div>

      <div className="px-3 py-2 border-t border-white/10 text-xs text-white/70 text-center">
        å·¦å³æ»‘å‹•æ›åœ– Â· é›™æ“Šæ”¾å¤§ Â· é»ç©ºç™½é—œé–‰
      </div>
    </div>
  );
}


// ============================
// Sectionï¼ˆå®Œæ•´ï¼‰
// - æ–°å¢ï¼šåœ¨å€å¡Šå…§æœ‰è¼¸å…¥èšç„¦æ™‚ï¼Œæš«åœ backdrop-filterï¼ˆæ¯›ç»ç’ƒï¼‰
// ============================
function Section({ title, subtitle, children }){
  const React = window.React || globalThis.React;

  // â˜… æ–°å¢ï¼šæœ‰æ²’æœ‰ã€Œå€å¡Šå…§çš„è¼¸å…¥ã€æ­£åœ¨èšç„¦
  const [focusWithin, setFocusWithin] = React.useState(false);

  const blurGuardStyle = focusWithin
    ? { backdropFilter: 'none', WebkitBackdropFilter: 'none' }
    : undefined;

  return (
    <section
      className="animate-fadeIn"
      onFocusCapture={() => setFocusWithin(true)}
      onBlurCapture={(e) => {
        // åªæœ‰æ•´å€‹ Section éƒ½å¤±å»ç„¦é»ï¼Œæ‰é—œæ‰ä¿è­·
        if (!e.currentTarget.contains(e.relatedTarget)) setFocusWithin(false);
      }}
    >
      <div className="mb-3">
        <h2 className="text-[1.25rem] font-semibold tracking-tight">{title}</h2>
        {subtitle && <p className="text-[13px] text-slate-500 mt-1">{subtitle}</p>}
      </div>

      {/* åŸæœ¬çš„ .section-card æ”¹ç‚ºç›´æ¥å¥—å·¥å…·é¡ï¼ˆä¿ç•™ä½ çš„æ¨£å¼ï¼‰ */}
      <div
        className="
          bg-white/80 dark:bg-slate-800/70 backdrop-blur
          border border-slate-200/70 dark:border-slate-700/60
          rounded-2xl
          shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)]
          hover:shadow-[0_12px_30px_-12px_rgba(0,0,0,0.35)]
          transition-shadow
          p-4 sm:p-5
        "
        style={blurGuardStyle} // â˜… åªæœ‰è¼¸å…¥èšç„¦æ™‚æ‰é—œé–‰æ¯›ç»ç’ƒ
      >
        {children}
      </div>
    </section>
  );
}


/* ============================
 * ç­‰å¾…é–‹çï¼ˆæ¸…å–® + è·³å‡ºå¼è³‡è¨Š + æŠ½çå±•ç¤ºï¼‰
 * - ä¿ç•™åŸåŠŸèƒ½ï¼šæœå°‹/åˆ†é /9æˆ–16å®®æ ¼/æ–°å¢/ç·¨è¼¯/åˆªé™¤/ä¸‰ç¨®è½‰æ­·å²
 * - å…§å»ºã€Œå‹¾é¸åå–® â†’ è½‰æ­·å²ã€å®Œæ•´ä¸²æ¥ï¼ˆå«å½ˆçª—å…§å‹¾é¸ UIï¼‰
 * - â˜… æ–°å¢ï¼šåŒä¸€è¦–çª—ã€Œé€å¡è²¼åå–®ã€æ‰¹æ¬¡é¢æ¿ï¼ˆè¿½åŠ /è¦†è“‹ã€æ¸…é›œè¨Šã€å»é‡ï¼‰
 * ============================ */
function Pending({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;
  const nidSafe = (typeof nid === "function") ? nid : () => Math.random().toString(36).slice(2);

  // åå¥½
  const prefKey = "pending_prefs_v2";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9"); // grid9 / grid16
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // å…¼å®¹è³‡æ–™ä¾†æº
  const raw = Array.isArray(data?.pending?.items) ? data.pending.items :
              (Array.isArray(data?.pending) ? data.pending : []);

  const parseLinesClean = (txt) => String(txt||"").split(/\r?\n|,|ã€|\s+/).map(s=>s.trim()).filter(Boolean);

  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    const tags   = Array.isArray(it?.tags) ? it.tags   : (typeof it?.tags === "string" ? it.tags.split(",").map(s=>s.trim()).filter(Boolean) : []);
    let candidates = [];
    if (Array.isArray(it?.participants)) candidates = it.participants;
    else if (Array.isArray(it?.members)) candidates = it.members;
    else if (Array.isArray(it?.list)) candidates = it.list;
    else if (Array.isArray(it?.candidates)) candidates = it.candidates;
    else if (typeof it?.listText === "string") candidates = String(it.listText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const planned = Number.isFinite(+it?.plannedWinners) ? +it.plannedWinners : 1;
    return { ...it, _images: images, _tags: tags, _candidates: candidates.map(String).filter(Boolean), _planned: planned };
  };

  const allItems = React.useMemo(()=> raw.map(normalizeItem), [raw]);

  // æˆ‘çš„åå­— / æˆ‘æ˜¯å¦æœ‰åƒèˆ‡
  const [myName, setMyName] = React.useState("");
  const [mineFilter, setMineFilter] = React.useState("all"); // all / joined / notJoined

  // æœå°‹
  const [search, setSearch] = React.useState(query || "");
  const filteredBySearch = React.useMemo(()=>{
    const kw = String(search||"").trim().toLowerCase();
    return allItems.filter(x=>{
      const hay = [x?.title, x?.name, x?.desc, x?.intro, x?._tags?.join(" ")].map(s=>String(s||"").toLowerCase()).join(" ");
      return !kw || hay.includes(kw);
    });
  }, [allItems, search]);

  const filtered = React.useMemo(()=>{
    const name = myName.trim();
    if (!name) return filteredBySearch;
    const joinedSet = new Set(
      filteredBySearch
        .filter(x => Array.isArray(x._candidates) && x._candidates.includes(name))
        .map(x => x.id ?? x)
    );
    if (mineFilter === "joined") return filteredBySearch.filter(x => joinedSet.has(x.id ?? x));
    if (mineFilter === "notJoined") return filteredBySearch.filter(x => !joinedSet.has(x.id ?? x));
    return filteredBySearch;
  }, [filteredBySearch, myName, mineFilter]);

  // æ’åº
  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered]);

  // åˆ†é 
  const total = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [search, view, pageSize, myName, mineFilter]);

  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems = sorted.slice(start, end);

  // Viewer
  const [viewer, setViewer] = React.useState({ open:false, images:[], index:0, title:"" });
  React.useEffect(()=>{
    if (!viewer.open) return;
    const onKey = (e)=>{
      if (e.key==="Escape") setViewer(v=>({ ...v, open:false }));
      if (e.key==="ArrowLeft") setViewer(v=>({ ...v, index:(v.index-1+v.images.length)%v.images.length }));
      if (e.key==="ArrowRight") setViewer(v=>({ ...v, index:(v.index+1)%v.images.length }));
    };
    document.addEventListener("keydown", onKey);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return ()=>{ document.removeEventListener("keydown", onKey); document.body.style.overflow = prev; };
  }, [viewer.open, viewer.images.length]);
  const openViewer = (images, index, title="")=>{
    const list = Array.isArray(images) ? images.filter(Boolean) : (images ? [images] : []);
    if (!list.length) return;
    setViewer({ open:true, images:list, index: Math.max(0, Math.min(index||0, list.length-1)), title });
  };

  // è¡¨å–®ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰
  const [draft, setDraft] = React.useState({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  const [editingId, setEditingId] = React.useState(null);

  function upsertFromDraft() {
    if (!admin) return alert("è«‹å…ˆç™»å…¥ç®¡ç†æ¨¡å¼");
    const title = (draft.title || "").trim();
    if (!title) return alert("è«‹å¡«å¯«ã€çé …åç¨±ã€‘");
    const planned = draft.plannedWinners !== "" ? Number(draft.plannedWinners) : 1;
    if (draft.plannedWinners !== "" && !Number.isFinite(planned)) return alert("æŠ½å‡ºåé¡éœ€ç‚ºæ•¸å­—");
    const rec = {
      id: editingId || nidSafe(),
      title,
      date: draft.date || "",
      image: (draft.image || "").trim(),
      participants: parseLinesClean(draft.participantsText),
      plannedWinners: planned
    };
    if (editingId) {
      const next = raw.map(x => x.id === editingId ? rec : x);
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); setEditingId(null); alert("å·²å„²å­˜ä¿®æ”¹");
    } else {
      const next = [rec, ...raw];
      const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
      setData(s => ({ ...s, pending: nextP })); alert("å·²æ–°å¢æ´»å‹•");
    }
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function editItem(x) {
    if (!admin) return;
    setEditingId(x?.id || null);
    setDraft({
      date: x?.date || "",
      title: x?.title || "",
      image: x?.image || (Array.isArray(x?._images)&&x._images[0]) || "",
      participantsText: Array.isArray(x?._candidates) ? x._candidates.join("\n") : (Array.isArray(x?.participants) ? x.participants.join("\n") : ""),
      plannedWinners: Number.isFinite(+x?._planned) ? String(x._planned) : (x?.plannedWinners ?? "")
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function cancelEdit(){
    setEditingId(null);
    setDraft({ date:"", title:"", image:"", participantsText:"", plannedWinners:"" });
  }
  function removeItemObj(x){
    if (!admin) return;
    if (!confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) return;
    const next = raw.filter(it => (it.id ?? it) !== (x.id ?? x));
    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: next } : next;
    setData(s => ({ ...s, pending: nextP }));
  }

  // ===== å‹¾é¸åå–®ï¼ˆæ¯å€‹æ´»å‹•ä¸€ä»½ mapï¼‰ =====
  const [checkedMaps, setCheckedMaps] = React.useState({}); // { [id]: { [name]: boolean } }
  function getCheckedMap(id) { return (checkedMaps && checkedMaps[id]) ? checkedMaps[id] : {}; }
  function makeToggleCheck(id) {
    return function toggleCheck(name, next){
      setCheckedMaps(prev => {
        const curr = prev[id] || {};
        const val = (typeof next === 'boolean') ? next : !curr[name];
        return { ...prev, [id]: { ...curr, [name]: !!val } };
      });
    };
  }

  // æ¸…ç†å‹¾é¸æ®˜ç•™
  function pruneCheckedMap(itemId, keepSet) {
    try {
      const id = String(itemId || "");
      const keep = keepSet instanceof Set ? keepSet : new Set();
      const current = getCheckedMap ? (getCheckedMap(id) || {}) : {};
      const toggle = makeToggleCheck ? makeToggleCheck(id) : null;
      for (const [name, checked] of Object.entries(current)) {
        if (checked && !keep.has(name)) {
          if (typeof toggle === "function") toggle(name, false);
          else current[name] = false;
        }
      }
    } catch (err) { console.warn("[pruneCheckedMap] ä¾‹å¤–ï¼š", err); }
  }

  // å°å¡ã€Œå¥—ç”¨åˆªé™¤ã€â†’ çœŸæ­£å›å¯«è³‡æ–™ + åŒæ­¥ç·¨è¼¯è‰ç¨¿ï¼ˆä¿®æ­£ç‰ˆï¼šç›´æ¥æŒä¹…åŒ–ï¼‰
function updateItemParticipants(payload) {
  const { id, item, lines, text } = (payload || {});
  const itemId = String(item?.id ?? id ?? "");
  if (!itemId) return;

  // ä¾†æºè¡Œåˆ—ï¼šå„ªå…ˆ linesï¼Œå…¶æ¬¡ text
  const srcLines = Array.isArray(lines) ? lines : String(text || "").split(/\r?\n/);

  // participantsï¼šç”¨æ–¼é¡¯ç¤º/æŠ½çï¼›trim å¾Œå»ç©ºè¡Œï¼ˆæ‰¹æ¬¡é¢æ¿å·²å»é‡ï¼Œé€™è£¡ä¸å†å»é‡ï¼‰
  const participants = srcLines
    .map(s => String(s ?? "").trim())
    .filter(Boolean);

  // listTextï¼šç·¨è¼¯ç”¨åŸæ¨£å­—ä¸²ï¼ˆä¿ç•™å°å¡/æ‰¹æ¬¡é¢æ¿å¥—ç”¨å¾Œçš„æ¨£å­ï¼‰
  const nextListText = (typeof text === "string") ? text : srcLines.join("\n");

  // 1) æ¸…ç†å‹¾é¸æ®˜ç•™ï¼ˆé¿å…åå–®è®Šæ›´å¾Œï¼Œå‹¾é¸é‚„ç•™åœ¨å·²åˆªåå­—ä¸Šï¼‰
  pruneCheckedMap(itemId, new Set(participants));

  // 2) ç›´æ¥æŒä¹…åŒ–åˆ° pendingï¼ˆç›¸å®¹ {pending:{items:[]}} èˆ‡ pending ç‚ºé™£åˆ—ï¼‰
  try {
    if (typeof setData === "function") {
      setData(prev => {
        const prevPending = prev?.pending;
        const items = Array.isArray(prevPending?.items)
          ? prevPending.items
          : (Array.isArray(prevPending) ? prevPending : []);

        const idx = items.findIndex(x => String(x?.id ?? x) === itemId);
        const base = idx >= 0 ? items[idx] : (item || { id: itemId });

        // åªè¦†è“‹éœ€è¦çš„æ¬„ä½ï¼Œå…¶é¤˜ç¶­æŒåŸæ¨£
        const updated = {
          ...base,
          id: itemId,
          listText: nextListText,
          participants
        };

        const nextItems = idx >= 0
          ? [...items.slice(0, idx), updated, ...items.slice(idx + 1)]
          : [updated, ...items];

        // å›å¯«æ™‚ä¿ç•™åŸçµæ§‹å‹æ…‹
        const nextPending = Array.isArray(prevPending?.items)
          ? { ...prevPending, items: nextItems }
          : nextItems;

        return { ...prev, pending: nextPending };
      });
    } else {
      // è‹¥ä½ çš„ç’°å¢ƒæ²’æœ‰ setDataï¼Œä»é€€å›èˆŠé‚è¼¯ï¼ˆä¸å»ºè­°ã€ä½†ä¿åº•ï¼‰
      if (typeof editItem === "function") {
        const nextItem = { ...(item || {}), id: itemId, listText: nextListText, participants };
        editItem(nextItem);
      } else {
        console.warn("[updateItemParticipants] setData ä¸å­˜åœ¨ï¼Œä¸”æ‰¾ä¸åˆ° editItem å¯ç”¨ã€‚");
      }
    }
  } catch (e) {
    console.warn("[updateItemParticipants] å¯«å›è³‡æ–™ä¾‹å¤–ï¼š", e);
  }

  // 3) è‹¥æ­¤æ™‚æ­£åœ¨ç·¨è¼¯åŒä¸€ç­†æ´»å‹• â†’ è®“ç·¨è¼¯è¦–çª—çš„ textarea ä¹Ÿç«‹åˆ»åŒæ­¥
  try {
    if (sheet?.item && String(sheet.item.id) === itemId && typeof setDraft === "function") {
      setDraft(d => ({ ...d, participantsText: nextListText }));
    }
  } catch (e) {
    // ignore
  }

  // ï¼ˆå¯é¸ï¼‰ç™¼å‡ºäº‹ä»¶ï¼Œè‹¥å¤–å±¤æœ‰ç›£è½å¯åŒæ­¥
  try {
    const evtPayload = {
      id: itemId,
      item,
      lines: participants,
      text: nextListText
    };
    window.dispatchEvent(new CustomEvent("kjs:pending:updateParticipants", { detail: evtPayload }));
  } catch {}
}


  // ===== è½‰æ­·å²ï¼ˆä¿ç•™åŸæµç¨‹ï¼‰ =====
  function convertByChecked(x, checkedMap){
    const picked = [];
    const m = checkedMap || {};
    for (const k in m) if (m[k]) picked.push(String(k));
    if (!picked.length) { alert("è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€ä½å¾—çè€…"); return; }

    const pool = Array.isArray(x?._candidates) ? x._candidates.map(String) : [];
    const allow = new Set(pool);
    const winners = picked.filter(n => allow.has(n));
    if (!winners.length) { alert("å‹¾é¸çš„åå­—ä¸åœ¨æ­¤æ´»å‹•çš„åƒèˆ‡åå–®ä¸­"); return; }

    convertToHistoryByWinners(x.id, winners);
  }

  function convertToHistoryByWinners(id, winners) {
    if (!admin) return;
    const now = raw.find(x => x.id === id);
    if (!now) return;
    const rest = raw.filter(x => x.id !== id);
    const history = Array.isArray(data?.history) ? data.history : [];

    const num = (v)=> (v===""||v==null) ? null : (Number.isFinite(+v) ? +v : null);

    const deriveCandidates = (it)=>{
      if (!it) return [];
      if (Array.isArray(it._candidates)) return it._candidates;
      if (Array.isArray(it.participants)) return it.participants;
      if (Array.isArray(it.members)) return it.members;
      if (Array.isArray(it.list)) return it.list;
      if (Array.isArray(it.candidates)) return it.candidates;
      if (typeof it.listText === "string") return it.listText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return [];
    };
    const totalParticipants = deriveCandidates(now).length;

    const plannedCount =
        num(now?._planned) ??
        num(now?.planned) ??
        num(now?.plannedCount) ??
        num(now?.winnersPlanned) ??
        num(now?.winnerPlan) ?? null;

    const rec = {
      id: nidSafe(),
      date: now.date || "",
      title: now.title || "",
      winners: Array.isArray(winners) ? winners : [],
      winnerCount: Array.isArray(winners) ? winners.length : 0,
      totalParticipants,
      plannedCount: plannedCount != null ? plannedCount : undefined,
      status: "å·²æŠ½å‡º",
      note: ""
    };

    const nextP = Array.isArray(data?.pending?.items) ? { ...data.pending, items: rest } : rest;
    setData(s => ({ ...s, pending: nextP, history: [rec, ...history] }));
    alert("å·²è½‰å…¥æ­·å²");
  }

  // ç®¡ç†ç”¨ï¼šä¸€æ¬¡æ€§æ¨¡æ“¬ï¼ˆä¿ç•™ï¼‰
  function simulateOnce(list, count){
    const names = Array.isArray(list) ? list.slice() : [];
    const n = Math.max(1, Math.min(count || 1, names.length));
    for (let k = names.length-1; k > 0; k--) {
      const j = Math.floor(Math.random()*(k+1));
      [names[k], names[j]] = [names[j], names[k]];
    }
    return names.slice(0, n);
  }
  function convertBySimulation(x){
    const store = (window.__LAST_SIM_RESULTS__ || {});
    const direct = store[x.id];
    const last = store.__LAST__;
    const winners = (direct && Array.isArray(direct.winners) && direct.winners.length>0)
      ? direct.winners
      : (last && Array.isArray(last.winners) && last.winners.length>0 ? last.winners : null);
    if (!winners) {
      alert("å°šæœªåŸ·è¡ŒæŠ½çæ¨¡æ“¬ï¼Œè«‹å…ˆæŒ‰ã€Œæ¨¡æ“¬æŠ½çï¼ˆå±•ç¤ºï¼‰ã€è·‘ä¸€æ¬¡ã€‚");
      return;
    }
    convertToHistoryByWinners(x.id, winners);
  }

  function convertByInput(x){
    const txt = prompt("è«‹è²¼ä¸Šå¾—çåå–®ï¼ˆæ¯è¡Œä¸€åï¼‰",""); 
    if (txt==null) return;
    const names = parseLinesClean(txt);
    if (!names.length) return alert("æ²’æœ‰æœ‰æ•ˆäººå");
    convertToHistoryByWinners(x.id, names);
  }

  // ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡ï¼ˆä¿ç•™ï¼‰
  function copyAdText(x){
    const planned = Number.isFinite(+x?._planned) ? +x._planned : 1;
    const dateStr = String(x?.date || "").trim();
    const weekday = (s) => {
      if (!s) return "";
      const d = new Date(s + "T00:00:00");
      const zh = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
      return zh[d.getDay()] || "";
    };
    const endW = weekday(dateStr);
    let announceDate = "";
    let announceW = "";
    if (dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      d.setDate(d.getDate()+1);
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
      announceDate = `${y}-${m}-${dd}`;
      announceW = weekday(announceDate);
    }
    const perCount = 1;
    const howTo = "ç›´æ¥åœ¨é€™ç¯‡ç•™è¨€ã€Œæˆ‘è¦åƒåŠ ã€å³å¯ï¼";

    const text = [
      "ğŸ‰ã€é™æ™‚æŠ½çä¾†å•¦ï¼ã€‘ğŸ‰",
      "é€™æ¬¡è¦é€å‡ºçš„çå“æ˜¯ ğŸ‘‡",
      "",
      `ğŸ ${x?.title || "ï¼ˆçå“åç¨±ï¼‰"}`,
      `å…±æŠ½ ${planned} åï¼Œæ¯äºº ${perCount} ï¼`,
      "",
      `ğŸ“Œ æŠ½å‡ºåé¡ï¼š${planned} ä½å¹¸é‹å…’`,
      `ğŸ“… æˆªæ­¢æ™‚é–“ï¼š${dateStr ? `${dateStr}ï¼ˆæ˜ŸæœŸ${endW}ï¼‰` : "ï¼ˆè‡ªé¸/å¡«æ—¥æœŸï¼‰"} æ™šä¸Š 23:59 å‰`,
      `ğŸ•° é–‹çå…¬å‘Šï¼š${announceDate ? `${announceDate}ï¼ˆæ˜ŸæœŸ${announceW}ï¼‰` : "ï¼ˆæˆªæ­¢ç¿Œæ—¥ï¼‰"} æ™šé–“å…¬å¸ƒæ–¼ç¾¤çµ„`,
      "",
      "ğŸ“£ åƒåŠ æ–¹å¼ï¼šï¼ˆå¯è‡ªå¡«ï¼‰",
      howTo,
      "",
      "âœ… å®Œå…¨å…è²»åƒåŠ ",
      "âœ… å¾—çåªéœ€è‡ªä»˜é‹è²»ï¼ˆå¯é¸è²¨åˆ°ä»˜æ¬¾ï¼‰",
    ].join("\n");

    navigator.clipboard?.writeText(text)
      .then(()=>alert("å·²è¤‡è£½æŠ½çè²¼æ–‡"))
      .catch(()=>alert("ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–"));
  }

  // è·³å‡ºå¼è³‡è¨Šé¢æ¿ / æŠ½çå±•ç¤ºï¼ˆä¿ç•™ï¼‰
  const [sheet, setSheet] = React.useState({ open:false, item:null });
  const [draw, setDraw] = React.useState({ open:false, item:null });

  const gridCols = view === "grid16" ? "grid-cols-4" : "grid-cols-3";

  // åˆ†é å™¨ï¼ˆä¿ç•™ï¼‰
  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
    </div>
  );

  // â˜… æ–°å¢ï¼šæ‰¹æ¬¡é¢æ¿é–‹é—œ
  const [batchOpen, setBatchOpen] = React.useState(false);

  // ç©©å®š Toolbarï¼ˆåŠ ä¸Šæ–°æŒ‰éˆ•ï¼šæ‰¹æ¬¡ç·¨è¼¯åƒåŠ åå–®ï¼‰
  const [toolbarFocus, setToolbarFocus] = React.useState(false);
  const ToolbarStable = React.useRef(null);
  if (!ToolbarStable.current) {
    ToolbarStable.current = function ToolbarStableComp({
      search, setSearch,
      myName, setMyName,
      mineFilter, setMineFilter,
      view, setView,
      pageSize, setPageSize,
      admin,
      toolbarFocus, setToolbarFocus,
      onOpenBatchEditor, // â˜… æ–°å¢
    }) {
      return (
        <div
          className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700"
          style={toolbarFocus ? { backdropFilter: 'none', WebkitBackdropFilter: 'none' } : undefined}
          onFocusCapture={() => setToolbarFocus(true)}
          onBlurCapture={(e) => { if (!e.currentTarget.contains(e.relatedTarget)) setToolbarFocus(false); }}
        >
          <div className="flex flex-wrap items-center gap-2">
            <input
              className="min-h-[44px] flex-1 rounded border px-3 py-2"
              placeholder="æœå°‹æ´»å‹•..."
              value={search}
              onChange={(e)=>setSearch(e.target.value)}
              inputMode="search"
              enterKeyHint="search"
              onKeyDownCapture={(e)=>{ e.stopPropagation?.(); }}
            />
            <input
              className="min-h-[44px] rounded border px-3 py-2"
              style={{minWidth:220}}
              placeholder="è¼¸å…¥ä½ çš„åå­—ï¼ˆç²¾ç¢ºæ¯”å°ï¼‰"
              value={myName}
              onChange={(e)=>setMyName(e.target.value)}
              inputMode="text"
              enterKeyHint="done"
              onKeyDownCapture={(e)=>{ e.stopPropagation?.(); }}
            />
            <div className="inline-flex rounded-lg overflow-hidden border">
              <button className={`px-3 py-2 text-sm ${mineFilter==='all'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('all')}>å…¨éƒ¨</button>
              <button className={`px-3 py-2 text-sm ${mineFilter==='joined'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('joined')}>æˆ‘å·²åƒåŠ </button>
              <button className={`px-3 py-2 text-sm ${mineFilter==='notJoined'?'bg-brand text-white':'bg-white dark:bg-slate-900'}`} onClick={()=>setMineFilter('notJoined')}>æˆ‘æœªåƒåŠ </button>
            </div>
            <label className="flex items-center gap-1">
              ç‰ˆé¢
              <select className="min-h-[44px] rounded border px-2 py-1" value={view} onChange={e=>setView(e.target.value)}>
                <option value="grid9">9 å®®æ ¼</option><option value="grid16">16 å®®æ ¼</option>
              </select>
            </label>
            <label className="flex items-center gap-1">
              æ¯é 
              <select className="min-h-[44px] rounded border px-2 py-1" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
                <option value="20">20</option><option value="40">40</option><option value="80">80</option>
              </select>
            </label>
            {admin && (
              <div className="ml-auto flex items-center gap-2">
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>window.scrollTo({top:0,behavior:"smooth"})}>æ–°å¢/ç·¨è¼¯</button>
                {/* â˜… æ–°å¢ï¼šæ‰¹æ¬¡ç·¨è¼¯åƒåŠ åå–® */}
                <button className="rounded-lg border px-3 py-1.5" onClick={onOpenBatchEditor} title="åŒä¸€è¦–çª—ï¼Œé€å¡è²¼å…¥ä¸åŒåå–®">æ‰¹æ¬¡ç·¨è¼¯åƒåŠ åå–®</button>
              </div>
            )}
          </div>
        </div>
      );
    };
  }

  // å¡ç‰‡ï¼ˆä¿ç•™ï¼‰
  const Card = ({ x, i }) => {
    const title = x?.title || x?.name || 'ï¼ˆæœªå‘½åï¼‰';
    const cover = Array.isArray(x?._images) && x._images.length>0 ? x._images[0] : (x?.image || "");
    const images = x._images || (cover ? [cover] : []);
    const count  = Array.isArray(x._candidates) ? x._candidates.length : 0;

    const [checkedMap, setCheckedMap] = React.useState({});
    const toggleCheck = (name) => setCheckedMap(m => ({...m, [name]: !m[name]}));

    return (
      <details key={x.id || i} className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden">
        <summary className="list-none cursor-pointer p-3" onClick={(e)=>{ e.preventDefault(); setSheet({ open:true, item:x }); }}>
          <div className="flex flex-col">
            <div className="relative aspect-[4/3] overflow-hidden rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
              {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
              <div className="absolute left-2 top-2 rounded bg-black/60 text-white text-xs px-2 py-1">å€™é¸ {count} äºº</div>
            </div>
            <div className="mt-2 text-[13px] font-medium truncate" title={title}>{title}</div>
            {x.date && <div className="text-xs text-slate-500">æ—¥æœŸï¼š{x.date}</div>}
          </div>
        </summary>

        <div className="px-3 pb-3">
          {Array.isArray(images) && images.length>0 && (
            <div className="mt-2 -mx-1 px-1 flex overflow-x-auto gap-2 snap-x snap-mandatory">
              {images.map((src,idx)=>(
                <button key={idx} className="shrink-0 w-24 aspect-square rounded-lg overflow-hidden border snap-start bg-white/60 dark:bg-slate-900/50" title={`åœ–ç‰‡ ${idx+1}`} onClick={(e)=>{ e.preventDefault(); openViewer(images, idx, title); }}>
                  <img src={src} alt="" className="w-full h-full object-contain" loading="lazy" />
                </button>
              ))}
            </div>
          )}

          {admin && (
            <div className="mt-3 space-y-2">
              <div>
                <div className="mb-1 text-sm font-medium">å·²å ±åï¼ˆ{x._candidates.length} äººï¼‰</div>
                {x._candidates.length===0 ? <div className="text-slate-500">å°šç„¡åå–®</div> : (
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-1">
                    {x._candidates.map((n,ii)=>(
                      <label key={ii} className="rounded border px-2 py-1 flex items-center gap-2">
                        <input type="checkbox" checked={!!checkedMap[n]} onChange={()=>toggleCheck(n)} />
                        <span>{n}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>

              <div className="flex flex-wrap gap-2 justify-end">
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>editItem(x)}>ç·¨è¼¯</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>copyAdText(x)}>ä¸€éµè¤‡è£½æŠ½çè²¼æ–‡</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertBySimulation(x)}>ä»¥æ¨¡æ“¬çµæœè½‰æ­·å²</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByChecked(x, checkedMap)}>ä»¥å‹¾é¸åå–®è½‰æ­·å²</button>
                <button className="rounded-lg border px-3 py-1.5" onClick={()=>convertByInput(x)}>ç›´æ¥è¼¸å…¥åå–®è½‰æ­·å²</button>
                <button className="rounded-lg bg-rose-500 text-white px-3 py-1.5" onClick={()=>removeItemObj(x)}>åˆªé™¤</button>
              </div>
            </div>
          )}
        </div>
      </details>
    );
  };

  // â˜… æ–°å¢ï¼šé€å¡è²¼åå–®ï¼ˆæ‰¹æ¬¡ï¼‰é¢æ¿
  function BatchParticipantsDialog({ open, onClose }) {
    const [modeMap, setModeMap] = React.useState({});     // { [id]: 'append' | 'replace' }
    const [textMap, setTextMap] = React.useState({});     // { [id]: '...\n...' }

    const norm = (s) => String(s ?? "")
      .replace(/[\u200B-\u200D\uFEFF]/g, "") // é›¶å¯¬
      .replace(/\u3000/g, " ")               // å…¨å½¢ç©ºç™½â†’åŠå½¢
      .replace(/[ \t]+/g, " ")
      .trim();

    const dedupeLines = (arr=[]) => {
      const seen = new Set(); const out = [];
      for (const line of arr) {
        const n = norm(line);
        if (!n) continue;
        const key = n.toLowerCase();
        if (!seen.has(key)) { seen.add(key); out.push(n); }
      }
      return out;
    };

    const handleClean = (id) => {
      const raw = String(textMap[id] || "");
      const cleaned = raw.split(/\r?\n|,|ã€|\s+/).map(s=>s.trim()).filter(Boolean).join("\n");
      setTextMap(m => ({ ...m, [id]: cleaned }));
    };
    const handleDedupe = (id) => {
      const raw = String(textMap[id] || "");
      const out = dedupeLines(raw.split(/\r?\n/));
      setTextMap(m => ({ ...m, [id]: out.join("\n") }));
      // å¯é¸æç¤º
      // alert(`å·²å»é™¤é‡è¤‡ ${Math.max(0, raw.split(/\r?\n/).filter(Boolean).length - out.length)} ç­†`);
    };

    const applyToItem = (item) => {
      const id = String(item.id);
      const incoming = dedupeLines(String(textMap[id] || "").split(/\r?\n/));
      const mode = modeMap[id] || "append";
      const current = Array.isArray(item._candidates) ? item._candidates.slice() : [];

      let merged = current.slice();
      if (mode === "replace") {
        merged = incoming.slice();
      } else {
        // è¿½åŠ ï¼šä¿ç•™ç¾æœ‰æ¨£è²Œï¼Œåƒ…æŠŠä¸å­˜åœ¨çš„ï¼ˆå¿½ç•¥å¤§å°å¯«/ç©ºç™½å·®ç•°ï¼‰åŠ å…¥å°¾ç«¯
        const exist = new Set(current.map(c => norm(c).toLowerCase()));
        for (const n of incoming) {
          const key = n.toLowerCase();
          if (!exist.has(key)) { merged.push(n); exist.add(key); }
        }
      }
      updateItemParticipants({
        id,
        item,
        lines: merged,
        text: merged.join("\n"),
      });
    };

    if (!open) return null;
    return (
      <div className="fixed inset-0 z-[1000] bg-black/50 backdrop-blur-sm flex">
        <div className="m-auto w-[min(1000px,96vw)] max-h-[92vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl flex flex-col">
          <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div className="font-semibold">æ‰¹æ¬¡ç·¨è¼¯åƒåŠ åå–®ï¼ˆé€å¡å„è²¼å„çš„ï¼‰</div>
            <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
          </div>

          <div className="flex-1 overflow-y-auto p-3 grid gap-3">
            {allItems.length === 0 && <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰ã€ç­‰å¾…é–‹çã€‘æ´»å‹•</div>}

            {allItems.map((it) => (
              <div key={it.id} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3 bg-white/70 dark:bg-slate-900/60">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-medium truncate" title={it.title || "ï¼ˆæœªå‘½åï¼‰"}>ğŸ {it.title || "ï¼ˆæœªå‘½åï¼‰"}</div>
                  <div className="text-xs text-slate-500">ç›®å‰ï¼š{it._candidates.length} ä½</div>
                </div>

                <textarea
                  className="mt-2 w-full rounded-lg border p-2 h-28 font-mono text-sm"
                  placeholder="ä¸€è¡Œä¸€ä½ï¼Œå¯è²¼ @name æˆ–ä»¥ç©ºç™½/é€—è™Ÿåˆ†éš”ï¼›æ­¤å€åƒ…å½±éŸ¿æœ¬å¡"
                  value={textMap[it.id] ?? ""}
                  onChange={(e)=>setTextMap(m => ({ ...m, [it.id]: e.target.value }))}
                />

                <div className="mt-2 flex flex-wrap items-center gap-2">
                  <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>handleClean(it.id)} title="ç§»é™¤ç©ºç™½è¡Œã€ä¿®å‰ªå…©å´ç©ºç™½ã€é€—è™Ÿ/ç©ºç™½ä¹Ÿæœƒåˆ†è¡Œ">âœ¨ æ¸…é™¤ç©ºç™½è¡Œ/é›œè¨Š</button>
                  <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>handleDedupe(it.id)} title="å¿½ç•¥å¤§å°å¯«/å¤šç©ºç™½ â†’ å»é‡ï¼›ä¿ç•™ç¬¬ä¸€ç­†æ¨£å¼">ğŸ§¹ å»é™¤é‡è¤‡</button>

                  <label className="ml-auto text-sm flex items-center gap-1">
                    å¥—ç”¨æ¨¡å¼
                    <select
                      className="rounded border px-2 py-1"
                      value={modeMap[it.id] || "append"}
                      onChange={(e)=>setModeMap(m => ({ ...m, [it.id]: e.target.value }))}
                    >
                      <option value="append">è¿½åŠ ï¼ˆä¿ç•™åŸåå–®ï¼‰</option>
                      <option value="replace">è¦†è“‹ï¼ˆä»¥æ­¤ç‚ºæ–°åå–®ï¼‰</option>
                    </select>
                  </label>
                  <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={()=>applyToItem(it)}>å¥—ç”¨åˆ°æ­¤å¡</button>
                </div>
              </div>
            ))}
          </div>

          <div className="p-3 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-500">
            è²¼å¿ƒæé†’ï¼šåªæœ‰æŒ‰ä¸‹ã€Œå¥—ç”¨åˆ°æ­¤å¡ã€çš„æ´»å‹•æ‰æœƒå¯«å…¥ï¼›é—œé–‰è¦–çª—ä¸æœƒè‡ªå‹•å¥—ç”¨ã€‚
          </div>
        </div>
      </div>
    );
  }

  return (
    <section className="space-y-3">
      {/* æ–°å¢/ç·¨è¼¯è¡¨å–®ï¼ˆç®¡ç†å“¡å¯è¦‹ï¼‰ */}
      {admin && (
        <div className="rounded-xl border p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="min-h-[44px] rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e => setDraft(d => ({ ...d, date: e.target.value }))} placeholder="é–‹ç/æˆªæ­¢æ—¥æœŸ" />
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.title} onChange={e => setDraft(d => ({ ...d, title: e.target.value }))} placeholder="çé …åç¨±" />
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.plannedWinners} onChange={e => setDraft(d => ({ ...d, plannedWinners: e.target.value }))} placeholder="æŠ½å‡ºåé¡ï¼ˆå¯ç©ºï¼Œé è¨­1ï¼‰" />
            <input className="min-h-[44px] rounded-lg border px-3 py-2" value={draft.image} onChange={e => setDraft(d => ({ ...d, image: e.target.value }))} placeholder="å°é¢åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰" />
          </div>

          {/* åå–®è¼¸å…¥å€ï¼ˆä¿ç•™ï¼‰ */}
          <div>
            <label className="text-sm text-slate-500">å·²å ±ååå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
            <textarea className="mt-1 w-full rounded-lg border p-2 h-28 font-mono text-sm" value={draft.participantsText} onChange={e => setDraft(d => ({ ...d, participantsText: e.target.value }))} placeholder="@name1\n@name2\n@name3" />
            <div className="mt-2 flex flex-wrap items-center gap-2">
              <button type="button" className="rounded-lg border px-3 py-1.5 text-sm" title="å¿½ç•¥å¤§å°å¯«ã€ç§»é™¤é›¶å¯¬å­—å…ƒã€å…¨å½¢ç©ºç™½â†’åŠå½¢ã€å¤šé‡ç©ºç™½æŠ˜æˆä¸€æ ¼" onClick={() => {
                const src = String(draft?.participantsText || "").split(/\r?\n/);
                const norm = (s) => String(s ?? "").replace(/[\u200B-\u200D\uFEFF]/g, "").replace(/\u3000/g, " ").replace(/[ \t]+/g, " ").trim();
                const seen = new Set(); const out = [];
                for (const line of src) { const n = norm(line); if (!n) continue; const key = n.toLowerCase(); if (!seen.has(key)) { seen.add(key); out.push(n); } }
                const before = src.map(norm).filter(Boolean).length; const after  = out.length; const removed = Math.max(0, before - after);
                setDraft(d => ({ ...d, participantsText: out.join("\n") }));
                if (removed > 0) { try { alert(`å·²å»é™¤é‡è¤‡ ${removed} ç­†`); } catch {} }
              }}>ğŸ§¹ å»é™¤é‡è¤‡ï¼ˆå»ºè­°ï¼‰</button>

              <button type="button" className="rounded-lg border px-3 py-1.5 text-sm" title="ç§»é™¤ç©ºç™½è¡Œã€ä¿®å‰ªæ¯è¡Œå…©å´ç©ºç™½" onClick={() => {
                const cleaned = String(draft.participantsText || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean).join("\n");
                setDraft(d => ({ ...d, participantsText: cleaned }));
              }}>âœ¨ æ¸…é™¤ç©ºç™½è¡Œ/é›œè¨Š</button>

              <span className="ml-auto text-sm text-slate-500">
                ç›®å‰å…± {String(draft.participantsText || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean).length} ä½
              </span>
            </div>
          </div>

          <div className="flex gap-2 justify-end">
            {editingId && (<button onClick={cancelEdit} className="rounded-lg border px-3 py-1.5">å–æ¶ˆ</button>)}
            <button onClick={upsertFromDraft} className="rounded-lg bg-brand text-white px-3 py-1.5">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢æ´»å‹•"}</button>
          </div>
        </div>
      )}

      {/* å·¥å…·åˆ— + åˆ†é å™¨ */}
      <div className="sticky top-0 z-10">
        <ToolbarStable.current
          search={search} setSearch={setSearch}
          myName={myName} setMyName={setMyName}
          mineFilter={mineFilter} setMineFilter={setMineFilter}
          view={view} setView={setView}
          pageSize={pageSize} setPageSize={setPageSize}
          admin={admin}
          toolbarFocus={toolbarFocus} setToolbarFocus={setToolbarFocus}
          onOpenBatchEditor={()=>setBatchOpen(true)} // â˜…
        />
      </div>

      <div className="sm:flex"><Paginator /></div>

      {/* æ¸…å–® */}
      <div className={`grid ${gridCols} gap-3`} aria-label="ç­‰å¾…é–‹çæ¸…å–®">
        {pageItems.map((x, i) => <Card key={x.id || i} x={x} i={i} />)}
      </div>

      <Paginator />

      {/* å…§å»º Viewerï¼ˆå…±ç”¨ï¼‰ */}
      <Viewer state={viewer} setState={setViewer} />

      {/* è·³å‡ºå¼è³‡è¨Šé¢æ¿ï¼ˆç­‰å¾…é–‹çï¼‰ */}
      <ProductSheet
        open={sheet.open}
        item={sheet.item}
        context="pending"
        admin={!!admin}
        onClose={()=>setSheet({ open:false, item:null })}
        onOpenViewer={(images, idx, title)=>openViewer(images, idx, title)}
        onStartDraw={(it)=>setDraw({ open:true, item:it })}
        onAdmin={{
          onEdit:(it)=>editItem(it),
          onDelete:(it)=>removeItemObj(it),
          onCopyAd:(it)=>copyAdText(it),
          onConvertBySim:(it)=>convertBySimulation(it),
          onConvertByChecked:(it, map)=>convertByChecked(it, map ?? getCheckedMap(it.id)),
          onConvertByInput:(it)=>convertByInput(it),
          checkedMap: sheet.item ? getCheckedMap(sheet.item.id) : {},
          toggleCheck: sheet.item ? makeToggleCheck(sheet.item.id) : ()=>{},
          // â˜… ä¿ç•™ï¼šå°å¡ã€Œå¥—ç”¨åˆªé™¤ã€å›å¯«
          onUpdateParticipants: updateItemParticipants,
        }}
      />

      {/* æŠ½çå±•ç¤ºï¼ˆå…¨è¢å¹•è¦†è“‹ï¼‰ */}
      <DrawSimulator
        open={draw.open}
        onClose={()=>setDraw({ open:false, item:null })}
        participants={draw.item ? normalizeItem(draw.item)._candidates : []}
        defaultCount={draw.item ? normalizeItem(draw.item)._planned || 1 : 1}
      />

      {/* â˜… æ–°å¢ï¼šåŒä¸€è¦–çª—é€å¡è²¼åå–®ï¼ˆæ‰¹æ¬¡ï¼‰ */}
      <BatchParticipantsDialog open={!!batchOpen} onClose={()=>setBatchOpen(false)} />
    </section>
  );
}



/* ============================
 * æŠ½çæ¨¡æ“¬å™¨ï¼ˆå±•ç¤ºç”¨ï¼‰
 * - åªé¡¯ç¤ºå‹•ç•«èˆ‡çµæœï¼Œä¸å¯«å›è³‡æ–™ã€ä¸æä¾›è¤‡è£½/å¥—ç”¨
 * props:
 *   open, onClose, participants (string[]), defaultCount (number)
 *   itemId?: string  // ç”¨æ–¼æš«å­˜æœ€è¿‘ä¸€æ¬¡æ¨¡æ“¬çµæœ
 * ============================ */
function DrawSimulator({ open=false, onClose=()=>{}, participants=[], defaultCount=1, itemId=null }) {
  const React = window.React || globalThis.React;
  const overlayRef = React.useRef(null);

  const [count, setCount] = React.useState(Math.max(1, defaultCount||1));
  const [duration, setDuration] = React.useState(2200); // 2.2s
  const [running, setRunning] = React.useState(false);
  const [displayName, setDisplayName] = React.useState("");
  const [results, setResults] = React.useState([]);

  React.useEffect(()=>{
    if (!open) return;
    const onKey = (e)=>{ if (e.key==="Escape") onClose(); };
    const onPop = ()=> onClose();
    document.addEventListener("keydown", onKey);
    window.addEventListener("popstate", onPop);
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    try { history.pushState({ draw:true }, "", location.href); } catch {}
    return ()=> {
      document.removeEventListener("keydown", onKey);
      window.removeEventListener("popstate", onPop);
      document.body.style.overflow = prev;
    };
  }, [open, onClose]);

  const handleOverlayClick = (e)=>{ if (e.target === overlayRef.current && !running) onClose(); };

  const pickWinners = (arr, k) => {
    const list = [...arr];
    for (let i=list.length-1;i>0;i--) {
      const j = Math.floor(Math.random()*(i+1));
      [list[i], list[j]] = [list[j], list[i]];
    }
    return list.slice(0, Math.max(1, Math.min(k, list.length)));
  };

  const start = ()=>{
    if (!Array.isArray(participants) || participants.length===0) { alert("æ²’æœ‰å€™é¸åå–®"); return; }
    setResults([]);
    setRunning(true);
    const startTime = performance.now();
    const total = participants.length;
    let acc = 0, last = startTime;
    const loop = (t)=>{
      const dt = t - last; last = t;
      const p = Math.min(1, (t - startTime) / Math.max(800, duration));
      const ease = 1 - Math.pow(1 - p, 3); // easeOutCubic
      const speed = 30 + (180 - 30) * (1 - ease);
      acc += dt * (speed / 1000) * 20;
      const idx = Math.floor(acc) % total;
      setDisplayName(participants[idx] || "");
      if (p < 1) requestAnimationFrame(loop);
      else { setResults(pickWinners(participants, Math.max(1, +count||1))); setRunning(false); }
    };
    requestAnimationFrame(loop);
  };

  // å¿«å–æœ€è¿‘ä¸€æ¬¡æ¨¡æ“¬çµæœï¼ˆä¾ itemIdï¼›ä¸¦æä¾› __LAST__ å¾Œå‚™ï¼‰
  React.useEffect(() => {
    if (!open) return;
    if (!Array.isArray(results) || results.length === 0) return;
    window.__LAST_SIM_RESULTS__ = window.__LAST_SIM_RESULTS__ || {};
    if (itemId) window.__LAST_SIM_RESULTS__[itemId] = { winners: results, time: Date.now(), itemId };
    window.__LAST_SIM_RESULTS__.__LAST__ = { winners: results, time: Date.now(), itemId: itemId || null };
  }, [open, itemId, results]);

  if (!open) return null;

  return (
    <div
      ref={overlayRef}
      className="fixed inset-0 z-[1000] bg-black/70 backdrop-blur flex items-center justify-center"
      role="dialog" aria-modal="true"
      onMouseDown={handleOverlayClick}
    >
      <div className="w-[min(96vw,50rem)] max-h-[92vh] rounded-2xl bg-white dark:bg-slate-900 shadow-elevate overflow-hidden flex flex-col">
        <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
          <div className="font-semibold">æŠ½çæ¨¡æ“¬ï¼ˆå±•ç¤ºï¼‰</div>
          <button className="rounded-full border px-3 py-1.5 text-sm" onClick={onClose} disabled={running}>é—œé–‰</button>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">æŠ½å‡ºäººæ•¸</span>
              <input type="number" min="1" max={Math.max(1, participants.length)} value={count} onChange={e=>setCount(Math.max(1, Math.min(+e.target.value||1, participants.length||1)))} className="w-20 rounded border px-2 py-1" />
            </label>
            <label className="flex items-center gap-2">
              <span className="text-sm whitespace-nowrap">å‹•ç•«æ™‚é•·(ms)</span>
              <input type="number" min="800" step="100" value={duration} onChange={e=>setDuration(Math.max(800, +e.target.value||2200))} className="w-28 rounded border px-2 py-1" />
            </label>
          </div>

          <div className="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 p-6 min-h-[140px] grid place-content-center">
            <div className="text-2xl md:text-3xl font-semibold text-slate-800 dark:text-white tracking-wide animate-pulse select-none">
              {running ? (displayName || "æŠ½é¸ä¸­...") : (results.length ? "æŠ½é¸å®Œæˆ" : "æº–å‚™é–‹å§‹")}
            </div>
            {!running && !results.length && (
              <div className="mt-2 text-xs text-slate-500">åå–®æ•¸ï¼š{participants.length}</div>
            )}
          </div>

          {!!results.length && (
            <div className="space-y-2">
              <div className="text-sm text-slate-600">ä¸­çåå–®ï¼ˆ{results.length}ï¼‰</div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                {results.map((name, i)=>(
                  <div key={name+i} className="rounded-lg border border-emerald-300/70 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 px-3 py-2 text-sm animate-[fadeIn_.6s_ease-out]">
                    <span className="opacity-70 mr-1">#{i+1}</span>{name}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="p-3 border-t border-slate-200 dark:border-slate-800 bg-white/95 dark:bg-slate-900/90 backdrop-blur flex items-center gap-2">
          {!running && <button className="flex-1 rounded-lg bg-brand text-white px-4 py-2 text-sm" onClick={start}>é–‹å§‹æŠ½ç</button>}
          {running && <button className="flex-1 rounded-lg border px-4 py-2 text-sm" disabled>æŠ½é¸é€²è¡Œä¸­...</button>}
          <button className="rounded-lg border px-3 py-2 text-sm" onClick={onClose} disabled={running}>é—œé–‰</button>
        </div>
      </div>
    </div>
  );
}

/* å°å·¥å…·ï¼šhash/PRNGï¼ˆfor ç¨®å­é‡ç¾ï¼‰ */
function xmur3(str) { let h = 1779033703 ^ str.length; for (let i=0;i<str.length;i++) { h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h<<13 | h>>>19; } return function() { h = Math.imul(h ^ (h>>>16), 2246822507); h = Math.imul(h ^ (h>>>13), 3266489909); return (h ^= h>>>16) >>> 0; }; }
function mulberry32(a) { return function() { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }

// å–å¾—å•†å“å‰©é¤˜æ•¸é‡ï¼ˆç›¸å®¹å¤šç¨®æ¬„ä½å‘½åï¼‰
function getRemain(x){
  const cand = [x?.stock, x?.qty, x?.quantity, x?.remaining];
  for (const v of cand){
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    if (typeof v === 'string' && v.trim()!=='' && !Number.isNaN(+v)) return +v;
  }
  return null; // æ²’æœ‰æ•¸é‡å°±ä¸é¡¯ç¤º
}

// é˜²å‘†åˆªé™¤é—œéµå­—ç¢ºèªï¼ˆé è¨­é—œéµå­—ï¼šåˆªé™¤ï¼‰
function confirmKeyword({ label='', keyword='åˆªé™¤' } = {}){
  const input = prompt(`ç‚ºäº†é˜²å‘†ï¼Œè«‹è¼¸å…¥ã€Œ${keyword}ã€ä»¥ç¢ºèªï¼š\n${label}`);
  return input === keyword;
}

// â€”â€” ç©ºè³‡æ–™ï¼ˆå…¨éƒ¨ç•™çµ¦ä½ ç”¨ Admin å¾ŒçºŒæ–°å¢ï¼‰ â€”â€”
// ç›´æ¥åœ¨ EMPTY å…§æ”¾å…¥ settingsï¼ˆæ³¨æ„ others å¾Œé¢çš„é€—è™Ÿï¼‰
const EMPTY = {
  homepage: { title: 'CxQé–‹çæ‰€ï½œå®˜æ–¹å¹³å°', subtitle: 'ç›²ç›’ãƒ»å…¬ä»”ãƒ»å°ç‰©é€æ˜è²©å”®èˆ‡äº¤æµ\næŠ½çç‚ºé™„å±¬å›é¥‹ï¼Œå…¬é–‹ç´€éŒ„ï¼Œå®‰å¿ƒä¸‹å–®', announcements: [] },
  history: [],     // ğŸ“š æ­·å²æŠ½çç´€éŒ„
  pending: [],     // â³ ç­‰å¾…é–‹ç
  ongoing: [],     // ğŸ”„ é€²è¡Œä¸­æ´»å‹•

  // ğŸ›ï¸ é»æ•¸å•†åŸï¼ˆåŸæœ¬å°±æœ‰ï¼‰
  shop: { items: [], people: [] },

  // ğŸ›’ï¼ˆæ–°å¢ï¼‰ç¤¾ç¾¤å•†åº—ï¼šçœŸéŒ¢è²©å”®ç”¨ï¼›æ”¯æ´å¤šåœ–ã€ä»‹ç´¹ã€å¤–éƒ¨è³¼è²·é€£çµ
  // images: [string]ï¼ˆåœ–ç‰‡ URL æˆ– ImageIO keyï¼‰ï¼Œæœƒè·Ÿè‘— data ä¸€èµ·åŒ¯å‡º
  // buyUrl: å¤–éƒ¨è³¼è²·ç¶²å€
  // stock: æ•¸é‡ï¼ˆå¯é¸ï¼‰ï¼Œprice: å”®åƒ¹ï¼ˆå­—ä¸²æˆ–æ•¸å­—ï¼‰
  // tags: ä¾‹å¦‚ ["ç©å…·","å®¶é›»"]ï¼Œå¯è¢«æœå°‹
  store: { items: [] },

  // ğŸ“Œ å…¶ä»–è³‡æ–™å¡ç‰‡é›†åˆï¼ˆé€™è¡Œå¾Œé¢ä¸€å®šè¦é€—è™Ÿï¼‰
  others: { cards: [] },

  settings: { ...DEFAULT_SETTINGS },
};



function normName(s=""){ return s.replace(/\u3000/g," ").replace(/\s+/g," ").trim().toLowerCase(); }
function parseISODate(d=""){ // å°ˆåƒ YYYY-MM-DDï¼ˆç©ºå­—ä¸²å› NaNï¼‰
  if(!d) return NaN;
  // å¼·åˆ¶ç”¨ UTC é˜²æ­¢æ™‚å€åç§»
  const m = String(d).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return NaN;
  return Date.UTC(+m[1], +m[2]-1, +m[3]);
}
function sortHistoryDesc(arr=[]) {
  const safe = (x)=> {
    const t = parseISODate(x?.date || "");
    return Number.isNaN(t) ? -Infinity : t; // æ²’æ—¥æœŸçš„æ’æœ€ä¸‹
  };
  return [...arr].sort((a,b)=> safe(b) - safe(a));
}


/* === çµ±ä¸€æ—¥æœŸé¡¯ç¤ºï¼šæŠŠ YYYY-MM-DD â†’ YYYY/MM/DDï¼ˆç”¨ UTC å…æ™‚å€åå·®ï¼‰ === */
function formatDateYMD(ymd=""){
  const ts = parseISODate(ymd);        // ä½ æª”æ¡ˆè£¡å·²å­˜åœ¨çš„å‡½å¼:contentReference[oaicite:2]{index=2}
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth()+1).padStart(2, '0');
  const day = String(d.getUTCDate()).padStart(2, '0');
  return `${y}/${m}/${day}`;
}

/* === ä¾æ­·å²ã€Œç‹€æ…‹ã€å›å‚³ä¸€å€‹æŸ”å’Œåº•è‰²ï¼ˆå¯é¸ç”¨ï¼‰ === */
function rowClassByStatus(status=""){
  switch(String(status).trim()){
    case "å·²å¯„å‡º":   return "bg-emerald-50/60 dark:bg-emerald-300/10";
    case "è™•ç†ä¸­":   return "bg-sky-50/60 dark:bg-sky-300/10";
    case "æœªå›è¦†":   return "bg-rose-50/60 dark:bg-rose-300/10";
    case "å†å¯„é€ä¸­": return "bg-indigo-50/60 dark:bg-indigo-300/10";
    case "å¾…å¯„é€":   return "bg-amber-50/60 dark:bg-amber-300/10";
    case "æ”¾æ£„é ˜ç": return "bg-slate-50/60 dark:bg-slate-300/10";
    default:         return "";
  }
}

// === Calendar helpers for History ===
function ymdStringUTC(y, mZeroBased, d) {
  const y4 = String(y).padStart(4, '0');
  const m2 = String(mZeroBased + 1).padStart(2, '0');
  const d2 = String(d).padStart(2, '0');
  return `${y4}-${m2}-${d2}`;
}

function buildMonthDaysUTC(y, mZeroBased) {
  // ä»¥ UTC è¨ˆç®—æœˆæ›†ï¼Œé¿å…æ™‚å€åç§»
  const first = new Date(Date.UTC(y, mZeroBased, 1));
  const startDow = first.getUTCDay(); // 0=Sun..6=Sat
  const daysInMonth = new Date(Date.UTC(y, mZeroBased + 1, 0)).getUTCDate();

  const days = [];
  for (let i = 0; i < startDow; i++) days.push(null); // å‰å°ç©ºæ ¼
  for (let d = 1; d <= daysInMonth; d++) {
    days.push(ymdStringUTC(y, mZeroBased, d));
  }
  return days;
}






// === Utils: æŠ½çç”¨ï¼ˆå®‰å…¨éš¨æ©Ÿ / å¯é¸ç¨®å­ï¼‰ ===
// å°‡å­—ä¸²è®Šæˆ 32-bit æ•´æ•¸ç¨®å­
function hash32(str="") {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
// xorshift32 ç”¢ç”Ÿå™¨ï¼ˆå¯é‡ç¾ï¼‰
function makePRNG(seedStr="") {
  if (!seedStr) return null; // æ²’ç¨®å­å°±ç”¨å®‰å…¨éš¨æ©Ÿ
  let x = hash32(seedStr) || 1;
  return function next() {
    // ç”¢ 0..1 çš„æµ®é»æ•¸
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    // è½‰æˆ 0..1
    return ((x >>> 0) / 4294967296);
  };
}
// Fisherâ€“Yates æ´—ç‰Œï¼›å„ªå…ˆä½¿ç”¨ prngï¼Œå¦å‰‡ç”¨ crypto å®‰å…¨éš¨æ©Ÿ
function shufflePick(arr, k, prng=null) {
  const a = arr.slice();
  const n = a.length;
  // åªæ´—åˆ°å–åˆ° k å€‹ç‚ºæ­¢
  for (let i = 0; i < k; i++) {
    let r;
    if (prng) {
      r = i + Math.floor(prng() * (n - i));
    } else {
      const buf = new Uint32Array(1);
      crypto.getRandomValues(buf);
      r = i + (buf[0] % (n - i));
    }
    [a[i], a[r]] = [a[r], a[i]];
  }
  return a.slice(0, k);
}

function drawCooldownKey(pendingId){ return `kjs_draw_cd_${pendingId}`; }

// === Announcement helpers (NEW) ===
// å®‰å…¨æŠŠ YYYY-MM-DD åŠ å¤©æ•¸ï¼ˆUTCï¼Œä¸åƒæ™‚å€èª¤å·®ï¼‰
function addDaysUTC(ymd="", days=1){
  const ts = parseISODate(ymd);
  if (Number.isNaN(ts)) return "";
  const d = new Date(ts);
  d.setUTCDate(d.getUTCDate() + days);
  const y = d.getUTCFullYear(), m = d.getUTCMonth(), day = d.getUTCDate();
  return ymdStringUTC(y, m, day);
}

// ä¾å¡ç‰‡è³‡æ–™ç”¢ç”Ÿå…¬å‘Šæ¨¡æ¿ï¼ˆå›å‚³å­—ä¸²ï¼‰
function buildAnnouncementText(p = {}, opts = {}) {
  const title   = p?.title || p?.name || "ï¼ˆæœªå‘½åï¼‰";
  const planned = Number(p?.planned || p?.quota || p?.winners || 1);
  const deadline = (p?.deadline || p?.date || "").toString().trim();
  const announce = deadline ? plusDays(deadline, 1) : "";
  const howTo = (typeof opts.howTo === "string" && opts.howTo.trim())
    ? opts.howTo.trim()
    : "ç›´æ¥åœ¨é€™ç¯‡ç•™è¨€ã€Œæˆ‘è¦åƒåŠ ã€å³å¯ï¼";

  return [
    "ğŸ‰ã€é™æ™‚æŠ½çä¾†å•¦ï¼ã€‘ğŸ‰",
    "é€™æ¬¡è¦é€å‡ºçš„å¯¦ç”¨å¥½ç‰©æ˜¯ ğŸ‘‡",
    "",
    `ğŸ ${title}`,
    `ğŸ“Œ æŠ½å‡ºåé¡ï¼š${planned} ä½å¹¸é‹å…’`,
    `ğŸ“… æˆªæ­¢æ™‚é–“ï¼š${deadline} æ™šä¸Š 23:59 å‰`,
    `ğŸ•° é–‹çå…¬å‘Šï¼š${announce} æ™šé–“å…¬å¸ƒæ–¼ç¾¤çµ„`,
    "",
    "ğŸ“£ åƒåŠ æ–¹å¼ï¼š(åˆå§‹å¦‚ä¸‹ï¼Œæ‡‰èƒ½æ›´æ”¹ï¼Œå¦‚æœ‰ç‰¹åˆ¥ä»»å‹™å¯è‡ªå¡«)",
    howTo,
    "",
    "âœ… å®Œå…¨å…è²»åƒåŠ ",
    "âœ… å¾—çåªéœ€è‡ªä»˜é‹è²»ï¼ˆå¯é¸è²¨åˆ°ä»˜æ¬¾ï¼‰",
  ].join("\n");
}

// å°å·¥å…·ï¼šæŠŠ YYYY-MM-DD åŠ  N å¤©
function plusDays(ymd, days){
  const d = new Date(ymd);
  if (Number.isNaN(d.getTime())) return ymd;
  d.setDate(d.getDate() + (days||0));
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2, "0"), dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

// === Collapseï¼ˆå¼·åŒ–ç‰ˆï¼Œå‘ä¸‹ç›¸å®¹ï¼‰===
// ä¿ç•™åŸï¼šheader, children, defaultOpen=false, force=null
// æ–°å¢ï¼šgroupï¼ˆåŒä¸€ç¾¤æ‰‹é¢¨ç´ idï¼‰ï¼Œuidï¼ˆè©²é …å”¯ä¸€ idï¼‰
function Collapse({ header, children, defaultOpen=false, force=null, group=null, uid=null }) {
  const { useState, useRef, useEffect } = React;
  const [open, setOpen] = useState(!!defaultOpen);
  const ref = useRef(null);
  const idRef = useRef(uid || Math.random().toString(36).slice(2,10));
  const grp = group || null;

  // force è¦†å¯«ï¼ˆé…åˆä½ çš„ã€Œå…¨éƒ¨å±•é–‹ï¼æ”¶åˆã€ï¼‰
  useEffect(() => {
    if (force === 'open') setOpen(true);
    else if (force === 'close') setOpen(false);
  }, [force]);

  // é«˜åº¦å‹•ç•«ï¼šä¾ open/children é‡æ–°è¨ˆç®—
  useEffect(() => {
    if (!ref.current) return;
    ref.current.style.height = open ? ref.current.scrollHeight + 'px' : '0px';
  }, [open, children]);

  // æ‰‹é¢¨ç´ï¼šåŒç¾¤æœ‰å…¶å®ƒé …ç›®æ‰“é–‹ â†’ é—œé–‰æˆ‘
  useEffect(() => {
    if (!grp) return;
    const onOpen = (e) => {
      const { group, uid } = e.detail || {};
      if (group === grp && uid !== idRef.current) setOpen(false);
    };
    document.addEventListener('kjs:accordionOpen', onOpen);
    return () => document.removeEventListener('kjs:accordionOpen', onOpen);
  }, [grp]);

  const handleToggle = () => {
    if (force === 'open' || force === 'close') return;
    const next = !open;
    setOpen(next);
    if (next && grp) {
      const ev = new CustomEvent('kjs:accordionOpen', { detail: { group: grp, uid: idRef.current }});
      document.dispatchEvent(ev);
    }
  };

  return (
    <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden bg-white/70 dark:bg-slate-900/40">
      <button
        className="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-slate-50/80 dark:hover:bg-slate-800/60 transition"
        onClick={handleToggle}
        aria-expanded={open ? 'true' : 'false'}
        type="button"
      >
        <div className="font-medium">
          {typeof header === 'function' ? header(open) : header}
        </div>
        <svg className={"w-4 h-4 transition " + (open ? "rotate-180" : "")} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
      <div ref={ref} className="px-4 pb-4 transition-[height] duration-300 ease-in-out" style={{height: open?'auto':'0px'}}>
        <div className="pt-2">{children}</div>
      </div>
    </div>
  );
}


/***************************************************
 * useAccordionControllerï¼šæ‰‹é¢¨ç´æ§åˆ¶ï¼ˆä¸€æ¬¡åªé–‹ä¸€å€‹ï¼‰
 * ä¹Ÿæ”¯æ´ã€Œå…¨éƒ¨å±•é–‹ / å…¨éƒ¨æ”¶åˆã€è¦†å¯«
 ***************************************************/
function useAccordionController() {
  const [activeId, setActiveId] = React.useState(null); // æ­£åœ¨å±•é–‹çš„ id
  const [force, setForce] = React.useState(null);       // 'open' | 'close' | null

  const openAll  = () => setForce('open');
  const closeAll = () => { setForce('close'); setActiveId(null); };
  const clearForce = () => setForce(null);

  // ç¶åˆ°æ¯å€‹ Collapse ç”¨
  const bind = (id) => ({
    isOpen: force === 'open' ? true : force === 'close' ? false : activeId === id,
    force,
    onToggle: () => {
      if (force) setForce(null); // åªè¦æ‰‹å‹•åˆ‡æ›ï¼Œå›æ­¸æ‰‹é¢¨ç´æ¨¡å¼
      setActiveId(prev => (prev === id ? null : id));
    }
  });

  return { activeId, setActiveId, force, setForce, openAll, closeAll, clearForce, bind };
}

    // â€”â€” ä¸» Appï¼ˆPart 1ï¼šéª¨æ¶/å°è¦½/é›™æ¨¡å¼/åŒ¯å…¥åŒ¯å‡ºï¼Œæœªå«ç·¨è¼¯å™¨ï¼‰ â€”â€”
    function App(){
      const [data, setData] = useLocalState(LS.data, EMPTY);

      // install global input guards once (mobile UX)
      React.useEffect(()=>{ installGlobalInputGuards(); }, []);

// é€²ç«™æ™‚è‡ªå‹•æŠ“ ./data/app.jsonï¼Œè¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Œä¸¦åŒæ­¥ç®¡ç†å“¡åå–®ï¼ˆadminsï¼‰
React.useEffect(() => {
  (async () => {
    try {
      const res = await fetch('./data/app.json?v=' + Date.now(), { cache: 'no-store' });
      const raw = await res.json();

      // åŒæ™‚ç›¸å®¹å…©ç¨®æ ¼å¼ï¼šæ‰å¹³ { ... } æˆ– åŒ…ä¸€å±¤ { _meta, data, admins }
      const obj = raw && typeof raw === 'object' && 'data' in raw ? raw.data : raw;

      // æ­·å²ç”±æ–°åˆ°èˆŠ
      if (obj && Array.isArray(obj.history)) {
        obj.history = sortHistoryDesc(obj.history);
      }

      // å¯«å…¥è³‡æ–™æœ¬é«”
      if (obj && typeof obj === 'object') {
        // é ç«¯ app.json ä½œç‚ºã€ŒåŸºåº•è³‡æ–™ã€ï¼Œæœ¬æ©Ÿä½œç‚ºã€Œä½¿ç”¨è€…åå¥½/è¨­å®šã€
        // é‡è¦ï¼šä¿ç•™æœ¬æ©Ÿ games è¨­å®šï¼ˆæ¨£å¼ã€æ“ä½œåå¥½ç­‰ï¼‰ï¼Œé¿å…åˆ·æ–°å¾Œè¢«è¦†è“‹
        setData(prev=>{
          const p = (prev && typeof prev === 'object') ? prev : {};
          const merged = { ...obj };
          if (p.games && typeof p.games === 'object') {
            merged.games = { ...(obj.games||{}), ...(p.games||{}) };
          }
          return merged;
        });
      } else {
        console.error('app.json çµæ§‹ç•°å¸¸ï¼šæœŸæœ›ç‚ºç‰©ä»¶ï¼Œå¯¦å¾—', obj);
      }

// â˜… æ–°å¢ï¼šæŠŠ app.json çš„èƒŒæ™¯è¨­å®šä¹ŸçŒå› stateï¼ˆå« url / pos / menu...ï¼‰
if (raw && typeof raw === 'object' && raw.bg) {
  setBg(raw.bg);
}

// ï¼ˆå¯é¸ï¼‰è‹¥ä½ æœ‰ç”¨ ImageIOï¼Œé †æ‰‹æŠŠ images ä¹ŸåŒ¯å…¥
if (raw && typeof raw === 'object' && raw.images && window.ImageIO?.importImagesJSON) {
  try { window.ImageIO.importImagesJSON(raw.images); } catch {}
}

      // â˜… æ–°å¢ï¼šè‹¥ app.json æä¾› adminsï¼Œè¦†è“‹æœ¬æ©Ÿçš„ç®¡ç†å“¡åå–®ï¼Œé¿å…ä¸åŒæ­¥
      if (raw && typeof raw === 'object' && Array.isArray(raw.admins)) {
        setAdmins(raw.admins);
      }
    } catch (e) {
      console.error('è®€å– data/app.json å¤±æ•—ï¼š', e);
    }
  })();
}, []);


// === PointsPanel å±•é–‹ç‹€æ…‹ï¼ˆé è¨­å±•é–‹ï¼Œæœƒè¨˜ä½ä½¿ç”¨è€…é¸æ“‡ï¼‰ ===
const [pointsOpen, setPointsOpen] = useLocalState('kjs_points_open', false);
      
const [tab, setTab] = useState('home'); // home | history | pending | ongoing | shop | others
      const [menuOpen, setMenuOpen] = useState(false);
      const [adminMode, setAdminMode] = useState(false);
      const [query, setQuery] = useState('');
const [queryMode, setQueryMode] = useLocalState('kjs_query_mode', 'all'); // all | prize | winner | note


// === Adminï¼šç®¡ç†å“¡åå–®ï¼‹ç›®å‰ç™»å…¥è€… ===
const [admins, setAdmins] = useLocalState('kjs_admins', [
  { 
    name: 'admin', 
    passwordHash: '8efdbb89a7394f7a1a3f3a81d1b91a2781a5a66d74f40bfa7f2f5a5a8d79f5f2' 
  }
]);
const [currentAdmin, setCurrentAdmin] = useLocalState('kjs_current_admin', ''); // ç©ºå­—ä¸²ï¼æœªç™»å…¥

// === Adminï¼šç™»å…¥ Modal ç‹€æ…‹ï¼ˆå…©æ®µå¼ï¼‰===
const [showAdminLogin, setShowAdminLogin] = React.useState(false);
const [adminLoginStep, setAdminLoginStep] = React.useState(1); // 1=è¼¸å…¥/é¸æ“‡åç¨±ï¼›2=è¼¸å…¥å¯†ç¢¼
const [loginName, setLoginName] = React.useState('');
const [loginPwd, setLoginPwd] = React.useState('');
const [loginAttempts, setLoginAttempts] = React.useState(0);
const [loginLockUntil, setLoginLockUntil] = React.useState(0); // Date.now() æ¯«ç§’
const [showAdminHint, setShowAdminHint] = React.useState(false);

// === Admin å¯†æŠ€ï¼šé•·æŒ‰ 5~8 ç§’ï¼ˆæ‰‹æ©Ÿï¼‰ï¼æ¡Œé¢é€£é» 7 ä¸‹ ===
const secretHoldMsRef = React.useRef(6000);        // æ¯æ¬¡é–‹å•Ÿç™»å…¥è¦–çª—ï¼Œéš¨æ©Ÿ 5000~8000ms
const secretTimerRef = React.useRef(null);
const secretClicksRef = React.useRef(0);
const secretClicksTimerRef = React.useRef(null);

React.useEffect(() => {
  if (showAdminLogin) {
    secretHoldMsRef.current = 5000 + Math.floor(Math.random() * 3000); // 5000~8000
    secretClicksRef.current = 0;
  } else {
    if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
    if (secretClicksTimerRef.current) clearTimeout(secretClicksTimerRef.current);
    secretClicksTimerRef.current = null;
    setShowAdminHint(false);
  }
}, [showAdminLogin, setShowAdminHint]);

function startSecretHold(e) {
  e.preventDefault();
  if (secretTimerRef.current) clearTimeout(secretTimerRef.current);
  secretTimerRef.current = setTimeout(() => {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
  }, secretHoldMsRef.current);
}
function cancelSecretHold() {
  if (secretTimerRef.current) {
    clearTimeout(secretTimerRef.current);
    secretTimerRef.current = null;
  }
}

// æ¡Œé¢ï¼šåœ¨åŒä¸€å…ƒç´ ä¸Š 7 æ¬¡é»æ“Šï¼ˆ4 ç§’å…§ï¼‰
function secretClick() {
  secretClicksRef.current += 1;
  if (!secretClicksTimerRef.current) {
    secretClicksTimerRef.current = setTimeout(() => {
      secretClicksRef.current = 0;
      secretClicksTimerRef.current = null;
    }, 4000);
  }
  if (secretClicksRef.current >= 7) {
    setShowAdminHint(true);
    // 5 ç§’å¾Œè‡ªå‹•éš±è—
    setTimeout(() => setShowAdminHint(false), 5000);
    // é‡ç½®
    secretClicksRef.current = 0;
    if (secretClicksTimerRef.current) { clearTimeout(secretClicksTimerRef.current); secretClicksTimerRef.current = null; }
  }
}


// å°è£ï¼šé–‹å•Ÿç™»å…¥è¦–çª— / ç™»å‡º
function enterAdmin() {
  setLoginName('');
  setLoginPwd('');
  setAdminLoginStep(1);
  setShowAdminLogin(true);
}
function exitAdmin() {
  setAdminMode(false);
  setCurrentAdmin('');
  alert('å·²ç™»å‡ºç®¡ç†æ¨¡å¼');
}

// === Drawer A11yï¼šåƒè€ƒç¯€é» ===
const menuPaneRef = React.useRef(null);     // æŠ½å±œ <aside>
const menuButtonRef = React.useRef(null);   // é–‹å•ŸæŠ½å±œçš„æ¼¢å ¡æŒ‰éˆ•
const appContentRef = React.useRef(null);   // ä¸»å…§å®¹å®¹å™¨ï¼ˆè¦ aria-hiddenï¼‰

// === BackToTopï¼šç‹€æ…‹ï¼ˆæ»¾åˆ°ä¸€å®šé«˜åº¦æ‰é¡¯ç¤ºï¼‰ ===
const [showBackTop, setShowBackTop] = React.useState(false);

      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
      // å¿«æ·éµï¼š/ æœå°‹ã€g h å›é¦–é ã€g m é–‹é¸å–®
useEffect(()=>{
  let g = false;
  const onKey = (e)=>{
    // è‹¥æ­£åœ¨è¼¸å…¥æ¬„ä½/æ–‡å­—å€æˆ–çµ„å­—ä¸­å°±å¿½ç•¥
    const tag = (e.target && e.target.tagName || '').toString().toLowerCase();
    if (e.isComposing || tag === 'input' || tag === 'textarea' || tag === 'select' || e.metaKey || e.ctrlKey || e.altKey) return;

    const k = (e.key || '').toLowerCase();     // â† é˜²å‘†
    if (k === '/') { e.preventDefault(); document.getElementById('kjs-search')?.focus(); return; }
    if (k === 'g') { g = true; setTimeout(()=> g = false, 800); return; }
    if (k === 'h' && g) { e.preventDefault(); setTab('home'); return; }
    if (k === 'm' && g) { e.preventDefault(); setMenuOpen(true); return; }
  };
  window.addEventListener('keydown', onKey);
  return ()=> window.removeEventListener('keydown', onKey);
},[]);

// === Drawer A11yï¼šç„¦é»é™·é˜±ã€Esc é—œé–‰ã€é–å®š body æ»¾å‹• ===
React.useEffect(() => {
  if (!menuOpen) return;

  const pane = menuPaneRef.current;
  if (!pane) return;

  // 1) é– body æ»¾å‹•
  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';

  // 2) èšç„¦æŠ½å±œå…§ç¬¬ä¸€å€‹å¯èšç„¦å…ƒç´ 
  const selectors = 'a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
  const focusables = Array.from(pane.querySelectorAll(selectors));
  const first = focusables[0];
  const last = focusables[focusables.length - 1];
  const prevActive = document.activeElement;

  first?.focus();

  // 3) éµç›¤è¡Œç‚ºï¼šEsc é—œé–‰ã€Tab ç„¦é»ç’°
  const onKeyDown = (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      setMenuOpen(false);
      return;
    }
    if (e.key === 'Tab' && focusables.length > 0) {
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus(); return;
      }
      if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus(); return;
      }
    }
  };

  document.addEventListener('keydown', onKeyDown);

  // 4) æ¸…ç†ï¼šé‚„åŸ bodyã€è§£é™¤ç›£è½ã€æŠŠç„¦é»é‚„çµ¦é–‹å•Ÿéˆ•
  return () => {
    document.body.style.overflow = prevOverflow;
    document.removeEventListener('keydown', onKeyDown);
    // å„ªå…ˆå›åˆ°æ¼¢å ¡æŒ‰éˆ•ï¼›æ²’æ‰¾åˆ°å°±å›åˆ°åŸå…ˆ focus
    if (menuButtonRef.current && typeof menuButtonRef.current.focus === 'function') {
      menuButtonRef.current.focus();
    } else if (prevActive && typeof prevActive.focus === 'function') {
      prevActive.focus();
    }
  };
}, [menuOpen, setMenuOpen]);

// === BackToTopï¼šæ»¾å‹•ç›£è½ï¼ˆ> 480px æ‰é¡¯ç¤ºï¼‰ ===
React.useEffect(() => {
  let ticking = false;
  const threshold = 480; // ä½ å¯ä»¥æ”¹æˆ 400~600 è¦–è¦ºå–œå¥½

  const onScroll = () => {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        setShowBackTop(y > threshold);
        ticking = false;
      });
    }
  };

  // å…ˆè·‘ä¸€æ¬¡ï¼Œé¿å…åˆæ¬¡é€²é é¢åœ¨ä¸­æ®µä½ç½®æ™‚ç‹€æ…‹ä¸æº–
  onScroll();

  window.addEventListener('scroll', onScroll, { passive: true });
  return () => window.removeEventListener('scroll', onScroll);
}, []);

// === èƒŒæ™¯è¨­å®šï¼ˆä¸»ç•«é¢ & æ¼¢å ¡é¸å–®ï¼‰ ===
const [bg, setBg] = useLocalState('kjs_bg', {
  url: "",
  tint: "rgba(255,255,255,0.0)",
  brightness: 1,
  blur: 0,
  opacity: 1,
  size: "cover",
  pos: "center",
  menuUseMain: true,
  menuUrl: "",
  menuTint: "rgba(255,255,255,0.0)",
  menuBrightness: 1,
  menuBlur: 0,
  menuOpacity: 1,
  menuSize: "cover",
  menuPos: "center",
});

// æŠŠè¨­å®šå¥—åˆ° CSS è®Šæ•¸
useEffect(()=>{
  const r = document.documentElement;
  // ä¸»ç•«é¢
  r.style.setProperty('--bg-img', bg.url ? `url("${bg.url}")` : 'none');
  r.style.setProperty('--bg-tint', bg.tint);
  r.style.setProperty('--bg-brightness', String(bg.brightness));
  r.style.setProperty('--bg-blur', bg.blur + 'px');
  r.style.setProperty('--bg-opacity', String(bg.opacity));
  r.style.setProperty('--bg-size', bg.size);
  r.style.setProperty('--bg-pos', bg.pos);

  // æ¼¢å ¡é¸å–®
  const useMain = !!bg.menuUseMain;
  const mUrl = useMain ? bg.url : bg.menuUrl;
  const mTint = useMain ? bg.tint : bg.menuTint;
  const mBri  = useMain ? bg.brightness : bg.menuBrightness;
  const mBlur = useMain ? bg.blur : bg.menuBlur;
  const mOpa  = useMain ? bg.opacity : bg.menuOpacity;
  const mSize = useMain ? bg.size : bg.menuSize;
  const mPos  = useMain ? bg.pos : bg.menuPos;

  r.style.setProperty('--menu-bg-img', mUrl ? `url("${mUrl}")` : 'none');
  r.style.setProperty('--menu-tint', mTint);
  r.style.setProperty('--menu-brightness', String(mBri));
  r.style.setProperty('--menu-blur', mBlur + 'px');
  r.style.setProperty('--menu-opacity', String(mOpa));
  r.style.setProperty('--menu-bg-size', mSize);
  r.style.setProperty('--menu-bg-pos', mPos);
}, [bg]);


 // åŒ¯å…¥/åŒ¯å‡ºï¼ˆJSONï¼Œä¾›ä½ å‚™ä»½æ¬ç§»ï¼‰â€”â€”ã€æ•´æ®µè¦†è“‹ç‰ˆã€‘
// æœ¬ç‰ˆæœƒæŠŠã€Œç«™å…§è³‡æ–™ dataã€èˆ‡ã€Œç®¡ç†å“¡åå–® adminsï¼ˆåªå«é›œæ¹Šï¼Œä¸å«æ˜æ–‡å¯†ç¢¼ï¼‰ã€ä¸€èµ·åŒ¯å‡ºï¼›
// åŒ¯å…¥æ™‚åŒæ™‚æ”¯æ´ã€Œæ–°æ ¼å¼ï¼ˆå« data/adminsï¼‰ã€èˆ‡ã€ŒèˆŠæ ¼å¼ï¼ˆåªæœ‰ dataï¼‰ã€ã€‚

const exportJSON = () => {
  // å–å‡ºç›®å‰æ‰€æœ‰åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´ï¼ˆImageIO æœƒå›å‚³å­—ä¸² JSONï¼‰
  const imagesStr = window.ImageIO ? window.ImageIO.exportImagesJSON() : null;
  const images = imagesStr ? JSON.parse(imagesStr) : null;

  const full = {
    _meta: {
      app: 'kjs',
      version: 2, // å‡ç´šä¸€ä¸‹ç‰ˆæœ¬è™Ÿï¼Œæ–¹ä¾¿ä¹‹å¾Œè¾¨è­˜
      exportedAt: new Date().toISOString()
    },
    data,            // ç«™å…§è³‡æ–™
    admins,          // ç®¡ç†å“¡åå–®ï¼ˆhashï¼‰
    images,          // â† æ–°å¢ï¼šå…¨ç«™åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´ï¼ˆimages.v1 çµæ§‹ï¼‰
    bg               // â† æ–°å¢ï¼šèƒŒæ™¯è¨­å®šï¼ˆä¸»ç•«é¢ / æ¼¢å ¡é¸å–®ï¼‰
  };

  const blob = new Blob([JSON.stringify(full, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_full_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// ï¼ˆå¯é¸ï¼‰åƒ…åŒ¯å‡ºç«™å…§è³‡æ–™ï¼Œä¸å«ç®¡ç†å“¡åå–®â€”â€”å¦‚æœè¦çµ¦ä¸€èˆ¬æˆå“¡å‚™ä»½ï¼Œå¯ä»¥ç¶é€™é¡†
const exportDataOnly = () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `kjs_data_only_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};

// åŒ¯å…¥æ”¯æ´å…©ç¨®æ ¼å¼ï¼š
// 1) æ–°æ ¼å¼ï¼š{ _meta?, data: {...}, admins: [...] } â€”â€” åŒæ™‚è¦†è“‹ç«™å…§è³‡æ–™èˆ‡ç®¡ç†å“¡åå–®
// 2) èˆŠæ ¼å¼ï¼š{ ...ç›´æ¥å°±æ˜¯ data å…§å®¹... } â€”â€” åªè¦†è“‹ç«™å…§è³‡æ–™ï¼Œä¿ç•™æœ¬æ©Ÿ admins
const importJSON = (file) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const obj = JSON.parse(String(e.target.result || '{}'));

      const looksNew = obj && typeof obj === 'object' && ('data' in obj || 'admins' in obj);

      if (looksNew) {
        const nextData   = obj.data  ?? {};
        const nextAdmins = Array.isArray(obj.admins) ? obj.admins : null;

        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        if (nextAdmins) setAdmins(nextAdmins);

        // â˜… æ–°å¢ï¼šè‹¥åŒ…äº† imagesï¼ˆimages.v1 çµæ§‹ï¼‰ï¼Œå‘¼å« ImageIO ç«‹å³å¥—ç”¨
        if (obj.images && window.ImageIO && typeof window.ImageIO.importImagesJSON === 'function') {
          try { window.ImageIO.importImagesJSON(obj.images); } catch {}
        }

        // â˜… æ–°å¢ï¼šè‹¥åŒ…äº† bgï¼ˆèƒŒæ™¯è¨­å®šï¼‰ï¼Œç›´æ¥å¯«å›
        if (obj.bg) {
          try { setBg(obj.bg); } catch {}
        }

        alert(`åŒ¯å…¥å®Œæˆ${nextAdmins ? 'ï¼ˆå«ç®¡ç†å“¡åå–®ï¼‰' : ''}ï¼Œæ­·å²å·²è‡ªå‹•æ’åº`);
      } else {
        // èˆŠæ ¼å¼ï¼šåªæœ‰ data
        const nextData = obj;
        if (Array.isArray(nextData.history)) nextData.history = sortHistoryDesc(nextData.history);
        setData(nextData);
        alert('åŒ¯å…¥å®Œæˆï¼ˆèˆŠæ ¼å¼ï¼Œå·²è‡ªå‹•æ’åºæ­·å²ï¼‰');
      }
    } catch {
      alert('åŒ¯å…¥å¤±æ•—ï¼šä¸æ˜¯æœ‰æ•ˆ JSON');
    }
  };
  reader.readAsText(file);
};


      return (
        <div className="min-h-screen flex flex-col app-min-vvh" data-app-root="1">
          {/* Header */}
          <header data-app-header="1" className="sticky top-0 z-30 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200/60 dark:border-slate-800">
            <div className="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2">
             <button
  ref={menuButtonRef}
  type="button"
  aria-controls="app-menu-pane"
  aria-expanded={menuOpen ? 'true' : 'false'}
  aria-label="é–‹å•Ÿä¸»é¸å–®"
  className="tap-target -ml-2"
  onClick={() => setMenuOpen(true)}
  title="é–‹å•Ÿé¸å–®"
>
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
</button>

              <h1 className="text-lg font-semibold">CxQé–‹çæ‰€</h1>
              <div className="ml-auto flex items-center gap-2">
                <div className="hidden sm:flex items-center gap-2">
  {/* æ¨¡å¼é¸å–® */}
  <label htmlFor="kjs-search-mode" className="sr-only">æœå°‹æ¨¡å¼</label>
  <select
    id="kjs-search-mode"
    value={queryMode}
    onChange={(e)=>setQueryMode(e.target.value)}
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-2 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70"
    title="é¸æ“‡æœå°‹æ¨¡å¼"
    aria-label="æœå°‹æ¨¡å¼"
  >
    <option value="all">å…¨éƒ¨</option>
    <option value="prize">çå“åç¨±</option>
    <option value="winner">å¾—çè€…</option>
    <option value="note">å‚™è¨»ãƒ»èªªæ˜</option>
  </select>

  {/* æœå°‹è¼¸å…¥æ¡† */}
  <label htmlFor="kjs-search" className="sr-only">æœå°‹é—œéµå­—</label>
  <input
    id="kjs-search"
    value={query}
    onChange={e=>setQuery(e.target.value)}
    placeholder="æœå°‹...ï¼ˆæŒ‰ / èšç„¦ï¼‰"
    className="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm bg-white/70 dark:bg-slate-800/70 focus:outline-none focus:ring-2 focus:ring-brand"
  />
</div>

                {!adminMode && (
                  <button onClick={enterAdmin} className="tap-target rounded-xl bg-brand text-white px-3 py-1.5 text-sm shadow-soft">ç®¡ç†</button>
                )}
                {adminMode && (
  <div className="flex items-center gap-2">
    <button onClick={exportJSON} className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm">åŒ¯å‡º</button>
    <label className="tap-target rounded-xl bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-sm cursor-pointer">åŒ¯å…¥
      <input type="file" accept="application/json" className="hidden" onChange={e=>e.target.files&&importJSON(e.target.files[0])}/>
    </label>

    {/* å°‡åŸæœ¬çš„ã€Œé‡è¨­å¯†ç¢¼ã€æ”¹æˆå°å‘ç³»çµ±è¨­ç½®é ï¼ˆåœ¨é‚£è£¡æ”¹å¸³è™Ÿ/å¯†ç¢¼ï¼‰ */}
    <button
      onClick={() => { setTab('system'); /* å¯é¸ï¼šå¸¶å…¥éŒ¨é» */ const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
      className="tap-target rounded-xl bg-amber-200 text-amber-900 dark:bg-amber-300/20 dark:text-amber-200 px-3 py-1.5 text-sm"
      title="å‰å¾€ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®"
    >
      ç®¡ç†å“¡è¨­å®š
    </button>

    <button onClick={exitAdmin} className="tap-target rounded-xl bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-3 py-1.5 text-sm">é€€å‡º</button>
  </div>
)}

              </div>
            </div>
          </header>

          {/* Main */}
          <div ref={appContentRef} aria-hidden={menuOpen ? 'true' : 'false'}>
  <main className="max-w-5xl mx-auto w-full px-4 py-6 flex-1">

            {tab==='home' && <Home setTab={setTab} data={data} setData={setData} admin={adminMode} />}

{tab==='links' && <LinksPage data={data} setData={setData} admin={adminMode} />}

{tab==='custom' && <CustomPage />}

{tab==='home' && <HomeSections data={data} setData={setData} admin={adminMode} />}

            {tab==='history' && <History data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='pending' && <Pending data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='ongoing' && <Ongoing data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}
{tab==='store' && (
  <Store
    data={data}
    admin={adminMode}
    setData={setData}
    query={query}
  />
)}

{tab==='shop' && (
  <>
    {/* æŸ¥è©¢é»æ•¸ï¼šå¯æ”¶åˆå¡ï¼ˆé è¨­å±•é–‹ï¼Œè¨˜æ†¶ç‹€æ…‹ï¼‰ */}
    <section
      className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-0 overflow-hidden"
      aria-label="æŸ¥è©¢é»æ•¸"
    >
      {/* å¡ç‰‡æ¨™é¡Œåˆ— */}
      <div className="flex items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <span className="text-lg">ğŸ’³</span>
          <h2 className="text-base font-semibold">æŸ¥è©¢é»æ•¸</h2>
        </div>
        <button
          type="button"
          aria-controls="points-panel-body"
          aria-expanded={pointsOpen ? 'true' : 'false'}
          onClick={()=>setPointsOpen(v=>!v)}
          className="tap-target rounded-lg border px-3 py-1.5 text-sm"
          title={pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        >
          {pointsOpen ? 'æ”¶åˆ' : 'å±•é–‹'}
        </button>
      </div>

      {/* åˆ†éš”ç·š */}
      <div className="h-px bg-slate-200 dark:bg-slate-700" />

      {/* å¡ç‰‡å…§å®¹ï¼ˆå¯æ”¶åˆï¼‰ */}
      {pointsOpen && (
        <div id="points-panel-body" className="p-4">
          <PointsPanel data={data} admin={adminMode} setData={setData} />
        </div>
      )}
    </section>

    {/* èˆ‡æŸ¥è©¢å¡ç‰‡ç•™é»é–“è· */}
    <div className="h-4" />

    {/* é»æ•¸å•†åŸå…§å®¹ */}
    <Shop data={data} admin={adminMode} setData={setData} query={query} />

<ShopImageQuickset data={data} setData={setData} admin={adminMode} />

  </>
)}


{tab==='others' && <Others data={data} admin={adminMode} setData={setData} query={query} queryMode={queryMode} />}

{tab==='games' && <GamesHub data={data} setData={setData} />}

{tab==='games_admin' && adminMode && <GamesAdmin data={data} setData={setData} />}

{tab==='system' && adminMode && (
  <SystemSettings
    data={data}
    setData={setData}
    bg={bg}
    setBg={setBg}
    admins={admins}
    setAdmins={setAdmins}
    currentAdmin={currentAdmin}
    setCurrentAdmin={setCurrentAdmin}
  />
)}

{tab==='gallery' && <GalleryPage data={data} setData={setData} admin={adminMode} />}
{tab==='faq' && <FaqPage data={data} setData={setData} admin={adminMode} />}

{/* è¿”å›é ‚éƒ¨ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ï¼šåƒ…åœ¨æ»¾åˆ°ä¸€å®šé«˜åº¦å¾Œé¡¯ç¤º */}
{showBackTop && (
  <button
    onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
    className="fixed right-4 bottom-20 md:bottom-6 z-40 rounded-full border shadow-soft bg-white/90 dark:bg-slate-900/80 backdrop-blur px-3 py-2 tap-target"
    aria-label="å›åˆ°æœ€ä¸Šé¢"
    title="å›åˆ°æœ€ä¸Šé¢"
  >
    â†‘
  </button>
)}

{/* === Admin ç™»å…¥ï¼ˆäºŒæ®µå¼ Modalï¼‰=== */}
{showAdminLogin && (
  <div className="fixed inset-0 z-50">
    {/* èƒŒæ™¯ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setShowAdminLogin(false)} />
    <div className="absolute inset-0 flex items-center justify-center p-4">
      <div className="relative w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4" onClick={(e)=>e.stopPropagation()}>

{/* ï¼ˆå¯†æŠ€ï¼‰å·¦ä¸Šè§’ 10Ã—10 px è£é£¾é»ï¼šçœ‹èµ·ä¾†åƒè£é£¾ï¼Œå¯¦éš›æ˜¯é•·æŒ‰/é€£é»å•Ÿå‹•å™¨ */}
<div
  aria-hidden="true"
  tabIndex={-1}
  className="absolute top-1 left-1 w-2.5 h-2.5 rounded-full bg-slate-300/70 dark:bg-slate-600/70 cursor-default select-none"
  // æ‰‹æ©Ÿï¼šé•·æŒ‰ 5~8 ç§’
  onPointerDown={startSecretHold}
  onPointerUp={cancelSecretHold}
  onPointerLeave={cancelSecretHold}
  onPointerCancel={cancelSecretHold}
  // æ¡Œé¢ï¼šé€£é» 7 ä¸‹ï¼ˆæ­¤å…ƒç´ ä¸é¡¯ç¤ºä»»ä½•æŒ‰éˆ•æ¨£å¼ï¼Œæ¸¸æ¨™ä¸è®Šï¼‰
  onClick={secretClick}
  onContextMenu={(e)=>e.preventDefault()} // é˜»æ“‹é•·æŒ‰å«å‡ºé¸å–®
/>


        <div className="text-base font-semibold mb-2">ç®¡ç†è€…ç™»å…¥</div>

        {/* é–å®šæç¤º */}
        {Date.now() < loginLockUntil && (
          <div className="text-sm text-red-600 mb-2">
            å˜—è©¦éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ï¼ˆ{Math.ceil((loginLockUntil - Date.now())/1000)} ç§’ï¼‰
          </div>
        )}

        {/* Step 1ï¼šç®¡ç†è€…åç¨± */}
{adminLoginStep === 1 && (
  <div className="grid gap-2">
    <label className="text-sm text-slate-600 dark:text-slate-300">ç®¡ç†è€…åç¨±</label>
    <input
      className="rounded-lg border px-3 py-2"
      placeholder="ä¾‹å¦‚ï¼šadmin æˆ–è¼¸å…¥æ–°åç¨±"
      value={loginName}
      onChange={e=>setLoginName(e.target.value)}
      disabled={Date.now() < loginLockUntil}
    />

    {/* æ³¨æ„ï¼šä¸å†é¡¯ç¤ºä»»ä½•é¡¯ç¤ºå¸³è™Ÿçš„æŒ‰éˆ•æˆ–æç¤ºï¼›åªåœ¨å¯†æŠ€è§¸ç™¼æ™‚çŸ­æš«é¡¯ç¤ºåå–® */}
    {showAdminHint && admins.length > 0 && (
      <div className="text-xs text-slate-600 dark:text-slate-300 rounded-lg border px-3 py-2">
        {admins.map((a,i)=>(
          <button
            key={i}
            className="mr-2 mb-1 inline-flex items-center px-2 py-0.5 rounded border hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={()=>setLoginName(a.name)}
            disabled={Date.now() < loginLockUntil}
            title="é»ä¸€ä¸‹å¸¶å…¥åç¨±ï¼ˆ5 ç§’å¾Œè‡ªå‹•éš±è—ï¼‰"
          >
            {a.name}
          </button>
        ))}
      </div>
    )}

    <div className="flex justify-end gap-2 mt-2">
      <button className="rounded-lg border px-3 py-1.5" onClick={()=>setShowAdminLogin(false)}>å–æ¶ˆ</button>
      <button
        className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
        onClick={()=>{
          if(!loginName.trim()) { alert('è«‹è¼¸å…¥ç®¡ç†è€…åç¨±'); return; }
          setAdminLoginStep(2);
        }}
      >
        ä¸‹ä¸€æ­¥
      </button>
    </div>
  </div>
)}


        {/* Step 2ï¼šå¯†ç¢¼ */}
        {adminLoginStep === 2 && (
          <div className="grid gap-2">
            <label className="text-sm text-slate-600 dark:text-slate-300">å¯†ç¢¼</label>
            <input
              type="password"
              className="rounded-lg border px-3 py-2"
              placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
              value={loginPwd}
              onChange={e=>setLoginPwd(e.target.value)}
              disabled={Date.now() < loginLockUntil}
            />
            <div className="flex justify-between items-center mt-2">
              <button className="rounded-lg border px-3 py-1.5" onClick={()=>setAdminLoginStep(1)}>ä¸Šä¸€æ­¥</button>
              <button
  className="rounded-lg border px-3 py-1.5 bg-brand text-white border-brand"
  disabled={Date.now() < loginLockUntil}
  onClick={async ()=>{
    const name = (loginName||"").trim();
    const pass = (loginPwd||"").trim();            // â† ä¿®æ­£ï¼šç”¨ loginPwdï¼Œä¸æ˜¯ loginPassword

    if(!name || !pass){
      alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
      return;
    }

    // ç›´æ¥ä½¿ç”¨ç‹€æ…‹ä¸­çš„ç®¡ç†å“¡åå–®ï¼ˆä¸è¦å†è®€ LS.adminsï¼‰
    const list = Array.isArray(admins) ? admins : [];
    const found = list.find(u => u && u.name === name);

    if(!found){
      // ğŸš« ç™»å…¥æµç¨‹ä¸å…è¨±å»ºç«‹æ–°ç®¡ç†å“¡ï¼ˆåªèƒ½ç”¨æ—¢æœ‰å¸³è™Ÿç™»å…¥ï¼‰
      alert("æ­¤å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹è¯çµ¡æ—¢æœ‰ç®¡ç†å“¡æ–¼ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€æ–°å¢ã€‚");
      return;
    }

    // å¿…é ˆå·²è¨­å®šå¯†ç¢¼ï¼ˆæœ‰ hashï¼‰ï¼Œä¸å…è¨±åœ¨ç™»å…¥æµç¨‹å»ºç«‹æˆ–è®Šæ›´å¯†ç¢¼
    if(!found.passwordHash || String(found.passwordHash).trim()===""){
      alert("æ­¤å¸³è™Ÿå°šæœªè¨­å®šå¯†ç¢¼ï¼Œè«‹å…ˆç”±æ—¢æœ‰ç®¡ç†å“¡åœ¨ã€ŒğŸ› ï¸ ç³»çµ±è¨­ç½®ã€ç‚ºè©²å¸³è™Ÿè¨­å®šå¯†ç¢¼ã€‚");
      return;
    }

    // æ¯”å° SHA-256 é›œæ¹Š
    const hash = await hashTextSHA256(pass);
    if(hash !== found.passwordHash){
      alert("å¯†ç¢¼éŒ¯èª¤");
      return;
    }

    // âœ… ç™»å…¥æˆåŠŸ
    setCurrentAdmin(name);
    setAdminMode(true);
    setShowAdminLogin(false);
    setLoginName("");
    setLoginPwd("");         // â† ä¿®æ­£ï¼šæ¸…ç©º loginPwdï¼ˆä¸æ˜¯ setLoginPasswordï¼‰
    alert(`å·²ä»¥ã€Œ${name}ã€ç™»å…¥ç®¡ç†æ¨¡å¼`);
  }}
>
  ç™»å…¥
</button>

            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}

          </main>
</div>

{/* åº•éƒ¨å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿï¼‰ */}
<nav data-app-bottomnav="1" className="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white/95 dark:bg-slate-900/80 border-t border-slate-200 dark:border-slate-700 backdrop-blur">
  <div className="max-w-5xl mx-auto grid grid-cols-5">
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='home'?'text-brand':'')} onClick={()=>setTab('home')} title="é¦–é ">ğŸ </button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='pending'?'text-brand':'')} onClick={()=>setTab('pending')} title="ç­‰å¾…é–‹ç">â³</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='shop'?'text-brand':'')} onClick={()=>setTab('shop')} title="é»æ•¸å•†åŸ">ğŸ›ï¸</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='store'?'text-brand':'')} onClick={()=>setTab('store')} title="ç¤¾ç¾¤å•†åº—">ğŸ›’</button>
    <button className={"tap-target flex items-center justify-center py-2 " + (tab==='history'?'text-brand':'')} onClick={()=>setTab('history')} title="æ­·å²ç´€éŒ„">ğŸ“š</button>
  </div>
</nav>

          {/* æŠ½å±œå¼æ¼¢å ¡é¸å–® */}
      {menuOpen && (
  <div className="fixed inset-0 z-50">
    {/* é®ç½©ï¼šé»æ“Šé—œé–‰ */}
    <div className="absolute inset-0 bg-black/40" onClick={()=>setMenuOpen(false)} />
    {/* æŠ½å±œæœ¬é«” */}
    <aside
      id="app-menu-pane"
      ref={menuPaneRef}
      role="dialog"
      aria-modal="true"
      aria-label="ä¸»é¸å–®"
      tabIndex={-1}
      className="menu-pane absolute left-0 top-0 h-full w-80 max-w-[85%] shadow-xl no-scrollbar overflow-y-auto"
    >
      {/* ä½ çš„é¸å–®å…§å®¹ç¶­æŒä¸è®Šï¼šæŠŠåŸæœ¬ aside è£¡çš„å…§å®¹æ•´æ®µè²¼å›ä¾† */}
      <div className="p-4 border-b ... flex items-center justify-between">
  <div className="font-semibold">
    å°è¦½{adminMode && currentAdmin ? <span className="ml-2 text-xs text-slate-500">ï¼ˆ{currentAdmin}ï¼‰</span> : null}
  </div>
        <button className="tap-target" onClick={()=>setMenuOpen(false)} aria-label="é—œé–‰">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <nav className="p-2 grid gap-1">
        <div className="h-px bg-slate-200/70 dark:bg-slate-700/70 my-1"></div>
  {/* â€”â€” ä¸»å°è¦½ â€”â€” */}
  <NavItem
    label="ğŸ  é¦–é "
    active={tab==='home'}
    onClick={()=>{ setTab('home'); setMenuOpen(false); }}
  />
 
<NavItem
  label="ğŸ›’ ç¤¾ç¾¤å•†åº—"
  active={tab==='store'}
  onClick={()=>{ setTab('store'); setMenuOpen(false); }}
  />  


<NavItem
  label="ğŸ§µ æ‰‹ä½œ/è¨‚è£½å€"
  active={tab==='custom'}
  onClick={()=>{ setTab('custom'); setMenuOpen(false); }}
/>

  <NavItem
    label="ğŸ›ï¸ é»æ•¸å•†åŸ"
    active={tab==='shop'}
    onClick={()=>{ setTab('shop'); setMenuOpen(false); }}
  />
  
<NavItem
    label="â³ ç­‰å¾…é–‹ç"
    active={tab==='pending'}
    onClick={()=>{ setTab('pending'); setMenuOpen(false); }}
  />

<NavItem
    label="ğŸ“š æ­·å²ç´€éŒ„"
    active={tab==='history'}
    onClick={()=>{ setTab('history'); setMenuOpen(false); }}
  />
  
<NavItem
    label="ğŸ”„ é€²è¡Œä¸­æ´»å‹•"
    active={tab==='ongoing'}
    onClick={()=>{ setTab('ongoing'); setMenuOpen(false); }}
  />
  <NavItem
    label="ğŸ“Œ å…¶ä»–è³‡æ–™"
    active={tab==='others'}
    onClick={()=>{ setTab('others'); setMenuOpen(false); }}
  />

  <NavItem
    label="ğŸ® å°éŠæˆ²"
    active={tab==='games'}
    onClick={()=>{ setTab('games'); setMenuOpen(false); }}
  />

<NavItem
  label="ğŸ–¼ é–‹ç®±/åˆ°è²¨å¯¦æ‹"
  active={tab==='gallery'}
  onClick={()=>{ setTab('gallery'); setMenuOpen(false); }}
/>

<NavItem
  label="â“ FAQ"
  active={tab==='faq'}
  onClick={()=>{ setTab('faq'); setMenuOpen(false); }}
/>

  {/* åˆ†éš”ç·š */}
  <div className="my-2 h-px bg-slate-200 dark:bg-slate-700" />

  {/* â€”â€” ç®¡ç†å€ï¼ˆä¾ç‹€æ…‹åˆ‡æ›ï¼‰ â€”â€” */}
  {!adminMode ? (
    <button
      className="w-full text-left px-3 py-2 rounded-xl tap-target hover:bg-slate-100 dark:hover:bg-slate-800"
      onClick={()=>{ enterAdmin(); /* æˆåŠŸé€²å…¥å¾Œä¿ç•™æŠ½å±œé–‹å•Ÿï¼Œæˆ–ä½ ä¹Ÿå¯é—œé–‰ */ }}
      title="é€²å…¥ç®¡ç†æ¨¡å¼"
    >
      ğŸ” é€²å…¥ç®¡ç†æ¨¡å¼
    </button>
  ) : (
    <>
      {/* ç³»çµ±è¨­ç½®åˆ†é ï¼ˆä½ ä¹‹å‰è¦æ±‚é›†ä¸­è¨­å®šåœ¨æ­¤ï¼‰ */}
      <NavItem
        label="ğŸ› ï¸ ç³»çµ±è¨­ç½®"
        active={tab==='system'}
        onClick={()=>{ setTab('system'); setMenuOpen(false); }}
      />

            <NavItem
        label="ğŸ® å°éŠæˆ²è¨­å®š"
        active={tab==='games_admin'}
        onClick={()=>{ setTab('games_admin'); setMenuOpen(false); }}
      />

{/* ç®¡ç†å¸¸ç”¨å·¥å…· */}
      <div className="grid grid-cols-2 gap-2 p-2">
  <button
    onClick={exportJSON}
    className="rounded-lg border px-3 py-2 text-sm"
    title="åŒ¯å‡ºæ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    åŒ¯å‡º
  </button>

  <label
    className="rounded-lg border px-3 py-2 text-sm cursor-pointer text-center"
    title="åŒ¯å…¥æ•´ç«™è³‡æ–™ï¼ˆJSONï¼‰"
  >
    ç´”åŒ¯å…¥
    <input
      type="file"
      accept="application/json"
      className="hidden"
      onChange={e=>e.target.files && importJSON(e.target.files[0])}
    />
  </label>

  {/* å°å‘ç³»çµ±è¨­ç½® > ç®¡ç†è€…æ¸…å–®ï¼ˆå–ä»£èˆŠçš„ resetAdminï¼‰ */}
  <button
    onClick={()=>{ setTab('system'); setMenuOpen(false); const el=document.getElementById('admin-list-panel'); if(el) el.scrollIntoView({behavior:'smooth'}); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="å‰å¾€ç³»çµ±è¨­ç½®ï¼ˆç®¡ç†è€…æ¸…å–®ï¼‰"
  >
    ç®¡ç†å“¡è¨­å®š
  </button>

  <button
    onClick={()=>{ exitAdmin(); setMenuOpen(false); }}
    className="rounded-lg border px-3 py-2 text-sm"
    title="é€€å‡ºç®¡ç†æ¨¡å¼"
  >
    é€€å‡ºç®¡ç†
  </button>
</div>

    </>
  )}
</nav>

      <div className="p-4 text-xs text-slate-500 border-t border-slate-200/60 dark:border-slate-800">
        <div>æç¤ºï¼š</div>
        <ul className="list-disc pl-5 mt-1 space-y-1">
          <li>æŒ‰ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">/</kbd> èšç„¦æœå°‹</li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">h</kbd>ï¼šå›é¦–é </li>
          <li><kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">g</kbd> â†’ <kbd className="px-1 rounded bg-slate-100 dark:bg-slate-800">m</kbd>ï¼šé–‹é¸å–®</li>
        </ul>
      </div>
    </aside>
  </div>
)}

        </div>
      );
    }

    // â€”â€” åŸºç¤ UI å…ƒä»¶ â€”â€”
    function NavItem({ label, active, onClick }){
  return (
    <button
      onClick={onClick}
      className={cx(
        'w-full text-left px-3 py-2 rounded-xl tap-target transition',
        active
          ? 'bg-brand/10 text-brand-fg border border-brand/30'
          : 'hover:bg-slate-100 dark:hover:bg-slate-800',
        // æ‰‹æ©Ÿ/éµç›¤çš„è§¸è¦ºå›é¥‹ï¼ˆæ²’æœ‰ hover ä¹Ÿæœ‰æ¸…æ¥šçš„ pressed/focus ç‹€æ…‹ï¼‰
        'active:bg-slate-100 dark:active:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50'
      )}
      // è¼”åŠ©æŠ€è¡“å¯è®€æ€§ï¼ˆé«˜äº®ç•¶å‰é ï¼‰
      aria-current={active ? 'page' : undefined}
    >
      {label}
    </button>
  );
}


function StickyBulkToggles({ onOpenAll, onCloseAll, className="" }) {
  return (
    <div className={cx(
      "sticky top-[60px] z-20 flex items-center gap-2 justify-end",
      className
    )}>
      <button
        type="button"
        onClick={onOpenAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨å±•é–‹"
        aria-label="å…¨éƒ¨å±•é–‹"
      >
        {/* å±•é–‹ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="6 15 12 9 18 15"></polyline>
        </svg>
      </button>
      <button
        type="button"
        onClick={onCloseAll}
        className="inline-flex items-center justify-center w-9 h-9 rounded-full border bg-white/90 dark:bg-slate-900/80 backdrop-blur hover:bg-slate-50 dark:hover:bg-slate-800 shadow-soft"
        title="å…¨éƒ¨æ”¶åˆ"
        aria-label="å…¨éƒ¨æ”¶åˆ"
      >
        {/* æ”¶åˆ icon */}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="18 9 12 15 6 9"></polyline>
        </svg>
      </button>
    </div>
  );
}

   

    function EmptyCard({ text, admin }){
      return (
        <div className="border border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 text-center text-slate-500">
          {text}
          {admin && <div className="mt-3 text-xs">ï¼ˆé€²å…¥ç®¡ç†å¾Œå¯æ–°å¢è³‡æ–™ï¼‰</div>}
        </div>
      );
    }

// === Homeï¼ˆHero + å³å´é–‹ç®±/åˆ°è²¨å¯¦æ‹ç¸®åœ– + 4 é¡†é‡é»æŒ‰éˆ• + FAQï¼‰ ===
function Home({ setTab, data, setData, admin }) {
  const { useState, useMemo, useEffect } = React;

  // ä¿éšœç¯€é»å­˜åœ¨ï¼ˆå»¶ç”¨ä½ çš„åˆå§‹åŒ–ï¼‰
  useEffect(() => {
    try { kjsEnsureGallery(data); } catch {}
    try { kjsEnsureFaq(data); } catch {}
    try { kjsEnsureGames(data); } catch {}
  }, [data]);

  // ç³»çµ±é€£çµï¼ˆä¸»é æŒ‰éˆ•ä½¿ç”¨ï¼Œå¯ç”±ã€Œç®¡ç†å“¡è¨­å®šã€èª¿æ•´ï¼‰
  const settings = (data && data.settings) ? data.settings : DEFAULT_SETTINGS;
  const lineGroupUrl = String(settings.lineGroupUrl || "").trim() || "https://reurl.cc/ZNGdXV";
  const officialLineUrl = String(settings.contactUrl || "").trim();

  // /api/stats â†’ 4 é¡†æŒ‰éˆ•æ•¸å­—ï¼ˆå¤±æ•—å›é€€æœ¬åœ°ï¼‰
  const [stats, setStats] = useState(null);
  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        const r = await fetch('/api/stats', { headers: { accept: 'application/json' } });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        if (!alive) return;
        setStats({
          pending: Number(j.pending ?? 0),
          history: Number(j.history ?? 0),
          store:   Number(j.storeCount ?? j.store ?? 0),
          shop:    Number(j.shopCount  ?? j.mall  ?? 0),
        });
      } catch {
        if (!alive) return;
        setStats(null);
      }
    })();
    return () => { alive = false; };
  }, []);

  // æœ¬åœ°è¨ˆæ•¸ï¼ˆfallbackï¼‰
  const local = useMemo(() => ({
    pending: Array.isArray(data.pending) ? data.pending.length : 0,
    history: Array.isArray(data.history) ? data.history.length : 0,
    store:   Array.isArray(data.store?.items) ? data.store.items.length : 0,
    shop:    Array.isArray(data.shop?.items)  ? data.shop.items.length  : 0,
  }), [data]);
  const eff = {
    pending: stats?.pending ?? local.pending,
    history: stats?.history ?? local.history,
    store:   stats?.store   ?? local.store,
    shop:    stats?.shop    ?? local.shop,
  };

 // â˜… é¦–é é–‹ç®±/åˆ°è²¨å¯¦æ‹ï¼šè‹¥å·²é¸æ“‡ï¼ˆhomepage_showcaseï¼‰â†’ å®Œæ•´ä¾é¸æ“‡é †åºé¡¯ç¤ºï¼›å¦å‰‡å›é€€å–å‰ 5 å¼µ
  const showcase = Array.isArray(data?.gallery?.homepage_showcase)
    ? data.gallery.homepage_showcase
    : [];

  const galleryImages = useMemo(() => {
    // ä½ æœ‰ã€Œå·²é¸æ¸…å–®ã€â†’ é¦–é å®Œæ•´ç…§ä½ æ’åºé¡¯ç¤ºï¼ˆä¸å†é™åˆ¶ 5 å¼µï¼‰
    if (Array.isArray(showcase) && showcase.length > 0) {
      return showcase.filter(Boolean);
    }

    // æ²’æœ‰é¸ â†’ ç”¨è³‡æ–™åº« items å›é€€é¡¯ç¤ºå‰ 5 å¼µï¼ˆé¿å…é¦–é éé•·ï¼‰
    const items = Array.isArray(data.gallery?.items) ? data.gallery.items : [];
    return items
      .map(it => it.url || it.img || it.image || it.src || '')
      .filter(Boolean)
      .slice(0, 5);
  }, [data.gallery, showcase]);


  // â˜… ç®¡ç†ä»‹é¢ï¼šç·¨è¼¯é¦–é å›å ±
  const [editOpen, setEditOpen] = useState(false);
  const allGallery = useMemo(() => (Array.isArray(data.gallery?.items) ? data.gallery.items : []), [data.gallery]);
  const [pick, setPick] = useState(showcase); // æš«å­˜é¸æ“‡ï¼ˆURL é™£åˆ—ï¼‰

  useEffect(()=>{ setPick(showcase); }, [editOpen]); // é–‹å•Ÿæ™‚è¼‰å…¥

  const togglePick = (url) => {
    setPick(prev => prev.includes(url) ? prev.filter(u=>u!==url) : [...prev, url]);
  };
  const movePick = (url, dir) => {
    setPick(prev => {
      const arr = prev.slice();
      const i = arr.indexOf(url);
      if (i<0) return prev;
      const j = i + (dir==='up'?-1:+1);
      if (j<0 || j>=arr.length) return prev;
      [arr[i], arr[j]] = [arr[j], arr[i]];
      return arr;
    });
  };
  const savePick = () => {
    setData(s => {
      const next = { ...(s||{}) };
      next.gallery = next.gallery || {};
      next.gallery.homepage_showcase = (pick||[]).filter(Boolean);
      return next;
    });
    setEditOpen(false);
    alert("å·²æ›´æ–°é¦–é é–‹ç®±/åˆ°è²¨å¯¦æ‹é¡¯ç¤º");
  };

  return (
    <div className="min-h-full bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
      {/* Hero */}
      <section className="py-8 sm:py-12">
        <div className="mx-auto max-w-6xl px-4 grid lg:grid-cols-2 gap-6 items-start">
          <div className="space-y-4">
            <h1 className="text-3xl sm:text-4xl font-extrabold leading-[1.15] tracking-tight">
              CxQé–‹çæ‰€ï½œå®˜æ–¹å¹³å°
            </h1>
            <p className="text-[15px] leading-relaxed text-slate-600 dark:text-slate-300">
              ç›²ç›’ãƒ»å…¬ä»”ãƒ»å°ç‰©é€æ˜è²©å”®èˆ‡äº¤æµ<br/>æŠ½çç‚ºé™„å±¬å›é¥‹ï¼Œå…¬é–‹ç´€éŒ„ï¼Œå®‰å¿ƒä¸‹å–®ã€‚
            </p>

            {/* ä¸»è¡Œå‹• */}
            <div className="flex flex-wrap gap-3">
              <a
                href={lineGroupUrl}
                target="_blank"
                className="rounded-xl bg-brand text-white px-4 py-2.5 text-sm shadow-[0_10px_25px_-12px_rgba(0,0,0,0.28)] active:scale-[0.99] transition"
              >
                åŠ å…¥LINEç¾¤
              </a>
              {officialLineUrl && (
                <a
                  href={officialLineUrl}
                  target="_blank"
                  className="rounded-xl border border-slate-200 bg-white/70 px-4 py-2.5 text-sm text-slate-700 shadow-sm backdrop-blur hover:bg-white active:scale-[0.99] transition dark:bg-slate-900/40 dark:border-slate-700 dark:text-slate-100"
                >
                  å®˜æ–¹LINE
                </a>
              )}
              {admin && (
                <button
                  onClick={()=>setEditOpen(true)}
                  className="rounded-xl bg-brand text-white px-4 py-2.5 text-sm shadow-[0_10px_25px_-12px_rgba(0,0,0,0.28)] active:scale-[0.99] transition"
                  title="åªå½±éŸ¿é¦–é å›å ±å€ï¼›åˆ†é å›å ±å€ç¶­æŒåŸè¨­å®š"
                >
                  ç·¨è¼¯é¦–é å›å ±
                </button>
              )}
            </div>

            {/* 4 é¡†é‡é»æŒ‰éˆ• */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 pt-2" data-testid="stats">
              <ActionTile scheme="muted"  emphasis="muted" icon="â³" label="ç­‰å¾…é–‹ç" count={eff.pending} onClick={() => setTab('pending')} />
              <ActionTile scheme="muted"  emphasis="muted" icon="ğŸ“š" label="æ­·å²ç´€éŒ„" count={eff.history} onClick={() => setTab('history')} />
              <ActionTile scheme="brand"  emphasis="primary" icon="ğŸ›’" label="ç¤¾ç¾¤å•†åº—" count={eff.store}   onClick={() => setTab('store')} />
              <ActionTile scheme="cyan"   emphasis="secondary" icon="ğŸ’" label="é»æ•¸å•†åŸ" count={eff.shop}    onClick={() => setTab('shop')} />
            </div>
          </div>
        </div>
      </section>


      {/* é–‹ç®±/åˆ°è²¨å¯¦æ‹ï¼ˆè­‰æ“šç‰†ï¼‰ */}
      {galleryImages.length > 0 && (
        <section className="mx-auto max-w-6xl px-4 pb-10">
          <div className="rounded-2xl border border-slate-200/70 dark:border-slate-700/70 bg-slate-50/70 dark:bg-slate-800/40 p-4 shadow-sm">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="font-semibold text-base">é–‹ç®±/åˆ°è²¨å¯¦æ‹</div>
                <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">åœ–ç‰‡ç‚ºç¾¤å‹å›å ±æˆªåœ–ï¼Œåƒ…ä½œç‚ºç´€éŒ„èˆ‡åˆ†äº«</div>
              </div>
              <button
                className="shrink-0 rounded-xl border border-slate-200 dark:border-slate-700 px-3 py-2 text-sm hover:bg-white/60 dark:hover:bg-slate-800/60 active:scale-[0.99] transition"
                onClick={() => setTab('gallery')}
              >
                æŸ¥çœ‹å…¨éƒ¨
              </button>
            </div>

            <div className="mt-4 flex gap-3 overflow-x-auto pb-2 -mx-1 px-1 snap-x snap-mandatory">
              {galleryImages.map((src, i) => (
                <img
                  key={i}
                  loading="lazy"
                  src={src}
                  className="snap-start rounded-xl h-28 w-28 sm:h-32 sm:w-32 md:h-36 md:w-36 object-cover border border-slate-200/60 dark:border-slate-700/60"
                  alt=""
                  onClick={() => setTab('gallery')}
                />
              ))}
            </div>
          </div>
        </section>
      )}

      {/* FAQ */}
      <section id="faq" className="mx-auto max-w-6xl px-4 py-10" data-testid="faq">
        <FaqSection data={data} admin={admin} onOpenAdmin={() => setTab('faq-admin')} />
      </section>

      {/* â˜… ç·¨è¼¯é¦–é å›å ±ï¼šåªå½±éŸ¿é¦–é  */}
      {admin && editOpen && (
        <div className="fixed inset-0 z-[1000] bg-black/40 backdrop-blur-sm flex">
          <div className="m-auto w-[min(1000px,96vw)] max-h-[92vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl flex flex-col">
            <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div className="font-semibold">ç·¨è¼¯é¦–é å›å ±ï¼ˆåƒ…é¦–é é¡¯ç¤ºé †åºèˆ‡ç¯„åœï¼‰</div>
              <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>setEditOpen(false)}>é—œé–‰</button>
            </div>

            <div className="flex-1 grid md:grid-cols-2 gap-3 p-3 overflow-y-auto">
              {/* å·¦ï¼šåœ–åº«ï¼ˆå…¨ï¼‰ */}
              <div className="rounded-xl border p-3">
                <div className="text-sm font-medium mb-2">åœ–åº«ï¼ˆå…¨éƒ¨é–‹ç®±/åˆ°è²¨å¯¦æ‹ä¾†æºï¼‰</div>
                <div className="grid grid-cols-3 gap-2">
                  {allGallery.map((g, idx) => {
                    const url = g.url || g.img || g.image || g.src || "";
                    if (!url) return null;
                    const picked = pick.includes(url);
                    return (
                      <button
                        key={idx}
                        className={`relative rounded-lg overflow-hidden border ${picked ? 'ring-2 ring-brand' : ''}`}
                        onClick={()=>togglePick(url)}
                        title={picked ? 'å–æ¶ˆå‹¾é¸' : 'åŠ å…¥é¦–é å›å ±'}
                      >
                        <img src={url} alt="" className="w-full h-24 object-cover" loading="lazy" />
                        {picked && <div className="absolute inset-0 bg-brand/20" />}
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* å³ï¼šå·²é¸ï¼ˆå¯æ’åºï¼‰ */}
              <div className="rounded-xl border p-3">
                <div className="text-sm font-medium mb-2">å·²é¸ï¼ˆæ‹–æ›é †åºï¼šç”¨ä¸Šä¸‹éµï¼‰</div>
                {pick.length === 0 && <div className="text-sm text-slate-500">å°šæœªé¸æ“‡ä»»ä½•åœ–ç‰‡</div>}
                <div className="grid gap-2">
                  {pick.map((url, i)=>(
                    <div key={url+i} className="flex items-center gap-2 rounded-lg border p-2 bg-white/70 dark:bg-slate-900/60">
                      <img src={url} alt="" className="w-16 h-12 object-cover rounded" />
                      <div className="text-xs text-slate-500 truncate flex-1">{url}</div>
                      <div className="flex items-center gap-1">
                        <button className="rounded border px-2 py-1 text-xs" onClick={()=>movePick(url,'up')} disabled={i===0}>ä¸Š</button>
                        <button className="rounded border px-2 py-1 text-xs" onClick={()=>movePick(url,'down')} disabled={i===pick.length-1}>ä¸‹</button>
                        <button className="rounded border px-2 py-1 text-xs" onClick={()=>togglePick(url)}>ç§»é™¤</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="p-3 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between">
              <div className="text-xs text-slate-500">æç¤ºï¼šåªæœƒå½±éŸ¿é¦–é å³å´ç¸®åœ–ç‰†ï¼›é–‹ç®±/åˆ°è²¨å¯¦æ‹åˆ†é ä»ç…§åŸæœ¬å…¨å…¬é–‹é¡¯ç¤ºã€‚</div>
              <div className="flex items-center gap-2">
                <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={()=>setPick([])}>æ¸…ç©º</button>
                <button className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm" onClick={savePick}>å„²å­˜</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


function ActionTile({ icon, label, count=0, onClick, scheme="cyan", emphasis="normal" }) {
  // ä¾ scheme åˆ‡æ›ä¸€é»é»è‰²å½©ï¼ˆäº®/æ·±è‰²éƒ½é©é…ï¼‰
  const map = {
    amber:  { ring: 'ring-amber-300/40 dark:ring-amber-400/20',  chip: 'bg-amber-100 text-amber-800 dark:bg-amber-500/20 dark:text-amber-300' },
    violet: { ring: 'ring-violet-300/40 dark:ring-violet-400/20', chip: 'bg-violet-100 text-violet-800 dark:bg-violet-500/20 dark:text-violet-300' },
    cyan:   { ring: 'ring-cyan-300/40 dark:ring-cyan-400/20',    chip: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-500/20 dark:text-cyan-300' },
    rose:   { ring: 'ring-rose-300/40 dark:ring-rose-400/20',    chip: 'bg-rose-100 text-rose-800 dark:bg-rose-500/20 dark:text-rose-300' },
    brand:  { ring: 'ring-brand/45 dark:ring-brand/25',          chip: 'bg-brand/10 text-brand-fg dark:bg-brand/20 dark:text-brand' },
    muted:  { ring: 'ring-slate-200/60 dark:ring-slate-600/35',   chip: 'bg-slate-100 text-slate-700 dark:bg-slate-700/40 dark:text-slate-200' },
  };
  const tone = map[scheme] || map.cyan;

  // è¦–è¦ºå±¤ç´šï¼šä¸æ”¹åŠŸèƒ½ï¼Œåªæ”¹é¦–é ã€Œå››å¡ã€çš„æ¬Šé‡å‘ˆç¾
  const emph = {
    primary:   {
      wrap: 'border-brand/30 dark:border-brand/25 bg-gradient-to-br from-white to-brand/5 dark:from-slate-800 dark:to-brand/10 shadow-[0_14px_34px_-18px_rgba(0,0,0,0.55)] hover:shadow-[0_18px_44px_-20px_rgba(0,0,0,0.65)]',
      icon: 'bg-brand/10 text-brand-fg dark:bg-brand/20 dark:text-brand',
      ring: 'hover:ring-2 ring-brand/40',
    },
    secondary: {
      wrap: 'bg-gradient-to-br from-white to-slate-50/60 dark:from-slate-800 dark:to-slate-800/60 shadow-[0_10px_26px_-16px_rgba(0,0,0,0.38)] hover:shadow-[0_14px_34px_-18px_rgba(0,0,0,0.48)]',
      icon: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100',
      ring: '',
    },
    muted:     {
      wrap: 'bg-slate-50/60 dark:bg-slate-800/40 shadow-[0_8px_18px_-14px_rgba(0,0,0,0.26)] hover:shadow-[0_10px_22px_-16px_rgba(0,0,0,0.32)] opacity-95',
      icon: 'bg-slate-100/80 text-slate-700 dark:bg-slate-700/60 dark:text-slate-100',
      ring: '',
    },
    normal:    {
      wrap: 'bg-gradient-to-br from-white to-slate-50/60 dark:from-slate-800 dark:to-slate-800/60 shadow-[0_10px_24px_-14px_rgba(0,0,0,0.32)] hover:shadow-[0_16px_36px_-18px_rgba(0,0,0,0.42)]',
      icon: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100',
      ring: '',
    }
  }[emphasis] || { wrap:'', icon:'', ring:'' };

  const ringClass = emphasis === "primary" ? emph.ring : `hover:ring-2 ${tone.ring}`;

  return (
    <button
      onClick={onClick}
      className={`
        group w-full text-left rounded-2xl border border-slate-200 dark:border-slate-700
        ${emph.wrap}
        px-4 py-3.5 transition transform active:scale-[0.98]
        ${ringClass}
      `}
      title={`å‰å¾€ ${label}`} aria-label={`å‰å¾€ ${label}`}
    >
      <div className="flex items-center justify-between">
        <div
          className={`
            flex items-center justify-center h-9 w-9 shrink-0 rounded-xl
            ${emph.icon}
            group-hover:scale-105 transition
          `}
        >
          <span className="text-lg leading-none">{icon}</span>
        </div>
        <div className={`grid place-items-center h-7 min-w-[2.25rem] px-2 rounded-full text-xs tabular-nums ${tone.chip}`}>
          {Number(count) || 0}
        </div>
      </div>
      <div className="mt-2 font-medium">{label}</div>
    </button>
  );
}

/* === å°å…ƒä»¶ï¼šçµ±è¨ˆå¡ï¼ˆåŠ ä¸Š onClickï¼‰ === */
function StatCard({ label, value, onClick }) {
  return (
    <button
      onClick={onClick}
      className="text-left rounded-2xl border bg-white/80 dark:bg-slate-800/60 p-4 shadow-[0_10px_25px_-10px_rgba(0,0,0,0.25)] w-full"
      title={`å‰å¾€ ${label}`}
      aria-label={`å‰å¾€ ${label}`}
    >
      <div className="text-xs text-slate-500">{label}</div>
      <div className="text-2xl font-bold tabular-nums">{Number(value)||0}</div>
    </button>
  );
}

/* === å°å…ƒä»¶ï¼šå¯æ”¶åˆå€å¡Šï¼ˆé è¨­æ”¶åˆï¼‰ === */
function Fold({ open=false, onToggle=()=>{}, title, subtitle, onSeeAll=()=>{}, children }) {
  return (
    <div className="my-6 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60">
      <button
        className="w-full flex items-center justify-between px-4 py-3 text-left"
        onClick={() => onToggle(!open)}
        aria-expanded={open}
        title={open ? 'æ”¶åˆ' : 'å±•é–‹'}
      >
        <div>
          <div className="text-lg font-semibold">{title}</div>
          {subtitle && <div className="text-sm text-slate-500">{subtitle}</div>}
        </div>
        <div className="flex items-center gap-3">
          <span
            className="text-sm text-brand underline underline-offset-2"
            onClick={(e)=>{ e.stopPropagation(); onSeeAll(); }}
          >
            æŸ¥çœ‹ä½ç½®
          </span>
          <span className="text-slate-400">{open ? 'ï¼' : 'ï¼‹'}</span>
        </div>
      </button>
      {open && <div className="px-4 pb-4">{children}</div>}
    </div>
  );
}

/* === å·²æœ‰çš„å°å…ƒä»¶ä¿ç•™ === */
function HeaderWithCTA(){ return null } // ä¸å†ä½¿ç”¨ï¼ˆFold å–ä»£ï¼‰
function CarouselRow({ children }) {
  return <div className="no-scrollbar flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2">{children}</div>;
}
function Empty({ text }) { return <div className="text-sm text-slate-500">{text}</div>; }





// === Historyï¼ˆæ­·å²æŠ½çç´€éŒ„ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/è¤‡è£½åå–®ï¼ˆå«åˆ†é èˆ‡å½ˆå±¤æœˆæ›†ï¼‰ ===
function History({ data, admin, setData, query="", queryMode="all" }) {
  const [bulk, setBulk] = useState(null); // 'open' | 'close' | null
  const [draft, setDraft] = useState({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  const [editingId, setEditingId] = useState(null);
  const [showCal, setShowCal] = useState(false);

  // ğŸ“… æœˆæ›†ï¼šç›®å‰æª¢è¦–çš„å¹´æœˆï¼ˆUTCï¼‰èˆ‡è¢«ç¯©é¸æ—¥æœŸ
  const [cal, setCal] = useState(()=>{
    const now = new Date();
    return { y: now.getUTCFullYear(), m: now.getUTCMonth() }; // ä½¿ç”¨ UTC
  });
  const [filterDate, setFilterDate] = useState(""); // YYYY-MM-DDï¼ˆç©ºå­—ä¸²ï¼ä¸éæ¿¾ï¼‰

  // ç•¶æœˆæ—¥æ›†èˆ‡æ¯æ—¥ç´€éŒ„æ•¸
  const dayList = React.useMemo(()=> buildMonthDaysUTC(cal.y, cal.m), [cal]);
  const dateCounts = React.useMemo(()=>{
    const map = Object.create(null);
    for (const r of (data.history || [])) {
      const d = r?.date || "";
      if (!d) continue;
      map[d] = (map[d] || 0) + 1;
    }
    return map;
  }, [data.history]);

 // ç¯©é¸ï¼‹æœå°‹å¾Œçš„æ¸…å–®ï¼ˆå…ˆä¾æ—¥æœŸç¯©é¸ã€å†ä¾æœå°‹æ¨¡å¼ï¼‰
const items = React.useMemo(()=>{
  let list = data.history || [];

  // 1) æ—¥æœŸç¯©é¸
  if (filterDate) {
    list = list.filter(x => (x.date || "") === filterDate);
  }

  // 2) æœå°‹æ¨¡å¼
  const q = String(query || "").trim();
  if (!q) return list;

  return list.filter(rec => historyMatchByMode(rec, q, queryMode));
}, [data.history, filterDate, query, queryMode]);


  // === åˆ†é ï¼ˆå›ºå®šæ¯é  20 ç­†ï¼›History ç„¡ list/grid æ¨¡å¼ï¼‰ ===
  const [historyPage, setHistoryPage] = useLocalState('kjs_history_page', 1);
  const historyPageSize = 20;
  const historyTotal = items.length;
  const historyMaxPage = Math.max(1, Math.ceil(historyTotal / historyPageSize));

  React.useEffect(() => {
    if (historyPage > historyMaxPage) setHistoryPage(historyMaxPage);
  }, [historyPage, historyMaxPage, setHistoryPage]);

// çµ±ä¸€æ—¥æœŸé¡¯ç¤ºç‚º YYYY-MM-DDï¼ˆä¹Ÿå®¹å¿ 2025/9/2 é€™ç¨®ï¼‰
const fmtDate = React.useCallback((d) => {
  if (!d) return "æœªå¡«æ—¥æœŸ";
  const m = String(d).trim().match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  // m å¯èƒ½æœ‰å…©ç¨®ç¾¤çµ„ï¼Œæ•´ç†æˆ y, mo, da
  let y, mo, da;
  if (m) {
    y  = m[1]  || m[4];
    mo = m[2]  || m[5];
    da = m[3]  || m[6];
    return `${y}-${String(+mo).padStart(2, '0')}-${String(+da).padStart(2, '0')}`;
  }
  // éä»¥ä¸Šæ ¼å¼å°±ä¸å‹‰å¼·ï¼Œé¡¯ç¤ºã€Œæœªå¡«æ—¥æœŸã€
  return "æœªå¡«æ—¥æœŸ";
}, []);
 
 // ç¯©é¸æˆ–æœå°‹è®ŠåŒ–æ™‚å›åˆ°ç¬¬ 1 é 
  React.useEffect(() => {
    setHistoryPage(1);
  }, [filterDate, query, setHistoryPage]);

  const historyStart = (historyPage - 1) * historyPageSize;
  const historyEnd = Math.min(historyStart + historyPageSize, historyTotal);
  const historyPageItems = items.slice(historyStart, historyEnd);

  // é ç¢¼è¦–çª—ï¼ˆæœ€å¤š 5 æ ¼ï¼‰
  const historyWindowSize = 5;
  const historyStartPage = Math.max(
    1,
    Math.min(historyPage - Math.floor(historyWindowSize / 2), historyMaxPage - historyWindowSize + 1)
  );
  const historyEndPage = Math.min(historyMaxPage, historyStartPage + historyWindowSize - 1);

  // â€”â€” å‹•ä½œï¼šå­˜æª” / ç·¨è¼¯ / å–æ¶ˆ / åˆªé™¤ / è¤‡è£½ â€”â€” //
  const saveRecord = () => {
    if (!admin) return alert('è«‹é€²å…¥ç®¡ç†æ¨¡å¼');
    if (!draft.title) return alert('è«‹å¡«å¯«ã€çé …åç¨±ã€‘');

    const dateText = draft.date || "";
    const ts = parseISODate(dateText);
    if (dateText && Number.isNaN(ts)) return alert("æ—¥æœŸæ ¼å¼éœ€ç‚º YYYY-MM-DDï¼ˆä¾‹å¦‚ 2025-08-30ï¼‰");

    const rawLines = String(draft.winnersText).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const winners = parseLinesClean(draft.winnersText);
    const removedDup = Math.max(0, rawLines.length - winners.length);

    const winnerCount = Number(draft.winnerCount || winners.length || 0);
    const totalParticipants = Number(draft.totalParticipants || 0);
    if (winnerCount < 0 || totalParticipants < 0) return alert("åé¡èˆ‡ç¸½åƒèˆ‡äººæ•¸éœ€ç‚º 0 æˆ–æ­£æ•´æ•¸");

    const summary = [
      `ç¢ºèªè¦${editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}å—ï¼Ÿ`,
      `çé …åç¨±ï¼š${draft.title}`,
      `æ—¥æœŸï¼š${dateText || "ï¼ˆæœªå¡«ï¼‰"}`,
      `å¾—çè€…äººæ•¸ï¼š${winners.length}${removedDup ? `ï¼ˆå·²è‡ªå‹•å»é‡ ${removedDup} ç­†ï¼‰` : ""}`,
      `æŠ½å‡ºåé¡ï¼š${winnerCount}`,
      `ç¸½åƒèˆ‡äººæ•¸ï¼š${totalParticipants || "ï¼ˆæœªå¡«ï¼‰"}`
    ].join("\n");
    if (!confirm(summary)) return;

    const rec = {
      id: editingId || Math.random().toString(36).slice(2,10),
      title: draft.title,
      date: dateText,
      winners,
      winnerCount,
      totalParticipants,
      youtube: draft.youtube || "",
      status: draft.status || "",
      note: draft.note || ""
    };

    const base = data.history || [];
    const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];
    const sorted = sortHistoryDesc(next); // å­˜æª”å³æ’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
    setData({ ...data, history: sorted });

    setEditingId(null);
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
  };

  const editRecord = (x) => {
    if (!admin) return;
    setEditingId(x.id);
    setDraft({
      date: x.date||'',
      title: x.title||'',
      winnersText: (x.winners||[]).join('\n'),
      winnerCount: String(x.winnerCount??''),
      totalParticipants: String(x.totalParticipants??''),
      youtube: x.youtube||'',
      status: x.status||'',
      note: x.note||''
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
    setDraft({ date:'', title:'', winnersText:'', winnerCount:'', totalParticipants:'', youtube:'', status:'', note:'' });
    setEditingId(null);
  };

  const removeRecord = (id) => {
    if (!admin) return;
    if (!confirm('åˆªé™¤æ­¤ç­†æ­·å²ç´€éŒ„ï¼Ÿ')) return;
    setData({ ...data, history: (data.history || []).filter(x => x.id !== id) });
  };

  const copyWinners = (arr=[]) => navigator.clipboard.writeText((arr||[]).join('\n')).then(()=>alert('å·²è¤‡è£½å¾—çè€…åå–®'));

  // â€”â€” ç•«é¢ â€”â€” //
  return (
    <Section title="ğŸ“š æ­·å²æŠ½çç´€éŒ„" subtitle="å®Œæ•´æ­·å±†æ´»å‹•ç´€éŒ„ã€‚">
      {/* ğŸ“… æœˆæ›†å¿«ç¯©ï¼ˆé ‚éƒ¨ï¼‰â€” å°æŒ‰éˆ• + å½ˆå±¤ */}
      <div className="flex items-center justify-between mb-3">
  <div className="text-sm text-slate-500">ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸</div>
  <div className="flex items-center gap-2">
    {filterDate && (
      <button
        type="button"
        className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
        title="æ¸…é™¤æ—¥æœŸç¯©é¸ï¼Œæ¢å¾©å…¨éƒ¨ç€è¦½"
        onClick={() => { setFilterDate(""); setHistoryPage(1); }}
      >
        æ¸…é™¤ç¯©é¸
      </button>
    )}
    <button
      onClick={()=>setShowCal(true)}
      className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm"
      title="é–‹å•Ÿæœˆæ›†"
    >
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      æœˆæ›†
    </button>
  </div>
</div>


      {/* ç•¶å‰ç¯©é¸æç¤º */}
      <div className="text-xs text-slate-500 mb-3">
        {filterDate
          ? <>å·²å¥—ç”¨æ—¥æœŸç¯©é¸ï¼š<b>{filterDate}</b>ï¼ˆé»æœˆæ›†æ¸…é™¤ï¼‰</>
          : <>å¯ä¾æ—¥æœŸå¿«é€Ÿç¯©é¸ç´€éŒ„</>}
      </div>

      {/* å½ˆå±¤æœˆæ›†ï¼ˆé®ç½© + ç½®ä¸­å¡ç‰‡ï¼‰ */}
      {showCal && (
  <div className="fixed inset-0 z-50" onClick={()=>setShowCal(false)}>
    {/* é»‘è‰²é®ç½©ï¼ˆæ­¤å±¤ä¸å†éœ€è¦ onClickï¼Œç¶­æŒè¦–è¦ºï¼‰ */}
    <div className="absolute inset-0 bg-black/40" />
    <div className="absolute inset-0 flex items-start justify-center p-4 overflow-auto sm:items-center">

      {/* å¡ç‰‡ä¸»é«”ï¼šé˜»æ­¢å†’æ³¡ï¼Œé¿å…é»æ“Šå¡ç‰‡å…§éƒ¨ä¹Ÿè¢«ç•¶æˆé—œé–‰ */}
      <div
        className="w-full max-w-md rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl p-4"
        onClick={(e)=>e.stopPropagation()}
      >
        <div className="flex items-center justify-between">
          <div className="text-sm font-medium">{cal.y} å¹´ {cal.m + 1} æœˆ</div>
          <div className="flex items-center gap-1">
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m-1<0?{y:y-1,m:11}:{y,m:m-1})); }}
              title="å‰ä¸€å€‹æœˆ"
            >â€¹</button>
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>{ setCal(({y,m})=> (m+1>11?{y:y+1,m:0}:{y,m:m+1})); }}
              title="ä¸‹ä¸€å€‹æœˆ"
            >â€º</button>
            {/* ç›´æ¥åœ¨å½ˆå±¤å…§æä¾›ã€Œæ¸…é™¤ã€ï¼šä¸€éµæ¢å¾©å…¨éƒ¨ç€è¦½ */}
            {filterDate && (
              <button
                className="rounded-lg border px-2 py-1.5 text-sm"
                onClick={()=>{ setFilterDate(""); setHistoryPage(1); }}
                title="æ¸…é™¤æ—¥æœŸç¯©é¸"
              >
                æ¸…é™¤
              </button>
            )}
            {/* é¡å¤–çš„é—œé–‰æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰ */}
            <button
              className="rounded-lg border px-2 py-1.5 text-sm"
              onClick={()=>setShowCal(false)}
              title="é—œé–‰"
            >âœ•</button>
          </div>
        </div>

        {/* æ˜ŸæœŸåˆ— */}
        <div className="grid grid-cols-7 text-xs text-slate-500 mt-3">
          {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((w,i)=>(<div key={i} className="px-1 py-1 text-center">{w}</div>))}
        </div>

        {/* æ—¥æ›†æ ¼ */}
        <div className="grid grid-cols-7 gap-1 mt-1">
          {dayList.map((d, i)=>{
            if (!d) return <div key={i} className="h-9 rounded-lg" />;
            const count = dateCounts[d] || 0;
            const active = !!count;
            const selected = filterDate === d;
            return (
              <button
                key={i}
                onClick={()=>{
                  setFilterDate(prev => prev === d ? "" : d);
                  setHistoryPage(1);
                  setShowCal(false);
                }}
                className={[
                  "h-9 rounded-lg border text-sm flex flex-col items-center justify-center",
                  selected ? "border-brand bg-brand/10" : "border-slate-200 dark:border-slate-700",
                  active ? "hover:bg-slate-50 dark:hover:bg-slate-800" : "opacity-60"
                ].join(" ")}
                title={active ? `æ­¤æ—¥å…±æœ‰ ${count} ç­†ç´€éŒ„` : "æ­¤æ—¥æ²’æœ‰ç´€éŒ„"}
              >
                <div className="leading-none">{parseInt(d.slice(-2),10)}</div>
                {active && (
                  <div className="text-[10px] leading-none mt-0.5 inline-flex items-center px-1 rounded border bg-white/70 dark:bg-slate-800/70">
                    {count}
                  </div>
                )}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  </div>
)}


      {/* ç®¡ç†è¡¨å–® */}
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" type="date" value={draft.date} onChange={e=>setDraft(d=>({...d,date:e.target.value}))} placeholder="æˆªæ­¢/é–‹çæ—¥æœŸ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="çé …åç¨±"/>
            <input className="rounded-lg border px-3 py-2" value={draft.winnerCount} onChange={e=>setDraft(d=>({...d,winnerCount:e.target.value}))} placeholder="æŠ½å‡ºåé¡ï¼ˆç•™ç©ºï¼ä»¥åå–®æ•¸é‡ï¼‰"/>
            <input className="rounded-lg border px-3 py-2" value={draft.totalParticipants} onChange={e=>setDraft(d=>({...d,totalParticipants:e.target.value}))} placeholder="ç¸½åƒèˆ‡äººæ•¸"/>
            <input className="rounded-lg border px-3 py-2 sm:col-span-2" value={draft.youtube} onChange={e=>setDraft(d=>({...d,youtube:e.target.value}))} placeholder="æŠ½çå½±ç‰‡ï¼ˆYouTube é€£çµï¼Œå¯ç©ºç™½ï¼‰"/>
            <select
              className="rounded-lg border px-3 py-2"
              value={draft.status}
              onChange={e=>setDraft(d=>({...d,status:e.target.value}))}
            >
              <option value="">ï¼ˆä¸å¡«ï¼‰</option>
              {HISTORY_STATUS_OPTIONS.map(opt=>(
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
            </select>
            <input className="rounded-lg border px-3 py-2" value={draft.note} onChange={e=>setDraft(d=>({...d,note:e.target.value}))} placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰"/>
          </div>
          <div>
            <label className="text-sm text-slate-500">å¾—çè€…åå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼‰</label>
            <textarea className="mt-1 w-full rounded-lg border px-3 py-2 min-h-[120px]" value={draft.winnersText} onChange={e=>setDraft(d=>({...d,winnersText:e.target.value}))} placeholder="ä¸€è¡Œä¸€å€‹ LINE æš±ç¨±"></textarea>
          </div>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveRecord} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢ç´€éŒ„"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      {/* å…¨å±•/å…¨æ”¶ï¼ˆåƒ…å°ç•¶é æœ‰æ•ˆï¼‰ */}
      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

      </div>

      {/* æ¸…å–®ï¼ˆç•¶é è³‡æ–™ï¼‰ */}
      <div className="grid gap-4 mt-4">
        {historyPageItems.map(x => (
          <Collapse
  key={x.id}
  group="history"
  uid={x.id}
  force={bulk}  // ä¿ç•™
  header={(open) => <HistoryHeaderRow rec={x} />}
>
  {/* æ‰‹æ©Ÿï¼šå±•é–‹å¾Œé¡¯ç¤ºå®Œæ•´çå“åç¨± */}
  <div className="sm:hidden mb-2">
    <div className="text-[15px] font-medium whitespace-normal break-words">
      <span className="mr-1" aria-hidden="true">ğŸ</span>
      {x.title || "ï¼ˆæœªå‘½åï¼‰"}
    </div>
  </div>

  <div className="text-sm grid sm:grid-cols-2 gap-x-6 gap-y-1">
    <div>æŠ½å‡ºåé¡ï¼š{x.winnerCount ?? (x.winners?.length||0)}</div>
    <div>ç¸½åƒèˆ‡äººæ•¸ï¼š{x.totalParticipants ?? '-'}</div>

    {x.youtube && (
      <div className="sm:col-span-2 truncate">
        å½±ç‰‡ï¼š
        <a className="text-brand underline" href={x.youtube} target="_blank" rel="noreferrer">
          {x.youtube}
        </a>
      </div>
    )}

    {x.status && (
      <div className="sm:col-span-2">
        <StatusTag value={x.status} />
      </div>
    )}

    {x.note && <div className="sm:col-span-2">å‚™è¨»ï¼š{x.note}</div>}
  </div>

  <div className="mt-3">
    <div className="text-sm text-slate-500 mb-1">å¾—çè€…ï¼š</div>
    <pre className="whitespace-pre-wrap text-sm bg-slate-50 dark:bg-slate-800 p-3 rounded-lg max-h-48 overflow-auto">
      {(x.winners||[]).join('\n')}
    </pre>
  </div>

  <div className="mt-3 flex gap-2 justify-end">
    <button onClick={()=>copyWinners(x.winners)} className="rounded-lg border px-3 py-1.5">è¤‡è£½åå–®</button>
    {admin && (
      <>
        <button onClick={()=>editRecord(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
        <button onClick={()=>removeRecord(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
      </>
    )}
  </div>
</Collapse>

        ))}
      </div>

      {/* åˆ†é æ§åˆ¶ï¼ˆHistoryï¼‰ */}
      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage <= 1}
          onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
        >
          ä¸Šä¸€é 
        </button>

        {Array.from({ length: (historyEndPage - historyStartPage + 1) }, (_, i) => historyStartPage + i).map(p => (
          <button
            key={p}
            type="button"
            className={`rounded-lg border px-3 py-1.5 text-sm ${p === historyPage ? 'bg-brand text-white border-brand' : ''}`}
            onClick={() => setHistoryPage(p)}
          >
            {p}
          </button>
        ))}

        <button
          type="button"
          className="rounded-lg border px-3 py-1.5 text-sm"
          disabled={historyPage >= historyMaxPage}
          onClick={() => setHistoryPage(p => Math.min(historyMaxPage, p + 1))}
        >
          ä¸‹ä¸€é 
        </button>
      </div>
    </Section>
  );
}


function CustomPage() {
  return (
    <Section>
      <h2 className="text-xl font-bold">ğŸ§µ æ‰‹ä½œ/è¨‚è£½å€</h2>
      <p className="text-slate-600 dark:text-slate-300 mt-2">
        æ­¤å€å…ˆé ç•™ç©ºé–“ï¼Œå¾ŒçºŒå°‡è¦åŠƒç‚ºè¨‚è£½æœå‹™å…¥å£ï¼ˆåˆä½œæ’ç•«å®¶ã€å¯è¨‚è£½å•†å“ç­‰ï¼‰ã€‚
      </p>
      <div className="mt-4 rounded-2xl border bg-white/70 dark:bg-slate-900/60 p-4">
        <div className="text-sm text-slate-500">
          ç›®å‰å°šæœªé–‹æ”¾ï¼Œæ•¬è«‹æœŸå¾…ã€‚
        </div>
      </div>
    </Section>
  );
}

function LinksPage({ data, setData, admin }) {
  const links = Array.isArray(data?.homepage?.links) ? data.homepage.links : [];
  const [page, setPage] = useLocalState('kjs_links_page', 1);
  const pageSize = 20;
  const total = links.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage   = Math.min(maxPage, startPage + windowSize - 1);

  const [draft, setDraft] = React.useState({ name: '', url: '' });

  const addLink = () => {
    if (!admin) return;
    if (!draft.name.trim() || !draft.url.trim()) return alert('è«‹å¡«åç¨±èˆ‡ç¶²å€');
    const next = [{ id: nid(), name: draft.name.trim(), url: draft.url.trim() }, ...links];
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: next } }));
    setDraft({ name:'', url:'' });
  };
  const removeLink = (id) => {
    if (!admin) return;
    if (!confirm('åˆªé™¤æ­¤é€£çµï¼Ÿ')) return;
    setData(s => ({ ...s, homepage: { ...(s.homepage||{}), links: (s.homepage?.links||[]).filter(x=>x.id!==id) } }));
  };

  return (
    <Section title="ğŸ”— ç¤¾ç¾¤èˆ‡å®˜æ–¹é€£çµ" subtitle="å¯è‡ªè¨‚å¤šå€‹é€£çµï¼Œæ”¯æ´åˆ†é ã€‚">
      {admin && (
        <div className="mb-3 grid sm:grid-cols-[1fr_2fr_auto] gap-2">
          <input className="rounded-lg border px-3 py-2" placeholder="åç¨±"
                 value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))}/>
          <input className="rounded-lg border px-3 py-2" placeholder="https://..."
                 value={draft.url} onChange={e=>setDraft(d=>({...d,url:e.target.value}))}/>
          <button className="rounded-lg bg-brand text-white px-3 py-2" onClick={addLink}>æ–°å¢</button>
        </div>
      )}

      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
        {links.slice(start, end).map(x => (
          <a key={x.id} href={x.url} target="_blank" rel="noreferrer"
             className="rounded-xl border p-3 hover:border-brand">
            <div className="font-medium truncate">{x.name || x.url}</div>
            <div className="text-xs text-slate-500 truncate">{x.url}</div>
            {admin && (
              <div className="mt-2 text-right">
                <button className="rounded-lg border px-2 py-1 text-xs"
                        onClick={(e)=>{e.preventDefault(); removeLink(x.id);}}>åˆªé™¤</button>
              </div>
            )}
          </a>
        ))}
      </div>

      <div className="mt-4 flex items-center justify-center gap-1 select-none">
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
        {Array.from({length:(endPage - startPage + 1)}, (_,i)=>startPage+i).map(p=>(
          <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page?'bg-brand text-white border-brand':''}`}
                  onClick={()=>setPage(p)}>{p}</button>
        ))}
        <button className="rounded-lg border px-3 py-1.5 text-sm"
                disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
      </div>
    </Section>
  );
}




// === Ongoingï¼ˆé€²è¡Œä¸­æ´»å‹•ï¼‰â€” å¯æ–°å¢/ç·¨è¼¯/åˆªé™¤/ä¸Šä¸‹ç§»å‹•/å•Ÿç”¨åœç”¨ ===
function Ongoing({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  const [editingId, setEditingId] = useState(null);

  const items = React.useMemo(()=>{
  let list = data.ongoing || [];
  if(!admin) list = list.filter(x => x.enabled !== false);
  const q = String(query).trim().toLowerCase();
  if(!q) return list;
  return list.filter(x=>{
    const hay = [
      x.title, x.desc, x.rules, x.link
    ].map(s => String(s||"").toLowerCase()).join(" ");
    return hay.includes(q);
  });
},[data.ongoing, admin, query]);

  const HasImageInput = typeof ImageInput === "function";

  const saveOngoing = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, desc: draft.desc||"", rules: draft.rules||"", link: draft.link||"", image: draft.image||"", enabled: !!draft.enabled };
    const base = data.ongoing || [];
const next = editingId ? base.map(x => x.id===editingId ? rec : x) : [rec, ...base];

    setData({ ...data, ongoing: next });
    setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true });
  };

  const editOngoing = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", desc:x.desc||"", rules:x.rules||"", link:x.link||"", image:x.image||"", enabled: !!x.enabled }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", desc:"", rules:"", link:"", image:"", enabled:true }); };

  const removeOngoing = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, ongoing: (data.ongoing || []).filter(x => x.id !== id) }); };

  const toggleEnabled = (id) => { if(!admin) return; setData({ ...data, ongoing: (data.ongoing || []).map(x => x.id===id ? { ...x, enabled: !x.enabled } : x) });
 };

  const move = (id, dir) => {
  if (!admin) return;
  const arr = [...(data.ongoing || [])];
  const i = arr.findIndex(x => x.id === id);
  const j = dir === "up" ? i - 1 : i + 1;
  if (i < 0 || j < 0 || j >= arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
  setData({ ...data, ongoing: arr });
};

  const moveUp = (id) => move(id, 'up');
  const moveDown = (id) => move(id, 'down');

  return (
    <Section title="ğŸ”„ é€²è¡Œä¸­æ´»å‹•" subtitle="å¡ç‰‡å¼å±•ç¤ºï¼ˆå¯ä¸Šä¸‹ç§»å‹•ã€å•Ÿç”¨/åœç”¨ã€ç·¨è¼¯ï¼‰ã€‚">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <div className="grid sm:grid-cols-2 gap-3">
            <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="æ¨™é¡Œ"/>
            <input className="rounded-lg border px-3 py-2" value={draft.link} onChange={e=>setDraft(d=>({...d,link:e.target.value}))} placeholder="é€£çµï¼ˆå¯ç©ºç™½ï¼‰"/>
            <div className="sm:col-span-2">
              {HasImageInput
                ? <ImageInput label="å±•ç¤ºåœ–ç‰‡" value={draft.image} onChange={(v)=>setDraft(d=>({...d,image:v}))}/>
                : <input className="rounded-lg border px-3 py-2 w-full" value={draft.image} onChange={e=>setDraft(d=>({...d,image:e.target.value}))} placeholder="å±•ç¤ºåœ–ç‰‡ï¼ˆç¶²å€æˆ– base64ï¼‰"/>}
            </div>
          </div>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.desc} onChange={e=>setDraft(d=>({...d,desc:e.target.value}))} placeholder="ä»‹ç´¹ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <textarea className="rounded-lg border px-3 py-2 min-h-[80px]" value={draft.rules} onChange={e=>setDraft(d=>({...d,rules:e.target.value}))} placeholder="è¦å‰‡ï¼ˆå¯ç©ºç™½ï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.enabled} onChange={e=>setDraft(d=>({...d,enabled:e.target.checked}))}/>å•Ÿç”¨ï¼ˆå‹¾é¸ï¼å°å¤–é¡¯ç¤ºï¼‰</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveOngoing} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {items.length===0 && <EmptyCard text="ç›®å‰æ²’æœ‰è³‡æ–™" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {items.map((x)=> (
          <Collapse key={x.id} 
 group="ongoing"        // â˜… æ–°å¢
  uid={x.id}             // â˜… æ–°å¢
  force={bulk}           // ä½ åŸæœ¬å°±æœ‰ï¼Œç•™è‘—
header={`${x.title || "æœªå‘½åæ´»å‹•"}`} force={bulk}>
            {x.image && <img src={x.image} alt="æ´»å‹•åœ–ç‰‡" className="rounded-lg max-h-56 object-contain w-full bg-slate-50 dark:bg-slate-800 mb-2"/>}
            {x.link && <div className="text-sm mb-2">é€£çµï¼š<a className="underline text-brand" href={x.link} target="_blank" rel="noreferrer">{x.link}</a></div>}
            {x.desc && <div className="text-sm whitespace-pre-wrap mb-2">{x.desc}</div>}
            {x.rules && <div className="text-sm whitespace-pre-wrap mb-2"><span className="text-slate-500">è¦å‰‡ï¼š</span>{x.rules}</div>}
            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>moveUp(x.id)} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>moveDown(x.id)} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>toggleEnabled(x.id)} className="rounded-lg border px-3 py-1.5">
                  {x.enabled ? "åœç”¨" : "å•Ÿç”¨"}
                </button>
                <button onClick={()=>removeOngoing(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

// é»æ•¸å•†åŸï¼ˆé»æ•¸å…Œæ›ï¼‰â€” ã€Œæœå°‹æ”¹æ¨™ç±¤ã€ï¼‹ã€Œä¸€éµè³¼ç‰©æ¸…å–®(é»æ•¸)ã€ï¼Œä¹/åå…­å®®æ ¼ä¿ç•™
function Shop({ data, admin, setData, query = "" }) {
  const React = window.React || globalThis.React;

  // åå¥½ï¼ˆä¹/åå…­å®®æ ¼ã€æ¯é ï¼‰
  const prefKey = "pointshop_prefs_v5";
  const loadPrefs = () => { try { return JSON.parse(localStorage.getItem(prefKey) || "{}"); } catch { return {}; } };
  const savePrefs = (p) => { try { localStorage.setItem(prefKey, JSON.stringify({ ...loadPrefs(), ...p })); } catch {} };

  const [view, setView] = React.useState(loadPrefs().view || "grid9");
  const [pageSize, setPageSize] = React.useState(loadPrefs().pageSize || 20);
  const [page, setPage] = React.useState(1);
  React.useEffect(()=>savePrefs({view}),[view]);
  React.useEffect(()=>savePrefs({pageSize}),[pageSize]);

  // æˆ‘çš„é»æ•¸ï¼ˆç›¸å®¹å¤šæ¬„ä½ï¼‰
  const initialMyPts =
    (Number.isFinite(+data?.points?.myPoints) ? +data.points.myPoints : null) ??
    (Number.isFinite(+data?.myPoints) ? +data.myPoints : 0);
  const [myPts, setMyPts] = React.useState(initialMyPts || 0);

  // ç®¡ç†é¢æ¿
  const [showEditor, setShowEditor] = React.useState(false);
  const HasShopEditor = typeof ShopEditor === "function";

  // è©³æƒ…
  const [sheet, setSheet] = React.useState({ open:false, item:null });

  // â˜… å°å¡å¼ã€Œç¯©é¸æ¨™ç±¤ã€å½ˆçª—é–‹é—œèˆ‡ç¾¤çµ„è³‡æ–™
  const [tagSheetOpen, setTagSheetOpen] = React.useState(false);
  const tagGroups = Array.isArray(data?.shop?.tagGroups) ? data.shop.tagGroups : [];

  // æ•¸å€¼è§£æ
  const safeNumber = (v) => (typeof v === "number" && Number.isFinite(v)) ? v : ((typeof v === "string" && v.trim() !== "" && !Number.isNaN(+v)) ? +v : null);
  const getRemain = (x) => [x?.stock, x?.qty, x?.quantity, x?.remaining].map(safeNumber).find(n=>n!=null);
  const getNeedPts = (x) => ['points','pts','need','needPoints','cost','costPts','pricePts'].map(k=>safeNumber(x?.[k])).find(n=>n!=null);

  // åŸå§‹è³‡æ–™
  const itemsRaw = Array.isArray(data?.shop?.items) ? data.shop.items : [];
  const normalizeItem = (it) => {
    const images = Array.isArray(it?.images) ? it.images : (it?.image ? [String(it.image)] : []);
    const tags   = Array.isArray(it?.tags) ? it.tags : (typeof it?.tags==='string'? it.tags.split(',').map(s=>s.trim()).filter(Boolean):[]);
    return { ...it, _images: images.filter(Boolean), _tags: tags, _needPts: getNeedPts(it) };
  };
  const allItems = React.useMemo(()=> itemsRaw.map(normalizeItem), [itemsRaw]);

  // æ¨™ç±¤ï¼ˆæ”¶é›† â†’ ä¾ç¾¤çµ„é †åºé‡æ’ï¼‰
  const allTags = React.useMemo(()=> collectUniqueTags(allItems, '_tags'), [allItems]);

  // â˜…â˜…â˜… ä¾ç¾¤çµ„é †åºé‡æ’ï¼ˆä¿ç•™é‹ç®—ï¼Œä¸åœ¨ Toolbar é¡¯ç¤º chipsï¼‰
  const tagsOrdered = React.useMemo(() => {
    if (!Array.isArray(tagGroups) || tagGroups.length === 0) return allTags;
    const seen = new Set();
    const ordered = [];
    tagGroups.forEach(g => {
      (g?.tags || []).forEach(t => {
        if (allTags.includes(t) && !seen.has(t)) { seen.add(t); ordered.push(t); }
      });
    });
    allTags.forEach(t => { if (!seen.has(t)) ordered.push(t); });
    return ordered;
  }, [allTags, tagGroups]);

  const tag = useTagFilter(allTags);

  // åªçœ‹æˆ‘å¯å…Œæ›
  const [onlyAffordable, setOnlyAffordable] = React.useState(false);

  // ç¯©é¸
  const filtered = React.useMemo(()=>{
    return allItems.filter(x=>{
      const okTag = !tag.picked.length || tag.picked.every(t => (x._tags||[]).includes(t));
      const need  = x._needPts ?? getNeedPts(x);
      const okPts = !onlyAffordable || (need!=null && myPts>=need);
      return (x?.enabled!==false) && okTag && okPts;
    });
  }, [allItems, tag.picked, onlyAffordable, myPts]);

  // æ’åºï¼ˆä»¥æ›´æ–°æ™‚é–“ï¼‰
  const sorted = React.useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (new Date(b?.updatedAt||b?.createdAt||0) - new Date(a?.updatedAt||a?.createdAt||0)));
    return arr;
  }, [filtered]);

  // åˆ†é 
  const total   = sorted.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  React.useEffect(()=>{ if (page>maxPage) setPage(maxPage); }, [maxPage, page]);
  React.useEffect(()=>{ setPage(1); }, [tag.picked, view, pageSize, onlyAffordable, myPts]);
  const start = (page-1)*pageSize;
  const end   = Math.min(start + pageSize, total);
  const windowSize = 5;
  const startPage  = Math.max(1, Math.min(page - Math.floor(windowSize/2), maxPage - windowSize + 1));
  const endPage    = Math.min(maxPage, startPage + windowSize - 1);
  const pageItems  = sorted.slice(start, end);

  // âœ… 9/16 å®®æ ¼ â†’ æ‰‹æ©Ÿå›ºå®š 2 æ¬„ï¼›è¼ƒå¤§å°ºå¯¸ä¾é¸é …å±•é–‹
  const gridCols =
    view === "grid16"
      ? "grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-6"
      : "grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-5";

  // ä¸€éµæ¸…å–®ï¼ˆé»æ•¸ï¼‰
  const pick = usePickList('kjs_pointshop_picklist');
  const [showConfirm, setShowConfirm] = React.useState(false);

  const Toolbar = () => (
    <div className="sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-700">
      <div className="flex flex-wrap items-center gap-2">
        {/* â›” ç§»é™¤æ•´æ’ TagChipsï¼Œåªä¿ç•™å½ˆçª—æŒ‰éˆ• */}
        {/* <TagChips tags={tagsOrdered} picked={tag.picked} onToggle={tag.toggle} onClear={tag.clear} /> */}

        {/* å°å¡å¼ã€Œç¯©é¸æ¨™ç±¤ã€â€” é¡¯ç¤ºå·²é¸æ•¸é‡ */}
        <button className="rounded-lg border px-3 py-2" onClick={()=>setTagSheetOpen(true)}>
          {tag.picked.length > 0 ? `ç¯©é¸æ¨™ç±¤ï¼ˆ${tag.picked.length}ï¼‰` : 'ç¯©é¸æ¨™ç±¤'}
        </button>

        <div className="flex items-center gap-2 ml-auto">
          <label className="flex items-center gap-1">
            æˆ‘çš„é»æ•¸
            <input
              type="number"
              inputMode="numeric"
              className="w-20 rounded border px-2 py-2 text-right"
              value={myPts}
              onChange={e=>setMyPts(Math.max(0, Number(e.target.value)||0))}
            />
          </label>
          <label className="flex items-center gap-1">
            <input type="checkbox" checked={onlyAffordable} onChange={e=>setOnlyAffordable(e.target.checked)} />
            åªçœ‹ã€Œæˆ‘å¯å…Œæ›ã€
          </label>
        </div>

        <label className="flex items-center gap-1">
          ç‰ˆé¢
          <select className="rounded border px-2 py-2" value={view} onChange={e=>setView(e.target.value)}>
            <option value="grid9">9 å®®æ ¼</option>
            <option value="grid16">16 å®®æ ¼</option>
          </select>
        </label>
        <label className="flex items-center gap-1">
          æ¯é 
          <select className="rounded border px-2 py-2" value={pageSize} onChange={e=>setPageSize(+e.target.value || 20)}>
            <option value="20">20</option><option value="40">40</option><option value="80">80</option>
          </select>
        </label>

        <div className="grow basis-full sm:basis-auto" />
        {admin && HasShopEditor && (
          <button className="rounded-lg border px-3 py-2" onClick={()=>setShowEditor(true)}>ç®¡ç†</button>
        )}
      </div>
    </div>
  );

  const Paginator = () => (
    <div className="mt-3 flex items-center justify-center gap-1 select-none">
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page<=1} onClick={()=>setPage(p=>Math.max(1,p-1))}>ä¸Šä¸€é </button>
      {Array.from({length:(endPage-startPage+1)},(_,i)=>startPage+i).map(p => (
        <button key={p} className={`rounded-lg border px-3 py-1.5 text-sm ${p===page ? 'bg-brand text-white border-brand' : ''}`} onClick={()=>setPage(p)}>{p}</button>
      ))}
      <button className="rounded-lg border px-3 py-1.5 text-sm" disabled={page>=maxPage} onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>ä¸‹ä¸€é </button>
    </div>
  );

  return (
    <section className="space-y-3">
      <Toolbar />
      <Paginator />

      {/* å°å¡ï¼šåœ–ç‰‡ â†’ åç¨± â†’ é»æ•¸ â†’ å³ä¸‹ã€Œå±•é–‹è©³æƒ…ã€ */}
      <div className={`grid ${gridCols} gap-3`} aria-label="é»æ•¸å•†åŸæ¸…å–®">
        {pageItems.map((x, i) => {
          const id      = x.id || i;
          const name    = x?.name || x?.title || 'ï¼ˆæœªå‘½åï¼‰';
          const needPts = x._needPts ?? getNeedPts(x);
          const cover   = Array.isArray(x._images) && x._images.length>0 ? x._images[0] : '';
          const remain  = getRemain(x);

          return (
            <div key={id} className="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur overflow-hidden select-none flex flex-col">
              {/* åœ–ç‰‡ï¼ˆé»é–‹è©³æƒ…ï¼‰ */}
              <button className="block w-full text-left p-3 pb-2" onClick={()=>setSheet({ open:true, item:x })}>
                <div className="aspect-[4/3] w-full rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200/70 dark:border-slate-700/70 grid place-content-center">
                  {cover ? <img src={cover} alt="" className="w-full h-full object-contain" loading="lazy" /> : <div className="text-slate-400 text-sm">ç„¡åœ–ç‰‡</div>}
                </div>
              </button>

              {/* åç¨± */}
              <button className="px-3 text-left" onClick={()=>setSheet({ open:true, item:x })} title={name}>
                <div className="text-[13px] font-medium truncate">{name}</div>
                {Array.isArray(x._tags)&&x._tags.length>0 && <div className="text-xs text-slate-500 truncate">{x._tags.join(' / ')}</div>}
              </button>

              {/* é»æ•¸è³‡è¨Š */}
              <div className="px-3 pt-2 pb-1">
                <div className="text-sm font-semibold tabular-nums">
                  {needPts!=null ? `${needPts} é»` : 'ã€€'}
                  {remain!=null && <span className="ml-2 text-xs font-normal text-slate-500">å‰©é¤˜ï¼š{remain}</span>}
                </div>
              </div>

              {/* åº•éƒ¨å‹•ä½œåˆ—ï¼šçµ±ä¸€å³ä¸‹ã€Œå±•é–‹è©³æƒ…ã€ */}
              <div className="px-3 pb-3 mt-auto flex justify-end">
                <button
                  type="button"
                  className="rounded-lg border px-3 py-1.5 text-sm"
                  onClick={()=>setSheet({ open:true, item:x })}
                  aria-label={`å±•é–‹ ${name} è©³æƒ…`}
                >
                  å±•é–‹è©³æƒ…
                </button>
              </div>
            </div>
          );
        })}
      </div>

      <Paginator />

      {/* ç®¡ç†é¢æ¿ï¼ˆä¿ç•™ï¼‰ */}
      {admin && HasShopEditor && showEditor && (
        <ShopEditor
          items={Array.isArray(data?.shop?.items) ? data.shop.items : []}
          groups={Array.isArray(data?.shop?.tagGroups) ? data.shop.tagGroups : []}
          onSave={(nextItems, nextGroups) => {
            const safeNext   = Array.isArray(nextItems)  ? nextItems  : [];
            const safeGroups = Array.isArray(nextGroups) ? nextGroups : [];
            setData(s => ({ ...s, shop: { ...(s.shop || {}), items: safeNext, tagGroups: safeGroups } }));
            setShowEditor(false);
          }}
          onClose={() => setShowEditor(false)}
        />
      )}

      {/* è©³æƒ…å½ˆçª—ï¼ˆä¿ç•™ï¼‰ */}
      <ProductSheet open={sheet.open} item={sheet.item} context="shop" onClose={()=>setSheet({ open:false, item:null })} />

      {/* ä¸€éµæ¸…å–®ï¼ˆä¿ç•™ï¼‰ */}
      <FloatingPickbar count={pick.totalQty} onOpen={()=>setShowConfirm(true)} />
      <ConfirmListDialog open={showConfirm} onClose={()=>setShowConfirm(false)} map={pick.map} mode="pts" onSetQty={(k,p,n)=>pick.setQty(k,p,n)} />

      {/* æ¨™ç±¤å°å¡ï¼ˆä¿ç•™ï¼‰ */}
      <TagFilterSheet
        open={tagSheetOpen}
        onClose={()=>setTagSheetOpen(false)}
        groups={tagGroups}
        allTags={allTags}
        picked={tag.picked}
        onApply={(list)=>{ tag.setPicked(list); setTagSheetOpen(false); }}
      />

      {/* é¿å…è¢«åº•éƒ¨æŒ‘é¸æ¢é®ä½çš„ç©ºç™½ */}
      {pick.totalQty > 0 && <div className="pickbar-spacer" />}
    </section>
  );
}


// ============================
// ShopEditorï¼šå°ˆç‚ºé»æ•¸å•†åŸçš„ç®¡ç†ç·¨è¼¯å™¨ï¼ˆä¸å½±éŸ¿ StoreEditorï¼‰â€” è¦æ ¼ç‰ˆ
// ============================
function ShopEditor({ items = [], groups = [], onSave, onClose }) {
  const React = window.React || globalThis.React;

  const [list, setList] = React.useState(() =>
    Array.isArray(items) ? items.map(x => ({ ...x })) : []
  );
  const [editingIndex, setEditingIndex] = React.useState(-1);

  // ç¾¤çµ„ç‹€æ…‹ï¼ˆå¾ props.groups åˆå§‹åŒ–ï¼‰
  const [groupsState, setGroupsState] = React.useState(() =>
    Array.isArray(groups)
      ? groups.map(g => ({ name: g?.name || "", tags: Array.isArray(g?.tags) ? [...g.tags] : [] }))
      : []
  );
  // ç”±ç•¶å‰æ¸…å–®å‹•æ…‹æ”¶é›†æ‰€æœ‰æ¨™ç±¤ï¼ˆæä¾›çµ¦ç¾¤çµ„ç·¨è¼¯å™¨ï¼‰
  const allTags = React.useMemo(() => normalizeAllTagsFromItems(list), [list]);

  // é è¨­é …ç›®
  const blankItem = () => ({
    enabled: true,
    name: "",
    points: "",
    stock: "", // å‰©é¤˜æ•¸é‡
    desc: "",
    tags: "",
    image: "",
    images: [],
    // å¯ä¸å¸¶ variantsï¼›å„²å­˜æ™‚è‹¥ mode=none æœƒåˆªé™¤
  });

  const move = (i, dir) => {
    setList(arr => {
      const a = [...arr];
      const j = i + dir;
      if (j < 0 || j >= a.length) return a;
      const tmp = a[i];
      a[i] = a[j];
      a[j] = tmp;
      return a;
    });
  };
  const remove = (i) => setList(arr => arr.filter((_, k) => k !== i));
  const toggle = (i) => setList(arr => arr.map((x, k) => (k === i ? { ...x, enabled: !(x.enabled !== false) } : x)));
  const addNew = () => { setList(arr => [...arr, blankItem()]); setEditingIndex(list.length); };

  const parseImages = (text) => {
    const lines = String(text || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    return Array.from(new Set(lines));
  };

  const ItemRow = ({ x, i }) => {
    const need  = x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? "";
    const cover = Array.isArray(x?.images) && x.images.length ? x.images[0] : (x?.image || "");
    const stock = x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "";
    const hasVariants = !!(x?.variants && x.variants.mode && x.variants.mode !== "none");
    return (
      <div className="grid grid-cols-[auto_1fr_auto] items-center gap-3 px-3 py-2 border-b">
        <div className="w-12 h-12 rounded bg-slate-100 overflow-hidden grid place-content-center">
          {cover ? <img src={cover} alt="" className="w-full h-full object-cover" /> : <span className="text-xs text-slate-400">ç„¡</span>}
        </div>
        <div className="min-w-0">
          <div className="font-medium truncate">
            {x?.name || "ï¼ˆæœªå‘½åï¼‰"}{hasVariants ? <span className="ml-2 text-xs text-emerald-600">å·²è¨­å®šè¦æ ¼</span> : null}
          </div>
          <div className="text-xs text-slate-500 truncate">
            éœ€è¦é»æ•¸ï¼š{need || "â€”"}ã€€å‰©é¤˜æ•¸é‡ï¼š{(stock === "" || stock == null) ? "â€”" : stock}ã€€æ¨™ç±¤ï¼š{Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags || "â€”")}
          </div>
        </div>
        <div className="flex items-center gap-1">
          <button className={`px-2 py-1 rounded text-xs border ${x?.enabled !== false ? "bg-emerald-50 border-emerald-200 text-emerald-700" : ""}`} onClick={() => toggle(i)}>
            {x?.enabled !== false ? "ä¸Šæ¶ä¸­" : "å·²åœç”¨"}
          </button>
          <button className="px-2 py-1 rounded text-xs border" onClick={() => move(i, -1)}>ä¸Šç§»</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={() => move(i, 1)}>ä¸‹ç§»</button>
          <button className="px-2 py-1 rounded text-xs border" onClick={() => setEditingIndex(i)}>ç·¨è¼¯</button>
          <button className="px-2 py-1 rounded text-xs border text-rose-600" onClick={() => remove(i)}>åˆªé™¤</button>
        </div>
      </div>
    );
  };

  // åŒ¯å‡º CSV
  const exportCSV = () => {
    const headers = ["enabled","name","points","stock","desc","tags","image","images"];
    const rows = list.map(x => {
      const tags   = Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags || "");
      const images = Array.isArray(x?.images) ? x.images.join("|") : (x?.image ? String(x.image) : "");
      const needPts = (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? "");
      const stock   = (x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "");
      return [(x?.enabled !== false), (x?.name || ""), needPts, stock, (x?.desc || ""), tags, (x?.image || ""), images];
    });
    const csv = [headers.join(","), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "shop_items.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // å…±åŒï¼šæŠŠ variants è½‰æˆè‰ç¨¿æ¬„ä½ï¼Œæˆ–åä¹‹
  const readVariantsToDraft = (v) => {
    const mode = v?.mode && v.mode !== "none" ? (v.mode === "double" ? "double" : "single") : "none";
    const a1 = Array.isArray(v?.attrs) && v.attrs[0] ? v.attrs[0] : { name: "", values: [] };
    const a2 = Array.isArray(v?.attrs) && v.attrs[1] ? v.attrs[1] : { name: "", values: [] };
    return {
      vMode: mode,
      v1Name: a1.name || "",
      v1ValuesText: Array.isArray(a1.values) ? a1.values.join(",") : "",
      v2Name: a2.name || "",
      v2ValuesText: Array.isArray(a2.values) ? a2.values.join(",") : "",
      vSkus: Array.isArray(v?.items) ? v.items.map(s => ({
        key: String(s?.key || ""),
        stock: s?.stock ?? "",
        points: s?.points ?? s?.needPoints ?? "",
        image: s?.image || "",
        enabled: (s?.enabled !== false)
      })) : []
    };
  };
  const writeDraftToVariants = (d) => {
    const mode = d.vMode || "none";
    if (mode === "none") return { mode: "none", attrs: [], items: [] };
    const v1Values = (d.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
    const v2Values = (d.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
    const attrs = mode === "single"
      ? [{ name: d.v1Name || "è¦æ ¼", values: v1Values }]
      : [{ name: d.v1Name || "è¦æ ¼1", values: v1Values }, { name: d.v2Name || "è¦æ ¼2", values: v2Values }];
    return {
      mode,
      attrs,
      items: Array.isArray(d.vSkus) ? d.vSkus.map(s => ({
        key: String(s.key || ""),
        stock: s.stock ?? "",
        points: s.points ?? "",
        image: s.image || "",
        enabled: (s.enabled !== false)
      })) : []
    };
  };
  const buildCombos = (mode, v1Values, v2Values) => {
    const combos = [];
    if (mode === "single") {
      v1Values.forEach(a => combos.push(a));
    } else if (mode === "double") {
      v1Values.forEach(a => v2Values.forEach(b => combos.push(`${a}|${b}`)));
    }
    return combos;
  };

  const EditorModal = ({ x, i }) => {
    const initialStock = (x?.stock ?? x?.qty ?? x?.quantity ?? x?.remaining ?? "");
    const vdraft0 = readVariantsToDraft(x?.variants);

    const [draft, setDraft] = React.useState(() => ({
      enabled: x?.enabled !== false,
      name: x?.name || "",
      points: (x?.points ?? x?.point ?? x?.needPoints ?? x?.need_point ?? ""),
      stock: (initialStock === null || initialStock === undefined) ? "" : String(initialStock),
      desc: x?.desc || "",
      tags: Array.isArray(x?.tags) ? x.tags.join(",") : (x?.tags || ""),
      image: x?.image || "",
      imagesText: (Array.isArray(x?.images) ? x.images : (x?.image ? [x.image] : [])).join("\n"),
      // è¦æ ¼è‰ç¨¿
      ...vdraft0
    }));

    const syncSkusToValues = () => {
      const mode = draft.vMode || "none";
      if (mode === "none") return;
      const v1Values = (draft.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const v2Values = (draft.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const combos = buildCombos(mode, v1Values, v2Values);
      const old = new Map((draft.vSkus || []).map(s => [String(s.key || ""), s]));
      const next = combos.map(key => {
        const s = old.get(String(key));
        return s ? { ...s } : { key, stock: "", points: "", image: "", enabled: true };
      });
      setDraft(d => ({ ...d, vSkus: next }));
    };
    const batchApply = ({ stock, points, emptyOnly = false }) => {
      setDraft(d => ({
        ...d,
        vSkus: (d.vSkus || []).map(s => {
          const n = { ...s };
          if (stock !== undefined) {
            if (!emptyOnly || String(n.stock || "") === "") n.stock = stock;
          }
          if (points !== undefined) {
            if (!emptyOnly || String(n.points || "") === "") n.points = points;
          }
          return n;
        })
      }));
    };

    const save = () => {
      const next = { ...x };
      next.enabled = !!draft.enabled;
      next.name = String(draft.name || "").trim();
      const n = draft.points;
      if (n === "" || n == null) { delete next.points; } else { next.points = n; }

      // stock
      const s = String(draft.stock || "").trim();
      if (s === "") { delete next.stock; }
      else {
        const sn = +s;
        next.stock = Number.isFinite(sn) ? sn : s;
      }

      next.desc = draft.desc;
      if ("intro" in next) delete next.intro;

      next.tags = draft.tags ? draft.tags.split(",").map(s => s.trim()).filter(Boolean) : [];
      const imgs = parseImages(draft.imagesText);
      next.images = imgs;
      next.image = imgs[0] || "";

      // è¦æ ¼å¯«å›
      const v = writeDraftToVariants(draft);
      if (v.mode === "none") delete next.variants;
      else next.variants = v;

      setList(arr => arr.map((it, k) => (k === i ? next : it)));
      setEditingIndex(-1);
    };

    // UIï¼šè¦æ ¼å–®/é›™é¢æ¿ï¼ˆé»æ•¸ï¼‰
    const SingleSpecList = () => {
      const v1Values = (draft.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const rows = (draft.vSkus || []).filter(s => v1Values.includes(s.key));
      return (
        <div className="space-y-2">
          <div className="text-xs text-slate-500">é¸é …åˆ—è¡¨ï¼ˆé€åˆ—å¡«ã€Œåº«å­˜ / é»æ•¸ã€ï¼‰</div>
          <div className="rounded border">
            <div className="grid grid-cols-[auto_1fr_1fr_auto_auto] items-center gap-2 px-3 py-2 border-b text-xs text-slate-500">
              <div>#</div><div>é¸é …</div><div>åº«å­˜</div><div>é»æ•¸</div><div>å•Ÿç”¨</div>
            </div>
            {rows.map((s, idx) => (
              <div key={s.key} className="grid grid-cols-[auto_1fr_1fr_auto_auto] items-center gap-2 px-3 py-2 border-b">
                <div className="text-xs text-slate-500">{idx+1}</div>
                <div className="text-sm">{s.key}</div>
                <input className="rounded border px-2 py-1 text-sm" value={s.stock} onChange={e=>{
                  const val = e.target.value; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, stock:val}:x)}));
                }} />
                <input className="rounded border px-2 py-1 text-sm" value={s.points} onChange={e=>{
                  const val = e.target.value; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, points:val}:x)}));
                }} />
                <label className="text-sm inline-flex items-center gap-1">
                  <input type="checkbox" checked={!!s.enabled} onChange={e=>{
                    const v = e.target.checked; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, enabled:v}:x)}));
                  }}/> å•Ÿç”¨
                </label>
              </div>
            ))}
            {rows.length===0 && <div className="px-3 py-6 text-center text-sm text-slate-500">å°šæœªç”¢ç”Ÿé¸é …ï¼Œè«‹å…ˆå¡«å®Œã€Œè¦æ ¼åç¨± / é¸é …ã€ä¸¦é»ã€Œç”Ÿæˆ/åŒæ­¥ã€</div>}
          </div>
        </div>
      );
    };
    const DoubleSpecMatrix = () => {
      const v1Values = (draft.v1ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const v2Values = (draft.v2ValuesText || "").split(",").map(s => s.trim()).filter(Boolean);
      const find = (a,b) => (draft.vSkus || []).find(s => s.key === `${a}|${b}`);
      return (
        <div className="space-y-2">
          <div className="text-xs text-slate-500">äº¤å‰è¡¨ï¼ˆæ¯æ ¼å¯å¡«ã€Œåº«å­˜ / é»æ•¸ã€æˆ–åœç”¨ï¼‰</div>
          <div className="overflow-auto rounded border">
            <table className="min-w-[560px] w-full border-collapse">
              <thead>
                <tr className="bg-slate-50 text-xs text-slate-600">
                  <th className="border px-2 py-1 text-left">{draft.v1Name || "è¦æ ¼1"}ï¼¼{draft.v2Name || "è¦æ ¼2"}</th>
                  {v2Values.map(v => <th key={v} className="border px-2 py-1 text-left">{v}</th>)}
                </tr>
              </thead>
              <tbody>
                {v1Values.map(a => (
                  <tr key={a}>
                    <th className="border px-2 py-1 text-left bg-slate-50 text-xs">{a}</th>
                    {v2Values.map(b => {
                      const s = find(a,b);
                      if (!s) return <td key={b} className="border px-2 py-1 text-center text-xs text-slate-400">â€”</td>;
                      return (
                        <td key={b} className="border px-2 py-1">
                          <div className="flex items-center gap-2">
                            <input className="w-20 rounded border px-2 py-1 text-sm" placeholder="åº«å­˜" value={s.stock} onChange={e=>{
                              const val = e.target.value; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, stock:val}:x)}));
                            }} />
                            <input className="w-24 rounded border px-2 py-1 text-sm" placeholder="é»æ•¸" value={s.points} onChange={e=>{
                              const val = e.target.value; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, points:val}:x)}));
                            }} />
                            <label className="text-xs inline-flex items-center gap-1">
                              <input type="checkbox" checked={!!s.enabled} onChange={e=>{
                                const v = e.target.checked; setDraft(d=>({...d, vSkus: d.vSkus.map(x=>x.key===s.key?{...x, enabled:v}:x)}));
                              }}/> å•Ÿç”¨
                            </label>
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
                {v1Values.length===0 && (
                  <tr><td className="border px-3 py-6 text-center text-sm text-slate-500" colSpan={Math.max(1, v2Values.length+1)}>å°šæœªç”¢ç”ŸçŸ©é™£ï¼Œè«‹å…ˆå¡«å®Œå…©å€‹è¦æ ¼ä¸¦é»ã€Œç”Ÿæˆ/åŒæ­¥ã€</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    return (
      <div className="fixed inset-0 z-[1100] bg-black/60 grid place-content-center p-3" role="dialog" aria-modal="true">
        <div className="w-[min(820px,96vw)] max-h-[90vh] overflow-auto rounded-2xl bg-white dark:bg-slate-900 shadow-xl">
          <div className="flex items-center justify-between px-4 py-3 border-b">
            <div className="font-semibold">ç·¨è¼¯é …ç›®</div>
            <div className="flex items-center gap-2">
              <button className="rounded border px-3 py-1.5 text-sm" onClick={() => setEditingIndex(-1)}>é—œé–‰</button>
              <button className="rounded bg-brand text-white px-3 py-1.5 text-sm" onClick={save}>å„²å­˜</button>
            </div>
          </div>

          <div className="p-4 space-y-4">
            {/* åŸºæœ¬æ¬„ä½ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label className="text-sm">
                åç¨±
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.name} onChange={e => setDraft(d => ({ ...d, name: e.target.value }))} />
              </label>
              <label className="text-sm">
                éœ€è¦é»æ•¸ï¼ˆpointsï¼‰
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.points} onChange={e => setDraft(d => ({ ...d, points: e.target.value }))} />
              </label>
              <label className="text-sm">
                å‰©é¤˜æ•¸é‡ï¼ˆstockï¼‰
                <input className="mt-1 w-full rounded-lg border px-3 py-2" inputMode="numeric" value={draft.stock} onChange={e => setDraft(d => ({ ...d, stock: e.target.value }))} placeholder="ä¾‹å¦‚ï¼š10" />
              </label>
              <label className="text-sm">
                å°é¢åœ–ç‰‡ï¼ˆimageï¼‰
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.image} onChange={e => setDraft(d => ({ ...d, image: e.target.value }))} />
              </label>
            </div>

            <label className="text-sm block">
              æè¿°ï¼ˆdescï¼‰
              <textarea className="mt-1 w-full rounded-lg border px-3 py-2" rows={4} value={draft.desc} onChange={e => setDraft(d => ({ ...d, desc: e.target.value }))} />
            </label>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label className="text-sm block">
                å¤šå¼µåœ–ç‰‡ï¼šæ¯è¡Œä¸€å€‹ URLï¼ˆimagesï¼‰
                <textarea
                  className="mt-1 w-full rounded-lg border px-3 py-2"
                  rows={5}
                  value={draft.imagesText}
                  onChange={e => {
                    const raw = e.target.value;
                    setDraft(d => ({ ...d, imagesText: raw }));
                  }}
                />
              </label>
              <label className="text-sm block">
                æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
                <input className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.tags} onChange={e => setDraft(d => ({ ...d, tags: e.target.value }))} />
              </label>
            </div>

            <div className="flex items-center justify-between">
              <label className="text-sm inline-flex items-center gap-2">
                <input type="checkbox" checked={!!draft.enabled} onChange={e => setDraft(d => ({ ...d, enabled: e.target.checked }))} />
                ä¸Šæ¶ï¼ˆenabledï¼‰
              </label>
            </div>

            {/* === è¦æ ¼å€å¡Šï¼ˆé»æ•¸ï¼‰ === */}
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="px-3 py-2 border-b text-sm font-medium">è¦æ ¼è¨­å®šï¼ˆå¯é¸ï¼‰</div>
              <div className="p-3 space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                  <label className="text-sm">
                    æ¨¡å¼
                    <select className="mt-1 w-full rounded-lg border px-3 py-2" value={draft.vMode}
                      onChange={e => setDraft(d => ({ ...d, vMode: e.target.value }))}>
                      <option value="none">ç„¡è¦æ ¼</option>
                      <option value="single">å–®è¦æ ¼</option>
                      <option value="double">é›™è¦æ ¼</option>
                    </select>
                  </label>

                  {draft.vMode !== "none" && (
                    <label className="text-sm">
                      {draft.vMode === "double" ? "è¦æ ¼1 åç¨±" : "è¦æ ¼åç¨±"}
                      <input className="mt-1 w-full rounded-lg border px-3 py-2"
                        value={draft.v1Name} onChange={e => setDraft(d => ({ ...d, v1Name: e.target.value }))} placeholder="ä¾‹ï¼šé¡è‰²" />
                    </label>
                  )}
                  {draft.vMode !== "none" && (
                    <label className="text-sm">
                      {draft.vMode === "double" ? "è¦æ ¼1 é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰" : "é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"}
                      <input className="mt-1 w-full rounded-lg border px-3 py-2"
                        value={draft.v1ValuesText} onChange={e => setDraft(d => ({ ...d, v1ValuesText: e.target.value }))} placeholder="ç´…, ç™½, è—" />
                    </label>
                  )}
                </div>

                {draft.vMode === "double" && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2 items-center">
                    <label className="text-sm">
                      è¦æ ¼2 åç¨±
                      <input className="mt-1 w-full rounded-lg border px-3 py-2"
                        value={draft.v2Name} onChange={e => setDraft(d => ({ ...d, v2Name: e.target.value }))} placeholder="ä¾‹ï¼šå°ºå¯¸" />
                    </label>
                    <label className="text-sm">
                      è¦æ ¼2 é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
                      <input className="mt-1 w-full rounded-lg border px-3 py-2"
                        value={draft.v2ValuesText} onChange={e => setDraft(d => ({ ...d, v2ValuesText: e.target.value }))} placeholder="S, M, L" />
                    </label>
                  </div>
                )}

                {draft.vMode !== "none" && (
                  <div className="flex flex-wrap items-center gap-2">
                    <button className="rounded-lg border px-3 py-1.5 text-sm" onClick={syncSkusToValues}>ç”Ÿæˆ/åŒæ­¥ é¸é …</button>
                    <span className="text-xs text-slate-500">å°‡ä¾é¸é …è‡ªå‹•ç”¢ç”Ÿ SKU åˆ—è¡¨/çŸ©é™£ï¼Œä¿ç•™æ—¢æœ‰è³‡æ–™</span>
                  </div>
                )}

                {draft.vMode === "single" && <SingleSpecList />}

                {draft.vMode === "double" && (
                  <>
                    <div className="flex flex-wrap items-center gap-2">
                      <span className="text-sm">æ‰¹æ¬¡å¥—ç”¨ï¼š</span>
                      <input className="w-24 rounded border px-2 py-1 text-sm" placeholder="åº«å­˜"
                        onChange={(e) => (e.target.__v = e.target.value)} />
                      <input className="w-28 rounded border px-2 py-1 text-sm" placeholder="é»æ•¸"
                        onChange={(e) => (e.target.__p = e.target.value)} />
                      <button className="rounded-lg border px-3 py-1.5 text-sm"
                        onClick={(e) => {
                          const wrap = e.currentTarget.parentElement;
                          const stock = wrap.querySelector('input[placeholder="åº«å­˜"]')?.__v;
                          const points = wrap.querySelector('input[placeholder="é»æ•¸"]')?.__p;
                          batchApply({ stock, points, emptyOnly: false });
                        }}>å¥—ç”¨å…¨éƒ¨</button>
                      <button className="rounded-lg border px-3 py-1.5 text-sm"
                        onClick={(e) => {
                          const wrap = e.currentTarget.parentElement;
                          const stock = wrap.querySelector('input[placeholder="åº«å­˜"]')?.__v;
                          const points = wrap.querySelector('input[placeholder="é»æ•¸"]')?.__p;
                          batchApply({ stock, points, emptyOnly: true });
                        }}>åªå¡«ç©ºæ ¼</button>
                    </div>
                    <DoubleSpecMatrix />
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // é–‹å•Ÿç·¨è¼¯å™¨æ™‚ï¼Œé–å®šèƒŒæ™¯æ»¾å‹•ï¼ˆé¿å…èƒŒæ™¯é è¢«æ²å‹•ï¼‰
  React.useEffect(() => {
    const el = document.documentElement;
    const prev = el.style.overflow;
    el.style.overflow = "hidden";
    return () => { el.style.overflow = prev; };
  }, []);

  return (
    <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center" role="dialog" aria-modal="true">
      <div className="w-[min(1024px,96vw)] max-h-[90vh] overflow-hidden rounded-2xl bg-white dark:bg-slate-900 shadow-xl flex flex-col">
        {/* header */}
        <div className="flex items-center justify-between px-4 py-3 border-b">
          <div className="font-semibold">é»æ•¸å•†åŸç®¡ç†</div>
          <div className="flex items-center gap-2">
            <button className="rounded border px-3 py-1.5 text-sm" onClick={exportCSV}>åŒ¯å‡º CSV</button>
            <button className="rounded border px-3 py-1.5 text-sm" onClick={onClose}>é—œé–‰</button>
            {/* å„²å­˜ï¼šå¤šå‚³ä¸€å€‹åƒæ•¸ groupsï¼ˆèˆŠå‘¼å«è€…æœƒè‡ªå‹•å¿½ç•¥ç¬¬äºŒåƒæ•¸ï¼‰ */}
            <button
              className="rounded bg-brand text-white px-3 py-1.5 text-sm"
              onClick={() => {
                const cleaned = ensureUniqueTagsInGroups(groupsState, allTags);
                onSave?.(list, cleaned);
              }}
            >
              å„²å­˜
            </button>
          </div>
        </div>

        {/* body */}
        <div className="flex-1 overflow-auto">
          <div className="p-2 space-y-4">
            {/* æ¨™ç±¤ç¾¤çµ„ç·¨è¼¯å™¨ */}
            <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="px-3 py-2 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                <div className="font-medium">æ¨™ç±¤ç¾¤çµ„ï¼ˆæ’åºï¼æ•´åˆï¼‰</div>
                <div className="text-xs text-slate-500">æœªåˆ†çµ„æ¨™ç±¤æœƒè‡ªå‹•æ­¸å…¥ã€Œå…¶ä»–ã€</div>
              </div>
              <div className="p-3">
                <TagGroupsEditor
                  groups={groupsState}
                  allTags={allTags}
                  onChange={setGroupsState}
                />
              </div>
            </div>

            {/* å•†å“æ¸…å–® */}
            <div>
              <button className="mb-2 rounded bg-emerald-600 text-white px-3 py-1.5 text-sm" onClick={addNew}>æ–°å¢é …ç›®</button>
              <div className="rounded border overflow-hidden">
                {list.length === 0 && <div className="p-6 text-center text-slate-500 text-sm">ç›®å‰æ²’æœ‰é …ç›®</div>}
                {list.map((x, i) => <ItemRow key={i} x={x} i={i} />)}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* editor modal */}
      {editingIndex >= 0 && <EditorModal x={list[editingIndex]} i={editingIndex} />}
    </div>
  );
}

/* ====== å°å·¥å…·ï¼šå¾å•†å“æ¸…å–®è’é›†å”¯ä¸€æ¨™ç±¤ ====== */
function normalizeAllTagsFromItems(list) {
  const set = new Set();
  (Array.isArray(list)? list: []).forEach(it => {
    let tags = [];
    if (Array.isArray(it?.tags)) tags = it.tags;
    else if (typeof it?.tags === 'string') tags = it.tags.split(',').map(s=>s.trim()).filter(Boolean);
    tags.forEach(t => set.add(t));
  });
  return Array.from(set);
}

/* ====== å°å·¥å…·ï¼šæ¸…æ´—ç¾¤çµ„ï¼Œå»é‡ï¼éæ¿¾ä¸å­˜åœ¨çš„æ¨™ç±¤ï¼Œä¿ç•™å…ˆå‡ºç¾çš„ç¾¤çµ„èˆ‡é †åº ====== */
function ensureUniqueTagsInGroups(groups, allTags) {
  const ok = new Set(allTags || []);
  const seen = new Set();
  const cleaned = [];

  (Array.isArray(groups)? groups: []).forEach(g => {
    const name = String(g?.name || '').trim() || 'æœªå‘½åç¾¤çµ„';
    const tags = [];
    (Array.isArray(g?.tags)? g.tags: []).forEach(t => {
      if (!ok.has(t)) return;     // å¿½ç•¥ä¸å­˜åœ¨æ–¼ allTags çš„æ¨™ç±¤
      if (seen.has(t)) return;    // å»é‡è¤‡ï¼šç¬¬ä¸€å€‹å‡ºç¾çš„ç¾¤çµ„ä¿ç•™
      seen.add(t);
      tags.push(t);
    });
    cleaned.push({ name, tags });
  });

  return cleaned;
}

/* =========================
 * TagGroupsEditorï¼šç¾¤çµ„å¯è¦–åŒ–ç·¨è¼¯å™¨ï¼ˆæ–°å¢ï¼åˆªé™¤ï¼æ”¹åï¼æ’åºï¼›ç¾¤å…§æ’åºï¼›å¾ allTags é¸å…¥ï¼‰
 * ========================= */
function TagGroupsEditor({ groups = [], allTags = [], onChange = () => {} }) {
  const React = window.React || globalThis.React;

  const addGroup = () => onChange([ ...groups, { name: '', tags: [] } ]);
  const removeGroup = (i) => onChange(groups.filter((_, idx) => idx !== i));
  const moveGroup = (i, dir) => {
    const j = i + dir;
    if (j<0 || j>=groups.length) return;
    const arr = [...groups];
    const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    onChange(arr);
  };
  const renameGroup = (i, name) => {
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, name }) : g);
    onChange(arr);
  };

  // å·²æ”¾å…¥ç¾¤çµ„çš„æ¨™ç±¤
  const inGroup = new Set(groups.flatMap(g => g?.tags || []));
  // æœªåˆ†çµ„æ¨™ç±¤ï¼ˆå¯åŠ å…¥ä»»ä¸€ç¾¤çµ„ï¼‰
  const rest = (allTags || []).filter(t => !inGroup.has(t));

  const addTagToGroup = (i, t) => {
    if (!t) return;
    // ä¸å…è¨±é‡è¤‡ï¼šè‹¥ tag å·²åœ¨å…¶ä»–ç¾¤çµ„ï¼Œå…ˆç§»å‡º
    const arr = groups.map((g, idx) => {
      if (idx === i) return { ...g, tags: Array.from(new Set([...(g?.tags||[]), t])) };
      return { ...g, tags: (g?.tags||[]).filter(x => x !== t) };
    });
    onChange(arr);
  };
  const removeTagFromGroup = (i, t) => {
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, tags: (g?.tags||[]).filter(x=>x!==t) }) : g);
    onChange(arr);
  };
  const moveTag = (i, t, dir) => {
    const tags = [...(groups[i]?.tags || [])];
    const k = tags.indexOf(t);
    const j = k + dir;
    if (k<0 || j<0 || j>=tags.length) return;
    const tmp = tags[k]; tags[k] = tags[j]; tags[j] = tmp;
    const arr = groups.map((g, idx) => idx===i ? ({ ...g, tags }) : g);
    onChange(arr);
  };

  return (
    <div className="space-y-3">
      {/* æœªåˆ†çµ„æ¨™ç±¤ */}
      <div className="rounded-lg border border-slate-200 dark:border-slate-700 p-2">
        <div className="text-xs text-slate-500 mb-1">æœªåˆ†çµ„æ¨™ç±¤ï¼ˆ{rest.length}ï¼‰</div>
        <div className="flex flex-wrap gap-2">
          {rest.length ? rest.map(t => (
            <span key={t} className="inline-flex items-center rounded-full border px-3 py-1 text-xs bg-white/70 dark:bg-slate-900/60">{t}</span>
          )) : <span className="text-xs text-slate-400">â€”</span>}
        </div>
      </div>

      {/* ç¾¤çµ„æ¸…å–® */}
      {groups.map((g, i) => {
        const availableToAdd = rest.concat( // å¯åŠ å…¥çš„ï¼šæœªåˆ†çµ„ + ä¸åœ¨æœ¬ç¾¤çµ„å…§ï¼ˆå»é‡ï¼‰
          (g?.tags || []).filter(t => !rest.includes(t))
        ).filter(Boolean);
        return (
          <div key={i} className="rounded-lg border border-slate-200 dark:border-slate-700 p-2 space-y-2">
            <div className="flex items-center gap-2">
              <input
                className="min-w-0 flex-1 rounded border px-2 py-1 text-sm"
                placeholder="ç¾¤çµ„åç¨±ï¼ˆä¾‹å¦‚ï¼šè§’è‰²ã€ç”Ÿæ´»ç”¨å“ã€3Cï¼‰"
                value={g?.name || ''}
                onChange={e=>renameGroup(i, e.target.value)}
              />
              <button className="rounded border px-2 py-1 text-xs" onClick={()=>moveGroup(i,-1)}>ä¸Šç§»</button>
              <button className="rounded border px-2 py-1 text-xs" onClick={()=>moveGroup(i, 1)}>ä¸‹ç§»</button>
              <button className="rounded border px-2 py-1 text-xs text-rose-600" onClick={()=>removeGroup(i)}>åˆªé™¤</button>
            </div>

            {/* ç¾¤å…§æ¨™ç±¤ */}
            <div className="flex flex-wrap gap-2">
              {(g?.tags || []).map(t => (
                <span key={t} className="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs">
                  {t}
                  <button className="rounded border px-1 text-[10px]" title="ä¸Šç§»" onClick={()=>moveTag(i,t,-1)}>â†‘</button>
                  <button className="rounded border px-1 text-[10px]" title="ä¸‹ç§»" onClick={()=>moveTag(i,t, 1)}>â†“</button>
                  <button className="rounded border px-1 text-[10px] text-rose-600" title="ç§»å‡ºç¾¤çµ„" onClick={()=>removeTagFromGroup(i,t)}>Ã—</button>
                </span>
              ))}
              {(g?.tags || []).length===0 && <span className="text-xs text-slate-400">å°šæœªåŠ å…¥ä»»ä½•æ¨™ç±¤</span>}
            </div>

            {/* åŠ å…¥æ¨™ç±¤åˆ°æ­¤ç¾¤çµ„ */}
            <div className="flex items-center gap-2">
              <select className="rounded border px-2 py-1 text-sm"
                value=""
                onChange={e=> addTagToGroup(i, e.target.value)}
              >
                <option value="" disabled>ï¼‹ å¾æœªåˆ†çµ„æ¨™ç±¤åŠ å…¥</option>
                {availableToAdd
                  .filter(t => !(g?.tags||[]).includes(t) && !groups.some((gg,idx)=> idx!==i && (gg?.tags||[]).includes(t)))
                  .map(t => <option key={t} value={t}>{t}</option>)
                }
              </select>
            </div>
          </div>
        );
      })}

      {/* æ–°å¢ç¾¤çµ„ */}
      <div>
        <button className="rounded bg-slate-900 text-white px-3 py-1.5 text-sm dark:bg-slate-100 dark:text-slate-900" onClick={addGroup}>æ–°å¢ç¾¤çµ„</button>
      </div>
    </div>
  );
}

function Others({ data, admin, setData, query="" }) {
  const [bulk, setBulk] = useState(null);
  const [draft, setDraft] = useState({ title:"", content:"", pin:false });
  const [editingId, setEditingId] = useState(null);

  const cards = React.useMemo(()=> data.others?.cards || [], [data.others]);

  const orderedCards = React.useMemo(()=>{
    const list = data.others?.cards || [];
    const q = String(query).trim().toLowerCase();
    const filtered = q
      ? list.filter(x =>
          String(x.title||"").toLowerCase().includes(q) ||
          String(x.content||"").toLowerCase().includes(q)
        )
      : list;
    // pin=true ç½®é ‚å„ªå…ˆ
    return [...filtered].sort((a,b)=> (b.pin===true) - (a.pin===true));
  },[data.others, query]);

  const saveCard = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    if (!draft.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
    const rec = { id: editingId || Math.random().toString(36).slice(2,10), title: draft.title, content: draft.content||"", pin: !!draft.pin };
    const next = editingId ? cards.map(x=>x.id===editingId?rec:x) : [rec, ...cards];
    setData({ ...data, others: { ...data.others, cards: next } });
    setEditingId(null); setDraft({ title:"", content:"", pin:false });
  };

  const editCard = (x) => { if(!admin) return; setEditingId(x.id); setDraft({ title:x.title||"", content:x.content||"", pin: !!x.pin }); window.scrollTo({top:0,behavior:"smooth"}); };
  const cancelEdit = () => { setEditingId(null); setDraft({ title:"", content:"", pin:false }); };

  const removeCard = (id) => { if(!admin) return; if(!confirm("åˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return; setData({ ...data, others: { ...data.others, cards: cards.filter(x=>x.id!==id) } }); };
  const togglePin = (id) => { if(!admin) return; setData({ ...data, others: { ...data.others, cards: cards.map(x=>x.id===id?{...x,pin:!x.pin}:x) } }); };

  const move = (id, dir) => {
    if (!admin) return;
    const arr = [...cards], i = arr.findIndex(x=>x.id===id), j = dir==="up" ? i-1 : i+1;
    if (i<0 || j<0 || j>=arr.length) return;
    [arr[i], arr[j]] = [arr[j], arr[i]];
    setData({ ...data, others: { ...data.others, cards: arr } });
  };

  return (
    <Section title="ğŸ“Œ å…¶ä»–è³‡æ–™" subtitle="å‰µç«‹åˆè¡·ã€å…¬å‘Šã€é–‹çæ–¹å¼ã€è£œå¯„/å†æŠ½è¦å‰‡ã€é»æ•¸è¦å‰‡ã€è´ŠåŠ©èªªæ˜ã€è´ŠåŠ©è€…åå–®ã€æŸ¥è©¢é»æ•¸â€¦">
      {admin && (
        <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
          <input className="rounded-lg border px-3 py-2" value={draft.title} onChange={e=>setDraft(d=>({...d,title:e.target.value}))} placeholder="å¡ç‰‡æ¨™é¡Œï¼ˆå¦‚ï¼šæœ€æ–°å…¬å‘Šï¼‰"/>
          <textarea className="rounded-lg border px-3 py-2 min-h-[120px]" value={draft.content} onChange={e=>setDraft(d=>({...d,content:e.target.value}))} placeholder="å…§å®¹ï¼ˆå¯è²¼é€£çµï¼‰"></textarea>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={draft.pin} onChange={e=>setDraft(d=>({...d,pin:e.target.checked}))}/>ç½®é ‚</label>
          <div className="flex gap-2 justify-end">
            {editingId && <button onClick={cancelEdit} className="rounded-lg border px-4 py-2">å–æ¶ˆ</button>}
            <button onClick={saveCard} className="rounded-lg bg-brand text-white px-4 py-2">{editingId ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢å¡ç‰‡"}</button>
          </div>
        </div>
      )}

      {cards.length === 0 && <EmptyCard text="ç›®å‰æ²’æœ‰å¡ç‰‡å…§å®¹" admin={admin} />}

      <div className="flex gap-2 justify-end mt-4">
        <button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('open');
    setTimeout(() => setBulk(null), 0); // é‡ç½®ï¼Œæ¢å¾©å–®é …å¯é»æ“Š
  }}
>
  å…¨éƒ¨å±•é–‹
</button>

<button
  className="rounded-lg border px-3 py-1.5"
  onClick={() => {
    setBulk('close');
    setTimeout(() => setBulk(null), 0); // é‡ç½®
  }}
>
  å…¨éƒ¨æ”¶åˆ
</button>

        
      </div>

      <div className="grid gap-4 mt-4">
        {orderedCards.map((x)=> (
          <Collapse key={x.id} 
group="others"         // â˜… æ–°å¢
  uid={x.id}             // â˜… æ–°å¢
  force={bulk}           // ä½ åŸæœ¬å°±æœ‰ï¼Œç•™è‘—
header={`${x.title || "æœªå‘½åå¡ç‰‡"}`} force={bulk}>
            <div className="whitespace-pre-wrap text-sm max-h-60 overflow-auto">
  {x.content || "ï¼ˆç„¡å…§å®¹ï¼‰"}
</div>

            <div className="mt-3 flex gap-2 justify-end">
              {admin && (<>
                <button onClick={()=>move(x.id,'up')} className="rounded-lg border px-3 py-1.5">ä¸Šç§»</button>
                <button onClick={()=>move(x.id,'down')} className="rounded-lg border px-3 py-1.5">ä¸‹ç§»</button>
                <button onClick={()=>togglePin(x.id)} className="rounded-lg border px-3 py-1.5">{x.pin ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚"}</button>
                <button onClick={()=>editCard(x)} className="rounded-lg border px-3 py-1.5">ç·¨è¼¯</button>
                <button onClick={()=>removeCard(x.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
              </>)}
            </div>
          </Collapse>
        ))}
      </div>
    </Section>
  );
}

function PointsPanel({ data, admin, setData }) {
  const people = React.useMemo(() => data.shop?.people || [], [data.shop]);
  const logs   = React.useMemo(() => data.shop?.logs   || [], [data.shop]); // {id, personId, delta, note, at}
  const [q, setQ] = useState("");
  const [draft, setDraft] = useState({ name: "", points: "" });

  // æŠŠã€Œé¸æ“‡äººå“¡ã€æ”¹æˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼šç”¨ datalist
  const [logDraft, setLogDraft] = useState({ name:"", delta:"", note:"" });

  const norm = (s="") => s.trim().toLowerCase();

  const result = React.useMemo(() => {
    if (!q.trim()) return null;
    const key = norm(q);
    const exact = people.find(p => norm(p.name) === key);
    if (exact) return exact;
    const fuzzy = people.find(p => norm(p.name).includes(key));
    return fuzzy || null;
  }, [q, people]);

const personIdFilter = React.useMemo(() => result?.id || null, [result]);

  const addOrUpdate = () => {
    if (!admin) return alert("è«‹é€²å…¥ç®¡ç†æ¨¡å¼");
    const raw = draft.name || "";
    const name = raw.replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if (!name) return alert("è«‹è¼¸å…¥å§“å/æš±ç¨±");
    const pts = Number(draft.points || 0);
    if (!Number.isFinite(pts)) return alert("é»æ•¸éœ€ç‚ºæ•¸å­—");

    const key = normName(name);
    const exists = people.find(p => normName(p.name) === key);

    const summary = exists
      ? `å·²å­˜åœ¨ã€Œ${exists.name}ã€ï¼Œç›®å‰é»æ•¸ï¼š${exists.points}\nè¦å°‡é»æ•¸æ”¹ç‚ºï¼š${pts} å—ï¼Ÿ`
      : `ç¢ºèªæ–°å¢äººå“¡ï¼š${name}\né»æ•¸ï¼š${pts}`;
    if (!confirm(summary)) return;

    let nextPeople;
    if (exists) {
      nextPeople = people.map(p => normName(p.name) === key ? { ...p, name, points: pts } : p);
    } else {
      nextPeople = [{ id: nid(), name, points: pts }, ...people];
    }
    setData({ ...data, shop: { ...data.shop, people: nextPeople } });
    setDraft({ name: "", points: "" });
  };

  const adjust = (id, delta) => {
    if (!admin) return;
    const next = people.map(p => p.id === id ? { ...p, points: Math.max(0, Number(p.points||0) + delta) } : p);
    const log = { id: nid(), personId:id, delta, note: delta>0?'+èª¿æ•´':'-èª¿æ•´', at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: next, logs: [log, ...logs] } });
  };

  // âœ… åˆªé™¤äººå“¡ï¼šé—œéµå­—ç¢ºèªï¼Œä¸”ä¸å†ä¸Ÿå›æ”¶ç«™
  const removePerson = (id) => {
    if (!admin) return;
    const p = people.find(x=>x.id===id); if(!p) return;
    if(!confirmKeyword({label: `æ¬²åˆªé™¤ï¼š${p.name}`, keyword:'åˆªé™¤'})) return;
    const nextShop = {
      ...data.shop,
      people: people.filter(x=>x.id!==id),
      logs   : logs // äººå“¡åˆªé™¤ä¸å‹•æ­·å²æµæ°´
    };
    setData({ ...data, shop: nextShop });
  };

  // âœ… æ–°å¢ç•°å‹•ï¼šç”¨åå­—æ‰¾äººï¼›ä¸å­˜åœ¨å°±è‡ªå‹•å»ºç«‹
  const addLog = () => {
    if(!admin) return;
    const rawName = (logDraft.name||"").replace(/\u3000/g," ").replace(/\s+/g," ").trim();
    if(!rawName) return alert('è«‹è¼¸å…¥äººå“¡å§“å/æš±ç¨±');
    const delta = Number(logDraft.delta||0);
    if(!Number.isFinite(delta) || delta===0) return alert('è«‹è¼¸å…¥é 0 çš„æ•´æ•¸ç•°å‹•');

    // å…ˆæ‰¾ç¾æœ‰äººå“¡
    const key = normName(rawName);
    let person = people.find(x => normName(x.name) === key);

    let nextPeople = [...people];
    if (!person) {
      // è‡ªå‹•å»ºç«‹æ–°çš„äººå“¡ï¼ˆ0 é»ï¼‰
      person = { id: nid(), name: rawName, points: 0 };
      nextPeople = [person, ...people];
    }

    // å¯«å…¥é»æ•¸èˆ‡æµæ°´
    nextPeople = nextPeople.map(x => x.id===person.id ? { ...x, points: Math.max(0, Number(x.points||0) + delta) } : x);
    const log = { id: nid(), personId: person.id, delta, note: logDraft.note||'', at: nowISO() };

    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [log, ...logs] } });

setQ(rawName);

    setLogDraft({ name:"", delta:"", note:"" });
  };

  const revokeLog = (logId) => {
    if(!admin) return;
    const lg = logs.find(l=>l.id===logId); if(!lg) return;
    if(!confirm('è¦æ’¤éŠ·é€™ç­†ç•°å‹•å—ï¼Ÿæœƒå¯«å…¥ä¸€ç­†ç›¸åæ•¸çš„è£œè¨˜ã€‚')) return;
    const pid = lg.personId; const delta = -lg.delta;
    const nextPeople = people.map(x=> x.id===pid ? { ...x, points: Math.max(0, Number(x.points||0)+delta) } : x);
    const newLog = { id: nid(), personId: pid, delta, note: `æ’¤éŠ· ${logId}`, at: nowISO() };
    setData({ ...data, shop: { ...data.shop, people: nextPeople, logs: [newLog, ...logs] } });
  };

  const sorted  = React.useMemo(()=> [...people].sort((a,b)=> a.name.localeCompare(b.name, "zh-Hant")), [people]);
  // ä¾ç›®å‰æŸ¥è©¢åˆ°çš„äººï¼ˆresultï¼‰ä¾†éæ¿¾å…¶å€‹äººæµæ°´ï¼Œä¸¦åªå– 5 ç­†
const latest5 = React.useMemo(() => {
  const filtered = personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
  return filtered.slice(0,5);
}, [logs, personIdFilter]);

const visibleLogs = React.useMemo(()=>{
  return personIdFilter ? logs.filter(l => l.personId === personIdFilter) : logs;
}, [logs, personIdFilter]);

const [showAllLogs, setShowAllLogs] = React.useState(false);


  return (
    <Section title="ğŸ” æŸ¥è©¢é»æ•¸" subtitle="å…¬é–‹æœ€å¤šé¡¯ç¤ºæœ€è¿‘ 5 ç­†ç•°å‹•ï¼›ç®¡ç†å¯çœ‹å…¨éƒ¨ã€åŠ ä¸€ç­†/æ’¤éŠ·ã€å¯åŒ¯å‡ºã€‚">
      <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3">
        <input className="rounded-lg border px-3 py-2" value={q} onChange={(e)=>setQ(e.target.value)} placeholder="è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢"/>
        <div className="text-sm">
          {q.trim()
            ? (result
                ? <span>ã€Œ<b>{result.name}</b>ã€ç›®å‰é»æ•¸ï¼š<b>{result.points}</b></span>
                : <span>æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</span>)
            : <span className="text-slate-500">è«‹è¼¸å…¥è¦æŸ¥è©¢çš„å§“å/æš±ç¨±</span>}
        </div>
      </div>

      {/* å…¬é–‹æµæ°´ï¼šåƒ…é¡¯ç¤ºæŸ¥è©¢åˆ°çš„æ­¤äººæœ€è¿‘ 5 ç­† */}
<div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 mt-3">
  <div className="text-sm font-medium mb-2">æœ€è¿‘ 5 ç­†é»æ•¸ç•°å‹•ï¼ˆåƒ…æ­¤äººï¼‰</div>

{admin && result && (
  <div className="mt-2">
    <button
      className="rounded-lg border px-3 py-2 text-sm"
      onClick={()=> setShowAllLogs(true)}
      title="æ‰“é–‹æ­¤äººçš„å…¨éƒ¨é»æ•¸ç•°å‹•ç´€éŒ„"
    >
      æŸ¥çœ‹ã€Œ{result.name}ã€å…¨éƒ¨ç´€éŒ„
    </button>
  </div>
)}


  {!q.trim() ? (
    <div className="text-sm text-slate-500">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å§“å/æš±ç¨±é€²è¡ŒæŸ¥è©¢</div>
  ) : !result ? (
    <div className="text-sm text-slate-500">æ‰¾ä¸åˆ°ã€Œ{q}ã€çš„é»æ•¸ç´€éŒ„</div>
  ) : latest5.length === 0 ? (
    <div className="text-sm text-slate-500">ã€Œ{result.name}ã€ç›®å‰æ²’æœ‰ç•°å‹•ç´€éŒ„</div>
  ) : (
    <div className="grid gap-2">
      {latest5.map(l=>{
        const p = people.find(x=>x.id===l.personId);
        return (
          <div key={l.id} className="text-sm flex items-center justify-between">
            <div className="truncate">{p?.name || '(å·²åˆª)'}ï½œ{l.delta>0?`+${l.delta}`:l.delta}ï½œ{l.note||'ï¼ˆç„¡å‚™è¨»ï¼‰'}</div>
            <div className="text-xs text-slate-500">{l.at}</div>
          </div>
        );
      })}
    </div>
  )}
</div>


      {admin && (
        <>
          {/* æ–°å¢/æ›´æ–°äººå“¡ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="grid sm:grid-cols-2 gap-3">
              <input className="rounded-lg border px-3 py-2" value={draft.name} onChange={(e)=>setDraft(d=>({ ...d, name: e.target.value }))} placeholder="å§“å/æš±ç¨±"/>
              <input className="rounded-lg border px-3 py-2" value={draft.points} onChange={(e)=>setDraft(d=>({ ...d, points: e.target.value }))} placeholder="é»æ•¸ï¼ˆæ•´æ•¸ï¼‰"/>
            </div>
            <div className="flex justify-end">
              <button onClick={addOrUpdate} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢/æ›´æ–°</button>
            </div>
          </div>

          {/* ç®¡ç†ï¼šå…¨éƒ¨æµæ°´è¡¨ã€åŠ ä¸€ç­† / æ’¤éŠ· / åŒ¯å‡º */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 p-4 grid gap-3 mt-3">
            <div className="flex items-center justify-between">
              <div className="text-sm font-medium">å…¨éƒ¨ç•°å‹•</div>
              <div className="flex items-center gap-2">
  {q.trim() && (
    <button
      className="rounded-lg border px-3 py-1.5 text-sm"
      onClick={()=>setQ("")}
      title="æ¸…é™¤äººå“¡éæ¿¾"
    >
      æ¸…é™¤éæ¿¾
    </button>
  )}
  <button
    className="rounded-lg border px-3 py-1.5 text-sm"
    onClick={()=>{
      const rows = [['at','person','delta','note']];
      const list = personIdFilter ? logs.filter(l=>l.personId===personIdFilter) : logs;
      list.forEach(l=>{
        const p = people.find(x=>x.id===l.personId);
        rows.push([l.at, p?.name||'(å·²åˆª)', l.delta, l.note||'']);
      });
      exportCSV('points_logs.csv', rows);
    }}
  >
    åŒ¯å‡º CSV
  </button>
</div>

            </div>

            {/* âœ… æ–°å¢ä¸€ç­†ç•°å‹•ï¼šå¯è¼¸å…¥æˆ–ä¸‹æ‹‰é¸æ“‡ */}
            <div className="grid sm:grid-cols-3 gap-2">
              <div className="sm:col-span-1">
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  list="people-list"
                  placeholder="äººå“¡ï¼ˆå¯è¼¸å…¥æˆ–é¸æ“‡ï¼‰"
                  value={logDraft.name}
                  onChange={e=>setLogDraft(d=>({...d, name:e.target.value}))}
                />
                <datalist id="people-list">
                  {people.map(p => <option key={p.id} value={p.name} />)}
                </datalist>
              </div>
              <input className="rounded-lg border px-3 py-2" placeholder="ç•°å‹•ï¼ˆæ•´æ•¸ï¼Œå¯è² ï¼‰" value={logDraft.delta} onChange={e=>setLogDraft(d=>({...d,delta:e.target.value}))}/>
              <input className="rounded-lg border px-3 py-2 sm:col-span-1" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰" value={logDraft.note} onChange={e=>setLogDraft(d=>({...d,note:e.target.value}))}/>
              <div className="sm:col-span-3 flex justify-end">
                <button onClick={addLog} className="rounded-lg bg-brand text-white px-4 py-2">æ–°å¢ç•°å‹•</button>
              </div>
            </div>

            {/* è¡¨æ ¼ */}
            <div className="rounded-xl border overflow-hidden">
              <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
                <div className="col-span-3">æ™‚é–“</div>
                <div className="col-span-3">äººå“¡</div>
                <div className="col-span-2">ç•°å‹•</div>
                <div className="col-span-3">å‚™è¨»</div>
                <div className="col-span-1 text-right">æ“ä½œ</div>
              </div>
              {logs.length===0 && <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡ç•°å‹•</div>}
              {visibleLogs.map(l=>{

                const p = people.find(x=>x.id===l.personId);
                return (
                  <div key={l.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                    <div className="col-span-3 text-xs">{l.at}</div>
                    <div className="col-span-3">
  {p
    ? <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">{p.name}</button>
    : '(å·²åˆª)'}
</div>

                    <div className="col-span-2">{l.delta>0?`+${l.delta}`:l.delta}</div>
                    <div className="col-span-3 truncate">{l.note||''}</div>
                    <div className="col-span-1 flex justify-end">
                      <button onClick={()=>revokeLog(l.id)} className="rounded-lg border px-2 py-1 text-xs">æ’¤éŠ·</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* äººå“¡åˆ—è¡¨ */}
          <div className="rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mt-3">
            <div className="grid grid-cols-12 text-sm bg-slate-50 dark:bg-slate-800 px-4 py-2">
              <div className="col-span-6">å§“å/æš±ç¨±</div>
              <div className="col-span-3">é»æ•¸</div>
              <div className="col-span-3 text-right">æ“ä½œ</div>
            </div>
            {sorted.length === 0 && (
              <div className="px-4 py-3 text-sm text-slate-500">å°šç„¡äººå“¡é»æ•¸è³‡æ–™</div>
            )}
            {sorted.map(p => (
              <div key={p.id} className="grid grid-cols-12 items-center px-4 py-2 border-t border-slate-200 dark:border-slate-700">
                <div className="col-span-6">
  <button className="underline text-brand" onClick={()=>setQ(p.name)} title="åªçœ‹æ­¤äºº">
    {p.name}
  </button>
</div>

                <div className="col-span-3">{p.points}</div>
                <div className="col-span-3 flex justify-end gap-2">
                  <button onClick={()=>adjust(p.id, +1)} className="rounded-lg border px-3 py-1.5">+1</button>
                  <button onClick={()=>adjust(p.id, -1)} className="rounded-lg border px-3 py-1.5">-1</button>
                  <button onClick={()=>removePerson(p.id)} className="rounded-lg bg-red-500 text-white px-3 py-1.5">åˆªé™¤</button>
                </div>
              </div>
            ))}
          </div>
        </>
      )}
    </Section>
  );
}

function SettingsPanel({ data, setData, bg, setBg }) {
  const DEFAULTS = DEFAULT_SETTINGS;
  const s = (data && data.settings) ? data.settings : DEFAULTS;

  // è¡¨å–®æš«å­˜ï¼ˆæŠ½çåƒæ•¸ + å®˜æ–¹LINE/è¯çµ¡ç®¡ç†å“¡ + LINEç¾¤é€£çµï¼‰
  const [draft, setDraft] = React.useState({
    drawMaxPerRun:       s.drawMaxPerRun       ?? DEFAULTS.drawMaxPerRun,
    drawPublicShowLimit: s.drawPublicShowLimit ?? DEFAULTS.drawPublicShowLimit,
    drawCooldownSec:     s.drawCooldownSec     ?? DEFAULTS.drawCooldownSec,
    contactUrl:          s.contactUrl          ?? "",
    lineGroupUrl:        s.lineGroupUrl        ?? ""
  });

  // è®“å½ˆçª—/é¦–é å¯ç›´æ¥è®€åˆ°å…¨åŸŸé€£çµï¼ˆå•†å“æœªè¦†å¯«æ™‚ä½¿ç”¨ï¼‰
  React.useEffect(() => {
    window.__CONTACT_URL__ = (draft.contactUrl || s.contactUrl || "").trim();
    window.__LINE_GROUP_URL__ = (draft.lineGroupUrl || s.lineGroupUrl || "").trim();
  }, [draft.contactUrl, s.contactUrl, draft.lineGroupUrl, s.lineGroupUrl]);

  const onNum  = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));
  const onText = (key) => (e) => setDraft(d => ({ ...d, [key]: e.target.value }));

  const saveSettings = () => {
    const a = Math.max(1, parseInt(draft.drawMaxPerRun, 10)       || DEFAULTS.drawMaxPerRun);
    const b = Math.max(1, parseInt(draft.drawPublicShowLimit, 10) || DEFAULTS.drawPublicShowLimit);
    const c = Math.max(0, parseInt(draft.drawCooldownSec, 10)     || DEFAULTS.drawCooldownSec);
    const contact = String(draft.contactUrl || "").trim();
    const group  = String(draft.lineGroupUrl || "").trim();

    const nextSettings = {
      drawMaxPerRun: a,
      drawPublicShowLimit: b,
      drawCooldownSec: c,
      contactUrl: contact,
      lineGroupUrl: group
    };

    setData(prev => {
      const prevObj = (prev && typeof prev === "object") ? prev : {};
      return { ...prevObj, settings: nextSettings };
    });
    window.__CONTACT_URL__ = contact;
    window.__LINE_GROUP_URL__ = group;
    alert("å·²æ›´æ–°ç³»çµ±è¨­å®š");
  };

  const HasImageInput = (typeof ImageInput === "function");

  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­ç½®" subtitle="æŠ½çåƒæ•¸ + è¯çµ¡ç®¡ç†å“¡é€£çµ + èƒŒæ™¯ç®¡ç†ï¼ˆä¸»ç•«é¢/æ¼¢å ¡é¸å–®ï¼‰">
      {/* æŠ½çæ¨¡æ“¬å™¨åƒæ•¸ */}
      <div className="grid sm:grid-cols-3 gap-3">
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æŠ½çå–®æ¬¡åé¡ä¸Šé™</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawMaxPerRun} onChange={onNum("drawMaxPerRun")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">å…¬é–‹çµæœé¡¯ç¤ºç­†æ•¸ä¸Šé™</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="1"
            value={draft.drawPublicShowLimit} onChange={onNum("drawPublicShowLimit")} />
        </div>
        <div className="grid gap-1">
          <label className="text-sm text-slate-500">æ¨¡æ“¬é‡è·‘å†·å»ï¼ˆç§’ï¼‰</label>
          <input className="rounded-lg border px-3 py-2" type="number" min="0"
            value={draft.drawCooldownSec} onChange={onNum("drawCooldownSec")} />
        </div>
      </div>

      {/* è¯çµ¡ç®¡ç†å“¡ï¼ˆå…¨åŸŸå¤–éƒ¨é€£çµï¼‰ */}
      <div className="mt-4 grid gap-1">
        <label className="text-sm text-slate-500">è¯çµ¡ç®¡ç†å“¡Â·å¤–éƒ¨é€£çµï¼ˆå¯ç©ºï¼‰</label>
        <input
          className="rounded-lg border px-3 py-2 w-full"
          placeholder="https://..."
          value={draft.contactUrl}
          onChange={onText("contactUrl")}
        />
        <div className="text-xs text-slate-500">å•†å“æœªè‡ªè¨‚æ™‚ï¼Œå½ˆçª—çš„ã€Œè¯çµ¡ç®¡ç†å“¡ã€æŒ‰éˆ•å°‡ä½¿ç”¨æ­¤é€£çµã€‚</div>
      </div>

      {/* åŠ å…¥LINEç¾¤ï¼ˆå…¨åŸŸå¤–éƒ¨é€£çµï¼‰ */}
      <div className="mt-4 grid gap-1">
        <label className="text-sm text-slate-500">åŠ å…¥LINEç¾¤Â·å¤–éƒ¨é€£çµï¼ˆå¯ç©ºï¼‰</label>
        <input
          className="rounded-lg border px-3 py-2 w-full"
          placeholder="https://..."
          value={draft.lineGroupUrl}
          onChange={onText("lineGroupUrl")}
        />
        <div className="text-xs text-slate-500">é¦–é çš„ã€ŒåŠ å…¥LINEç¾¤ã€æŒ‰éˆ•å°‡ä½¿ç”¨æ­¤é€£çµã€‚</div>
      </div>

      {/* èƒŒæ™¯ç®¡ç†ï¼ˆä¸»ç•«é¢ / æ¼¢å ¡é¸å–®ï¼‰ */}
      <div className="mt-6 grid md:grid-cols-2 gap-6">
        {/* ä¸»ç•«é¢èƒŒæ™¯ */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">ğŸ¨ ä¸»ç•«é¢èƒŒæ™¯</div>

          {HasImageInput ? (
            <ImageInput
              label="èƒŒæ™¯åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰"
              value={bg.url || ""}
              onChange={(url) => setBg({ ...bg, url })}
            />
          ) : (
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">èƒŒæ™¯åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
              <input
                className="rounded-lg border px-3 py-2 w-full"
                placeholder="https://..."
                value={bg.url || ""}
                onChange={e=>setBg({ ...bg, url: e.target.value })}
              />
            </div>
          )}

          <div className="grid sm:grid-cols-2 gap-3 mt-3">
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">äº®åº¦ {bg.brightness ?? 1}</label>
              <input type="range" min="0.2" max="2" step="0.05"
                value={bg.brightness ?? 1}
                onChange={e=>setBg({ ...bg, brightness: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">éœ§åŒ–ï¼ˆpxï¼‰ {bg.blur ?? 0}</label>
              <input type="range" min="0" max="16" step="1"
                value={bg.blur ?? 0}
                onChange={e=>setBg({ ...bg, blur: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">é€æ˜åº¦ {bg.opacity ?? 1}</label>
              <input type="range" min="0" max="1" step="0.05"
                value={bg.opacity ?? 1}
                onChange={e=>setBg({ ...bg, opacity: Number(e.target.value) })}
              />
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">ä½ç½®</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.pos || "center"}
                onChange={e=>setBg({ ...bg, pos: e.target.value })}
              >
                <option value="center">center</option>
                <option value="top">top</option>
                <option value="bottom">bottom</option>
                <option value="left">left</option>
                <option value="right">right</option>
                <option value="top left">top left</option>
                <option value="top right">top right</option>
                <option value="bottom left">bottom left</option>
                <option value="bottom right">bottom right</option>
              </select>
            </div>
            <div className="grid gap-1">
              <label className="text-sm text-slate-500">å°ºå¯¸</label>
              <select className="rounded-lg border px-3 py-2"
                value={bg.size || "cover"}
                onChange={e=>setBg({ ...bg, size: e.target.value })}
              >
                <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                <option value="auto">auto</option>
              </select>
            </div>
          </div>

          <div className="mt-2">
            <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼‰</label>
            <input
              className="rounded-lg border px-3 py-2 w-full"
              placeholder="ä¾‹å¦‚ï¼šrgba(0,0,0,0.25)"
              value={bg.tint || ""}
              onChange={e=>setBg({ ...bg, tint: e.target.value })}
            />
          </div>
        </div>

        {/* æ¼¢å ¡é¸å–®èƒŒæ™¯ */}
        <div className="rounded-xl border p-4">
          <div className="font-medium mb-2">ğŸ“‚ æ¼¢å ¡é¸å–®èƒŒæ™¯</div>

          <label className="inline-flex items-center gap-2 text-sm">
            <input type="checkbox"
              checked={!!bg.menuUseMain}
              onChange={e=>setBg({ ...bg, menuUseMain: e.target.checked })}
            />
            <span>æ²¿ç”¨ä¸»ç•«é¢è¨­å®š</span>
          </label>

          {!bg.menuUseMain && (
            <>
              {HasImageInput ? (
                <ImageInput
                  label="é¸å–®èƒŒæ™¯åœ–ç‰‡ï¼ˆå¯ç©ºï¼‰"
                  value={bg.menuUrl || ""}
                  onChange={(url) => setBg({ ...bg, menuUrl: url })}
                />
              ) : (
                <div className="grid gap-1 mt-2">
                  <label className="text-sm text-slate-500">é¸å–®èƒŒæ™¯åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
                  <input
                    className="rounded-lg border px-3 py-2 w-full"
                    placeholder="https://..."
                    value={bg.menuUrl || ""}
                    onChange={e=>setBg({ ...bg, menuUrl: e.target.value })}
                  />
                </div>
              )}

              <div className="grid sm:grid-cols-2 gap-3 mt-3">
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">äº®åº¦ {bg.menuBrightness ?? 1}</label>
                  <input type="range" min="0.2" max="2" step="0.05"
                    value={bg.menuBrightness ?? 1}
                    onChange={e=>setBg({ ...bg, menuBrightness: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">éœ§åŒ–ï¼ˆpxï¼‰ {bg.menuBlur ?? 0}</label>
                  <input type="range" min="0" max="16" step="1"
                    value={bg.menuBlur ?? 0}
                    onChange={e=>setBg({ ...bg, menuBlur: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">é€æ˜åº¦ {bg.menuOpacity ?? 1}</label>
                  <input type="range" min="0" max="1" step="0.05"
                    value={bg.menuOpacity ?? 1}
                    onChange={e=>setBg({ ...bg, menuOpacity: Number(e.target.value) })}
                  />
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">ä½ç½®</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuPos || "center"}
                    onChange={e=>setBg({ ...bg, menuPos: e.target.value })}
                  >
                    <option value="center">center</option>
                    <option value="top">top</option>
                    <option value="bottom">bottom</option>
                    <option value="left">left</option>
                    <option value="right">right</option>
                    <option value="top left">top left</option>
                    <option value="top right">top right</option>
                    <option value="bottom left">bottom left</option>
                    <option value="bottom right">bottom right</option>
                  </select>
                </div>
                <div className="grid gap-1">
                  <label className="text-sm text-slate-500">å°ºå¯¸</label>
                  <select className="rounded-lg border px-3 py-2"
                    value={bg.menuSize || "cover"}
                    onChange={e=>setBg({ ...bg, menuSize: e.target.value })}
                  >
                    <option value="cover">coverï¼ˆæ»¿ç‰ˆï¼‰</option>
                    <option value="contain">containï¼ˆç­‰æ¯”å®Œæ•´ï¼‰</option>
                    <option value="auto">auto</option>
                  </select>
                </div>
              </div>

              <div className="mt-2">
                <label className="block text-sm mb-1">è‰²å½©è¦†è“‹ï¼ˆTintï¼‰</label>
                <input
                  className="rounded-lg border px-3 py-2 w-full"
                  placeholder="ä¾‹å¦‚ï¼šrgba(0,0,0,0.25)"
                  value={bg.menuTint || ""}
                  onChange={e=>setBg({ ...bg, menuTint: e.target.value })}
                />
              </div>
            </>
          )}
        </div>
      </div>

      {/* å¿«é€Ÿé¢¨æ ¼ï¼ˆå¯é¸ï¼‰ */}
      <div className="mt-6 flex flex-wrap gap-2">
        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.20)", brightness:1.0, blur:2, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…çˆ½</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(255,255,255,0.35)", brightness:0.95, blur:6, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æŸ”éœ§</button>

        <button
          onClick={()=>setBg({
            ...bg,
            tint:"rgba(0,0,0,0.35)", brightness:1.1, blur:0, opacity:1,
            menuUseMain:true
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æš—åº•</button>

        <button
          onClick={()=>setBg({
            url:"", tint:"rgba(255,255,255,0.0)", brightness:1, blur:0, opacity:1,
            size:"cover", pos:"center",
            menuUseMain:true, menuUrl:"", menuTint:"rgba(255,255,255,0.0)",
            menuBrightness:1, menuBlur:0, menuOpacity:1, menuSize:"cover", menuPos:"center"
          })}
          className="rounded-lg border px-3 py-1.5 text-sm"
        >æ¸…é™¤èƒŒæ™¯</button>
      </div>

      {/* å„²å­˜ï¼ˆåªå¯«æŠ½çåƒæ•¸èˆ‡è¯çµ¡é€£çµï¼›èƒŒæ™¯é€é setBg å³æ™‚ç”Ÿæ•ˆ/å¦æœ‰æœ¬åœ°å„²å­˜ï¼‰ */}
      <div className="mt-6 flex justify-end">
        <button onClick={saveSettings} className="rounded-lg bg-brand text-white px-4 py-2">å„²å­˜ç³»çµ±è¨­å®š</button>
      </div>
    </Section>
  );
}

function SystemSettings({ data, setData, bg, setBg, admins, setAdmins, currentAdmin, setCurrentAdmin }) {
  return (
    <Section title="âš™ï¸ ç³»çµ±è¨­ç½®" subtitle="é›†ä¸­ç®¡ç†æ‰€æœ‰è¨­å®šé …ç›®ã€‚">
      {/* ä½ åŸæœ¬ä½¿ç”¨çš„ SettingsPanel å®Œæ•´æ¬åˆ°é€™è£¡å‘ˆç¾ */}
      <SettingsPanel data={data} setData={setData} bg={bg} setBg={setBg} />

{/* === ç®¡ç†è€…æ¸…å–®ï¼ˆæœ¬åœ°ï¼‰=== */}
<Section id="admin-list-panel" title="ğŸ‘¤ ç®¡ç†è€…æ¸…å–®" subtitle="æ–°å¢ï¼åˆªé™¤ï¼æ”¹åï¼æ”¹å¯†ç¢¼ï¼ˆè³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿï¼‰ã€‚">
  <div className="grid gap-3">
    {/* åˆ—è¡¨ */}
    <div className="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 dark:bg-slate-800/50">
          <tr>
            <th className="text-left px-3 py-2">åç¨±</th>
            <th className="text-left px-3 py-2">å¯†ç¢¼ç‹€æ…‹</th>
            <th className="text-right px-3 py-2">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {admins.map((a, idx)=>(
            <tr key={idx} className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-2">{a.name}</td>
              <td className="px-3 py-2">{a.passwordHash ? 'å·²è¨­å®š' : 'å°šæœªè¨­å®š'}</td>
              <td className="px-3 py-2">
                <div className="flex justify-end gap-2">
                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const newName = prompt('è¼¸å…¥æ–°åç¨±', a.name) || '';
                      const trimmed = newName.trim();
                      if(!trimmed){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
                      if(trimmed !== a.name && admins.some(x=>x.name === trimmed)){
                        alert('åç¨±å·²å­˜åœ¨'); return;
                      }
                      const next = admins.map(x => x.name === a.name ? ({ ...x, name: trimmed }) : x);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(trimmed); }
                      alert('åç¨±å·²æ›´æ–°');
                    }}
                  >æ”¹å</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={async ()=>{
                      const pwd = prompt('è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
                      if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
                      const hash = await hashTextSHA256(pwd);
                      const next = admins.map(x => x.name === a.name ? ({ ...x, passwordHash: hash }) : x);
                      setAdmins(next);
                      alert('å¯†ç¢¼å·²æ›´æ–°');
                    }}
                  >æ”¹å¯†ç¢¼</button>

                  <button
                    className="rounded-lg border px-2 py-1"
                    onClick={()=>{
                      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ç®¡ç†è€…ã€Œ${a.name}ã€ï¼Ÿ`)) return;
                      const next = admins.filter(x => x.name !== a.name);
                      setAdmins(next);
                      if(currentAdmin === a.name){ setCurrentAdmin(''); setAdminMode(false); }
                      alert('å·²åˆªé™¤');
                    }}
                  >åˆªé™¤</button>
                </div>
              </td>
            </tr>
          ))}
          {admins.length === 0 && (
            <tr className="border-t border-slate-200 dark:border-slate-700">
              <td className="px-3 py-6 text-center text-slate-500" colSpan={3}>ç›®å‰æ²’æœ‰ç®¡ç†è€…</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>

    {/* æ–°å¢ */}
    <div className="flex gap-2">
      <button
        className="rounded-lg border px-3 py-1.5"
        onClick={async ()=>{
          const name = prompt('è¼¸å…¥æ–°ç®¡ç†è€…åç¨±') || '';
          const n = name.trim();
          if(!n){ alert('åç¨±ä¸å¯ç‚ºç©º'); return; }
          if(admins.some(a => a.name === n)){ alert('åç¨±å·²å­˜åœ¨'); return; }
          const pwd = prompt('è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 4 ç¢¼ï¼‰') || '';
          if(pwd.length < 4){ alert('å¯†ç¢¼å¤ªçŸ­'); return; }
          const hash = await hashTextSHA256(pwd);
          setAdmins([...admins, { name: n, passwordHash: hash }]);
          alert('å·²æ–°å¢ç®¡ç†è€…');
        }}
      >æ–°å¢ç®¡ç†è€…</button>
    </div>
  </div>
</Section>
     
 {/* å¦‚æœªä¾†è¦æ“´å……æ›´å¤šè¨­å®šï¼Œå¯åœ¨æ­¤ç¹¼çºŒåˆ†æ®µ */}
      {/* ä¾‹ï¼šç¶²ç«™è³‡è¨Š / æ¬Šé™ / å‚™ä»½å·¥å…· / ä¸»é¡Œé¢¨æ ¼ ç­‰ */}
    </Section>
  );
}

function ImageInput({ label="åœ–ç‰‡", value="", onChange }) {
  const [mode, setMode] = React.useState(value && /^https?:\/\//i.test(value) ? 'url' : (value ? 'data' : 'url'));
  const fileRef = React.useRef(null);

  const pickFile = ()=> fileRef.current?.click();
  const onFile = async (f)=>{
    if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=> onChange?.(String(e.target?.result||""));
    reader.readAsDataURL(f);
  };

  return (
    <div className="grid gap-1.5">
      <label className="text-sm text-slate-600 dark:text-slate-300">{label}</label>
      <div className="flex items-center gap-2">
        <button
          type="button"
          onClick={()=>setMode('url')}
          className={`px-2 py-1 rounded border text-xs ${mode==='url'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >ç¶²å€</button>
        <button
          type="button"
          onClick={()=>setMode('data')}
          className={`px-2 py-1 rounded border text-xs ${mode==='data'?'bg-brand text-white border-brand':'border-slate-300 dark:border-slate-600'}`}
        >æœ¬æ©Ÿæª”æ¡ˆ</button>
      </div>

      {mode==='url' ? (
        <input
          className="rounded-lg border px-3 py-2"
          value={value}
          onChange={e=>onChange?.(e.target.value)}
          placeholder="https://... æˆ–ç›´æ¥è²¼ä¸Šç¶²å€"
        />
      ) : (
        <>
          <div className="flex items-center gap-2">
            <button type="button" onClick={pickFile} className="rounded-lg border px-3 py-2 text-sm">é¸æ“‡æª”æ¡ˆ</button>
            <span className="text-xs text-slate-500">ï¼ˆå°‡è®€ç‚º base64ï¼Œé›¢ç·šä¹Ÿå¯é¡¯ç¤ºï¼‰</span>
          </div>
          <input
            ref={fileRef}
            type="file"
            accept="image/*"
            className="hidden"
            onChange={e=>onFile(e.target.files?.[0]||null)}
          />
        </>
      )}

      {value && (
        <div className="mt-2">
          <img src={value} alt="" className="max-h-40 rounded border bg-slate-50 dark:bg-slate-800 object-contain"/>
        </div>
      )}
    </div>
  );
}

function ShopImageQuickset({ data, setData, admin }) {
  if (!admin) return null; // åªçµ¦ç®¡ç†æ¨¡å¼ç”¨

  // ç›®å‰å•†å“æ¸…å–®
  const items = Array.isArray(data?.shop?.items) ? data.shop.items : [];

  // â€”â€” ç›¸å®¹ï¼šæŠŠèˆŠçš„å–®å¼µ image è½‰ç‚º images é™£åˆ—ï¼ˆä¸è¦†è“‹åŸæ¬„ä½ï¼Œåªè£œä¸Šï¼‰â€”â€”
  const ensureImagesArr = (it) => {
    const nx = { ...it };
    if (!Array.isArray(nx.images)) {
      const one = String(nx.image || "").trim();
      nx.images = one ? [one] : [];
    }
    return nx;
  };

  // è‰ç¨¿ï¼šä»¥ image æ¬„ä½ç‚ºæº–ï¼ˆä½ åŸæœ¬çš„è¡Œç‚ºä¿ç•™ï¼‰
  const [drafts, setDrafts] = React.useState(() =>
    items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    }))
  );

  // è‹¥å¤–éƒ¨ items æ”¹è®Šï¼Œè‰ç¨¿åŒæ­¥ä¸€æ¬¡ï¼ˆä½ åŸæœ¬çš„è¡Œç‚ºä¿ç•™ï¼‰
  React.useEffect(() => {
    setDrafts(items.map(it => ({
      id: it.id || nid(),
      name: it.name || '',
      image: it.image || ''
    })));
  }, [items]);

  // æ­£è¦åŒ–ï¼šå»é ­å°¾å¼•è™Ÿèˆ‡ç©ºç™½ï¼ˆåªæä¾›çµ¦ã€Œæª”åè‡ªå‹•è£œè³‡æ–™å¤¾ã€æŒ‰éˆ•ç”¨ï¼›saveAll ä¸ç”¨å®ƒï¼‰
  const normPath = (s) => String(s || '').trim().replace(/^"+|"+$/g, '');

  // å„²å­˜ï¼šæŠŠè‰ç¨¿å¯«å› data.shop.items[i].imageï¼ˆâ˜… åŸæ¨£ä¿å­˜ï¼Œä¸åŠ å·¥ï¼‰
  const saveAll = () => {
    const next = items.map((it, i) => {
      const image = drafts[i]?.image ?? '';   // ä¸åšä»»ä½•è™•ç†ï¼ŒåŸæ¨£å­—ä¸²
      return { ...it, image };                // â† ä¿®æ­£ ...it
    });
    setData({
      ...data,                                // â† ä¿®æ­£ ...data
      shop: { ...(data.shop || {}), items: next }  // â† ä¿®æ­£ ...(data.shop || {})
    });
    alert('å·²å„²å­˜åœ–ç‰‡è·¯å¾‘åˆ°å•†å“ã€‚ä¹‹å¾Œã€ŒåŒ¯å‡ºã€å³å¯æŠŠè·¯å¾‘å¸¶å‡ºã€‚');
  };

  // è‹¥åªè²¼ã€Œæª”å.jpgã€æ²’æœ‰è³‡æ–™å¤¾ï¼Œè‡ªå‹•è£œ ./assets/products/ï¼ˆâ˜… åƒ…åœ¨ä½ æŒ‰é€™é¡†éˆ•æ™‚æ‰æœƒè®Šå‹•ï¼‰
  const applyBaseToEmpty = () => {
    const base = './assets/products/';
    setDrafts(ds => ds.map(d => {
      const v = normPath(d.image);
      if (!v) return d;
      if (!v.includes('/')) return { ...d, image: base + v }; // â† ä¿®æ­£ ...d
      return d;
    }));
  };

  // ====== ä»¥ä¸‹æ˜¯ã€Œå¤šåœ–ç®¡ç†ã€æ–°å¢åŠŸèƒ½ï¼ˆä¸å½±éŸ¿ä¸Šé¢æ—¢æœ‰æµç¨‹ï¼‰ ======

  // å–®å¼µæ–°å¢åˆ° images[]
  const addOneImage = (id, url) => {
    const u = String(url || "").trim();
    if (!u) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      if (!nx.images.includes(u)) {
        nx.images = [...nx.images, u];
        if (!nx.image) nx.image = u;          // æ²’å°é¢æ™‚è£œä¸Š
      }
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // å¤šå¼µæ‰¹é‡ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰
  const addMultiImages = (id, text) => {
    const lines = String(text || "")
      .split(/\r?\n/)
      .map((s) => s.trim())
      .filter(Boolean);
    if (lines.length === 0) return;
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const set = new Set(nx.images);
      for (const l of lines) set.add(l);
      nx.images = Array.from(set);
      if (!nx.image && nx.images.length > 0) nx.image = nx.images[0]; // æ²’å°é¢â†’ç¬¬ä¸€å¼µ
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  // åˆªé™¤æŸå¼µåœ–ç‰‡ï¼ˆä¸¦å›é€€å°é¢ç‚ºæ–°ç¬¬ä¸€å¼µï¼‰
  const removeImageAt = (id, idx) => {
    const base = data.shop?.items || [];
    const next = base.map((it) => {
      if ((it.id || "") !== id) return it;
      const nx = ensureImagesArr(it);
      const arr = [...nx.images];
      if (idx < 0 || idx >= arr.length) return it;
      arr.splice(idx, 1);
      nx.images = arr;
      nx.image = arr[0] || ""; // å°é¢å›é€€
      return { ...nx };
    });
    setData({ ...data, shop: { ...data.shop, items: next } });
  };

  return (
    <section
      className="mt-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4"
      aria-label="å•†å“åœ–ç‰‡è·¯å¾‘å¿«é€Ÿè¨­å®šï¼‹å¤šåœ–ç®¡ç†"
    >
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-base font-semibold">ğŸ–¼ï¸ å•†å“åœ–ç‰‡ç®¡ç†ï¼ˆä¿ç•™èˆŠåŠŸèƒ½ï¼‹æ–°å¢å¤šåœ–ï¼‰</h3>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={applyBaseToEmpty}
            className="rounded-lg border px-3 py-1.5 text-sm"
            title="è‹¥è¼¸å…¥åƒ…æª”åï¼Œå¹«ä½ è‡ªå‹•åŠ ä¸Š ./assets/products/"
          >
            æª”åè‡ªå‹•è£œè³‡æ–™å¤¾
          </button>
          <button
            type="button"
            onClick={saveAll}
            className="rounded-lg bg-brand text-white px-3 py-1.5 text-sm"
            title="æŠŠè¼¸å…¥çš„è·¯å¾‘å¯«å› data.shop.items"
          >
            å„²å­˜å…¨éƒ¨ï¼ˆå°é¢ imageï¼‰
          </button>
        </div>
      </div>

      {items.length === 0 ? (
        <div className="text-sm text-slate-500">ç›®å‰æ²’æœ‰å•†å“å¯è¨­å®šåœ–ç‰‡ã€‚</div>
      ) : (
        <div className="grid gap-4">
          {items.map((raw, i) => {
            const it = ensureImagesArr({ ...raw });
            const d  = drafts[i] || { id: it.id, name: it.name || '', image: it.image || '' };
            return (
              <div key={it.id || i} className="rounded-xl border border-slate-200 dark:border-slate-700 p-3">
                {/* æ¨™é¡Œåˆ— */}
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm">
                    <div className="font-medium truncate">{it.name || 'ï¼ˆæœªå‘½åï¼‰'}</div>
                    {it.id && <div className="text-xs text-slate-500">IDï¼š{it.id}</div>}
                  </div>
                  <div className="text-xs text-slate-500">{(it.images || []).length} å¼µ</div>
                </div>

                {/* ä½ åŸæœ¬çš„ï¼šå–®ä¸€å°é¢ image è¼¸å…¥ï¼ˆä¿ç•™ï¼‰ */}
                <div className="grid sm:grid-cols-2 gap-2 items-center mb-3">
                  <label className="text-xs text-slate-500 sm:col-span-1">å°é¢ imageï¼ˆå–®ä¸€å­—ä¸²ï¼‰</label>
                  <input
                    className="rounded-lg border px-3 py-2 text-sm sm:col-span-1"
                    placeholder="è²¼ä¸Šå°é¢åœ–ç‰‡è·¯å¾‘æˆ–å®Œæ•´ç¶²å€"
                    value={d.image}
                    onChange={e => {
                      const v = e.target.value;
                      setDrafts(ds => ds.map((x, j) => (j === i ? { ...x, image: v } : x)));
                    }}
                  />
                </div>

                {/* æ–°å¢ï¼šå¤šåœ–ç¸®åœ–æ¸…å–®ï¼ˆç®¡ç†å¯åˆªå–®å¼µï¼‰ */}
                <div>
                  <div className="text-xs text-slate-500 mb-1">æ›´å¤šåœ–ç‰‡ï¼ˆimages[]ï¼‰</div>
                  <div className="no-scrollbar overflow-x-auto flex gap-2 mb-2">
                    {(it.images || []).length === 0 ? (
                      <div className="text-xs text-slate-500">å°šç„¡å…¶ä»–åœ–ç‰‡</div>
                    ) : (
                      it.images.map((src, k) => (
                        <div key={k} className="relative shrink-0">
                          <img
                            src={src}
                            alt={`åœ–${k + 1}`}
                            className="w-28 h-28 object-cover rounded-lg border border-slate-200/70 dark:border-slate-700/70"
                            loading="lazy"
                          />
                          <button
                            className="absolute -top-2 -right-2 bg-rose-600 text-white w-6 h-6 rounded-full text-xs"
                            title="åˆªé™¤æ­¤åœ–"
                            onClick={() => removeImageAt(it.id, k)}
                          >
                            Ã—
                          </button>
                        </div>
                      ))
                    )}
                  </div>

                  {/* å–®å¼µæ–°å¢ */}
                  <div className="flex gap-2 items-center mb-2">
                    <input
                      type="url"
                      placeholder="è²¼ä¸Šå–®å¼µåœ–ç‰‡ç¶²å€..."
                      className="flex-1 rounded-lg border px-3 py-1.5 text-sm bg-white/80 dark:bg-slate-800/70"
                      onKeyDown={(e) => {
                        if (e.key === "Enter") {
                          addOneImage(it.id, e.currentTarget.value);
                          e.currentTarget.value = "";
                        }
                      }}
                    />
                    <button
                      className="rounded-lg border px-3 py-1.5 text-sm"
                      onClick={(e) => {
                        const input = e.currentTarget.previousElementSibling;
                        if (input && input.value) {
                          addOneImage(it.id, input.value);
                          input.value = "";
                        }
                      }}
                    >
                      æ–°å¢
                    </button>
                  </div>

                  {/* å¤šå¼µæ‰¹é‡è²¼ä¸Šï¼ˆæ¯è¡Œä¸€å¼µï¼›è²¼ä¸Šå³åŒ¯å…¥ä¸¦æ¸…ç©ºï¼‰ */}
                  <div className="grid gap-2">
                    <label className="text-xs text-slate-500">æ‰¹é‡è²¼ä¸Šï¼ˆæ¯è¡Œä¸€å€‹åœ–ç‰‡ç¶²å€ï¼‰</label>
                    <textarea
                      rows={3}
                      placeholder="https://...1.jpg
https://...2.png"
                      className="rounded-lg border px-3 py-2 text-sm bg-white/80 dark:bg-slate-800/70"
                      onPaste={(e) => {
                        setTimeout(() => {
                          const v = e.currentTarget.value;
                          if (v && v.trim()) {
                            addMultiImages(it.id, v);
                            e.currentTarget.value = "";
                          }
                        }, 0);
                      }}
                    />
                    <div className="text-xs text-slate-500">
                      è²¼ä¸Šå¾Œæœƒè‡ªå‹•åŒ¯å…¥ä¸¦æ¸…ç©ºè¼¸å…¥æ¡†ï¼›é‡è¤‡ç¶²å€æœƒè‡ªå‹•ç•¥éã€‚
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <p className="mt-3 text-xs text-slate-500">
        å°æé†’ï¼šæŠŠåœ–ç‰‡æ”¾é€² <code>assets/products/</code> å¾Œï¼Œå¯ä»¥åªè²¼
        <code> æª”å.jpg</code>ï¼Œå†æŒ‰ã€Œæª”åè‡ªå‹•è£œè³‡æ–™å¤¾ã€ã€‚æˆ–ç›´æ¥è²¼ç›¸å°è·¯å¾‘ <code>./assets/products/æª”å.jpg</code>ï¼Œ
        ä¹Ÿæ”¯æ´å®Œæ•´ç¶²å€ <code>https://...</code>ã€‚<br/>
        å¤šåœ–å€æœƒå³æ™‚æ›´æ–° <code>images[]</code> èˆ‡å°é¢ <code>image</code>ï¼ˆåˆªé™¤æ™‚å°é¢è‡ªå‹•å›é€€ï¼‰ã€‚
      </p>
    </section>
  );
}

// ===== é€šç”¨ç‡ˆç®±ï¼ˆå¿…è¦åŠŸèƒ½ç‰ˆï¼‰ =====
function LightboxRoot() {
  const [open, setOpen] = React.useState(false);
  const [imgs, setImgs] = React.useState([]);
  const [idx, setIdx]   = React.useState(0);
  const originRef = React.useRef(null);

  // å½±åƒå¹³ç§»/ç¸®æ”¾ï¼ˆç°¡ç‰ˆï¼‰
  const [scale, setScale] = React.useState(1);
  const [tx, setTx] = React.useState(0);
  const [ty, setTy] = React.useState(0);
  const last = React.useRef({ x:0, y:0, p1:null, p2:null, dist:0 });

  // é–‹å•Ÿ APIï¼ˆå…¨åŸŸï¼‰
  React.useEffect(()=>{
    window.__LB__ = {
      openFrom(el){
        // å¾€ä¸Šæ‰¾ data-gallery
        const node = el.closest("[data-gallery]");
        if(!node) return;
        const group = node.getAttribute("data-gallery");
        const all = Array.from(document.querySelectorAll(`[data-zoomable][data-gallery="${group}"]`));
        const sources = all.map(n => n.getAttribute("src"));
        const start = Number(el.getAttribute("data-index") || "0");
        originRef.current = el;
        setImgs(sources);
        setIdx(Math.max(0, Math.min(start, sources.length-1)));
        setScale(1); setTx(0); setTy(0);
        setOpen(true);
      }
    };
  },[]);

  // éµç›¤æ§åˆ¶ï¼ˆESC/å·¦å³éµï¼‰
  React.useEffect(()=>{
    if(!open) return;
    const onKey = (e)=>{
      if(e.key === "Escape"){ e.preventDefault(); close(); }
      else if(e.key === "ArrowLeft"){ setIdx(i=>Math.max(0, i-1)); resetTransform(); }
      else if(e.key === "ArrowRight"){ setIdx(i=>Math.min(imgs.length-1, i+1)); resetTransform(); }
    };
    window.addEventListener("keydown", onKey);
    return ()=>window.removeEventListener("keydown", onKey);
  },[open, imgs.length]);

  function resetTransform(){ setScale(1); setTx(0); setTy(0); }

  function close(){
    setOpen(false);
    // ç„¦é»å›åˆ°åŸåœ–
    setTimeout(()=>{ originRef.current?.focus?.(); }, 0);
  }

  // æ»‘é¼ æ‹–æ›³ / è§¸æ§ç¸®æ”¾
  function onPointerDown(e){
    e.preventDefault();
    e.currentTarget.setPointerCapture(e.pointerId);
    if(last.current.p1 && !last.current.p2) last.current.p2 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    if(!last.current.p1) last.current.p1 = { id:e.pointerId, x:e.clientX, y:e.clientY };
    last.current.x = e.clientX; last.current.y = e.clientY;
    if(last.current.p1 && last.current.p2){
      const dx = last.current.p1.x - last.current.p2.x;
      const dy = last.current.p1.y - last.current.p2.y;
      last.current.dist = Math.hypot(dx, dy) || 1;
    }
  }
  function onPointerMove(e){
    if(!open) return;
    if(last.current.p1 && last.current.p2){
      // é›™æŒ‡ç¸®æ”¾
      const p = (p)=>p?.id===e.pointerId ? { id:e.pointerId, x:e.clientX, y:e.clientY } : p;
      last.current.p1 = p(last.current.p1);
      last.current.p2 = p(last.current.p2);
      const dx = (last.current.p1.x - last.current.p2.x);
      const dy = (last.current.p1.y - last.current.p2.y);
      const d  = Math.hypot(dx, dy) || 1;
      const s  = Math.min(4, Math.max(1, scale * (d / (last.current.dist || d))));
      setScale(s);
      last.current.dist = d;
    }else{
      // å–®æŒ‡/æ»‘é¼ æ‹–æ›³
      const dx = e.clientX - last.current.x;
      const dy = e.clientY - last.current.y;
      setTx(t=>t+dx); setTy(t=>t+dy);
      last.current.x = e.clientX; last.current.y = e.clientY;
    }
  }
  function onPointerUp(e){
    if(last.current.p2?.id===e.pointerId) last.current.p2=null;
    else if(last.current.p1?.id===e.pointerId) last.current.p1=null;
  }
   function onDblClick(){ setScale(s => s>1 ? 1 : 2); setTx(0); setTy(0); }

  if(!open) return null;
  return (
    <div className="fixed inset-0 z-[9999] bg-black/90 backdrop-blur-sm flex flex-col" role="dialog" aria-modal="true">
      <div className="flex items-center justify-between px-3 py-2">
        <div className="text-slate-200 text-sm">{idx+1} / {imgs.length}</div>
        <div className="flex items-center gap-2">
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.max(0,i-1)); resetTransform(); }} disabled={idx<=0}>â†</button>
          <button className="rounded-md border border-white/30 text-white px-2 py-1 text-sm" onClick={()=>{ setIdx(i=>Math.min(imgs.length-1,i+1)); resetTransform(); }} disabled={idx>=imgs.length-1}>â†’</button>
          <button className="rounded-md bg-white text-black px-2 py-1 text-sm" onClick={close}>é—œé–‰</button>
        </div>
      </div>
      <div className="relative flex-1 overflow-hidden game-touch-lock touch-pan-y">
        <img
          src={imgs[idx]}
          alt=""
          className="absolute left-1/2 top-1/2 select-none"
          style={{
            transform:`translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`,
            maxWidth:"90vw", maxHeight:"75vh"
          }}
          onPointerDown={onPointerDown}
          onPointerMove={onPointerMove}
          onPointerUp={onPointerUp}
          onPointerCancel={onPointerUp}
          onDoubleClick={onDblClick}
          draggable={false}
        />
      </div>
    </div>
  );
}

/* =========================
   ğŸ® å°éŠæˆ²ç³»çµ±ï¼ˆç´”å¨›æ¨‚ï¼‰
   - ä¸ç™¼çã€ä¸é€£ç·šã€ä¸å›å‚³ã€ä¸é˜²åˆ·
   - æ‰‹æ©Ÿå„ªå…ˆï¼šé¿é–‹ header / åº•éƒ¨å°è¦½ / iOS safe-area
   ========================= */

function parseLinesToList(text){
  return String(text||"")
    .split(/[\r\n,]+/g)
    .map(s=>s.trim())
    .filter(Boolean);
}

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function envSafeBottom(){
  // åœ¨éƒ¨åˆ†ç€è¦½å™¨ç„¡æ³•ç›´æ¥è®€ env(safe-area-inset-bottom) çš„æ•¸å€¼æ™‚ï¼Œè‡³å°‘å›å‚³ 0
  // é€™è£¡ä¸»è¦ç”¨æ–¼è¨ˆç®—å¯ç”¨é«˜åº¦ï¼Œé¿å…è¢« iOS æ‰‹å‹¢æ¢/åº•éƒ¨å°è¦½é®æ“‹
  try{
    // æœ‰äº›ç’°å¢ƒæ”¯æ´ CSS env ä½† JS å–ä¸åˆ°ï¼›ä»¥è¦–è¦º/å¸ƒå±€ä¿å®ˆè™•ç†
    return 0;
  }catch(e){
    return 0;
  }
}


function useIsTouch(){
  const [touch, setTouch] = React.useState(false);
  React.useEffect(()=>{
    const ok = ('ontouchstart' in window) || (navigator.maxTouchPoints>0);
    setTouch(!!ok);
  },[]);
  return touch;
}

function GameShell({ title, subtitle, children, onReset }){
  return (
    <div className="px-4 pb-24 md:pb-6"
      data-game-shell="1"
      style={{
        paddingBottom: 'calc(var(--game-shell-bottom-pad, 96px) + var(--sab, env(safe-area-inset-bottom)) + var(--app-bottom-nav-h, 0px))',
        paddingLeft: 'calc(16px + var(--sal, env(safe-area-inset-left)))',
        paddingRight:'calc(16px + var(--sar, env(safe-area-inset-right)))',
        paddingTop: 'calc(0px + var(--sat, env(safe-area-inset-top)))',
      }}
    >
      <div className="max-w-5xl mx-auto">
        <div className="game-head flex items-start justify-between gap-3 mb-4">
          <div>
            <div className="text-lg font-semibold">{title}</div>
            {subtitle ? <div className="game-subtitle mt-1">{subtitle}</div> : null}
          </div>
          {typeof onReset==='function' ? (
            <button className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
              onClick={onReset}
              type="button"
            >é‡ç½®</button>
          ) : null}
        </div>

        {/* Stage wrapper: provides a consistent gesture surface and usable-height contract */}
        <div className="game-gesture-surface">
          {children}
        </div>
      </div>
    </div>
  );
}


/* ---------- GamesHubï¼ˆç©å®¶å…¥å£ï¼‰ ---------- */
function GamesHub({ data, setData }){
  const games = (data && data.games) ? data.games : {};
  const [active, setActive] = React.useState(null); // null | memory | mole | g2048 | luck | tetris
  // Immersive mode: mobile-first game screen (hide app chrome, maximize playfield)
  React.useEffect(()=>{
    const doc = document.documentElement;
    if(active!==null){
      doc.dataset.kjsGame = "1";
      // Override measured chrome heights (header/bottom nav) while hidden
      doc.style.setProperty('--app-header-h', '0px');
      doc.style.setProperty('--app-bottom-nav-h', '0px');
      // Prevent accidental scroll-jank during play
      document.body.classList.add('kjs-game-lock');
    }else{
      delete doc.dataset.kjsGame;
      document.body.classList.remove('kjs-game-lock');
      // Trigger a re-measure on next frame
      requestAnimationFrame(()=>window.dispatchEvent(new Event('resize')));
    }
    return ()=>{
      delete doc.dataset.kjsGame;
      document.body.classList.remove('kjs-game-lock');
    };
  }, [active]);


  React.useEffect(()=>{ try{ kjsEnsureGames(data); }catch{} }, [data]);

  const items = [
    { id:'memory', title:'è¨˜æ†¶ç¿»ç‰Œ', sub:'Memory Match' },
    { id:'mole', title:'æ‰“åœ°é¼ ', sub:'Whack-a-mole' },
    { id:'g2048', title:'2048', sub:'2048' },
    { id:'luck', title:'ä»Šå¤©æ‰‹æ°£', sub:'ç´”äº‚æ•¸å åœ' },
    { id:'tetris', title:'ä¿„ç¾…æ–¯æ–¹å¡Š', sub:'Tetris' },
  ];

  const activeMeta = active ? (items.find(x=>x.id===active) || null) : null;

  return (
    <GameShell
      title="ğŸ® å°éŠæˆ²"
      subtitle="ç´”å¨›æ¨‚æ¨¡çµ„ï¼šä¸ç™¼çã€ä¸é€£ç·šã€ä¸å›å‚³ã€ä¸é˜²åˆ·ã€‚"
    >
      {/* Game Pickerï¼šåƒ…åœ¨æœªé€²å…¥éŠæˆ²æ™‚é¡¯ç¤ºï¼Œé¿å…å½±éŸ¿éŠæˆ²è§€æ„Ÿ */}
      {active===null ? (
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
          {items.map(it=>(
            <button
              key={it.id}
              type="button"
              onClick={()=>setActive(it.id)}
              className={"text-left rounded-2xl border p-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition border-slate-200 dark:border-slate-700"}
            >
              <div className="font-semibold">{it.title}</div>
              <div className="text-sm text-slate-500 dark:text-slate-400">{it.sub}</div>
            </button>
          ))}
        </div>
      ) : (
        <div className="flex items-center justify-between mb-3">
          <div className="min-w-0">
            <div className="text-base font-semibold truncate">{activeMeta ? activeMeta.title : "éŠæˆ²"}</div>
            <div className="text-xs text-slate-500 dark:text-slate-400 truncate">{activeMeta ? activeMeta.sub : ""}</div>
          </div>
          <div className="shrink-0 flex items-center gap-2">
            <button
              type="button"
              className="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
              onClick={()=>setActive(null)}
              title="è¿”å›éŠæˆ²åˆ—è¡¨"
            >
              â† è¿”å›
            </button>
          </div>
        </div>
      )}

      {/* Active Gameï¼šé€²å…¥éŠæˆ²å¾Œåªæ¸²æŸ“å–®ä¸€éŠæˆ²ï¼Œé¿å…åŒæ™‚å‡ºç¾å¤šå€‹å…¥å£å¡ç‰‡ */}
      {active==='memory' && <GameMemory data={data} setData={setData} />}
      {active==='mole'   && <GameMole data={data} setData={setData} />}
      {active==='g2048'  && <Game2048 data={data} setData={setData} />}
      {active==='luck'   && <GameLuck data={data} setData={setData} />}
      {active==='tetris' && <GameTetris data={data} setData={setData} />}
    </GameShell>
  );
}


/* ---------- GamesAdminï¼ˆç®¡ç†å…¥å£ï¼šç¨ç«‹è¨­å®šé  + è‰ç¨¿æ¨¡å¼ï¼‰ ---------- */
function GamesAdmin({ data, setData }){
  React.useEffect(()=>{ try{ kjsEnsureGames(data); }catch{} }, [data]);
  const [page, setPage] = React.useState('list'); // list | memory | mole | g2048 | luck | tetris

  const go = (id)=>setPage(id);
  const back = ()=>setPage('list');

  return (
    <GameShell
      title="ğŸ® å°éŠæˆ²è¨­å®š"
      subtitle="ç„¡è…¦è¨­å®šï¼šå„éŠæˆ²ç¨ç«‹é ï¼Œè‰ç¨¿æ¨¡å¼ï¼ŒæŒ‰ã€Œå„²å­˜ã€æ‰å¯«å›æ­£å¼è³‡æ–™ã€‚"
    >
      {page==='list' ? (
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <GameAdminCard title="è¨˜æ†¶ç¿»ç‰Œ" sub="ä¸»é¡Œåœ–ç‰‡ç®¡ç†" onOpen={()=>go('memory')} />
          <GameAdminCard title="æ‰“åœ°é¼ " sub="ç›®æ¨™ä¸»é¡Œ + é›£åº¦" onOpen={()=>go('mole')} />
          <GameAdminCard title="2048" sub="æ•¸å­—æ ¼åº•åœ– + é€æ˜åº¦" onOpen={()=>go('g2048')} />
          <GameAdminCard title="ä»Šå¤©æ‰‹æ°£" sub="emoji/æ¨™é¡Œ/å…§å®¹/åœ–ç‰‡/æ¬Šé‡ + æ‰¹æ¬¡" onOpen={()=>go('luck')} />
          <GameAdminCard title="ä¿„ç¾…æ–¯æ–¹å¡Š" sub="æ–¹å¡Šæ¨£å¼ï¼ˆç´”è‰²/åœ–ç‰‡ï¼‰" onOpen={()=>go('tetris')} />
        </div>
      ) : null}

      {page==='memory' && <AdminMemory data={data} setData={setData} onBack={back} />}
      {page==='mole'   && <AdminMole data={data} setData={setData} onBack={back} />}
      {page==='g2048'  && <Admin2048 data={data} setData={setData} onBack={back} />}
      {page==='luck'   && <AdminLuck data={data} setData={setData} onBack={back} />}
      {page==='tetris' && <AdminTetris data={data} setData={setData} onBack={back} />}
    </GameShell>
  );
}

function GameAdminCard({ title, sub, onOpen }){
  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
      <div className="font-semibold">{title}</div>
      <div className="text-sm text-slate-500 dark:text-slate-400 mt-1">{sub}</div>
      <div className="mt-3">
        <button type="button" onClick={onOpen}
          className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
        >è¨­å®š</button>
      </div>
    </div>
  );
}

/* =========================
   1) Memory Match
   ========================= */
function GameMemory({ data, setData }){
  const cfg = data?.games?.memory || {};
  const isTouch = useIsTouch();
  const themes = Array.isArray(cfg.themes)?cfg.themes:[];
  const [themeId, setThemeId] = React.useState(()=>themes[0]?.id || "default");
  const [level, setLevel] = React.useState("easy"); // easy=4, medium=8, hard=16
  const size = (level==="easy"?4:(level==="medium"?8:16));
  const theme = themes.find(t=>t.id===themeId) || themes[0] || { id:"default", name:"é è¨­", imagesText:"" };
  const imgs = parseLinesToList(theme.imagesText||"");
  const pairs = (size*size)/2;

  const makeDeck = React.useCallback(()=>{
    const fallbackEmoji = [
      "ğŸ˜€","ğŸ˜","ğŸ¥³","ğŸ¤–","ğŸ‘»","ğŸ¶","ğŸ±","ğŸ¼","ğŸ¦Š","ğŸ¸","ğŸµ","ğŸ¤","ğŸ™","ğŸ¦„","ğŸ","ğŸ‹","ğŸ‡","ğŸ‰",
      "ğŸ”","ğŸŸ","ğŸ•","ğŸ£","ğŸ©","ğŸª","ğŸ°","âš½","ğŸ€","ğŸ¾","ğŸ¯","ğŸ¹","ğŸ·","ğŸ»","ğŸš—","ğŸš•","ğŸš€","âœˆï¸",
      "â­","ğŸŒ™","â˜€ï¸","âš¡","ğŸ”¥","ğŸ’§","ğŸ€","ğŸŒ¸","ğŸŒˆ","â„ï¸","ğŸˆ","ğŸ","ğŸ®","ğŸ²","ğŸ§©","ğŸ§","ğŸ“Œ","ğŸ“","ğŸ”‘","ğŸ’¡"
    ];

    const isImg = (s)=>{
      if(!s) return false;
      const t = String(s).trim();
      return /^data:image\//i.test(t) || /^https?:\/\//i.test(t) || /^\//.test(t) || /\.(png|jpe?g|webp|gif|svg)(\?|#|$)/i.test(t);
    };

    // è‹¥ä¸»é¡Œåœ–ç‰‡ä¸è¶³ï¼šå…ˆé‡è¤‡åœ–ç‰‡è£œé½Šï¼›è‹¥å®Œå…¨æ²’æœ‰åœ–ç‰‡ï¼Œä½¿ç”¨ emoji è£œé½Šï¼ˆé¿å…ç©ºç™½ / ç ´åœ–ï¼‰
    const pool = imgs.filter(Boolean);
    const pick = [];
    for(let i=0;i<pairs;i++){
      const raw = pool.length ? pool[i % pool.length] : fallbackEmoji[i % fallbackEmoji.length];
      if(isImg(raw)){
        pick.push({ id: `p${i}`, src: raw, emoji: "" });
      }else{
        pick.push({ id: `p${i}`, src: "", emoji: String(raw) });
      }
    }

    const cards = [];
    for(const p of pick){
      cards.push({ key: p.id+"a", pid: p.id, src: p.src, emoji: p.emoji });
      cards.push({ key: p.id+"b", pid: p.id, src: p.src, emoji: p.emoji });
    }
    // shuffleï¼ˆå¯è¦–ç‚ºå…¬å¹³æ´—ç‰Œï¼›å¦‚éœ€å¯æ¸¬ RNGï¼Œå¯åœ¨æ­¤æ”¹æˆ seedable RNGï¼‰
    for(let i=cards.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [cards[i],cards[j]]=[cards[j],cards[i]];
    }
    return cards;
  }, [pairs, themeId, theme.imagesText]);

  const [seed, setSeed] = React.useState(0);
  const [cards, setCards] = React.useState(()=>makeDeck());
  const [open, setOpen] = React.useState([]); // indices
  const [matched, setMatched] = React.useState(()=>new Set());

  React.useEffect(()=>{
    setCards(makeDeck());
    setOpen([]);
    setMatched(new Set());
  }, [seed, level, themeId]);

  // responsive cell size
  const wrapRef = React.useRef(null);
  const [cellPx, setCellPx] = React.useState(64);

  const recalc = React.useCallback(()=>{
    const w = wrapRef.current?.clientWidth || Math.min(window.innerWidth*0.92, 560);
    const topReserve = 160; // ä¼°ç®— header/é¸å–®èˆ‡èªªæ˜
    const h = Math.max(220, window.innerHeight - topReserve - (envSafeBottom()+120));
    const byW = Math.floor((w - 8)/size);
    const byH = Math.floor((h - 8)/size);
    // Mobile 16x16: prioritize tap target size; allow scrolling rather than squeezing to fit
    const cell = (isTouch && size===16) ? byW : Math.floor(Math.min(byW, byH));
    setCellPx(Math.max(14, cell));
  }, [size, isTouch]);

  React.useEffect(()=>{
    recalc();
    window.addEventListener('resize', recalc);
    return ()=>window.removeEventListener('resize', recalc);
  }, [recalc]);

  const flip = (i)=>{
    if(matched.has(i)) return;
    if(open.includes(i)) return;
    if(open.length>=2) return;
    setOpen(o=>[...o,i]);
  };

  React.useEffect(()=>{
    if(open.length!==2) return;
    const [a,b]=open;
    const ca=cards[a], cb=cards[b];
    if(!ca || !cb) return;
    const same = ca.pid===cb.pid;
    const t = setTimeout(()=>{
      if(same){
        setMatched(ms=>{
          const nx = new Set(ms);
          nx.add(a); nx.add(b);
          return nx;
        });
      }
      setOpen([]);
    }, 420);
    return ()=>clearTimeout(t);
  }, [open, cards]);

  const done = matched.size === cards.length && cards.length>0;

  return (
    <GameShell
      title="è¨˜æ†¶ç¿»ç‰Œ"
      subtitle="æ‰‹æ©Ÿï¼šé»æ“Šç¿»ç‰Œï¼›é›»è…¦ï¼šæ»‘é¼ é»æ“Š"
      onReset={()=>setSeed(s=>s+1)}
    >
      <div className="grid gap-3">
        <div className="flex flex-wrap items-center gap-2">
          <label className="text-sm text-slate-600 dark:text-slate-300">ä¸»é¡Œ</label>
          <select className="rounded-xl border px-3 py-2 text-sm"
            value={themeId}
            onChange={(e)=>setThemeId(e.target.value)}
          >
            {(themes.length?themes:[{id:"default",name:"é è¨­"}]).map(t=>(
              <option key={t.id} value={t.id}>{t.name||"æœªå‘½å"}</option>
            ))}
          </select>

          <label className="text-sm text-slate-600 dark:text-slate-300 ml-2">é›£åº¦</label>
          <select className="rounded-xl border px-3 py-2 text-sm"
            value={level}
            onChange={(e)=>setLevel(e.target.value)}
          >
            <option value="easy">æ™®é€šï¼ˆ4Ã—4ï¼‰</option>
            <option value="medium">ä¸­ç­‰ï¼ˆ8Ã—8ï¼‰</option>
            <option value="hard">å›°é›£ï¼ˆ16Ã—16ï¼‰</option>
          </select>

          <div className="text-sm text-slate-600 dark:text-slate-300 ml-auto">
            {done ? "å®Œæˆ" : `å·²é…å°ï¼š${matched.size/2}/${cards.length/2}`}
          </div>
        </div>

        <div ref={wrapRef} className="rounded-2xl border border-slate-200 dark:border-slate-700 p-2 overflow-auto"
          style={{
            maxHeight: `calc(100vh - 220px - ${envSafeBottom()}px)`,
          }}
        >
          <div className="grid gap-1 mx-auto"
            style={{
              gridTemplateColumns: `repeat(${size}, ${cellPx}px)`,
              width: `${cellPx*size + (size-1)*4}px`,
            }}
          >
            {cards.map((c, i)=>{
              const isOpen = open.includes(i) || matched.has(i);
              return (
                <button key={c.key} type="button"
                  className={"rounded-lg border flex items-center justify-center overflow-hidden select-none " +
                    (matched.has(i) ? "border-emerald-400/60" : "border-slate-200 dark:border-slate-700") +
                    " bg-white dark:bg-slate-900"}
                  style={{ width: cellPx, height: cellPx, touchAction:"manipulation" }}
                  onClick={()=>flip(i)}
                >
                  {isOpen ? (
                    c.src ? <img src={c.src} alt="" className="w-full h-full object-cover" draggable={false}/> :
                    c.emoji ? <span className="leading-none" style={{ fontSize: Math.max(12, Math.floor(cellPx*0.55)) }}>{c.emoji}</span> :
                    <div className="w-full h-full" style={{ background: `hsl(${(i*29)%360} 70% 70%)` }} />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-xs text-slate-500"
                      style={{ background:"linear-gradient(135deg, rgba(148,163,184,.25), rgba(148,163,184,.05))" }}
                    >
                      ?
                    </div>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {done ? (
          <div className="rounded-2xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-900 p-3 text-sm">
            å·²å®Œæˆæœ¬å±€ã€‚å¯æŒ‰å³ä¸Šè§’ã€Œé‡ç½®ã€å†ä¾†ä¸€å±€ã€‚
          </div>
        ) : null}
      </div>
    </GameShell>
  );
}


function AdminMemory({ data, setData, onBack }){
  const base = data?.games?.memory || {};
  const [draft, setDraft] = React.useState(()=>JSON.parse(JSON.stringify(base||{})));

  React.useEffect(()=>{ setDraft(JSON.parse(JSON.stringify(base||{}))); }, [base]); // é€²é æ™‚è¼‰å…¥

  const themes = Array.isArray(draft.themes)?draft.themes:[];

  const addTheme = ()=>{
    const t = { id: kjsNid(), name:"æ–°ä¸»é¡Œ", imagesText:"", images:[] };
    setDraft(d=>({ ...d, themes: [...(d.themes||[]), t] }));
  };
  const delTheme = (id)=>{
    setDraft(d=>({ ...d, themes: (d.themes||[]).filter(t=>t.id!==id) }));
  };
  const upd = (id, patch)=>{
    setDraft(d=>({ ...d, themes: (d.themes||[]).map(t=>t.id===id?{...t, ...patch}:t) }));
  };

  const save = ()=>{
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      next.games.memory = {
        ...next.games.memory,
        themes: (draft.themes||[]).map(t=>({
          ...t,
          images: parseLinesToList(t.imagesText||t.images?.join("\n")||""),
        })),
        defaultThemeId: draft.defaultThemeId || (draft.themes?.[0]?.id||""),
      };
      return next;
    });
    alert("å·²å„²å­˜ï¼šè¨˜æ†¶ç¿»ç‰Œè¨­å®š");
  };

  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
      <div className="flex items-center justify-between gap-3 mb-3">
        <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={onBack}>è¿”å›</button>
        <div className="flex items-center gap-2">
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={addTheme}>æ–°å¢ä¸»é¡Œ</button>
          <button type="button" className="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:opacity-90" onClick={save}>å„²å­˜</button>
        </div>
      </div>

      <div className="grid gap-4">
        {themes.map(t=>(
          <div key={t.id} className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
              <div className="flex items-center gap-2">
                <input className="rounded-xl border px-3 py-2 text-sm w-56"
                  value={t.name||""}
                  onChange={(e)=>upd(t.id,{name:e.target.value})}
                />
                <label className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">
                  <input type="radio" name="mm_default" checked={(draft.defaultThemeId||"")===t.id}
                    onChange={()=>setDraft(d=>({ ...d, defaultThemeId: t.id }))}
                  />
                  é è¨­
                </label>
              </div>
              <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
                onClick={()=>delTheme(t.id)}
              >åˆªé™¤</button>
            </div>

            <div className="mt-2 grid md:grid-cols-2 gap-3">
              <div className="grid gap-1">
                <div className="text-sm text-slate-600 dark:text-slate-300">åœ–ç‰‡æ¸…å–®ï¼ˆæ¯è¡Œä¸€å¼µæˆ–ç”¨é€—è™Ÿåˆ†éš”ï¼‰</div>
                <textarea className="rounded-xl border px-3 py-2 text-sm min-h-[140px]"
                  value={t.imagesText||""}
                  onChange={(e)=>upd(t.id,{imagesText:e.target.value})}
                />
              </div>
              <div className="grid gap-1">
                <div className="text-sm text-slate-600 dark:text-slate-300">å³æ™‚é è¦½</div>
                <div className="grid grid-cols-4 gap-2 rounded-2xl border border-slate-200 dark:border-slate-700 p-2">
                  {parseLinesToList(t.imagesText||"").slice(0,12).map((src,i)=>(
                    <img key={src+i} src={src} alt="" className="w-full aspect-square object-cover rounded-xl border border-slate-200 dark:border-slate-700" draggable={false}/>
                  ))}
                  {parseLinesToList(t.imagesText||"").length===0 ? (
                    <div className="col-span-4 text-sm text-slate-500 dark:text-slate-400 p-2">å°šæœªè¨­å®šåœ–ç‰‡</div>
                  ) : null}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* =========================
   2) Whack-a-mole
   ========================= */
function GameMole({ data, setData }){
  const cfg = data?.games?.mole || {};
  const themes = Array.isArray(cfg.themes)?cfg.themes:[];
  const [themeId, setThemeId] = React.useState(()=>themes[0]?.id || "default");
  const [level, setLevel] = React.useState("easy"); // easy must be relaxed
  const theme = themes.find(t=>t.id===themeId) || themes[0] || { id:"default", name:"é è¨­", imagesText:"" };
  const imgs = parseLinesToList(theme.imagesText||"");

  const isTouch = useIsTouch();
  const [running, setRunning] = React.useState(false);
  const [timeLeft, setTimeLeft] = React.useState(60);
  const [score, setScore] = React.useState(0);
  const [active, setActive] = React.useState(-1);
  const holes = 9;

  const params = React.useMemo(()=>{
    if(level==="easy") return { spawn: 850, show: 720 };     // æ”¾é¬†ã€çœ‹å¾—åˆ°ã€ä¾†å¾—åŠé»
    if(level==="medium") return { spawn: 520, show: 470 };   // ç·Šæ¹Š
    return { spawn: 340, show: 310 };                        // æ‰‹é€ŸæŒ‘æˆ°
  }, [level]);

  const start = ()=>{
    setScore(0);
    setTimeLeft(60);
    setActive(-1);
    setRunning(true);
  };

  const stop = ()=>{
    setRunning(false);
    setActive(-1);
  };

  React.useEffect(()=>{
    if(!running) return;
    const t = setInterval(()=>{
      setTimeLeft(s=>{
        if(s<=1){
          stop();
          return 0;
        }
        return s-1;
      });
    }, 1000);
    return ()=>clearInterval(t);
  }, [running]);

  React.useEffect(()=>{
    if(!running) return;
    let hideTimer = null;
    const spawn = ()=>{
      const idx = Math.floor(Math.random()*holes);
      setActive(idx);
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>setActive(-1), params.show);
    };
    spawn();
    const it = setInterval(spawn, params.spawn);
    return ()=>{
      clearInterval(it);
      if(hideTimer) clearTimeout(hideTimer);
    };
  }, [running, params.spawn, params.show]);

  const hit = (i)=>{
    if(!running) return;
    if(i!==active) return;
    setScore(s=>s+1);
    setActive(-1);
  };

  const renderTarget = ()=>{
    // è‹¥æœ‰åœ–ç‰‡ä¸»é¡Œï¼Œä½¿ç”¨åœ–ç‰‡ï¼›å¦å‰‡é è¨­é¡¯ç¤ºğŸ­
    if(imgs.length){
      const src = imgs[Math.floor(Math.random()*imgs.length)];
      return <img src={src} alt="" className="w-full h-full object-cover" draggable={false}/>;
    }
    return <div className="text-3xl leading-none">ğŸ­</div>;
  };

  return (
    <GameShell
      title="æ‰“åœ°é¼ "
      subtitle={isTouch ? "æ‰‹æ©Ÿï¼šé»æ“Šåœ°é¼ " : "é›»è…¦ï¼šæ»‘é¼ é»æ“Š"}
      onReset={start}
    >
      <div className="grid gap-3">
        <div className="flex flex-wrap items-center gap-2">
          <label className="text-sm text-slate-600 dark:text-slate-300">ä¸»é¡Œ</label>
          <select className="rounded-xl border px-3 py-2 text-sm"
            value={themeId}
            onChange={(e)=>setThemeId(e.target.value)}
          >
            {(themes.length?themes:[{id:"default",name:"é è¨­"}]).map(t=>(
              <option key={t.id} value={t.id}>{t.name||"æœªå‘½å"}</option>
            ))}
          </select>

          <label className="text-sm text-slate-600 dark:text-slate-300 ml-2">é›£åº¦</label>
          <select className="rounded-xl border px-3 py-2 text-sm"
            value={level}
            onChange={(e)=>setLevel(e.target.value)}
          >
            <option value="easy">æ™®é€šï¼ˆæ”¾é¬†ï¼‰</option>
            <option value="medium">ä¸­ç­‰ï¼ˆç·Šæ¹Šï¼‰</option>
            <option value="hard">å›°é›£ï¼ˆæ‰‹é€ŸæŒ‘æˆ°ï¼‰</option>
          </select>

          <div className="ml-auto flex items-center gap-3">
            <div className="text-sm font-medium">å‰©é¤˜ {timeLeft}s</div>
            <div className="text-sm font-medium">å¾—åˆ† {score}</div>
          </div>
        </div>

        <div className="flex items-center gap-2">
          {!running ? (
            <button type="button" className="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
              onClick={start}
            >é–‹å§‹ï¼ˆ60 ç§’ï¼‰</button>
          ) : (
            <button type="button" className="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
              onClick={stop}
            >åœæ­¢</button>
          )}
          <div className="text-sm text-slate-500 dark:text-slate-400">æ™®é€šé›£åº¦åˆ»æ„æ”¾æ…¢ï¼Œé©åˆå¤§çœ¾ã€‚</div>
        </div>

        <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3"
          style={{ touchAction:"manipulation" }}
        >
          <div className="grid grid-cols-3 gap-3 max-w-[520px] mx-auto">
            {Array.from({length:holes}).map((_,i)=>(
              <button key={i} type="button"
                className={"relative rounded-2xl border overflow-hidden bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 " +
                  "aspect-square"}
                onClick={()=>hit(i)}
              >
                <div className="absolute inset-0 flex items-center justify-center">
                  {running && i===active ? renderTarget() : <div className="w-10 h-10 rounded-full bg-slate-200/60 dark:bg-slate-700/40" />}
                </div>
              </button>
            ))}
          </div>
        </div>

        {!running && timeLeft===0 ? (
          <div className="rounded-2xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 text-sm">
            æœ¬å±€çµæŸã€‚å¾—åˆ†ï¼š{score}
          </div>
        ) : null}
      </div>
    </GameShell>
  );
}


function AdminMole({ data, setData, onBack }){
  const base = data?.games?.mole || {};
  const [draft, setDraft] = React.useState(()=>JSON.parse(JSON.stringify(base||{})));

  React.useEffect(()=>{ setDraft(JSON.parse(JSON.stringify(base||{}))); }, [base]); // é€²é æ™‚è¼‰å…¥

  const themes = Array.isArray(draft.themes)?draft.themes:[];

  const addTheme = ()=>{
    const t = { id: kjsNid(), name:"æ–°ä¸»é¡Œ", imagesText:"", images:[] };
    setDraft(d=>({ ...d, themes: [...(d.themes||[]), t] }));
  };
  const delTheme = (id)=>{
    setDraft(d=>({ ...d, themes: (d.themes||[]).filter(t=>t.id!==id) }));
  };
  const upd = (id, patch)=>{
    setDraft(d=>({ ...d, themes: (d.themes||[]).map(t=>t.id===id?{...t, ...patch}:t) }));
  };

  const save = ()=>{
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      next.games.mole = {
        ...next.games.mole,
        themes: (draft.themes||[]).map(t=>({
          ...t,
          images: parseLinesToList(t.imagesText||t.images?.join("\n")||""),
        })),
        defaultThemeId: draft.defaultThemeId || (draft.themes?.[0]?.id||""),
      };
      return next;
    });
    alert("å·²å„²å­˜ï¼šæ‰“åœ°é¼ è¨­å®š");
  };

  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
      <div className="flex items-center justify-between gap-3 mb-3">
        <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={onBack}>è¿”å›</button>
        <div className="flex items-center gap-2">
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={addTheme}>æ–°å¢ä¸»é¡Œ</button>
          <button type="button" className="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:opacity-90" onClick={save}>å„²å­˜</button>
        </div>
      </div>

      <div className="grid gap-4">
        {themes.map(t=>(
          <div key={t.id} className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
              <div className="flex items-center gap-2">
                <input className="rounded-xl border px-3 py-2 text-sm w-56"
                  value={t.name||""}
                  onChange={(e)=>upd(t.id,{name:e.target.value})}
                />
                <label className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">
                  <input type="radio" name="mole_default" checked={(draft.defaultThemeId||"")===t.id}
                    onChange={()=>setDraft(d=>({ ...d, defaultThemeId: t.id }))}
                  />
                  é è¨­
                </label>
              </div>
              <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
                onClick={()=>delTheme(t.id)}
              >åˆªé™¤</button>
            </div>

            <div className="mt-2 grid md:grid-cols-2 gap-3">
              <div className="grid gap-1">
                <div className="text-sm text-slate-600 dark:text-slate-300">ç›®æ¨™åœ–ç‰‡ï¼ˆæ¯è¡Œä¸€å¼µæˆ–é€—è™Ÿåˆ†éš”ï¼‰</div>
                <textarea className="rounded-xl border px-3 py-2 text-sm min-h-[140px]"
                  value={t.imagesText||""}
                  onChange={(e)=>upd(t.id,{imagesText:e.target.value})}
                />
              </div>
              <div className="grid gap-1">
                <div className="text-sm text-slate-600 dark:text-slate-300">å³æ™‚é è¦½</div>
                <div className="grid grid-cols-4 gap-2 rounded-2xl border border-slate-200 dark:border-slate-700 p-2">
                  {parseLinesToList(t.imagesText||"").slice(0,12).map((src,i)=>(
                    <img key={src+i} src={src} alt="" className="w-full aspect-square object-cover rounded-xl border border-slate-200 dark:border-slate-700" draggable={false}/>
                  ))}
                  {parseLinesToList(t.imagesText||"").length===0 ? (
                    <div className="col-span-4 text-sm text-slate-500 dark:text-slate-400 p-2">å°šæœªè¨­å®šåœ–ç‰‡</div>
                  ) : null}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* =========================
   3) 2048
   ========================= */
function Game2048({ data, setData }){
  const cfg = data?.games?.g2048 || {};

  // æ”¯æ´ã€Œå¤šå¥—æ¨£å¼ã€ï¼šstyles[ ] + activeStyleIdï¼›è‹¥èˆŠè³‡æ–™åªæœ‰ tileImagesï¼Œæœƒè‡ªå‹•è¦–ç‚ºé è¨­æ¨£å¼
  const legacyDefaultOpacity = (cfg.defaultTileOpacity==null?0.22:cfg.defaultTileOpacity);
  const styles = Array.isArray(cfg.styles) && cfg.styles.length
    ? cfg.styles
    : [{ id:"default", name:"é è¨­", defaultOpacity: legacyDefaultOpacity, tileImages: (cfg.tileImages||{}) }];

  const savedStyleId = cfg.activeStyleId || styles[0].id;

  // ä½¿ç”¨è€…å¯åœ¨éŠæˆ²å…§åˆ‡æ›æ¨£å¼ï¼ˆèˆ‡ã€Œè¨˜æ†¶ç¿»ç‰Œ/æ‰“åœ°é¼ ã€ä¸€è‡´çš„é«”é©—ï¼‰ï¼Œä¸¦æŒä¹…åŒ–åˆ°æœ¬æ©Ÿ
  const [styleId, setStyleId] = React.useState(savedStyleId);
  React.useEffect(()=>{ setStyleId(savedStyleId); }, [savedStyleId]);

  const effectiveStyleId = (typeof styleId==="string" && styleId) ? styleId : savedStyleId;
  const activeStyle = styles.find(s=>s.id===effectiveStyleId) || styles[0];
  const tileImages = activeStyle.tileImages || {};
  const defaultOpacity = (activeStyle.defaultOpacity==null ? legacyDefaultOpacity : activeStyle.defaultOpacity);

  const applyStyle = (id)=>{
    setStyleId(id);
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      const cur = next.games.g2048 || {};
      next.games.g2048 = {
        ...cur,
        // ä¿ç•™æ—¢æœ‰ stylesï¼›è‹¥ä¸å­˜åœ¨å‰‡ä½¿ç”¨ç•¶å‰è§£æåˆ°çš„ styles ä½œç‚º fallback
        styles: (Array.isArray(cur.styles) && cur.styles.length) ? cur.styles : styles,
        activeStyleId: id,
        targetTile: cur.targetTile
      };
      return next;
    });
  };


  const applyTarget = (v)=>{
    const n = Number(v);
    const targetTile = (n===2048 || n===4096 || n===8192) ? n : 2048;
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      const cur = next.games.g2048 || {};
      next.games.g2048 = {
        ...cur,
        styles: (Array.isArray(cur.styles) && cur.styles.length) ? cur.styles : styles,
        activeStyleId: (cur.activeStyleId || savedStyleId || styles[0].id),
        targetTile
      };
      return next;
    });
  };

  const target = (cfg.targetTile===2048 || cfg.targetTile===4096 || cfg.targetTile===8192) ? cfg.targetTile : 2048;

  const isTouch = useIsTouch();

  const emptyBoard = ()=>Array.from({length:4},()=>Array(4).fill(0));

  const randEmpty = (b)=>{
    const cells=[];
    for(let r=0;r<4;r++) for(let c=0;c<4;c++) if(!b[r][c]) cells.push([r,c]);
    if(!cells.length) return null;
    return cells[Math.floor(Math.random()*cells.length)];
  };

  const addRandom = (b)=>{
    const p = randEmpty(b);
    if(!p) return b;
    const [r,c]=p;
    const v = Math.random()<0.9?2:4;
    const nb = b.map(row=>row.slice());
    nb[r][c]=v;
    return nb;
  };

  const canMove = (b)=>{
    for(let r=0;r<4;r++) for(let c=0;c<4;c++){
      const v=b[r][c];
      if(v===0) return true;
      if(r<3 && b[r+1][c]===v) return true;
      if(c<3 && b[r][c+1]===v) return true;
    }
    return false;
  };

  const slideLine = (line)=>{
    const arr = line.filter(x=>x!==0);
    let scoreAdd=0;
    for(let i=0;i<arr.length-1;i++){
      if(arr[i]===arr[i+1]){
        arr[i]*=2;
        scoreAdd+=arr[i];
        arr[i+1]=0;
      }
    }
    const merged = arr.filter(x=>x!==0);
    while(merged.length<4) merged.push(0);
    return { line: merged, scoreAdd };
  };

  const move = (b, dir)=>{
    // dir: 'L','R','U','D'
    let moved=false;
    let scoreAdd=0;
    const nb = emptyBoard();
    const get = (r,c)=>b[r][c];

    const setRow = (r, line)=>{ for(let c=0;c<4;c++) nb[r][c]=line[c]; };
    const setCol = (c, line)=>{ for(let r=0;r<4;r++) nb[r][c]=line[r]; };

    if(dir==='L' || dir==='R'){
      for(let r=0;r<4;r++){
        const line = [0,1,2,3].map(c=>get(r,c));
        const src = (dir==='R')?line.slice().reverse():line;
        const { line:out, scoreAdd:sa } = slideLine(src);
        const res = (dir==='R')?out.slice().reverse():out;
        setRow(r,res);
        if(res.some((v,i)=>v!==line[i])) moved=true;
        scoreAdd+=sa;
      }
    }else{
      for(let c=0;c<4;c++){
        const line = [0,1,2,3].map(r=>get(r,c));
        const src = (dir==='D')?line.slice().reverse():line;
        const { line:out, scoreAdd:sa } = slideLine(src);
        const res = (dir==='D')?out.slice().reverse():out;
        setCol(c,res);
        if(res.some((v,i)=>v!==line[i])) moved=true;
        scoreAdd+=sa;
      }
    }
    return { board: nb, moved, scoreAdd };
  };

  const [seed, setSeed] = React.useState(0);
  const [board, setBoard] = React.useState(()=>addRandom(addRandom(emptyBoard())));
  const [score, setScore] = React.useState(0);
  const [won, setWon] = React.useState(false);
  const [over, setOver] = React.useState(false);

  React.useEffect(()=>{
    setBoard(addRandom(addRandom(emptyBoard())));
    setScore(0);
    setWon(false);
    setOver(false);
  }, [seed, target]);

  const applyMove = (dir)=>{
    if(over) return;
    setBoard(b=>{
      const { board:nb, moved, scoreAdd } = move(b, dir);
      if(!moved) return b;
      const added = addRandom(nb);
      // check
      const maxv = Math.max(...added.flat());
      if(maxv>=target) setWon(true);
      if(!canMove(added)) setOver(true);
      setScore(s=>s+scoreAdd);
      return added;
    });
  };

  // keyboard
  React.useEffect(()=>{
    const onKey=(e)=>{
      if(e.key==='ArrowLeft'){ e.preventDefault(); applyMove('L'); }
      else if(e.key==='ArrowRight'){ e.preventDefault(); applyMove('R'); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); applyMove('U'); }
      else if(e.key==='ArrowDown'){ e.preventDefault(); applyMove('D'); }
    };
    window.addEventListener('keydown', onKey, { passive:false });
    return ()=>window.removeEventListener('keydown', onKey);
  }, [over]);

  // swipe
  const touch = React.useRef({ x:0, y:0, on:false });
  const onTouchStart = (e)=>{
    if(!e.touches?.length) return;
    const t = e.touches[0];
    touch.current = { x:t.clientX, y:t.clientY, on:true };
  };
  const onTouchEnd = (e)=>{
    if(!touch.current.on) return;
    touch.current.on=false;
    const t = e.changedTouches?.[0];
    if(!t) return;
    const dx = t.clientX - touch.current.x;
    const dy = t.clientY - touch.current.y;
    const adx = Math.abs(dx), ady = Math.abs(dy);
    if(Math.max(adx,ady)<22) return;
    if(adx>ady) applyMove(dx>0?'R':'L');
    else applyMove(dy>0?'D':'U');
  };

  // responsive tile size
  const wrapRef = React.useRef(null);
  const [tilePx, setTilePx] = React.useState(72);
  React.useEffect(()=>{
    const recalc=()=>{
      const w = Math.min(wrapRef.current?.clientWidth||window.innerWidth*0.92, 520);
      const topReserve = 190;
      const h = Math.max(240, window.innerHeight - topReserve - (envSafeBottom()+120));
      const cell = Math.floor(Math.min((w-24)/4, (h-24)/4));
      setTilePx(Math.max(48, cell));
    };
    recalc();
    window.addEventListener('resize', recalc);
    return ()=>window.removeEventListener('resize', recalc);
  }, []);

  const tileBg = (v)=>{
    const item = tileImages?.[String(v)];
    const src = item?.src || "";
    const op = item?.opacity;
    const opacity = (op==null?defaultOpacity:op);
    return { src, opacity };
  };

  return (
    <GameShell
      title="2048"
      subtitle={isTouch ? "æ‰‹æ©Ÿï¼šæ»‘å‹•å³å¯ç§»å‹•" : "é›»è…¦ï¼šä½¿ç”¨æ–¹å‘éµ"}
      onReset={()=>setSeed(s=>s+1)}
    >
      <div className="grid gap-3">
        <div className="flex items-center gap-3 flex-wrap">
          <div className="flex items-center gap-2">
            <div className="text-sm font-medium">ç›®æ¨™</div>
            <select className="rounded-xl border px-3 py-2 text-sm bg-white dark:bg-slate-900"
              value={target}
              onChange={(e)=>applyTarget(e.target.value)}
              title="é¸æ“‡é€šé—œç›®æ¨™ï¼ˆé”æˆå¾Œæœƒé¡¯ç¤ºé”æˆï¼‰"
            >
              <option value="2048">2048</option>
              <option value="4096">4096</option>
              <option value="8192">8192</option>
            </select>
          </div>
          <div className="text-sm font-medium">åˆ†æ•¸ï¼š{score}</div>
          {won ? <div className="text-sm rounded-full px-3 py-1 border border-emerald-300 bg-emerald-50 dark:bg-emerald-900/20">é”æˆ</div> : null}
          {over ? <div className="text-sm rounded-full px-3 py-1 border border-rose-300 bg-rose-50 dark:bg-rose-900/20">çµæŸ</div> : null}
          <div className="flex items-center gap-2">
            <label className="text-sm text-slate-600 dark:text-slate-300">æ¨£å¼</label>
            <select className="rounded-xl border px-3 py-2 text-sm bg-white dark:bg-slate-900"
              value={styleId}
              onChange={(e)=>applyStyle(e.target.value)}
            >
              {(styles.length?styles:[{id:"default",name:"é è¨­"}]).map(s=>(
                <option key={s.id} value={s.id}>{s.name||"æœªå‘½å"}</option>
              ))}
            </select>
          </div>
          <div className="ml-auto text-sm text-slate-500 dark:text-slate-400">æ ¼å­å›ºå®šå°é½Šï¼Œæ‰‹æ©Ÿæ”¯æ´æ»‘å‹•æ“ä½œ</div>
        </div>

        <div ref={wrapRef} className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3 mx-auto"
          style={{ width: (tilePx*4 + 12*3 + 24) }}
        >
          <div
            className="grid gap-3"
            style={{
              gridTemplateColumns:`repeat(4, ${tilePx}px)`,
              touchAction:"none",
            }}
            onTouchStart={onTouchStart}
            onTouchEnd={onTouchEnd}
          >
            {board.flatMap((row,r)=>row.map((v,c)=>{
              const { src, opacity } = tileBg(v);
              return (
                <div key={`${r}-${c}`}
                  className="relative rounded-2xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex items-center justify-center overflow-hidden"
                  style={{ width: tilePx, height: tilePx }}
                >
                  {src ? (
                    <img src={src} alt="" className="absolute inset-0 w-full h-full object-cover"
                      style={{ opacity: opacity, pointerEvents:"none" }} draggable={false}
                    />
                  ) : null}
                  <div className="relative font-bold select-none"
                    style={{ fontSize: Math.max(16, Math.floor(tilePx*0.28)) }}
                  >
                    {v?String(v):""}
                  </div>
                </div>
              );
            }))}
          </div>
        </div>
      </div>
    </GameShell>
  );
}


function Admin2048({ data, setData, onBack }){
  const base = data?.games?.g2048 || {};
  const [draft, setDraft] = React.useState(()=>JSON.parse(JSON.stringify(base||{})));
  const [styleId, setStyleId] = React.useState(()=> (base.activeStyleId || (Array.isArray(base.styles)&&base.styles[0]?.id) || "default"));
  const [tileKey, setTileKey] = React.useState("2");

  // åªåœ¨ base çœŸæ­£æ”¹è®Šæ™‚åŒæ­¥ï¼ˆé¿å…è‰ç¨¿è¢«åè¦†è¦†è“‹é€ æˆã€Œç„¡æ³•é¸æ“‡/ç„¡æ³•æ–°å¢ã€ï¼‰
  React.useEffect(()=>{
    setDraft(JSON.parse(JSON.stringify(base||{})));
    const initStyles = (Array.isArray(base.styles)&&base.styles.length)?base.styles:[];
    setStyleId(base.activeStyleId || initStyles[0]?.id || "default");
  }, [base]);

  const legacyDefaultOpacity = (draft.defaultTileOpacity==null?0.22:draft.defaultTileOpacity);
  const styles = (Array.isArray(draft.styles) && draft.styles.length)
    ? draft.styles
    : [{ id:"default", name:"é è¨­", defaultOpacity: legacyDefaultOpacity, tileImages: (draft.tileImages||{}) }];

  const active = styles.find(s=>s.id===styleId) || styles[0];

  const ensureStylesOnDraft = (nx)=>{
    if(!Array.isArray(nx.styles) || !nx.styles.length){
      nx.styles = [{ id:"default", name:"é è¨­", defaultOpacity: legacyDefaultOpacity, tileImages: (nx.tileImages||{}) }];
    }
    // æ¸…æ‰ legacy æ¬„ä½é¿å…æ··äº‚ï¼ˆä»ä¿ç•™ç›¸å®¹è®€å–ï¼Œä½†å­˜æª”ä»¥ styles ç‚ºæº–ï¼‰
    if(nx.tileImages) delete nx.tileImages;
    if(nx.defaultTileOpacity!=null) delete nx.defaultTileOpacity;
    return nx;
  };

  const addStyle = ()=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      const id = "s_"+Date.now().toString(36);
      nx.styles.push({ id, name:`æ¨£å¼ ${nx.styles.length+1}`, defaultOpacity: 0.22, tileImages: {} });
      return nx;
    });
    // setStyleId éœ€åœ¨ state æ›´æ–°å¾Œå†åˆ‡æ›ï¼Œé€™è£¡ç”¨ microtask
    Promise.resolve().then(()=>setStyleId("s_"+Date.now().toString(36)));
  };

  const addStyleStable = ()=>{
    const id = "s_"+Date.now().toString(36);
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles.push({ id, name:`æ¨£å¼ ${nx.styles.length+1}`, defaultOpacity: 0.22, tileImages: {} });
      return nx;
    });
    setStyleId(id);
  };

  const renameStyle = (name)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=> s.id===styleId ? { ...s, name } : s);
      return nx;
    });
  };

  const deleteStyle = ()=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      if(nx.styles.length<=1) return nx;
      const rest = nx.styles.filter(s=>s.id!==styleId);
      nx.styles = rest;
      const nextId = rest[0]?.id || "default";
      setStyleId(nextId);
      return nx;
    });
  };

  const setActivePatch = (patch)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=> s.id===styleId ? { ...s, ...patch } : s);
      return nx;
    });
  };

  const tileImages = active.tileImages || {};
  const cur = tileImages[tileKey] || { src:"", opacity: (active.defaultOpacity==null?0.22:active.defaultOpacity) };

  const setCur = (patch)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=>{
        if(s.id!==styleId) return s;
        const ti = { ...(s.tileImages||{}) };
        const prev = ti[tileKey] || { src:"", opacity: (s.defaultOpacity==null?0.22:s.defaultOpacity) };
        ti[tileKey] = { ...prev, ...patch };
        return { ...s, tileImages: ti };
      });
      return nx;
    });
  };

  const save = ()=>{
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(draft||{})));
      next.games.g2048 = {
        ...nx,
        styles: (nx.styles||styles),
        activeStyleId: styleId,
        // targetTile ä¿ç•™
        targetTile: nx.targetTile
      };
      return next;
    });
    toast("2048 è¨­å®šå·²å„²å­˜");
  };

  const tileKeys = ["2","4","8","16","32","64","128","256","512","1024","2048","4096","8192"];

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div className="font-semibold">2048 è¨­å®š</div>
        <div className="flex gap-2">
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={onBack}
          >è¿”å›</button>
          <button type="button" className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700"
            onClick={save}
          >å„²å­˜</button>
        </div>
      </div>

      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-3">
        <div className="font-medium">å‹åˆ©ç›®æ¨™</div>
        <div className="flex flex-wrap gap-2">
          {[2048,4096,8192].map(v=>(
            <button key={v} type="button"
              className={"rounded-xl border px-3 py-2 text-sm " + ((draft.targetTile||2048)===v ? "bg-slate-900 text-white dark:bg-white dark:text-slate-900" : "hover:bg-slate-50 dark:hover:bg-slate-800")}
              onClick={()=>setDraft(d=>({...(d||{}), targetTile:v}))}
            >{v}</button>
          ))}
        </div>
      </div>

      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-3">
        <div className="flex items-center justify-between gap-2">
          <div className="font-medium">æ¨£å¼</div>
          <div className="flex gap-2">
            <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
              onClick={addStyleStable}
            >æ–°å¢æ¨£å¼</button>
            <button type="button" className={"rounded-xl border px-3 py-2 text-sm " + (styles.length<=1 ? "opacity-50 cursor-not-allowed" : "hover:bg-slate-50 dark:hover:bg-slate-800")}
              disabled={styles.length<=1}
              onClick={deleteStyle}
            >åˆªé™¤</button>
          </div>
        </div>

        <div className="grid md:grid-cols-3 gap-3">
          <label className="text-sm">
            <div className="text-slate-500 mb-1">é¸æ“‡æ¨£å¼</div>
            <select className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={styleId}
              onChange={(e)=>setStyleId(e.target.value)}
            >
              {styles.map(s=>(<option key={s.id} value={s.id}>{s.name||s.id}</option>))}
            </select>
          </label>

          <label className="text-sm md:col-span-2">
            <div className="text-slate-500 mb-1">æ¨£å¼åç¨±</div>
            <input className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={active.name||""}
              onChange={(e)=>renameStyle(e.target.value)}
              placeholder="ä¾‹å¦‚ï¼šå¯æ„›é¢¨ã€IP åœ–ã€é€æ˜åº•ç­‰"
            />
          </label>
        </div>

        <label className="text-sm">
          <div className="text-slate-500 mb-1">é è¨­åœ–ç‰‡é€æ˜åº¦ï¼ˆæœªå–®ç¨è¨­å®šæ™‚ï¼‰</div>
          <input type="range" min="0" max="0.6" step="0.02"
            value={(active.defaultOpacity==null?0.22:active.defaultOpacity)}
            onChange={(e)=>setActivePatch({ defaultOpacity: Number(e.target.value) })}
            className="w-full"
          />
          <div className="text-xs text-slate-500 mt-1">{(active.defaultOpacity==null?0.22:active.defaultOpacity).toFixed(2)}</div>
        </label>
      </div>

      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-4">
        <div className="font-medium">æ–¹å¡Šåœ–ç‰‡ï¼ˆ2~8192ï¼‰</div>

        <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <label className="text-sm">
            <div className="text-slate-500 mb-1">é¸æ“‡æ•¸å­—</div>
            <select className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={tileKey}
              onChange={(e)=>setTileKey(e.target.value)}
            >
              {tileKeys.map(k=>(<option key={k} value={k}>{k}</option>))}
            </select>
          </label>

          <label className="text-sm sm:col-span-1 lg:col-span-3">
            <div className="text-slate-500 mb-1">åœ–ç‰‡ URLï¼ˆæˆ–è²¼ä¸Š dataURLï¼‰</div>
            <input className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={cur.src||""}
              onChange={(e)=>setCur({ src: e.target.value })}
              placeholder="https://... æˆ– data:image/..."
            />
          </label>
        </div>

        <div className="grid md:grid-cols-3 gap-3 items-end">
          <label className="text-sm">
            <div className="text-slate-500 mb-1">é€æ˜åº¦ï¼ˆæ­¤æ•¸å­—ï¼‰</div>
            <input type="range" min="0" max="0.6" step="0.02"
              value={(cur.opacity==null?(active.defaultOpacity==null?0.22:active.defaultOpacity):cur.opacity)}
              onChange={(e)=>setCur({ opacity: Number(e.target.value) })}
              className="w-full"
            />
            <div className="text-xs text-slate-500 mt-1">{(cur.opacity==null?(active.defaultOpacity==null?0.22:active.defaultOpacity):cur.opacity).toFixed(2)}</div>
          </label>

          <div className="md:col-span-2">
            <div className="text-sm text-slate-500 mb-1">é è¦½</div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3 flex items-center gap-3">
              <div className="w-20 h-20 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                {cur.src ? <img src={cur.src} alt="" className="w-full h-full object-cover" style={{ opacity: (cur.opacity==null?(active.defaultOpacity==null?0.22:active.defaultOpacity):cur.opacity) }} /> : <div className="text-slate-400 text-sm">ç„¡</div>}
              </div>
              <div className="text-sm">
                <div>æ•¸å­—ï¼š<span className="font-semibold">{tileKey}</span></div>
                <div className="text-xs text-slate-500 mt-1">æœªå¡«åœ–ç‰‡æ™‚æœƒé¡¯ç¤ºé è¨­åº•è‰² + æ•¸å­—</div>
              </div>
            </div>
          </div>
        </div>

        <div className="text-xs text-slate-500">
          å»ºè­°ï¼šåœ–ç‰‡ç”¨é€æ˜ PNG/WebPï¼Œæˆ–åœ¨åœ–ç‰‡ä¸Šä¿ç•™è¶³å¤ ç•™ç™½ï¼›æ•¸å­—æœƒä¿æŒåœ¨æœ€ä¸Šå±¤ä»¥ç¢ºä¿å¯è®€æ€§ã€‚
        </div>
      </div>
    </div>
  );
}


function GameLuck({ data, setData }){
  const cfg = data?.games?.luck || {};
  const items = Array.isArray(cfg.items)?cfg.items:[];
  const [result, setResult] = React.useState(null);

  const draw = ()=>{
    const it = pickWeighted(items);
    setResult(it || null);
  };

  return (
    <GameShell title="ä»Šå¤©æ‰‹æ°£" subtitle="ç´”äº‚æ•¸å åœï¼šé»ä¸€ä¸‹å°±å‡ºçµæœã€‚">
      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
        <div className="flex items-center gap-2">
          <button type="button" className="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm hover:opacity-90" onClick={draw}>æŠ½ä¸€ä¸‹</button>
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={()=>setResult(null)}>æ¸…é™¤</button>
        </div>

        <div className="mt-4">
          {result ? (
            <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
              <div className="text-3xl">{result.emoji||"ğŸ²"}</div>
              <div className="text-lg font-semibold mt-2">{result.title||"çµæœ"}</div>
              <div className="text-slate-600 dark:text-slate-300 mt-2 whitespace-pre-wrap">{result.content||""}</div>
              {result.image ? (
                <img src={result.image} alt="" className="mt-3 w-full max-w-md rounded-2xl border border-slate-200 dark:border-slate-700 object-cover" draggable={false}/>
              ) : null}
            </div>
          ) : (
            <div className="text-sm text-slate-500 dark:text-slate-400">å°šæœªæŠ½å–</div>
          )}
        </div>
      </div>
    </GameShell>
  );
}

function AdminLuck({ data, setData, onBack }){
  const base = data?.games?.luck || {};
  const [draft, setDraft] = React.useState(()=>JSON.parse(JSON.stringify(base||{})));
  const [batch, setBatch] = React.useState("");

  React.useEffect(()=>{ setDraft(JSON.parse(JSON.stringify(base||{}))); }, [base]);

  const items = Array.isArray(draft.items)?draft.items:[];

  const upd = (id, patch)=>{
    setDraft(d=>({ ...d, items: (d.items||[]).map(it=>it.id===id?{...it, ...patch}:it) }));
  };
  const addOne = ()=>{
    const it = { id:kjsNid(), emoji:"ğŸ²", title:"æ–°çµæœ", content:"", image:"", weight:1 };
    setDraft(d=>({ ...d, items:[...(d.items||[]), it] }));
  };
  const delOne = (id)=>{
    setDraft(d=>({ ...d, items:(d.items||[]).filter(it=>it.id!==id) }));
  };

  // æ‰¹æ¬¡æ¨¡å¼ï¼šæ¯è¡Œä¸€ç­†
  // æ ¼å¼ï¼šemoji | æ¨™é¡Œ | å…§å®¹ | åœ–ç‰‡(å¯ç©º) | æ¬Šé‡
  const applyBatch = ()=>{
    const lines = String(batch||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const next = [];
    for(const ln of lines){
      const parts = ln.split("|").map(s=>s.trim());
      const emoji = parts[0] || "ğŸ²";
      const title = parts[1] || "çµæœ";
      const content = parts[2] || "";
      const image = parts[3] || "";
      const weight = Number(parts[4] || 1);
      next.push({ id:kjsNid(), emoji, title, content, image, weight: isFinite(weight)?weight:1 });
    }
    setDraft(d=>({ ...d, items: next }));
    alert("å·²å¥—ç”¨æ‰¹æ¬¡å…§å®¹ï¼ˆè‰ç¨¿ï¼‰");
  };

  const save = ()=>{
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      next.games.luck = {
        ...next.games.luck,
        items: (draft.items||[]).map(it=>({
          ...it,
          emoji: String(it.emoji||"").trim(),
          title: String(it.title||"").trim(),
          content: String(it.content||""),
          image: String(it.image||"").trim(),
          weight: Math.max(0, Number(it.weight||0))
        }))
      };
      return next;
    });
    alert("å·²å„²å­˜ï¼šä»Šå¤©æ‰‹æ°£è¨­å®š");
  };

  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
      <div className="flex items-center justify-between gap-3 mb-3">
        <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={onBack}>è¿”å›</button>
        <div className="flex items-center gap-2">
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={addOne}>æ–°å¢ä¸€ç­†</button>
          <button type="button" className="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:opacity-90" onClick={save}>å„²å­˜</button>
        </div>
      </div>

      <div className="grid lg:grid-cols-2 gap-4">
        <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3">
          <div className="font-semibold">æ‰¹æ¬¡ç·¨è¼¯æ¨¡å¼</div>
          <div className="text-sm text-slate-500 dark:text-slate-400 mt-1">æ¯è¡Œä¸€ç­†ï¼šemoji | æ¨™é¡Œ | å…§å®¹ | åœ–ç‰‡(å¯ç©º) | æ¬Šé‡</div>
          <textarea className="rounded-xl border px-3 py-2 text-sm min-h-[200px] w-full mt-3"
            value={batch}
            onChange={(e)=>setBatch(e.target.value)}
            placeholder="ä¾‹ï¼šğŸ€ | æ‰‹æ°£ä¸éŒ¯ | ä»Šå¤©é©åˆæ¨é€²è¨ˆç•« | https://...jpg | 3"
          />
          <div className="mt-3">
            <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={applyBatch}>ä¸€éµå¥—ç”¨åˆ°è‰ç¨¿</button>
          </div>
        </div>

        <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3">
          <div className="font-semibold">å–®ç­†ç·¨è¼¯ï¼ˆè‰ç¨¿ï¼‰</div>
          <div className="grid gap-3 mt-3">
            {items.map(it=>(
              <div key={it.id} className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3">
                <div className="grid grid-cols-2 gap-2">
                  <input className="rounded-xl border px-3 py-2 text-sm" value={it.emoji||""} onChange={(e)=>upd(it.id,{emoji:e.target.value})} placeholder="emoji"/>
                  <input className="rounded-xl border px-3 py-2 text-sm" value={it.title||""} onChange={(e)=>upd(it.id,{title:e.target.value})} placeholder="æ¨™é¡Œ"/>
                </div>
                <textarea className="rounded-xl border px-3 py-2 text-sm w-full min-h-[90px] mt-2"
                  value={it.content||""}
                  onChange={(e)=>upd(it.id,{content:e.target.value})}
                  placeholder="å…§å®¹"
                />
                <div className="grid grid-cols-2 gap-2 mt-2">
                  <input className="rounded-xl border px-3 py-2 text-sm" value={it.image||""} onChange={(e)=>upd(it.id,{image:e.target.value})} placeholder="åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰"/>
                  <input className="rounded-xl border px-3 py-2 text-sm" type="number" min="0" step="1"
                    value={it.weight==null?0:it.weight}
                    onChange={(e)=>upd(it.id,{weight:e.target.value})}
                    placeholder="æ¬Šé‡"
                  />
                </div>
                <div className="mt-2 flex items-center justify-between">
                  <div className="text-xs text-slate-500 dark:text-slate-400">id: {it.id}</div>
                  <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
                    onClick={()=>delOne(it.id)}
                  >åˆªé™¤</button>
                </div>
              </div>
            ))}
            {items.length===0 ? <div className="text-sm text-slate-500 dark:text-slate-400">å°šç„¡è³‡æ–™</div> : null}
          </div>
        </div>
      </div>
    </div>
  );
}

/* =========================
   5) Tetrisï¼ˆCanvas + æ‰‹æ©ŸæŒ‰éˆ•ï¼‰
   ========================= */
function GameTetris({ data, setData }){
  const cfg = data?.games?.tetris || {};

  // æ”¯æ´å¤šå¥—æ¨£å¼ï¼šstyles[] + activeStyleIdï¼›è‹¥èˆŠè³‡æ–™åªæœ‰ styleï¼Œè¦–ç‚ºé è¨­æ¨£å¼
  const styles = (Array.isArray(cfg.styles) && cfg.styles.length)
    ? cfg.styles
    : [{ id:"default", name:"é è¨­", mode:(cfg.style?.mode||"color"), imagesText:(cfg.style?.imagesText||""), pieceImages:(cfg.style?.pieceImages||{}), tileOpacity:(cfg.style?.tileOpacity==null?0.22:cfg.style?.tileOpacity) }];

  const savedStyleId = cfg.activeStyleId || styles[0].id;

  // ä½¿ç”¨è€…å¯åœ¨éŠæˆ²å…§åˆ‡æ›æ¨£å¼ï¼Œä¸¦æŒä¹…åŒ–åˆ°æœ¬æ©Ÿ
  const [styleId, setStyleId] = React.useState(savedStyleId);
  React.useEffect(()=>{ setStyleId(savedStyleId); }, [savedStyleId]);

  const effectiveStyleId = (typeof styleId==="string" && styleId) ? styleId : savedStyleId;
  const style = styles.find(s=>s.id===effectiveStyleId) || styles[0];

  const applyStyle = (id)=>{
    setStyleId(id);
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      const cur = next.games.tetris || {};
      next.games.tetris = {
        ...cur,
        styles: (Array.isArray(cur.styles) && cur.styles.length) ? cur.styles : styles,
        activeStyleId: id,
        style: cur.style // å…¼å®¹èˆŠæ¬„ä½
      };
      return next;
    });
  };


  const isTouch = useIsTouch();

  const canvasRef = React.useRef(null);

  // status: idle -> running -> paused / over
  const [status, setStatus] = React.useState("idle"); // "idle" | "running" | "paused" | "over"
  const [score, setScore] = React.useState(0);

  const COLS=10, ROWS=20;

  const SHAPES = [
    { k:'I', c:1, m:[[1,1,1,1]] },
    { k:'O', c:2, m:[[1,1],[1,1]] },
    { k:'T', c:3, m:[[0,1,0],[1,1,1]] },
    { k:'S', c:4, m:[[0,1,1],[1,1,0]] },
    { k:'Z', c:5, m:[[1,1,0],[0,1,1]] },
    { k:'J', c:6, m:[[1,0,0],[1,1,1]] },
    { k:'L', c:7, m:[[0,0,1],[1,1,1]] },
  ];

  const emptyBoard = ()=>Array.from({length:ROWS}, ()=>Array(COLS).fill(0));

  const rotateM = (m)=>{
    const r=m.length, c=m[0].length;
    const out = Array.from({length:c}, ()=>Array(r).fill(0));
    for(let i=0;i<r;i++) for(let j=0;j<c;j++) out[j][r-1-i]=m[i][j];
    return out;
  };

  const collide = (board, piece, pos)=>{
    for(let r=0;r<piece.m.length;r++){
      for(let c=0;c<piece.m[0].length;c++){
        if(!piece.m[r][c]) continue;
        const x=pos.x+c, y=pos.y+r;
        if(x<0||x>=COLS||y>=ROWS) return true;
        if(y>=0 && board[y][x]) return true;
      }
    }
    return false;
  };

  const merge = (board, piece, pos)=>{
    const nb = board.map(row=>row.slice());
    for(let r=0;r<piece.m.length;r++){
      for(let c=0;c<piece.m[0].length;c++){
        if(!piece.m[r][c]) continue;
        const x=pos.x+c, y=pos.y+r;
        if(y>=0 && y<ROWS && x>=0 && x<COLS) nb[y][x]=piece.c;
      }
    }
    return nb;
  };

  const clearLines = (board)=>{
    const keep = board.filter(row=>row.some(v=>v===0));
    const cleared = ROWS - keep.length;
    while(keep.length<ROWS) keep.unshift(Array(COLS).fill(0));
    return { board: keep, cleared };
  };

  const randPiece = ()=>{
    const p = SHAPES[Math.floor(Math.random()*SHAPES.length)];
    return { ...p, m: p.m.map(row=>row.slice()) };
  };

  const [board, setBoard] = React.useState(()=>emptyBoard());
  const [piece, setPiece] = React.useState(()=>randPiece());
  const [pos, setPos] = React.useState({ x:3, y:-2 });

  const isRunning = status==="running";

  const reset = ()=>{
    setScore(0);
    setBoard(emptyBoard());
    setPiece(randPiece());
    setPos({ x:3, y:-2 });
    setStatus("idle");
  };

  const start = ()=>{
    setScore(0);
    setBoard(emptyBoard());
    const p = randPiece();
    const ppos = { x:3, y:-2 };
    setPiece(p);
    setPos(ppos);
    // è‹¥èµ·æ‰‹å³ç¢°æ’ï¼Œç›´æ¥æ›ä¸€é¡†ï¼ˆæ¥µå°‘æ•¸æƒ…æ³ï¼Œä¿åº•ï¼‰
    setStatus("running");
  };

  const pauseToggle = ()=>{
    setStatus(s=>{
      if(s==="running") return "paused";
      if(s==="paused") return "running";
      return s;
    });
  };

  // auto pause when tab hidden
  React.useEffect(()=>{
    const onVis=()=>{
      if(document.hidden){
        setStatus(s=> s==="running" ? "paused" : s);
      }
    };
    document.addEventListener("visibilitychange", onVis);
    return ()=>document.removeEventListener("visibilitychange", onVis);
  }, []);

  const stepDown = React.useCallback(()=>{
    if(!isRunning) return;

    setPos(ps=>{
      const np = { x: ps.x, y: ps.y+1 };
      if(!collide(board, piece, np)) return np;

      // lock
      const merged = merge(board, piece, ps);
      const { board: cleared, cleared: n } = clearLines(merged);
      setBoard(cleared);
      if(n>0) setScore(s=>s + n*100);

      const npiece = randPiece();
      const npos = { x:3, y:-2 };
      if(collide(cleared, npiece, npos)){
        setStatus("over");
        return ps;
      }
      setPiece(npiece);
      return npos;
    });
  }, [isRunning, board, piece]);

  // gravity tickï¼ˆé¿å… setInterval æ¼‚ç§»éå¤§ï¼špaused/over ä¸è·‘ï¼‰
  React.useEffect(()=>{
    if(!isRunning) return;
    const id = setInterval(()=>stepDown(), 520);
    return ()=>clearInterval(id);
  }, [isRunning, stepDown]);

  const moveX = (dx)=>{
    if(!isRunning) return;
    setPos(ps=>{
      const np = { x: ps.x+dx, y: ps.y };
      if(collide(board, piece, np)) return ps;
      return np;
    });
  };

  const rot = ()=>{
    if(!isRunning) return;
    const rm = rotateM(piece.m);
    const np = { ...piece, m: rm };

    // ç°¡åŒ– wall kickï¼ˆé ç‰†ä»å¯è½‰ï¼‰
    const kicks = [0, -1, 1, -2, 2];
    for(const k of kicks){
      const test = { x: pos.x + k, y: pos.y };
      if(!collide(board, np, test)){
        setPiece(np);
        if(k!==0) setPos(p=>({ ...p, x: p.x + k }));
        return;
      }
    }
  };

  const softDrop = ()=>stepDown();

  const hardDrop = ()=>{
    if(!isRunning) return;
    for(let i=0;i<ROWS+2;i++){
      let blocked=false;
      setPos(ps=>{
        const np = { x: ps.x, y: ps.y+1 };
        if(collide(board, piece, np)){ blocked=true; return ps; }
        return np;
      });
      if(blocked){ stepDown(); break; }
    }
  };

  // keyboard
  React.useEffect(()=>{
    const onKey=(e)=>{
      // åªåœ¨éŠæˆ²é€²è¡Œ/æš«åœæ™‚æ¥éµç›¤ï¼Œé¿å…å¹²æ“¾ç®¡ç†é è¼¸å…¥
      if(!(status==="running" || status==="paused")) return;

      if(e.key==='Escape'){ e.preventDefault(); pauseToggle(); return; }
      if(status!=="running") return;

      if(e.key==='ArrowLeft'){ e.preventDefault(); moveX(-1); }
      else if(e.key==='ArrowRight'){ e.preventDefault(); moveX(1); }
      else if(e.key==='ArrowDown'){ e.preventDefault(); softDrop(); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); rot(); }
      else if(e.key===' '){ e.preventDefault(); hardDrop(); }
    };
    window.addEventListener('keydown', onKey, { passive:false });
    return ()=>window.removeEventListener('keydown', onKey);
  }, [status, board, piece, pos]);

  // fit canvas using GameViewport contract + measured control bar (avoid covering / overflow)
  const controlBarRef = React.useRef(null);

  const fit = React.useCallback(()=>{
    const canvas = canvasRef.current;
    if(!canvas) return { w:300,h:600,cell:30 };

    const rootStyle = getComputedStyle(document.documentElement);
    const usableW = Number(rootStyle.getPropertyValue('--game-usable-w')||0) || window.innerWidth;
    const usableH = Number(rootStyle.getPropertyValue('--game-usable-h')||0) || (window.visualViewport?.height || window.innerHeight);

    // ä»¥å¯¦éš›æ§åˆ¶åˆ—é«˜åº¦ç‚ºæº–ï¼ˆä¸å†çŒœ 170ï¼‰ï¼Œé¿å…åœ¨å°è¢å¹•ç¸®æ”¾æ™‚è¢«è“‹ä½
    const controlBar = isTouch ? (controlBarRef.current?.offsetHeight || 0) : 0;

    const pad = 18; // shell padding + safe breathing room
    const w = Math.max(240, Math.min(560, usableW - pad));
    const h = Math.max(320, Math.min(900, usableH - pad - controlBar));

    // 10x20
    const cell = Math.max(10, Math.floor(Math.min(w/COLS, h/ROWS)));
    const cw = cell*COLS;
    const ch = cell*ROWS;

    const dpr = (window.devicePixelRatio||1);
    canvas.width = cw * dpr;
    canvas.height = ch * dpr;
    canvas.style.width = cw + "px";
    canvas.style.height = ch + "px";
    const ctx = canvas.getContext("2d");
    if(ctx) ctx.setTransform(dpr,0,0,dpr,0,0);

    return { w:cw, h:ch, cell };
  }, [isTouch]);

  React.useEffect(()=>{
    const canvas = canvasRef.current;
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    if(!ctx) return;

    let last = fit();
    const onResize=()=>{ last = fit(); draw(); };
    window.addEventListener('resize', onResize);

    const palette = ["#00000000","#60a5fa","#f59e0b","#34d399","#fb7185","#a78bfa","#f97316","#22c55e"];

    // èˆŠç‰ˆï¼šimagesText ä»¥ã€Œæ¯è¡Œä¸€å¼µã€é †åºå¥—ç”¨ï¼›æ–°ç‰ˆï¼špieceImages ä»¥ I/J/L/O/S/T/Z æŒ‡å®š
    const imgList = parseLinesToList(style.imagesText||"");
    const pieceOrder = ["","I","J","L","O","S","T","Z"];
    const imgCache = {};

    const getImg = (v)=>{
      if(style.mode!=="image") return null;

      const k = pieceOrder[v] || "";
      const byPiece = style.pieceImages && k ? (style.pieceImages[k]||"") : "";
      const src = byPiece || imgList[(v-1)%Math.max(1,imgList.length)] || "";
      if(!src) return null;

      if(imgCache[src]) return imgCache[src];
      const im = new Image();
      im.src = src;
      imgCache[src]=im;
      return im;
    };

    const draw = ()=>{
      const { w, h, cell } = last;
      ctx.clearRect(0,0,w,h);

      // grid background
      ctx.fillStyle = "#00000008";
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          ctx.fillRect(c*cell, r*cell, cell-1, cell-1);
        }
      }

      // board
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const v = board[r][c];
          if(!v) continue;
          const x=c*cell, y=r*cell;
          if(style.mode==="image"){
            const im=getImg(v);
            if(im && im.complete) ctx.drawImage(im,x,y,cell,cell);
            else{
              ctx.fillStyle=palette[v%palette.length];
              ctx.fillRect(x,y,cell-1,cell-1);
            }
          }else{
            ctx.fillStyle=palette[v%palette.length];
            ctx.fillRect(x,y,cell-1,cell-1);
          }
        }
      }

      // piece
      for(let r=0;r<piece.m.length;r++){
        for(let c=0;c<piece.m[0].length;c++){
          if(!piece.m[r][c]) continue;
          const x=(pos.x+c)*cell, y=(pos.y+r)*cell;
          if(y<0) continue;
          const v=piece.c;
          if(style.mode==="image"){
            const im=getImg(v);
            if(im && im.complete) ctx.drawImage(im,x,y,cell,cell);
            else{
              ctx.fillStyle=palette[v%palette.length];
              ctx.fillRect(x,y,cell-1,cell-1);
            }
          }else{
            ctx.fillStyle=palette[v%palette.length];
            ctx.fillRect(x,y,cell-1,cell-1);
          }
        }
      }

      // overlay when idle/paused/over
      if(status!=="running"){
        ctx.fillStyle = "rgba(0,0,0,0.25)";
        ctx.fillRect(0,0,w,h);
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.fillRect(w*0.12,h*0.38,w*0.76,h*0.24);

        ctx.fillStyle = "#111827";
        ctx.font = `bold ${Math.max(14, Math.floor(cell*0.75))}px system-ui`;
        ctx.textAlign = "center";
        const msg = status==="idle" ? "æŒ‰é–‹å§‹é–‹å§‹éŠæˆ²" : (status==="paused" ? "å·²æš«åœ" : "çµæŸ");
        ctx.fillText(msg, w/2, h*0.48);
        ctx.font = `${Math.max(12, Math.floor(cell*0.45))}px system-ui`;
        const sub = status==="idle" ? (isTouch ? "ä½¿ç”¨ä¸‹æ–¹æŒ‰éµæ“ä½œ" : "æ–¹å‘éµæ“ä½œï¼ŒEsc æš«åœ") : (status==="paused" ? "æŒ‰ç¹¼çºŒæ¢å¾©" : "æŒ‰é‡ç©é‡æ–°é–‹å§‹");
        ctx.fillText(sub, w/2, h*0.58);
      }
    };

    let raf=0;
    const loop=()=>{
      draw();
      raf=requestAnimationFrame(loop);
    };
    loop();

    return ()=>{
      cancelAnimationFrame(raf);
      window.removeEventListener('resize', onResize);
    };
  }, [board, piece, pos, status, style.mode, style.imagesText, JSON.stringify(style.pieceImages||{}), isTouch, fit]);

  // Touch controls (with press-and-hold repeat for left/right/down)
  const holdRef = React.useRef({ id:0, action:null });

  const stopHold = ()=>{
    if(holdRef.current.id){
      clearInterval(holdRef.current.id);
      holdRef.current.id=0;
    }
  };

  const startHold = (fn, delay=200, interval=55)=>{
    stopHold();
    fn();
    let started=false;
    const t0 = setTimeout(()=>{
      started=true;
      holdRef.current.id = setInterval(fn, interval);
    }, delay);
    holdRef.current.id = t0;
  };

  React.useEffect(()=>()=>stopHold(), []);

  // è§¸æ§æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿï¼‰ï¼šæ”¯æ´ pointer äº‹ä»¶ã€é•·æŒ‰é€£ç™¼ï¼›é¿å… TouchBtn æœªå®šç¾©
  const TouchBtn = ({ label, onDown, onUp })=>{
    const handleDown = (e)=>{
      e.preventDefault();
      e.stopPropagation();
      if(!isRunning) return;
      if(typeof onDown==="function") onDown();
    };
    const handleUp = (e)=>{
      e.preventDefault();
      e.stopPropagation();
      if(typeof onUp==="function") onUp();
    };
    return (
      <button
        type="button"
        className="rounded-xl border px-3 py-3 text-sm hover:bg-slate-50 dark:hover:bg-slate-800 select-none"
        onPointerDown={handleDown}
        onPointerUp={handleUp}
        onPointerCancel={handleUp}
        onPointerLeave={handleUp}
      >{label}</button>
    );
  };

const touchHud = (
    <>
      <div className="tetris-hud" aria-label="Tetris controls">
        <div className="tetris-pad left">
          <div className="tetris-pad-inner">
            <TouchBtn label="â†" onDown={()=>startHold(()=>moveX(-1), 200, 55)} onUp={stopHold}/>
            <TouchBtn label="â†’" onDown={()=>startHold(()=>moveX(1), 200, 55)} onUp={stopHold}/>
          </div>
        </div>

        <div className="tetris-center">
          {status==="idle" ? (
            <button type="button" className="tetris-mini primary" onClick={()=>{ start(); }}>é–‹å§‹</button>
          ) : status==="running" ? (
            <button type="button" className="tetris-mini" onClick={()=>{ pauseToggle(); }}>æš«åœ</button>
          ) : status==="paused" ? (
            <button type="button" className="tetris-mini primary" onClick={()=>{ pauseToggle(); }}>ç¹¼çºŒ</button>
          ) : (
            <button type="button" className="tetris-mini primary" onClick={()=>{ start(); }}>é‡ç©</button>
          )}
          {status!=="idle" ? (
            <button type="button" className="tetris-mini" onClick={()=>{ reset(); }}>é‡ç½®</button>
          ) : null}
        </div>

        <div className="tetris-pad right">
          <div className="tetris-pad-inner">
            <TouchBtn label="âŸ³" onDown={()=>rot()} onUp={()=>{}}/>
            <TouchBtn label="â†“" onDown={()=>startHold(()=>softDown(), 140, 55)} onUp={stopHold}/>
            <TouchBtn label="â¤“" onDown={()=>hardDrop()} onUp={()=>{}}/>
          </div>
        </div>
      </div>
      <div className="tetris-hint">é•·æŒ‰ â†/â†’/â†“ å¯é€£çºŒç§»å‹•</div>
    </>
  );

  return (
    <GameShell
      title="ä¿„ç¾…æ–¯æ–¹å¡Š"
      subtitle={isTouch ? "æ‰‹æ©Ÿï¼šä½¿ç”¨åº•éƒ¨è§¸æ§æŒ‰éˆ•æ“ä½œï¼ˆæŒ‰é–‹å§‹å¾Œæ‰æœƒæ‰è½ï¼‰" : "é›»è…¦ï¼šæ–¹å‘éµç§»å‹•ã€â†‘æ—‹è½‰ã€ç©ºç™½éµç›´æ¥è½ä¸‹ã€Esc æš«åœ"}
      onReset={reset}
    >
      <div className="flex flex-col" style={{ height: "calc(var(--game-usable-h) * 1px)" }}>
        <div className="relative flex-1 flex justify-center items-start">
          <canvas
            ref={canvasRef}
            className="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900"
            style={{ touchAction:"none" }}
          />

          <div className="absolute top-3 left-3 flex items-center gap-2">
            <div className="text-sm font-medium bg-white/80 dark:bg-slate-900/70 backdrop-blur rounded-xl px-3 py-2 border border-slate-200 dark:border-slate-700">
              åˆ†æ•¸ï¼š{score}
            </div>
            <div className="flex items-center gap-2 bg-white/80 dark:bg-slate-900/70 rounded-xl px-3 py-2 border border-slate-200 dark:border-slate-700">
              <label className="text-sm text-slate-600 dark:text-slate-300">æ¨£å¼</label>
              <select className="rounded-xl border px-2 py-1 text-sm bg-white dark:bg-slate-900"
                value={styleId}
                onChange={(e)=>applyStyle(e.target.value)}
              >
                {(styles.length?styles:[{id:"default",name:"é è¨­"}]).map(s=>(
                  <option key={s.id} value={s.id}>{s.name||"æœªå‘½å"}</option>
                ))}
              </select>
            </div>

            {status==="paused" ? <div className="text-sm rounded-full px-3 py-1 border border-amber-300 bg-amber-50 dark:bg-amber-900/20">æš«åœ</div> : null}
            {status==="over" ? <div className="text-sm rounded-full px-3 py-1 border border-rose-300 bg-rose-50 dark:bg-rose-900/20">çµæŸ</div> : null}
          </div>

          {!isTouch ? <div className="absolute top-3 right-3 flex items-center gap-2">
            {status==="idle" ? (
              <button type="button" className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" onClick={()=>{ start(); }}>é–‹å§‹</button>
            ) : status==="running" ? (
              <button type="button" className="rounded-xl border px-3 py-2 text-sm bg-white/80 dark:bg-slate-900/70 backdrop-blur hover:bg-white dark:hover:bg-slate-800" onClick={()=>{ pauseToggle(); }}>æš«åœ</button>
            ) : status==="paused" ? (
              <button type="button" className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" onClick={()=>{ pauseToggle(); }}>ç¹¼çºŒ</button>
            ) : (
              <button type="button" className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" onClick={()=>{ start(); }}>é‡ç©</button>
            )}
            {status!=="idle" ? (
              <button type="button" className="rounded-xl border px-3 py-2 text-sm bg-white/80 dark:bg-slate-900/70 backdrop-blur hover:bg-white dark:hover:bg-slate-800" onClick={()=>{ reset(); }}>é‡ç½®</button>
            ) : null}
          </div> : null}
        </div>

        {isTouch ? touchHud : null}
      </div>
    </GameShell>
  );
}


function AdminTetris({ data, setData, onBack }){
  const base = data?.games?.tetris || {};
  const [draft, setDraft] = React.useState(()=>JSON.parse(JSON.stringify(base||{})));
  const [styleId, setStyleId] = React.useState(()=> (base.activeStyleId || (Array.isArray(base.styles)&&base.styles[0]?.id) || "default"));
  const [pieceKey, setPieceKey] = React.useState("I");

  React.useEffect(()=>{
    setDraft(JSON.parse(JSON.stringify(base||{})));
    const initStyles = (Array.isArray(base.styles)&&base.styles.length)?base.styles:[];
    setStyleId(base.activeStyleId || initStyles[0]?.id || "default");
  }, [base]);

  const styles = (Array.isArray(draft.styles) && draft.styles.length)
    ? draft.styles
    : [{ id:"default", name:"é è¨­", mode:(draft.style?.mode||"color"), imagesText:(draft.style?.imagesText||""), pieceImages:(draft.style?.pieceImages||{}), tileOpacity:(draft.style?.tileOpacity==null?0.22:draft.style?.tileOpacity) }];

  const active = styles.find(s=>s.id===styleId) || styles[0];

  const ensureStylesOnDraft = (nx)=>{
    if(!Array.isArray(nx.styles) || !nx.styles.length){
      nx.styles = [{ id:"default", name:"é è¨­", mode:(nx.style?.mode||"color"), imagesText:(nx.style?.imagesText||""), pieceImages:(nx.style?.pieceImages||{}), tileOpacity:(nx.style?.tileOpacity==null?0.22:nx.style?.tileOpacity) }];
    }
    if(nx.style) delete nx.style; // legacy
    return nx;
  };

  const addStyle = ()=>{
    const id = "s_"+Date.now().toString(36);
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles.push({ id, name:`æ¨£å¼ ${nx.styles.length+1}`, mode:"color", imagesText:"", pieceImages:{}, tileOpacity:0.22 });
      return nx;
    });
    setStyleId(id);
  };

  const renameStyle = (name)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=> s.id===styleId ? { ...s, name } : s);
      return nx;
    });
  };

  const deleteStyle = ()=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      if(nx.styles.length<=1) return nx;
      const rest = nx.styles.filter(s=>s.id!==styleId);
      nx.styles = rest;
      const nextId = rest[0]?.id || "default";
      setStyleId(nextId);
      return nx;
    });
  };

  const setActivePatch = (patch)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=> s.id===styleId ? { ...s, ...patch } : s);
      return nx;
    });
  };

  const pieceImages = active.pieceImages || {};
  const curSrc = pieceImages[pieceKey] || "";

  const setPieceSrc = (src)=>{
    setDraft(d=>{
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(d||{})));
      nx.styles = nx.styles.map(s=>{
        if(s.id!==styleId) return s;
        const pi = { ...(s.pieceImages||{}) };
        if(src) pi[pieceKey]=src; else delete pi[pieceKey];
        return { ...s, pieceImages: pi };
      });
      return nx;
    });
  };

  const save = ()=>{
    setData(prev=>{
      const next = { ...(prev||{}) };
      kjsEnsureGames(next);
      const nx = ensureStylesOnDraft(JSON.parse(JSON.stringify(draft||{})));
      next.games.tetris = {
        ...nx,
        styles: (nx.styles||styles),
        activeStyleId: styleId
      };
      return next;
    });
    toast("ä¿„ç¾…æ–¯æ–¹å¡Šè¨­å®šå·²å„²å­˜");
  };

  const pieces = ["I","J","L","O","S","T","Z"];

  return (
    <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-4">
      <div className="flex items-center justify-between gap-3">
        <div className="font-semibold">ä¿„ç¾…æ–¯æ–¹å¡Šï¼ˆæ¨£å¼è¨­å®šï¼‰</div>
        <div className="flex gap-2">
          <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={onBack}>è¿”å›</button>
          <button type="button" className="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" onClick={save}>å„²å­˜</button>
        </div>
      </div>

      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-3">
        <div className="flex items-center justify-between gap-2">
          <div className="font-medium">æ¨£å¼</div>
          <div className="flex gap-2">
            <button type="button" className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800" onClick={addStyle}>æ–°å¢æ¨£å¼</button>
            <button type="button" className={"rounded-xl border px-3 py-2 text-sm " + (styles.length<=1 ? "opacity-50 cursor-not-allowed" : "hover:bg-slate-50 dark:hover:bg-slate-800")}
              disabled={styles.length<=1}
              onClick={deleteStyle}
            >åˆªé™¤</button>
          </div>
        </div>

        <div className="grid md:grid-cols-3 gap-3">
          <label className="text-sm">
            <div className="text-slate-500 mb-1">é¸æ“‡æ¨£å¼</div>
            <select className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={styleId}
              onChange={(e)=>setStyleId(e.target.value)}
            >
              {styles.map(s=>(<option key={s.id} value={s.id}>{s.name||s.id}</option>))}
            </select>
          </label>

          <label className="text-sm md:col-span-2">
            <div className="text-slate-500 mb-1">æ¨£å¼åç¨±</div>
            <input className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={active.name||""}
              onChange={(e)=>renameStyle(e.target.value)}
              placeholder="ä¾‹å¦‚ï¼šIP æ–¹å¡Šã€é€æ˜åº•ã€é»‘ç™½ç­‰"
            />
          </label>
        </div>

        <label className="text-sm">
          <div className="text-slate-500 mb-1">æ–¹å¡Šé¡¯ç¤ºæ¨¡å¼</div>
          <select className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
            value={active.mode||"color"}
            onChange={(e)=>setActivePatch({ mode: e.target.value })}
          >
            <option value="color">ç´”è‰²</option>
            <option value="image">åœ–ç‰‡ï¼ˆä¾ I/J/L/O/S/T/Zï¼‰</option>
          </select>
          <div className="text-xs text-slate-500 mt-1">
            è‹¥ç”¨åœ–ç‰‡ï¼šå»ºè­°é€æ˜ PNG/WebPï¼Œåœ–å…§ä¿ç•™ç•™ç™½ï¼Œé¿å…æ–¹å¡Šé‚Šç•Œä¸æ¸…ã€‚
          </div>
        </label>
      </div>

      <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-4">
        <div className="font-medium">åœ–ç‰‡å°æ‡‰ï¼ˆI/J/L/O/S/T/Zï¼‰</div>

        <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <label className="text-sm">
            <div className="text-slate-500 mb-1">é¸æ“‡æ–¹å¡Š</div>
            <select className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={pieceKey}
              onChange={(e)=>setPieceKey(e.target.value)}
            >
              {pieces.map(k=>(<option key={k} value={k}>{k}</option>))}
            </select>
          </label>

          <label className="text-sm sm:col-span-1 lg:col-span-3">
            <div className="text-slate-500 mb-1">åœ–ç‰‡ URLï¼ˆæˆ– dataURLï¼‰</div>
            <input className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-slate-900"
              value={curSrc}
              onChange={(e)=>setPieceSrc(e.target.value)}
              placeholder="https://... æˆ– data:image/..."
            />
          </label>
        </div>

        <div className="grid md:grid-cols-3 gap-3 items-end">
          <div className="md:col-span-2">
            <div className="text-sm text-slate-500 mb-1">é è¦½</div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-700 p-3 flex items-center gap-3">
              <div className="w-20 h-20 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                {curSrc ? <img src={curSrc} alt="" className="w-full h-full object-cover" /> : <div className="text-slate-400 text-sm">ç„¡</div>}
              </div>
              <div className="text-sm">
                <div>æ–¹å¡Šï¼š<span className="font-semibold">{pieceKey}</span></div>
                <div className="text-xs text-slate-500 mt-1">åœ–ç‰‡æ¨¡å¼ä¸‹ï¼Œæœƒä»¥æ­¤åœ–ç‰‡é‹ªæ»¿æ¯å€‹å°æ–¹å¡Š</div>
              </div>
            </div>
          </div>

          <button type="button"
            className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800"
            onClick={()=>setPieceSrc("")}
          >æ¸…é™¤æ­¤æ–¹å¡Šåœ–ç‰‡</button>
        </div>
      </div>
    </div>
  );
}




    // â€”â€” Render â€”â€”
    // â€”â€” Render â€”â€”
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<><App /><LightboxRoot /></>);

  </script>

<!-- [IMGIO JS START] -->
<script>
(function(){
  // â€”â€” çµ±ä¸€çš„åœ–ç‰‡ç‹€æ…‹ï¼ˆkey -> { src, type, fit, opacity, offsetX, offsetY, scale, rotateDeg }ï¼‰
  // æ³¨æ„ï¼šæˆ‘å€‘ä¸æœƒå‹•ä½ è²¼é€²ä¾†çš„ src å­—ä¸²ï¼ˆçµ•ä¸æ­£è¦åŒ–ã€çµ•ä¸è£œå‰ç¶´ï¼‰ã€‚
  const imageState = new Map();

  // ä»¥ dataset æˆ– DOM è·¯å¾‘å–å¾—ç©©å®š keyï¼ˆæ²’æœ‰ data-img-key ä¹Ÿèƒ½é‹ä½œï¼‰
  function getStableKeyFor(el){
    if(el.dataset && el.dataset.imgKey) return el.dataset.imgKey;
    // ç”Ÿæˆ DOM è·¯å¾‘ï¼ˆé¿å…é‡æ•´å¾Œè®Šå‹•ï¼Œç›¡é‡åŒ…å«åŒå±¤ç´¢å¼•ï¼‰
    const parts=[];
    let node=el;
    while(node && node.nodeType===1 && node.tagName.toLowerCase()!=='html'){
      const tag=node.tagName.toLowerCase();
      const parent=node.parentElement;
      let idx=0;
      if(parent){
        const siblings=[...parent.children].filter(c=>c.tagName===node.tagName);
        idx=siblings.indexOf(node);
      }
      parts.unshift(`${tag}:nth-of-type(${idx+1})`);
      node=parent;
    }
    return parts.join('>');
  }

  // åµæ¸¬å…ƒç´ æ˜¯ <img> é‚„æ˜¯å®¹å™¨èƒŒæ™¯
  function detectType(el){
    return el.tagName && el.tagName.toLowerCase()==='img' ? 'img' : 'bg';
  }

  // å¥—ç”¨ç‹€æ…‹åˆ°å…ƒç´ 
  function applyToElement(el, state){
    const type = detectType(el);
    if(type==='img'){
      if(state.src !== undefined) el.src = state.src; // åŸæ¨£å­—ä¸²
      // å…¶ä»–èª¿æ•´å¯ç”¨ style ä¾†å¥—
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      // img çš„ fit å¯ç”¨ object-fit / object-position
      if(state.fit) el.style.objectFit = state.fit; // 'cover' | 'contain' | 'fill' | 'none' | 'scale-down'
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.objectPosition = `${ox}px ${oy}px`;
      }
    }else{
      // èƒŒæ™¯å®¹å™¨
      if(state.src !== undefined) el.style.backgroundImage = state.src ? `url("${state.src}")` : 'none';
      if(state.opacity!=null) el.style.opacity = String(state.opacity);
      const tf = buildTransform(state);
      if(tf) el.style.transform = tf;
      if(state.fit){
        // å°èƒŒæ™¯ä½¿ç”¨ background-size
        const map = { cover:'cover', contain:'contain', fill:'100% 100%', none:'auto', 'scale-down':'contain' };
        el.style.backgroundSize = map[state.fit] || state.fit;
      }
      if(state.offsetX!=null || state.offsetY!=null){
        const ox = state.offsetX ?? 0, oy = state.offsetY ?? 0;
        el.style.backgroundPosition = `${ox}px ${oy}px`;
      }
    }
  }

  function buildTransform(state){
    const ops=[];
    if(state.scale!=null && state.scale!==1) ops.push(`scale(${state.scale})`);
    if(state.rotateDeg!=null && state.rotateDeg!==0) ops.push(`rotate(${state.rotateDeg}deg)`);
    if(ops.length===0) return '';
    return ops.join(' ');
  }

  // æƒæé é¢ä¸Šæ‰€æœ‰å¯èƒ½çš„åœ–ç‰‡å…ƒç´ 
  function collectImageElements(){
    const all = new Set();
    // 1) å…·æœ‰ data-img-key çš„å…ƒç´ 
    document.querySelectorAll('[data-img-key]').forEach(el=>all.add(el));
    // 2) æ‰€æœ‰ <img>
    document.querySelectorAll('img').forEach(el=>all.add(el));
    // 3) æ˜ç¢ºå®£å‘Šç‚ºèƒŒæ™¯åœ–å®¹å™¨çš„å…ƒç´ ï¼ˆå¯é¸ï¼‰
    document.querySelectorAll('[data-img-type="bg"]').forEach(el=>all.add(el));
    return [...all];
  }

  // æŠŠå…ƒç´ è¨»å†Šé€²ç‹€æ…‹è¡¨ï¼ˆè‹¥å·²æœ‰å°±ä¸è¦†è“‹ï¼‰
  function ensureStateForElement(el){
    const key = getStableKeyFor(el);
    if(!imageState.has(key)){
      imageState.set(key, {
        src: readCurrentSrc(el),
        type: detectType(el),
        fit: undefined, opacity: undefined, offsetX: 0, offsetY: 0,
        scale: 1, rotateDeg: 0
      });
    }
    return key;
  }

  function readCurrentSrc(el){
    if(detectType(el)==='img'){
      return el.getAttribute('src') || '';
    }else{
      // å¾ style.backgroundImage å– url(...)ï¼ˆè‹¥ç„¡å‰‡ç©ºï¼‰
      const bg = getComputedStyle(el).backgroundImage;
      if(!bg || bg==='none') return '';
      // ç°¡å–®æŠ½å– url("...") å…§å®¹
      const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
      return m ? m[2] : '';
    }
  }

  // å°å–®ä¸€ key è¨­å®šè·¯å¾‘ï¼ˆåŸæ¨£ä¿å­˜ï¼Œä¸æ”¹å­—ä¸²ï¼‰
  function setPath(key, rawPath){
    const state = imageState.get(key) || { };
    state.src = (rawPath==null ? '' : String(rawPath));
    imageState.set(key, state);
    // æŠŠå®ƒå¥—å›å°æ‡‰å…ƒç´ 
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  // å°å–®ä¸€ key èª¿æ•´å±¬æ€§ï¼ˆä¸å½±éŸ¿ srcï¼‰
  function setAdjust(key, patch){
    const state = imageState.get(key) || { };
    Object.assign(state, patch);
    imageState.set(key, state);
    const el = findElementByKey(key);
    if(el) applyToElement(el, state);
  }

  function findElementByKey(key){
    // å…ˆæ‰¾ data-img-key
    let el = document.querySelector(`[data-img-key="${CSS.escape(key)}"]`);
    if(el) return el;
    // è‹¥ä¸æ˜¯ data-img-keyï¼Œå¯èƒ½æ˜¯è‡ªå‹•ç”¢ç”Ÿçš„ DOM è·¯å¾‘ key
    try{
      el = document.querySelector(key.split('>').map(seg=>{
        // seg å½¢å¦‚ "div:nth-of-type(1)"ï¼Œç›´æ¥ç”¨
        return seg.trim();
      }).join(' > '));
    }catch(e){}
    return el || null;
  }

  // å°‡ç›®å‰ imageState åŒ¯å‡ºç‚º JSONï¼ˆå­—ä¸²ï¼‰
  function exportImagesJSON(){
    // Map -> ç´”ç‰©ä»¶
    const obj = {};
    for(const [k,v] of imageState.entries()){
      obj[k] = {
        src: v.src ?? '',
        type: v.type ?? 'img',
        fit: v.fit ?? undefined,
        opacity: v.opacity ?? undefined,
        offsetX: v.offsetX ?? 0,
        offsetY: v.offsetY ?? 0,
        scale: v.scale ?? 1,
        rotateDeg: v.rotateDeg ?? 0
      };
    }
    return JSON.stringify({ __kind: 'images.v1', data: obj }, null, 2);
  }

  // å¾ JSONï¼ˆå­—ä¸²æˆ–ç‰©ä»¶ï¼‰åŒ¯å…¥ï¼ŒåŸæ¨£é‚„åŸä¸¦ç«‹å³å¥—ç”¨
  function importImagesJSON(json){
    const payload = (typeof json==='string') ? JSON.parse(json) : json;
    if(!payload || payload.__kind!=='images.v1' || !payload.data) return;
    for(const k of Object.keys(payload.data)){
      imageState.set(k, { ...payload.data[k] });
      const el = findElementByKey(k);
      if(el) applyToElement(el, imageState.get(k));
    }
  }

  // ç¶å®šè¼¸å…¥æ¡†ï¼šä»»ä½• input/textarea åªè¦æœ‰ data-img-input="key" å°±æœƒè²¼ä¸Šå³å¥—ç”¨
  function bindInputsLive(){
    document.querySelectorAll('[data-img-input]').forEach(inp=>{
      const keyAttr = inp.getAttribute('data-img-input');
      const elKey = keyAttr && keyAttr.trim() ? keyAttr.trim() : null;
      // è‹¥æ²’å¡« keyï¼Œå˜—è©¦ç”¨æœ€è¿‘çš„ data-img-key å®¹å™¨
      let key = elKey;
      if(!key){
        const host = inp.closest('[data-img-key]');
        if(host) key = getStableKeyFor(host);
      }
      if(!key) return;

      // ç¢ºä¿æœ‰ç‹€æ…‹
      imageState.has(key) || imageState.set(key, {});

      // åˆå§‹åŒ–ï¼šå¦‚æœ input æœ‰å€¼å°±å…ˆå¥—
      if(inp.value && inp.value.trim()){
        setPath(key, inp.value.trim());
      }

      // å³æ™‚ç›£è½ï¼ˆè²¼ä¸Š/è¼¸å…¥/è®Šæ›´ï¼‰
      ['input','change','paste'].forEach(ev=>{
        inp.addEventListener(ev, ()=>{
          setPath(key, inp.value);
        });
      });
    });
  }

  // æ›åœ¨å…¨åŸŸï¼Œæ–¹ä¾¿ä½ å‘¼å«
  window.ImageIO = {
    setPath, setAdjust, exportImagesJSON, importImagesJSON,
    refreshAll(){
      collectImageElements().forEach(el=>{
        const key = ensureStateForElement(el);
        applyToElement(el, imageState.get(key));
      });
    }
  };

  // åˆæ¬¡å•Ÿå‹•ï¼šæ”¶é›†å…ƒç´  â†’ å»ºç‹€æ…‹ â†’ ç¶å®šè¼¸å…¥æ¡† â†’ é¦–æ¬¡å¥—ç”¨
  function boot(){
    const els = collectImageElements();
    els.forEach(el=>{
      const key = ensureStateForElement(el);
      // åˆå§‹å¥—ç”¨ï¼ˆä»¥ DOM ç›®å‰çš„ src / èƒŒæ™¯ç‚ºåŸºæº–ï¼‰
      applyToElement(el, imageState.get(key));
    });
    bindInputsLive();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', boot);
  }else{
    boot();
  }

  // â€”â€” ä¸‹é¢æ˜¯ã€Œç¤ºç¯„ç”¨ã€çš„åŒ¯å‡º/åŒ¯å…¥æŒ‰éˆ•ï¼ˆå¯ä¿ç•™æˆ–æ•´åˆåˆ°ä½ ç¾æœ‰ UIï¼‰ â€”â€” //
  // åŒ¯å‡ºï¼šä¸‹è¼‰ .jsonï¼ˆä¿ç•™åŸå­—ä¸²è·¯å¾‘ï¼‰
  function downloadJSON(filename, content){
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename || 'images.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 0);
  }

  // ä½ å¯ä»¥åœ¨ä»»ä½•äº‹ä»¶ä¸­å‘¼å« window.ImageIO.exportImagesJSON()
  window.addEventListener('click', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-export]')){
      const json = exportImagesJSON();
      downloadJSON('images.json', json);
    }
  });

  // åŒ¯å…¥ï¼šè®€æª”å¾Œç«‹å³é‚„åŸ
  window.addEventListener('change', function(e){
    const t = e.target;
    if(!(t && t.matches)) return;
    if(t.matches('[data-imgio-import]') && t.files && t.files[0]){
      const f = t.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        try{
          importImagesJSON(reader.result);
          alert('åœ–ç‰‡è·¯å¾‘èˆ‡èª¿æ•´å·²åŒ¯å…¥ä¸¦å¥—ç”¨å®Œæˆã€‚');
        }catch(err){
          alert('åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤æˆ–å…§å®¹ä¸ç¬¦ã€‚');
        }
        t.value = '';
      };
      reader.readAsText(f);
    }
  });
})();
</script>
<!-- [IMGIO JS END] -->

</body>

</html>
